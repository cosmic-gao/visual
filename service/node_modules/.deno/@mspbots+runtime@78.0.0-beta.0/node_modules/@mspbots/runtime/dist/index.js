import{join,dirname}from'path';import _0x34077b from'process';import{stat}from'fs/promises';async function ie(_0x691a45){try{return await stat(_0x691a45),!0x0;}catch{return![];}}var f={'error':(_0x3893e8,_0x1c6877)=>console['error']('[ERROR]\x20'+_0x3893e8,_0x1c6877),'warn':(_0x99e905,_0x7a3cee)=>console['warn']('[WARN]\x20'+_0x99e905,_0x7a3cee),'info':(_0x2223cd,_0x2555d6)=>console['log']('[INFO]\x20'+_0x2223cd,_0x2555d6),'debug':(_0xf45326,_0x4554cc)=>console['log']('[DEBUG]\x20'+_0xf45326,_0x4554cc)};function z(){let _0x27f4f4=globalThis['Deno'];if(!_0x27f4f4)throw new Error('Deno is not available');return _0x27f4f4;}var D=class{constructor(_0x441038,_0xa7abcc='./lib',_0x1dd14c={}){this['manifest']=_0x441038,this['libDir']=_0xa7abcc,this['platformImports']=_0x1dd14c;}['buildPerms'](){let _0x11ddd2=this['manifest']['permissions']||{},_0x27c257={};return _0x11ddd2['net']!==void 0x0&&(_0x27c257['net']=_0x11ddd2['net']===!![]?!![]:Array['isArray'](_0x11ddd2['net'])?_0x11ddd2['net']:[]),_0x11ddd2['read']!==void 0x0&&(_0x27c257['read']=_0x11ddd2['read']===!![]?!![]:Array['isArray'](_0x11ddd2['read'])?_0x11ddd2['read']:[]),_0x11ddd2['write']!==void 0x0&&(_0x27c257['write']=_0x11ddd2['write']===!![]?!![]:Array['isArray'](_0x11ddd2['write'])?_0x11ddd2['write']:[]),_0x11ddd2['env']!==void 0x0&&(_0x27c257['env']=_0x11ddd2['env']===!![]?!![]:Array['isArray'](_0x11ddd2['env'])?_0x11ddd2['env']:[]),_0x11ddd2['run']!==void 0x0&&(_0x27c257['run']=_0x11ddd2['run']===!![]?!![]:Array['isArray'](_0x11ddd2['run'])?_0x11ddd2['run']:[]),_0x11ddd2['ffi']!==void 0x0&&(_0x27c257['ffi']=_0x11ddd2['ffi']===!![]?!![]:Array['isArray'](_0x11ddd2['ffi'])?_0x11ddd2['ffi']:[]),_0x11ddd2['sys']!==void 0x0&&(_0x27c257['sys']=_0x11ddd2['sys']===!![]?!![]:Array['isArray'](_0x11ddd2['sys'])?_0x11ddd2['sys']:[]),_0x11ddd2['hrtime']!==void 0x0&&(_0x27c257['hrtime']=_0x11ddd2['hrtime']),_0x27c257;}['normalize'](_0xe63270){return _0xe63270===!![]?[]:Array['isArray'](_0xe63270)?_0xe63270:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x28b615){return join(this['libDir'],_0x28b615+'@*');}['getReadPaths'](){let _0x20841a=this['getImports']();_0x20841a['includes']('*')&&(_0x20841a=Object['keys'](this['platformImports']));let _0x9913c9=[];console['log']('[Permissions] Building package path patterns for imports:',_0x20841a);for(let _0x73d4f2 of _0x20841a){let _0x6dc458=this['getLibPattern'](_0x73d4f2);_0x9913c9['push'](_0x6dc458),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x73d4f2+'\x20->\x20'+_0x6dc458);}return console['log']('[Permissions] Final package path patterns:',_0x9913c9),_0x9913c9;}['buildImportMap'](_0x38fc65){let _0x4cfcb6=this['getImports'](),_0x3c22f8=_0x4cfcb6['includes']('*')?Object['keys'](_0x38fc65):_0x4cfcb6;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x3c22f8);let _0xfbe490={};for(let _0x291f23 of _0x3c22f8)if(_0x38fc65[_0x291f23])_0xfbe490[_0x291f23]=_0x38fc65[_0x291f23],console['log']('[ImportMap]\x20'+_0x291f23+'\x20->\x20'+_0x38fc65[_0x291f23]+'\x20(from\x20platform)');else try{let _0x214381=z(),_0x1811c8=join(_0x214381['cwd'](),this['libDir']),_0x3c23d1=!0x1;try{for(let _0x5ced53 of _0x214381['readDirSync'](_0x1811c8))if(_0x5ced53['isDirectory']&&(_0x5ced53['name']===_0x291f23||_0x5ced53['name']['startsWith'](_0x291f23+'@'))){let _0x43b2ba=join(_0x214381['cwd'](),this['libDir'],_0x5ced53['name'],'index.js')['replace'](/\\/g,'/'),_0x9ea0=new URL('file:///'+_0x43b2ba)['href'];_0xfbe490[_0x291f23]=_0x9ea0,console['log']('[ImportMap]\x20'+_0x291f23+'\x20->\x20'+_0x9ea0+'\x20(from\x20lib)'),_0x3c23d1=!0x0;break;}}catch{}_0x3c23d1||console['warn']('[ImportMap]\x20Package\x20'+_0x291f23+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x4b1967){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x291f23+':',_0x4b1967);}return _0xfbe490;}['validateServerImports'](_0x316888){let _0x1c0ad0=this['manifest']['name']||this['manifest']['id'],_0x16abbd=this['manifest']['metadata']?.['serverPath'],_0x195256=_0x268dbd=>_0x268dbd['replace'](/\\/g,'/'),_0x47906e=z(),_0x455d75=_0x1e17ca=>{try{return _0x47906e['statSync'](_0x1e17ca),!0x0;}catch{return![];}},_0x1184cc=_0x16abbd?_0x195256(_0x16abbd):void 0x0;if(!_0x1184cc){let _0xd4b07b=[_0x316888+'/service/server.js',_0x316888+'/service/server.ts',_0x316888+'/'+_0x1c0ad0+'/server.js',_0x316888+'/'+_0x1c0ad0+'/server.ts',_0x316888+'/server.js',_0x316888+'/server.ts']['map'](_0x195256);for(let _0x5b80d9 of _0xd4b07b)if(_0x455d75(_0x5b80d9)){_0x1184cc=_0x5b80d9;break;}}if(!_0x1184cc)return{'valid':![],'violations':['Failed to locate server module']};let _0x3d71a1='';try{_0x3d71a1=_0x47906e['readTextFileSync'](_0x1184cc);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x1184cc};}let _0xf227e6=this['getImports']();if(_0xf227e6['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x1184cc};let _0x407af4=_0xf227e6,_0x4e7837=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x11190e=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x5ce690=/\bimport\s*['"]([^'"]+)['"]/g,_0x2ff9dd=[],_0x58c5b3=new Set(),_0x2d7ee2=_0x14b9cd=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x14b9cd),_0x1e4bea=_0x3a568c=>{let _0x54a5da=_0x3a568c;if(_0x54a5da['startsWith']('./')||_0x54a5da['startsWith']('../')||_0x54a5da['startsWith']('/')||_0x54a5da['startsWith']('file://')||!_0x2d7ee2(_0x3a568c)||_0x58c5b3['has'](_0x3a568c))return;_0x58c5b3['add'](_0x3a568c),_0x54a5da['startsWith']('npm:')&&(_0x54a5da=_0x54a5da['substring'](0x4)),_0x54a5da['includes']('@')&&!_0x54a5da['startsWith']('@')&&(_0x54a5da=_0x54a5da['split']('@')[0x0]);let _0xd308be=_0x54a5da['split']('/')[0x0];_0x407af4['includes'](_0xd308be)||_0x407af4['includes'](_0x3a568c)||_0x2ff9dd['push'](_0x3a568c);},_0x322238;for(;(_0x322238=_0x4e7837['exec'](_0x3d71a1))!==null;)_0x1e4bea(_0x322238[0x1]);for(;(_0x322238=_0x11190e['exec'](_0x3d71a1))!==null;)_0x1e4bea(_0x322238[0x1]);for(;(_0x322238=_0x5ce690['exec'](_0x3d71a1))!==null;)_0x1e4bea(_0x322238[0x1]);return{'valid':_0x2ff9dd['length']===0x0,'violations':_0x2ff9dd,'serverPath':_0x1184cc};}['validate'](_0xa3a864={}){let _0x2e3c8b=[],_0x15fad0=this['manifest']['permissions']||{};try{let _0x3f0d46=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x3f0d46);}catch{}let _0x4b8a2a=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x21eddc,_0x54c20f]of Object['entries'](_0x15fad0))if(_0x21eddc==='hrtime')typeof _0x54c20f!='boolean'&&_0x2e3c8b['push']('Permission\x20\x27'+_0x21eddc+'\x27\x20must\x20be\x20boolean');else{if(_0x21eddc==='langchain')typeof _0x54c20f!='boolean'&&(typeof _0x54c20f!='object'||_0x54c20f===null)?_0x2e3c8b['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x54c20f=='object'&&(_0x54c20f===null||!('enabled'in _0x54c20f)||typeof _0x54c20f['enabled']!='boolean')&&_0x2e3c8b['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x21eddc==='kv')typeof _0x54c20f!='boolean'&&_0x2e3c8b['push']('Permission\x20\x27'+_0x21eddc+'\x27\x20must\x20be\x20boolean');else{if(_0x21eddc==='mspbots')Array['isArray'](_0x54c20f)||_0x2e3c8b['push']('Permission\x20\x27'+_0x21eddc+'\x27\x20must\x20be\x20an\x20array');else{if(_0x21eddc==='db'){if(typeof _0x54c20f!='object'||_0x54c20f===null||Array['isArray'](_0x54c20f))_0x2e3c8b['push']('Permission\x20\x27'+_0x21eddc+'\x27\x20must\x20be\x20an\x20object');else{let _0x4b6b7d=_0x54c20f,_0x1aa146=['user','password']['filter'](_0x1832c3=>!(_0x1832c3 in _0x4b6b7d));_0x1aa146['length']>0x0&&_0x2e3c8b['push']('Permission\x20\x27'+_0x21eddc+'\x27\x20missing\x20required\x20fields:\x20'+_0x1aa146['join'](',\x20'));}}else{if(_0x21eddc==='imports')continue;_0x4b8a2a['has'](_0x21eddc)||typeof _0x54c20f!='boolean'&&!Array['isArray'](_0x54c20f)&&_0x2e3c8b['push']('Permission\x20\x27'+_0x21eddc+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x39b8cc=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x39b8cc))_0x2e3c8b['push']('permissions.imports must be an array');else{for(let _0x5696bc of _0x39b8cc)typeof _0x5696bc!='string'&&_0x2e3c8b['push']('import\x20\x27'+_0x5696bc+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x2e3c8b['length']===0x0,'errors':_0x2e3c8b};}};function q(_0x460ca6,_0x54c183,_0x4cdcfe){return new D(_0x460ca6,_0x54c183,_0x4cdcfe||{});}var R=null;function I(){let _0x260925=globalThis['Deno'];if(!_0x260925)throw new Error('Deno is not available');return _0x260925;}async function K(){if(R)return{...R};try{let _0x370924=I(),_0x23b525=join(_0x370924['cwd'](),'deno.json'),_0x581797=await _0x370924['readTextFile'](_0x23b525);return R=JSON['parse'](_0x581797)['imports']||{},{...R};}catch(_0x42ce6b){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x42ce6b),{};}}var E=class{constructor(_0x38a759,_0x565de5={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x38a759['appsDir'],this['platformImportsOverride']=_0x38a759['platformImports'],this['libDir']=_0x38a759['libDir'],this['events']=_0x565de5);}async['create'](_0x389cab,_0x3a0568,_0x52b766){try{return await this['createWorker'](_0x389cab,_0x3a0568,_0x52b766);}catch(_0x22a222){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x389cab+':',_0x22a222),_0x22a222;}}async['createWorker'](_0x354ecf,_0x4cde6d,_0x52c584){let _0x26c36c=this['platformImportsOverride']||await K(),_0x395f24=q(_0x4cde6d,this['libDir'],_0x26c36c)['validateServerImports'](this['appsDir']);if(!_0x395f24['valid']){let _0x426387=_0x395f24['violations']['filter'](_0x527950=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x527950)),_0x1f3e4e=_0x395f24['serverPath']?_0x395f24['serverPath']:(_0x4cde6d['name']||_0x4cde6d['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x1f3e4e+':\x20'+_0x426387['join'](',\x20'));}let _0x3942b1=q(_0x4cde6d,this['libDir'],_0x26c36c),_0x3bc9dc=_0x3942b1['validate'](_0x26c36c);if(!_0x3bc9dc['valid'])throw new Error('Invalid\x20config:\x20'+_0x3bc9dc['errors']['join'](',\x20'));let _0x26053c=_0x3942b1['buildImportMap'](_0x26c36c);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x354ecf+':',_0x26053c);let _0x4d504a=_0x3942b1['buildPerms'](),_0x2a999e=_0x3942b1['getReadPaths']();if(_0x4d504a['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x4d504a['read']);else{let _0x58e0e6=_0x4cde6d['name']||_0x354ecf,_0x4654ab=this['appsDir']+'/'+_0x58e0e6,_0x38395f=[_0x4654ab],_0x18d8ba=_0x4cde6d['metadata']?.['serverPath'];if(_0x18d8ba&&typeof _0x18d8ba=='string')try{let _0x3624f2=dirname(_0x18d8ba)['replace'](/\\/g,'/');_0x38395f['push'](_0x3624f2);}catch{}_0x4d504a['read']=_0x38395f,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x4654ab);}if(_0x2a999e['length']>0x0){if(_0x4d504a['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x353199=Array['isArray'](_0x4d504a['read'])?_0x4d504a['read']:[];_0x4d504a['read']=[..._0x353199,..._0x2a999e],console['log']('[Worker] Added package read permissions:',_0x2a999e);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x4d504a['net']||(_0x4d504a['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x354ecf+':',_0x4d504a['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x4d504a['read']===!![]?'unrestricted':Array['isArray'](_0x4d504a['read'])?_0x4d504a['read']['length']:0x0));let _0x4b5fd6=await this['createImportMap'](_0x354ecf,_0x26053c),_0x1e6f9d=await this['createLock'](_0x354ecf,_0x26053c),_0x359e81={'type':'module','deno':{'permissions':{}}};_0x359e81['deno']['namespace']=![],_0x359e81['deno']['permissions']=_0x4d504a,_0x359e81['deno']['importMap']=_0x4b5fd6,_0x359e81['deno']['lock']=_0x1e6f9d,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x354ecf+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x4b5fd6),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x1e6f9d),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x26053c)['length']+'\x20('+(Object['keys'](_0x26053c)['join'](',\x20')||'none')+')');let _0x40959c={'worker':new Worker(_0x52c584,_0x359e81),'appId':_0x354ecf,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x4cde6d,'importMapPath':_0x4b5fd6,'lockfilePath':_0x1e6f9d};return this['workers']['set'](_0x354ecf,_0x40959c),this['events']['onCreate']?.(_0x40959c),_0x40959c;}async['createLock'](_0xb5a7c9,_0x27a9e9){let _0x1ddea1=I(),_0x1a88a6=join(_0x1ddea1['cwd'](),'storage','temp','lockfiles');await _0x1ddea1['mkdir'](_0x1a88a6,{'recursive':!![]});let _0x1f65ae=_0xb5a7c9+'-'+Date['now']()+'.lock',_0x148656=join(_0x1a88a6,_0x1f65ae),_0x23855a={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x364764,_0x1a824e]of Object['entries'](_0x27a9e9))if(_0x1a824e['startsWith']('npm:'))_0x1a824e['replace']('npm:',''),_0x23855a['packages']['specifiers'][_0x364764]=_0x1a824e;else _0x1a824e['startsWith']('file://')&&(_0x23855a['packages']['specifiers'][_0x364764]=_0x1a824e);let _0x15d9ae=JSON['stringify'](_0x23855a,null,0x2);return await _0x1ddea1['writeTextFile'](_0x148656,_0x15d9ae),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x148656),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x27a9e9)['length']+'):',Object['keys'](_0x27a9e9)),_0x148656;}async['createImportMap'](_0x1f4f53,_0x1e14d8){let _0x453b0b=I(),_0x13fdb5=join(_0x453b0b['cwd'](),'storage','temp','importmaps');await _0x453b0b['mkdir'](_0x13fdb5,{'recursive':!![]});let _0x17dc2d=_0x1f4f53+'-'+Date['now']()+'.json',_0x70393f=join(_0x13fdb5,_0x17dc2d),_0x54e619=JSON['stringify']({'imports':_0x1e14d8,'scopes':{}},null,0x2);return await _0x453b0b['writeTextFile'](_0x70393f,_0x54e619),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x70393f),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x1e14d8)['length']+'):',Object['keys'](_0x1e14d8)['join'](',\x20')||'none'),_0x70393f;}['get'](_0x509a1d){return this['workers']['get'](_0x509a1d);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0xec6304,_0x53a167){let _0x29e7cb=this['workers']['get'](_0xec6304);if(!_0x29e7cb)return;let _0x44d37e=_0x29e7cb['status'];_0x29e7cb['status']=_0x53a167,_0x53a167==='running'&&_0x44d37e==='starting'?this['events']['onReady']?.(_0x29e7cb):_0x53a167==='crashed'&&this['events']['onCrash']?.(_0x29e7cb);}['touch'](_0x238a98){let _0x3ccf2f=this['workers']['get'](_0x238a98);_0x3ccf2f&&(_0x3ccf2f['lastUsed']=Date['now']());}async['stop'](_0x52cc9a){let _0x5b9c7d=this['workers']['get'](_0x52cc9a);if(_0x5b9c7d)try{_0x5b9c7d['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x5b9c7d['worker']['terminate'](),_0x5b9c7d['status']='stopped',this['events']['onStop']?.(_0x5b9c7d),_0x5b9c7d['importMapPath']&&await this['cleanupImportMap'](_0x5b9c7d['importMapPath']),_0x5b9c7d['lockfilePath']&&await this['cleanupLock'](_0x5b9c7d['lockfilePath']);}catch(_0x323704){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x52cc9a+':',_0x323704);}finally{this['workers']['delete'](_0x52cc9a);}}async['cleanupImportMap'](_0x37536b){try{await I()['remove'](_0x37536b),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x37536b);}catch(_0x20c6d0){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x37536b,_0x20c6d0);}}async['cleanupLock'](_0x10be22){try{await I()['remove'](_0x10be22),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x10be22);}catch(_0x6b96de){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x10be22,_0x6b96de);}}async['stopAll'](){let _0xe3ea62=Array['from'](this['workers']['keys']());await Promise['all'](_0xe3ea62['map'](_0x5bafb7=>this['stop'](_0x5bafb7)));}async['restart'](_0x2c90a5,_0x5d5028){let _0xd5fecc=this['workers']['get'](_0x2c90a5);if(!_0xd5fecc)throw new Error('Worker\x20'+_0x2c90a5+'\x20not\x20found');let _0x1ae1eb=_0xd5fecc['manifest'];return await this['stop'](_0x2c90a5),await this['create'](_0x2c90a5,_0x1ae1eb,_0x5d5028);}['checkHealth'](_0x144440){let _0xdcbc39=this['workers']['get'](_0x144440);if(!_0xdcbc39)return{'healthy':![],'reason':'Not\x20found'};if(_0xdcbc39['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0xdcbc39['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x3ab359=Date['now']()-_0xdcbc39['lastUsed'],_0x13ee5d=0x708*0x3e8;return _0x3ab359>_0x13ee5d?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x3ab359/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x41b9b5=0x708*0x3e8,_0x2cd910){let _0x3c2c8d=Date['now'](),_0x342cf6=[];for(let [_0x90eba1,_0x2a20c3]of this['workers']['entries']()){let _0x56e592=_0x3c2c8d-_0x2a20c3['lastUsed'];_0x56e592>_0x41b9b5&&_0x342cf6['push']({'appId':_0x90eba1,'idle':_0x56e592});}_0x342cf6['sort']((_0x3050cf,_0x52eb81)=>_0x52eb81['idle']-_0x3050cf['idle']);let _0x466581=_0x2cd910?_0x342cf6['slice'](0x0,_0x2cd910)['map'](_0x17fe0a=>_0x17fe0a['appId']):_0x342cf6['map'](_0x1d1935=>_0x1d1935['appId']);for(let _0xc0e019 of _0x466581)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0xc0e019),await this['stop'](_0xc0e019);}['stats'](){let _0x4bca55={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x6f432b=Date['now']();for(let _0x3d1327 of this['workers']['values']())_0x4bca55['byStatus'][_0x3d1327['status']]++,_0x4bca55['workers']['push']({'appId':_0x3d1327['appId'],'status':_0x3d1327['status'],'version':_0x3d1327['version'],'lastUsed':_0x3d1327['lastUsed'],'idle':_0x6f432b-_0x3d1327['lastUsed']});return _0x4bca55;}['startCleanup'](_0x5693a3=0x12c*0x3e8,_0x3ef37b){let _0x25bb94=setInterval(()=>{this['cleanup'](_0x3ef37b)['catch'](_0x159c04=>{console['error']('Cleanup\x20failed:',_0x159c04);});},_0x5693a3);return()=>clearInterval(_0x25bb94);}['delay'](_0x158738){return new Promise(_0x5f3681=>setTimeout(_0x5f3681,_0x158738));}};function W(_0x2f26e4,_0x285e95){return new E(_0x2f26e4,_0x285e95);}var v=f,j=class{constructor(_0x5df6d9,_0x221d71=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x5df6d9,this['timeout']=_0x221d71);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0xac0d8f){_0xac0d8f['worker']['onmessage']=_0x28c82d=>{let _0x1af547=_0x28c82d['data'],{appId:_0x29249f}=_0xac0d8f;switch(_0x1af547['type']){case'ready':this['events']['onReady'](_0x29249f),v['info']('Worker\x20ready',{'appId':_0x29249f,'version':_0xac0d8f['version']});break;case'log':{let {level:_0x551bde='info',message:_0x508c43,meta:_0x11e05b}=_0x1af547,_0x25058b={..._0x11e05b||{},'appId':_0x29249f,'version':_0xac0d8f['version']};this['events']['onLog'](_0x29249f,_0x551bde,_0x508c43,_0x25058b);break;}case'result':{let {reqId:_0x3a5e73,ok:_0x1537dd,response:_0x574b76,error:_0x20de2b}=_0x1af547,_0x27fbc5=this['pending']['get'](_0x3a5e73);if(!_0x27fbc5){v['warn']('Unknown\x20request',{'appId':_0x29249f,'reqId':_0x3a5e73});return;}if(this['pending']['delete'](_0x3a5e73),_0x1537dd&&_0x574b76)_0x27fbc5['resolve'](_0x574b76);else{let _0xa0a73d=new Error(_0x20de2b?.['message']||'Worker\x20error');_0xa0a73d['stack']=_0x20de2b?.['stack'],_0x27fbc5['reject'](_0xa0a73d);}this['events']['onResult'](_0x29249f,_0x3a5e73,_0x574b76||_0x20de2b);break;}default:v['debug']('Unknown\x20message',{'appId':_0x29249f,'type':_0x1af547['type']});}},_0xac0d8f['worker']['onerror']=_0x2e0048=>{let {appId:_0x3fcb7f}=_0xac0d8f;v['error']('Worker\x20error',{'appId':_0x3fcb7f,'message':_0x2e0048['message'],'lineno':_0x2e0048['lineno'],'filename':_0x2e0048['filename']}),_0xac0d8f['status']='crashed',this['rejectPending'](_0x3fcb7f,new Error('Worker\x20'+_0x3fcb7f+'\x20crashed:\x20'+_0x2e0048['message'])),_0x2e0048['preventDefault']();},_0xac0d8f['worker']['onmessageerror']=_0x284245=>{let {appId:_0x5da1a3}=_0xac0d8f;v['error']('Message\x20error',{'appId':_0x5da1a3,'data':_0x284245['data']}),_0xac0d8f['status']='crashed',_0x284245['preventDefault']();};}['sendInit'](_0x242e67,_0x1fef43,_0x914c30,_0x2a6d4c){_0x242e67['worker']['postMessage']({'type':'init','appId':_0x242e67['appId'],'manifest':_0x914c30,'appsDir':_0x1fef43,'serverPath':_0x2a6d4c});}async['sendInvoke'](_0x5d1004,_0xbd14a7){let _0x3dfb97=this['nextId'](),_0x220f3d=_0x5d1004['appId'],_0x39210f=new Promise((_0x468dc1,_0x13cce2)=>{let _0x60cf84=setTimeout(()=>{this['pending']['delete'](_0x3dfb97),_0x13cce2(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x3dfb97,{'resolve':_0x5d88eb=>{clearTimeout(_0x60cf84),_0x468dc1(_0x5d88eb);},'reject':_0x5b748d=>{clearTimeout(_0x60cf84),_0x13cce2(_0x5b748d);},'timestamp':Date['now'](),'appId':_0x220f3d});});return _0x5d1004['worker']['postMessage']({'type':'invoke','appId':_0x5d1004['appId'],'reqId':_0x3dfb97,'payload':_0xbd14a7}),await _0x39210f;}['rejectPending'](_0x109e1f,_0x159352){let _0x25db64=0x0;for(let [_0x402b80,_0x3817dd]of this['pending']['entries']())_0x3817dd['appId']===_0x109e1f&&(this['pending']['delete'](_0x402b80),_0x3817dd['reject'](_0x159352),_0x25db64++);_0x25db64>0x0&&v['warn']('Rejected\x20'+_0x25db64+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x109e1f});}['cleanupTimeout'](){let _0x2bfeb5=Date['now']();for(let [_0x47162e,_0x2231e5]of this['pending']['entries']())_0x2bfeb5-_0x2231e5['timestamp']>this['timeout']&&(this['pending']['delete'](_0x47162e),_0x2231e5['reject'](new Error('Request\x20'+_0x47162e+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x4eff2c){let _0x219f41=0x0;for(let _0x38e32 of this['pending']['values']())_0x38e32['appId']===_0x4eff2c&&_0x219f41++;return _0x219f41;}['startCleanup'](_0x155ea1=0x2710){let _0x26c652=setInterval(()=>{this['cleanupTimeout']();},_0x155ea1);return()=>clearInterval(_0x26c652);}};function $(_0x32c13c,_0x11d805){return new j(_0x32c13c,_0x11d805);}var Q=class{constructor(_0xd581fb={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0xd581fb['logger']||f,this['config']={'appsDir':_0xd581fb['appsDir']||this['getAppsDir'](),'scriptUrl':_0xd581fb['scriptUrl']||this['getScriptUrl'](),'timeout':_0xd581fb['timeout']||0x78*0x3e8,'autoCleanup':_0xd581fb['autoCleanup']??!![],'cleanupInterval':_0xd581fb['cleanupInterval']||0x168*0x3e8,'maxIdle':_0xd581fb['maxIdle']||0xb4*0x3e8,'maxWorkers':_0xd581fb['maxWorkers'],'reuseWorkers':_0xd581fb['reuseWorkers']??!![],'workerReuseStrategy':_0xd581fb['workerReuseStrategy']||'lru','enableQueue':_0xd581fb['enableQueue']??!![],'maxQueueSize':_0xd581fb['maxQueueSize']||0x64,'queueTimeout':_0xd581fb['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0xb14c10=>this['logger']['info']('Worker\x20created',{'appId':_0xb14c10['appId'],'v':_0xb14c10['version']}),'onReady':_0xf1660=>this['lifecycle']['updateStatus'](_0xf1660['appId'],'running'),'onCrash':_0x3047c3=>this['logger']['error']('Worker\x20crashed',{'appId':_0x3047c3['appId'],'v':_0x3047c3['version']}),'onStop':_0x1330ee=>this['logger']['info']('Worker\x20stopped',{'appId':_0x1330ee['appId'],'v':_0x1330ee['version']})}),this['messaging']=$({'onReady':_0x34d34e=>this['lifecycle']['updateStatus'](_0x34d34e,'running'),'onLog':(_0x52c197,_0x26b621,_0x5df7a7,_0x6db9b3)=>{let _0x5158d8={..._0x6db9b3||{},'appId':_0x52c197};switch(_0x26b621){case'error':this['logger']['error'](_0x5df7a7,_0x5158d8);break;case'warn':this['logger']['warn'](_0x5df7a7,_0x5158d8);break;case'debug':this['logger']['debug'](_0x5df7a7,_0x5158d8);break;default:this['logger']['info'](_0x5df7a7,_0x5158d8);break;}},'onResult':(_0x38323b,_0x5a95e8,_0x5053e3)=>{this['logger']['debug']('Result\x20received',{'appId':_0x38323b,'reqId':_0x5a95e8});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x34077b['cwd'](),'apps');}['getScriptUrl'](){let _0x595246=import.meta.url,_0x257e13=_0x595246['endsWith']('.js')||_0x595246['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x257e13,_0x595246)['href'];}async['ensure'](_0x388f93){let {id:_0x211427}=_0x388f93,_0x44f018=this['lifecycle']['get'](_0x211427);if(_0x44f018){let _0x2d4082=this['lifecycle']['checkHealth'](_0x211427);if(_0x2d4082['healthy'])return this['lifecycle']['touch'](_0x211427),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x211427}),_0x44f018;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x211427,'reason':_0x2d4082['reason']}),await this['lifecycle']['stop'](_0x211427);}for(;;){let _0x316562=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x316562>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x316562,'max':this['config']['maxWorkers'],'appId':_0x211427}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x388f93);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x2848a8=await this['loadManifest'](_0x211427,_0x388f93['manifest']),_0x37274c=await this['lifecycle']['create'](_0x211427,_0x2848a8,this['config']['scriptUrl']),_0x469aa3=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x469aa3>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x469aa3,'max':this['config']['maxWorkers'],'appId':_0x211427}),await this['lifecycle']['stop'](_0x211427),this['config']['enableQueue'])return await this['waitSlot'](_0x388f93);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x469aa3+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x37274c);let _0x547bcf=_0x2848a8['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x37274c,this['config']['appsDir'],_0x2848a8,_0x547bcf),this['logger']['info']('Worker\x20created',{'appId':_0x211427,'v':_0x37274c['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x37274c;}async['evictIdle'](){let _0x2c4187=this['lifecycle']['getAll']();if(_0x2c4187['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x1cf56a=[..._0x2c4187];this['config']['workerReuseStrategy']==='lru'?_0x1cf56a['sort']((_0x501bf7,_0x107e3f)=>_0x501bf7['lastUsed']-_0x107e3f['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x1cf56a['sort']((_0x3718de,_0x250d16)=>_0x3718de['version']-_0x250d16['version']);let _0x18a1b1=null;for(let _0x367c9f of _0x1cf56a)if(this['messaging']['getAppCount'](_0x367c9f['appId'])===0x0){_0x18a1b1=_0x367c9f;break;}if(!_0x18a1b1&&_0x1cf56a['length']>0x0&&(_0x18a1b1=_0x1cf56a['reduce']((_0x1cc724,_0x2ab2c7)=>{let _0x5eb5a3=this['messaging']['getAppCount'](_0x1cc724['appId']);return this['messaging']['getAppCount'](_0x2ab2c7['appId'])<_0x5eb5a3?_0x2ab2c7:_0x1cc724;})),_0x18a1b1){let _0x5d98b6=this['messaging']['getAppCount'](_0x18a1b1['appId']);return _0x5d98b6>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x18a1b1['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x18a1b1['lastUsed'],'pendingRequests':_0x5d98b6}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x18a1b1['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x18a1b1['lastUsed']}),await this['lifecycle']['stop'](_0x18a1b1['appId']),!![];}return![];}['waitSlot'](_0x543b68){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x2d067d,_0x5a2d21)=>{let _0x5a291b={'info':_0x543b68,'resolve':_0x2d067d,'reject':_0x5a2d21,'timestamp':Date['now']()};this['requestQueue']['push'](_0x5a291b),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x543b68['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x242c61=setTimeout(()=>{let _0x4662d7=this['requestQueue']['indexOf'](_0x5a291b);_0x4662d7!==-0x1&&(this['requestQueue']['splice'](_0x4662d7,0x1),_0x5a2d21(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x5a291b['resolve']=_0x201a39=>{clearTimeout(_0x242c61),_0x2d067d(_0x201a39);},_0x5a291b['reject']=_0x797cb9=>{clearTimeout(_0x242c61),_0x5a2d21(_0x797cb9);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x159565=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x159565>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x200f71=this['requestQueue']['shift']();if(!_0x200f71)break;try{let _0x5aff63=await this['ensure'](_0x200f71['info']);_0x200f71['resolve'](_0x5aff63);}catch(_0x1ae72f){_0x200f71['reject'](_0x1ae72f);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x37ef19,_0x3b4f0e){let _0x429580=this['config']['appsDir']['replace'](/\\/g,'/'),_0x4b9531=async _0x1c03b6=>{try{let _0x3828b1=globalThis['Deno'];if(!_0x3828b1)return null;let _0xa5775c=await _0x3828b1['readTextFile'](_0x1c03b6);return JSON['parse'](_0xa5775c);}catch{return null;}};if(_0x3b4f0e?.['name']){let _0x427efa=await _0x4b9531(_0x429580+'/'+_0x3b4f0e['name']+'/manifest.json');if(_0x427efa)return _0x427efa;}let _0x1415d0=await _0x4b9531(_0x429580+'/'+_0x37ef19+'/manifest.json');if(_0x1415d0)return _0x1415d0;try{let _0x2e7261=globalThis['Deno'];if(_0x2e7261)for await(let _0x484504 of _0x2e7261['readDir'](_0x429580)){if(!_0x484504['isDirectory'])continue;let _0x3e1c24=_0x429580+'/'+_0x484504['name']+'/manifest.json',_0x42d9e8=await _0x4b9531(_0x3e1c24);if(_0x42d9e8&&(_0x42d9e8['id']===_0x37ef19||_0x3b4f0e?.['name']&&_0x42d9e8['name']===_0x3b4f0e['name']))return _0x42d9e8;}}catch(_0x3e2c9e){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x37ef19,'error':_0x3e2c9e['message']});}return _0x3b4f0e||{'id':_0x37ef19,'name':_0x37ef19,'version':'1.0.0'};}async['invoke'](_0x3ed0ec){let _0x297b52=_0x3ed0ec['ctx']['app']['id'],_0x10e6e4=_0x3ed0ec['ctx']['app']['name'];try{let _0x58a157={'id':_0x297b52,'manifest':{'id':_0x297b52,'name':_0x10e6e4}},_0x43c09d=await this['ensure'](_0x58a157);if(_0x43c09d['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x297b52}),await this['restart'](_0x297b52);let _0x3f5f7c=await this['ensure'](_0x58a157);return this['lifecycle']['touch'](_0x297b52),await this['messaging']['sendInvoke'](_0x3f5f7c,_0x3ed0ec);}return this['lifecycle']['touch'](_0x297b52),await this['messaging']['sendInvoke'](_0x43c09d,_0x3ed0ec);}catch(_0x694044){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x297b52,'error':_0x694044['message'],'stack':_0x694044['stack']}),_0x694044;}}async['stop'](_0x56910e){await this['lifecycle']['stop'](_0x56910e),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x4bb70e){return await this['lifecycle']['restart'](_0x4bb70e,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x508cda=>({'appId':_0x508cda['appId'],'status':_0x508cda['status'],'version':_0x508cda['version'],'lastUsed':_0x508cda['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x5750ed=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x2f3e12=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x5750ed(),_0x2f3e12();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x2ea87e=>{_0x2ea87e?(await this['stop'](_0x2ea87e),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x2ea87e})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x4560a2){return new Q(_0x4560a2);}var S=null;function be(_0x4d169c){S=ee(_0x4d169c);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x192011){return await k()['ensure'](_0x192011);}async function xe(_0x337715){return await k()['invoke'](_0x337715);}function Ie(_0x3aa46d){k()['stop'](_0x3aa46d)['catch'](_0x37c2c0=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x3aa46d,'error':_0x37c2c0['message']});});}function Re(){k()['stopAll']()['catch'](_0x159f73=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x159f73['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0xf9e4a3){await k()['stop'](_0xf9e4a3);}async function Se(){await k()['stopAll']();}function Ae(_0x260b38){let _0x482d0b=_0x260b38&&typeof _0x260b38=='object'?_0x260b38:null;if(_0x482d0b&&'user'in _0x482d0b)return _0x482d0b['user'];}function H(_0x5ddde5){let _0x146c3e=_0x5ddde5&&typeof _0x5ddde5=='object'?_0x5ddde5:null;if(!_0x146c3e)return{};let _0x489751={};for(let [_0x5ca747,_0x577b0b]of Object['entries'](_0x146c3e))_0x5ca747!=='user'&&(_0x489751[_0x5ca747]=_0x577b0b);return _0x489751;}function O(_0x5d7770){return _0x5d7770?{'id':_0x5d7770['manifest']?.['id']||_0x5d7770['id']||'','name':_0x5d7770['manifest']?.['name']||'','version':_0x5d7770['manifest']?.['version']||'','description':_0x5d7770['manifest']?.['description']||'','icon':_0x5d7770['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x12b792){return _0x12b792?.['permissions']||_0x12b792?.['manifest']?.['permissions']||{};}function F(_0x5455b2){return _0x5455b2?.['manifest']?.['metadata']||{};}function Ce(_0x136feb){return _0x136feb?{'appId':_0x136feb['id'],'appName':_0x136feb['manifest']?.['name']}:{};}function N(_0x1d91a3,_0x26ae56={}){let {appInfo:_0x5ac2d3=null,status:_0x4a724d=0x1f4,defaultMessage:_0x116766='Internal\x20Server\x20Error'}=_0x26ae56,_0x453158={'error':_0x116766,'message':_0x1d91a3?.['message']||_0x116766};return _0x5ac2d3&&(_0x453158['appId']=_0x5ac2d3['id'],_0x453158['appName']=_0x5ac2d3['manifest']?.['name']),_0x1d91a3?.['message']?.['includes']('crashed')&&(_0x453158['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x4a724d,'body':_0x453158};}function qe(_0x2e6120){return _0x2e6120?.['message']?.['includes']('crashed')||![];}function J(_0xa45371){if(_0xa45371)try{return JSON['parse'](_0xa45371);}catch{return _0xa45371;}}function B(_0x361614){try{let _0x31aaf8=new URL(_0x361614),_0x11585a={};for(let _0x537c3f of _0x31aaf8['searchParams']['keys']()){let _0x1d3995=_0x31aaf8['searchParams']['getAll'](_0x537c3f)['map'](_0x411f62=>_0x411f62);_0x1d3995['length']<=0x1?_0x11585a[_0x537c3f]=_0x1d3995[0x0]??'':_0x11585a[_0x537c3f]=_0x1d3995;}return _0x11585a;}catch{return{};}}function Le(_0x25e541){return(()=>{try{return new URL(_0x25e541)['pathname'];}catch{return _0x25e541;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x1414e0,_0x34e05d){let _0x237ce3=_0x1414e0;if(_0x34e05d&&_0x237ce3['startsWith']('/apps/'+_0x34e05d))_0x237ce3=_0x237ce3['substring'](('/apps/'+_0x34e05d)['length'])||'/';else{let _0x3c8bd3=_0x237ce3['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x3c8bd3&&(_0x237ce3=_0x3c8bd3[0x1]||'/');}return _0x237ce3['startsWith']('/api')&&(_0x237ce3=_0x237ce3['substring'](0x4)||'/'),_0x237ce3;}function Ue(_0x56617e,_0x1cfb99){let _0x292faa=_0x56617e;if(_0x1cfb99&&_0x292faa['startsWith']('/apps/'+_0x1cfb99))_0x292faa=_0x292faa['substring'](('/apps/'+_0x1cfb99)['length'])||'/';else{let _0x205e43=_0x292faa['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x205e43&&(_0x292faa=_0x205e43[0x1]||'/');}return(!_0x292faa||_0x292faa==='/')&&(_0x292faa='/index.html'),_0x292faa;}async function He(_0x3f03b2,_0x260682){return await _0x260682(_0x3f03b2);}function _(_0x30a011){return _0x30a011['split']('/')['filter'](_0x466d4f=>_0x466d4f['length']>0x0);}function te(_0x171f48){try{return decodeURIComponent(_0x171f48);}catch{return _0x171f48;}}function re(_0x5ec2d0,_0x362f85){let _0x1e63b5=_(_0x5ec2d0),_0x1e0b7f=_(_0x362f85),_0x3fd654={},_0x446240=0x0,_0x7692da=0x0;for(;_0x446240<_0x1e63b5['length']&&_0x7692da<_0x1e0b7f['length'];){let _0x185040=_0x1e63b5[_0x446240],_0x457974=_0x1e0b7f[_0x7692da];if(_0x185040==='*')break;if(_0x185040['startsWith'](':')){let _0x15b756=_0x185040['slice'](0x1);_0x15b756&&(_0x3fd654[_0x15b756]=te(_0x457974)),_0x446240++,_0x7692da++;continue;}if(_0x185040!==_0x457974)return{};_0x446240++,_0x7692da++;}return _0x446240===_0x1e63b5['length']||_0x446240===_0x1e63b5['length']-0x1&&_0x1e63b5[_0x446240]==='*',_0x3fd654;}async function Oe(_0x761ba3,_0x256f10,_0x17b3ac,_0x5d5f56,_0x269321=void 0x0,_0x28aafd){let _0x1f455e=await _0x256f10['text'](),_0x5d0522=J(_0x1f455e),_0x5a85d3=B(_0x256f10['url']),_0x54d270={...F(_0x761ba3),'user':_0x269321},_0x59ef96=H(_0x54d270),_0x405ab4=_0x28aafd?re(_0x28aafd,_0x256f10['path']):{};return{'app':O(_0x761ba3),'permissions':T(_0x761ba3),'user':_0x269321,'metadata':_0x59ef96,'body':_0x5d0522,'query':_0x5a85d3,'params':_0x405ab4,'method':_0x17b3ac,'pathname':_0x5d5f56,'requestUrl':_0x256f10['url'],'headers':Object['fromEntries'](_0x256f10['raw']['headers']['entries']())};}function Te(_0x38dda3){return{'method':_0x38dda3['method'],'pathname':_0x38dda3['pathname'],'ctx':_0x38dda3};}function Fe(_0x4100b0,_0x4dca92){let {status:_0x30277a=0xc8,headers:_0x363cc8={},body:_0x2b4f41,type:_0x5422e4}=_0x4100b0??{};return _0x5422e4==='raw'?new globalThis['Response'](String(_0x2b4f41??''),{'status':_0x30277a,'headers':_0x363cc8}):_0x4dca92(_0x2b4f41,_0x30277a);}function Ne(_0x312fdc,_0x46b817=null){return N(_0x312fdc,{'appInfo':_0x46b817});}var V=f;async function Ve(_0x12cca0){_0x12cca0?(await U(_0x12cca0),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x12cca0)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x1b6acb,_0x1ee1d2){let _0x248937=Object['fromEntries'](Object['entries'](_0x1b6acb['headers']||{})['map'](([_0x4a1121,_0x52b899])=>[_0x4a1121['toLowerCase'](),_0x52b899]));return{'id':_0x1b6acb['app']['id']||_0x1ee1d2['appId']||'','name':_0x1b6acb['app']['name']||'','version':_0x1b6acb['app']['version']||'','description':_0x1b6acb['app']['description']||'','metadata':{..._0x1b6acb['metadata'],'permissions':_0x1b6acb['permissions']},'body':_0x1b6acb['body'],'query':_0x1b6acb['query'],'params':_0x1b6acb?.['params'],'method':_0x1b6acb['method'],'pathname':_0x1b6acb['pathname'],'requestUrl':_0x1b6acb['requestUrl'],'user':_0x1b6acb['user'],'headers':_0x248937};}var L=class{constructor(_0x80aa63){this['handle']=null,(this['config']=_0x80aa63,this['logger']=_0x80aa63['logger']||f,this['lifecycle']=W({'appsDir':_0x80aa63['appsDir'],'timeout':_0x80aa63['timeout'],'platformImports':_0x80aa63['platformImports'],'libDir':_0x80aa63['libDir']},{'onCreate':_0x5be0ba=>this['logger']['info']('Worker\x20created',{'appId':_0x5be0ba['appId']}),'onReady':_0x362434=>{this['lifecycle']['updateStatus'](_0x362434['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x362434['appId']});},'onCrash':_0x3f3816=>this['logger']['error']('Worker\x20crashed',{'appId':_0x3f3816['appId']}),'onStop':_0x2455c4=>this['logger']['info']('Worker\x20stopped',{'appId':_0x2455c4['appId']})}),this['messaging']=$({'onReady':_0x90a1a9=>this['lifecycle']['updateStatus'](_0x90a1a9,'running'),'onLog':(_0x11bc89,_0x4a9201,_0x2024f8,_0x1d514a)=>{(this['logger'][_0x4a9201]||this['logger']['info'])['call'](this['logger'],_0x2024f8,_0x1d514a);},'onResult':()=>{}},_0x80aa63['timeout']||0x1d4c0));}async['create'](_0x41be73){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x5d3936=await this['lifecycle']['create'](this['config']['appId'],_0x41be73,this['config']['scriptUrl']);this['messaging']['setup'](_0x5d3936),this['messaging']['sendInit'](_0x5d3936,this['config']['appsDir'],_0x41be73,this['config']['serverPath']),this['handle']=_0x5d3936,await this['waitForReady']();}async['waitForReady'](_0x401c5f=0x2710){let _0xc0bc7c=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0xc0bc7c>_0x401c5f)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x132c70=>setTimeout(_0x132c70,0x64));}}async['invoke'](_0x41f4b2){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x41f4b2);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x43271d){return new L(_0x43271d);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};