'use strict';function c(_0x27f79d,_0x598087){let _0x297451=Object['fromEntries'](Object['entries'](_0x27f79d['headers']||{})['map'](([_0x1ecb28,_0x501cf1])=>[_0x1ecb28['toLowerCase'](),_0x501cf1]));return{'id':_0x27f79d['app']['id']||_0x598087['appId']||'','name':_0x27f79d['app']['name']||'','version':_0x27f79d['app']['version']||'','description':_0x27f79d['app']['description']||'','metadata':{..._0x27f79d['metadata'],'permissions':_0x27f79d['permissions']},'body':_0x27f79d['body'],'query':_0x27f79d['query'],'params':_0x27f79d?.['params'],'method':_0x27f79d['method'],'pathname':_0x27f79d['pathname'],'requestUrl':_0x27f79d['requestUrl'],'user':_0x27f79d['user'],'headers':_0x297451};}function f(_0x3d669e){return _0x3d669e['split']('/')['filter'](_0x226ebc=>_0x226ebc['length']>0x0);}function P(_0x4d80d7,_0x425849){let _0x44bc74=f(_0x4d80d7),_0x346e69=f(_0x425849),_0x1194b4=0x0,_0x369ea3=0x0;for(;_0x1194b4<_0x44bc74['length']&&_0x369ea3<_0x346e69['length'];){let _0x1fe686=_0x44bc74[_0x1194b4],_0x579001=_0x346e69[_0x369ea3];if(_0x1fe686==='*')return!![];if(_0x1fe686['startsWith'](':')){_0x1194b4++,_0x369ea3++;continue;}if(_0x1fe686!==_0x579001)return![];_0x1194b4++,_0x369ea3++;}return _0x1194b4===_0x44bc74['length']&&_0x369ea3===_0x346e69['length']||_0x1194b4===_0x44bc74['length']-0x1&&_0x44bc74[_0x1194b4]==='*';}function m(_0x4bf7a0,_0x44353c,_0x3c0c83){let _0x2bb92c=_0x44353c+'\x20'+_0x3c0c83;if(_0x4bf7a0[_0x2bb92c])return{'handler':_0x4bf7a0[_0x2bb92c],'routePattern':_0x3c0c83};let _0x355d99=[];_0x3c0c83['startsWith']('/api')?_0x355d99['push'](_0x3c0c83['substring'](0x4)||'/'):_0x355d99['push']('/api'+_0x3c0c83),_0x355d99['push'](_0x3c0c83);for(let _0x2b637b of _0x355d99)for(let _0x3029b3 of Object['keys'](_0x4bf7a0)){if(!_0x3029b3['startsWith'](_0x44353c+'\x20'))continue;let _0x5998ed=_0x3029b3['substring'](_0x44353c['length']+0x1);if(P(_0x5998ed,_0x2b637b))return{'handler':_0x4bf7a0[_0x3029b3],'routePattern':_0x5998ed};}return null;}function k(_0x85699){return typeof _0x85699=='function'?{'handler':_0x85699,'routePattern':''}:_0x85699;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x41c92f){let _0x155a24=async _0x540848=>{try{let _0x219595=globalThis['Deno'];if(!_0x219595)throw new Error('Deno is not available');return await _0x219595['stat'](_0x540848),!0x0;}catch{return![];}};if(_0x41c92f&&typeof _0x41c92f=='string'&&_0x41c92f['length']>0x0)return _0x41c92f;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x29027c=s['manifest']?.['metadata']?.['serverPath'];if(_0x29027c&&typeof _0x29027c=='string'&&_0x29027c['length']>0x0)return _0x29027c;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x57e795=s['manifest']['name'];if(!_0x57e795)throw new Error('Manifest\x20name\x20not\x20found');let _0x1a80e9=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x57e795+'/server.js',s['appsDir']+'/'+_0x57e795+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0xcb5798 of _0x1a80e9)if(await _0x155a24(_0xcb5798))return _0xcb5798;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x1a80e9['join'](',\x20'));}function R(){let _0x7ecea1=['log','info','warn','error','debug','trace'];for(let _0x41b044 of _0x7ecea1){let _0x2123e2=(console[_0x41b044]||console['log'])['bind'](console);console[_0x41b044]=(..._0x4773a5)=>{try{let _0x483964=_0x4773a5['map'](_0xa6830a=>{if(typeof _0xa6830a=='string')return _0xa6830a;if(_0xa6830a instanceof Error)return JSON['stringify']({'name':_0xa6830a['name'],'message':_0xa6830a['message'],'stack':_0xa6830a['stack']});if(typeof Request<'u'&&_0xa6830a instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0xa6830a['url'],'method':_0xa6830a['method'],'headers':Object['fromEntries'](_0xa6830a['headers']['entries']()),'bodyUsed':_0xa6830a['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0xa6830a instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0xa6830a['status'],'headers':Object['fromEntries'](_0xa6830a['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0xa6830a);}catch{return String(_0xa6830a);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x41b044==='log'?'info':_0x41b044,'message':_0x483964,'meta':{'appId':s['appId']}});}catch{_0x2123e2(..._0x4773a5);}};}}R();async function v(_0x458865){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x190cf0=(await w(_0x458865))['replace'](/\\/g,'/'),_0x1dd6e7=(_0x190cf0['startsWith']('file://')?_0x190cf0:'file://'+_0x190cf0)+'?t='+Date['now']();try{let _0x580377=await import(_0x1dd6e7);return s['module']=_0x580377,_0x580377;}catch(_0x3f0e0a){throw console['error']('Failed to load module:',_0x3f0e0a),_0x3f0e0a;}}function b(_0x2c169d){return _0x2c169d instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x2c169d,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x3a0f85){return _0x3a0f85['split']('/')['filter'](_0x4346bc=>_0x4346bc['length']>0x0);}function E(_0x270086){try{return decodeURIComponent(_0x270086);}catch{return _0x270086;}}function I(_0x4a0b4b,_0x1c35da){let _0x521f39=g(_0x4a0b4b),_0x168b54=g(_0x1c35da),_0x11351e={},_0x54221e=0x0,_0x376cbd=0x0;for(;_0x54221e<_0x521f39['length']&&_0x376cbd<_0x168b54['length'];){let _0x532ddc=_0x521f39[_0x54221e],_0x12630b=_0x168b54[_0x376cbd];if(_0x532ddc==='*')break;if(_0x532ddc['startsWith'](':')){let _0x4d0c61=_0x532ddc['slice'](0x1);_0x4d0c61&&(_0x11351e[_0x4d0c61]=E(_0x12630b)),_0x54221e++,_0x376cbd++;continue;}if(_0x532ddc!==_0x12630b)return{};_0x54221e++,_0x376cbd++;}return _0x54221e===_0x521f39['length']||_0x54221e===_0x521f39['length']-0x1&&_0x521f39[_0x54221e]==='*',_0x11351e;}function M(_0x4b4b92,_0x51e7c3){return _0x4b4b92['startsWith']('/api')&&!_0x51e7c3['startsWith']('/api')?_0x4b4b92['substring'](0x4)||'/':!_0x4b4b92['startsWith']('/api')&&_0x51e7c3['startsWith']('/api')?'/api'+(_0x4b4b92['startsWith']('/')?'':'/')+_0x4b4b92:_0x4b4b92;}async function W(_0x2c89df){let _0x12e7cf=_0x2c89df['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x12e7cf)&&await v(_0x12e7cf);let _0x28de47=_0x2c89df['ctx'],{method:_0x24ff2a,pathname:_0x34519d}=_0x28de47,_0x3e4bef=s['module']?.['default']||{},_0xba9546=m(_0x3e4bef,_0x24ff2a,_0x34519d);if(!_0xba9546)throw Object['assign'](new Error('Route\x20'+_0x24ff2a+'\x20'+_0x34519d+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x4c9ced=k(_0xba9546),_0x4ae47b=c(_0x28de47,s),_0x445a20=_0x34519d,_0x3f74d1=M(_0x4c9ced['routePattern'],_0x445a20),_0x4ff56d=_0x3f74d1?I(_0x3f74d1,_0x445a20):{},_0x4a22c8=await _0x4c9ced['handler']({..._0x4ae47b,'params':{..._0x4ae47b['params'],..._0x4ff56d}});return b(_0x4a22c8);}function D(_0x4c6a01){s['appId']=_0x4c6a01['appId'],s['manifest']=_0x4c6a01['manifest'],s['appsDir']=_0x4c6a01['appsDir'],s['serverPath']=_0x4c6a01['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x259e6e){let {reqId:_0x39acb0,payload:_0xf27088}=_0x259e6e;try{let _0x31a8c1=await W(_0xf27088);self['postMessage']({'type':'result','reqId':_0x39acb0,'ok':!0x0,'response':_0x31a8c1});}catch(_0x10bf75){let _0xa2989b=_0x10bf75;self['postMessage']({'type':'result','reqId':_0x39acb0,'ok':![],'error':{'message':_0xa2989b['message'],'stack':_0xa2989b['stack'],'code':_0xa2989b['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x1667a5=>{let _0x231e36=_0x1667a5['data'];try{switch(_0x231e36['type']){case'init':D(_0x231e36);break;case'invoke':await $(_0x231e36);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x231e36['type']);break;}}catch(_0x5f2c04){let _0x5f9688=_0x5f2c04;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x5f9688['message'],'stack':_0x5f9688['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x5f9688);}}},self['onerror']=_0x44c02e=>{let _0x2a78ea={'message':typeof _0x44c02e=='string'?_0x44c02e:_0x44c02e['message'],'filename':typeof _0x44c02e=='string'?void 0x0:_0x44c02e['filename'],'lineno':typeof _0x44c02e=='string'?void 0x0:_0x44c02e['lineno'],'colno':typeof _0x44c02e=='string'?void 0x0:_0x44c02e['colno'],'error':typeof _0x44c02e=='string'?void 0x0:_0x44c02e['error']?.['message'],'stack':typeof _0x44c02e=='string'?void 0x0:_0x44c02e['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x2a78ea);},self['onunhandledrejection']=_0x2a13bb=>{let _0x27bf3e=_0x2a13bb['reason'],_0x4ecf36={'appId':s['appId'],'reason':_0x27bf3e instanceof Error?_0x27bf3e['message']:String(_0x27bf3e),'stack':_0x27bf3e instanceof Error?_0x27bf3e['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x4ecf36);};