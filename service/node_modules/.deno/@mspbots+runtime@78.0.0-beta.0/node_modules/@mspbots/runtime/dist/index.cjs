'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0xacd0af){return _0xacd0af&&_0xacd0af['__esModule']?_0xacd0af:{'default':_0xacd0af};}var Y__default=_interopDefault(Y);async function ie(_0x22991f){try{return await promises['stat'](_0x22991f),!0x0;}catch{return![];}}var f={'error':(_0x252a14,_0x5a6abb)=>console['error']('[ERROR]\x20'+_0x252a14,_0x5a6abb),'warn':(_0x1d73fc,_0xc8d2f1)=>console['warn']('[WARN]\x20'+_0x1d73fc,_0xc8d2f1),'info':(_0x1f25ca,_0x4b146b)=>console['log']('[INFO]\x20'+_0x1f25ca,_0x4b146b),'debug':(_0x149362,_0x5313ef)=>console['log']('[DEBUG]\x20'+_0x149362,_0x5313ef)};function z(){let _0x34ac40=globalThis['Deno'];if(!_0x34ac40)throw new Error('Deno is not available');return _0x34ac40;}var D=class{constructor(_0x57862e,_0x3f89ed='./lib',_0x2e07e6={}){this['manifest']=_0x57862e,this['libDir']=_0x3f89ed,this['platformImports']=_0x2e07e6;}['buildPerms'](){let _0x1b8afb=this['manifest']['permissions']||{},_0x3efa82={};return _0x1b8afb['net']!==void 0x0&&(_0x3efa82['net']=_0x1b8afb['net']===!![]?!![]:Array['isArray'](_0x1b8afb['net'])?_0x1b8afb['net']:[]),_0x1b8afb['read']!==void 0x0&&(_0x3efa82['read']=_0x1b8afb['read']===!![]?!![]:Array['isArray'](_0x1b8afb['read'])?_0x1b8afb['read']:[]),_0x1b8afb['write']!==void 0x0&&(_0x3efa82['write']=_0x1b8afb['write']===!![]?!![]:Array['isArray'](_0x1b8afb['write'])?_0x1b8afb['write']:[]),_0x1b8afb['env']!==void 0x0&&(_0x3efa82['env']=_0x1b8afb['env']===!![]?!![]:Array['isArray'](_0x1b8afb['env'])?_0x1b8afb['env']:[]),_0x1b8afb['run']!==void 0x0&&(_0x3efa82['run']=_0x1b8afb['run']===!![]?!![]:Array['isArray'](_0x1b8afb['run'])?_0x1b8afb['run']:[]),_0x1b8afb['ffi']!==void 0x0&&(_0x3efa82['ffi']=_0x1b8afb['ffi']===!![]?!![]:Array['isArray'](_0x1b8afb['ffi'])?_0x1b8afb['ffi']:[]),_0x1b8afb['sys']!==void 0x0&&(_0x3efa82['sys']=_0x1b8afb['sys']===!![]?!![]:Array['isArray'](_0x1b8afb['sys'])?_0x1b8afb['sys']:[]),_0x1b8afb['hrtime']!==void 0x0&&(_0x3efa82['hrtime']=_0x1b8afb['hrtime']),_0x3efa82;}['normalize'](_0x5eb471){return _0x5eb471===!![]?[]:Array['isArray'](_0x5eb471)?_0x5eb471:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x127431){return path.join(this['libDir'],_0x127431+'@*');}['getReadPaths'](){let _0x4fd541=this['getImports']();_0x4fd541['includes']('*')&&(_0x4fd541=Object['keys'](this['platformImports']));let _0x46dbcb=[];console['log']('[Permissions] Building package path patterns for imports:',_0x4fd541);for(let _0x4a2d3c of _0x4fd541){let _0x3d846b=this['getLibPattern'](_0x4a2d3c);_0x46dbcb['push'](_0x3d846b),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x4a2d3c+'\x20->\x20'+_0x3d846b);}return console['log']('[Permissions] Final package path patterns:',_0x46dbcb),_0x46dbcb;}['buildImportMap'](_0x2446ab){let _0xf8f604=this['getImports'](),_0x10090f=_0xf8f604['includes']('*')?Object['keys'](_0x2446ab):_0xf8f604;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x10090f);let _0x33664c={};for(let _0x3858e1 of _0x10090f)if(_0x2446ab[_0x3858e1])_0x33664c[_0x3858e1]=_0x2446ab[_0x3858e1],console['log']('[ImportMap]\x20'+_0x3858e1+'\x20->\x20'+_0x2446ab[_0x3858e1]+'\x20(from\x20platform)');else try{let _0x5f06e5=z(),_0x2ebb11=path.join(_0x5f06e5['cwd'](),this['libDir']),_0x742004=!0x1;try{for(let _0x567aef of _0x5f06e5['readDirSync'](_0x2ebb11))if(_0x567aef['isDirectory']&&(_0x567aef['name']===_0x3858e1||_0x567aef['name']['startsWith'](_0x3858e1+'@'))){let _0x38699e=path.join(_0x5f06e5['cwd'](),this['libDir'],_0x567aef['name'],'index.js')['replace'](/\\/g,'/'),_0x268598=new URL('file:///'+_0x38699e)['href'];_0x33664c[_0x3858e1]=_0x268598,console['log']('[ImportMap]\x20'+_0x3858e1+'\x20->\x20'+_0x268598+'\x20(from\x20lib)'),_0x742004=!0x0;break;}}catch{}_0x742004||console['warn']('[ImportMap]\x20Package\x20'+_0x3858e1+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x40682e){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x3858e1+':',_0x40682e);}return _0x33664c;}['validateServerImports'](_0x404976){let _0x1c5781=this['manifest']['name']||this['manifest']['id'],_0x29e8a6=this['manifest']['metadata']?.['serverPath'],_0x2db6d3=_0xb5dd1=>_0xb5dd1['replace'](/\\/g,'/'),_0x36e391=z(),_0x4bb477=_0x5b1d45=>{try{return _0x36e391['statSync'](_0x5b1d45),!0x0;}catch{return![];}},_0x501289=_0x29e8a6?_0x2db6d3(_0x29e8a6):void 0x0;if(!_0x501289){let _0x4f6985=[_0x404976+'/service/server.js',_0x404976+'/service/server.ts',_0x404976+'/'+_0x1c5781+'/server.js',_0x404976+'/'+_0x1c5781+'/server.ts',_0x404976+'/server.js',_0x404976+'/server.ts']['map'](_0x2db6d3);for(let _0x21e67f of _0x4f6985)if(_0x4bb477(_0x21e67f)){_0x501289=_0x21e67f;break;}}if(!_0x501289)return{'valid':![],'violations':['Failed to locate server module']};let _0x4cddd3='';try{_0x4cddd3=_0x36e391['readTextFileSync'](_0x501289);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x501289};}let _0x44ba30=this['getImports']();if(_0x44ba30['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x501289};let _0x595312=_0x44ba30,_0x2eb329=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x3e009c=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0xf2dcef=/\bimport\s*['"]([^'"]+)['"]/g,_0x5d0477=[],_0x4be4d6=new Set(),_0x400468=_0x36bbc1=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x36bbc1),_0x3cbda6=_0xbe0382=>{let _0x22b297=_0xbe0382;if(_0x22b297['startsWith']('./')||_0x22b297['startsWith']('../')||_0x22b297['startsWith']('/')||_0x22b297['startsWith']('file://')||!_0x400468(_0xbe0382)||_0x4be4d6['has'](_0xbe0382))return;_0x4be4d6['add'](_0xbe0382),_0x22b297['startsWith']('npm:')&&(_0x22b297=_0x22b297['substring'](0x4)),_0x22b297['includes']('@')&&!_0x22b297['startsWith']('@')&&(_0x22b297=_0x22b297['split']('@')[0x0]);let _0x521d15=_0x22b297['split']('/')[0x0];_0x595312['includes'](_0x521d15)||_0x595312['includes'](_0xbe0382)||_0x5d0477['push'](_0xbe0382);},_0x4d1f7f;for(;(_0x4d1f7f=_0x2eb329['exec'](_0x4cddd3))!==null;)_0x3cbda6(_0x4d1f7f[0x1]);for(;(_0x4d1f7f=_0x3e009c['exec'](_0x4cddd3))!==null;)_0x3cbda6(_0x4d1f7f[0x1]);for(;(_0x4d1f7f=_0xf2dcef['exec'](_0x4cddd3))!==null;)_0x3cbda6(_0x4d1f7f[0x1]);return{'valid':_0x5d0477['length']===0x0,'violations':_0x5d0477,'serverPath':_0x501289};}['validate'](_0x3da78e={}){let _0x6e5af0=[],_0x2cf871=this['manifest']['permissions']||{};try{let _0x421413=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x421413);}catch{}let _0x21914a=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x3cd49a,_0x3deedd]of Object['entries'](_0x2cf871))if(_0x3cd49a==='hrtime')typeof _0x3deedd!='boolean'&&_0x6e5af0['push']('Permission\x20\x27'+_0x3cd49a+'\x27\x20must\x20be\x20boolean');else{if(_0x3cd49a==='langchain')typeof _0x3deedd!='boolean'&&(typeof _0x3deedd!='object'||_0x3deedd===null)?_0x6e5af0['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x3deedd=='object'&&(_0x3deedd===null||!('enabled'in _0x3deedd)||typeof _0x3deedd['enabled']!='boolean')&&_0x6e5af0['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x3cd49a==='kv')typeof _0x3deedd!='boolean'&&_0x6e5af0['push']('Permission\x20\x27'+_0x3cd49a+'\x27\x20must\x20be\x20boolean');else{if(_0x3cd49a==='mspbots')Array['isArray'](_0x3deedd)||_0x6e5af0['push']('Permission\x20\x27'+_0x3cd49a+'\x27\x20must\x20be\x20an\x20array');else{if(_0x3cd49a==='db'){if(typeof _0x3deedd!='object'||_0x3deedd===null||Array['isArray'](_0x3deedd))_0x6e5af0['push']('Permission\x20\x27'+_0x3cd49a+'\x27\x20must\x20be\x20an\x20object');else{let _0x105253=_0x3deedd,_0x286674=['user','password']['filter'](_0x5a0d47=>!(_0x5a0d47 in _0x105253));_0x286674['length']>0x0&&_0x6e5af0['push']('Permission\x20\x27'+_0x3cd49a+'\x27\x20missing\x20required\x20fields:\x20'+_0x286674['join'](',\x20'));}}else{if(_0x3cd49a==='imports')continue;_0x21914a['has'](_0x3cd49a)||typeof _0x3deedd!='boolean'&&!Array['isArray'](_0x3deedd)&&_0x6e5af0['push']('Permission\x20\x27'+_0x3cd49a+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x34c71e=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x34c71e))_0x6e5af0['push']('permissions.imports must be an array');else{for(let _0x581673 of _0x34c71e)typeof _0x581673!='string'&&_0x6e5af0['push']('import\x20\x27'+_0x581673+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x6e5af0['length']===0x0,'errors':_0x6e5af0};}};function q(_0xb19370,_0x51d696,_0x13521c){return new D(_0xb19370,_0x51d696,_0x13521c||{});}var R=null;function I(){let _0x111976=globalThis['Deno'];if(!_0x111976)throw new Error('Deno is not available');return _0x111976;}async function K(){if(R)return{...R};try{let _0x42b382=I(),_0x28f59e=path.join(_0x42b382['cwd'](),'deno.json'),_0x2d7957=await _0x42b382['readTextFile'](_0x28f59e);return R=JSON['parse'](_0x2d7957)['imports']||{},{...R};}catch(_0x446bd6){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x446bd6),{};}}var E=class{constructor(_0x540d2b,_0x59390a={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x540d2b['appsDir'],this['platformImportsOverride']=_0x540d2b['platformImports'],this['libDir']=_0x540d2b['libDir'],this['events']=_0x59390a);}async['create'](_0x29f5e6,_0x3c0382,_0x494acb){try{return await this['createWorker'](_0x29f5e6,_0x3c0382,_0x494acb);}catch(_0x4b7564){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x29f5e6+':',_0x4b7564),_0x4b7564;}}async['createWorker'](_0x44c5d1,_0x27794b,_0xb28a75){let _0x11561e=this['platformImportsOverride']||await K(),_0x2bb685=q(_0x27794b,this['libDir'],_0x11561e)['validateServerImports'](this['appsDir']);if(!_0x2bb685['valid']){let _0x573b39=_0x2bb685['violations']['filter'](_0x541c8d=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x541c8d)),_0x15b083=_0x2bb685['serverPath']?_0x2bb685['serverPath']:(_0x27794b['name']||_0x27794b['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x15b083+':\x20'+_0x573b39['join'](',\x20'));}let _0x2da23a=q(_0x27794b,this['libDir'],_0x11561e),_0x2d80a5=_0x2da23a['validate'](_0x11561e);if(!_0x2d80a5['valid'])throw new Error('Invalid\x20config:\x20'+_0x2d80a5['errors']['join'](',\x20'));let _0x617065=_0x2da23a['buildImportMap'](_0x11561e);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x44c5d1+':',_0x617065);let _0xc14e72=_0x2da23a['buildPerms'](),_0x4e88d5=_0x2da23a['getReadPaths']();if(_0xc14e72['read'])console['log']('[Worker] Custom read permissions from manifest:',_0xc14e72['read']);else{let _0x1be3b5=_0x27794b['name']||_0x44c5d1,_0x256580=this['appsDir']+'/'+_0x1be3b5,_0x1e0185=[_0x256580],_0xa2a751=_0x27794b['metadata']?.['serverPath'];if(_0xa2a751&&typeof _0xa2a751=='string')try{let _0x3e61a9=path.dirname(_0xa2a751)['replace'](/\\/g,'/');_0x1e0185['push'](_0x3e61a9);}catch{}_0xc14e72['read']=_0x1e0185,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x256580);}if(_0x4e88d5['length']>0x0){if(_0xc14e72['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x33ee43=Array['isArray'](_0xc14e72['read'])?_0xc14e72['read']:[];_0xc14e72['read']=[..._0x33ee43,..._0x4e88d5],console['log']('[Worker] Added package read permissions:',_0x4e88d5);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0xc14e72['net']||(_0xc14e72['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x44c5d1+':',_0xc14e72['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0xc14e72['read']===!![]?'unrestricted':Array['isArray'](_0xc14e72['read'])?_0xc14e72['read']['length']:0x0));let _0x4ad869=await this['createImportMap'](_0x44c5d1,_0x617065),_0x8aaddd=await this['createLock'](_0x44c5d1,_0x617065),_0x15b78f={'type':'module','deno':{'permissions':{}}};_0x15b78f['deno']['namespace']=![],_0x15b78f['deno']['permissions']=_0xc14e72,_0x15b78f['deno']['importMap']=_0x4ad869,_0x15b78f['deno']['lock']=_0x8aaddd,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x44c5d1+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x4ad869),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x8aaddd),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x617065)['length']+'\x20('+(Object['keys'](_0x617065)['join'](',\x20')||'none')+')');let _0x109d56={'worker':new Worker(_0xb28a75,_0x15b78f),'appId':_0x44c5d1,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x27794b,'importMapPath':_0x4ad869,'lockfilePath':_0x8aaddd};return this['workers']['set'](_0x44c5d1,_0x109d56),this['events']['onCreate']?.(_0x109d56),_0x109d56;}async['createLock'](_0x27af19,_0x1bc2b7){let _0x3aad8a=I(),_0x4c99bb=path.join(_0x3aad8a['cwd'](),'storage','temp','lockfiles');await _0x3aad8a['mkdir'](_0x4c99bb,{'recursive':!![]});let _0x134cad=_0x27af19+'-'+Date['now']()+'.lock',_0x5afd3b=path.join(_0x4c99bb,_0x134cad),_0x35e66e={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x50268c,_0x1373a8]of Object['entries'](_0x1bc2b7))if(_0x1373a8['startsWith']('npm:'))_0x1373a8['replace']('npm:',''),_0x35e66e['packages']['specifiers'][_0x50268c]=_0x1373a8;else _0x1373a8['startsWith']('file://')&&(_0x35e66e['packages']['specifiers'][_0x50268c]=_0x1373a8);let _0x2dee6a=JSON['stringify'](_0x35e66e,null,0x2);return await _0x3aad8a['writeTextFile'](_0x5afd3b,_0x2dee6a),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x5afd3b),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x1bc2b7)['length']+'):',Object['keys'](_0x1bc2b7)),_0x5afd3b;}async['createImportMap'](_0x546de3,_0x3b55e6){let _0x1af309=I(),_0x20ee37=path.join(_0x1af309['cwd'](),'storage','temp','importmaps');await _0x1af309['mkdir'](_0x20ee37,{'recursive':!![]});let _0x382926=_0x546de3+'-'+Date['now']()+'.json',_0x4644f8=path.join(_0x20ee37,_0x382926),_0x599d6c=JSON['stringify']({'imports':_0x3b55e6,'scopes':{}},null,0x2);return await _0x1af309['writeTextFile'](_0x4644f8,_0x599d6c),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x4644f8),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x3b55e6)['length']+'):',Object['keys'](_0x3b55e6)['join'](',\x20')||'none'),_0x4644f8;}['get'](_0x271824){return this['workers']['get'](_0x271824);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x18316c,_0x84281c){let _0x5f1ac8=this['workers']['get'](_0x18316c);if(!_0x5f1ac8)return;let _0x341b3c=_0x5f1ac8['status'];_0x5f1ac8['status']=_0x84281c,_0x84281c==='running'&&_0x341b3c==='starting'?this['events']['onReady']?.(_0x5f1ac8):_0x84281c==='crashed'&&this['events']['onCrash']?.(_0x5f1ac8);}['touch'](_0x20a058){let _0x13561f=this['workers']['get'](_0x20a058);_0x13561f&&(_0x13561f['lastUsed']=Date['now']());}async['stop'](_0x4dd48c){let _0x5bc044=this['workers']['get'](_0x4dd48c);if(_0x5bc044)try{_0x5bc044['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x5bc044['worker']['terminate'](),_0x5bc044['status']='stopped',this['events']['onStop']?.(_0x5bc044),_0x5bc044['importMapPath']&&await this['cleanupImportMap'](_0x5bc044['importMapPath']),_0x5bc044['lockfilePath']&&await this['cleanupLock'](_0x5bc044['lockfilePath']);}catch(_0x4cb327){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x4dd48c+':',_0x4cb327);}finally{this['workers']['delete'](_0x4dd48c);}}async['cleanupImportMap'](_0x14eab6){try{await I()['remove'](_0x14eab6),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x14eab6);}catch(_0x224b23){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x14eab6,_0x224b23);}}async['cleanupLock'](_0x46e445){try{await I()['remove'](_0x46e445),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x46e445);}catch(_0x1986bd){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x46e445,_0x1986bd);}}async['stopAll'](){let _0x198836=Array['from'](this['workers']['keys']());await Promise['all'](_0x198836['map'](_0x44232f=>this['stop'](_0x44232f)));}async['restart'](_0x4f19fb,_0x518e42){let _0x333d3d=this['workers']['get'](_0x4f19fb);if(!_0x333d3d)throw new Error('Worker\x20'+_0x4f19fb+'\x20not\x20found');let _0x2d6d62=_0x333d3d['manifest'];return await this['stop'](_0x4f19fb),await this['create'](_0x4f19fb,_0x2d6d62,_0x518e42);}['checkHealth'](_0x2490a9){let _0x15615e=this['workers']['get'](_0x2490a9);if(!_0x15615e)return{'healthy':![],'reason':'Not\x20found'};if(_0x15615e['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x15615e['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x29e758=Date['now']()-_0x15615e['lastUsed'],_0x12bcab=0x708*0x3e8;return _0x29e758>_0x12bcab?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x29e758/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x38b117=0x708*0x3e8,_0x236965){let _0xc86e25=Date['now'](),_0x3ff558=[];for(let [_0x50a213,_0x402a2a]of this['workers']['entries']()){let _0x36d507=_0xc86e25-_0x402a2a['lastUsed'];_0x36d507>_0x38b117&&_0x3ff558['push']({'appId':_0x50a213,'idle':_0x36d507});}_0x3ff558['sort']((_0x124232,_0x425276)=>_0x425276['idle']-_0x124232['idle']);let _0x3dc6ad=_0x236965?_0x3ff558['slice'](0x0,_0x236965)['map'](_0xb78622=>_0xb78622['appId']):_0x3ff558['map'](_0x5b7038=>_0x5b7038['appId']);for(let _0x1d03de of _0x3dc6ad)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x1d03de),await this['stop'](_0x1d03de);}['stats'](){let _0x3c4484={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x425ffe=Date['now']();for(let _0x221780 of this['workers']['values']())_0x3c4484['byStatus'][_0x221780['status']]++,_0x3c4484['workers']['push']({'appId':_0x221780['appId'],'status':_0x221780['status'],'version':_0x221780['version'],'lastUsed':_0x221780['lastUsed'],'idle':_0x425ffe-_0x221780['lastUsed']});return _0x3c4484;}['startCleanup'](_0x6d0af0=0x12c*0x3e8,_0x52d3d2){let _0x2a22b2=setInterval(()=>{this['cleanup'](_0x52d3d2)['catch'](_0x3fc556=>{console['error']('Cleanup\x20failed:',_0x3fc556);});},_0x6d0af0);return()=>clearInterval(_0x2a22b2);}['delay'](_0x4ae650){return new Promise(_0x59d6dd=>setTimeout(_0x59d6dd,_0x4ae650));}};function W(_0x895e02,_0x4b3b72){return new E(_0x895e02,_0x4b3b72);}var v=f,j=class{constructor(_0x2d8a2c,_0x5a32ee=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x2d8a2c,this['timeout']=_0x5a32ee);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x3b9a0a){_0x3b9a0a['worker']['onmessage']=_0x4cb482=>{let _0x17ab29=_0x4cb482['data'],{appId:_0x52200f}=_0x3b9a0a;switch(_0x17ab29['type']){case'ready':this['events']['onReady'](_0x52200f),v['info']('Worker\x20ready',{'appId':_0x52200f,'version':_0x3b9a0a['version']});break;case'log':{let {level:_0x42d78e='info',message:_0x34be8f,meta:_0x1c0da8}=_0x17ab29,_0x22f584={..._0x1c0da8||{},'appId':_0x52200f,'version':_0x3b9a0a['version']};this['events']['onLog'](_0x52200f,_0x42d78e,_0x34be8f,_0x22f584);break;}case'result':{let {reqId:_0x45280e,ok:_0x429556,response:_0xbe977d,error:_0x5ed864}=_0x17ab29,_0x365475=this['pending']['get'](_0x45280e);if(!_0x365475){v['warn']('Unknown\x20request',{'appId':_0x52200f,'reqId':_0x45280e});return;}if(this['pending']['delete'](_0x45280e),_0x429556&&_0xbe977d)_0x365475['resolve'](_0xbe977d);else{let _0x5f0642=new Error(_0x5ed864?.['message']||'Worker\x20error');_0x5f0642['stack']=_0x5ed864?.['stack'],_0x365475['reject'](_0x5f0642);}this['events']['onResult'](_0x52200f,_0x45280e,_0xbe977d||_0x5ed864);break;}default:v['debug']('Unknown\x20message',{'appId':_0x52200f,'type':_0x17ab29['type']});}},_0x3b9a0a['worker']['onerror']=_0x832d54=>{let {appId:_0x4818cd}=_0x3b9a0a;v['error']('Worker\x20error',{'appId':_0x4818cd,'message':_0x832d54['message'],'lineno':_0x832d54['lineno'],'filename':_0x832d54['filename']}),_0x3b9a0a['status']='crashed',this['rejectPending'](_0x4818cd,new Error('Worker\x20'+_0x4818cd+'\x20crashed:\x20'+_0x832d54['message'])),_0x832d54['preventDefault']();},_0x3b9a0a['worker']['onmessageerror']=_0x51d18d=>{let {appId:_0x4f0ec0}=_0x3b9a0a;v['error']('Message\x20error',{'appId':_0x4f0ec0,'data':_0x51d18d['data']}),_0x3b9a0a['status']='crashed',_0x51d18d['preventDefault']();};}['sendInit'](_0x6bc7f4,_0x430db0,_0x4b8e62,_0x227495){_0x6bc7f4['worker']['postMessage']({'type':'init','appId':_0x6bc7f4['appId'],'manifest':_0x4b8e62,'appsDir':_0x430db0,'serverPath':_0x227495});}async['sendInvoke'](_0x47226e,_0x4d2f63){let _0x3d0151=this['nextId'](),_0x266fb8=_0x47226e['appId'],_0x29a88c=new Promise((_0x56b7e4,_0x48515a)=>{let _0x25ee99=setTimeout(()=>{this['pending']['delete'](_0x3d0151),_0x48515a(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x3d0151,{'resolve':_0x2e68c5=>{clearTimeout(_0x25ee99),_0x56b7e4(_0x2e68c5);},'reject':_0x4c4278=>{clearTimeout(_0x25ee99),_0x48515a(_0x4c4278);},'timestamp':Date['now'](),'appId':_0x266fb8});});return _0x47226e['worker']['postMessage']({'type':'invoke','appId':_0x47226e['appId'],'reqId':_0x3d0151,'payload':_0x4d2f63}),await _0x29a88c;}['rejectPending'](_0x4effcc,_0x3cbe44){let _0x32390b=0x0;for(let [_0x44bd3a,_0x2aa663]of this['pending']['entries']())_0x2aa663['appId']===_0x4effcc&&(this['pending']['delete'](_0x44bd3a),_0x2aa663['reject'](_0x3cbe44),_0x32390b++);_0x32390b>0x0&&v['warn']('Rejected\x20'+_0x32390b+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x4effcc});}['cleanupTimeout'](){let _0x98dd4a=Date['now']();for(let [_0x2944d9,_0x205c37]of this['pending']['entries']())_0x98dd4a-_0x205c37['timestamp']>this['timeout']&&(this['pending']['delete'](_0x2944d9),_0x205c37['reject'](new Error('Request\x20'+_0x2944d9+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x59d0fc){let _0x5e2a50=0x0;for(let _0x56c3e0 of this['pending']['values']())_0x56c3e0['appId']===_0x59d0fc&&_0x5e2a50++;return _0x5e2a50;}['startCleanup'](_0x28d0aa=0x2710){let _0x2b59df=setInterval(()=>{this['cleanupTimeout']();},_0x28d0aa);return()=>clearInterval(_0x2b59df);}};function $(_0x353091,_0x73ad23){return new j(_0x353091,_0x73ad23);}var Q=class{constructor(_0x26c03d={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x26c03d['logger']||f,this['config']={'appsDir':_0x26c03d['appsDir']||this['getAppsDir'](),'scriptUrl':_0x26c03d['scriptUrl']||this['getScriptUrl'](),'timeout':_0x26c03d['timeout']||0x78*0x3e8,'autoCleanup':_0x26c03d['autoCleanup']??!![],'cleanupInterval':_0x26c03d['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x26c03d['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x26c03d['maxWorkers'],'reuseWorkers':_0x26c03d['reuseWorkers']??!![],'workerReuseStrategy':_0x26c03d['workerReuseStrategy']||'lru','enableQueue':_0x26c03d['enableQueue']??!![],'maxQueueSize':_0x26c03d['maxQueueSize']||0x64,'queueTimeout':_0x26c03d['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x5cdbb9=>this['logger']['info']('Worker\x20created',{'appId':_0x5cdbb9['appId'],'v':_0x5cdbb9['version']}),'onReady':_0x3a7149=>this['lifecycle']['updateStatus'](_0x3a7149['appId'],'running'),'onCrash':_0x5ba6bf=>this['logger']['error']('Worker\x20crashed',{'appId':_0x5ba6bf['appId'],'v':_0x5ba6bf['version']}),'onStop':_0x1d7bba=>this['logger']['info']('Worker\x20stopped',{'appId':_0x1d7bba['appId'],'v':_0x1d7bba['version']})}),this['messaging']=$({'onReady':_0x3eb754=>this['lifecycle']['updateStatus'](_0x3eb754,'running'),'onLog':(_0x1e83a1,_0x2b0f96,_0x897ddb,_0x3b2aeb)=>{let _0xce4ab9={..._0x3b2aeb||{},'appId':_0x1e83a1};switch(_0x2b0f96){case'error':this['logger']['error'](_0x897ddb,_0xce4ab9);break;case'warn':this['logger']['warn'](_0x897ddb,_0xce4ab9);break;case'debug':this['logger']['debug'](_0x897ddb,_0xce4ab9);break;default:this['logger']['info'](_0x897ddb,_0xce4ab9);break;}},'onResult':(_0x548ada,_0x2dc2e7,_0xae281b)=>{this['logger']['debug']('Result\x20received',{'appId':_0x548ada,'reqId':_0x2dc2e7});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x56a91b=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x1475a6=_0x56a91b['endsWith']('.js')||_0x56a91b['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x1475a6,_0x56a91b)['href'];}async['ensure'](_0x239e2f){let {id:_0x194a97}=_0x239e2f,_0x1dc133=this['lifecycle']['get'](_0x194a97);if(_0x1dc133){let _0x888b83=this['lifecycle']['checkHealth'](_0x194a97);if(_0x888b83['healthy'])return this['lifecycle']['touch'](_0x194a97),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x194a97}),_0x1dc133;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x194a97,'reason':_0x888b83['reason']}),await this['lifecycle']['stop'](_0x194a97);}for(;;){let _0x97fcac=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x97fcac>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x97fcac,'max':this['config']['maxWorkers'],'appId':_0x194a97}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x239e2f);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0xbbe9ed=await this['loadManifest'](_0x194a97,_0x239e2f['manifest']),_0x40eaf9=await this['lifecycle']['create'](_0x194a97,_0xbbe9ed,this['config']['scriptUrl']),_0x7978a4=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x7978a4>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x7978a4,'max':this['config']['maxWorkers'],'appId':_0x194a97}),await this['lifecycle']['stop'](_0x194a97),this['config']['enableQueue'])return await this['waitSlot'](_0x239e2f);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x7978a4+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x40eaf9);let _0x21daf8=_0xbbe9ed['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x40eaf9,this['config']['appsDir'],_0xbbe9ed,_0x21daf8),this['logger']['info']('Worker\x20created',{'appId':_0x194a97,'v':_0x40eaf9['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x40eaf9;}async['evictIdle'](){let _0x471603=this['lifecycle']['getAll']();if(_0x471603['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x5a23bd=[..._0x471603];this['config']['workerReuseStrategy']==='lru'?_0x5a23bd['sort']((_0x54cf52,_0xb93d18)=>_0x54cf52['lastUsed']-_0xb93d18['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x5a23bd['sort']((_0x2b2d78,_0x385c6b)=>_0x2b2d78['version']-_0x385c6b['version']);let _0x6fbdf0=null;for(let _0x15b6a8 of _0x5a23bd)if(this['messaging']['getAppCount'](_0x15b6a8['appId'])===0x0){_0x6fbdf0=_0x15b6a8;break;}if(!_0x6fbdf0&&_0x5a23bd['length']>0x0&&(_0x6fbdf0=_0x5a23bd['reduce']((_0x14eecd,_0x1a8dd0)=>{let _0x57aac3=this['messaging']['getAppCount'](_0x14eecd['appId']);return this['messaging']['getAppCount'](_0x1a8dd0['appId'])<_0x57aac3?_0x1a8dd0:_0x14eecd;})),_0x6fbdf0){let _0x493860=this['messaging']['getAppCount'](_0x6fbdf0['appId']);return _0x493860>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x6fbdf0['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x6fbdf0['lastUsed'],'pendingRequests':_0x493860}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x6fbdf0['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x6fbdf0['lastUsed']}),await this['lifecycle']['stop'](_0x6fbdf0['appId']),!![];}return![];}['waitSlot'](_0x1d2a43){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x591244,_0x1641b4)=>{let _0x3b90ff={'info':_0x1d2a43,'resolve':_0x591244,'reject':_0x1641b4,'timestamp':Date['now']()};this['requestQueue']['push'](_0x3b90ff),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x1d2a43['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x1bf352=setTimeout(()=>{let _0xf42aa0=this['requestQueue']['indexOf'](_0x3b90ff);_0xf42aa0!==-0x1&&(this['requestQueue']['splice'](_0xf42aa0,0x1),_0x1641b4(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x3b90ff['resolve']=_0x58ea2e=>{clearTimeout(_0x1bf352),_0x591244(_0x58ea2e);},_0x3b90ff['reject']=_0x199270=>{clearTimeout(_0x1bf352),_0x1641b4(_0x199270);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x471ff4=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x471ff4>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x550be1=this['requestQueue']['shift']();if(!_0x550be1)break;try{let _0xc2b398=await this['ensure'](_0x550be1['info']);_0x550be1['resolve'](_0xc2b398);}catch(_0x31867c){_0x550be1['reject'](_0x31867c);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x520622,_0x20e66b){let _0x3eb79b=this['config']['appsDir']['replace'](/\\/g,'/'),_0x528ee5=async _0xf3e484=>{try{let _0x5e2104=globalThis['Deno'];if(!_0x5e2104)return null;let _0x4d346b=await _0x5e2104['readTextFile'](_0xf3e484);return JSON['parse'](_0x4d346b);}catch{return null;}};if(_0x20e66b?.['name']){let _0x5dcfd1=await _0x528ee5(_0x3eb79b+'/'+_0x20e66b['name']+'/manifest.json');if(_0x5dcfd1)return _0x5dcfd1;}let _0x4288dd=await _0x528ee5(_0x3eb79b+'/'+_0x520622+'/manifest.json');if(_0x4288dd)return _0x4288dd;try{let _0x482122=globalThis['Deno'];if(_0x482122)for await(let _0x24e99a of _0x482122['readDir'](_0x3eb79b)){if(!_0x24e99a['isDirectory'])continue;let _0x3a3899=_0x3eb79b+'/'+_0x24e99a['name']+'/manifest.json',_0x2ec2e6=await _0x528ee5(_0x3a3899);if(_0x2ec2e6&&(_0x2ec2e6['id']===_0x520622||_0x20e66b?.['name']&&_0x2ec2e6['name']===_0x20e66b['name']))return _0x2ec2e6;}}catch(_0x288a5c){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x520622,'error':_0x288a5c['message']});}return _0x20e66b||{'id':_0x520622,'name':_0x520622,'version':'1.0.0'};}async['invoke'](_0x9f7669){let _0x4098ff=_0x9f7669['ctx']['app']['id'],_0x57ab94=_0x9f7669['ctx']['app']['name'];try{let _0x2c01a3={'id':_0x4098ff,'manifest':{'id':_0x4098ff,'name':_0x57ab94}},_0x11ed8d=await this['ensure'](_0x2c01a3);if(_0x11ed8d['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x4098ff}),await this['restart'](_0x4098ff);let _0x4d0659=await this['ensure'](_0x2c01a3);return this['lifecycle']['touch'](_0x4098ff),await this['messaging']['sendInvoke'](_0x4d0659,_0x9f7669);}return this['lifecycle']['touch'](_0x4098ff),await this['messaging']['sendInvoke'](_0x11ed8d,_0x9f7669);}catch(_0x3165fb){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x4098ff,'error':_0x3165fb['message'],'stack':_0x3165fb['stack']}),_0x3165fb;}}async['stop'](_0x3829af){await this['lifecycle']['stop'](_0x3829af),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x75a1ee){return await this['lifecycle']['restart'](_0x75a1ee,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x37d1e8=>({'appId':_0x37d1e8['appId'],'status':_0x37d1e8['status'],'version':_0x37d1e8['version'],'lastUsed':_0x37d1e8['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0xd923bc=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x532d6d=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0xd923bc(),_0x532d6d();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x30a239=>{_0x30a239?(await this['stop'](_0x30a239),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x30a239})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x2b441d){return new Q(_0x2b441d);}var S=null;function be(_0x54e320){S=ee(_0x54e320);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x4553ec){return await k()['ensure'](_0x4553ec);}async function xe(_0x349b96){return await k()['invoke'](_0x349b96);}function Ie(_0x951435){k()['stop'](_0x951435)['catch'](_0x5e87ac=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x951435,'error':_0x5e87ac['message']});});}function Re(){k()['stopAll']()['catch'](_0x46638f=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x46638f['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x2354be){await k()['stop'](_0x2354be);}async function Se(){await k()['stopAll']();}function Ae(_0x2360a0){let _0x2061f7=_0x2360a0&&typeof _0x2360a0=='object'?_0x2360a0:null;if(_0x2061f7&&'user'in _0x2061f7)return _0x2061f7['user'];}function H(_0x8c9ea5){let _0x258b46=_0x8c9ea5&&typeof _0x8c9ea5=='object'?_0x8c9ea5:null;if(!_0x258b46)return{};let _0x190236={};for(let [_0x10033c,_0x32b587]of Object['entries'](_0x258b46))_0x10033c!=='user'&&(_0x190236[_0x10033c]=_0x32b587);return _0x190236;}function O(_0x3973ac){return _0x3973ac?{'id':_0x3973ac['manifest']?.['id']||_0x3973ac['id']||'','name':_0x3973ac['manifest']?.['name']||'','version':_0x3973ac['manifest']?.['version']||'','description':_0x3973ac['manifest']?.['description']||'','icon':_0x3973ac['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x2ae41d){return _0x2ae41d?.['permissions']||_0x2ae41d?.['manifest']?.['permissions']||{};}function F(_0x110e98){return _0x110e98?.['manifest']?.['metadata']||{};}function Ce(_0x147da3){return _0x147da3?{'appId':_0x147da3['id'],'appName':_0x147da3['manifest']?.['name']}:{};}function N(_0x32eff0,_0x55530d={}){let {appInfo:_0x157e65=null,status:_0x4d7f59=0x1f4,defaultMessage:_0x48a19a='Internal\x20Server\x20Error'}=_0x55530d,_0x39094d={'error':_0x48a19a,'message':_0x32eff0?.['message']||_0x48a19a};return _0x157e65&&(_0x39094d['appId']=_0x157e65['id'],_0x39094d['appName']=_0x157e65['manifest']?.['name']),_0x32eff0?.['message']?.['includes']('crashed')&&(_0x39094d['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x4d7f59,'body':_0x39094d};}function qe(_0x268171){return _0x268171?.['message']?.['includes']('crashed')||![];}function J(_0x44202f){if(_0x44202f)try{return JSON['parse'](_0x44202f);}catch{return _0x44202f;}}function B(_0x1f38f5){try{let _0x3598cb=new URL(_0x1f38f5),_0x3c9f16={};for(let _0x63a8d of _0x3598cb['searchParams']['keys']()){let _0x34e079=_0x3598cb['searchParams']['getAll'](_0x63a8d)['map'](_0x36bebf=>_0x36bebf);_0x34e079['length']<=0x1?_0x3c9f16[_0x63a8d]=_0x34e079[0x0]??'':_0x3c9f16[_0x63a8d]=_0x34e079;}return _0x3c9f16;}catch{return{};}}function Le(_0x49a1f3){return(()=>{try{return new URL(_0x49a1f3)['pathname'];}catch{return _0x49a1f3;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x54d79b,_0x4ba425){let _0x2b06d9=_0x54d79b;if(_0x4ba425&&_0x2b06d9['startsWith']('/apps/'+_0x4ba425))_0x2b06d9=_0x2b06d9['substring'](('/apps/'+_0x4ba425)['length'])||'/';else{let _0x28d85c=_0x2b06d9['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x28d85c&&(_0x2b06d9=_0x28d85c[0x1]||'/');}return _0x2b06d9['startsWith']('/api')&&(_0x2b06d9=_0x2b06d9['substring'](0x4)||'/'),_0x2b06d9;}function Ue(_0x5a47e9,_0x53c699){let _0x159410=_0x5a47e9;if(_0x53c699&&_0x159410['startsWith']('/apps/'+_0x53c699))_0x159410=_0x159410['substring'](('/apps/'+_0x53c699)['length'])||'/';else{let _0x37c32e=_0x159410['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x37c32e&&(_0x159410=_0x37c32e[0x1]||'/');}return(!_0x159410||_0x159410==='/')&&(_0x159410='/index.html'),_0x159410;}async function He(_0x2b61f1,_0x589e33){return await _0x589e33(_0x2b61f1);}function _(_0x5ddf8c){return _0x5ddf8c['split']('/')['filter'](_0xc389f9=>_0xc389f9['length']>0x0);}function te(_0x2c5470){try{return decodeURIComponent(_0x2c5470);}catch{return _0x2c5470;}}function re(_0x4c8051,_0x59684e){let _0x1b7161=_(_0x4c8051),_0x375c57=_(_0x59684e),_0x140412={},_0x285b5a=0x0,_0x42c9cf=0x0;for(;_0x285b5a<_0x1b7161['length']&&_0x42c9cf<_0x375c57['length'];){let _0x3c1820=_0x1b7161[_0x285b5a],_0x40fde2=_0x375c57[_0x42c9cf];if(_0x3c1820==='*')break;if(_0x3c1820['startsWith'](':')){let _0x4cbf6c=_0x3c1820['slice'](0x1);_0x4cbf6c&&(_0x140412[_0x4cbf6c]=te(_0x40fde2)),_0x285b5a++,_0x42c9cf++;continue;}if(_0x3c1820!==_0x40fde2)return{};_0x285b5a++,_0x42c9cf++;}return _0x285b5a===_0x1b7161['length']||_0x285b5a===_0x1b7161['length']-0x1&&_0x1b7161[_0x285b5a]==='*',_0x140412;}async function Oe(_0xd39acf,_0x25cd55,_0xb15359,_0x373b16,_0x59ac51=void 0x0,_0x4e0582){let _0x20a2eb=await _0x25cd55['text'](),_0x31ea45=J(_0x20a2eb),_0x4ca708=B(_0x25cd55['url']),_0x4578b6={...F(_0xd39acf),'user':_0x59ac51},_0x41b1a3=H(_0x4578b6),_0x166c36=_0x4e0582?re(_0x4e0582,_0x25cd55['path']):{};return{'app':O(_0xd39acf),'permissions':T(_0xd39acf),'user':_0x59ac51,'metadata':_0x41b1a3,'body':_0x31ea45,'query':_0x4ca708,'params':_0x166c36,'method':_0xb15359,'pathname':_0x373b16,'requestUrl':_0x25cd55['url'],'headers':Object['fromEntries'](_0x25cd55['raw']['headers']['entries']())};}function Te(_0x50a6af){return{'method':_0x50a6af['method'],'pathname':_0x50a6af['pathname'],'ctx':_0x50a6af};}function Fe(_0x512bc6,_0x1bcd7d){let {status:_0x35ff45=0xc8,headers:_0x52d21b={},body:_0x579000,type:_0x402bb1}=_0x512bc6??{};return _0x402bb1==='raw'?new globalThis['Response'](String(_0x579000??''),{'status':_0x35ff45,'headers':_0x52d21b}):_0x1bcd7d(_0x579000,_0x35ff45);}function Ne(_0x5d3898,_0x24d568=null){return N(_0x5d3898,{'appInfo':_0x24d568});}var V=f;async function Ve(_0xa6e95f){_0xa6e95f?(await U(_0xa6e95f),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0xa6e95f)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x4a91db,_0x57f6e9){let _0xfb17be=Object['fromEntries'](Object['entries'](_0x4a91db['headers']||{})['map'](([_0x58819f,_0x18ce62])=>[_0x58819f['toLowerCase'](),_0x18ce62]));return{'id':_0x4a91db['app']['id']||_0x57f6e9['appId']||'','name':_0x4a91db['app']['name']||'','version':_0x4a91db['app']['version']||'','description':_0x4a91db['app']['description']||'','metadata':{..._0x4a91db['metadata'],'permissions':_0x4a91db['permissions']},'body':_0x4a91db['body'],'query':_0x4a91db['query'],'params':_0x4a91db?.['params'],'method':_0x4a91db['method'],'pathname':_0x4a91db['pathname'],'requestUrl':_0x4a91db['requestUrl'],'user':_0x4a91db['user'],'headers':_0xfb17be};}var L=class{constructor(_0x117bbd){this['handle']=null,(this['config']=_0x117bbd,this['logger']=_0x117bbd['logger']||f,this['lifecycle']=W({'appsDir':_0x117bbd['appsDir'],'timeout':_0x117bbd['timeout'],'platformImports':_0x117bbd['platformImports'],'libDir':_0x117bbd['libDir']},{'onCreate':_0xf82242=>this['logger']['info']('Worker\x20created',{'appId':_0xf82242['appId']}),'onReady':_0x31fad2=>{this['lifecycle']['updateStatus'](_0x31fad2['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x31fad2['appId']});},'onCrash':_0x515e27=>this['logger']['error']('Worker\x20crashed',{'appId':_0x515e27['appId']}),'onStop':_0x31b107=>this['logger']['info']('Worker\x20stopped',{'appId':_0x31b107['appId']})}),this['messaging']=$({'onReady':_0x1be4a4=>this['lifecycle']['updateStatus'](_0x1be4a4,'running'),'onLog':(_0x54abca,_0x506bd4,_0x400c25,_0x34a9fd)=>{(this['logger'][_0x506bd4]||this['logger']['info'])['call'](this['logger'],_0x400c25,_0x34a9fd);},'onResult':()=>{}},_0x117bbd['timeout']||0x1d4c0));}async['create'](_0x28c306){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x14a7f6=await this['lifecycle']['create'](this['config']['appId'],_0x28c306,this['config']['scriptUrl']);this['messaging']['setup'](_0x14a7f6),this['messaging']['sendInit'](_0x14a7f6,this['config']['appsDir'],_0x28c306,this['config']['serverPath']),this['handle']=_0x14a7f6,await this['waitForReady']();}async['waitForReady'](_0x367db0=0x2710){let _0x36ed4f=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x36ed4f>_0x367db0)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0xae8480=>setTimeout(_0xae8480,0x64));}}async['invoke'](_0x2fbf24){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x2fbf24);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x1e4c59){return new L(_0x1e4c59);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;