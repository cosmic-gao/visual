import{join,dirname}from'path';import _0x627d89 from'process';import{stat}from'fs/promises';async function ie(_0x58df74){try{return await stat(_0x58df74),!0x0;}catch{return![];}}var f={'error':(_0x3693f0,_0x3a9eb9)=>console['error']('[ERROR]\x20'+_0x3693f0,_0x3a9eb9),'warn':(_0x355501,_0x2f1ed1)=>console['warn']('[WARN]\x20'+_0x355501,_0x2f1ed1),'info':(_0x2c74fe,_0x2b019)=>console['log']('[INFO]\x20'+_0x2c74fe,_0x2b019),'debug':(_0x366ca0,_0x43e63c)=>console['log']('[DEBUG]\x20'+_0x366ca0,_0x43e63c)};function z(){let _0x13340a=globalThis['Deno'];if(!_0x13340a)throw new Error('Deno is not available');return _0x13340a;}var D=class{constructor(_0x3663f0,_0x1aafcd='./lib',_0x21973d={}){this['manifest']=_0x3663f0,this['libDir']=_0x1aafcd,this['platformImports']=_0x21973d;}['buildPerms'](){let _0x129de9=this['manifest']['permissions']||{},_0x546df6={};return _0x129de9['net']!==void 0x0&&(_0x546df6['net']=_0x129de9['net']===!![]?!![]:Array['isArray'](_0x129de9['net'])?_0x129de9['net']:[]),_0x129de9['read']!==void 0x0&&(_0x546df6['read']=_0x129de9['read']===!![]?!![]:Array['isArray'](_0x129de9['read'])?_0x129de9['read']:[]),_0x129de9['write']!==void 0x0&&(_0x546df6['write']=_0x129de9['write']===!![]?!![]:Array['isArray'](_0x129de9['write'])?_0x129de9['write']:[]),_0x129de9['env']!==void 0x0&&(_0x546df6['env']=_0x129de9['env']===!![]?!![]:Array['isArray'](_0x129de9['env'])?_0x129de9['env']:[]),_0x129de9['run']!==void 0x0&&(_0x546df6['run']=_0x129de9['run']===!![]?!![]:Array['isArray'](_0x129de9['run'])?_0x129de9['run']:[]),_0x129de9['ffi']!==void 0x0&&(_0x546df6['ffi']=_0x129de9['ffi']===!![]?!![]:Array['isArray'](_0x129de9['ffi'])?_0x129de9['ffi']:[]),_0x129de9['sys']!==void 0x0&&(_0x546df6['sys']=_0x129de9['sys']===!![]?!![]:Array['isArray'](_0x129de9['sys'])?_0x129de9['sys']:[]),_0x129de9['hrtime']!==void 0x0&&(_0x546df6['hrtime']=_0x129de9['hrtime']),_0x546df6;}['normalize'](_0x6f3ee9){return _0x6f3ee9===!![]?[]:Array['isArray'](_0x6f3ee9)?_0x6f3ee9:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0xce0a80){return join(this['libDir'],_0xce0a80+'@*');}['getReadPaths'](){let _0x5e9d07=this['getImports']();_0x5e9d07['includes']('*')&&(_0x5e9d07=Object['keys'](this['platformImports']));let _0x53b48e=[];console['log']('[Permissions] Building package path patterns for imports:',_0x5e9d07);for(let _0x3be45e of _0x5e9d07){let _0x1b8600=this['getLibPattern'](_0x3be45e);_0x53b48e['push'](_0x1b8600),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x3be45e+'\x20->\x20'+_0x1b8600);}return console['log']('[Permissions] Final package path patterns:',_0x53b48e),_0x53b48e;}['buildImportMap'](_0x1c9124){let _0x2c0fed=this['getImports'](),_0x96639f=_0x2c0fed['includes']('*')?Object['keys'](_0x1c9124):_0x2c0fed;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x96639f);let _0x1c32e9={};for(let _0x1dff85 of _0x96639f)if(_0x1c9124[_0x1dff85])_0x1c32e9[_0x1dff85]=_0x1c9124[_0x1dff85],console['log']('[ImportMap]\x20'+_0x1dff85+'\x20->\x20'+_0x1c9124[_0x1dff85]+'\x20(from\x20platform)');else try{let _0x38b1d0=z(),_0x31e1eb=join(_0x38b1d0['cwd'](),this['libDir']),_0x4c78e5=!0x1;try{for(let _0x50e483 of _0x38b1d0['readDirSync'](_0x31e1eb))if(_0x50e483['isDirectory']&&(_0x50e483['name']===_0x1dff85||_0x50e483['name']['startsWith'](_0x1dff85+'@'))){let _0x1e4dfd=join(_0x38b1d0['cwd'](),this['libDir'],_0x50e483['name'],'index.js')['replace'](/\\/g,'/'),_0xa157a3=new URL('file:///'+_0x1e4dfd)['href'];_0x1c32e9[_0x1dff85]=_0xa157a3,console['log']('[ImportMap]\x20'+_0x1dff85+'\x20->\x20'+_0xa157a3+'\x20(from\x20lib)'),_0x4c78e5=!0x0;break;}}catch{}_0x4c78e5||console['warn']('[ImportMap]\x20Package\x20'+_0x1dff85+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0xa382c4){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x1dff85+':',_0xa382c4);}return _0x1c32e9;}['validateServerImports'](_0x4462b7){let _0x264ea8=this['manifest']['name']||this['manifest']['id'],_0x2df954=this['manifest']['metadata']?.['serverPath'],_0x342976=_0x12b6f8=>_0x12b6f8['replace'](/\\/g,'/'),_0x573760=z(),_0x539cf9=_0x794f1f=>{try{return _0x573760['statSync'](_0x794f1f),!0x0;}catch{return![];}},_0x205ace=_0x2df954?_0x342976(_0x2df954):void 0x0;if(!_0x205ace){let _0x492041=[_0x4462b7+'/service/server.js',_0x4462b7+'/service/server.ts',_0x4462b7+'/'+_0x264ea8+'/server.js',_0x4462b7+'/'+_0x264ea8+'/server.ts',_0x4462b7+'/server.js',_0x4462b7+'/server.ts']['map'](_0x342976);for(let _0x17775a of _0x492041)if(_0x539cf9(_0x17775a)){_0x205ace=_0x17775a;break;}}if(!_0x205ace)return{'valid':![],'violations':['Failed to locate server module']};let _0x230808='';try{_0x230808=_0x573760['readTextFileSync'](_0x205ace);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x205ace};}let _0x2ef71d=this['getImports']();if(_0x2ef71d['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x205ace};let _0x58e859=_0x2ef71d,_0x31bf25=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x14fc4f=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x463fb1=/\bimport\s*['"]([^'"]+)['"]/g,_0x14251e=[],_0x812686=new Set(),_0x102c72=_0x319838=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x319838),_0x34be61=_0x2266e5=>{let _0x3d5443=_0x2266e5;if(_0x3d5443['startsWith']('./')||_0x3d5443['startsWith']('../')||_0x3d5443['startsWith']('/')||_0x3d5443['startsWith']('file://')||!_0x102c72(_0x2266e5)||_0x812686['has'](_0x2266e5))return;_0x812686['add'](_0x2266e5),_0x3d5443['startsWith']('npm:')&&(_0x3d5443=_0x3d5443['substring'](0x4)),_0x3d5443['includes']('@')&&!_0x3d5443['startsWith']('@')&&(_0x3d5443=_0x3d5443['split']('@')[0x0]);let _0x710557=_0x3d5443['split']('/')[0x0];_0x58e859['includes'](_0x710557)||_0x58e859['includes'](_0x2266e5)||_0x14251e['push'](_0x2266e5);},_0x3f5860;for(;(_0x3f5860=_0x31bf25['exec'](_0x230808))!==null;)_0x34be61(_0x3f5860[0x1]);for(;(_0x3f5860=_0x14fc4f['exec'](_0x230808))!==null;)_0x34be61(_0x3f5860[0x1]);for(;(_0x3f5860=_0x463fb1['exec'](_0x230808))!==null;)_0x34be61(_0x3f5860[0x1]);return{'valid':_0x14251e['length']===0x0,'violations':_0x14251e,'serverPath':_0x205ace};}['validate'](_0x2dedee={}){let _0x1e0a6e=[],_0x5e29b1=this['manifest']['permissions']||{};try{let _0x3bcead=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x3bcead);}catch{}let _0x4cf212=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x5e7a8f,_0x382859]of Object['entries'](_0x5e29b1))if(_0x5e7a8f==='hrtime')typeof _0x382859!='boolean'&&_0x1e0a6e['push']('Permission\x20\x27'+_0x5e7a8f+'\x27\x20must\x20be\x20boolean');else{if(_0x5e7a8f==='langchain')typeof _0x382859!='boolean'&&(typeof _0x382859!='object'||_0x382859===null)?_0x1e0a6e['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x382859=='object'&&(_0x382859===null||!('enabled'in _0x382859)||typeof _0x382859['enabled']!='boolean')&&_0x1e0a6e['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x5e7a8f==='kv')typeof _0x382859!='boolean'&&_0x1e0a6e['push']('Permission\x20\x27'+_0x5e7a8f+'\x27\x20must\x20be\x20boolean');else{if(_0x5e7a8f==='mspbots')Array['isArray'](_0x382859)||_0x1e0a6e['push']('Permission\x20\x27'+_0x5e7a8f+'\x27\x20must\x20be\x20an\x20array');else{if(_0x5e7a8f==='db'){if(typeof _0x382859!='object'||_0x382859===null||Array['isArray'](_0x382859))_0x1e0a6e['push']('Permission\x20\x27'+_0x5e7a8f+'\x27\x20must\x20be\x20an\x20object');else{let _0x130e12=_0x382859,_0x250483=['user','password']['filter'](_0x26f963=>!(_0x26f963 in _0x130e12));_0x250483['length']>0x0&&_0x1e0a6e['push']('Permission\x20\x27'+_0x5e7a8f+'\x27\x20missing\x20required\x20fields:\x20'+_0x250483['join'](',\x20'));}}else{if(_0x5e7a8f==='imports')continue;_0x4cf212['has'](_0x5e7a8f)||typeof _0x382859!='boolean'&&!Array['isArray'](_0x382859)&&_0x1e0a6e['push']('Permission\x20\x27'+_0x5e7a8f+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x122e86=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x122e86))_0x1e0a6e['push']('permissions.imports must be an array');else{for(let _0x4e1870 of _0x122e86)typeof _0x4e1870!='string'&&_0x1e0a6e['push']('import\x20\x27'+_0x4e1870+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x1e0a6e['length']===0x0,'errors':_0x1e0a6e};}};function q(_0xb4f9dd,_0x42cd8d,_0x444490){return new D(_0xb4f9dd,_0x42cd8d,_0x444490||{});}var R=null;function I(){let _0x8683fb=globalThis['Deno'];if(!_0x8683fb)throw new Error('Deno is not available');return _0x8683fb;}async function K(){if(R)return{...R};try{let _0x60a825=I(),_0x1ac220=join(_0x60a825['cwd'](),'deno.json'),_0x2e2d88=await _0x60a825['readTextFile'](_0x1ac220);return R=JSON['parse'](_0x2e2d88)['imports']||{},{...R};}catch(_0x619cab){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x619cab),{};}}var E=class{constructor(_0xa2b83a,_0x1e2851={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0xa2b83a['appsDir'],this['platformImportsOverride']=_0xa2b83a['platformImports'],this['libDir']=_0xa2b83a['libDir'],this['events']=_0x1e2851);}async['create'](_0x1cf3b3,_0x1b8a30,_0x553c18){try{return await this['createWorker'](_0x1cf3b3,_0x1b8a30,_0x553c18);}catch(_0x28ec34){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x1cf3b3+':',_0x28ec34),_0x28ec34;}}async['createWorker'](_0x379b97,_0xf14a71,_0x43b24b){let _0x52123a=this['platformImportsOverride']||await K(),_0x26e739=q(_0xf14a71,this['libDir'],_0x52123a)['validateServerImports'](this['appsDir']);if(!_0x26e739['valid']){let _0x16ecc7=_0x26e739['violations']['filter'](_0x1cd5d2=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x1cd5d2)),_0x2a5095=_0x26e739['serverPath']?_0x26e739['serverPath']:(_0xf14a71['name']||_0xf14a71['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x2a5095+':\x20'+_0x16ecc7['join'](',\x20'));}let _0x5083d1=q(_0xf14a71,this['libDir'],_0x52123a),_0x12ff46=_0x5083d1['validate'](_0x52123a);if(!_0x12ff46['valid'])throw new Error('Invalid\x20config:\x20'+_0x12ff46['errors']['join'](',\x20'));let _0xe0a928=_0x5083d1['buildImportMap'](_0x52123a);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x379b97+':',_0xe0a928);let _0x408aed=_0x5083d1['buildPerms'](),_0xf32441=_0x5083d1['getReadPaths']();if(_0x408aed['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x408aed['read']);else{let _0x38c4f1=_0xf14a71['name']||_0x379b97,_0x3f7a67=this['appsDir']+'/'+_0x38c4f1,_0x2bbb0e=[_0x3f7a67],_0x5604af=_0xf14a71['metadata']?.['serverPath'];if(_0x5604af&&typeof _0x5604af=='string')try{let _0x2bc722=dirname(_0x5604af)['replace'](/\\/g,'/');_0x2bbb0e['push'](_0x2bc722);}catch{}_0x408aed['read']=_0x2bbb0e,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x3f7a67);}if(_0xf32441['length']>0x0){if(_0x408aed['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x16b020=Array['isArray'](_0x408aed['read'])?_0x408aed['read']:[];_0x408aed['read']=[..._0x16b020,..._0xf32441],console['log']('[Worker] Added package read permissions:',_0xf32441);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x408aed['net']||(_0x408aed['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x379b97+':',_0x408aed['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x408aed['read']===!![]?'unrestricted':Array['isArray'](_0x408aed['read'])?_0x408aed['read']['length']:0x0));let _0x3e8099=await this['createImportMap'](_0x379b97,_0xe0a928),_0x1b2518=await this['createLock'](_0x379b97,_0xe0a928),_0x5e3072={'type':'module','deno':{'permissions':{}}};_0x5e3072['deno']['namespace']=![],_0x5e3072['deno']['permissions']=_0x408aed,_0x5e3072['deno']['importMap']=_0x3e8099,_0x5e3072['deno']['lock']=_0x1b2518,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x379b97+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x3e8099),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x1b2518),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0xe0a928)['length']+'\x20('+(Object['keys'](_0xe0a928)['join'](',\x20')||'none')+')');let _0x5b2024={'worker':new Worker(_0x43b24b,_0x5e3072),'appId':_0x379b97,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0xf14a71,'importMapPath':_0x3e8099,'lockfilePath':_0x1b2518};return this['workers']['set'](_0x379b97,_0x5b2024),this['events']['onCreate']?.(_0x5b2024),_0x5b2024;}async['createLock'](_0x1e8311,_0x1131c7){let _0x270cad=I(),_0x117eec=join(_0x270cad['cwd'](),'storage','temp','lockfiles');await _0x270cad['mkdir'](_0x117eec,{'recursive':!![]});let _0x45dec9=_0x1e8311+'-'+Date['now']()+'.lock',_0x2bcae1=join(_0x117eec,_0x45dec9),_0x4f6f67={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0xc0bb37,_0x1c2376]of Object['entries'](_0x1131c7))if(_0x1c2376['startsWith']('npm:'))_0x1c2376['replace']('npm:',''),_0x4f6f67['packages']['specifiers'][_0xc0bb37]=_0x1c2376;else _0x1c2376['startsWith']('file://')&&(_0x4f6f67['packages']['specifiers'][_0xc0bb37]=_0x1c2376);let _0x1b1c3c=JSON['stringify'](_0x4f6f67,null,0x2);return await _0x270cad['writeTextFile'](_0x2bcae1,_0x1b1c3c),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x2bcae1),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x1131c7)['length']+'):',Object['keys'](_0x1131c7)),_0x2bcae1;}async['createImportMap'](_0x21e684,_0x5a5fcf){let _0x17ac9b=I(),_0x4c3013=join(_0x17ac9b['cwd'](),'storage','temp','importmaps');await _0x17ac9b['mkdir'](_0x4c3013,{'recursive':!![]});let _0xe7f63a=_0x21e684+'-'+Date['now']()+'.json',_0x5669a2=join(_0x4c3013,_0xe7f63a),_0x35356d=JSON['stringify']({'imports':_0x5a5fcf,'scopes':{}},null,0x2);return await _0x17ac9b['writeTextFile'](_0x5669a2,_0x35356d),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x5669a2),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x5a5fcf)['length']+'):',Object['keys'](_0x5a5fcf)['join'](',\x20')||'none'),_0x5669a2;}['get'](_0x5e3dc7){return this['workers']['get'](_0x5e3dc7);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x2d3244,_0x55d801){let _0x368f41=this['workers']['get'](_0x2d3244);if(!_0x368f41)return;let _0x2bee82=_0x368f41['status'];_0x368f41['status']=_0x55d801,_0x55d801==='running'&&_0x2bee82==='starting'?this['events']['onReady']?.(_0x368f41):_0x55d801==='crashed'&&this['events']['onCrash']?.(_0x368f41);}['touch'](_0x5b9960){let _0x1bcd56=this['workers']['get'](_0x5b9960);_0x1bcd56&&(_0x1bcd56['lastUsed']=Date['now']());}async['stop'](_0x3ac080){let _0xd564d0=this['workers']['get'](_0x3ac080);if(_0xd564d0)try{_0xd564d0['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0xd564d0['worker']['terminate'](),_0xd564d0['status']='stopped',this['events']['onStop']?.(_0xd564d0),_0xd564d0['importMapPath']&&await this['cleanupImportMap'](_0xd564d0['importMapPath']),_0xd564d0['lockfilePath']&&await this['cleanupLock'](_0xd564d0['lockfilePath']);}catch(_0x10f549){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x3ac080+':',_0x10f549);}finally{this['workers']['delete'](_0x3ac080);}}async['cleanupImportMap'](_0x2bccca){try{await I()['remove'](_0x2bccca),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x2bccca);}catch(_0x555c17){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x2bccca,_0x555c17);}}async['cleanupLock'](_0x2c632b){try{await I()['remove'](_0x2c632b),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x2c632b);}catch(_0x375f72){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x2c632b,_0x375f72);}}async['stopAll'](){let _0x4d37bc=Array['from'](this['workers']['keys']());await Promise['all'](_0x4d37bc['map'](_0x13a05d=>this['stop'](_0x13a05d)));}async['restart'](_0x437b5d,_0xb3cf19){let _0x18c2ea=this['workers']['get'](_0x437b5d);if(!_0x18c2ea)throw new Error('Worker\x20'+_0x437b5d+'\x20not\x20found');let _0x24625e=_0x18c2ea['manifest'];return await this['stop'](_0x437b5d),await this['create'](_0x437b5d,_0x24625e,_0xb3cf19);}['checkHealth'](_0x189777){let _0x2cd282=this['workers']['get'](_0x189777);if(!_0x2cd282)return{'healthy':![],'reason':'Not\x20found'};if(_0x2cd282['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x2cd282['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x1a0796=Date['now']()-_0x2cd282['lastUsed'],_0x14e6ad=0x708*0x3e8;return _0x1a0796>_0x14e6ad?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x1a0796/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x19c83c=0x708*0x3e8,_0x4acaaa){let _0x3e2310=Date['now'](),_0x4565a2=[];for(let [_0x307649,_0x527b47]of this['workers']['entries']()){let _0x4bfbcb=_0x3e2310-_0x527b47['lastUsed'];_0x4bfbcb>_0x19c83c&&_0x4565a2['push']({'appId':_0x307649,'idle':_0x4bfbcb});}_0x4565a2['sort']((_0x17b95f,_0x1d0631)=>_0x1d0631['idle']-_0x17b95f['idle']);let _0x30ac54=_0x4acaaa?_0x4565a2['slice'](0x0,_0x4acaaa)['map'](_0x1575fe=>_0x1575fe['appId']):_0x4565a2['map'](_0x42f4e1=>_0x42f4e1['appId']);for(let _0x32edfb of _0x30ac54)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x32edfb),await this['stop'](_0x32edfb);}['stats'](){let _0x3680f8={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x2cce43=Date['now']();for(let _0x500d28 of this['workers']['values']())_0x3680f8['byStatus'][_0x500d28['status']]++,_0x3680f8['workers']['push']({'appId':_0x500d28['appId'],'status':_0x500d28['status'],'version':_0x500d28['version'],'lastUsed':_0x500d28['lastUsed'],'idle':_0x2cce43-_0x500d28['lastUsed']});return _0x3680f8;}['startCleanup'](_0x5a9c5f=0x12c*0x3e8,_0xf40d05){let _0x2a890f=setInterval(()=>{this['cleanup'](_0xf40d05)['catch'](_0x140451=>{console['error']('Cleanup\x20failed:',_0x140451);});},_0x5a9c5f);return()=>clearInterval(_0x2a890f);}['delay'](_0x407ab8){return new Promise(_0x557f20=>setTimeout(_0x557f20,_0x407ab8));}};function W(_0x2d2c72,_0x481092){return new E(_0x2d2c72,_0x481092);}var v=f,j=class{constructor(_0x5c2a50,_0x455ef3=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x5c2a50,this['timeout']=_0x455ef3);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x3d5685){_0x3d5685['worker']['onmessage']=_0x655dc5=>{let _0x5aabbe=_0x655dc5['data'],{appId:_0x29feda}=_0x3d5685;switch(_0x5aabbe['type']){case'ready':this['events']['onReady'](_0x29feda),v['info']('Worker\x20ready',{'appId':_0x29feda,'version':_0x3d5685['version']});break;case'log':{let {level:_0x5d94f6='info',message:_0xe7ce0f,meta:_0x11e0c6}=_0x5aabbe,_0x133366={..._0x11e0c6||{},'appId':_0x29feda,'version':_0x3d5685['version']};this['events']['onLog'](_0x29feda,_0x5d94f6,_0xe7ce0f,_0x133366);break;}case'result':{let {reqId:_0x31d075,ok:_0x25f8fa,response:_0x5bf5f2,error:_0x1ca944}=_0x5aabbe,_0x5dd2bf=this['pending']['get'](_0x31d075);if(!_0x5dd2bf){v['warn']('Unknown\x20request',{'appId':_0x29feda,'reqId':_0x31d075});return;}if(this['pending']['delete'](_0x31d075),_0x25f8fa&&_0x5bf5f2)_0x5dd2bf['resolve'](_0x5bf5f2);else{let _0x2fa693=new Error(_0x1ca944?.['message']||'Worker\x20error');_0x2fa693['stack']=_0x1ca944?.['stack'],_0x5dd2bf['reject'](_0x2fa693);}this['events']['onResult'](_0x29feda,_0x31d075,_0x5bf5f2||_0x1ca944);break;}default:v['debug']('Unknown\x20message',{'appId':_0x29feda,'type':_0x5aabbe['type']});}},_0x3d5685['worker']['onerror']=_0x336314=>{let {appId:_0x9d5630}=_0x3d5685;v['error']('Worker\x20error',{'appId':_0x9d5630,'message':_0x336314['message'],'lineno':_0x336314['lineno'],'filename':_0x336314['filename']}),_0x3d5685['status']='crashed',this['rejectPending'](_0x9d5630,new Error('Worker\x20'+_0x9d5630+'\x20crashed:\x20'+_0x336314['message'])),_0x336314['preventDefault']();},_0x3d5685['worker']['onmessageerror']=_0x21f8d5=>{let {appId:_0x3a9aef}=_0x3d5685;v['error']('Message\x20error',{'appId':_0x3a9aef,'data':_0x21f8d5['data']}),_0x3d5685['status']='crashed',_0x21f8d5['preventDefault']();};}['sendInit'](_0x1b9747,_0x5f4bee,_0x5c8872,_0x30c26d){_0x1b9747['worker']['postMessage']({'type':'init','appId':_0x1b9747['appId'],'manifest':_0x5c8872,'appsDir':_0x5f4bee,'serverPath':_0x30c26d});}async['sendInvoke'](_0xaf7769,_0x48756d){let _0x31b8a4=this['nextId'](),_0x277505=_0xaf7769['appId'],_0x3e128e=new Promise((_0x41c229,_0x49fe98)=>{let _0x478f1f=setTimeout(()=>{this['pending']['delete'](_0x31b8a4),_0x49fe98(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x31b8a4,{'resolve':_0x2e231d=>{clearTimeout(_0x478f1f),_0x41c229(_0x2e231d);},'reject':_0x163bdc=>{clearTimeout(_0x478f1f),_0x49fe98(_0x163bdc);},'timestamp':Date['now'](),'appId':_0x277505});});return _0xaf7769['worker']['postMessage']({'type':'invoke','appId':_0xaf7769['appId'],'reqId':_0x31b8a4,'payload':_0x48756d}),await _0x3e128e;}['rejectPending'](_0x596e96,_0x5d7734){let _0x648057=0x0;for(let [_0x20e8d7,_0x289a7f]of this['pending']['entries']())_0x289a7f['appId']===_0x596e96&&(this['pending']['delete'](_0x20e8d7),_0x289a7f['reject'](_0x5d7734),_0x648057++);_0x648057>0x0&&v['warn']('Rejected\x20'+_0x648057+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x596e96});}['cleanupTimeout'](){let _0x31a683=Date['now']();for(let [_0x2360a9,_0xb4cfb2]of this['pending']['entries']())_0x31a683-_0xb4cfb2['timestamp']>this['timeout']&&(this['pending']['delete'](_0x2360a9),_0xb4cfb2['reject'](new Error('Request\x20'+_0x2360a9+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x3dcf5a){let _0x54fbd3=0x0;for(let _0x439cc6 of this['pending']['values']())_0x439cc6['appId']===_0x3dcf5a&&_0x54fbd3++;return _0x54fbd3;}['startCleanup'](_0x5d0701=0x2710){let _0x375b46=setInterval(()=>{this['cleanupTimeout']();},_0x5d0701);return()=>clearInterval(_0x375b46);}};function $(_0x8dc79b,_0x8a80df){return new j(_0x8dc79b,_0x8a80df);}var Q=class{constructor(_0x248fdf={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x248fdf['logger']||f,this['config']={'appsDir':_0x248fdf['appsDir']||this['getAppsDir'](),'scriptUrl':_0x248fdf['scriptUrl']||this['getScriptUrl'](),'timeout':_0x248fdf['timeout']||0x78*0x3e8,'autoCleanup':_0x248fdf['autoCleanup']??!![],'cleanupInterval':_0x248fdf['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x248fdf['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x248fdf['maxWorkers'],'reuseWorkers':_0x248fdf['reuseWorkers']??!![],'workerReuseStrategy':_0x248fdf['workerReuseStrategy']||'lru','enableQueue':_0x248fdf['enableQueue']??!![],'maxQueueSize':_0x248fdf['maxQueueSize']||0x64,'queueTimeout':_0x248fdf['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x42d6c1=>this['logger']['info']('Worker\x20created',{'appId':_0x42d6c1['appId'],'v':_0x42d6c1['version']}),'onReady':_0x44a05b=>this['lifecycle']['updateStatus'](_0x44a05b['appId'],'running'),'onCrash':_0x52e8a7=>this['logger']['error']('Worker\x20crashed',{'appId':_0x52e8a7['appId'],'v':_0x52e8a7['version']}),'onStop':_0x3d3a31=>this['logger']['info']('Worker\x20stopped',{'appId':_0x3d3a31['appId'],'v':_0x3d3a31['version']})}),this['messaging']=$({'onReady':_0x38edb8=>this['lifecycle']['updateStatus'](_0x38edb8,'running'),'onLog':(_0x165bb4,_0xc622be,_0x1c2a77,_0xac172e)=>{let _0x54a756={..._0xac172e||{},'appId':_0x165bb4};switch(_0xc622be){case'error':this['logger']['error'](_0x1c2a77,_0x54a756);break;case'warn':this['logger']['warn'](_0x1c2a77,_0x54a756);break;case'debug':this['logger']['debug'](_0x1c2a77,_0x54a756);break;default:this['logger']['info'](_0x1c2a77,_0x54a756);break;}},'onResult':(_0x36224a,_0x36a9e6,_0x42bf0f)=>{this['logger']['debug']('Result\x20received',{'appId':_0x36224a,'reqId':_0x36a9e6});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x627d89['cwd'](),'apps');}['getScriptUrl'](){let _0x2cd9cf=import.meta.url,_0x7a544c=_0x2cd9cf['endsWith']('.js')||_0x2cd9cf['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x7a544c,_0x2cd9cf)['href'];}async['ensure'](_0x2be0c0){let {id:_0x581e79}=_0x2be0c0,_0x547b2e=this['lifecycle']['get'](_0x581e79);if(_0x547b2e){let _0x1d8c06=this['lifecycle']['checkHealth'](_0x581e79);if(_0x1d8c06['healthy'])return this['lifecycle']['touch'](_0x581e79),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x581e79}),_0x547b2e;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x581e79,'reason':_0x1d8c06['reason']}),await this['lifecycle']['stop'](_0x581e79);}for(;;){let _0x456dd4=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x456dd4>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x456dd4,'max':this['config']['maxWorkers'],'appId':_0x581e79}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x2be0c0);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x57118d=await this['loadManifest'](_0x581e79,_0x2be0c0['manifest']),_0xb875c1=await this['lifecycle']['create'](_0x581e79,_0x57118d,this['config']['scriptUrl']),_0x2a27eb=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x2a27eb>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x2a27eb,'max':this['config']['maxWorkers'],'appId':_0x581e79}),await this['lifecycle']['stop'](_0x581e79),this['config']['enableQueue'])return await this['waitSlot'](_0x2be0c0);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x2a27eb+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0xb875c1);let _0x5b9caf=_0x57118d['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0xb875c1,this['config']['appsDir'],_0x57118d,_0x5b9caf),this['logger']['info']('Worker\x20created',{'appId':_0x581e79,'v':_0xb875c1['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0xb875c1;}async['evictIdle'](){let _0x21daad=this['lifecycle']['getAll']();if(_0x21daad['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x2859b8=[..._0x21daad];this['config']['workerReuseStrategy']==='lru'?_0x2859b8['sort']((_0x37ef8a,_0x3307bb)=>_0x37ef8a['lastUsed']-_0x3307bb['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x2859b8['sort']((_0x4dfb10,_0x54bfea)=>_0x4dfb10['version']-_0x54bfea['version']);let _0x11a325=null;for(let _0x281806 of _0x2859b8)if(this['messaging']['getAppCount'](_0x281806['appId'])===0x0){_0x11a325=_0x281806;break;}if(!_0x11a325&&_0x2859b8['length']>0x0&&(_0x11a325=_0x2859b8['reduce']((_0x3a2794,_0x22f39d)=>{let _0xc46de5=this['messaging']['getAppCount'](_0x3a2794['appId']);return this['messaging']['getAppCount'](_0x22f39d['appId'])<_0xc46de5?_0x22f39d:_0x3a2794;})),_0x11a325){let _0x3b5547=this['messaging']['getAppCount'](_0x11a325['appId']);return _0x3b5547>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x11a325['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x11a325['lastUsed'],'pendingRequests':_0x3b5547}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x11a325['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x11a325['lastUsed']}),await this['lifecycle']['stop'](_0x11a325['appId']),!![];}return![];}['waitSlot'](_0x5542dd){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x16f5f0,_0x7e5ea7)=>{let _0x39f447={'info':_0x5542dd,'resolve':_0x16f5f0,'reject':_0x7e5ea7,'timestamp':Date['now']()};this['requestQueue']['push'](_0x39f447),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x5542dd['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x5502e3=setTimeout(()=>{let _0x274f27=this['requestQueue']['indexOf'](_0x39f447);_0x274f27!==-0x1&&(this['requestQueue']['splice'](_0x274f27,0x1),_0x7e5ea7(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x39f447['resolve']=_0x2097ac=>{clearTimeout(_0x5502e3),_0x16f5f0(_0x2097ac);},_0x39f447['reject']=_0x1a31fb=>{clearTimeout(_0x5502e3),_0x7e5ea7(_0x1a31fb);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x560a43=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x560a43>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x5d5787=this['requestQueue']['shift']();if(!_0x5d5787)break;try{let _0xcbfd9a=await this['ensure'](_0x5d5787['info']);_0x5d5787['resolve'](_0xcbfd9a);}catch(_0x43eeae){_0x5d5787['reject'](_0x43eeae);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x225f30,_0x3d4d6d){let _0x44c09b=this['config']['appsDir']['replace'](/\\/g,'/'),_0x4fa186=async _0x3807cd=>{try{let _0x199890=globalThis['Deno'];if(!_0x199890)return null;let _0x12af93=await _0x199890['readTextFile'](_0x3807cd);return JSON['parse'](_0x12af93);}catch{return null;}};if(_0x3d4d6d?.['name']){let _0xbbc1a9=await _0x4fa186(_0x44c09b+'/'+_0x3d4d6d['name']+'/manifest.json');if(_0xbbc1a9)return _0xbbc1a9;}let _0x25304d=await _0x4fa186(_0x44c09b+'/'+_0x225f30+'/manifest.json');if(_0x25304d)return _0x25304d;try{let _0x361b07=globalThis['Deno'];if(_0x361b07)for await(let _0x1d5ef8 of _0x361b07['readDir'](_0x44c09b)){if(!_0x1d5ef8['isDirectory'])continue;let _0x425b6d=_0x44c09b+'/'+_0x1d5ef8['name']+'/manifest.json',_0x5f33af=await _0x4fa186(_0x425b6d);if(_0x5f33af&&(_0x5f33af['id']===_0x225f30||_0x3d4d6d?.['name']&&_0x5f33af['name']===_0x3d4d6d['name']))return _0x5f33af;}}catch(_0x3f2cb1){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x225f30,'error':_0x3f2cb1['message']});}return _0x3d4d6d||{'id':_0x225f30,'name':_0x225f30,'version':'1.0.0'};}async['invoke'](_0x4ad783){let _0x1d6966=_0x4ad783['ctx']['app']['id'],_0x420da8=_0x4ad783['ctx']['app']['name'];try{let _0x493fa6={'id':_0x1d6966,'manifest':{'id':_0x1d6966,'name':_0x420da8}},_0x2a4368=await this['ensure'](_0x493fa6);if(_0x2a4368['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x1d6966}),await this['restart'](_0x1d6966);let _0x3f9344=await this['ensure'](_0x493fa6);return this['lifecycle']['touch'](_0x1d6966),await this['messaging']['sendInvoke'](_0x3f9344,_0x4ad783);}return this['lifecycle']['touch'](_0x1d6966),await this['messaging']['sendInvoke'](_0x2a4368,_0x4ad783);}catch(_0x183c2f){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x1d6966,'error':_0x183c2f['message'],'stack':_0x183c2f['stack']}),_0x183c2f;}}async['stop'](_0xe4a54d){await this['lifecycle']['stop'](_0xe4a54d),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x16496a){return await this['lifecycle']['restart'](_0x16496a,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x18b50f=>({'appId':_0x18b50f['appId'],'status':_0x18b50f['status'],'version':_0x18b50f['version'],'lastUsed':_0x18b50f['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0xf46c55=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x56bfc7=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0xf46c55(),_0x56bfc7();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x1facbb=>{_0x1facbb?(await this['stop'](_0x1facbb),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x1facbb})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x51f45f){return new Q(_0x51f45f);}var S=null;function be(_0x58f22a){S=ee(_0x58f22a);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x1ecc33){return await k()['ensure'](_0x1ecc33);}async function xe(_0x4e0ef4){return await k()['invoke'](_0x4e0ef4);}function Ie(_0x5d8b36){k()['stop'](_0x5d8b36)['catch'](_0x57a861=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x5d8b36,'error':_0x57a861['message']});});}function Re(){k()['stopAll']()['catch'](_0x4f089c=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x4f089c['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x20606c){await k()['stop'](_0x20606c);}async function Se(){await k()['stopAll']();}function Ae(_0xebe559){let _0x187097=_0xebe559&&typeof _0xebe559=='object'?_0xebe559:null;if(_0x187097&&'user'in _0x187097)return _0x187097['user'];}function H(_0x1e1f1a){let _0x470143=_0x1e1f1a&&typeof _0x1e1f1a=='object'?_0x1e1f1a:null;if(!_0x470143)return{};let _0x33e907={};for(let [_0x13a479,_0x2aad4c]of Object['entries'](_0x470143))_0x13a479!=='user'&&(_0x33e907[_0x13a479]=_0x2aad4c);return _0x33e907;}function O(_0x127b90){return _0x127b90?{'id':_0x127b90['manifest']?.['id']||_0x127b90['id']||'','name':_0x127b90['manifest']?.['name']||'','version':_0x127b90['manifest']?.['version']||'','description':_0x127b90['manifest']?.['description']||'','icon':_0x127b90['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x27f6cc){return _0x27f6cc?.['permissions']||_0x27f6cc?.['manifest']?.['permissions']||{};}function F(_0x59bbe3){return _0x59bbe3?.['manifest']?.['metadata']||{};}function Ce(_0xb111c2){return _0xb111c2?{'appId':_0xb111c2['id'],'appName':_0xb111c2['manifest']?.['name']}:{};}function N(_0x4f7949,_0x11c23a={}){let {appInfo:_0x3352b2=null,status:_0x48d94c=0x1f4,defaultMessage:_0x2d6704='Internal\x20Server\x20Error'}=_0x11c23a,_0x7fa1a0={'error':_0x2d6704,'message':_0x4f7949?.['message']||_0x2d6704};return _0x3352b2&&(_0x7fa1a0['appId']=_0x3352b2['id'],_0x7fa1a0['appName']=_0x3352b2['manifest']?.['name']),_0x4f7949?.['message']?.['includes']('crashed')&&(_0x7fa1a0['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x48d94c,'body':_0x7fa1a0};}function qe(_0x45cdbd){return _0x45cdbd?.['message']?.['includes']('crashed')||![];}function J(_0x1ecae4){if(_0x1ecae4)try{return JSON['parse'](_0x1ecae4);}catch{return _0x1ecae4;}}function B(_0x8ce620){try{let _0x22637b=new URL(_0x8ce620),_0x256749={};for(let _0x3a6094 of _0x22637b['searchParams']['keys']()){let _0x1baeae=_0x22637b['searchParams']['getAll'](_0x3a6094)['map'](_0x327aac=>_0x327aac);_0x1baeae['length']<=0x1?_0x256749[_0x3a6094]=_0x1baeae[0x0]??'':_0x256749[_0x3a6094]=_0x1baeae;}return _0x256749;}catch{return{};}}function Le(_0x4ca5f3){return(()=>{try{return new URL(_0x4ca5f3)['pathname'];}catch{return _0x4ca5f3;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x239f22,_0xe6f12c){let _0x57b730=_0x239f22;if(_0xe6f12c&&_0x57b730['startsWith']('/apps/'+_0xe6f12c))_0x57b730=_0x57b730['substring'](('/apps/'+_0xe6f12c)['length'])||'/';else{let _0x305f6c=_0x57b730['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x305f6c&&(_0x57b730=_0x305f6c[0x1]||'/');}return _0x57b730['startsWith']('/api')&&(_0x57b730=_0x57b730['substring'](0x4)||'/'),_0x57b730;}function Ue(_0x12ad8f,_0x1d227d){let _0x1fb609=_0x12ad8f;if(_0x1d227d&&_0x1fb609['startsWith']('/apps/'+_0x1d227d))_0x1fb609=_0x1fb609['substring'](('/apps/'+_0x1d227d)['length'])||'/';else{let _0x42399=_0x1fb609['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x42399&&(_0x1fb609=_0x42399[0x1]||'/');}return(!_0x1fb609||_0x1fb609==='/')&&(_0x1fb609='/index.html'),_0x1fb609;}async function He(_0x3e8366,_0x4b3a9c){return await _0x4b3a9c(_0x3e8366);}function _(_0x4b0692){return _0x4b0692['split']('/')['filter'](_0x37298a=>_0x37298a['length']>0x0);}function te(_0x3ac730){try{return decodeURIComponent(_0x3ac730);}catch{return _0x3ac730;}}function re(_0x243845,_0x51e459){let _0x78b9b1=_(_0x243845),_0x48d970=_(_0x51e459),_0x76a88b={},_0x4736d7=0x0,_0x1adf1e=0x0;for(;_0x4736d7<_0x78b9b1['length']&&_0x1adf1e<_0x48d970['length'];){let _0x1451be=_0x78b9b1[_0x4736d7],_0x327646=_0x48d970[_0x1adf1e];if(_0x1451be==='*')break;if(_0x1451be['startsWith'](':')){let _0x5ee62f=_0x1451be['slice'](0x1);_0x5ee62f&&(_0x76a88b[_0x5ee62f]=te(_0x327646)),_0x4736d7++,_0x1adf1e++;continue;}if(_0x1451be!==_0x327646)return{};_0x4736d7++,_0x1adf1e++;}return _0x4736d7===_0x78b9b1['length']||_0x4736d7===_0x78b9b1['length']-0x1&&_0x78b9b1[_0x4736d7]==='*',_0x76a88b;}async function Oe(_0x3ff750,_0x2a5b6d,_0x43962a,_0x5d8e98,_0x4a55d4=void 0x0,_0x317019){let _0x4ae6e8=await _0x2a5b6d['text'](),_0x297afc=J(_0x4ae6e8),_0x33a28f=B(_0x2a5b6d['url']),_0x50e1c5={...F(_0x3ff750),'user':_0x4a55d4},_0x2e8793=H(_0x50e1c5),_0x3a70d0=_0x317019?re(_0x317019,_0x2a5b6d['path']):{};return{'app':O(_0x3ff750),'permissions':T(_0x3ff750),'user':_0x4a55d4,'metadata':_0x2e8793,'body':_0x297afc,'query':_0x33a28f,'params':_0x3a70d0,'method':_0x43962a,'pathname':_0x5d8e98,'requestUrl':_0x2a5b6d['url'],'headers':Object['fromEntries'](_0x2a5b6d['raw']['headers']['entries']())};}function Te(_0x4de456){return{'method':_0x4de456['method'],'pathname':_0x4de456['pathname'],'ctx':_0x4de456};}function Fe(_0x5c84c9,_0x3d12f7){let {status:_0xa6bd0c=0xc8,headers:_0x52983c={},body:_0x119d44,type:_0x3f7471}=_0x5c84c9??{};return _0x3f7471==='raw'?new globalThis['Response'](String(_0x119d44??''),{'status':_0xa6bd0c,'headers':_0x52983c}):_0x3d12f7(_0x119d44,_0xa6bd0c);}function Ne(_0x1539c9,_0x236ee9=null){return N(_0x1539c9,{'appInfo':_0x236ee9});}var V=f;async function Ve(_0x2a1375){_0x2a1375?(await U(_0x2a1375),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x2a1375)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x2a32fe,_0x283a69){let _0x2843b1=Object['fromEntries'](Object['entries'](_0x2a32fe['headers']||{})['map'](([_0x366e73,_0x632231])=>[_0x366e73['toLowerCase'](),_0x632231]));return{'id':_0x2a32fe['app']['id']||_0x283a69['appId']||'','name':_0x2a32fe['app']['name']||'','version':_0x2a32fe['app']['version']||'','description':_0x2a32fe['app']['description']||'','metadata':{..._0x2a32fe['metadata'],'permissions':_0x2a32fe['permissions']},'body':_0x2a32fe['body'],'query':_0x2a32fe['query'],'params':_0x2a32fe?.['params'],'method':_0x2a32fe['method'],'pathname':_0x2a32fe['pathname'],'requestUrl':_0x2a32fe['requestUrl'],'user':_0x2a32fe['user'],'headers':_0x2843b1};}var L=class{constructor(_0x2cf8e7){this['handle']=null,(this['config']=_0x2cf8e7,this['logger']=_0x2cf8e7['logger']||f,this['lifecycle']=W({'appsDir':_0x2cf8e7['appsDir'],'timeout':_0x2cf8e7['timeout'],'platformImports':_0x2cf8e7['platformImports'],'libDir':_0x2cf8e7['libDir']},{'onCreate':_0x2f7449=>this['logger']['info']('Worker\x20created',{'appId':_0x2f7449['appId']}),'onReady':_0x15c47d=>{this['lifecycle']['updateStatus'](_0x15c47d['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x15c47d['appId']});},'onCrash':_0x175ee3=>this['logger']['error']('Worker\x20crashed',{'appId':_0x175ee3['appId']}),'onStop':_0x29c63c=>this['logger']['info']('Worker\x20stopped',{'appId':_0x29c63c['appId']})}),this['messaging']=$({'onReady':_0x43b8b6=>this['lifecycle']['updateStatus'](_0x43b8b6,'running'),'onLog':(_0x1af956,_0x50c77b,_0x150160,_0x5386ac)=>{(this['logger'][_0x50c77b]||this['logger']['info'])['call'](this['logger'],_0x150160,_0x5386ac);},'onResult':()=>{}},_0x2cf8e7['timeout']||0x1d4c0));}async['create'](_0x2b5cd4){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x2dfb34=await this['lifecycle']['create'](this['config']['appId'],_0x2b5cd4,this['config']['scriptUrl']);this['messaging']['setup'](_0x2dfb34),this['messaging']['sendInit'](_0x2dfb34,this['config']['appsDir'],_0x2b5cd4,this['config']['serverPath']),this['handle']=_0x2dfb34,await this['waitForReady']();}async['waitForReady'](_0x4747ef=0x2710){let _0x562de9=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x562de9>_0x4747ef)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x18e669=>setTimeout(_0x18e669,0x64));}}async['invoke'](_0x1d36f9){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x1d36f9);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x19841d){return new L(_0x19841d);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};