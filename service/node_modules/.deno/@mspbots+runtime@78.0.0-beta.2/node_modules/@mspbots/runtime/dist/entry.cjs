'use strict';function c(_0x33f02a,_0x174027){let _0x17fd55=Object['fromEntries'](Object['entries'](_0x33f02a['headers']||{})['map'](([_0x5f430d,_0x3432d1])=>[_0x5f430d['toLowerCase'](),_0x3432d1]));return{'id':_0x33f02a['app']['id']||_0x174027['appId']||'','name':_0x33f02a['app']['name']||'','version':_0x33f02a['app']['version']||'','description':_0x33f02a['app']['description']||'','metadata':{..._0x33f02a['metadata'],'permissions':_0x33f02a['permissions']},'body':_0x33f02a['body'],'query':_0x33f02a['query'],'params':_0x33f02a?.['params'],'method':_0x33f02a['method'],'pathname':_0x33f02a['pathname'],'requestUrl':_0x33f02a['requestUrl'],'user':_0x33f02a['user'],'headers':_0x17fd55};}function f(_0x405922){return _0x405922['split']('/')['filter'](_0x4c809f=>_0x4c809f['length']>0x0);}function P(_0x30a53c,_0x1b9ade){let _0x46a0fe=f(_0x30a53c),_0x12769a=f(_0x1b9ade),_0x4fc8c7=0x0,_0x198d69=0x0;for(;_0x4fc8c7<_0x46a0fe['length']&&_0x198d69<_0x12769a['length'];){let _0xde0770=_0x46a0fe[_0x4fc8c7],_0x2987e6=_0x12769a[_0x198d69];if(_0xde0770==='*')return!![];if(_0xde0770['startsWith'](':')){_0x4fc8c7++,_0x198d69++;continue;}if(_0xde0770!==_0x2987e6)return![];_0x4fc8c7++,_0x198d69++;}return _0x4fc8c7===_0x46a0fe['length']&&_0x198d69===_0x12769a['length']||_0x4fc8c7===_0x46a0fe['length']-0x1&&_0x46a0fe[_0x4fc8c7]==='*';}function m(_0x11ce72,_0x23f72f,_0x41c057){let _0x29474e=_0x23f72f+'\x20'+_0x41c057;if(_0x11ce72[_0x29474e])return{'handler':_0x11ce72[_0x29474e],'routePattern':_0x41c057};let _0x440a4=[];_0x41c057['startsWith']('/api')?_0x440a4['push'](_0x41c057['substring'](0x4)||'/'):_0x440a4['push']('/api'+_0x41c057),_0x440a4['push'](_0x41c057);for(let _0x494822 of _0x440a4)for(let _0x572cf2 of Object['keys'](_0x11ce72)){if(!_0x572cf2['startsWith'](_0x23f72f+'\x20'))continue;let _0x5cf81c=_0x572cf2['substring'](_0x23f72f['length']+0x1);if(P(_0x5cf81c,_0x494822))return{'handler':_0x11ce72[_0x572cf2],'routePattern':_0x5cf81c};}return null;}function k(_0x212818){return typeof _0x212818=='function'?{'handler':_0x212818,'routePattern':''}:_0x212818;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x275c59){let _0x334f63=async _0x24323f=>{try{let _0x40a511=globalThis['Deno'];if(!_0x40a511)throw new Error('Deno is not available');return await _0x40a511['stat'](_0x24323f),!0x0;}catch{return![];}};if(_0x275c59&&typeof _0x275c59=='string'&&_0x275c59['length']>0x0)return _0x275c59;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x4b11c9=s['manifest']?.['metadata']?.['serverPath'];if(_0x4b11c9&&typeof _0x4b11c9=='string'&&_0x4b11c9['length']>0x0)return _0x4b11c9;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x51ca66=s['manifest']['name'];if(!_0x51ca66)throw new Error('Manifest\x20name\x20not\x20found');let _0x46c79a=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x51ca66+'/server.js',s['appsDir']+'/'+_0x51ca66+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x19c9c2 of _0x46c79a)if(await _0x334f63(_0x19c9c2))return _0x19c9c2;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x46c79a['join'](',\x20'));}function R(){let _0x1f2933=['log','info','warn','error','debug','trace'];for(let _0x32aa2e of _0x1f2933){let _0x724013=(console[_0x32aa2e]||console['log'])['bind'](console);console[_0x32aa2e]=(..._0x11e342)=>{try{let _0x110590=_0x11e342['map'](_0x1c88f7=>{if(typeof _0x1c88f7=='string')return _0x1c88f7;if(_0x1c88f7 instanceof Error)return JSON['stringify']({'name':_0x1c88f7['name'],'message':_0x1c88f7['message'],'stack':_0x1c88f7['stack']});if(typeof Request<'u'&&_0x1c88f7 instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x1c88f7['url'],'method':_0x1c88f7['method'],'headers':Object['fromEntries'](_0x1c88f7['headers']['entries']()),'bodyUsed':_0x1c88f7['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x1c88f7 instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x1c88f7['status'],'headers':Object['fromEntries'](_0x1c88f7['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x1c88f7);}catch{return String(_0x1c88f7);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x32aa2e==='log'?'info':_0x32aa2e,'message':_0x110590,'meta':{'appId':s['appId']}});}catch{_0x724013(..._0x11e342);}};}}R();async function v(_0x48b705){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x23a2a3=(await w(_0x48b705))['replace'](/\\/g,'/'),_0x1dd7e9=(_0x23a2a3['startsWith']('file://')?_0x23a2a3:'file://'+_0x23a2a3)+'?t='+Date['now']();try{let _0x31dd34=await import(_0x1dd7e9);return s['module']=_0x31dd34,_0x31dd34;}catch(_0x3003cc){throw console['error']('Failed to load module:',_0x3003cc),_0x3003cc;}}function b(_0x4766d1){return _0x4766d1 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x4766d1,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x29590d){return _0x29590d['split']('/')['filter'](_0x379d8e=>_0x379d8e['length']>0x0);}function E(_0x2fe79c){try{return decodeURIComponent(_0x2fe79c);}catch{return _0x2fe79c;}}function I(_0x3edfbe,_0x6ba223){let _0x5853c4=g(_0x3edfbe),_0x1b3b98=g(_0x6ba223),_0x43179c={},_0x10e043=0x0,_0x11e064=0x0;for(;_0x10e043<_0x5853c4['length']&&_0x11e064<_0x1b3b98['length'];){let _0x15a61a=_0x5853c4[_0x10e043],_0x60c1fb=_0x1b3b98[_0x11e064];if(_0x15a61a==='*')break;if(_0x15a61a['startsWith'](':')){let _0x173b30=_0x15a61a['slice'](0x1);_0x173b30&&(_0x43179c[_0x173b30]=E(_0x60c1fb)),_0x10e043++,_0x11e064++;continue;}if(_0x15a61a!==_0x60c1fb)return{};_0x10e043++,_0x11e064++;}return _0x10e043===_0x5853c4['length']||_0x10e043===_0x5853c4['length']-0x1&&_0x5853c4[_0x10e043]==='*',_0x43179c;}function M(_0x51f7f2,_0x947e8d){return _0x51f7f2['startsWith']('/api')&&!_0x947e8d['startsWith']('/api')?_0x51f7f2['substring'](0x4)||'/':!_0x51f7f2['startsWith']('/api')&&_0x947e8d['startsWith']('/api')?'/api'+(_0x51f7f2['startsWith']('/')?'':'/')+_0x51f7f2:_0x51f7f2;}async function W(_0x5d5f58){let _0x4b3af1=_0x5d5f58['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x4b3af1)&&await v(_0x4b3af1);let _0x245a0c=_0x5d5f58['ctx'],{method:_0x425951,pathname:_0x3e91c4}=_0x245a0c,_0x50dbf9=s['module']?.['default']||{},_0x71f9bb=m(_0x50dbf9,_0x425951,_0x3e91c4);if(!_0x71f9bb)throw Object['assign'](new Error('Route\x20'+_0x425951+'\x20'+_0x3e91c4+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x33808e=k(_0x71f9bb),_0x5a3ba0=c(_0x245a0c,s),_0x5de7c6=_0x3e91c4,_0x23280b=M(_0x33808e['routePattern'],_0x5de7c6),_0x15eb2f=_0x23280b?I(_0x23280b,_0x5de7c6):{},_0x3386e0=await _0x33808e['handler']({..._0x5a3ba0,'params':{..._0x5a3ba0['params'],..._0x15eb2f}});return b(_0x3386e0);}function D(_0x3af550){s['appId']=_0x3af550['appId'],s['manifest']=_0x3af550['manifest'],s['appsDir']=_0x3af550['appsDir'],s['serverPath']=_0x3af550['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x3dd247){let {reqId:_0x357c55,payload:_0x3d6082}=_0x3dd247;try{let _0x3846d4=await W(_0x3d6082);self['postMessage']({'type':'result','reqId':_0x357c55,'ok':!0x0,'response':_0x3846d4});}catch(_0x581a40){let _0xf0ae92=_0x581a40;self['postMessage']({'type':'result','reqId':_0x357c55,'ok':![],'error':{'message':_0xf0ae92['message'],'stack':_0xf0ae92['stack'],'code':_0xf0ae92['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x74bf65=>{let _0x4cce21=_0x74bf65['data'];try{switch(_0x4cce21['type']){case'init':D(_0x4cce21);break;case'invoke':await $(_0x4cce21);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x4cce21['type']);break;}}catch(_0x336b7c){let _0x22f11e=_0x336b7c;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x22f11e['message'],'stack':_0x22f11e['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x22f11e);}}},self['onerror']=_0x441e3a=>{let _0x2b4458={'message':typeof _0x441e3a=='string'?_0x441e3a:_0x441e3a['message'],'filename':typeof _0x441e3a=='string'?void 0x0:_0x441e3a['filename'],'lineno':typeof _0x441e3a=='string'?void 0x0:_0x441e3a['lineno'],'colno':typeof _0x441e3a=='string'?void 0x0:_0x441e3a['colno'],'error':typeof _0x441e3a=='string'?void 0x0:_0x441e3a['error']?.['message'],'stack':typeof _0x441e3a=='string'?void 0x0:_0x441e3a['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x2b4458);},self['onunhandledrejection']=_0x489e8f=>{let _0x3367d7=_0x489e8f['reason'],_0x190cc8={'appId':s['appId'],'reason':_0x3367d7 instanceof Error?_0x3367d7['message']:String(_0x3367d7),'stack':_0x3367d7 instanceof Error?_0x3367d7['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x190cc8);};