'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x121aa9){return _0x121aa9&&_0x121aa9['__esModule']?_0x121aa9:{'default':_0x121aa9};}var Y__default=_interopDefault(Y);async function ie(_0x1ba406){try{return await promises['stat'](_0x1ba406),!0x0;}catch{return![];}}var f={'error':(_0x42cf22,_0x359327)=>console['error']('[ERROR]\x20'+_0x42cf22,_0x359327),'warn':(_0xc11515,_0x10b7ee)=>console['warn']('[WARN]\x20'+_0xc11515,_0x10b7ee),'info':(_0x2b80a4,_0x4535dc)=>console['log']('[INFO]\x20'+_0x2b80a4,_0x4535dc),'debug':(_0x540013,_0xb5668b)=>console['log']('[DEBUG]\x20'+_0x540013,_0xb5668b)};function z(){let _0x9a5e36=globalThis['Deno'];if(!_0x9a5e36)throw new Error('Deno is not available');return _0x9a5e36;}var D=class{constructor(_0x16dee5,_0x34ff77='./lib',_0x53cf9d={}){this['manifest']=_0x16dee5,this['libDir']=_0x34ff77,this['platformImports']=_0x53cf9d;}['buildPerms'](){let _0x9ac14d=this['manifest']['permissions']||{},_0x2e18fd={};return _0x9ac14d['net']!==void 0x0&&(_0x2e18fd['net']=_0x9ac14d['net']===!![]?!![]:Array['isArray'](_0x9ac14d['net'])?_0x9ac14d['net']:[]),_0x9ac14d['read']!==void 0x0&&(_0x2e18fd['read']=_0x9ac14d['read']===!![]?!![]:Array['isArray'](_0x9ac14d['read'])?_0x9ac14d['read']:[]),_0x9ac14d['write']!==void 0x0&&(_0x2e18fd['write']=_0x9ac14d['write']===!![]?!![]:Array['isArray'](_0x9ac14d['write'])?_0x9ac14d['write']:[]),_0x9ac14d['env']!==void 0x0&&(_0x2e18fd['env']=_0x9ac14d['env']===!![]?!![]:Array['isArray'](_0x9ac14d['env'])?_0x9ac14d['env']:[]),_0x9ac14d['run']!==void 0x0&&(_0x2e18fd['run']=_0x9ac14d['run']===!![]?!![]:Array['isArray'](_0x9ac14d['run'])?_0x9ac14d['run']:[]),_0x9ac14d['ffi']!==void 0x0&&(_0x2e18fd['ffi']=_0x9ac14d['ffi']===!![]?!![]:Array['isArray'](_0x9ac14d['ffi'])?_0x9ac14d['ffi']:[]),_0x9ac14d['sys']!==void 0x0&&(_0x2e18fd['sys']=_0x9ac14d['sys']===!![]?!![]:Array['isArray'](_0x9ac14d['sys'])?_0x9ac14d['sys']:[]),_0x9ac14d['hrtime']!==void 0x0&&(_0x2e18fd['hrtime']=_0x9ac14d['hrtime']),_0x2e18fd;}['normalize'](_0x4d93da){return _0x4d93da===!![]?[]:Array['isArray'](_0x4d93da)?_0x4d93da:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x380d59){return path.join(this['libDir'],_0x380d59+'@*');}['getReadPaths'](){let _0x57b9ad=this['getImports']();_0x57b9ad['includes']('*')&&(_0x57b9ad=Object['keys'](this['platformImports']));let _0x37e5f6=[];console['log']('[Permissions] Building package path patterns for imports:',_0x57b9ad);for(let _0xe985cf of _0x57b9ad){let _0xaab249=this['getLibPattern'](_0xe985cf);_0x37e5f6['push'](_0xaab249),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0xe985cf+'\x20->\x20'+_0xaab249);}return console['log']('[Permissions] Final package path patterns:',_0x37e5f6),_0x37e5f6;}['buildImportMap'](_0xedbfbf){let _0x45168b=this['getImports'](),_0x36abbd=_0x45168b['includes']('*')?Object['keys'](_0xedbfbf):_0x45168b;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x36abbd);let _0xd3b008={};for(let _0xd5916 of _0x36abbd)if(_0xedbfbf[_0xd5916])_0xd3b008[_0xd5916]=_0xedbfbf[_0xd5916],console['log']('[ImportMap]\x20'+_0xd5916+'\x20->\x20'+_0xedbfbf[_0xd5916]+'\x20(from\x20platform)');else try{let _0xb2e605=z(),_0x16bb86=path.join(_0xb2e605['cwd'](),this['libDir']),_0x4fba64=!0x1;try{for(let _0x1fcd1b of _0xb2e605['readDirSync'](_0x16bb86))if(_0x1fcd1b['isDirectory']&&(_0x1fcd1b['name']===_0xd5916||_0x1fcd1b['name']['startsWith'](_0xd5916+'@'))){let _0x1acafd=path.join(_0xb2e605['cwd'](),this['libDir'],_0x1fcd1b['name'],'index.js')['replace'](/\\/g,'/'),_0x58137b=new URL('file:///'+_0x1acafd)['href'];_0xd3b008[_0xd5916]=_0x58137b,console['log']('[ImportMap]\x20'+_0xd5916+'\x20->\x20'+_0x58137b+'\x20(from\x20lib)'),_0x4fba64=!0x0;break;}}catch{}_0x4fba64||console['warn']('[ImportMap]\x20Package\x20'+_0xd5916+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0xb1c5be){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0xd5916+':',_0xb1c5be);}return _0xd3b008;}['validateServerImports'](_0x346ade){let _0x3db463=this['manifest']['name']||this['manifest']['id'],_0x24b9f4=this['manifest']['metadata']?.['serverPath'],_0x43801f=_0x364ab9=>_0x364ab9['replace'](/\\/g,'/'),_0x44fcbb=z(),_0x167405=_0x330faf=>{try{return _0x44fcbb['statSync'](_0x330faf),!0x0;}catch{return![];}},_0x1df847=_0x24b9f4?_0x43801f(_0x24b9f4):void 0x0;if(!_0x1df847){let _0x387a11=[_0x346ade+'/service/server.js',_0x346ade+'/service/server.ts',_0x346ade+'/'+_0x3db463+'/server.js',_0x346ade+'/'+_0x3db463+'/server.ts',_0x346ade+'/server.js',_0x346ade+'/server.ts']['map'](_0x43801f);for(let _0x8b779d of _0x387a11)if(_0x167405(_0x8b779d)){_0x1df847=_0x8b779d;break;}}if(!_0x1df847)return{'valid':![],'violations':['Failed to locate server module']};let _0x17e7e5='';try{_0x17e7e5=_0x44fcbb['readTextFileSync'](_0x1df847);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x1df847};}let _0x105a57=this['getImports']();if(_0x105a57['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x1df847};let _0x586237=_0x105a57,_0xaf6dc1=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x35f067=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x2796fe=/\bimport\s*['"]([^'"]+)['"]/g,_0x1a6efa=[],_0x34cd2b=new Set(),_0x279411=_0xe33ed=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0xe33ed),_0x15c911=_0x4d657e=>{let _0x251635=_0x4d657e;if(_0x251635['startsWith']('./')||_0x251635['startsWith']('../')||_0x251635['startsWith']('/')||_0x251635['startsWith']('file://')||!_0x279411(_0x4d657e)||_0x34cd2b['has'](_0x4d657e))return;_0x34cd2b['add'](_0x4d657e),_0x251635['startsWith']('npm:')&&(_0x251635=_0x251635['substring'](0x4)),_0x251635['includes']('@')&&!_0x251635['startsWith']('@')&&(_0x251635=_0x251635['split']('@')[0x0]);let _0x1053cc=_0x251635['split']('/')[0x0];_0x586237['includes'](_0x1053cc)||_0x586237['includes'](_0x4d657e)||_0x1a6efa['push'](_0x4d657e);},_0x48b0b9;for(;(_0x48b0b9=_0xaf6dc1['exec'](_0x17e7e5))!==null;)_0x15c911(_0x48b0b9[0x1]);for(;(_0x48b0b9=_0x35f067['exec'](_0x17e7e5))!==null;)_0x15c911(_0x48b0b9[0x1]);for(;(_0x48b0b9=_0x2796fe['exec'](_0x17e7e5))!==null;)_0x15c911(_0x48b0b9[0x1]);return{'valid':_0x1a6efa['length']===0x0,'violations':_0x1a6efa,'serverPath':_0x1df847};}['validate'](_0x2b620c={}){let _0x1308da=[],_0x3d792f=this['manifest']['permissions']||{};try{let _0x5f29c0=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x5f29c0);}catch{}let _0x2458d7=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x41e12f,_0x114128]of Object['entries'](_0x3d792f))if(_0x41e12f==='hrtime')typeof _0x114128!='boolean'&&_0x1308da['push']('Permission\x20\x27'+_0x41e12f+'\x27\x20must\x20be\x20boolean');else{if(_0x41e12f==='langchain')typeof _0x114128!='boolean'&&(typeof _0x114128!='object'||_0x114128===null)?_0x1308da['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x114128=='object'&&(_0x114128===null||!('enabled'in _0x114128)||typeof _0x114128['enabled']!='boolean')&&_0x1308da['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x41e12f==='kv')typeof _0x114128!='boolean'&&_0x1308da['push']('Permission\x20\x27'+_0x41e12f+'\x27\x20must\x20be\x20boolean');else{if(_0x41e12f==='mspbots')Array['isArray'](_0x114128)||_0x1308da['push']('Permission\x20\x27'+_0x41e12f+'\x27\x20must\x20be\x20an\x20array');else{if(_0x41e12f==='db'){if(typeof _0x114128!='object'||_0x114128===null||Array['isArray'](_0x114128))_0x1308da['push']('Permission\x20\x27'+_0x41e12f+'\x27\x20must\x20be\x20an\x20object');else{let _0x41450d=_0x114128,_0x6d7460=['user','password']['filter'](_0x3a732c=>!(_0x3a732c in _0x41450d));_0x6d7460['length']>0x0&&_0x1308da['push']('Permission\x20\x27'+_0x41e12f+'\x27\x20missing\x20required\x20fields:\x20'+_0x6d7460['join'](',\x20'));}}else{if(_0x41e12f==='imports')continue;_0x2458d7['has'](_0x41e12f)||typeof _0x114128!='boolean'&&!Array['isArray'](_0x114128)&&_0x1308da['push']('Permission\x20\x27'+_0x41e12f+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x255510=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x255510))_0x1308da['push']('permissions.imports must be an array');else{for(let _0x5cd793 of _0x255510)typeof _0x5cd793!='string'&&_0x1308da['push']('import\x20\x27'+_0x5cd793+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x1308da['length']===0x0,'errors':_0x1308da};}};function q(_0x3614ab,_0x5d6104,_0xb115b2){return new D(_0x3614ab,_0x5d6104,_0xb115b2||{});}var R=null;function I(){let _0x18d1d2=globalThis['Deno'];if(!_0x18d1d2)throw new Error('Deno is not available');return _0x18d1d2;}async function K(){if(R)return{...R};try{let _0x2e6088=I(),_0x55ef39=path.join(_0x2e6088['cwd'](),'deno.json'),_0x299f65=await _0x2e6088['readTextFile'](_0x55ef39);return R=JSON['parse'](_0x299f65)['imports']||{},{...R};}catch(_0x776919){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x776919),{};}}var E=class{constructor(_0x2b40a6,_0x47bb5b={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x2b40a6['appsDir'],this['platformImportsOverride']=_0x2b40a6['platformImports'],this['libDir']=_0x2b40a6['libDir'],this['events']=_0x47bb5b);}async['create'](_0x1516f9,_0x3a8ca0,_0x449b84){try{return await this['createWorker'](_0x1516f9,_0x3a8ca0,_0x449b84);}catch(_0x3990db){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x1516f9+':',_0x3990db),_0x3990db;}}async['createWorker'](_0x49b361,_0x1c5d5d,_0x30d69c){let _0x328bd9=this['platformImportsOverride']||await K(),_0x24cca0=q(_0x1c5d5d,this['libDir'],_0x328bd9)['validateServerImports'](this['appsDir']);if(!_0x24cca0['valid']){let _0x5a548d=_0x24cca0['violations']['filter'](_0x1bc354=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x1bc354)),_0x2d2d60=_0x24cca0['serverPath']?_0x24cca0['serverPath']:(_0x1c5d5d['name']||_0x1c5d5d['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x2d2d60+':\x20'+_0x5a548d['join'](',\x20'));}let _0x1c8890=q(_0x1c5d5d,this['libDir'],_0x328bd9),_0x3d8bbb=_0x1c8890['validate'](_0x328bd9);if(!_0x3d8bbb['valid'])throw new Error('Invalid\x20config:\x20'+_0x3d8bbb['errors']['join'](',\x20'));let _0x5ceee1=_0x1c8890['buildImportMap'](_0x328bd9);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x49b361+':',_0x5ceee1);let _0x15ad02=_0x1c8890['buildPerms'](),_0x131cc2=_0x1c8890['getReadPaths']();if(_0x15ad02['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x15ad02['read']);else{let _0x4538a1=_0x1c5d5d['name']||_0x49b361,_0x3b957f=this['appsDir']+'/'+_0x4538a1,_0x55f91a=[_0x3b957f],_0x513304=_0x1c5d5d['metadata']?.['serverPath'];if(_0x513304&&typeof _0x513304=='string')try{let _0x4de108=path.dirname(_0x513304)['replace'](/\\/g,'/');_0x55f91a['push'](_0x4de108);}catch{}_0x15ad02['read']=_0x55f91a,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x3b957f);}if(_0x131cc2['length']>0x0){if(_0x15ad02['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x11a9e1=Array['isArray'](_0x15ad02['read'])?_0x15ad02['read']:[];_0x15ad02['read']=[..._0x11a9e1,..._0x131cc2],console['log']('[Worker] Added package read permissions:',_0x131cc2);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x15ad02['net']||(_0x15ad02['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x49b361+':',_0x15ad02['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x15ad02['read']===!![]?'unrestricted':Array['isArray'](_0x15ad02['read'])?_0x15ad02['read']['length']:0x0));let _0x54c3c7=await this['createImportMap'](_0x49b361,_0x5ceee1),_0x273d7a=await this['createLock'](_0x49b361,_0x5ceee1),_0x4a8784={'type':'module','deno':{'permissions':{}}};_0x4a8784['deno']['namespace']=![],_0x4a8784['deno']['permissions']=_0x15ad02,_0x4a8784['deno']['importMap']=_0x54c3c7,_0x4a8784['deno']['lock']=_0x273d7a,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x49b361+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x54c3c7),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x273d7a),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x5ceee1)['length']+'\x20('+(Object['keys'](_0x5ceee1)['join'](',\x20')||'none')+')');let _0x2a979f={'worker':new Worker(_0x30d69c,_0x4a8784),'appId':_0x49b361,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x1c5d5d,'importMapPath':_0x54c3c7,'lockfilePath':_0x273d7a};return this['workers']['set'](_0x49b361,_0x2a979f),this['events']['onCreate']?.(_0x2a979f),_0x2a979f;}async['createLock'](_0x1a12f5,_0x318272){let _0x5f4232=I(),_0x46cd0b=path.join(_0x5f4232['cwd'](),'storage','temp','lockfiles');await _0x5f4232['mkdir'](_0x46cd0b,{'recursive':!![]});let _0xd52bd6=_0x1a12f5+'-'+Date['now']()+'.lock',_0x163bcc=path.join(_0x46cd0b,_0xd52bd6),_0x382cdc={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x47ad92,_0x43f8cf]of Object['entries'](_0x318272))if(_0x43f8cf['startsWith']('npm:'))_0x43f8cf['replace']('npm:',''),_0x382cdc['packages']['specifiers'][_0x47ad92]=_0x43f8cf;else _0x43f8cf['startsWith']('file://')&&(_0x382cdc['packages']['specifiers'][_0x47ad92]=_0x43f8cf);let _0x58becd=JSON['stringify'](_0x382cdc,null,0x2);return await _0x5f4232['writeTextFile'](_0x163bcc,_0x58becd),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x163bcc),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x318272)['length']+'):',Object['keys'](_0x318272)),_0x163bcc;}async['createImportMap'](_0x32ae1c,_0x3224e8){let _0x2416ba=I(),_0x548e20=path.join(_0x2416ba['cwd'](),'storage','temp','importmaps');await _0x2416ba['mkdir'](_0x548e20,{'recursive':!![]});let _0x4c4d67=_0x32ae1c+'-'+Date['now']()+'.json',_0x4c8a0e=path.join(_0x548e20,_0x4c4d67),_0x500a66=JSON['stringify']({'imports':_0x3224e8,'scopes':{}},null,0x2);return await _0x2416ba['writeTextFile'](_0x4c8a0e,_0x500a66),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x4c8a0e),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x3224e8)['length']+'):',Object['keys'](_0x3224e8)['join'](',\x20')||'none'),_0x4c8a0e;}['get'](_0x315000){return this['workers']['get'](_0x315000);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x25ee35,_0x362dcc){let _0x7cba9f=this['workers']['get'](_0x25ee35);if(!_0x7cba9f)return;let _0x440a25=_0x7cba9f['status'];_0x7cba9f['status']=_0x362dcc,_0x362dcc==='running'&&_0x440a25==='starting'?this['events']['onReady']?.(_0x7cba9f):_0x362dcc==='crashed'&&this['events']['onCrash']?.(_0x7cba9f);}['touch'](_0x1780d6){let _0x237e77=this['workers']['get'](_0x1780d6);_0x237e77&&(_0x237e77['lastUsed']=Date['now']());}async['stop'](_0x5f1081){let _0x36ab8f=this['workers']['get'](_0x5f1081);if(_0x36ab8f)try{_0x36ab8f['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x36ab8f['worker']['terminate'](),_0x36ab8f['status']='stopped',this['events']['onStop']?.(_0x36ab8f),_0x36ab8f['importMapPath']&&await this['cleanupImportMap'](_0x36ab8f['importMapPath']),_0x36ab8f['lockfilePath']&&await this['cleanupLock'](_0x36ab8f['lockfilePath']);}catch(_0x40d23e){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x5f1081+':',_0x40d23e);}finally{this['workers']['delete'](_0x5f1081);}}async['cleanupImportMap'](_0x40f562){try{await I()['remove'](_0x40f562),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x40f562);}catch(_0x52ac8d){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x40f562,_0x52ac8d);}}async['cleanupLock'](_0x129051){try{await I()['remove'](_0x129051),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x129051);}catch(_0x38a6a9){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x129051,_0x38a6a9);}}async['stopAll'](){let _0x5457f9=Array['from'](this['workers']['keys']());await Promise['all'](_0x5457f9['map'](_0x31543f=>this['stop'](_0x31543f)));}async['restart'](_0x4dbefc,_0x242171){let _0xe0d93c=this['workers']['get'](_0x4dbefc);if(!_0xe0d93c)throw new Error('Worker\x20'+_0x4dbefc+'\x20not\x20found');let _0x300250=_0xe0d93c['manifest'];return await this['stop'](_0x4dbefc),await this['create'](_0x4dbefc,_0x300250,_0x242171);}['checkHealth'](_0x4a1ad5){let _0x4ff87f=this['workers']['get'](_0x4a1ad5);if(!_0x4ff87f)return{'healthy':![],'reason':'Not\x20found'};if(_0x4ff87f['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x4ff87f['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x3e3f48=Date['now']()-_0x4ff87f['lastUsed'],_0x508335=0x708*0x3e8;return _0x3e3f48>_0x508335?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x3e3f48/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x48b617=0x708*0x3e8,_0x126f36){let _0x2c13dd=Date['now'](),_0x44c416=[];for(let [_0x34e411,_0x3c9068]of this['workers']['entries']()){let _0x432e63=_0x2c13dd-_0x3c9068['lastUsed'];_0x432e63>_0x48b617&&_0x44c416['push']({'appId':_0x34e411,'idle':_0x432e63});}_0x44c416['sort']((_0x5a84f5,_0x181bec)=>_0x181bec['idle']-_0x5a84f5['idle']);let _0x6435f=_0x126f36?_0x44c416['slice'](0x0,_0x126f36)['map'](_0x2e00b7=>_0x2e00b7['appId']):_0x44c416['map'](_0x560e61=>_0x560e61['appId']);for(let _0x22aa97 of _0x6435f)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x22aa97),await this['stop'](_0x22aa97);}['stats'](){let _0x12191f={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x5396e8=Date['now']();for(let _0x4eec86 of this['workers']['values']())_0x12191f['byStatus'][_0x4eec86['status']]++,_0x12191f['workers']['push']({'appId':_0x4eec86['appId'],'status':_0x4eec86['status'],'version':_0x4eec86['version'],'lastUsed':_0x4eec86['lastUsed'],'idle':_0x5396e8-_0x4eec86['lastUsed']});return _0x12191f;}['startCleanup'](_0x18e66d=0x12c*0x3e8,_0x4cfbf8){let _0x38d7d9=setInterval(()=>{this['cleanup'](_0x4cfbf8)['catch'](_0xd8f17e=>{console['error']('Cleanup\x20failed:',_0xd8f17e);});},_0x18e66d);return()=>clearInterval(_0x38d7d9);}['delay'](_0x182ae0){return new Promise(_0x19b247=>setTimeout(_0x19b247,_0x182ae0));}};function W(_0x46fdae,_0x36988b){return new E(_0x46fdae,_0x36988b);}var v=f,j=class{constructor(_0x1cc74d,_0x38742e=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x1cc74d,this['timeout']=_0x38742e);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x38050a){_0x38050a['worker']['onmessage']=_0x58e3c7=>{let _0x1b7aa1=_0x58e3c7['data'],{appId:_0x27ff3a}=_0x38050a;switch(_0x1b7aa1['type']){case'ready':this['events']['onReady'](_0x27ff3a),v['info']('Worker\x20ready',{'appId':_0x27ff3a,'version':_0x38050a['version']});break;case'log':{let {level:_0x2126ee='info',message:_0x3ba0c8,meta:_0x4a70b9}=_0x1b7aa1,_0x507c27={..._0x4a70b9||{},'appId':_0x27ff3a,'version':_0x38050a['version']};this['events']['onLog'](_0x27ff3a,_0x2126ee,_0x3ba0c8,_0x507c27);break;}case'result':{let {reqId:_0x2f5872,ok:_0x4e6067,response:_0xa2258,error:_0x1cff07}=_0x1b7aa1,_0x3dd319=this['pending']['get'](_0x2f5872);if(!_0x3dd319){v['warn']('Unknown\x20request',{'appId':_0x27ff3a,'reqId':_0x2f5872});return;}if(this['pending']['delete'](_0x2f5872),_0x4e6067&&_0xa2258)_0x3dd319['resolve'](_0xa2258);else{let _0x53085b=new Error(_0x1cff07?.['message']||'Worker\x20error');_0x53085b['stack']=_0x1cff07?.['stack'],_0x3dd319['reject'](_0x53085b);}this['events']['onResult'](_0x27ff3a,_0x2f5872,_0xa2258||_0x1cff07);break;}default:v['debug']('Unknown\x20message',{'appId':_0x27ff3a,'type':_0x1b7aa1['type']});}},_0x38050a['worker']['onerror']=_0xdf6d1e=>{let {appId:_0x58f0a1}=_0x38050a;v['error']('Worker\x20error',{'appId':_0x58f0a1,'message':_0xdf6d1e['message'],'lineno':_0xdf6d1e['lineno'],'filename':_0xdf6d1e['filename']}),_0x38050a['status']='crashed',this['rejectPending'](_0x58f0a1,new Error('Worker\x20'+_0x58f0a1+'\x20crashed:\x20'+_0xdf6d1e['message'])),_0xdf6d1e['preventDefault']();},_0x38050a['worker']['onmessageerror']=_0x36dbfa=>{let {appId:_0x1c362c}=_0x38050a;v['error']('Message\x20error',{'appId':_0x1c362c,'data':_0x36dbfa['data']}),_0x38050a['status']='crashed',_0x36dbfa['preventDefault']();};}['sendInit'](_0x695707,_0x4694a1,_0x5411c3,_0x56855f){_0x695707['worker']['postMessage']({'type':'init','appId':_0x695707['appId'],'manifest':_0x5411c3,'appsDir':_0x4694a1,'serverPath':_0x56855f});}async['sendInvoke'](_0x473092,_0x198594){let _0x3c2c35=this['nextId'](),_0x373a62=_0x473092['appId'],_0xaf2173=new Promise((_0x51bbf3,_0x971286)=>{let _0x5e6848=setTimeout(()=>{this['pending']['delete'](_0x3c2c35),_0x971286(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x3c2c35,{'resolve':_0x1d4aee=>{clearTimeout(_0x5e6848),_0x51bbf3(_0x1d4aee);},'reject':_0x1abb50=>{clearTimeout(_0x5e6848),_0x971286(_0x1abb50);},'timestamp':Date['now'](),'appId':_0x373a62});});return _0x473092['worker']['postMessage']({'type':'invoke','appId':_0x473092['appId'],'reqId':_0x3c2c35,'payload':_0x198594}),await _0xaf2173;}['rejectPending'](_0x4288e3,_0x234718){let _0x4887c2=0x0;for(let [_0x2d3f8c,_0x25d537]of this['pending']['entries']())_0x25d537['appId']===_0x4288e3&&(this['pending']['delete'](_0x2d3f8c),_0x25d537['reject'](_0x234718),_0x4887c2++);_0x4887c2>0x0&&v['warn']('Rejected\x20'+_0x4887c2+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x4288e3});}['cleanupTimeout'](){let _0x3c0da2=Date['now']();for(let [_0x25e683,_0x3b865d]of this['pending']['entries']())_0x3c0da2-_0x3b865d['timestamp']>this['timeout']&&(this['pending']['delete'](_0x25e683),_0x3b865d['reject'](new Error('Request\x20'+_0x25e683+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x17d91c){let _0x5e1549=0x0;for(let _0x3458f0 of this['pending']['values']())_0x3458f0['appId']===_0x17d91c&&_0x5e1549++;return _0x5e1549;}['startCleanup'](_0x4e73f2=0x2710){let _0x57e70e=setInterval(()=>{this['cleanupTimeout']();},_0x4e73f2);return()=>clearInterval(_0x57e70e);}};function $(_0xd63a8d,_0x23dfa1){return new j(_0xd63a8d,_0x23dfa1);}var Q=class{constructor(_0x515b5e={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x515b5e['logger']||f,this['config']={'appsDir':_0x515b5e['appsDir']||this['getAppsDir'](),'scriptUrl':_0x515b5e['scriptUrl']||this['getScriptUrl'](),'timeout':_0x515b5e['timeout']||0x78*0x3e8,'autoCleanup':_0x515b5e['autoCleanup']??!![],'cleanupInterval':_0x515b5e['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x515b5e['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x515b5e['maxWorkers'],'reuseWorkers':_0x515b5e['reuseWorkers']??!![],'workerReuseStrategy':_0x515b5e['workerReuseStrategy']||'lru','enableQueue':_0x515b5e['enableQueue']??!![],'maxQueueSize':_0x515b5e['maxQueueSize']||0x64,'queueTimeout':_0x515b5e['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x46eedc=>this['logger']['info']('Worker\x20created',{'appId':_0x46eedc['appId'],'v':_0x46eedc['version']}),'onReady':_0x5469eb=>this['lifecycle']['updateStatus'](_0x5469eb['appId'],'running'),'onCrash':_0x5255ac=>this['logger']['error']('Worker\x20crashed',{'appId':_0x5255ac['appId'],'v':_0x5255ac['version']}),'onStop':_0x5877c5=>this['logger']['info']('Worker\x20stopped',{'appId':_0x5877c5['appId'],'v':_0x5877c5['version']})}),this['messaging']=$({'onReady':_0x223b68=>this['lifecycle']['updateStatus'](_0x223b68,'running'),'onLog':(_0x3d1cdd,_0x2455f0,_0x80cba7,_0x2451a6)=>{let _0x23062b={..._0x2451a6||{},'appId':_0x3d1cdd};switch(_0x2455f0){case'error':this['logger']['error'](_0x80cba7,_0x23062b);break;case'warn':this['logger']['warn'](_0x80cba7,_0x23062b);break;case'debug':this['logger']['debug'](_0x80cba7,_0x23062b);break;default:this['logger']['info'](_0x80cba7,_0x23062b);break;}},'onResult':(_0x54c4af,_0x2ba1cf,_0x64be67)=>{this['logger']['debug']('Result\x20received',{'appId':_0x54c4af,'reqId':_0x2ba1cf});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x53f8ed=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x508253=_0x53f8ed['endsWith']('.js')||_0x53f8ed['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x508253,_0x53f8ed)['href'];}async['ensure'](_0xa7ad89){let {id:_0x392f75}=_0xa7ad89,_0x159559=this['lifecycle']['get'](_0x392f75);if(_0x159559){let _0x1ae1b1=this['lifecycle']['checkHealth'](_0x392f75);if(_0x1ae1b1['healthy'])return this['lifecycle']['touch'](_0x392f75),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x392f75}),_0x159559;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x392f75,'reason':_0x1ae1b1['reason']}),await this['lifecycle']['stop'](_0x392f75);}for(;;){let _0x50360e=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x50360e>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x50360e,'max':this['config']['maxWorkers'],'appId':_0x392f75}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0xa7ad89);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x2e5a91=await this['loadManifest'](_0x392f75,_0xa7ad89['manifest']),_0x5031b6=await this['lifecycle']['create'](_0x392f75,_0x2e5a91,this['config']['scriptUrl']),_0x2339a0=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x2339a0>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x2339a0,'max':this['config']['maxWorkers'],'appId':_0x392f75}),await this['lifecycle']['stop'](_0x392f75),this['config']['enableQueue'])return await this['waitSlot'](_0xa7ad89);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x2339a0+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x5031b6);let _0xf38532=_0x2e5a91['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x5031b6,this['config']['appsDir'],_0x2e5a91,_0xf38532),this['logger']['info']('Worker\x20created',{'appId':_0x392f75,'v':_0x5031b6['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x5031b6;}async['evictIdle'](){let _0x3ace3f=this['lifecycle']['getAll']();if(_0x3ace3f['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x5058a6=[..._0x3ace3f];this['config']['workerReuseStrategy']==='lru'?_0x5058a6['sort']((_0x81148c,_0x3750f6)=>_0x81148c['lastUsed']-_0x3750f6['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x5058a6['sort']((_0xd52096,_0x445172)=>_0xd52096['version']-_0x445172['version']);let _0x110017=null;for(let _0x3f9d18 of _0x5058a6)if(this['messaging']['getAppCount'](_0x3f9d18['appId'])===0x0){_0x110017=_0x3f9d18;break;}if(!_0x110017&&_0x5058a6['length']>0x0&&(_0x110017=_0x5058a6['reduce']((_0x3b0b13,_0x111a98)=>{let _0x4e2bce=this['messaging']['getAppCount'](_0x3b0b13['appId']);return this['messaging']['getAppCount'](_0x111a98['appId'])<_0x4e2bce?_0x111a98:_0x3b0b13;})),_0x110017){let _0xbe91a5=this['messaging']['getAppCount'](_0x110017['appId']);return _0xbe91a5>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x110017['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x110017['lastUsed'],'pendingRequests':_0xbe91a5}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x110017['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x110017['lastUsed']}),await this['lifecycle']['stop'](_0x110017['appId']),!![];}return![];}['waitSlot'](_0x4ce1b3){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x3dbd1f,_0x1f0ee1)=>{let _0x4f258e={'info':_0x4ce1b3,'resolve':_0x3dbd1f,'reject':_0x1f0ee1,'timestamp':Date['now']()};this['requestQueue']['push'](_0x4f258e),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x4ce1b3['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x751287=setTimeout(()=>{let _0x28e8cf=this['requestQueue']['indexOf'](_0x4f258e);_0x28e8cf!==-0x1&&(this['requestQueue']['splice'](_0x28e8cf,0x1),_0x1f0ee1(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x4f258e['resolve']=_0x2387b7=>{clearTimeout(_0x751287),_0x3dbd1f(_0x2387b7);},_0x4f258e['reject']=_0x5adf89=>{clearTimeout(_0x751287),_0x1f0ee1(_0x5adf89);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x1a8f0e=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x1a8f0e>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x1074de=this['requestQueue']['shift']();if(!_0x1074de)break;try{let _0x53f7c2=await this['ensure'](_0x1074de['info']);_0x1074de['resolve'](_0x53f7c2);}catch(_0xd6cb74){_0x1074de['reject'](_0xd6cb74);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x254a61,_0x522b1b){let _0x50e948=this['config']['appsDir']['replace'](/\\/g,'/'),_0x42dc97=async _0x14db23=>{try{let _0x36b924=globalThis['Deno'];if(!_0x36b924)return null;let _0x3a37b9=await _0x36b924['readTextFile'](_0x14db23);return JSON['parse'](_0x3a37b9);}catch{return null;}};if(_0x522b1b?.['name']){let _0x4ef3a7=await _0x42dc97(_0x50e948+'/'+_0x522b1b['name']+'/manifest.json');if(_0x4ef3a7)return _0x4ef3a7;}let _0x4f3a74=await _0x42dc97(_0x50e948+'/'+_0x254a61+'/manifest.json');if(_0x4f3a74)return _0x4f3a74;try{let _0x4b1aa7=globalThis['Deno'];if(_0x4b1aa7)for await(let _0x10295f of _0x4b1aa7['readDir'](_0x50e948)){if(!_0x10295f['isDirectory'])continue;let _0x13a730=_0x50e948+'/'+_0x10295f['name']+'/manifest.json',_0x56d42e=await _0x42dc97(_0x13a730);if(_0x56d42e&&(_0x56d42e['id']===_0x254a61||_0x522b1b?.['name']&&_0x56d42e['name']===_0x522b1b['name']))return _0x56d42e;}}catch(_0x1a30ce){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x254a61,'error':_0x1a30ce['message']});}return _0x522b1b||{'id':_0x254a61,'name':_0x254a61,'version':'1.0.0'};}async['invoke'](_0x20b282){let _0x49546a=_0x20b282['ctx']['app']['id'],_0x5ad542=_0x20b282['ctx']['app']['name'];try{let _0x4103ce={'id':_0x49546a,'manifest':{'id':_0x49546a,'name':_0x5ad542}},_0x287b7d=await this['ensure'](_0x4103ce);if(_0x287b7d['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x49546a}),await this['restart'](_0x49546a);let _0x45b9f9=await this['ensure'](_0x4103ce);return this['lifecycle']['touch'](_0x49546a),await this['messaging']['sendInvoke'](_0x45b9f9,_0x20b282);}return this['lifecycle']['touch'](_0x49546a),await this['messaging']['sendInvoke'](_0x287b7d,_0x20b282);}catch(_0x4f30e5){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x49546a,'error':_0x4f30e5['message'],'stack':_0x4f30e5['stack']}),_0x4f30e5;}}async['stop'](_0x2c9046){await this['lifecycle']['stop'](_0x2c9046),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x41fcd3){return await this['lifecycle']['restart'](_0x41fcd3,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x28a9e0=>({'appId':_0x28a9e0['appId'],'status':_0x28a9e0['status'],'version':_0x28a9e0['version'],'lastUsed':_0x28a9e0['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x48bbea=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x478f24=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x48bbea(),_0x478f24();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x2693d4=>{_0x2693d4?(await this['stop'](_0x2693d4),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x2693d4})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x3c4585){return new Q(_0x3c4585);}var S=null;function be(_0x902c19){S=ee(_0x902c19);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x66f99d){return await k()['ensure'](_0x66f99d);}async function xe(_0x43d243){return await k()['invoke'](_0x43d243);}function Ie(_0x57caaa){k()['stop'](_0x57caaa)['catch'](_0x4b6e73=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x57caaa,'error':_0x4b6e73['message']});});}function Re(){k()['stopAll']()['catch'](_0x3a0cc2=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x3a0cc2['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x5f9205){await k()['stop'](_0x5f9205);}async function Se(){await k()['stopAll']();}function Ae(_0x2cdde4){let _0x4fb364=_0x2cdde4&&typeof _0x2cdde4=='object'?_0x2cdde4:null;if(_0x4fb364&&'user'in _0x4fb364)return _0x4fb364['user'];}function H(_0x9de864){let _0x363e48=_0x9de864&&typeof _0x9de864=='object'?_0x9de864:null;if(!_0x363e48)return{};let _0x35683b={};for(let [_0x4c8143,_0x1a17cb]of Object['entries'](_0x363e48))_0x4c8143!=='user'&&(_0x35683b[_0x4c8143]=_0x1a17cb);return _0x35683b;}function O(_0x36d526){return _0x36d526?{'id':_0x36d526['manifest']?.['id']||_0x36d526['id']||'','name':_0x36d526['manifest']?.['name']||'','version':_0x36d526['manifest']?.['version']||'','description':_0x36d526['manifest']?.['description']||'','icon':_0x36d526['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x471bb9){return _0x471bb9?.['permissions']||_0x471bb9?.['manifest']?.['permissions']||{};}function F(_0x581517){return _0x581517?.['manifest']?.['metadata']||{};}function Ce(_0x5ac619){return _0x5ac619?{'appId':_0x5ac619['id'],'appName':_0x5ac619['manifest']?.['name']}:{};}function N(_0x88f620,_0x76ca57={}){let {appInfo:_0x480968=null,status:_0xbccfdc=0x1f4,defaultMessage:_0x5ae4f0='Internal\x20Server\x20Error'}=_0x76ca57,_0x20fc63={'error':_0x5ae4f0,'message':_0x88f620?.['message']||_0x5ae4f0};return _0x480968&&(_0x20fc63['appId']=_0x480968['id'],_0x20fc63['appName']=_0x480968['manifest']?.['name']),_0x88f620?.['message']?.['includes']('crashed')&&(_0x20fc63['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0xbccfdc,'body':_0x20fc63};}function qe(_0x50bbdd){return _0x50bbdd?.['message']?.['includes']('crashed')||![];}function J(_0x2b64bf){if(_0x2b64bf)try{return JSON['parse'](_0x2b64bf);}catch{return _0x2b64bf;}}function B(_0x8e115e){try{let _0x4a14e0=new URL(_0x8e115e),_0x4a4606={};for(let _0x1359f8 of _0x4a14e0['searchParams']['keys']()){let _0x3912c5=_0x4a14e0['searchParams']['getAll'](_0x1359f8)['map'](_0x3cad9f=>_0x3cad9f);_0x3912c5['length']<=0x1?_0x4a4606[_0x1359f8]=_0x3912c5[0x0]??'':_0x4a4606[_0x1359f8]=_0x3912c5;}return _0x4a4606;}catch{return{};}}function Le(_0x67001){return(()=>{try{return new URL(_0x67001)['pathname'];}catch{return _0x67001;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x10c649,_0x2ac95e){let _0x305a38=_0x10c649;if(_0x2ac95e&&_0x305a38['startsWith']('/apps/'+_0x2ac95e))_0x305a38=_0x305a38['substring'](('/apps/'+_0x2ac95e)['length'])||'/';else{let _0x14d94b=_0x305a38['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x14d94b&&(_0x305a38=_0x14d94b[0x1]||'/');}return _0x305a38['startsWith']('/api')&&(_0x305a38=_0x305a38['substring'](0x4)||'/'),_0x305a38;}function Ue(_0x44553c,_0x34c249){let _0x18b103=_0x44553c;if(_0x34c249&&_0x18b103['startsWith']('/apps/'+_0x34c249))_0x18b103=_0x18b103['substring'](('/apps/'+_0x34c249)['length'])||'/';else{let _0x3415d6=_0x18b103['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x3415d6&&(_0x18b103=_0x3415d6[0x1]||'/');}return(!_0x18b103||_0x18b103==='/')&&(_0x18b103='/index.html'),_0x18b103;}async function He(_0x5c63c0,_0x15b7c7){return await _0x15b7c7(_0x5c63c0);}function _(_0x208aaf){return _0x208aaf['split']('/')['filter'](_0x573045=>_0x573045['length']>0x0);}function te(_0x5201b4){try{return decodeURIComponent(_0x5201b4);}catch{return _0x5201b4;}}function re(_0x623ddf,_0x1357cd){let _0x3286e1=_(_0x623ddf),_0x2d5610=_(_0x1357cd),_0x57cb60={},_0x47212b=0x0,_0x33d121=0x0;for(;_0x47212b<_0x3286e1['length']&&_0x33d121<_0x2d5610['length'];){let _0xda6cf7=_0x3286e1[_0x47212b],_0x1419c5=_0x2d5610[_0x33d121];if(_0xda6cf7==='*')break;if(_0xda6cf7['startsWith'](':')){let _0x4e111c=_0xda6cf7['slice'](0x1);_0x4e111c&&(_0x57cb60[_0x4e111c]=te(_0x1419c5)),_0x47212b++,_0x33d121++;continue;}if(_0xda6cf7!==_0x1419c5)return{};_0x47212b++,_0x33d121++;}return _0x47212b===_0x3286e1['length']||_0x47212b===_0x3286e1['length']-0x1&&_0x3286e1[_0x47212b]==='*',_0x57cb60;}async function Oe(_0x34fb15,_0x1b79e6,_0x427669,_0x5f598,_0x14556a=void 0x0,_0x3e5d78){let _0x245f5d=await _0x1b79e6['text'](),_0x578a69=J(_0x245f5d),_0x2e7423=B(_0x1b79e6['url']),_0x4e27d9={...F(_0x34fb15),'user':_0x14556a},_0x3d0583=H(_0x4e27d9),_0x259614=_0x3e5d78?re(_0x3e5d78,_0x1b79e6['path']):{};return{'app':O(_0x34fb15),'permissions':T(_0x34fb15),'user':_0x14556a,'metadata':_0x3d0583,'body':_0x578a69,'query':_0x2e7423,'params':_0x259614,'method':_0x427669,'pathname':_0x5f598,'requestUrl':_0x1b79e6['url'],'headers':Object['fromEntries'](_0x1b79e6['raw']['headers']['entries']())};}function Te(_0x177c16){return{'method':_0x177c16['method'],'pathname':_0x177c16['pathname'],'ctx':_0x177c16};}function Fe(_0x5bda1f,_0x2acf76){let {status:_0x283b1c=0xc8,headers:_0x1cf69f={},body:_0x20c849,type:_0x254d0e}=_0x5bda1f??{};return _0x254d0e==='raw'?new globalThis['Response'](String(_0x20c849??''),{'status':_0x283b1c,'headers':_0x1cf69f}):_0x2acf76(_0x20c849,_0x283b1c);}function Ne(_0x37a581,_0x1445c5=null){return N(_0x37a581,{'appInfo':_0x1445c5});}var V=f;async function Ve(_0x45f387){_0x45f387?(await U(_0x45f387),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x45f387)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x374058,_0x22c306){let _0x16ca9d=Object['fromEntries'](Object['entries'](_0x374058['headers']||{})['map'](([_0x88eab8,_0x4c4461])=>[_0x88eab8['toLowerCase'](),_0x4c4461]));return{'id':_0x374058['app']['id']||_0x22c306['appId']||'','name':_0x374058['app']['name']||'','version':_0x374058['app']['version']||'','description':_0x374058['app']['description']||'','metadata':{..._0x374058['metadata'],'permissions':_0x374058['permissions']},'body':_0x374058['body'],'query':_0x374058['query'],'params':_0x374058?.['params'],'method':_0x374058['method'],'pathname':_0x374058['pathname'],'requestUrl':_0x374058['requestUrl'],'user':_0x374058['user'],'headers':_0x16ca9d};}var L=class{constructor(_0x2aa6ef){this['handle']=null,(this['config']=_0x2aa6ef,this['logger']=_0x2aa6ef['logger']||f,this['lifecycle']=W({'appsDir':_0x2aa6ef['appsDir'],'timeout':_0x2aa6ef['timeout'],'platformImports':_0x2aa6ef['platformImports'],'libDir':_0x2aa6ef['libDir']},{'onCreate':_0x4450f9=>this['logger']['info']('Worker\x20created',{'appId':_0x4450f9['appId']}),'onReady':_0x2a4380=>{this['lifecycle']['updateStatus'](_0x2a4380['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x2a4380['appId']});},'onCrash':_0x33b50e=>this['logger']['error']('Worker\x20crashed',{'appId':_0x33b50e['appId']}),'onStop':_0x58e764=>this['logger']['info']('Worker\x20stopped',{'appId':_0x58e764['appId']})}),this['messaging']=$({'onReady':_0x2c33b7=>this['lifecycle']['updateStatus'](_0x2c33b7,'running'),'onLog':(_0x52c792,_0x2ef2fc,_0x5e633c,_0x5a7b9a)=>{(this['logger'][_0x2ef2fc]||this['logger']['info'])['call'](this['logger'],_0x5e633c,_0x5a7b9a);},'onResult':()=>{}},_0x2aa6ef['timeout']||0x1d4c0));}async['create'](_0x544426){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x5a64fb=await this['lifecycle']['create'](this['config']['appId'],_0x544426,this['config']['scriptUrl']);this['messaging']['setup'](_0x5a64fb),this['messaging']['sendInit'](_0x5a64fb,this['config']['appsDir'],_0x544426,this['config']['serverPath']),this['handle']=_0x5a64fb,await this['waitForReady']();}async['waitForReady'](_0x2dc59d=0x2710){let _0x2e8398=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x2e8398>_0x2dc59d)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x6f8e3=>setTimeout(_0x6f8e3,0x64));}}async['invoke'](_0x3f4c66){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x3f4c66);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x55a18e){return new L(_0x55a18e);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;