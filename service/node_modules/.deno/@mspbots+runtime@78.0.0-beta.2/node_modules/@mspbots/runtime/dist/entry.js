function c(_0xc2dbec,_0x26019a){let _0xe22db2=Object['fromEntries'](Object['entries'](_0xc2dbec['headers']||{})['map'](([_0x32434f,_0x2e00de])=>[_0x32434f['toLowerCase'](),_0x2e00de]));return{'id':_0xc2dbec['app']['id']||_0x26019a['appId']||'','name':_0xc2dbec['app']['name']||'','version':_0xc2dbec['app']['version']||'','description':_0xc2dbec['app']['description']||'','metadata':{..._0xc2dbec['metadata'],'permissions':_0xc2dbec['permissions']},'body':_0xc2dbec['body'],'query':_0xc2dbec['query'],'params':_0xc2dbec?.['params'],'method':_0xc2dbec['method'],'pathname':_0xc2dbec['pathname'],'requestUrl':_0xc2dbec['requestUrl'],'user':_0xc2dbec['user'],'headers':_0xe22db2};}function f(_0x3115f0){return _0x3115f0['split']('/')['filter'](_0xf111ba=>_0xf111ba['length']>0x0);}function P(_0x308755,_0xd3b962){let _0x543260=f(_0x308755),_0x5bd23d=f(_0xd3b962),_0x3b9c2c=0x0,_0x2d33ee=0x0;for(;_0x3b9c2c<_0x543260['length']&&_0x2d33ee<_0x5bd23d['length'];){let _0x28be4c=_0x543260[_0x3b9c2c],_0x3f5037=_0x5bd23d[_0x2d33ee];if(_0x28be4c==='*')return!![];if(_0x28be4c['startsWith'](':')){_0x3b9c2c++,_0x2d33ee++;continue;}if(_0x28be4c!==_0x3f5037)return![];_0x3b9c2c++,_0x2d33ee++;}return _0x3b9c2c===_0x543260['length']&&_0x2d33ee===_0x5bd23d['length']||_0x3b9c2c===_0x543260['length']-0x1&&_0x543260[_0x3b9c2c]==='*';}function m(_0x1fb2ff,_0x39d71a,_0x466a5e){let _0x16f8ab=_0x39d71a+'\x20'+_0x466a5e;if(_0x1fb2ff[_0x16f8ab])return{'handler':_0x1fb2ff[_0x16f8ab],'routePattern':_0x466a5e};let _0x407e08=[];_0x466a5e['startsWith']('/api')?_0x407e08['push'](_0x466a5e['substring'](0x4)||'/'):_0x407e08['push']('/api'+_0x466a5e),_0x407e08['push'](_0x466a5e);for(let _0x30ee5e of _0x407e08)for(let _0x17c32b of Object['keys'](_0x1fb2ff)){if(!_0x17c32b['startsWith'](_0x39d71a+'\x20'))continue;let _0x31da27=_0x17c32b['substring'](_0x39d71a['length']+0x1);if(P(_0x31da27,_0x30ee5e))return{'handler':_0x1fb2ff[_0x17c32b],'routePattern':_0x31da27};}return null;}function k(_0x53f6e3){return typeof _0x53f6e3=='function'?{'handler':_0x53f6e3,'routePattern':''}:_0x53f6e3;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x2fb028){let _0x8e2745=async _0x599311=>{try{let _0x1120cd=globalThis['Deno'];if(!_0x1120cd)throw new Error('Deno is not available');return await _0x1120cd['stat'](_0x599311),!0x0;}catch{return![];}};if(_0x2fb028&&typeof _0x2fb028=='string'&&_0x2fb028['length']>0x0)return _0x2fb028;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x255302=s['manifest']?.['metadata']?.['serverPath'];if(_0x255302&&typeof _0x255302=='string'&&_0x255302['length']>0x0)return _0x255302;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0xd5a1d1=s['manifest']['name'];if(!_0xd5a1d1)throw new Error('Manifest\x20name\x20not\x20found');let _0x3c5f21=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0xd5a1d1+'/server.js',s['appsDir']+'/'+_0xd5a1d1+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x13b05e of _0x3c5f21)if(await _0x8e2745(_0x13b05e))return _0x13b05e;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x3c5f21['join'](',\x20'));}function R(){let _0x58da2a=['log','info','warn','error','debug','trace'];for(let _0x16fc4e of _0x58da2a){let _0x1c781c=(console[_0x16fc4e]||console['log'])['bind'](console);console[_0x16fc4e]=(..._0xa60ff4)=>{try{let _0x3081bd=_0xa60ff4['map'](_0x273d26=>{if(typeof _0x273d26=='string')return _0x273d26;if(_0x273d26 instanceof Error)return JSON['stringify']({'name':_0x273d26['name'],'message':_0x273d26['message'],'stack':_0x273d26['stack']});if(typeof Request<'u'&&_0x273d26 instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x273d26['url'],'method':_0x273d26['method'],'headers':Object['fromEntries'](_0x273d26['headers']['entries']()),'bodyUsed':_0x273d26['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x273d26 instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x273d26['status'],'headers':Object['fromEntries'](_0x273d26['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x273d26);}catch{return String(_0x273d26);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x16fc4e==='log'?'info':_0x16fc4e,'message':_0x3081bd,'meta':{'appId':s['appId']}});}catch{_0x1c781c(..._0xa60ff4);}};}}R();async function v(_0x594c1b){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x1762c4=(await w(_0x594c1b))['replace'](/\\/g,'/'),_0x3c97fc=(_0x1762c4['startsWith']('file://')?_0x1762c4:'file://'+_0x1762c4)+'?t='+Date['now']();try{let _0x1ed7a8=await import(_0x3c97fc);return s['module']=_0x1ed7a8,_0x1ed7a8;}catch(_0x145b88){throw console['error']('Failed to load module:',_0x145b88),_0x145b88;}}function b(_0xd3ac9){return _0xd3ac9 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0xd3ac9,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x79475e){return _0x79475e['split']('/')['filter'](_0x8f0609=>_0x8f0609['length']>0x0);}function E(_0x206ee1){try{return decodeURIComponent(_0x206ee1);}catch{return _0x206ee1;}}function I(_0x29120a,_0x2d92a2){let _0x4fbf2e=g(_0x29120a),_0x52dfb0=g(_0x2d92a2),_0x55e4fb={},_0x308044=0x0,_0x5be766=0x0;for(;_0x308044<_0x4fbf2e['length']&&_0x5be766<_0x52dfb0['length'];){let _0x3e7a15=_0x4fbf2e[_0x308044],_0xaeabf4=_0x52dfb0[_0x5be766];if(_0x3e7a15==='*')break;if(_0x3e7a15['startsWith'](':')){let _0x35b0a5=_0x3e7a15['slice'](0x1);_0x35b0a5&&(_0x55e4fb[_0x35b0a5]=E(_0xaeabf4)),_0x308044++,_0x5be766++;continue;}if(_0x3e7a15!==_0xaeabf4)return{};_0x308044++,_0x5be766++;}return _0x308044===_0x4fbf2e['length']||_0x308044===_0x4fbf2e['length']-0x1&&_0x4fbf2e[_0x308044]==='*',_0x55e4fb;}function M(_0x17b5be,_0x3f86b7){return _0x17b5be['startsWith']('/api')&&!_0x3f86b7['startsWith']('/api')?_0x17b5be['substring'](0x4)||'/':!_0x17b5be['startsWith']('/api')&&_0x3f86b7['startsWith']('/api')?'/api'+(_0x17b5be['startsWith']('/')?'':'/')+_0x17b5be:_0x17b5be;}async function W(_0x3728bc){let _0x4c7cde=_0x3728bc['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x4c7cde)&&await v(_0x4c7cde);let _0x10bc9e=_0x3728bc['ctx'],{method:_0x53be68,pathname:_0x31de41}=_0x10bc9e,_0x43ef0a=s['module']?.['default']||{},_0x10f7dd=m(_0x43ef0a,_0x53be68,_0x31de41);if(!_0x10f7dd)throw Object['assign'](new Error('Route\x20'+_0x53be68+'\x20'+_0x31de41+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x469d64=k(_0x10f7dd),_0x40d778=c(_0x10bc9e,s),_0x3124b=_0x31de41,_0x1b13ee=M(_0x469d64['routePattern'],_0x3124b),_0x2800bb=_0x1b13ee?I(_0x1b13ee,_0x3124b):{},_0x530db9=await _0x469d64['handler']({..._0x40d778,'params':{..._0x40d778['params'],..._0x2800bb}});return b(_0x530db9);}function D(_0xfe154a){s['appId']=_0xfe154a['appId'],s['manifest']=_0xfe154a['manifest'],s['appsDir']=_0xfe154a['appsDir'],s['serverPath']=_0xfe154a['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x51b4b8){let {reqId:_0x166eb4,payload:_0x1fa6b3}=_0x51b4b8;try{let _0x22cdce=await W(_0x1fa6b3);self['postMessage']({'type':'result','reqId':_0x166eb4,'ok':!0x0,'response':_0x22cdce});}catch(_0x5d0a69){let _0xec1b2d=_0x5d0a69;self['postMessage']({'type':'result','reqId':_0x166eb4,'ok':![],'error':{'message':_0xec1b2d['message'],'stack':_0xec1b2d['stack'],'code':_0xec1b2d['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x2c6571=>{let _0x515e68=_0x2c6571['data'];try{switch(_0x515e68['type']){case'init':D(_0x515e68);break;case'invoke':await $(_0x515e68);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x515e68['type']);break;}}catch(_0x4d63be){let _0x558441=_0x4d63be;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x558441['message'],'stack':_0x558441['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x558441);}}},self['onerror']=_0x1adbfc=>{let _0x87b934={'message':typeof _0x1adbfc=='string'?_0x1adbfc:_0x1adbfc['message'],'filename':typeof _0x1adbfc=='string'?void 0x0:_0x1adbfc['filename'],'lineno':typeof _0x1adbfc=='string'?void 0x0:_0x1adbfc['lineno'],'colno':typeof _0x1adbfc=='string'?void 0x0:_0x1adbfc['colno'],'error':typeof _0x1adbfc=='string'?void 0x0:_0x1adbfc['error']?.['message'],'stack':typeof _0x1adbfc=='string'?void 0x0:_0x1adbfc['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x87b934);},self['onunhandledrejection']=_0x15624a=>{let _0x2063dd=_0x15624a['reason'],_0x5a569f={'appId':s['appId'],'reason':_0x2063dd instanceof Error?_0x2063dd['message']:String(_0x2063dd),'stack':_0x2063dd instanceof Error?_0x2063dd['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x5a569f);};