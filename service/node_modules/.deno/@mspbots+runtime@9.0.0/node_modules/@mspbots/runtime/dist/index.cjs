'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x940f6d){return _0x940f6d&&_0x940f6d['__esModule']?_0x940f6d:{'default':_0x940f6d};}var Y__default=_interopDefault(Y);async function ie(_0x49ca02){try{return await promises['stat'](_0x49ca02),!0x0;}catch{return![];}}var f={'error':(_0x18fcf0,_0x596ab1)=>console['error']('[ERROR]\x20'+_0x18fcf0,_0x596ab1),'warn':(_0x1ee77f,_0x2c7afc)=>console['warn']('[WARN]\x20'+_0x1ee77f,_0x2c7afc),'info':(_0x24e186,_0x493f28)=>console['log']('[INFO]\x20'+_0x24e186,_0x493f28),'debug':(_0x30489b,_0x491c3d)=>console['log']('[DEBUG]\x20'+_0x30489b,_0x491c3d)};function z(){let _0x1429ea=globalThis['Deno'];if(!_0x1429ea)throw new Error('Deno is not available');return _0x1429ea;}var D=class{constructor(_0x428b0e,_0x181e3c='./lib',_0x1d5529={}){this['manifest']=_0x428b0e,this['libDir']=_0x181e3c,this['platformImports']=_0x1d5529;}['buildPerms'](){let _0x35b238=this['manifest']['permissions']||{},_0x1f6493={};return _0x35b238['net']!==void 0x0&&(_0x1f6493['net']=_0x35b238['net']===!![]?!![]:Array['isArray'](_0x35b238['net'])?_0x35b238['net']:[]),_0x35b238['read']!==void 0x0&&(_0x1f6493['read']=_0x35b238['read']===!![]?!![]:Array['isArray'](_0x35b238['read'])?_0x35b238['read']:[]),_0x35b238['write']!==void 0x0&&(_0x1f6493['write']=_0x35b238['write']===!![]?!![]:Array['isArray'](_0x35b238['write'])?_0x35b238['write']:[]),_0x35b238['env']!==void 0x0&&(_0x1f6493['env']=_0x35b238['env']===!![]?!![]:Array['isArray'](_0x35b238['env'])?_0x35b238['env']:[]),_0x35b238['run']!==void 0x0&&(_0x1f6493['run']=_0x35b238['run']===!![]?!![]:Array['isArray'](_0x35b238['run'])?_0x35b238['run']:[]),_0x35b238['ffi']!==void 0x0&&(_0x1f6493['ffi']=_0x35b238['ffi']===!![]?!![]:Array['isArray'](_0x35b238['ffi'])?_0x35b238['ffi']:[]),_0x35b238['sys']!==void 0x0&&(_0x1f6493['sys']=_0x35b238['sys']===!![]?!![]:Array['isArray'](_0x35b238['sys'])?_0x35b238['sys']:[]),_0x35b238['hrtime']!==void 0x0&&(_0x1f6493['hrtime']=_0x35b238['hrtime']),_0x1f6493;}['normalize'](_0x2df8a9){return _0x2df8a9===!![]?[]:Array['isArray'](_0x2df8a9)?_0x2df8a9:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x249800){return path.join(this['libDir'],_0x249800+'@*');}['getReadPaths'](){let _0x425735=this['getImports']();_0x425735['includes']('*')&&(_0x425735=Object['keys'](this['platformImports']));let _0x393773=[];console['log']('[Permissions] Building package path patterns for imports:',_0x425735);for(let _0x48855e of _0x425735){let _0x2beb43=this['getLibPattern'](_0x48855e);_0x393773['push'](_0x2beb43),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x48855e+'\x20->\x20'+_0x2beb43);}return console['log']('[Permissions] Final package path patterns:',_0x393773),_0x393773;}['buildImportMap'](_0x34ea90){let _0x2c151a=this['getImports'](),_0x275d11=_0x2c151a['includes']('*')?Object['keys'](_0x34ea90):_0x2c151a;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x275d11);let _0x4a5f5f={};for(let _0x4cfb50 of _0x275d11)if(_0x34ea90[_0x4cfb50])_0x4a5f5f[_0x4cfb50]=_0x34ea90[_0x4cfb50],console['log']('[ImportMap]\x20'+_0x4cfb50+'\x20->\x20'+_0x34ea90[_0x4cfb50]+'\x20(from\x20platform)');else try{let _0x547d5a=z(),_0x2ca1e1=path.join(_0x547d5a['cwd'](),this['libDir']),_0x2a1801=!0x1;try{for(let _0xac7f6c of _0x547d5a['readDirSync'](_0x2ca1e1))if(_0xac7f6c['isDirectory']&&(_0xac7f6c['name']===_0x4cfb50||_0xac7f6c['name']['startsWith'](_0x4cfb50+'@'))){let _0x25a033=path.join(_0x547d5a['cwd'](),this['libDir'],_0xac7f6c['name'],'index.js')['replace'](/\\/g,'/'),_0x1d3e6e=new URL('file:///'+_0x25a033)['href'];_0x4a5f5f[_0x4cfb50]=_0x1d3e6e,console['log']('[ImportMap]\x20'+_0x4cfb50+'\x20->\x20'+_0x1d3e6e+'\x20(from\x20lib)'),_0x2a1801=!0x0;break;}}catch{}_0x2a1801||console['warn']('[ImportMap]\x20Package\x20'+_0x4cfb50+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0xf98401){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x4cfb50+':',_0xf98401);}return _0x4a5f5f;}['validateServerImports'](_0x6a9141){let _0x25a5e4=this['manifest']['name']||this['manifest']['id'],_0x408a4b=this['manifest']['metadata']?.['serverPath'],_0x3110fc=_0xf88d30=>_0xf88d30['replace'](/\\/g,'/'),_0x38cdc2=z(),_0x1a3524=_0x6e1477=>{try{return _0x38cdc2['statSync'](_0x6e1477),!0x0;}catch{return![];}},_0x7c8dc6=_0x408a4b?_0x3110fc(_0x408a4b):void 0x0;if(!_0x7c8dc6){let _0x54278f=[_0x6a9141+'/service/server.js',_0x6a9141+'/service/server.ts',_0x6a9141+'/'+_0x25a5e4+'/server.js',_0x6a9141+'/'+_0x25a5e4+'/server.ts',_0x6a9141+'/server.js',_0x6a9141+'/server.ts']['map'](_0x3110fc);for(let _0x2dc5bd of _0x54278f)if(_0x1a3524(_0x2dc5bd)){_0x7c8dc6=_0x2dc5bd;break;}}if(!_0x7c8dc6)return{'valid':![],'violations':['Failed to locate server module']};let _0x3998b9='';try{_0x3998b9=_0x38cdc2['readTextFileSync'](_0x7c8dc6);}catch{return{'valid':![],'violations':['Failed to read server module']};}let _0x1d1a85=this['getImports']();if(_0x1d1a85['includes']('*'))return{'valid':!![],'violations':[]};let _0x10a0e9=_0x1d1a85,_0x2e280f=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x2a7b19=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x4d7c04=/\bimport\s*['"]([^'"]+)['"]/g,_0x2269e5=[],_0x2034b4=new Set(),_0x2f9772=_0x48c132=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x48c132),_0x173b35=_0x56eae0=>{let _0x532100=_0x56eae0;if(_0x532100['startsWith']('./')||_0x532100['startsWith']('../')||_0x532100['startsWith']('/')||_0x532100['startsWith']('file://')||!_0x2f9772(_0x56eae0)||_0x2034b4['has'](_0x56eae0))return;_0x2034b4['add'](_0x56eae0),_0x532100['startsWith']('npm:')&&(_0x532100=_0x532100['substring'](0x4)),_0x532100['includes']('@')&&!_0x532100['startsWith']('@')&&(_0x532100=_0x532100['split']('@')[0x0]);let _0xcbfbb=_0x532100['split']('/')[0x0];_0x10a0e9['includes'](_0xcbfbb)||_0x10a0e9['includes'](_0x56eae0)||_0x2269e5['push'](_0x56eae0);},_0x1248ba;for(;(_0x1248ba=_0x2e280f['exec'](_0x3998b9))!==null;)_0x173b35(_0x1248ba[0x1]);for(;(_0x1248ba=_0x2a7b19['exec'](_0x3998b9))!==null;)_0x173b35(_0x1248ba[0x1]);for(;(_0x1248ba=_0x4d7c04['exec'](_0x3998b9))!==null;)_0x173b35(_0x1248ba[0x1]);return{'valid':_0x2269e5['length']===0x0,'violations':_0x2269e5};}['validate'](_0x5ae896={}){let _0x4d323d=[],_0x31b421=this['manifest']['permissions']||{};try{let _0x192603=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x192603);}catch{}let _0x2903f3=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x4e013b,_0x49269d]of Object['entries'](_0x31b421))if(_0x4e013b==='hrtime')typeof _0x49269d!='boolean'&&_0x4d323d['push']('Permission\x20\x27'+_0x4e013b+'\x27\x20must\x20be\x20boolean');else{if(_0x4e013b==='langchain')typeof _0x49269d!='boolean'&&(typeof _0x49269d!='object'||_0x49269d===null)?_0x4d323d['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x49269d=='object'&&(_0x49269d===null||!('enabled'in _0x49269d)||typeof _0x49269d['enabled']!='boolean')&&_0x4d323d['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x4e013b==='kv')typeof _0x49269d!='boolean'&&_0x4d323d['push']('Permission\x20\x27'+_0x4e013b+'\x27\x20must\x20be\x20boolean');else{if(_0x4e013b==='mspbots')Array['isArray'](_0x49269d)||_0x4d323d['push']('Permission\x20\x27'+_0x4e013b+'\x27\x20must\x20be\x20an\x20array');else{if(_0x4e013b==='db'){if(typeof _0x49269d!='object'||_0x49269d===null||Array['isArray'](_0x49269d))_0x4d323d['push']('Permission\x20\x27'+_0x4e013b+'\x27\x20must\x20be\x20an\x20object');else{let _0x48f66f=_0x49269d,_0x13a240=['user','password']['filter'](_0x2f3bd6=>!(_0x2f3bd6 in _0x48f66f));_0x13a240['length']>0x0&&_0x4d323d['push']('Permission\x20\x27'+_0x4e013b+'\x27\x20missing\x20required\x20fields:\x20'+_0x13a240['join'](',\x20'));}}else{if(_0x4e013b==='imports')continue;_0x2903f3['has'](_0x4e013b)||typeof _0x49269d!='boolean'&&!Array['isArray'](_0x49269d)&&_0x4d323d['push']('Permission\x20\x27'+_0x4e013b+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x4d8305=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x4d8305))_0x4d323d['push']('permissions.imports must be an array');else{for(let _0x45c43d of _0x4d8305)typeof _0x45c43d!='string'&&_0x4d323d['push']('import\x20\x27'+_0x45c43d+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x4d323d['length']===0x0,'errors':_0x4d323d};}};function q(_0x20d5dd,_0x2388eb,_0x5b407e){return new D(_0x20d5dd,_0x2388eb,_0x5b407e||{});}var R=null;function I(){let _0x59decd=globalThis['Deno'];if(!_0x59decd)throw new Error('Deno is not available');return _0x59decd;}async function K(){if(R)return{...R};try{let _0x4b7c1a=I(),_0x4f0f39=path.join(_0x4b7c1a['cwd'](),'deno.json'),_0x2bd2e1=await _0x4b7c1a['readTextFile'](_0x4f0f39);return R=JSON['parse'](_0x2bd2e1)['imports']||{},{...R};}catch(_0x1753fd){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x1753fd),{};}}var E=class{constructor(_0x121262,_0x3d42e3={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x121262['appsDir'],this['platformImportsOverride']=_0x121262['platformImports'],this['libDir']=_0x121262['libDir'],this['events']=_0x3d42e3);}async['create'](_0xfe50dc,_0x5dedbc,_0xe32356){try{return await this['createWorker'](_0xfe50dc,_0x5dedbc,_0xe32356);}catch(_0x1a54ec){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0xfe50dc+':',_0x1a54ec),_0x1a54ec;}}async['createWorker'](_0x277cfb,_0x578fab,_0x3ee4f3){let _0x8490c8=this['platformImportsOverride']||await K(),_0x216e9c=q(_0x578fab,this['libDir'],_0x8490c8)['validateServerImports'](this['appsDir']);if(!_0x216e9c['valid']){let _0x41e58b=_0x216e9c['violations']['filter'](_0x1d7e6e=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x1d7e6e));throw new Error('Unauthorized\x20imports\x20in\x20'+(_0x578fab['name']||_0x578fab['id'])+'/server.js:\x20'+_0x41e58b['join'](',\x20'));}let _0x386ccf=q(_0x578fab,this['libDir'],_0x8490c8),_0x1bce7c=_0x386ccf['validate'](_0x8490c8);if(!_0x1bce7c['valid'])throw new Error('Invalid\x20config:\x20'+_0x1bce7c['errors']['join'](',\x20'));let _0x3bbd7c=_0x386ccf['buildImportMap'](_0x8490c8);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x277cfb+':',_0x3bbd7c);let _0x39f334=_0x386ccf['buildPerms'](),_0x38e0c1=_0x386ccf['getReadPaths']();if(_0x39f334['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x39f334['read']);else{let _0x2d2f23=_0x578fab['name']||_0x277cfb,_0x4b5303=this['appsDir']+'/'+_0x2d2f23,_0x4c8510=[_0x4b5303],_0x104d32=_0x578fab['metadata']?.['serverPath'];if(_0x104d32&&typeof _0x104d32=='string')try{let _0x26f342=path.dirname(_0x104d32)['replace'](/\\/g,'/');_0x4c8510['push'](_0x26f342);}catch{}_0x39f334['read']=_0x4c8510,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x4b5303);}if(_0x38e0c1['length']>0x0){if(_0x39f334['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x504284=Array['isArray'](_0x39f334['read'])?_0x39f334['read']:[];_0x39f334['read']=[..._0x504284,..._0x38e0c1],console['log']('[Worker] Added package read permissions:',_0x38e0c1);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x39f334['net']||(_0x39f334['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x277cfb+':',_0x39f334['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x39f334['read']===!![]?'unrestricted':Array['isArray'](_0x39f334['read'])?_0x39f334['read']['length']:0x0));let _0x28ae8f=await this['createImportMap'](_0x277cfb,_0x3bbd7c),_0x1e96e5=await this['createLock'](_0x277cfb,_0x3bbd7c),_0x3f31ea={'type':'module','deno':{'permissions':{}}};_0x3f31ea['deno']['namespace']=![],_0x3f31ea['deno']['permissions']=_0x39f334,_0x3f31ea['deno']['importMap']=_0x28ae8f,_0x3f31ea['deno']['lock']=_0x1e96e5,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x277cfb+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x28ae8f),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x1e96e5),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x3bbd7c)['length']+'\x20('+(Object['keys'](_0x3bbd7c)['join'](',\x20')||'none')+')');let _0x3c858e={'worker':new Worker(_0x3ee4f3,_0x3f31ea),'appId':_0x277cfb,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x578fab,'importMapPath':_0x28ae8f,'lockfilePath':_0x1e96e5};return this['workers']['set'](_0x277cfb,_0x3c858e),this['events']['onCreate']?.(_0x3c858e),_0x3c858e;}async['createLock'](_0x53ec8e,_0x45683d){let _0x26f490=I(),_0x51694a=path.join(_0x26f490['cwd'](),'storage','temp','lockfiles');await _0x26f490['mkdir'](_0x51694a,{'recursive':!![]});let _0x59923d=_0x53ec8e+'-'+Date['now']()+'.lock',_0x1f9945=path.join(_0x51694a,_0x59923d),_0x5343cd={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x4776fa,_0xfaec98]of Object['entries'](_0x45683d))if(_0xfaec98['startsWith']('npm:'))_0xfaec98['replace']('npm:',''),_0x5343cd['packages']['specifiers'][_0x4776fa]=_0xfaec98;else _0xfaec98['startsWith']('file://')&&(_0x5343cd['packages']['specifiers'][_0x4776fa]=_0xfaec98);let _0x2190ed=JSON['stringify'](_0x5343cd,null,0x2);return await _0x26f490['writeTextFile'](_0x1f9945,_0x2190ed),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x1f9945),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x45683d)['length']+'):',Object['keys'](_0x45683d)),_0x1f9945;}async['createImportMap'](_0x2c67f3,_0x273fd2){let _0x24d5b2=I(),_0x499ae6=path.join(_0x24d5b2['cwd'](),'storage','temp','importmaps');await _0x24d5b2['mkdir'](_0x499ae6,{'recursive':!![]});let _0x41c665=_0x2c67f3+'-'+Date['now']()+'.json',_0x2730a6=path.join(_0x499ae6,_0x41c665),_0x47890b=JSON['stringify']({'imports':_0x273fd2,'scopes':{}},null,0x2);return await _0x24d5b2['writeTextFile'](_0x2730a6,_0x47890b),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x2730a6),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x273fd2)['length']+'):',Object['keys'](_0x273fd2)['join'](',\x20')||'none'),_0x2730a6;}['get'](_0x5d2fe0){return this['workers']['get'](_0x5d2fe0);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x3fa441,_0x124048){let _0x1252f2=this['workers']['get'](_0x3fa441);if(!_0x1252f2)return;let _0x36165c=_0x1252f2['status'];_0x1252f2['status']=_0x124048,_0x124048==='running'&&_0x36165c==='starting'?this['events']['onReady']?.(_0x1252f2):_0x124048==='crashed'&&this['events']['onCrash']?.(_0x1252f2);}['touch'](_0x277941){let _0x16a60b=this['workers']['get'](_0x277941);_0x16a60b&&(_0x16a60b['lastUsed']=Date['now']());}async['stop'](_0x31f60c){let _0x53fe88=this['workers']['get'](_0x31f60c);if(_0x53fe88)try{_0x53fe88['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x53fe88['worker']['terminate'](),_0x53fe88['status']='stopped',this['events']['onStop']?.(_0x53fe88),_0x53fe88['importMapPath']&&await this['cleanupImportMap'](_0x53fe88['importMapPath']),_0x53fe88['lockfilePath']&&await this['cleanupLock'](_0x53fe88['lockfilePath']);}catch(_0x3e2b44){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x31f60c+':',_0x3e2b44);}finally{this['workers']['delete'](_0x31f60c);}}async['cleanupImportMap'](_0x3a12fc){try{await I()['remove'](_0x3a12fc),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x3a12fc);}catch(_0x385330){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x3a12fc,_0x385330);}}async['cleanupLock'](_0x1167c7){try{await I()['remove'](_0x1167c7),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x1167c7);}catch(_0x449113){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x1167c7,_0x449113);}}async['stopAll'](){let _0x4fc353=Array['from'](this['workers']['keys']());await Promise['all'](_0x4fc353['map'](_0x5b6bb2=>this['stop'](_0x5b6bb2)));}async['restart'](_0xf76a4f,_0x48b52b){let _0xddd838=this['workers']['get'](_0xf76a4f);if(!_0xddd838)throw new Error('Worker\x20'+_0xf76a4f+'\x20not\x20found');let _0xd3d9f1=_0xddd838['manifest'];return await this['stop'](_0xf76a4f),await this['create'](_0xf76a4f,_0xd3d9f1,_0x48b52b);}['checkHealth'](_0x2ebb96){let _0x1ea50b=this['workers']['get'](_0x2ebb96);if(!_0x1ea50b)return{'healthy':![],'reason':'Not\x20found'};if(_0x1ea50b['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x1ea50b['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x1fead6=Date['now']()-_0x1ea50b['lastUsed'],_0x51188f=0x708*0x3e8;return _0x1fead6>_0x51188f?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x1fead6/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x2bc0af=0x708*0x3e8,_0x5c958f){let _0x139dde=Date['now'](),_0x459c4f=[];for(let [_0x1d4a21,_0x3bb175]of this['workers']['entries']()){let _0x108796=_0x139dde-_0x3bb175['lastUsed'];_0x108796>_0x2bc0af&&_0x459c4f['push']({'appId':_0x1d4a21,'idle':_0x108796});}_0x459c4f['sort']((_0x45742e,_0x3a1e35)=>_0x3a1e35['idle']-_0x45742e['idle']);let _0x5e89b5=_0x5c958f?_0x459c4f['slice'](0x0,_0x5c958f)['map'](_0x654ab7=>_0x654ab7['appId']):_0x459c4f['map'](_0x40399e=>_0x40399e['appId']);for(let _0x2e98a6 of _0x5e89b5)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x2e98a6),await this['stop'](_0x2e98a6);}['stats'](){let _0x2d48ab={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x59f7b9=Date['now']();for(let _0x253727 of this['workers']['values']())_0x2d48ab['byStatus'][_0x253727['status']]++,_0x2d48ab['workers']['push']({'appId':_0x253727['appId'],'status':_0x253727['status'],'version':_0x253727['version'],'lastUsed':_0x253727['lastUsed'],'idle':_0x59f7b9-_0x253727['lastUsed']});return _0x2d48ab;}['startCleanup'](_0x296923=0x12c*0x3e8,_0x17df82){let _0x59654a=setInterval(()=>{this['cleanup'](_0x17df82)['catch'](_0x320b3b=>{console['error']('Cleanup\x20failed:',_0x320b3b);});},_0x296923);return()=>clearInterval(_0x59654a);}['delay'](_0x2176f5){return new Promise(_0x48bf36=>setTimeout(_0x48bf36,_0x2176f5));}};function W(_0x127c34,_0x2e1793){return new E(_0x127c34,_0x2e1793);}var v=f,j=class{constructor(_0x5d36cf,_0x5bffb3=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x5d36cf,this['timeout']=_0x5bffb3);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x1397cd){_0x1397cd['worker']['onmessage']=_0x1081e9=>{let _0x1f0e22=_0x1081e9['data'],{appId:_0x278a33}=_0x1397cd;switch(_0x1f0e22['type']){case'ready':this['events']['onReady'](_0x278a33),v['info']('Worker\x20ready',{'appId':_0x278a33,'version':_0x1397cd['version']});break;case'log':{let {level:_0x137368='info',message:_0x46c121,meta:_0x41bbd1}=_0x1f0e22,_0x22f638={..._0x41bbd1||{},'appId':_0x278a33,'version':_0x1397cd['version']};this['events']['onLog'](_0x278a33,_0x137368,_0x46c121,_0x22f638);break;}case'result':{let {reqId:_0x2277e5,ok:_0x1f3876,response:_0x2d82ca,error:_0x4f559e}=_0x1f0e22,_0xa9e96d=this['pending']['get'](_0x2277e5);if(!_0xa9e96d){v['warn']('Unknown\x20request',{'appId':_0x278a33,'reqId':_0x2277e5});return;}if(this['pending']['delete'](_0x2277e5),_0x1f3876&&_0x2d82ca)_0xa9e96d['resolve'](_0x2d82ca);else{let _0x50f31e=new Error(_0x4f559e?.['message']||'Worker\x20error');_0x50f31e['stack']=_0x4f559e?.['stack'],_0xa9e96d['reject'](_0x50f31e);}this['events']['onResult'](_0x278a33,_0x2277e5,_0x2d82ca||_0x4f559e);break;}default:v['debug']('Unknown\x20message',{'appId':_0x278a33,'type':_0x1f0e22['type']});}},_0x1397cd['worker']['onerror']=_0x1bc9cf=>{let {appId:_0x3d8d0e}=_0x1397cd;v['error']('Worker\x20error',{'appId':_0x3d8d0e,'message':_0x1bc9cf['message'],'lineno':_0x1bc9cf['lineno'],'filename':_0x1bc9cf['filename']}),_0x1397cd['status']='crashed',this['rejectPending'](_0x3d8d0e,new Error('Worker\x20'+_0x3d8d0e+'\x20crashed:\x20'+_0x1bc9cf['message'])),_0x1bc9cf['preventDefault']();},_0x1397cd['worker']['onmessageerror']=_0x4ed829=>{let {appId:_0x49b5b7}=_0x1397cd;v['error']('Message\x20error',{'appId':_0x49b5b7,'data':_0x4ed829['data']}),_0x1397cd['status']='crashed',_0x4ed829['preventDefault']();};}['sendInit'](_0xefc420,_0x5e83ca,_0x64c091,_0x427162){_0xefc420['worker']['postMessage']({'type':'init','appId':_0xefc420['appId'],'manifest':_0x64c091,'appsDir':_0x5e83ca,'serverPath':_0x427162});}async['sendInvoke'](_0x35624e,_0x3577a7){let _0x4cb6c1=this['nextId'](),_0x1297c6=_0x35624e['appId'],_0x1c8b3d=new Promise((_0x1ab9bf,_0x5f3d27)=>{let _0x5a44c4=setTimeout(()=>{this['pending']['delete'](_0x4cb6c1),_0x5f3d27(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x4cb6c1,{'resolve':_0x562950=>{clearTimeout(_0x5a44c4),_0x1ab9bf(_0x562950);},'reject':_0x1ccbf6=>{clearTimeout(_0x5a44c4),_0x5f3d27(_0x1ccbf6);},'timestamp':Date['now'](),'appId':_0x1297c6});});return _0x35624e['worker']['postMessage']({'type':'invoke','appId':_0x35624e['appId'],'reqId':_0x4cb6c1,'payload':_0x3577a7}),await _0x1c8b3d;}['rejectPending'](_0x38ca49,_0x23230b){let _0x18257e=0x0;for(let [_0x1a4749,_0x558d4a]of this['pending']['entries']())_0x558d4a['appId']===_0x38ca49&&(this['pending']['delete'](_0x1a4749),_0x558d4a['reject'](_0x23230b),_0x18257e++);_0x18257e>0x0&&v['warn']('Rejected\x20'+_0x18257e+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x38ca49});}['cleanupTimeout'](){let _0x15ac04=Date['now']();for(let [_0x233906,_0x2a2cc9]of this['pending']['entries']())_0x15ac04-_0x2a2cc9['timestamp']>this['timeout']&&(this['pending']['delete'](_0x233906),_0x2a2cc9['reject'](new Error('Request\x20'+_0x233906+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x5ea0c5){let _0x213dee=0x0;for(let _0x1f82e2 of this['pending']['values']())_0x1f82e2['appId']===_0x5ea0c5&&_0x213dee++;return _0x213dee;}['startCleanup'](_0x34d163=0x2710){let _0x4a425a=setInterval(()=>{this['cleanupTimeout']();},_0x34d163);return()=>clearInterval(_0x4a425a);}};function S(_0x402bda,_0x1988f5){return new j(_0x402bda,_0x1988f5);}var Q=class{constructor(_0x389535={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x389535['logger']||f,this['config']={'appsDir':_0x389535['appsDir']||this['getAppsDir'](),'scriptUrl':_0x389535['scriptUrl']||this['getScriptUrl'](),'timeout':_0x389535['timeout']||0x78*0x3e8,'autoCleanup':_0x389535['autoCleanup']??!![],'cleanupInterval':_0x389535['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x389535['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x389535['maxWorkers'],'reuseWorkers':_0x389535['reuseWorkers']??!![],'workerReuseStrategy':_0x389535['workerReuseStrategy']||'lru','enableQueue':_0x389535['enableQueue']??!![],'maxQueueSize':_0x389535['maxQueueSize']||0x64,'queueTimeout':_0x389535['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x4e8789=>this['logger']['info']('Worker\x20created',{'appId':_0x4e8789['appId'],'v':_0x4e8789['version']}),'onReady':_0x474967=>this['lifecycle']['updateStatus'](_0x474967['appId'],'running'),'onCrash':_0xcccc09=>this['logger']['error']('Worker\x20crashed',{'appId':_0xcccc09['appId'],'v':_0xcccc09['version']}),'onStop':_0x3edba4=>this['logger']['info']('Worker\x20stopped',{'appId':_0x3edba4['appId'],'v':_0x3edba4['version']})}),this['messaging']=S({'onReady':_0x300061=>this['lifecycle']['updateStatus'](_0x300061,'running'),'onLog':(_0xc822b1,_0xa99f05,_0x37c624,_0x4c0f77)=>{let _0x41fe01={..._0x4c0f77||{},'appId':_0xc822b1};switch(_0xa99f05){case'error':this['logger']['error'](_0x37c624,_0x41fe01);break;case'warn':this['logger']['warn'](_0x37c624,_0x41fe01);break;case'debug':this['logger']['debug'](_0x37c624,_0x41fe01);break;default:this['logger']['info'](_0x37c624,_0x41fe01);break;}},'onResult':(_0x4e4f5f,_0x255d14,_0x4f61ce)=>{this['logger']['debug']('Result\x20received',{'appId':_0x4e4f5f,'reqId':_0x255d14});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x3026ae=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x2ea447=_0x3026ae['endsWith']('.js')||_0x3026ae['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x2ea447,_0x3026ae)['href'];}async['ensure'](_0x235dbf){let {id:_0x1f1294}=_0x235dbf,_0x584a37=this['lifecycle']['get'](_0x1f1294);if(_0x584a37){let _0x3c9607=this['lifecycle']['checkHealth'](_0x1f1294);if(_0x3c9607['healthy'])return this['lifecycle']['touch'](_0x1f1294),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x1f1294}),_0x584a37;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x1f1294,'reason':_0x3c9607['reason']}),await this['lifecycle']['stop'](_0x1f1294);}for(;;){let _0x138f96=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x138f96>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x138f96,'max':this['config']['maxWorkers'],'appId':_0x1f1294}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x235dbf);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x3036db=await this['loadManifest'](_0x1f1294,_0x235dbf['manifest']),_0x594555=await this['lifecycle']['create'](_0x1f1294,_0x3036db,this['config']['scriptUrl']),_0x170763=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x170763>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x170763,'max':this['config']['maxWorkers'],'appId':_0x1f1294}),await this['lifecycle']['stop'](_0x1f1294),this['config']['enableQueue'])return await this['waitSlot'](_0x235dbf);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x170763+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x594555);let _0x52b968=_0x3036db['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x594555,this['config']['appsDir'],_0x3036db,_0x52b968),this['logger']['info']('Worker\x20created',{'appId':_0x1f1294,'v':_0x594555['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x594555;}async['evictIdle'](){let _0x367577=this['lifecycle']['getAll']();if(_0x367577['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x953e42=[..._0x367577];this['config']['workerReuseStrategy']==='lru'?_0x953e42['sort']((_0x260487,_0x5ff782)=>_0x260487['lastUsed']-_0x5ff782['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x953e42['sort']((_0x308227,_0x2a9049)=>_0x308227['version']-_0x2a9049['version']);let _0xd0cd55=null;for(let _0x5690c1 of _0x953e42)if(this['messaging']['getAppCount'](_0x5690c1['appId'])===0x0){_0xd0cd55=_0x5690c1;break;}if(!_0xd0cd55&&_0x953e42['length']>0x0&&(_0xd0cd55=_0x953e42['reduce']((_0x1c66be,_0x2d55e6)=>{let _0x594693=this['messaging']['getAppCount'](_0x1c66be['appId']);return this['messaging']['getAppCount'](_0x2d55e6['appId'])<_0x594693?_0x2d55e6:_0x1c66be;})),_0xd0cd55){let _0xdfeb62=this['messaging']['getAppCount'](_0xd0cd55['appId']);return _0xdfeb62>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0xd0cd55['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0xd0cd55['lastUsed'],'pendingRequests':_0xdfeb62}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0xd0cd55['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0xd0cd55['lastUsed']}),await this['lifecycle']['stop'](_0xd0cd55['appId']),!![];}return![];}['waitSlot'](_0x315414){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0xff861e,_0x322d61)=>{let _0x38698a={'info':_0x315414,'resolve':_0xff861e,'reject':_0x322d61,'timestamp':Date['now']()};this['requestQueue']['push'](_0x38698a),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x315414['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x1f4d90=setTimeout(()=>{let _0x3a94dd=this['requestQueue']['indexOf'](_0x38698a);_0x3a94dd!==-0x1&&(this['requestQueue']['splice'](_0x3a94dd,0x1),_0x322d61(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x38698a['resolve']=_0x3d8f1b=>{clearTimeout(_0x1f4d90),_0xff861e(_0x3d8f1b);},_0x38698a['reject']=_0x3dbe7e=>{clearTimeout(_0x1f4d90),_0x322d61(_0x3dbe7e);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x388c77=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x388c77>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x3a81e2=this['requestQueue']['shift']();if(!_0x3a81e2)break;try{let _0x1db81a=await this['ensure'](_0x3a81e2['info']);_0x3a81e2['resolve'](_0x1db81a);}catch(_0x545a7b){_0x3a81e2['reject'](_0x545a7b);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x4f63f8,_0x59a23f){let _0x57514e=this['config']['appsDir']['replace'](/\\/g,'/'),_0x5c8403=async _0x361d77=>{try{let _0x46f6e4=globalThis['Deno'];if(!_0x46f6e4)return null;let _0x3bf054=await _0x46f6e4['readTextFile'](_0x361d77);return JSON['parse'](_0x3bf054);}catch{return null;}};if(_0x59a23f?.['name']){let _0x2ecbb0=await _0x5c8403(_0x57514e+'/'+_0x59a23f['name']+'/manifest.json');if(_0x2ecbb0)return _0x2ecbb0;}let _0x37744a=await _0x5c8403(_0x57514e+'/'+_0x4f63f8+'/manifest.json');if(_0x37744a)return _0x37744a;try{let _0x39984e=globalThis['Deno'];if(_0x39984e)for await(let _0xa476a2 of _0x39984e['readDir'](_0x57514e)){if(!_0xa476a2['isDirectory'])continue;let _0x116cec=_0x57514e+'/'+_0xa476a2['name']+'/manifest.json',_0x41430a=await _0x5c8403(_0x116cec);if(_0x41430a&&(_0x41430a['id']===_0x4f63f8||_0x59a23f?.['name']&&_0x41430a['name']===_0x59a23f['name']))return _0x41430a;}}catch(_0x45369c){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x4f63f8,'error':_0x45369c['message']});}return _0x59a23f||{'id':_0x4f63f8,'name':_0x4f63f8,'version':'1.0.0'};}async['invoke'](_0x3f5bf9){let _0x40dc37=_0x3f5bf9['ctx']['app']['id'],_0x2bca17=_0x3f5bf9['ctx']['app']['name'];try{let _0x2e3532={'id':_0x40dc37,'manifest':{'id':_0x40dc37,'name':_0x2bca17}},_0x5c5fb4=await this['ensure'](_0x2e3532);if(_0x5c5fb4['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x40dc37}),await this['restart'](_0x40dc37);let _0x5e6875=await this['ensure'](_0x2e3532);return this['lifecycle']['touch'](_0x40dc37),await this['messaging']['sendInvoke'](_0x5e6875,_0x3f5bf9);}return this['lifecycle']['touch'](_0x40dc37),await this['messaging']['sendInvoke'](_0x5c5fb4,_0x3f5bf9);}catch(_0x1ecadf){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x40dc37,'error':_0x1ecadf['message'],'stack':_0x1ecadf['stack']}),_0x1ecadf;}}async['stop'](_0x2dace5){await this['lifecycle']['stop'](_0x2dace5),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x1ba336){return await this['lifecycle']['restart'](_0x1ba336,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x5a115d=>({'appId':_0x5a115d['appId'],'status':_0x5a115d['status'],'version':_0x5a115d['version'],'lastUsed':_0x5a115d['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x3bcab5=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0xf2f2da=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x3bcab5(),_0xf2f2da();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x381268=>{_0x381268?(await this['stop'](_0x381268),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x381268})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x2b15e1){return new Q(_0x2b15e1);}var M=null;function be(_0x470c96){M=ee(_0x470c96);}function k(){if(!M)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return M;}async function Pe(_0x6f0449){return await k()['ensure'](_0x6f0449);}async function xe(_0x110ae7){return await k()['invoke'](_0x110ae7);}function Ie(_0x462f5f){k()['stop'](_0x462f5f)['catch'](_0x5b4ddc=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x462f5f,'error':_0x5b4ddc['message']});});}function Re(){k()['stopAll']()['catch'](_0x1a5c2d=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x1a5c2d['message']});});}function We(){return k()['getStats']();}function Se(){return M;}async function O(_0x548ffe){await k()['stop'](_0x548ffe);}async function Me(){await k()['stopAll']();}function Ae(_0x463556){let _0x2b5cf6=_0x463556&&typeof _0x463556=='object'?_0x463556:null;if(_0x2b5cf6&&'user'in _0x2b5cf6)return _0x2b5cf6['user'];}function U(_0x45cc57){let _0x42c079=_0x45cc57&&typeof _0x45cc57=='object'?_0x45cc57:null;if(!_0x42c079)return{};let _0x2f88e1={};for(let [_0x7d4b09,_0x429be5]of Object['entries'](_0x42c079))_0x7d4b09!=='user'&&(_0x2f88e1[_0x7d4b09]=_0x429be5);return _0x2f88e1;}function H(_0x5df0d5){return _0x5df0d5?{'id':_0x5df0d5['manifest']?.['id']||_0x5df0d5['id']||'','name':_0x5df0d5['manifest']?.['name']||'','version':_0x5df0d5['manifest']?.['version']||'','description':_0x5df0d5['manifest']?.['description']||'','icon':_0x5df0d5['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x17b906){return _0x17b906?.['permissions']||_0x17b906?.['manifest']?.['permissions']||{};}function F(_0x1b6b6c){return _0x1b6b6c?.['manifest']?.['metadata']||{};}function Ce(_0x11f1f6){return _0x11f1f6?{'appId':_0x11f1f6['id'],'appName':_0x11f1f6['manifest']?.['name']}:{};}function N(_0x3a59d8,_0x16aac6={}){let {appInfo:_0x4bd499=null,status:_0x20d6e5=0x1f4,defaultMessage:_0x1487e='Internal\x20Server\x20Error'}=_0x16aac6,_0x498f09={'error':_0x1487e,'message':_0x3a59d8?.['message']||_0x1487e};return _0x4bd499&&(_0x498f09['appId']=_0x4bd499['id'],_0x498f09['appName']=_0x4bd499['manifest']?.['name']),_0x3a59d8?.['message']?.['includes']('crashed')&&(_0x498f09['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x20d6e5,'body':_0x498f09};}function qe(_0x4a7692){return _0x4a7692?.['message']?.['includes']('crashed')||![];}function J(_0x5536cb){if(_0x5536cb)try{return JSON['parse'](_0x5536cb);}catch{return _0x5536cb;}}function B(_0x1f54bd){try{let _0x47fed5=new URL(_0x1f54bd),_0x328cef={};for(let _0xf00e8b of _0x47fed5['searchParams']['keys']()){let _0x29d15c=_0x47fed5['searchParams']['getAll'](_0xf00e8b)['map'](_0x551ddb=>_0x551ddb);_0x29d15c['length']<=0x1?_0x328cef[_0xf00e8b]=_0x29d15c[0x0]??'':_0x328cef[_0xf00e8b]=_0x29d15c;}return _0x328cef;}catch{return{};}}function Le(_0x1914a1){try{let _0x128ebc=new URL(_0x1914a1)['pathname']['split']('/'),_0x493a43=_0x128ebc['indexOf']('apps')+0x1;return _0x128ebc[_0x493a43]||'';}catch{let _0x169f80=_0x1914a1['split']('/'),_0x370ad9=_0x169f80['indexOf']('apps')+0x1;return _0x169f80[_0x370ad9]||'';}}function ze(_0x355364,_0x37eefa){let _0x1d66bd=_0x355364['replace']('/apps/'+_0x37eefa,'');return _0x1d66bd['startsWith']('/api')&&(_0x1d66bd=_0x1d66bd['substring'](0x4)||'/'),_0x1d66bd;}function Oe(_0x445202,_0x10ebf9){let _0x46f6f4=_0x445202['replace']('/apps/'+_0x10ebf9,'');return(!_0x46f6f4||_0x46f6f4==='/')&&(_0x46f6f4='/index.html'),_0x46f6f4;}async function Ue(_0x1ad3be,_0x231aa5){return await _0x231aa5(_0x1ad3be);}function _(_0x1e76fa){return _0x1e76fa['split']('/')['filter'](_0x51f5cb=>_0x51f5cb['length']>0x0);}function te(_0x29cd62){try{return decodeURIComponent(_0x29cd62);}catch{return _0x29cd62;}}function re(_0x19faf6,_0x1175e2){let _0x2e033d=_(_0x19faf6),_0x23cbce=_(_0x1175e2),_0xa66633={},_0x2539a1=0x0,_0x2e1092=0x0;for(;_0x2539a1<_0x2e033d['length']&&_0x2e1092<_0x23cbce['length'];){let _0x3fd0b1=_0x2e033d[_0x2539a1],_0x182df1=_0x23cbce[_0x2e1092];if(_0x3fd0b1==='*')break;if(_0x3fd0b1['startsWith'](':')){let _0x58871a=_0x3fd0b1['slice'](0x1);_0x58871a&&(_0xa66633[_0x58871a]=te(_0x182df1)),_0x2539a1++,_0x2e1092++;continue;}if(_0x3fd0b1!==_0x182df1)return{};_0x2539a1++,_0x2e1092++;}return _0x2539a1===_0x2e033d['length']||_0x2539a1===_0x2e033d['length']-0x1&&_0x2e033d[_0x2539a1]==='*',_0xa66633;}async function He(_0x125b69,_0x2c8b4c,_0x426220,_0x18c069,_0x1a6f4c=void 0x0,_0x438dad){let _0x1100cf=await _0x2c8b4c['text'](),_0x15be93=J(_0x1100cf),_0x417ab7=B(_0x2c8b4c['url']),_0x27daf5={...F(_0x125b69),'user':_0x1a6f4c},_0x30c89b=U(_0x27daf5),_0x20eca4=_0x438dad?re(_0x438dad,_0x2c8b4c['path']):{};return{'app':H(_0x125b69),'permissions':T(_0x125b69),'user':_0x1a6f4c,'metadata':_0x30c89b,'body':_0x15be93,'query':_0x417ab7,'params':_0x20eca4,'method':_0x426220,'pathname':_0x18c069,'requestUrl':_0x2c8b4c['url'],'headers':Object['fromEntries'](_0x2c8b4c['raw']['headers']['entries']())};}function Te(_0x1951f6){return{'method':_0x1951f6['method'],'pathname':_0x1951f6['pathname'],'ctx':_0x1951f6};}function Fe(_0x9bd21c,_0xa2076){let {status:_0x56d544=0xc8,headers:_0x22dba7={},body:_0x1c77d3,type:_0xec3b23}=_0x9bd21c??{};return _0xec3b23==='raw'?new globalThis['Response'](String(_0x1c77d3??''),{'status':_0x56d544,'headers':_0x22dba7}):_0xa2076(_0x1c77d3,_0x56d544);}function Ne(_0x2baaf5,_0x5ac71d=null){return N(_0x2baaf5,{'appInfo':_0x5ac71d});}var V=f;async function Ve(_0x2e27ed){_0x2e27ed?(await O(_0x2e27ed),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x2e27ed)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x251b3c,_0x172ce5){let _0x16e449=Object['fromEntries'](Object['entries'](_0x251b3c['headers']||{})['map'](([_0x349fc1,_0x507dd0])=>[_0x349fc1['toLowerCase'](),_0x507dd0]));return{'id':_0x251b3c['app']['id']||_0x172ce5['appId']||'','name':_0x251b3c['app']['name']||'','version':_0x251b3c['app']['version']||'','description':_0x251b3c['app']['description']||'','metadata':{..._0x251b3c['metadata'],'permissions':_0x251b3c['permissions']},'body':_0x251b3c['body'],'query':_0x251b3c['query'],'params':_0x251b3c?.['params'],'method':_0x251b3c['method'],'pathname':_0x251b3c['pathname'],'requestUrl':_0x251b3c['requestUrl'],'user':_0x251b3c['user'],'headers':_0x16e449};}var L=class{constructor(_0x23c23d){this['handle']=null,(this['config']=_0x23c23d,this['logger']=_0x23c23d['logger']||f,this['lifecycle']=W({'appsDir':_0x23c23d['appsDir'],'timeout':_0x23c23d['timeout'],'platformImports':_0x23c23d['platformImports'],'libDir':_0x23c23d['libDir']},{'onCreate':_0x51ffee=>this['logger']['info']('Worker\x20created',{'appId':_0x51ffee['appId']}),'onReady':_0x538132=>{this['lifecycle']['updateStatus'](_0x538132['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x538132['appId']});},'onCrash':_0x4efaf6=>this['logger']['error']('Worker\x20crashed',{'appId':_0x4efaf6['appId']}),'onStop':_0x16be92=>this['logger']['info']('Worker\x20stopped',{'appId':_0x16be92['appId']})}),this['messaging']=S({'onReady':_0x4feac4=>this['lifecycle']['updateStatus'](_0x4feac4,'running'),'onLog':(_0x278254,_0x3a6353,_0x1b3328,_0x2a0573)=>{(this['logger'][_0x3a6353]||this['logger']['info'])['call'](this['logger'],_0x1b3328,_0x2a0573);},'onResult':()=>{}},_0x23c23d['timeout']||0x1d4c0));}async['create'](_0x54d508){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x2c3b05=await this['lifecycle']['create'](this['config']['appId'],_0x54d508,this['config']['scriptUrl']);this['messaging']['setup'](_0x2c3b05),this['messaging']['sendInit'](_0x2c3b05,this['config']['appsDir'],_0x54d508,this['config']['serverPath']),this['handle']=_0x2c3b05,await this['waitForReady']();}async['waitForReady'](_0x48f93c=0x2710){let _0x50759d=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x50759d>_0x48f93c)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x305354=>setTimeout(_0x305354,0x64));}}async['invoke'](_0x358dec){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x358dec);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0xa068ce){return new L(_0xa068ce);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=S,exports['createPermManager']=q,exports['createRequestCtx']=He,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=H,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=U,exports['extractPermissions']=T,exports['extractStatic']=Oe,exports['extractUser']=Ae,exports['findApp']=Ue,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=Se,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Me,exports['stopWorker']=O,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;