import{join,dirname}from'path';import _0xb6d15d from'process';import{stat}from'fs/promises';async function ie(_0x1fc13f){try{return await stat(_0x1fc13f),!0x0;}catch{return![];}}var f={'error':(_0x317fa8,_0x2adb2d)=>console['error']('[ERROR]\x20'+_0x317fa8,_0x2adb2d),'warn':(_0x1e6fa2,_0x103cff)=>console['warn']('[WARN]\x20'+_0x1e6fa2,_0x103cff),'info':(_0x331c0,_0x577175)=>console['log']('[INFO]\x20'+_0x331c0,_0x577175),'debug':(_0x1f89f9,_0x37fbe8)=>console['log']('[DEBUG]\x20'+_0x1f89f9,_0x37fbe8)};function z(){let _0x169f31=globalThis['Deno'];if(!_0x169f31)throw new Error('Deno is not available');return _0x169f31;}var D=class{constructor(_0x24377b,_0x361299='./lib',_0x51216b={}){this['manifest']=_0x24377b,this['libDir']=_0x361299,this['platformImports']=_0x51216b;}['buildPerms'](){let _0x394998=this['manifest']['permissions']||{},_0x467e42={};return _0x394998['net']!==void 0x0&&(_0x467e42['net']=_0x394998['net']===!![]?!![]:Array['isArray'](_0x394998['net'])?_0x394998['net']:[]),_0x394998['read']!==void 0x0&&(_0x467e42['read']=_0x394998['read']===!![]?!![]:Array['isArray'](_0x394998['read'])?_0x394998['read']:[]),_0x394998['write']!==void 0x0&&(_0x467e42['write']=_0x394998['write']===!![]?!![]:Array['isArray'](_0x394998['write'])?_0x394998['write']:[]),_0x394998['env']!==void 0x0&&(_0x467e42['env']=_0x394998['env']===!![]?!![]:Array['isArray'](_0x394998['env'])?_0x394998['env']:[]),_0x394998['run']!==void 0x0&&(_0x467e42['run']=_0x394998['run']===!![]?!![]:Array['isArray'](_0x394998['run'])?_0x394998['run']:[]),_0x394998['ffi']!==void 0x0&&(_0x467e42['ffi']=_0x394998['ffi']===!![]?!![]:Array['isArray'](_0x394998['ffi'])?_0x394998['ffi']:[]),_0x394998['sys']!==void 0x0&&(_0x467e42['sys']=_0x394998['sys']===!![]?!![]:Array['isArray'](_0x394998['sys'])?_0x394998['sys']:[]),_0x394998['hrtime']!==void 0x0&&(_0x467e42['hrtime']=_0x394998['hrtime']),_0x467e42;}['normalize'](_0x4b8d74){return _0x4b8d74===!![]?[]:Array['isArray'](_0x4b8d74)?_0x4b8d74:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x3f9941){return join(this['libDir'],_0x3f9941+'@*');}['getReadPaths'](){let _0x53fe03=this['getImports']();_0x53fe03['includes']('*')&&(_0x53fe03=Object['keys'](this['platformImports']));let _0x21aa65=[];console['log']('[Permissions] Building package path patterns for imports:',_0x53fe03);for(let _0x416a71 of _0x53fe03){let _0x914f27=this['getLibPattern'](_0x416a71);_0x21aa65['push'](_0x914f27),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x416a71+'\x20->\x20'+_0x914f27);}return console['log']('[Permissions] Final package path patterns:',_0x21aa65),_0x21aa65;}['buildImportMap'](_0x8a61c2){let _0x950175=this['getImports'](),_0x129e9f=_0x950175['includes']('*')?Object['keys'](_0x8a61c2):_0x950175;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x129e9f);let _0x36125c={};for(let _0xc1e72d of _0x129e9f)if(_0x8a61c2[_0xc1e72d])_0x36125c[_0xc1e72d]=_0x8a61c2[_0xc1e72d],console['log']('[ImportMap]\x20'+_0xc1e72d+'\x20->\x20'+_0x8a61c2[_0xc1e72d]+'\x20(from\x20platform)');else try{let _0x24d85e=z(),_0x383701=join(_0x24d85e['cwd'](),this['libDir']),_0x5bc180=!0x1;try{for(let _0x4b0a54 of _0x24d85e['readDirSync'](_0x383701))if(_0x4b0a54['isDirectory']&&(_0x4b0a54['name']===_0xc1e72d||_0x4b0a54['name']['startsWith'](_0xc1e72d+'@'))){let _0xd42ee0=join(_0x24d85e['cwd'](),this['libDir'],_0x4b0a54['name'],'index.js')['replace'](/\\/g,'/'),_0x25d9ed=new URL('file:///'+_0xd42ee0)['href'];_0x36125c[_0xc1e72d]=_0x25d9ed,console['log']('[ImportMap]\x20'+_0xc1e72d+'\x20->\x20'+_0x25d9ed+'\x20(from\x20lib)'),_0x5bc180=!0x0;break;}}catch{}_0x5bc180||console['warn']('[ImportMap]\x20Package\x20'+_0xc1e72d+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x368719){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0xc1e72d+':',_0x368719);}return _0x36125c;}['validateServerImports'](_0x12b62b){let _0x2755d5=this['manifest']['name']||this['manifest']['id'],_0x4b1e77=this['manifest']['metadata']?.['serverPath'],_0x127611=_0x29e6dd=>_0x29e6dd['replace'](/\\/g,'/'),_0x160524=z(),_0x1006f3=_0x1b6cf2=>{try{return _0x160524['statSync'](_0x1b6cf2),!0x0;}catch{return![];}},_0xb0f652=_0x4b1e77?_0x127611(_0x4b1e77):void 0x0;if(!_0xb0f652){let _0x2dc5d8=[_0x12b62b+'/service/server.js',_0x12b62b+'/service/server.ts',_0x12b62b+'/'+_0x2755d5+'/server.js',_0x12b62b+'/'+_0x2755d5+'/server.ts',_0x12b62b+'/server.js',_0x12b62b+'/server.ts']['map'](_0x127611);for(let _0x417310 of _0x2dc5d8)if(_0x1006f3(_0x417310)){_0xb0f652=_0x417310;break;}}if(!_0xb0f652)return{'valid':![],'violations':['Failed to locate server module']};let _0x315a6c='';try{_0x315a6c=_0x160524['readTextFileSync'](_0xb0f652);}catch{return{'valid':![],'violations':['Failed to read server module']};}let _0x4b39e9=this['getImports']();if(_0x4b39e9['includes']('*'))return{'valid':!![],'violations':[]};let _0x33ce35=_0x4b39e9,_0x533769=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x3610e6=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x52b206=/\bimport\s*['"]([^'"]+)['"]/g,_0x1a899f=[],_0x356266=new Set(),_0x34b233=_0x47de81=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x47de81),_0x4f9908=_0x44a568=>{let _0x2b14f3=_0x44a568;if(_0x2b14f3['startsWith']('./')||_0x2b14f3['startsWith']('../')||_0x2b14f3['startsWith']('/')||_0x2b14f3['startsWith']('file://')||!_0x34b233(_0x44a568)||_0x356266['has'](_0x44a568))return;_0x356266['add'](_0x44a568),_0x2b14f3['startsWith']('npm:')&&(_0x2b14f3=_0x2b14f3['substring'](0x4)),_0x2b14f3['includes']('@')&&!_0x2b14f3['startsWith']('@')&&(_0x2b14f3=_0x2b14f3['split']('@')[0x0]);let _0x427505=_0x2b14f3['split']('/')[0x0];_0x33ce35['includes'](_0x427505)||_0x33ce35['includes'](_0x44a568)||_0x1a899f['push'](_0x44a568);},_0x2da124;for(;(_0x2da124=_0x533769['exec'](_0x315a6c))!==null;)_0x4f9908(_0x2da124[0x1]);for(;(_0x2da124=_0x3610e6['exec'](_0x315a6c))!==null;)_0x4f9908(_0x2da124[0x1]);for(;(_0x2da124=_0x52b206['exec'](_0x315a6c))!==null;)_0x4f9908(_0x2da124[0x1]);return{'valid':_0x1a899f['length']===0x0,'violations':_0x1a899f};}['validate'](_0x35adc8={}){let _0x59d506=[],_0x82e3a2=this['manifest']['permissions']||{};try{let _0x1c5007=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x1c5007);}catch{}let _0x5684bf=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x1844d8,_0x3079a8]of Object['entries'](_0x82e3a2))if(_0x1844d8==='hrtime')typeof _0x3079a8!='boolean'&&_0x59d506['push']('Permission\x20\x27'+_0x1844d8+'\x27\x20must\x20be\x20boolean');else{if(_0x1844d8==='langchain')typeof _0x3079a8!='boolean'&&(typeof _0x3079a8!='object'||_0x3079a8===null)?_0x59d506['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x3079a8=='object'&&(_0x3079a8===null||!('enabled'in _0x3079a8)||typeof _0x3079a8['enabled']!='boolean')&&_0x59d506['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x1844d8==='kv')typeof _0x3079a8!='boolean'&&_0x59d506['push']('Permission\x20\x27'+_0x1844d8+'\x27\x20must\x20be\x20boolean');else{if(_0x1844d8==='mspbots')Array['isArray'](_0x3079a8)||_0x59d506['push']('Permission\x20\x27'+_0x1844d8+'\x27\x20must\x20be\x20an\x20array');else{if(_0x1844d8==='db'){if(typeof _0x3079a8!='object'||_0x3079a8===null||Array['isArray'](_0x3079a8))_0x59d506['push']('Permission\x20\x27'+_0x1844d8+'\x27\x20must\x20be\x20an\x20object');else{let _0x22f8a5=_0x3079a8,_0x1eb69f=['user','password']['filter'](_0x426aea=>!(_0x426aea in _0x22f8a5));_0x1eb69f['length']>0x0&&_0x59d506['push']('Permission\x20\x27'+_0x1844d8+'\x27\x20missing\x20required\x20fields:\x20'+_0x1eb69f['join'](',\x20'));}}else{if(_0x1844d8==='imports')continue;_0x5684bf['has'](_0x1844d8)||typeof _0x3079a8!='boolean'&&!Array['isArray'](_0x3079a8)&&_0x59d506['push']('Permission\x20\x27'+_0x1844d8+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x17eef1=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x17eef1))_0x59d506['push']('permissions.imports must be an array');else{for(let _0x1f2620 of _0x17eef1)typeof _0x1f2620!='string'&&_0x59d506['push']('import\x20\x27'+_0x1f2620+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x59d506['length']===0x0,'errors':_0x59d506};}};function q(_0x1c1740,_0x5680da,_0x574e95){return new D(_0x1c1740,_0x5680da,_0x574e95||{});}var R=null;function I(){let _0x5c52de=globalThis['Deno'];if(!_0x5c52de)throw new Error('Deno is not available');return _0x5c52de;}async function K(){if(R)return{...R};try{let _0x3843b7=I(),_0x54d781=join(_0x3843b7['cwd'](),'deno.json'),_0x509e7d=await _0x3843b7['readTextFile'](_0x54d781);return R=JSON['parse'](_0x509e7d)['imports']||{},{...R};}catch(_0x436b96){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x436b96),{};}}var E=class{constructor(_0x209ee9,_0xd08af5={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x209ee9['appsDir'],this['platformImportsOverride']=_0x209ee9['platformImports'],this['libDir']=_0x209ee9['libDir'],this['events']=_0xd08af5);}async['create'](_0x5bbf96,_0x4ada17,_0x22737e){try{return await this['createWorker'](_0x5bbf96,_0x4ada17,_0x22737e);}catch(_0x2300a0){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x5bbf96+':',_0x2300a0),_0x2300a0;}}async['createWorker'](_0x395d91,_0x4f4306,_0x19af1d){let _0x3199ca=this['platformImportsOverride']||await K(),_0x5056be=q(_0x4f4306,this['libDir'],_0x3199ca)['validateServerImports'](this['appsDir']);if(!_0x5056be['valid']){let _0x536153=_0x5056be['violations']['filter'](_0x135e9b=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x135e9b));throw new Error('Unauthorized\x20imports\x20in\x20'+(_0x4f4306['name']||_0x4f4306['id'])+'/server.js:\x20'+_0x536153['join'](',\x20'));}let _0x200bd2=q(_0x4f4306,this['libDir'],_0x3199ca),_0x2f2d85=_0x200bd2['validate'](_0x3199ca);if(!_0x2f2d85['valid'])throw new Error('Invalid\x20config:\x20'+_0x2f2d85['errors']['join'](',\x20'));let _0xb0c6b0=_0x200bd2['buildImportMap'](_0x3199ca);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x395d91+':',_0xb0c6b0);let _0x50d828=_0x200bd2['buildPerms'](),_0x3c1c78=_0x200bd2['getReadPaths']();if(_0x50d828['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x50d828['read']);else{let _0x54de72=_0x4f4306['name']||_0x395d91,_0x3d7950=this['appsDir']+'/'+_0x54de72,_0x25889c=[_0x3d7950],_0x2dbb12=_0x4f4306['metadata']?.['serverPath'];if(_0x2dbb12&&typeof _0x2dbb12=='string')try{let _0x24549d=dirname(_0x2dbb12)['replace'](/\\/g,'/');_0x25889c['push'](_0x24549d);}catch{}_0x50d828['read']=_0x25889c,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x3d7950);}if(_0x3c1c78['length']>0x0){if(_0x50d828['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x2dc4a1=Array['isArray'](_0x50d828['read'])?_0x50d828['read']:[];_0x50d828['read']=[..._0x2dc4a1,..._0x3c1c78],console['log']('[Worker] Added package read permissions:',_0x3c1c78);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x50d828['net']||(_0x50d828['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x395d91+':',_0x50d828['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x50d828['read']===!![]?'unrestricted':Array['isArray'](_0x50d828['read'])?_0x50d828['read']['length']:0x0));let _0x37009f=await this['createImportMap'](_0x395d91,_0xb0c6b0),_0x1df9d1=await this['createLock'](_0x395d91,_0xb0c6b0),_0x17eea7={'type':'module','deno':{'permissions':{}}};_0x17eea7['deno']['namespace']=![],_0x17eea7['deno']['permissions']=_0x50d828,_0x17eea7['deno']['importMap']=_0x37009f,_0x17eea7['deno']['lock']=_0x1df9d1,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x395d91+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x37009f),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x1df9d1),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0xb0c6b0)['length']+'\x20('+(Object['keys'](_0xb0c6b0)['join'](',\x20')||'none')+')');let _0x58a9ea={'worker':new Worker(_0x19af1d,_0x17eea7),'appId':_0x395d91,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x4f4306,'importMapPath':_0x37009f,'lockfilePath':_0x1df9d1};return this['workers']['set'](_0x395d91,_0x58a9ea),this['events']['onCreate']?.(_0x58a9ea),_0x58a9ea;}async['createLock'](_0x4554f1,_0xe674c1){let _0x4f6035=I(),_0x5b0af8=join(_0x4f6035['cwd'](),'storage','temp','lockfiles');await _0x4f6035['mkdir'](_0x5b0af8,{'recursive':!![]});let _0x4c5ad4=_0x4554f1+'-'+Date['now']()+'.lock',_0x52b97e=join(_0x5b0af8,_0x4c5ad4),_0x40bab9={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x1590b3,_0x14f184]of Object['entries'](_0xe674c1))if(_0x14f184['startsWith']('npm:'))_0x14f184['replace']('npm:',''),_0x40bab9['packages']['specifiers'][_0x1590b3]=_0x14f184;else _0x14f184['startsWith']('file://')&&(_0x40bab9['packages']['specifiers'][_0x1590b3]=_0x14f184);let _0xbdbce4=JSON['stringify'](_0x40bab9,null,0x2);return await _0x4f6035['writeTextFile'](_0x52b97e,_0xbdbce4),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x52b97e),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0xe674c1)['length']+'):',Object['keys'](_0xe674c1)),_0x52b97e;}async['createImportMap'](_0xfe8131,_0x45c515){let _0x327150=I(),_0x5819af=join(_0x327150['cwd'](),'storage','temp','importmaps');await _0x327150['mkdir'](_0x5819af,{'recursive':!![]});let _0x40c2d3=_0xfe8131+'-'+Date['now']()+'.json',_0x1d4cf2=join(_0x5819af,_0x40c2d3),_0x5c8ebe=JSON['stringify']({'imports':_0x45c515,'scopes':{}},null,0x2);return await _0x327150['writeTextFile'](_0x1d4cf2,_0x5c8ebe),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x1d4cf2),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x45c515)['length']+'):',Object['keys'](_0x45c515)['join'](',\x20')||'none'),_0x1d4cf2;}['get'](_0x48b09e){return this['workers']['get'](_0x48b09e);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x5eef5f,_0x4e91ca){let _0x2a8af3=this['workers']['get'](_0x5eef5f);if(!_0x2a8af3)return;let _0x44e465=_0x2a8af3['status'];_0x2a8af3['status']=_0x4e91ca,_0x4e91ca==='running'&&_0x44e465==='starting'?this['events']['onReady']?.(_0x2a8af3):_0x4e91ca==='crashed'&&this['events']['onCrash']?.(_0x2a8af3);}['touch'](_0x498941){let _0x18f0bd=this['workers']['get'](_0x498941);_0x18f0bd&&(_0x18f0bd['lastUsed']=Date['now']());}async['stop'](_0x906a5f){let _0x1284e4=this['workers']['get'](_0x906a5f);if(_0x1284e4)try{_0x1284e4['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x1284e4['worker']['terminate'](),_0x1284e4['status']='stopped',this['events']['onStop']?.(_0x1284e4),_0x1284e4['importMapPath']&&await this['cleanupImportMap'](_0x1284e4['importMapPath']),_0x1284e4['lockfilePath']&&await this['cleanupLock'](_0x1284e4['lockfilePath']);}catch(_0x5e2900){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x906a5f+':',_0x5e2900);}finally{this['workers']['delete'](_0x906a5f);}}async['cleanupImportMap'](_0x4674f8){try{await I()['remove'](_0x4674f8),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x4674f8);}catch(_0x139ac0){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x4674f8,_0x139ac0);}}async['cleanupLock'](_0x5f3550){try{await I()['remove'](_0x5f3550),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x5f3550);}catch(_0xf2d148){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x5f3550,_0xf2d148);}}async['stopAll'](){let _0x17a8d2=Array['from'](this['workers']['keys']());await Promise['all'](_0x17a8d2['map'](_0x1987c5=>this['stop'](_0x1987c5)));}async['restart'](_0x1c897c,_0x2cbdb4){let _0x1e162c=this['workers']['get'](_0x1c897c);if(!_0x1e162c)throw new Error('Worker\x20'+_0x1c897c+'\x20not\x20found');let _0xe655a0=_0x1e162c['manifest'];return await this['stop'](_0x1c897c),await this['create'](_0x1c897c,_0xe655a0,_0x2cbdb4);}['checkHealth'](_0x4a77c9){let _0x29b2a3=this['workers']['get'](_0x4a77c9);if(!_0x29b2a3)return{'healthy':![],'reason':'Not\x20found'};if(_0x29b2a3['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x29b2a3['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x568692=Date['now']()-_0x29b2a3['lastUsed'],_0x24441e=0x708*0x3e8;return _0x568692>_0x24441e?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x568692/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x43ec75=0x708*0x3e8,_0x31ca8a){let _0x288da3=Date['now'](),_0x220b56=[];for(let [_0x5b6e1d,_0x45260a]of this['workers']['entries']()){let _0x4fe8f3=_0x288da3-_0x45260a['lastUsed'];_0x4fe8f3>_0x43ec75&&_0x220b56['push']({'appId':_0x5b6e1d,'idle':_0x4fe8f3});}_0x220b56['sort']((_0x5cd549,_0x450c0f)=>_0x450c0f['idle']-_0x5cd549['idle']);let _0x2cf006=_0x31ca8a?_0x220b56['slice'](0x0,_0x31ca8a)['map'](_0x495e58=>_0x495e58['appId']):_0x220b56['map'](_0x1854b4=>_0x1854b4['appId']);for(let _0x247a8c of _0x2cf006)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x247a8c),await this['stop'](_0x247a8c);}['stats'](){let _0x925fa={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x191238=Date['now']();for(let _0x173b19 of this['workers']['values']())_0x925fa['byStatus'][_0x173b19['status']]++,_0x925fa['workers']['push']({'appId':_0x173b19['appId'],'status':_0x173b19['status'],'version':_0x173b19['version'],'lastUsed':_0x173b19['lastUsed'],'idle':_0x191238-_0x173b19['lastUsed']});return _0x925fa;}['startCleanup'](_0x237f40=0x12c*0x3e8,_0x28e982){let _0x2cd26e=setInterval(()=>{this['cleanup'](_0x28e982)['catch'](_0x463692=>{console['error']('Cleanup\x20failed:',_0x463692);});},_0x237f40);return()=>clearInterval(_0x2cd26e);}['delay'](_0x346074){return new Promise(_0x3dcd28=>setTimeout(_0x3dcd28,_0x346074));}};function W(_0xbe1095,_0x2e2c59){return new E(_0xbe1095,_0x2e2c59);}var v=f,j=class{constructor(_0x35e323,_0x1e4f02=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x35e323,this['timeout']=_0x1e4f02);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x16682c){_0x16682c['worker']['onmessage']=_0x37a4af=>{let _0x52e8a1=_0x37a4af['data'],{appId:_0x4b15b8}=_0x16682c;switch(_0x52e8a1['type']){case'ready':this['events']['onReady'](_0x4b15b8),v['info']('Worker\x20ready',{'appId':_0x4b15b8,'version':_0x16682c['version']});break;case'log':{let {level:_0x3920b3='info',message:_0x46eac0,meta:_0x1c58e4}=_0x52e8a1,_0x4a3794={..._0x1c58e4||{},'appId':_0x4b15b8,'version':_0x16682c['version']};this['events']['onLog'](_0x4b15b8,_0x3920b3,_0x46eac0,_0x4a3794);break;}case'result':{let {reqId:_0x5593ae,ok:_0x3872cb,response:_0x3022e7,error:_0x3f5ef2}=_0x52e8a1,_0x1a9eba=this['pending']['get'](_0x5593ae);if(!_0x1a9eba){v['warn']('Unknown\x20request',{'appId':_0x4b15b8,'reqId':_0x5593ae});return;}if(this['pending']['delete'](_0x5593ae),_0x3872cb&&_0x3022e7)_0x1a9eba['resolve'](_0x3022e7);else{let _0x2b8190=new Error(_0x3f5ef2?.['message']||'Worker\x20error');_0x2b8190['stack']=_0x3f5ef2?.['stack'],_0x1a9eba['reject'](_0x2b8190);}this['events']['onResult'](_0x4b15b8,_0x5593ae,_0x3022e7||_0x3f5ef2);break;}default:v['debug']('Unknown\x20message',{'appId':_0x4b15b8,'type':_0x52e8a1['type']});}},_0x16682c['worker']['onerror']=_0x594b06=>{let {appId:_0x5f5217}=_0x16682c;v['error']('Worker\x20error',{'appId':_0x5f5217,'message':_0x594b06['message'],'lineno':_0x594b06['lineno'],'filename':_0x594b06['filename']}),_0x16682c['status']='crashed',this['rejectPending'](_0x5f5217,new Error('Worker\x20'+_0x5f5217+'\x20crashed:\x20'+_0x594b06['message'])),_0x594b06['preventDefault']();},_0x16682c['worker']['onmessageerror']=_0x4efd93=>{let {appId:_0x2e4f60}=_0x16682c;v['error']('Message\x20error',{'appId':_0x2e4f60,'data':_0x4efd93['data']}),_0x16682c['status']='crashed',_0x4efd93['preventDefault']();};}['sendInit'](_0x21232a,_0x271fb6,_0x321bd8,_0x3d6524){_0x21232a['worker']['postMessage']({'type':'init','appId':_0x21232a['appId'],'manifest':_0x321bd8,'appsDir':_0x271fb6,'serverPath':_0x3d6524});}async['sendInvoke'](_0x12cec7,_0x2e8b0d){let _0x40dd3b=this['nextId'](),_0x12bd39=_0x12cec7['appId'],_0x3e8cae=new Promise((_0x4d10a5,_0x560509)=>{let _0x3c9aad=setTimeout(()=>{this['pending']['delete'](_0x40dd3b),_0x560509(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x40dd3b,{'resolve':_0x596563=>{clearTimeout(_0x3c9aad),_0x4d10a5(_0x596563);},'reject':_0x3c7151=>{clearTimeout(_0x3c9aad),_0x560509(_0x3c7151);},'timestamp':Date['now'](),'appId':_0x12bd39});});return _0x12cec7['worker']['postMessage']({'type':'invoke','appId':_0x12cec7['appId'],'reqId':_0x40dd3b,'payload':_0x2e8b0d}),await _0x3e8cae;}['rejectPending'](_0x31faf7,_0x49ed6c){let _0x74f5d3=0x0;for(let [_0xdc60ac,_0x15bbc6]of this['pending']['entries']())_0x15bbc6['appId']===_0x31faf7&&(this['pending']['delete'](_0xdc60ac),_0x15bbc6['reject'](_0x49ed6c),_0x74f5d3++);_0x74f5d3>0x0&&v['warn']('Rejected\x20'+_0x74f5d3+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x31faf7});}['cleanupTimeout'](){let _0x135ecd=Date['now']();for(let [_0x5c0b99,_0x48371e]of this['pending']['entries']())_0x135ecd-_0x48371e['timestamp']>this['timeout']&&(this['pending']['delete'](_0x5c0b99),_0x48371e['reject'](new Error('Request\x20'+_0x5c0b99+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x29259f){let _0x34b954=0x0;for(let _0xb1ea30 of this['pending']['values']())_0xb1ea30['appId']===_0x29259f&&_0x34b954++;return _0x34b954;}['startCleanup'](_0x8cf77d=0x2710){let _0x1f1770=setInterval(()=>{this['cleanupTimeout']();},_0x8cf77d);return()=>clearInterval(_0x1f1770);}};function S(_0x117cc9,_0xaf9a53){return new j(_0x117cc9,_0xaf9a53);}var Q=class{constructor(_0x45b1e2={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x45b1e2['logger']||f,this['config']={'appsDir':_0x45b1e2['appsDir']||this['getAppsDir'](),'scriptUrl':_0x45b1e2['scriptUrl']||this['getScriptUrl'](),'timeout':_0x45b1e2['timeout']||0x78*0x3e8,'autoCleanup':_0x45b1e2['autoCleanup']??!![],'cleanupInterval':_0x45b1e2['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x45b1e2['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x45b1e2['maxWorkers'],'reuseWorkers':_0x45b1e2['reuseWorkers']??!![],'workerReuseStrategy':_0x45b1e2['workerReuseStrategy']||'lru','enableQueue':_0x45b1e2['enableQueue']??!![],'maxQueueSize':_0x45b1e2['maxQueueSize']||0x64,'queueTimeout':_0x45b1e2['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x1941e0=>this['logger']['info']('Worker\x20created',{'appId':_0x1941e0['appId'],'v':_0x1941e0['version']}),'onReady':_0x569a59=>this['lifecycle']['updateStatus'](_0x569a59['appId'],'running'),'onCrash':_0x1a3144=>this['logger']['error']('Worker\x20crashed',{'appId':_0x1a3144['appId'],'v':_0x1a3144['version']}),'onStop':_0x468739=>this['logger']['info']('Worker\x20stopped',{'appId':_0x468739['appId'],'v':_0x468739['version']})}),this['messaging']=S({'onReady':_0x671d3f=>this['lifecycle']['updateStatus'](_0x671d3f,'running'),'onLog':(_0x27e21c,_0x5e3c61,_0x10ab77,_0x352184)=>{let _0x175457={..._0x352184||{},'appId':_0x27e21c};switch(_0x5e3c61){case'error':this['logger']['error'](_0x10ab77,_0x175457);break;case'warn':this['logger']['warn'](_0x10ab77,_0x175457);break;case'debug':this['logger']['debug'](_0x10ab77,_0x175457);break;default:this['logger']['info'](_0x10ab77,_0x175457);break;}},'onResult':(_0x1fe51f,_0x1330f8,_0x5359ee)=>{this['logger']['debug']('Result\x20received',{'appId':_0x1fe51f,'reqId':_0x1330f8});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0xb6d15d['cwd'](),'apps');}['getScriptUrl'](){let _0x8162c=import.meta.url,_0xcde1b0=_0x8162c['endsWith']('.js')||_0x8162c['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0xcde1b0,_0x8162c)['href'];}async['ensure'](_0x5d18cf){let {id:_0x355c4b}=_0x5d18cf,_0xc657f=this['lifecycle']['get'](_0x355c4b);if(_0xc657f){let _0x388b7e=this['lifecycle']['checkHealth'](_0x355c4b);if(_0x388b7e['healthy'])return this['lifecycle']['touch'](_0x355c4b),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x355c4b}),_0xc657f;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x355c4b,'reason':_0x388b7e['reason']}),await this['lifecycle']['stop'](_0x355c4b);}for(;;){let _0x7c9794=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x7c9794>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x7c9794,'max':this['config']['maxWorkers'],'appId':_0x355c4b}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x5d18cf);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x14ed79=await this['loadManifest'](_0x355c4b,_0x5d18cf['manifest']),_0x5aeecc=await this['lifecycle']['create'](_0x355c4b,_0x14ed79,this['config']['scriptUrl']),_0x50eb2c=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x50eb2c>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x50eb2c,'max':this['config']['maxWorkers'],'appId':_0x355c4b}),await this['lifecycle']['stop'](_0x355c4b),this['config']['enableQueue'])return await this['waitSlot'](_0x5d18cf);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x50eb2c+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x5aeecc);let _0x1244a3=_0x14ed79['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x5aeecc,this['config']['appsDir'],_0x14ed79,_0x1244a3),this['logger']['info']('Worker\x20created',{'appId':_0x355c4b,'v':_0x5aeecc['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x5aeecc;}async['evictIdle'](){let _0x374ef0=this['lifecycle']['getAll']();if(_0x374ef0['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x2aa006=[..._0x374ef0];this['config']['workerReuseStrategy']==='lru'?_0x2aa006['sort']((_0x18a4b9,_0x555ad8)=>_0x18a4b9['lastUsed']-_0x555ad8['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x2aa006['sort']((_0x14e68c,_0x5487ed)=>_0x14e68c['version']-_0x5487ed['version']);let _0x557476=null;for(let _0x309c1f of _0x2aa006)if(this['messaging']['getAppCount'](_0x309c1f['appId'])===0x0){_0x557476=_0x309c1f;break;}if(!_0x557476&&_0x2aa006['length']>0x0&&(_0x557476=_0x2aa006['reduce']((_0x5a82ab,_0x17aff3)=>{let _0x610513=this['messaging']['getAppCount'](_0x5a82ab['appId']);return this['messaging']['getAppCount'](_0x17aff3['appId'])<_0x610513?_0x17aff3:_0x5a82ab;})),_0x557476){let _0x3081fe=this['messaging']['getAppCount'](_0x557476['appId']);return _0x3081fe>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x557476['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x557476['lastUsed'],'pendingRequests':_0x3081fe}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x557476['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x557476['lastUsed']}),await this['lifecycle']['stop'](_0x557476['appId']),!![];}return![];}['waitSlot'](_0x57a199){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x125e30,_0x50a38f)=>{let _0x1ea0af={'info':_0x57a199,'resolve':_0x125e30,'reject':_0x50a38f,'timestamp':Date['now']()};this['requestQueue']['push'](_0x1ea0af),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x57a199['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x52c868=setTimeout(()=>{let _0x1ba39e=this['requestQueue']['indexOf'](_0x1ea0af);_0x1ba39e!==-0x1&&(this['requestQueue']['splice'](_0x1ba39e,0x1),_0x50a38f(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x1ea0af['resolve']=_0x45ddfd=>{clearTimeout(_0x52c868),_0x125e30(_0x45ddfd);},_0x1ea0af['reject']=_0x411fe2=>{clearTimeout(_0x52c868),_0x50a38f(_0x411fe2);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0xf8f518=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0xf8f518>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x5c3b39=this['requestQueue']['shift']();if(!_0x5c3b39)break;try{let _0x5ed6b1=await this['ensure'](_0x5c3b39['info']);_0x5c3b39['resolve'](_0x5ed6b1);}catch(_0x201a88){_0x5c3b39['reject'](_0x201a88);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x42e37f,_0x1ebf90){let _0x4484a8=this['config']['appsDir']['replace'](/\\/g,'/'),_0x2ddfa7=async _0x2906d8=>{try{let _0x23d929=globalThis['Deno'];if(!_0x23d929)return null;let _0x12faa8=await _0x23d929['readTextFile'](_0x2906d8);return JSON['parse'](_0x12faa8);}catch{return null;}};if(_0x1ebf90?.['name']){let _0x1279c0=await _0x2ddfa7(_0x4484a8+'/'+_0x1ebf90['name']+'/manifest.json');if(_0x1279c0)return _0x1279c0;}let _0x36a4fd=await _0x2ddfa7(_0x4484a8+'/'+_0x42e37f+'/manifest.json');if(_0x36a4fd)return _0x36a4fd;try{let _0x35ecf2=globalThis['Deno'];if(_0x35ecf2)for await(let _0x53498c of _0x35ecf2['readDir'](_0x4484a8)){if(!_0x53498c['isDirectory'])continue;let _0x23b0e6=_0x4484a8+'/'+_0x53498c['name']+'/manifest.json',_0x2774ab=await _0x2ddfa7(_0x23b0e6);if(_0x2774ab&&(_0x2774ab['id']===_0x42e37f||_0x1ebf90?.['name']&&_0x2774ab['name']===_0x1ebf90['name']))return _0x2774ab;}}catch(_0x1e48f0){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x42e37f,'error':_0x1e48f0['message']});}return _0x1ebf90||{'id':_0x42e37f,'name':_0x42e37f,'version':'1.0.0'};}async['invoke'](_0x5bf6e7){let _0x41339a=_0x5bf6e7['ctx']['app']['id'],_0xa00440=_0x5bf6e7['ctx']['app']['name'];try{let _0x146596={'id':_0x41339a,'manifest':{'id':_0x41339a,'name':_0xa00440}},_0x14a45f=await this['ensure'](_0x146596);if(_0x14a45f['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x41339a}),await this['restart'](_0x41339a);let _0x54510e=await this['ensure'](_0x146596);return this['lifecycle']['touch'](_0x41339a),await this['messaging']['sendInvoke'](_0x54510e,_0x5bf6e7);}return this['lifecycle']['touch'](_0x41339a),await this['messaging']['sendInvoke'](_0x14a45f,_0x5bf6e7);}catch(_0x19022a){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x41339a,'error':_0x19022a['message'],'stack':_0x19022a['stack']}),_0x19022a;}}async['stop'](_0x4c657b){await this['lifecycle']['stop'](_0x4c657b),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x408454){return await this['lifecycle']['restart'](_0x408454,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x57f80f=>({'appId':_0x57f80f['appId'],'status':_0x57f80f['status'],'version':_0x57f80f['version'],'lastUsed':_0x57f80f['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x488012=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x3cf731=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x488012(),_0x3cf731();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x1353e7=>{_0x1353e7?(await this['stop'](_0x1353e7),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x1353e7})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x20c226){return new Q(_0x20c226);}var M=null;function be(_0x500546){M=ee(_0x500546);}function k(){if(!M)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return M;}async function Pe(_0x5dbff4){return await k()['ensure'](_0x5dbff4);}async function xe(_0x7a7d93){return await k()['invoke'](_0x7a7d93);}function Ie(_0x4a5958){k()['stop'](_0x4a5958)['catch'](_0x489615=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x4a5958,'error':_0x489615['message']});});}function Re(){k()['stopAll']()['catch'](_0x3a559a=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x3a559a['message']});});}function We(){return k()['getStats']();}function Se(){return M;}async function O(_0x11a7d0){await k()['stop'](_0x11a7d0);}async function Me(){await k()['stopAll']();}function Ae(_0x5ad687){let _0x4825f5=_0x5ad687&&typeof _0x5ad687=='object'?_0x5ad687:null;if(_0x4825f5&&'user'in _0x4825f5)return _0x4825f5['user'];}function U(_0x2ed31b){let _0x507473=_0x2ed31b&&typeof _0x2ed31b=='object'?_0x2ed31b:null;if(!_0x507473)return{};let _0x10dd3b={};for(let [_0x3f340c,_0x54e24e]of Object['entries'](_0x507473))_0x3f340c!=='user'&&(_0x10dd3b[_0x3f340c]=_0x54e24e);return _0x10dd3b;}function H(_0x12b29c){return _0x12b29c?{'id':_0x12b29c['manifest']?.['id']||_0x12b29c['id']||'','name':_0x12b29c['manifest']?.['name']||'','version':_0x12b29c['manifest']?.['version']||'','description':_0x12b29c['manifest']?.['description']||'','icon':_0x12b29c['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x301267){return _0x301267?.['permissions']||_0x301267?.['manifest']?.['permissions']||{};}function F(_0x36e4dc){return _0x36e4dc?.['manifest']?.['metadata']||{};}function Ce(_0x3d53c5){return _0x3d53c5?{'appId':_0x3d53c5['id'],'appName':_0x3d53c5['manifest']?.['name']}:{};}function N(_0x2d8194,_0x27ec60={}){let {appInfo:_0x426849=null,status:_0x1c8a06=0x1f4,defaultMessage:_0x59cf9b='Internal\x20Server\x20Error'}=_0x27ec60,_0x31223f={'error':_0x59cf9b,'message':_0x2d8194?.['message']||_0x59cf9b};return _0x426849&&(_0x31223f['appId']=_0x426849['id'],_0x31223f['appName']=_0x426849['manifest']?.['name']),_0x2d8194?.['message']?.['includes']('crashed')&&(_0x31223f['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x1c8a06,'body':_0x31223f};}function qe(_0xbd6f66){return _0xbd6f66?.['message']?.['includes']('crashed')||![];}function J(_0x5ea720){if(_0x5ea720)try{return JSON['parse'](_0x5ea720);}catch{return _0x5ea720;}}function B(_0x5b5ce3){try{let _0x2cffd4=new URL(_0x5b5ce3),_0x3b1179={};for(let _0x8d3ab7 of _0x2cffd4['searchParams']['keys']()){let _0x1b7bf6=_0x2cffd4['searchParams']['getAll'](_0x8d3ab7)['map'](_0x524f12=>_0x524f12);_0x1b7bf6['length']<=0x1?_0x3b1179[_0x8d3ab7]=_0x1b7bf6[0x0]??'':_0x3b1179[_0x8d3ab7]=_0x1b7bf6;}return _0x3b1179;}catch{return{};}}function Le(_0x5938ac){try{let _0xbdd8f0=new URL(_0x5938ac)['pathname']['split']('/'),_0x21abb0=_0xbdd8f0['indexOf']('apps')+0x1;return _0xbdd8f0[_0x21abb0]||'';}catch{let _0x300795=_0x5938ac['split']('/'),_0x1a1232=_0x300795['indexOf']('apps')+0x1;return _0x300795[_0x1a1232]||'';}}function ze(_0x317470,_0x59664d){let _0x555a40=_0x317470['replace']('/apps/'+_0x59664d,'');return _0x555a40['startsWith']('/api')&&(_0x555a40=_0x555a40['substring'](0x4)||'/'),_0x555a40;}function Oe(_0xf6f0bd,_0x49aa8b){let _0x2a5672=_0xf6f0bd['replace']('/apps/'+_0x49aa8b,'');return(!_0x2a5672||_0x2a5672==='/')&&(_0x2a5672='/index.html'),_0x2a5672;}async function Ue(_0x5e2122,_0x19252e){return await _0x19252e(_0x5e2122);}function _(_0x2d357e){return _0x2d357e['split']('/')['filter'](_0xbccd20=>_0xbccd20['length']>0x0);}function te(_0x3449ed){try{return decodeURIComponent(_0x3449ed);}catch{return _0x3449ed;}}function re(_0x13ba50,_0x5a8dc6){let _0x366475=_(_0x13ba50),_0x37c438=_(_0x5a8dc6),_0x5063b5={},_0x4a536f=0x0,_0x4817be=0x0;for(;_0x4a536f<_0x366475['length']&&_0x4817be<_0x37c438['length'];){let _0x2f4686=_0x366475[_0x4a536f],_0x485dca=_0x37c438[_0x4817be];if(_0x2f4686==='*')break;if(_0x2f4686['startsWith'](':')){let _0xd16b11=_0x2f4686['slice'](0x1);_0xd16b11&&(_0x5063b5[_0xd16b11]=te(_0x485dca)),_0x4a536f++,_0x4817be++;continue;}if(_0x2f4686!==_0x485dca)return{};_0x4a536f++,_0x4817be++;}return _0x4a536f===_0x366475['length']||_0x4a536f===_0x366475['length']-0x1&&_0x366475[_0x4a536f]==='*',_0x5063b5;}async function He(_0x68553a,_0x2ba370,_0x4c4072,_0x26c5cc,_0x5a519d=void 0x0,_0x4997c9){let _0x1246e8=await _0x2ba370['text'](),_0x507b43=J(_0x1246e8),_0x16138b=B(_0x2ba370['url']),_0x321923={...F(_0x68553a),'user':_0x5a519d},_0x22873b=U(_0x321923),_0x3320e0=_0x4997c9?re(_0x4997c9,_0x2ba370['path']):{};return{'app':H(_0x68553a),'permissions':T(_0x68553a),'user':_0x5a519d,'metadata':_0x22873b,'body':_0x507b43,'query':_0x16138b,'params':_0x3320e0,'method':_0x4c4072,'pathname':_0x26c5cc,'requestUrl':_0x2ba370['url'],'headers':Object['fromEntries'](_0x2ba370['raw']['headers']['entries']())};}function Te(_0x1c925a){return{'method':_0x1c925a['method'],'pathname':_0x1c925a['pathname'],'ctx':_0x1c925a};}function Fe(_0x57c35d,_0x205e2a){let {status:_0x1c9cd1=0xc8,headers:_0x90872b={},body:_0x34b789,type:_0x4a4ff4}=_0x57c35d??{};return _0x4a4ff4==='raw'?new globalThis['Response'](String(_0x34b789??''),{'status':_0x1c9cd1,'headers':_0x90872b}):_0x205e2a(_0x34b789,_0x1c9cd1);}function Ne(_0x3086b0,_0x51c8ca=null){return N(_0x3086b0,{'appInfo':_0x51c8ca});}var V=f;async function Ve(_0x5804b8){_0x5804b8?(await O(_0x5804b8),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x5804b8)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x13e498,_0x2808c5){let _0x1535f8=Object['fromEntries'](Object['entries'](_0x13e498['headers']||{})['map'](([_0x430003,_0x183db4])=>[_0x430003['toLowerCase'](),_0x183db4]));return{'id':_0x13e498['app']['id']||_0x2808c5['appId']||'','name':_0x13e498['app']['name']||'','version':_0x13e498['app']['version']||'','description':_0x13e498['app']['description']||'','metadata':{..._0x13e498['metadata'],'permissions':_0x13e498['permissions']},'body':_0x13e498['body'],'query':_0x13e498['query'],'params':_0x13e498?.['params'],'method':_0x13e498['method'],'pathname':_0x13e498['pathname'],'requestUrl':_0x13e498['requestUrl'],'user':_0x13e498['user'],'headers':_0x1535f8};}var L=class{constructor(_0x4a3ed7){this['handle']=null,(this['config']=_0x4a3ed7,this['logger']=_0x4a3ed7['logger']||f,this['lifecycle']=W({'appsDir':_0x4a3ed7['appsDir'],'timeout':_0x4a3ed7['timeout'],'platformImports':_0x4a3ed7['platformImports'],'libDir':_0x4a3ed7['libDir']},{'onCreate':_0xa880a3=>this['logger']['info']('Worker\x20created',{'appId':_0xa880a3['appId']}),'onReady':_0x5dd055=>{this['lifecycle']['updateStatus'](_0x5dd055['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x5dd055['appId']});},'onCrash':_0x1a0dce=>this['logger']['error']('Worker\x20crashed',{'appId':_0x1a0dce['appId']}),'onStop':_0x1ad42a=>this['logger']['info']('Worker\x20stopped',{'appId':_0x1ad42a['appId']})}),this['messaging']=S({'onReady':_0x1002bd=>this['lifecycle']['updateStatus'](_0x1002bd,'running'),'onLog':(_0x3fec18,_0x313294,_0x407527,_0x5eeace)=>{(this['logger'][_0x313294]||this['logger']['info'])['call'](this['logger'],_0x407527,_0x5eeace);},'onResult':()=>{}},_0x4a3ed7['timeout']||0x1d4c0));}async['create'](_0x5b2657){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x3ae6c0=await this['lifecycle']['create'](this['config']['appId'],_0x5b2657,this['config']['scriptUrl']);this['messaging']['setup'](_0x3ae6c0),this['messaging']['sendInit'](_0x3ae6c0,this['config']['appsDir'],_0x5b2657,this['config']['serverPath']),this['handle']=_0x3ae6c0,await this['waitForReady']();}async['waitForReady'](_0x348aea=0x2710){let _0x32aa90=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x32aa90>_0x348aea)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x1a40e8=>setTimeout(_0x1a40e8,0x64));}}async['invoke'](_0x18e2b2){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x18e2b2);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x180d74){return new L(_0x180d74);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,S as createMessaging,q as createPermManager,He as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,H as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,U as extractMetadata,T as extractPermissions,Oe as extractStatic,Ae as extractUser,Ue as findApp,Ce as getAppLogMeta,Ze as getCacheSize,Se as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Me as stopAllWorkers,O as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};