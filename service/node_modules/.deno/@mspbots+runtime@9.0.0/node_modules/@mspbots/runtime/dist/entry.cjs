'use strict';function c(_0x4eb221,_0x12b506){let _0x20eb9d=Object['fromEntries'](Object['entries'](_0x4eb221['headers']||{})['map'](([_0x1007ed,_0x57824b])=>[_0x1007ed['toLowerCase'](),_0x57824b]));return{'id':_0x4eb221['app']['id']||_0x12b506['appId']||'','name':_0x4eb221['app']['name']||'','version':_0x4eb221['app']['version']||'','description':_0x4eb221['app']['description']||'','metadata':{..._0x4eb221['metadata'],'permissions':_0x4eb221['permissions']},'body':_0x4eb221['body'],'query':_0x4eb221['query'],'params':_0x4eb221?.['params'],'method':_0x4eb221['method'],'pathname':_0x4eb221['pathname'],'requestUrl':_0x4eb221['requestUrl'],'user':_0x4eb221['user'],'headers':_0x20eb9d};}function f(_0x94b3ff){return _0x94b3ff['split']('/')['filter'](_0x146def=>_0x146def['length']>0x0);}function P(_0x2b9ba5,_0x3c4c5a){let _0x495e6a=f(_0x2b9ba5),_0x41fda6=f(_0x3c4c5a),_0x56d8e5=0x0,_0x57bc09=0x0;for(;_0x56d8e5<_0x495e6a['length']&&_0x57bc09<_0x41fda6['length'];){let _0x5e2e4a=_0x495e6a[_0x56d8e5],_0x397557=_0x41fda6[_0x57bc09];if(_0x5e2e4a==='*')return!![];if(_0x5e2e4a['startsWith'](':')){_0x56d8e5++,_0x57bc09++;continue;}if(_0x5e2e4a!==_0x397557)return![];_0x56d8e5++,_0x57bc09++;}return _0x56d8e5===_0x495e6a['length']&&_0x57bc09===_0x41fda6['length']||_0x56d8e5===_0x495e6a['length']-0x1&&_0x495e6a[_0x56d8e5]==='*';}function m(_0x10bcfb,_0xf6d88f,_0x27def6){let _0x52122d=_0xf6d88f+'\x20'+_0x27def6;if(_0x10bcfb[_0x52122d])return{'handler':_0x10bcfb[_0x52122d],'routePattern':_0x27def6};let _0x38b380=[];_0x27def6['startsWith']('/api')?_0x38b380['push'](_0x27def6['substring'](0x4)||'/'):_0x38b380['push']('/api'+_0x27def6),_0x38b380['push'](_0x27def6);for(let _0x454b4f of _0x38b380)for(let _0x2a9fd9 of Object['keys'](_0x10bcfb)){if(!_0x2a9fd9['startsWith'](_0xf6d88f+'\x20'))continue;let _0x2dba06=_0x2a9fd9['substring'](_0xf6d88f['length']+0x1);if(P(_0x2dba06,_0x454b4f))return{'handler':_0x10bcfb[_0x2a9fd9],'routePattern':_0x2dba06};}return null;}function k(_0x1e0eb6){return typeof _0x1e0eb6=='function'?{'handler':_0x1e0eb6,'routePattern':''}:_0x1e0eb6;}var n={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return n['appId'];},get 'manifest'(){return n['manifest'];}};async function w(_0x41557f){let _0x277d38=async _0x2383d5=>{try{let _0x54232e=globalThis['Deno'];if(!_0x54232e)throw new Error('Deno is not available');return await _0x54232e['stat'](_0x2383d5),!0x0;}catch{return![];}};if(_0x41557f&&typeof _0x41557f=='string'&&_0x41557f['length']>0x0)return _0x41557f;if(n['serverPath']&&typeof n['serverPath']=='string'&&n['serverPath']['length']>0x0)return n['serverPath'];let _0x260daf=n['manifest']?.['metadata']?.['serverPath'];if(_0x260daf&&typeof _0x260daf=='string'&&_0x260daf['length']>0x0)return _0x260daf;if(!n['appsDir']||!n['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x721a0b=n['manifest']['name'];if(!_0x721a0b)throw new Error('Manifest\x20name\x20not\x20found');let _0x1a35d2=[n['appsDir']+'/service/server.js',n['appsDir']+'/service/server.ts',n['appsDir']+'/'+_0x721a0b+'/server.js',n['appsDir']+'/'+_0x721a0b+'/server.ts',n['appsDir']+'/server.ts',n['appsDir']+'/server.js'];for(let _0x15e97f of _0x1a35d2)if(await _0x277d38(_0x15e97f))return _0x15e97f;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x1a35d2['join'](',\x20'));}function R(){let _0x1d790f=['log','info','warn','error','debug'];for(let _0x1830ba of _0x1d790f){let _0x155be7=(console[_0x1830ba]||console['log'])['bind'](console);console[_0x1830ba]=(..._0x16c012)=>{try{let _0x4835de=_0x16c012['map'](_0x36f533=>{if(typeof _0x36f533=='string')return _0x36f533;if(_0x36f533 instanceof Error)return JSON['stringify']({'name':_0x36f533['name'],'message':_0x36f533['message'],'stack':_0x36f533['stack']});if(typeof Request<'u'&&_0x36f533 instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x36f533['url'],'method':_0x36f533['method'],'headers':Object['fromEntries'](_0x36f533['headers']['entries']()),'bodyUsed':_0x36f533['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x36f533 instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x36f533['status'],'headers':Object['fromEntries'](_0x36f533['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x36f533);}catch{return String(_0x36f533);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x1830ba==='log'?'info':_0x1830ba,'message':_0x4835de,'meta':{'appId':n['appId']}});}catch{_0x155be7(..._0x16c012);}};}}R();async function v(_0x2e17d3){if(!n['appId']||!n['appsDir']||!n['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x322b1c=(await w(_0x2e17d3))['replace'](/\\/g,'/'),_0x36ac34=(_0x322b1c['startsWith']('file://')?_0x322b1c:'file://'+_0x322b1c)+'?t='+Date['now']();try{let _0x23238b=await import(_0x36ac34);return n['module']=_0x23238b,_0x23238b;}catch(_0x326da5){throw console['error']('Failed to load module:',_0x326da5),_0x326da5;}}function b(_0x43f6ed){return _0x43f6ed instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x43f6ed,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x38c056){return _0x38c056['split']('/')['filter'](_0x5d56a5=>_0x5d56a5['length']>0x0);}function E(_0x27b4f3){try{return decodeURIComponent(_0x27b4f3);}catch{return _0x27b4f3;}}function I(_0xb0d0b0,_0x5513c2){let _0x123a1d=g(_0xb0d0b0),_0x5c551d=g(_0x5513c2),_0x1dc884={},_0x1c8892=0x0,_0x25ad55=0x0;for(;_0x1c8892<_0x123a1d['length']&&_0x25ad55<_0x5c551d['length'];){let _0x48bb03=_0x123a1d[_0x1c8892],_0x356cbf=_0x5c551d[_0x25ad55];if(_0x48bb03==='*')break;if(_0x48bb03['startsWith'](':')){let _0x5cff53=_0x48bb03['slice'](0x1);_0x5cff53&&(_0x1dc884[_0x5cff53]=E(_0x356cbf)),_0x1c8892++,_0x25ad55++;continue;}if(_0x48bb03!==_0x356cbf)return{};_0x1c8892++,_0x25ad55++;}return _0x1c8892===_0x123a1d['length']||_0x1c8892===_0x123a1d['length']-0x1&&_0x123a1d[_0x1c8892]==='*',_0x1dc884;}function M(_0x398a8a,_0x4d1e22){return _0x398a8a['startsWith']('/api')&&!_0x4d1e22['startsWith']('/api')?_0x398a8a['substring'](0x4)||'/':!_0x398a8a['startsWith']('/api')&&_0x4d1e22['startsWith']('/api')?'/api'+(_0x398a8a['startsWith']('/')?'':'/')+_0x398a8a:_0x398a8a;}async function W(_0x5ad1ff){let _0x1a7b9d=_0x5ad1ff['ctx']?.['metadata']?.['serverPath'];(!n['module']||_0x1a7b9d)&&await v(_0x1a7b9d);let _0x10a884=_0x5ad1ff['ctx'],{method:_0x56b134,pathname:_0x3f059e}=_0x10a884,_0x45f5b8=n['module']?.['default']||{},_0x561e16=m(_0x45f5b8,_0x56b134,_0x3f059e);if(!_0x561e16)throw Object['assign'](new Error('Route\x20'+_0x56b134+'\x20'+_0x3f059e+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x3cf4ac=k(_0x561e16),_0x52a123=c(_0x10a884,n),_0x18b545=_0x3f059e,_0x129491=M(_0x3cf4ac['routePattern'],_0x18b545),_0x3f6518=_0x129491?I(_0x129491,_0x18b545):{},_0x41c39a=await _0x3cf4ac['handler']({..._0x52a123,'params':{..._0x52a123['params'],..._0x3f6518}});return b(_0x41c39a);}function D(_0x26d5b0){n['appId']=_0x26d5b0['appId'],n['manifest']=_0x26d5b0['manifest'],n['appsDir']=_0x26d5b0['appsDir'],n['serverPath']=_0x26d5b0['serverPath']||null,console['log']('Worker\x20initialized',{'appId':n['appId']}),self['postMessage']({'type':'ready','appId':n['appId']});}async function $(_0x143626){let {reqId:_0xc018fe,payload:_0x22e8be}=_0x143626;try{let _0x189197=await W(_0x22e8be);self['postMessage']({'type':'result','reqId':_0xc018fe,'ok':!0x0,'response':_0x189197});}catch(_0x2524fd){let _0x3f357d=_0x2524fd;self['postMessage']({'type':'result','reqId':_0xc018fe,'ok':![],'error':{'message':_0x3f357d['message'],'stack':_0x3f357d['stack'],'code':_0x3f357d['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':n['appId']}),n['module']=null,n['appId']=null,n['manifest']=null,n['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x2a0c02=>{let _0xa27044=_0x2a0c02['data'];try{switch(_0xa27044['type']){case'init':D(_0xa27044);break;case'invoke':await $(_0xa27044);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0xa27044['type']);break;}}catch(_0x4b0394){let _0x105051=_0x4b0394;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':n['appId'],'error':_0x105051['message'],'stack':_0x105051['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x105051);}}},self['onerror']=_0x3c31bd=>{let _0x1dab13={'message':typeof _0x3c31bd=='string'?_0x3c31bd:_0x3c31bd['message'],'filename':typeof _0x3c31bd=='string'?void 0x0:_0x3c31bd['filename'],'lineno':typeof _0x3c31bd=='string'?void 0x0:_0x3c31bd['lineno'],'colno':typeof _0x3c31bd=='string'?void 0x0:_0x3c31bd['colno'],'error':typeof _0x3c31bd=='string'?void 0x0:_0x3c31bd['error']?.['message'],'stack':typeof _0x3c31bd=='string'?void 0x0:_0x3c31bd['error']?.['stack'],'appId':n['appId']};console['error']('Worker\x20global\x20error:',_0x1dab13);},self['onunhandledrejection']=_0x591800=>{let _0x49fd3c=_0x591800['reason'],_0x29603d={'appId':n['appId'],'reason':_0x49fd3c instanceof Error?_0x49fd3c['message']:String(_0x49fd3c),'stack':_0x49fd3c instanceof Error?_0x49fd3c['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x29603d);};