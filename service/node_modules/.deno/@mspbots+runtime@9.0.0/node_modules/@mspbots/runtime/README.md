# @mspbots/runtime

Lightweight Deno/Node.js runtime environment for isolated execution of MSPBots backend service code.

| Package Info | Details |
| :--- | :--- |
| **Type** | Backend Package |
| **Environment** | Deno, Node.js |
| **Core Features** | Isolation, Permission Control |

## Operation Manual

### Introduction

This package is primarily used internally on the server side to load and run user-written `service/server.ts` code. It provides a sandbox environment ensuring applications can only access authorized APIs and resources.

### Key Features

1.  **Code Loading**: Dynamically loads the application's backend bundle.
2.  **Context Injection**: Injects `RequestCtx` for each request, containing user info, app config, etc.
3.  **API Routing**: Dispatches traffic to corresponding handler functions based on request path.
4.  **Permission Validation**: Validates API call permissions based on manifest declarations.

## API Reference

### Global Exports

The package exports core utilities and types for building the runtime environment.

```ts
export * from './manager';
export * from './types';
export * from './lifecycle';
export * from './messaging';
export * from './utils';
export * from './context';
export * from './http';
export * from './loader';
export * from './validator';
export * from './tools';
export * from './permissions';
export * from './executor';
```

### Core Interfaces

#### `HandlerParams`

The standard parameter object received by user-written route handlers.

```ts
export interface HandlerParams {
  id: string;          // App ID
  name: string;        // App Name
  version: string;     // App Version
  description: string; // App Description
  metadata: Record<string, unknown>; // App Metadata (permissions, etc.)
  
  // Request Data
  body: unknown;       // Parsed Request Body
  query: Record<string, string | string[]>; // Query Parameters
  params: Record<string, string>; // Route Parameters (e.g. /users/:id)
  headers: Record<string, string>; // Request Headers
  
  // Request Context
  method: string;      // HTTP Method
  path: string;        // Request Path
  url: string;         // Full URL
  user?: User;         // Current User (if authenticated)
}
```

#### `RequestCtx`

The raw context object passed into the runtime from the host server (e.g., mspack dev server or production gateway).

```ts
export interface RequestCtx {
  app: {
    id: string;
    name: string;
    version?: string;
    description?: string;
    icon?: string;
  };
  permissions: Record<string, unknown>;
  metadata: Record<string, unknown>;
  user?: User;
  
  // HTTP Request
  body: unknown;
  query: Record<string, string | string[]>;
  params: Record<string, string>;
  method: string;
  path: string;
  url: string;
  headers: Record<string, string>;
}
```

#### `Manifest` & `Permissions`

Defines the application's capabilities and metadata.

```ts
export interface Manifest {
  id: string;
  name: string;
  version: string;
  permissions?: Permissions;
  // ...
}

export interface Permissions {
  net?: string[] | boolean;  // Network access
  read?: string[] | boolean; // File read
  write?: string[] | boolean;// File write
  env?: string[] | boolean;  // Env vars
  run?: string[] | boolean;  // Subprocesses
  // ... and more (kv, db, langchain, etc.)
}
```

### Core Utilities

#### `buildParams(ctx: RequestCtx, workerCtx: WorkerCtx): HandlerParams`

Transforms the raw `RequestCtx` into the developer-facing `HandlerParams`.

#### `extractUser(context: unknown): unknown`

Helper to safely extract user information from a generic context object.

#### `extractAppInfo(appInfo: AppInfo | null)`

Helper to normalize application information from the raw manifest.
