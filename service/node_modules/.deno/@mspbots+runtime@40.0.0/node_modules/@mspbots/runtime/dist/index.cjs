'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x29ec5d){return _0x29ec5d&&_0x29ec5d['__esModule']?_0x29ec5d:{'default':_0x29ec5d};}var Y__default=_interopDefault(Y);async function ie(_0x3ed0ea){try{return await promises['stat'](_0x3ed0ea),!0x0;}catch{return![];}}var f={'error':(_0x2734ce,_0x1fe2e4)=>console['error']('[ERROR]\x20'+_0x2734ce,_0x1fe2e4),'warn':(_0x27f26b,_0x29811f)=>console['warn']('[WARN]\x20'+_0x27f26b,_0x29811f),'info':(_0x1cce93,_0x2a8a40)=>console['log']('[INFO]\x20'+_0x1cce93,_0x2a8a40),'debug':(_0x59ca99,_0x389357)=>console['log']('[DEBUG]\x20'+_0x59ca99,_0x389357)};function z(){let _0x367780=globalThis['Deno'];if(!_0x367780)throw new Error('Deno is not available');return _0x367780;}var D=class{constructor(_0x13b3ea,_0x5da959='./lib',_0x28d67d={}){this['manifest']=_0x13b3ea,this['libDir']=_0x5da959,this['platformImports']=_0x28d67d;}['buildPerms'](){let _0x2f70e1=this['manifest']['permissions']||{},_0x2ce445={};return _0x2f70e1['net']!==void 0x0&&(_0x2ce445['net']=_0x2f70e1['net']===!![]?!![]:Array['isArray'](_0x2f70e1['net'])?_0x2f70e1['net']:[]),_0x2f70e1['read']!==void 0x0&&(_0x2ce445['read']=_0x2f70e1['read']===!![]?!![]:Array['isArray'](_0x2f70e1['read'])?_0x2f70e1['read']:[]),_0x2f70e1['write']!==void 0x0&&(_0x2ce445['write']=_0x2f70e1['write']===!![]?!![]:Array['isArray'](_0x2f70e1['write'])?_0x2f70e1['write']:[]),_0x2f70e1['env']!==void 0x0&&(_0x2ce445['env']=_0x2f70e1['env']===!![]?!![]:Array['isArray'](_0x2f70e1['env'])?_0x2f70e1['env']:[]),_0x2f70e1['run']!==void 0x0&&(_0x2ce445['run']=_0x2f70e1['run']===!![]?!![]:Array['isArray'](_0x2f70e1['run'])?_0x2f70e1['run']:[]),_0x2f70e1['ffi']!==void 0x0&&(_0x2ce445['ffi']=_0x2f70e1['ffi']===!![]?!![]:Array['isArray'](_0x2f70e1['ffi'])?_0x2f70e1['ffi']:[]),_0x2f70e1['sys']!==void 0x0&&(_0x2ce445['sys']=_0x2f70e1['sys']===!![]?!![]:Array['isArray'](_0x2f70e1['sys'])?_0x2f70e1['sys']:[]),_0x2f70e1['hrtime']!==void 0x0&&(_0x2ce445['hrtime']=_0x2f70e1['hrtime']),_0x2ce445;}['normalize'](_0x415d01){return _0x415d01===!![]?[]:Array['isArray'](_0x415d01)?_0x415d01:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x2d368b){return path.join(this['libDir'],_0x2d368b+'@*');}['getReadPaths'](){let _0x498aeb=this['getImports']();_0x498aeb['includes']('*')&&(_0x498aeb=Object['keys'](this['platformImports']));let _0x334d10=[];console['log']('[Permissions] Building package path patterns for imports:',_0x498aeb);for(let _0x306ee7 of _0x498aeb){let _0x10da06=this['getLibPattern'](_0x306ee7);_0x334d10['push'](_0x10da06),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x306ee7+'\x20->\x20'+_0x10da06);}return console['log']('[Permissions] Final package path patterns:',_0x334d10),_0x334d10;}['buildImportMap'](_0x4cbaf8){let _0x39cb64=this['getImports'](),_0xfcbebb=_0x39cb64['includes']('*')?Object['keys'](_0x4cbaf8):_0x39cb64;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0xfcbebb);let _0x116456={};for(let _0x5e1d99 of _0xfcbebb)if(_0x4cbaf8[_0x5e1d99])_0x116456[_0x5e1d99]=_0x4cbaf8[_0x5e1d99],console['log']('[ImportMap]\x20'+_0x5e1d99+'\x20->\x20'+_0x4cbaf8[_0x5e1d99]+'\x20(from\x20platform)');else try{let _0x3c737b=z(),_0x46b2d4=path.join(_0x3c737b['cwd'](),this['libDir']),_0x4a6049=!0x1;try{for(let _0x1dfe5b of _0x3c737b['readDirSync'](_0x46b2d4))if(_0x1dfe5b['isDirectory']&&(_0x1dfe5b['name']===_0x5e1d99||_0x1dfe5b['name']['startsWith'](_0x5e1d99+'@'))){let _0x2cc3d0=path.join(_0x3c737b['cwd'](),this['libDir'],_0x1dfe5b['name'],'index.js')['replace'](/\\/g,'/'),_0x1fe942=new URL('file:///'+_0x2cc3d0)['href'];_0x116456[_0x5e1d99]=_0x1fe942,console['log']('[ImportMap]\x20'+_0x5e1d99+'\x20->\x20'+_0x1fe942+'\x20(from\x20lib)'),_0x4a6049=!0x0;break;}}catch{}_0x4a6049||console['warn']('[ImportMap]\x20Package\x20'+_0x5e1d99+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0xbc0f77){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x5e1d99+':',_0xbc0f77);}return _0x116456;}['validateServerImports'](_0x5e29ec){let _0x2c6b3c=this['manifest']['name']||this['manifest']['id'],_0x53939f=this['manifest']['metadata']?.['serverPath'],_0x271ea5=_0xf22b56=>_0xf22b56['replace'](/\\/g,'/'),_0x369f52=z(),_0x3bbeab=_0x379d93=>{try{return _0x369f52['statSync'](_0x379d93),!0x0;}catch{return![];}},_0x526f10=_0x53939f?_0x271ea5(_0x53939f):void 0x0;if(!_0x526f10){let _0x229bce=[_0x5e29ec+'/service/server.js',_0x5e29ec+'/service/server.ts',_0x5e29ec+'/'+_0x2c6b3c+'/server.js',_0x5e29ec+'/'+_0x2c6b3c+'/server.ts',_0x5e29ec+'/server.js',_0x5e29ec+'/server.ts']['map'](_0x271ea5);for(let _0x6e3a15 of _0x229bce)if(_0x3bbeab(_0x6e3a15)){_0x526f10=_0x6e3a15;break;}}if(!_0x526f10)return{'valid':![],'violations':['Failed to locate server module']};let _0x402521='';try{_0x402521=_0x369f52['readTextFileSync'](_0x526f10);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x526f10};}let _0x5f5ed5=this['getImports']();if(_0x5f5ed5['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x526f10};let _0x20b65e=_0x5f5ed5,_0x3a20cd=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x2b0e0e=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x9ae049=/\bimport\s*['"]([^'"]+)['"]/g,_0x40c20f=[],_0x14904c=new Set(),_0x261251=_0x567655=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x567655),_0xf35356=_0x4a17aa=>{let _0x3554f9=_0x4a17aa;if(_0x3554f9['startsWith']('./')||_0x3554f9['startsWith']('../')||_0x3554f9['startsWith']('/')||_0x3554f9['startsWith']('file://')||!_0x261251(_0x4a17aa)||_0x14904c['has'](_0x4a17aa))return;_0x14904c['add'](_0x4a17aa),_0x3554f9['startsWith']('npm:')&&(_0x3554f9=_0x3554f9['substring'](0x4)),_0x3554f9['includes']('@')&&!_0x3554f9['startsWith']('@')&&(_0x3554f9=_0x3554f9['split']('@')[0x0]);let _0x1b8f5e=_0x3554f9['split']('/')[0x0];_0x20b65e['includes'](_0x1b8f5e)||_0x20b65e['includes'](_0x4a17aa)||_0x40c20f['push'](_0x4a17aa);},_0xb2b308;for(;(_0xb2b308=_0x3a20cd['exec'](_0x402521))!==null;)_0xf35356(_0xb2b308[0x1]);for(;(_0xb2b308=_0x2b0e0e['exec'](_0x402521))!==null;)_0xf35356(_0xb2b308[0x1]);for(;(_0xb2b308=_0x9ae049['exec'](_0x402521))!==null;)_0xf35356(_0xb2b308[0x1]);return{'valid':_0x40c20f['length']===0x0,'violations':_0x40c20f,'serverPath':_0x526f10};}['validate'](_0x183e46={}){let _0x14c7ec=[],_0x200d67=this['manifest']['permissions']||{};try{let _0x59f1ff=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x59f1ff);}catch{}let _0x44f9aa=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x385f24,_0xb63175]of Object['entries'](_0x200d67))if(_0x385f24==='hrtime')typeof _0xb63175!='boolean'&&_0x14c7ec['push']('Permission\x20\x27'+_0x385f24+'\x27\x20must\x20be\x20boolean');else{if(_0x385f24==='langchain')typeof _0xb63175!='boolean'&&(typeof _0xb63175!='object'||_0xb63175===null)?_0x14c7ec['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0xb63175=='object'&&(_0xb63175===null||!('enabled'in _0xb63175)||typeof _0xb63175['enabled']!='boolean')&&_0x14c7ec['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x385f24==='kv')typeof _0xb63175!='boolean'&&_0x14c7ec['push']('Permission\x20\x27'+_0x385f24+'\x27\x20must\x20be\x20boolean');else{if(_0x385f24==='mspbots')Array['isArray'](_0xb63175)||_0x14c7ec['push']('Permission\x20\x27'+_0x385f24+'\x27\x20must\x20be\x20an\x20array');else{if(_0x385f24==='db'){if(typeof _0xb63175!='object'||_0xb63175===null||Array['isArray'](_0xb63175))_0x14c7ec['push']('Permission\x20\x27'+_0x385f24+'\x27\x20must\x20be\x20an\x20object');else{let _0x336c21=_0xb63175,_0x2e91ad=['user','password']['filter'](_0x2f6ce5=>!(_0x2f6ce5 in _0x336c21));_0x2e91ad['length']>0x0&&_0x14c7ec['push']('Permission\x20\x27'+_0x385f24+'\x27\x20missing\x20required\x20fields:\x20'+_0x2e91ad['join'](',\x20'));}}else{if(_0x385f24==='imports')continue;_0x44f9aa['has'](_0x385f24)||typeof _0xb63175!='boolean'&&!Array['isArray'](_0xb63175)&&_0x14c7ec['push']('Permission\x20\x27'+_0x385f24+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x2f8231=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x2f8231))_0x14c7ec['push']('permissions.imports must be an array');else{for(let _0x2e5aa9 of _0x2f8231)typeof _0x2e5aa9!='string'&&_0x14c7ec['push']('import\x20\x27'+_0x2e5aa9+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x14c7ec['length']===0x0,'errors':_0x14c7ec};}};function q(_0x4f8d44,_0x429119,_0x3d7d19){return new D(_0x4f8d44,_0x429119,_0x3d7d19||{});}var R=null;function I(){let _0x134a3f=globalThis['Deno'];if(!_0x134a3f)throw new Error('Deno is not available');return _0x134a3f;}async function K(){if(R)return{...R};try{let _0x16d7b7=I(),_0xf291c5=path.join(_0x16d7b7['cwd'](),'deno.json'),_0x57cbec=await _0x16d7b7['readTextFile'](_0xf291c5);return R=JSON['parse'](_0x57cbec)['imports']||{},{...R};}catch(_0x17c364){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x17c364),{};}}var E=class{constructor(_0x3320b1,_0x37a7e6={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x3320b1['appsDir'],this['platformImportsOverride']=_0x3320b1['platformImports'],this['libDir']=_0x3320b1['libDir'],this['events']=_0x37a7e6);}async['create'](_0x35e937,_0x270f46,_0x47356b){try{return await this['createWorker'](_0x35e937,_0x270f46,_0x47356b);}catch(_0x47c415){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x35e937+':',_0x47c415),_0x47c415;}}async['createWorker'](_0x2af576,_0x326266,_0x5cb3ea){let _0x1d329b=this['platformImportsOverride']||await K(),_0xa27b7d=q(_0x326266,this['libDir'],_0x1d329b)['validateServerImports'](this['appsDir']);if(!_0xa27b7d['valid']){let _0x55cda8=_0xa27b7d['violations']['filter'](_0xbe27f5=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0xbe27f5)),_0x24b5e9=_0xa27b7d['serverPath']?_0xa27b7d['serverPath']:(_0x326266['name']||_0x326266['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x24b5e9+':\x20'+_0x55cda8['join'](',\x20'));}let _0x228027=q(_0x326266,this['libDir'],_0x1d329b),_0xb172b1=_0x228027['validate'](_0x1d329b);if(!_0xb172b1['valid'])throw new Error('Invalid\x20config:\x20'+_0xb172b1['errors']['join'](',\x20'));let _0x38d788=_0x228027['buildImportMap'](_0x1d329b);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x2af576+':',_0x38d788);let _0x5af075=_0x228027['buildPerms'](),_0x556979=_0x228027['getReadPaths']();if(_0x5af075['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x5af075['read']);else{let _0x32b587=_0x326266['name']||_0x2af576,_0x16667f=this['appsDir']+'/'+_0x32b587,_0xe7e536=[_0x16667f],_0xda4d75=_0x326266['metadata']?.['serverPath'];if(_0xda4d75&&typeof _0xda4d75=='string')try{let _0x38d1c5=path.dirname(_0xda4d75)['replace'](/\\/g,'/');_0xe7e536['push'](_0x38d1c5);}catch{}_0x5af075['read']=_0xe7e536,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x16667f);}if(_0x556979['length']>0x0){if(_0x5af075['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x589531=Array['isArray'](_0x5af075['read'])?_0x5af075['read']:[];_0x5af075['read']=[..._0x589531,..._0x556979],console['log']('[Worker] Added package read permissions:',_0x556979);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x5af075['net']||(_0x5af075['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x2af576+':',_0x5af075['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x5af075['read']===!![]?'unrestricted':Array['isArray'](_0x5af075['read'])?_0x5af075['read']['length']:0x0));let _0x3f45ed=await this['createImportMap'](_0x2af576,_0x38d788),_0x5f08e7=await this['createLock'](_0x2af576,_0x38d788),_0x4bc32e={'type':'module','deno':{'permissions':{}}};_0x4bc32e['deno']['namespace']=![],_0x4bc32e['deno']['permissions']=_0x5af075,_0x4bc32e['deno']['importMap']=_0x3f45ed,_0x4bc32e['deno']['lock']=_0x5f08e7,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x2af576+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x3f45ed),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x5f08e7),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x38d788)['length']+'\x20('+(Object['keys'](_0x38d788)['join'](',\x20')||'none')+')');let _0x48cc1e={'worker':new Worker(_0x5cb3ea,_0x4bc32e),'appId':_0x2af576,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x326266,'importMapPath':_0x3f45ed,'lockfilePath':_0x5f08e7};return this['workers']['set'](_0x2af576,_0x48cc1e),this['events']['onCreate']?.(_0x48cc1e),_0x48cc1e;}async['createLock'](_0xb2d55d,_0x521dd7){let _0x379497=I(),_0x5a09ac=path.join(_0x379497['cwd'](),'storage','temp','lockfiles');await _0x379497['mkdir'](_0x5a09ac,{'recursive':!![]});let _0x3ffa88=_0xb2d55d+'-'+Date['now']()+'.lock',_0x2bdf69=path.join(_0x5a09ac,_0x3ffa88),_0x1d9eb7={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0xfc1870,_0x151103]of Object['entries'](_0x521dd7))if(_0x151103['startsWith']('npm:'))_0x151103['replace']('npm:',''),_0x1d9eb7['packages']['specifiers'][_0xfc1870]=_0x151103;else _0x151103['startsWith']('file://')&&(_0x1d9eb7['packages']['specifiers'][_0xfc1870]=_0x151103);let _0x3da648=JSON['stringify'](_0x1d9eb7,null,0x2);return await _0x379497['writeTextFile'](_0x2bdf69,_0x3da648),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x2bdf69),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x521dd7)['length']+'):',Object['keys'](_0x521dd7)),_0x2bdf69;}async['createImportMap'](_0x5b7822,_0x337403){let _0x5cbdfa=I(),_0x3d64c7=path.join(_0x5cbdfa['cwd'](),'storage','temp','importmaps');await _0x5cbdfa['mkdir'](_0x3d64c7,{'recursive':!![]});let _0x3e1a80=_0x5b7822+'-'+Date['now']()+'.json',_0x4a6aed=path.join(_0x3d64c7,_0x3e1a80),_0xbf4c61=JSON['stringify']({'imports':_0x337403,'scopes':{}},null,0x2);return await _0x5cbdfa['writeTextFile'](_0x4a6aed,_0xbf4c61),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x4a6aed),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x337403)['length']+'):',Object['keys'](_0x337403)['join'](',\x20')||'none'),_0x4a6aed;}['get'](_0x4b4754){return this['workers']['get'](_0x4b4754);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x27cb75,_0x162573){let _0x389e4e=this['workers']['get'](_0x27cb75);if(!_0x389e4e)return;let _0x545727=_0x389e4e['status'];_0x389e4e['status']=_0x162573,_0x162573==='running'&&_0x545727==='starting'?this['events']['onReady']?.(_0x389e4e):_0x162573==='crashed'&&this['events']['onCrash']?.(_0x389e4e);}['touch'](_0x3eb9fb){let _0x2a4e93=this['workers']['get'](_0x3eb9fb);_0x2a4e93&&(_0x2a4e93['lastUsed']=Date['now']());}async['stop'](_0x58a39a){let _0x4b37b0=this['workers']['get'](_0x58a39a);if(_0x4b37b0)try{_0x4b37b0['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x4b37b0['worker']['terminate'](),_0x4b37b0['status']='stopped',this['events']['onStop']?.(_0x4b37b0),_0x4b37b0['importMapPath']&&await this['cleanupImportMap'](_0x4b37b0['importMapPath']),_0x4b37b0['lockfilePath']&&await this['cleanupLock'](_0x4b37b0['lockfilePath']);}catch(_0x4e71da){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x58a39a+':',_0x4e71da);}finally{this['workers']['delete'](_0x58a39a);}}async['cleanupImportMap'](_0x3c3f73){try{await I()['remove'](_0x3c3f73),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x3c3f73);}catch(_0x59bc8d){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x3c3f73,_0x59bc8d);}}async['cleanupLock'](_0x37d81b){try{await I()['remove'](_0x37d81b),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x37d81b);}catch(_0x111e9f){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x37d81b,_0x111e9f);}}async['stopAll'](){let _0x36c13c=Array['from'](this['workers']['keys']());await Promise['all'](_0x36c13c['map'](_0xf1072b=>this['stop'](_0xf1072b)));}async['restart'](_0xb60b7e,_0x582152){let _0x406c81=this['workers']['get'](_0xb60b7e);if(!_0x406c81)throw new Error('Worker\x20'+_0xb60b7e+'\x20not\x20found');let _0x51b5dd=_0x406c81['manifest'];return await this['stop'](_0xb60b7e),await this['create'](_0xb60b7e,_0x51b5dd,_0x582152);}['checkHealth'](_0x38ab18){let _0x3ac912=this['workers']['get'](_0x38ab18);if(!_0x3ac912)return{'healthy':![],'reason':'Not\x20found'};if(_0x3ac912['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x3ac912['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x5e15e2=Date['now']()-_0x3ac912['lastUsed'],_0x2ba57e=0x708*0x3e8;return _0x5e15e2>_0x2ba57e?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x5e15e2/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x4d9665=0x708*0x3e8,_0x436e1a){let _0x3a356f=Date['now'](),_0x18f94c=[];for(let [_0x258bd4,_0x44de93]of this['workers']['entries']()){let _0x7b82a7=_0x3a356f-_0x44de93['lastUsed'];_0x7b82a7>_0x4d9665&&_0x18f94c['push']({'appId':_0x258bd4,'idle':_0x7b82a7});}_0x18f94c['sort']((_0x3e3af2,_0x2119e8)=>_0x2119e8['idle']-_0x3e3af2['idle']);let _0xcf98c4=_0x436e1a?_0x18f94c['slice'](0x0,_0x436e1a)['map'](_0x28a565=>_0x28a565['appId']):_0x18f94c['map'](_0x238d06=>_0x238d06['appId']);for(let _0x34b89e of _0xcf98c4)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x34b89e),await this['stop'](_0x34b89e);}['stats'](){let _0x1e098c={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x3b92bb=Date['now']();for(let _0x22585f of this['workers']['values']())_0x1e098c['byStatus'][_0x22585f['status']]++,_0x1e098c['workers']['push']({'appId':_0x22585f['appId'],'status':_0x22585f['status'],'version':_0x22585f['version'],'lastUsed':_0x22585f['lastUsed'],'idle':_0x3b92bb-_0x22585f['lastUsed']});return _0x1e098c;}['startCleanup'](_0x280e66=0x12c*0x3e8,_0x2de391){let _0x328e95=setInterval(()=>{this['cleanup'](_0x2de391)['catch'](_0x3a9ea1=>{console['error']('Cleanup\x20failed:',_0x3a9ea1);});},_0x280e66);return()=>clearInterval(_0x328e95);}['delay'](_0x4ba513){return new Promise(_0x58da45=>setTimeout(_0x58da45,_0x4ba513));}};function W(_0x1e3f5b,_0x48ba11){return new E(_0x1e3f5b,_0x48ba11);}var v=f,j=class{constructor(_0x4899b3,_0x7ac748=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x4899b3,this['timeout']=_0x7ac748);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x585a54){_0x585a54['worker']['onmessage']=_0x330550=>{let _0x4dc659=_0x330550['data'],{appId:_0x314630}=_0x585a54;switch(_0x4dc659['type']){case'ready':this['events']['onReady'](_0x314630),v['info']('Worker\x20ready',{'appId':_0x314630,'version':_0x585a54['version']});break;case'log':{let {level:_0x56825f='info',message:_0x21613f,meta:_0x334d0b}=_0x4dc659,_0xef1dd8={..._0x334d0b||{},'appId':_0x314630,'version':_0x585a54['version']};this['events']['onLog'](_0x314630,_0x56825f,_0x21613f,_0xef1dd8);break;}case'result':{let {reqId:_0x38f91f,ok:_0x5ec65,response:_0x263b76,error:_0x318209}=_0x4dc659,_0x427e44=this['pending']['get'](_0x38f91f);if(!_0x427e44){v['warn']('Unknown\x20request',{'appId':_0x314630,'reqId':_0x38f91f});return;}if(this['pending']['delete'](_0x38f91f),_0x5ec65&&_0x263b76)_0x427e44['resolve'](_0x263b76);else{let _0xed301f=new Error(_0x318209?.['message']||'Worker\x20error');_0xed301f['stack']=_0x318209?.['stack'],_0x427e44['reject'](_0xed301f);}this['events']['onResult'](_0x314630,_0x38f91f,_0x263b76||_0x318209);break;}default:v['debug']('Unknown\x20message',{'appId':_0x314630,'type':_0x4dc659['type']});}},_0x585a54['worker']['onerror']=_0xd2cd19=>{let {appId:_0x82a456}=_0x585a54;v['error']('Worker\x20error',{'appId':_0x82a456,'message':_0xd2cd19['message'],'lineno':_0xd2cd19['lineno'],'filename':_0xd2cd19['filename']}),_0x585a54['status']='crashed',this['rejectPending'](_0x82a456,new Error('Worker\x20'+_0x82a456+'\x20crashed:\x20'+_0xd2cd19['message'])),_0xd2cd19['preventDefault']();},_0x585a54['worker']['onmessageerror']=_0x168a08=>{let {appId:_0x40cf5c}=_0x585a54;v['error']('Message\x20error',{'appId':_0x40cf5c,'data':_0x168a08['data']}),_0x585a54['status']='crashed',_0x168a08['preventDefault']();};}['sendInit'](_0x3dadf9,_0x4f0b01,_0x116552,_0x3d38b1){_0x3dadf9['worker']['postMessage']({'type':'init','appId':_0x3dadf9['appId'],'manifest':_0x116552,'appsDir':_0x4f0b01,'serverPath':_0x3d38b1});}async['sendInvoke'](_0x2a372d,_0x3da579){let _0x30aaf3=this['nextId'](),_0x8e1311=_0x2a372d['appId'],_0x5404fb=new Promise((_0x4a2af5,_0x24674b)=>{let _0x1a749f=setTimeout(()=>{this['pending']['delete'](_0x30aaf3),_0x24674b(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x30aaf3,{'resolve':_0x2eccec=>{clearTimeout(_0x1a749f),_0x4a2af5(_0x2eccec);},'reject':_0xe79774=>{clearTimeout(_0x1a749f),_0x24674b(_0xe79774);},'timestamp':Date['now'](),'appId':_0x8e1311});});return _0x2a372d['worker']['postMessage']({'type':'invoke','appId':_0x2a372d['appId'],'reqId':_0x30aaf3,'payload':_0x3da579}),await _0x5404fb;}['rejectPending'](_0x485aff,_0x115c32){let _0x54d8e0=0x0;for(let [_0x4486a4,_0x499b36]of this['pending']['entries']())_0x499b36['appId']===_0x485aff&&(this['pending']['delete'](_0x4486a4),_0x499b36['reject'](_0x115c32),_0x54d8e0++);_0x54d8e0>0x0&&v['warn']('Rejected\x20'+_0x54d8e0+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x485aff});}['cleanupTimeout'](){let _0x20ae65=Date['now']();for(let [_0x3f00ed,_0x41a163]of this['pending']['entries']())_0x20ae65-_0x41a163['timestamp']>this['timeout']&&(this['pending']['delete'](_0x3f00ed),_0x41a163['reject'](new Error('Request\x20'+_0x3f00ed+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x3a1eea){let _0x257413=0x0;for(let _0x1060d2 of this['pending']['values']())_0x1060d2['appId']===_0x3a1eea&&_0x257413++;return _0x257413;}['startCleanup'](_0x5bd1a3=0x2710){let _0x514ec2=setInterval(()=>{this['cleanupTimeout']();},_0x5bd1a3);return()=>clearInterval(_0x514ec2);}};function $(_0x5c801d,_0xd7caf7){return new j(_0x5c801d,_0xd7caf7);}var Q=class{constructor(_0x59e197={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x59e197['logger']||f,this['config']={'appsDir':_0x59e197['appsDir']||this['getAppsDir'](),'scriptUrl':_0x59e197['scriptUrl']||this['getScriptUrl'](),'timeout':_0x59e197['timeout']||0x78*0x3e8,'autoCleanup':_0x59e197['autoCleanup']??!![],'cleanupInterval':_0x59e197['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x59e197['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x59e197['maxWorkers'],'reuseWorkers':_0x59e197['reuseWorkers']??!![],'workerReuseStrategy':_0x59e197['workerReuseStrategy']||'lru','enableQueue':_0x59e197['enableQueue']??!![],'maxQueueSize':_0x59e197['maxQueueSize']||0x64,'queueTimeout':_0x59e197['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x5ac8ca=>this['logger']['info']('Worker\x20created',{'appId':_0x5ac8ca['appId'],'v':_0x5ac8ca['version']}),'onReady':_0x33eee5=>this['lifecycle']['updateStatus'](_0x33eee5['appId'],'running'),'onCrash':_0x2809b7=>this['logger']['error']('Worker\x20crashed',{'appId':_0x2809b7['appId'],'v':_0x2809b7['version']}),'onStop':_0x546a05=>this['logger']['info']('Worker\x20stopped',{'appId':_0x546a05['appId'],'v':_0x546a05['version']})}),this['messaging']=$({'onReady':_0x40699c=>this['lifecycle']['updateStatus'](_0x40699c,'running'),'onLog':(_0x3b213f,_0x4df7fd,_0x404c88,_0x1b816f)=>{let _0x35a514={..._0x1b816f||{},'appId':_0x3b213f};switch(_0x4df7fd){case'error':this['logger']['error'](_0x404c88,_0x35a514);break;case'warn':this['logger']['warn'](_0x404c88,_0x35a514);break;case'debug':this['logger']['debug'](_0x404c88,_0x35a514);break;default:this['logger']['info'](_0x404c88,_0x35a514);break;}},'onResult':(_0x29acfa,_0x493dcf,_0x53ca91)=>{this['logger']['debug']('Result\x20received',{'appId':_0x29acfa,'reqId':_0x493dcf});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x12a731=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x456960=_0x12a731['endsWith']('.js')||_0x12a731['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x456960,_0x12a731)['href'];}async['ensure'](_0x44c474){let {id:_0x3176f9}=_0x44c474,_0x256a97=this['lifecycle']['get'](_0x3176f9);if(_0x256a97){let _0xc0b450=this['lifecycle']['checkHealth'](_0x3176f9);if(_0xc0b450['healthy'])return this['lifecycle']['touch'](_0x3176f9),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x3176f9}),_0x256a97;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x3176f9,'reason':_0xc0b450['reason']}),await this['lifecycle']['stop'](_0x3176f9);}for(;;){let _0x1ea786=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x1ea786>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x1ea786,'max':this['config']['maxWorkers'],'appId':_0x3176f9}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x44c474);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x245bd0=await this['loadManifest'](_0x3176f9,_0x44c474['manifest']),_0xfa0639=await this['lifecycle']['create'](_0x3176f9,_0x245bd0,this['config']['scriptUrl']),_0x192e9f=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x192e9f>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x192e9f,'max':this['config']['maxWorkers'],'appId':_0x3176f9}),await this['lifecycle']['stop'](_0x3176f9),this['config']['enableQueue'])return await this['waitSlot'](_0x44c474);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x192e9f+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0xfa0639);let _0x3e9ddf=_0x245bd0['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0xfa0639,this['config']['appsDir'],_0x245bd0,_0x3e9ddf),this['logger']['info']('Worker\x20created',{'appId':_0x3176f9,'v':_0xfa0639['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0xfa0639;}async['evictIdle'](){let _0x45aa9d=this['lifecycle']['getAll']();if(_0x45aa9d['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x4755fe=[..._0x45aa9d];this['config']['workerReuseStrategy']==='lru'?_0x4755fe['sort']((_0xc81e94,_0x10666e)=>_0xc81e94['lastUsed']-_0x10666e['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x4755fe['sort']((_0x81190,_0x3f97d2)=>_0x81190['version']-_0x3f97d2['version']);let _0x4362da=null;for(let _0x984c1b of _0x4755fe)if(this['messaging']['getAppCount'](_0x984c1b['appId'])===0x0){_0x4362da=_0x984c1b;break;}if(!_0x4362da&&_0x4755fe['length']>0x0&&(_0x4362da=_0x4755fe['reduce']((_0x47c5f8,_0x2a4c67)=>{let _0x5bb767=this['messaging']['getAppCount'](_0x47c5f8['appId']);return this['messaging']['getAppCount'](_0x2a4c67['appId'])<_0x5bb767?_0x2a4c67:_0x47c5f8;})),_0x4362da){let _0xe75e4=this['messaging']['getAppCount'](_0x4362da['appId']);return _0xe75e4>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x4362da['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x4362da['lastUsed'],'pendingRequests':_0xe75e4}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x4362da['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x4362da['lastUsed']}),await this['lifecycle']['stop'](_0x4362da['appId']),!![];}return![];}['waitSlot'](_0x3196ea){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x521c27,_0x3ff06b)=>{let _0x3b0db5={'info':_0x3196ea,'resolve':_0x521c27,'reject':_0x3ff06b,'timestamp':Date['now']()};this['requestQueue']['push'](_0x3b0db5),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x3196ea['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x54a36a=setTimeout(()=>{let _0x4c3bac=this['requestQueue']['indexOf'](_0x3b0db5);_0x4c3bac!==-0x1&&(this['requestQueue']['splice'](_0x4c3bac,0x1),_0x3ff06b(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x3b0db5['resolve']=_0x3007a1=>{clearTimeout(_0x54a36a),_0x521c27(_0x3007a1);},_0x3b0db5['reject']=_0xf1dc8e=>{clearTimeout(_0x54a36a),_0x3ff06b(_0xf1dc8e);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x43c0b1=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x43c0b1>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x251823=this['requestQueue']['shift']();if(!_0x251823)break;try{let _0x1ce381=await this['ensure'](_0x251823['info']);_0x251823['resolve'](_0x1ce381);}catch(_0x4ebd22){_0x251823['reject'](_0x4ebd22);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x7e9849,_0x580586){let _0x44628a=this['config']['appsDir']['replace'](/\\/g,'/'),_0x5596f1=async _0x449e5d=>{try{let _0x3d43a4=globalThis['Deno'];if(!_0x3d43a4)return null;let _0x1eb6f0=await _0x3d43a4['readTextFile'](_0x449e5d);return JSON['parse'](_0x1eb6f0);}catch{return null;}};if(_0x580586?.['name']){let _0xa2fe81=await _0x5596f1(_0x44628a+'/'+_0x580586['name']+'/manifest.json');if(_0xa2fe81)return _0xa2fe81;}let _0xc2d277=await _0x5596f1(_0x44628a+'/'+_0x7e9849+'/manifest.json');if(_0xc2d277)return _0xc2d277;try{let _0x3a45bc=globalThis['Deno'];if(_0x3a45bc)for await(let _0x5c7590 of _0x3a45bc['readDir'](_0x44628a)){if(!_0x5c7590['isDirectory'])continue;let _0x15887b=_0x44628a+'/'+_0x5c7590['name']+'/manifest.json',_0x4600f3=await _0x5596f1(_0x15887b);if(_0x4600f3&&(_0x4600f3['id']===_0x7e9849||_0x580586?.['name']&&_0x4600f3['name']===_0x580586['name']))return _0x4600f3;}}catch(_0x1db012){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x7e9849,'error':_0x1db012['message']});}return _0x580586||{'id':_0x7e9849,'name':_0x7e9849,'version':'1.0.0'};}async['invoke'](_0x3dc59f){let _0x44496f=_0x3dc59f['ctx']['app']['id'],_0x48e620=_0x3dc59f['ctx']['app']['name'];try{let _0x198add={'id':_0x44496f,'manifest':{'id':_0x44496f,'name':_0x48e620}},_0x3a3424=await this['ensure'](_0x198add);if(_0x3a3424['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x44496f}),await this['restart'](_0x44496f);let _0x4ed6a7=await this['ensure'](_0x198add);return this['lifecycle']['touch'](_0x44496f),await this['messaging']['sendInvoke'](_0x4ed6a7,_0x3dc59f);}return this['lifecycle']['touch'](_0x44496f),await this['messaging']['sendInvoke'](_0x3a3424,_0x3dc59f);}catch(_0x541743){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x44496f,'error':_0x541743['message'],'stack':_0x541743['stack']}),_0x541743;}}async['stop'](_0x311455){await this['lifecycle']['stop'](_0x311455),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x57a319){return await this['lifecycle']['restart'](_0x57a319,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x45f7d5=>({'appId':_0x45f7d5['appId'],'status':_0x45f7d5['status'],'version':_0x45f7d5['version'],'lastUsed':_0x45f7d5['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x5e4429=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x22fb09=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x5e4429(),_0x22fb09();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x3fa70a=>{_0x3fa70a?(await this['stop'](_0x3fa70a),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x3fa70a})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x441563){return new Q(_0x441563);}var S=null;function be(_0x5f34d7){S=ee(_0x5f34d7);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0xcecd4f){return await k()['ensure'](_0xcecd4f);}async function xe(_0x31a72a){return await k()['invoke'](_0x31a72a);}function Ie(_0x167f86){k()['stop'](_0x167f86)['catch'](_0x4027e6=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x167f86,'error':_0x4027e6['message']});});}function Re(){k()['stopAll']()['catch'](_0x2e18a9=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x2e18a9['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x5021e8){await k()['stop'](_0x5021e8);}async function Se(){await k()['stopAll']();}function Ae(_0x4482d7){let _0x3a70e7=_0x4482d7&&typeof _0x4482d7=='object'?_0x4482d7:null;if(_0x3a70e7&&'user'in _0x3a70e7)return _0x3a70e7['user'];}function H(_0x2a4b8b){let _0x198eb1=_0x2a4b8b&&typeof _0x2a4b8b=='object'?_0x2a4b8b:null;if(!_0x198eb1)return{};let _0x217bab={};for(let [_0x445e79,_0x160d3d]of Object['entries'](_0x198eb1))_0x445e79!=='user'&&(_0x217bab[_0x445e79]=_0x160d3d);return _0x217bab;}function O(_0x3ab9d3){return _0x3ab9d3?{'id':_0x3ab9d3['manifest']?.['id']||_0x3ab9d3['id']||'','name':_0x3ab9d3['manifest']?.['name']||'','version':_0x3ab9d3['manifest']?.['version']||'','description':_0x3ab9d3['manifest']?.['description']||'','icon':_0x3ab9d3['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x2b2105){return _0x2b2105?.['permissions']||_0x2b2105?.['manifest']?.['permissions']||{};}function F(_0x2a96a8){return _0x2a96a8?.['manifest']?.['metadata']||{};}function Ce(_0x350407){return _0x350407?{'appId':_0x350407['id'],'appName':_0x350407['manifest']?.['name']}:{};}function N(_0x3a7b96,_0x56aa0b={}){let {appInfo:_0x3b2e43=null,status:_0x2d5de3=0x1f4,defaultMessage:_0xf3bf84='Internal\x20Server\x20Error'}=_0x56aa0b,_0x56b86e={'error':_0xf3bf84,'message':_0x3a7b96?.['message']||_0xf3bf84};return _0x3b2e43&&(_0x56b86e['appId']=_0x3b2e43['id'],_0x56b86e['appName']=_0x3b2e43['manifest']?.['name']),_0x3a7b96?.['message']?.['includes']('crashed')&&(_0x56b86e['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x2d5de3,'body':_0x56b86e};}function qe(_0x1da80b){return _0x1da80b?.['message']?.['includes']('crashed')||![];}function J(_0x28dee6){if(_0x28dee6)try{return JSON['parse'](_0x28dee6);}catch{return _0x28dee6;}}function B(_0x22e850){try{let _0x272dee=new URL(_0x22e850),_0x553529={};for(let _0x9b3f7f of _0x272dee['searchParams']['keys']()){let _0x2ed6a4=_0x272dee['searchParams']['getAll'](_0x9b3f7f)['map'](_0x3d00c6=>_0x3d00c6);_0x2ed6a4['length']<=0x1?_0x553529[_0x9b3f7f]=_0x2ed6a4[0x0]??'':_0x553529[_0x9b3f7f]=_0x2ed6a4;}return _0x553529;}catch{return{};}}function Le(_0x1ceaa6){return(()=>{try{return new URL(_0x1ceaa6)['pathname'];}catch{return _0x1ceaa6;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x567970,_0x49c591){let _0xde97da=_0x567970;if(_0x49c591&&_0xde97da['startsWith']('/apps/'+_0x49c591))_0xde97da=_0xde97da['substring'](('/apps/'+_0x49c591)['length'])||'/';else{let _0x3b2b6c=_0xde97da['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x3b2b6c&&(_0xde97da=_0x3b2b6c[0x1]||'/');}return _0xde97da['startsWith']('/api')&&(_0xde97da=_0xde97da['substring'](0x4)||'/'),_0xde97da;}function Ue(_0x4ea5c9,_0x79b292){let _0x4a878d=_0x4ea5c9;if(_0x79b292&&_0x4a878d['startsWith']('/apps/'+_0x79b292))_0x4a878d=_0x4a878d['substring'](('/apps/'+_0x79b292)['length'])||'/';else{let _0x4bd5bd=_0x4a878d['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x4bd5bd&&(_0x4a878d=_0x4bd5bd[0x1]||'/');}return(!_0x4a878d||_0x4a878d==='/')&&(_0x4a878d='/index.html'),_0x4a878d;}async function He(_0x121608,_0x1434af){return await _0x1434af(_0x121608);}function _(_0x2d8d7a){return _0x2d8d7a['split']('/')['filter'](_0x26e10d=>_0x26e10d['length']>0x0);}function te(_0x15f553){try{return decodeURIComponent(_0x15f553);}catch{return _0x15f553;}}function re(_0x14c6b6,_0x3d5aa2){let _0x271592=_(_0x14c6b6),_0x231dab=_(_0x3d5aa2),_0x4e1e4b={},_0x2f5a5e=0x0,_0x64aa48=0x0;for(;_0x2f5a5e<_0x271592['length']&&_0x64aa48<_0x231dab['length'];){let _0x181af0=_0x271592[_0x2f5a5e],_0x149025=_0x231dab[_0x64aa48];if(_0x181af0==='*')break;if(_0x181af0['startsWith'](':')){let _0xab6904=_0x181af0['slice'](0x1);_0xab6904&&(_0x4e1e4b[_0xab6904]=te(_0x149025)),_0x2f5a5e++,_0x64aa48++;continue;}if(_0x181af0!==_0x149025)return{};_0x2f5a5e++,_0x64aa48++;}return _0x2f5a5e===_0x271592['length']||_0x2f5a5e===_0x271592['length']-0x1&&_0x271592[_0x2f5a5e]==='*',_0x4e1e4b;}async function Oe(_0x50bdc0,_0x10610b,_0xdea948,_0x239c1a,_0x347ee7=void 0x0,_0x4554bf){let _0x5b6f85=await _0x10610b['text'](),_0x466bb0=J(_0x5b6f85),_0x58aa48=B(_0x10610b['url']),_0x452071={...F(_0x50bdc0),'user':_0x347ee7},_0x2dfe8a=H(_0x452071),_0x1d99e4=_0x4554bf?re(_0x4554bf,_0x10610b['path']):{};return{'app':O(_0x50bdc0),'permissions':T(_0x50bdc0),'user':_0x347ee7,'metadata':_0x2dfe8a,'body':_0x466bb0,'query':_0x58aa48,'params':_0x1d99e4,'method':_0xdea948,'pathname':_0x239c1a,'requestUrl':_0x10610b['url'],'headers':Object['fromEntries'](_0x10610b['raw']['headers']['entries']())};}function Te(_0xd7e3e8){return{'method':_0xd7e3e8['method'],'pathname':_0xd7e3e8['pathname'],'ctx':_0xd7e3e8};}function Fe(_0x1670eb,_0x1fcc72){let {status:_0xeff2cf=0xc8,headers:_0x5d64ce={},body:_0x3ffcda,type:_0x207151}=_0x1670eb??{};return _0x207151==='raw'?new globalThis['Response'](String(_0x3ffcda??''),{'status':_0xeff2cf,'headers':_0x5d64ce}):_0x1fcc72(_0x3ffcda,_0xeff2cf);}function Ne(_0x2c17d6,_0x169e33=null){return N(_0x2c17d6,{'appInfo':_0x169e33});}var V=f;async function Ve(_0x205996){_0x205996?(await U(_0x205996),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x205996)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x51a30f,_0x215f88){let _0x6f1f7=Object['fromEntries'](Object['entries'](_0x51a30f['headers']||{})['map'](([_0x380ed5,_0xfe497e])=>[_0x380ed5['toLowerCase'](),_0xfe497e]));return{'id':_0x51a30f['app']['id']||_0x215f88['appId']||'','name':_0x51a30f['app']['name']||'','version':_0x51a30f['app']['version']||'','description':_0x51a30f['app']['description']||'','metadata':{..._0x51a30f['metadata'],'permissions':_0x51a30f['permissions']},'body':_0x51a30f['body'],'query':_0x51a30f['query'],'params':_0x51a30f?.['params'],'method':_0x51a30f['method'],'pathname':_0x51a30f['pathname'],'requestUrl':_0x51a30f['requestUrl'],'user':_0x51a30f['user'],'headers':_0x6f1f7};}var L=class{constructor(_0xb1900f){this['handle']=null,(this['config']=_0xb1900f,this['logger']=_0xb1900f['logger']||f,this['lifecycle']=W({'appsDir':_0xb1900f['appsDir'],'timeout':_0xb1900f['timeout'],'platformImports':_0xb1900f['platformImports'],'libDir':_0xb1900f['libDir']},{'onCreate':_0x5dbde0=>this['logger']['info']('Worker\x20created',{'appId':_0x5dbde0['appId']}),'onReady':_0x311a72=>{this['lifecycle']['updateStatus'](_0x311a72['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x311a72['appId']});},'onCrash':_0x2f7dde=>this['logger']['error']('Worker\x20crashed',{'appId':_0x2f7dde['appId']}),'onStop':_0x4c4028=>this['logger']['info']('Worker\x20stopped',{'appId':_0x4c4028['appId']})}),this['messaging']=$({'onReady':_0x5cd001=>this['lifecycle']['updateStatus'](_0x5cd001,'running'),'onLog':(_0x5f1f5c,_0x15b163,_0x38fa1d,_0x46e647)=>{(this['logger'][_0x15b163]||this['logger']['info'])['call'](this['logger'],_0x38fa1d,_0x46e647);},'onResult':()=>{}},_0xb1900f['timeout']||0x1d4c0));}async['create'](_0x2da969){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x4f5826=await this['lifecycle']['create'](this['config']['appId'],_0x2da969,this['config']['scriptUrl']);this['messaging']['setup'](_0x4f5826),this['messaging']['sendInit'](_0x4f5826,this['config']['appsDir'],_0x2da969,this['config']['serverPath']),this['handle']=_0x4f5826,await this['waitForReady']();}async['waitForReady'](_0x5d5016=0x2710){let _0x8aa253=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x8aa253>_0x5d5016)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x35f4df=>setTimeout(_0x35f4df,0x64));}}async['invoke'](_0x580ad6){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x580ad6);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x889392){return new L(_0x889392);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;