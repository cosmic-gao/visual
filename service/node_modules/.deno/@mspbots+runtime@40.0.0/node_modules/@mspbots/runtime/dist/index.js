import{join,dirname}from'path';import _0x4ff57a from'process';import{stat}from'fs/promises';async function ie(_0x43c140){try{return await stat(_0x43c140),!0x0;}catch{return![];}}var f={'error':(_0x5da85b,_0x175900)=>console['error']('[ERROR]\x20'+_0x5da85b,_0x175900),'warn':(_0x555d43,_0x4c1866)=>console['warn']('[WARN]\x20'+_0x555d43,_0x4c1866),'info':(_0x435c50,_0x437aa1)=>console['log']('[INFO]\x20'+_0x435c50,_0x437aa1),'debug':(_0xd37499,_0x7c8d5d)=>console['log']('[DEBUG]\x20'+_0xd37499,_0x7c8d5d)};function z(){let _0x4b5406=globalThis['Deno'];if(!_0x4b5406)throw new Error('Deno is not available');return _0x4b5406;}var D=class{constructor(_0x249606,_0x14872a='./lib',_0x2c49b4={}){this['manifest']=_0x249606,this['libDir']=_0x14872a,this['platformImports']=_0x2c49b4;}['buildPerms'](){let _0x5c95b5=this['manifest']['permissions']||{},_0x40dd59={};return _0x5c95b5['net']!==void 0x0&&(_0x40dd59['net']=_0x5c95b5['net']===!![]?!![]:Array['isArray'](_0x5c95b5['net'])?_0x5c95b5['net']:[]),_0x5c95b5['read']!==void 0x0&&(_0x40dd59['read']=_0x5c95b5['read']===!![]?!![]:Array['isArray'](_0x5c95b5['read'])?_0x5c95b5['read']:[]),_0x5c95b5['write']!==void 0x0&&(_0x40dd59['write']=_0x5c95b5['write']===!![]?!![]:Array['isArray'](_0x5c95b5['write'])?_0x5c95b5['write']:[]),_0x5c95b5['env']!==void 0x0&&(_0x40dd59['env']=_0x5c95b5['env']===!![]?!![]:Array['isArray'](_0x5c95b5['env'])?_0x5c95b5['env']:[]),_0x5c95b5['run']!==void 0x0&&(_0x40dd59['run']=_0x5c95b5['run']===!![]?!![]:Array['isArray'](_0x5c95b5['run'])?_0x5c95b5['run']:[]),_0x5c95b5['ffi']!==void 0x0&&(_0x40dd59['ffi']=_0x5c95b5['ffi']===!![]?!![]:Array['isArray'](_0x5c95b5['ffi'])?_0x5c95b5['ffi']:[]),_0x5c95b5['sys']!==void 0x0&&(_0x40dd59['sys']=_0x5c95b5['sys']===!![]?!![]:Array['isArray'](_0x5c95b5['sys'])?_0x5c95b5['sys']:[]),_0x5c95b5['hrtime']!==void 0x0&&(_0x40dd59['hrtime']=_0x5c95b5['hrtime']),_0x40dd59;}['normalize'](_0x3d3282){return _0x3d3282===!![]?[]:Array['isArray'](_0x3d3282)?_0x3d3282:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0xc61062){return join(this['libDir'],_0xc61062+'@*');}['getReadPaths'](){let _0x25b52f=this['getImports']();_0x25b52f['includes']('*')&&(_0x25b52f=Object['keys'](this['platformImports']));let _0x36eb44=[];console['log']('[Permissions] Building package path patterns for imports:',_0x25b52f);for(let _0x17e4d4 of _0x25b52f){let _0x92e5c0=this['getLibPattern'](_0x17e4d4);_0x36eb44['push'](_0x92e5c0),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x17e4d4+'\x20->\x20'+_0x92e5c0);}return console['log']('[Permissions] Final package path patterns:',_0x36eb44),_0x36eb44;}['buildImportMap'](_0x15772a){let _0x108013=this['getImports'](),_0x33ec12=_0x108013['includes']('*')?Object['keys'](_0x15772a):_0x108013;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x33ec12);let _0x2b6df8={};for(let _0x4ac526 of _0x33ec12)if(_0x15772a[_0x4ac526])_0x2b6df8[_0x4ac526]=_0x15772a[_0x4ac526],console['log']('[ImportMap]\x20'+_0x4ac526+'\x20->\x20'+_0x15772a[_0x4ac526]+'\x20(from\x20platform)');else try{let _0x1f3b4f=z(),_0x1303d5=join(_0x1f3b4f['cwd'](),this['libDir']),_0x5a51ec=!0x1;try{for(let _0x16c880 of _0x1f3b4f['readDirSync'](_0x1303d5))if(_0x16c880['isDirectory']&&(_0x16c880['name']===_0x4ac526||_0x16c880['name']['startsWith'](_0x4ac526+'@'))){let _0x2841f8=join(_0x1f3b4f['cwd'](),this['libDir'],_0x16c880['name'],'index.js')['replace'](/\\/g,'/'),_0x3f8a5d=new URL('file:///'+_0x2841f8)['href'];_0x2b6df8[_0x4ac526]=_0x3f8a5d,console['log']('[ImportMap]\x20'+_0x4ac526+'\x20->\x20'+_0x3f8a5d+'\x20(from\x20lib)'),_0x5a51ec=!0x0;break;}}catch{}_0x5a51ec||console['warn']('[ImportMap]\x20Package\x20'+_0x4ac526+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0xf08e5){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x4ac526+':',_0xf08e5);}return _0x2b6df8;}['validateServerImports'](_0x5c6d97){let _0x5e6a38=this['manifest']['name']||this['manifest']['id'],_0xd69eab=this['manifest']['metadata']?.['serverPath'],_0x52cb2a=_0x283a77=>_0x283a77['replace'](/\\/g,'/'),_0x50bd47=z(),_0x298be3=_0x5beb08=>{try{return _0x50bd47['statSync'](_0x5beb08),!0x0;}catch{return![];}},_0x348928=_0xd69eab?_0x52cb2a(_0xd69eab):void 0x0;if(!_0x348928){let _0x1319fb=[_0x5c6d97+'/service/server.js',_0x5c6d97+'/service/server.ts',_0x5c6d97+'/'+_0x5e6a38+'/server.js',_0x5c6d97+'/'+_0x5e6a38+'/server.ts',_0x5c6d97+'/server.js',_0x5c6d97+'/server.ts']['map'](_0x52cb2a);for(let _0x35a2c8 of _0x1319fb)if(_0x298be3(_0x35a2c8)){_0x348928=_0x35a2c8;break;}}if(!_0x348928)return{'valid':![],'violations':['Failed to locate server module']};let _0x50fd61='';try{_0x50fd61=_0x50bd47['readTextFileSync'](_0x348928);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x348928};}let _0x5c69d8=this['getImports']();if(_0x5c69d8['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x348928};let _0x390bd4=_0x5c69d8,_0x89f4c4=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x226a88=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0xe38135=/\bimport\s*['"]([^'"]+)['"]/g,_0x1d03bf=[],_0x2970df=new Set(),_0x33cf8d=_0x13ce74=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x13ce74),_0x1e5e3a=_0x355007=>{let _0x3bfd1b=_0x355007;if(_0x3bfd1b['startsWith']('./')||_0x3bfd1b['startsWith']('../')||_0x3bfd1b['startsWith']('/')||_0x3bfd1b['startsWith']('file://')||!_0x33cf8d(_0x355007)||_0x2970df['has'](_0x355007))return;_0x2970df['add'](_0x355007),_0x3bfd1b['startsWith']('npm:')&&(_0x3bfd1b=_0x3bfd1b['substring'](0x4)),_0x3bfd1b['includes']('@')&&!_0x3bfd1b['startsWith']('@')&&(_0x3bfd1b=_0x3bfd1b['split']('@')[0x0]);let _0x1e8c1b=_0x3bfd1b['split']('/')[0x0];_0x390bd4['includes'](_0x1e8c1b)||_0x390bd4['includes'](_0x355007)||_0x1d03bf['push'](_0x355007);},_0x25da61;for(;(_0x25da61=_0x89f4c4['exec'](_0x50fd61))!==null;)_0x1e5e3a(_0x25da61[0x1]);for(;(_0x25da61=_0x226a88['exec'](_0x50fd61))!==null;)_0x1e5e3a(_0x25da61[0x1]);for(;(_0x25da61=_0xe38135['exec'](_0x50fd61))!==null;)_0x1e5e3a(_0x25da61[0x1]);return{'valid':_0x1d03bf['length']===0x0,'violations':_0x1d03bf,'serverPath':_0x348928};}['validate'](_0x6e86ed={}){let _0x2c3dcc=[],_0x123b74=this['manifest']['permissions']||{};try{let _0xb56683=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0xb56683);}catch{}let _0x3f03c2=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x3b1f23,_0x29bfa6]of Object['entries'](_0x123b74))if(_0x3b1f23==='hrtime')typeof _0x29bfa6!='boolean'&&_0x2c3dcc['push']('Permission\x20\x27'+_0x3b1f23+'\x27\x20must\x20be\x20boolean');else{if(_0x3b1f23==='langchain')typeof _0x29bfa6!='boolean'&&(typeof _0x29bfa6!='object'||_0x29bfa6===null)?_0x2c3dcc['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x29bfa6=='object'&&(_0x29bfa6===null||!('enabled'in _0x29bfa6)||typeof _0x29bfa6['enabled']!='boolean')&&_0x2c3dcc['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x3b1f23==='kv')typeof _0x29bfa6!='boolean'&&_0x2c3dcc['push']('Permission\x20\x27'+_0x3b1f23+'\x27\x20must\x20be\x20boolean');else{if(_0x3b1f23==='mspbots')Array['isArray'](_0x29bfa6)||_0x2c3dcc['push']('Permission\x20\x27'+_0x3b1f23+'\x27\x20must\x20be\x20an\x20array');else{if(_0x3b1f23==='db'){if(typeof _0x29bfa6!='object'||_0x29bfa6===null||Array['isArray'](_0x29bfa6))_0x2c3dcc['push']('Permission\x20\x27'+_0x3b1f23+'\x27\x20must\x20be\x20an\x20object');else{let _0x4146e1=_0x29bfa6,_0x4c79f3=['user','password']['filter'](_0x3b5856=>!(_0x3b5856 in _0x4146e1));_0x4c79f3['length']>0x0&&_0x2c3dcc['push']('Permission\x20\x27'+_0x3b1f23+'\x27\x20missing\x20required\x20fields:\x20'+_0x4c79f3['join'](',\x20'));}}else{if(_0x3b1f23==='imports')continue;_0x3f03c2['has'](_0x3b1f23)||typeof _0x29bfa6!='boolean'&&!Array['isArray'](_0x29bfa6)&&_0x2c3dcc['push']('Permission\x20\x27'+_0x3b1f23+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x184152=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x184152))_0x2c3dcc['push']('permissions.imports must be an array');else{for(let _0x4ce4c4 of _0x184152)typeof _0x4ce4c4!='string'&&_0x2c3dcc['push']('import\x20\x27'+_0x4ce4c4+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x2c3dcc['length']===0x0,'errors':_0x2c3dcc};}};function q(_0x49ef0f,_0x5ce810,_0x17d76a){return new D(_0x49ef0f,_0x5ce810,_0x17d76a||{});}var R=null;function I(){let _0x214115=globalThis['Deno'];if(!_0x214115)throw new Error('Deno is not available');return _0x214115;}async function K(){if(R)return{...R};try{let _0x4fd1ac=I(),_0x39b63a=join(_0x4fd1ac['cwd'](),'deno.json'),_0xd6029a=await _0x4fd1ac['readTextFile'](_0x39b63a);return R=JSON['parse'](_0xd6029a)['imports']||{},{...R};}catch(_0x3ceda6){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x3ceda6),{};}}var E=class{constructor(_0x35f1b7,_0x13f4d9={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x35f1b7['appsDir'],this['platformImportsOverride']=_0x35f1b7['platformImports'],this['libDir']=_0x35f1b7['libDir'],this['events']=_0x13f4d9);}async['create'](_0x193f57,_0x2e99c1,_0x9c4f){try{return await this['createWorker'](_0x193f57,_0x2e99c1,_0x9c4f);}catch(_0x185d3b){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x193f57+':',_0x185d3b),_0x185d3b;}}async['createWorker'](_0x4921e2,_0xf7fd12,_0x4b6543){let _0x3166ce=this['platformImportsOverride']||await K(),_0x243719=q(_0xf7fd12,this['libDir'],_0x3166ce)['validateServerImports'](this['appsDir']);if(!_0x243719['valid']){let _0x4a602f=_0x243719['violations']['filter'](_0x55dd6a=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x55dd6a)),_0x476ef9=_0x243719['serverPath']?_0x243719['serverPath']:(_0xf7fd12['name']||_0xf7fd12['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x476ef9+':\x20'+_0x4a602f['join'](',\x20'));}let _0x366f09=q(_0xf7fd12,this['libDir'],_0x3166ce),_0xa29749=_0x366f09['validate'](_0x3166ce);if(!_0xa29749['valid'])throw new Error('Invalid\x20config:\x20'+_0xa29749['errors']['join'](',\x20'));let _0x1ddc5c=_0x366f09['buildImportMap'](_0x3166ce);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x4921e2+':',_0x1ddc5c);let _0x38e288=_0x366f09['buildPerms'](),_0xf2f62e=_0x366f09['getReadPaths']();if(_0x38e288['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x38e288['read']);else{let _0x4fb458=_0xf7fd12['name']||_0x4921e2,_0x587cb8=this['appsDir']+'/'+_0x4fb458,_0x4512d4=[_0x587cb8],_0x18e252=_0xf7fd12['metadata']?.['serverPath'];if(_0x18e252&&typeof _0x18e252=='string')try{let _0x510948=dirname(_0x18e252)['replace'](/\\/g,'/');_0x4512d4['push'](_0x510948);}catch{}_0x38e288['read']=_0x4512d4,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x587cb8);}if(_0xf2f62e['length']>0x0){if(_0x38e288['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x25184e=Array['isArray'](_0x38e288['read'])?_0x38e288['read']:[];_0x38e288['read']=[..._0x25184e,..._0xf2f62e],console['log']('[Worker] Added package read permissions:',_0xf2f62e);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x38e288['net']||(_0x38e288['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x4921e2+':',_0x38e288['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x38e288['read']===!![]?'unrestricted':Array['isArray'](_0x38e288['read'])?_0x38e288['read']['length']:0x0));let _0x55db62=await this['createImportMap'](_0x4921e2,_0x1ddc5c),_0x506662=await this['createLock'](_0x4921e2,_0x1ddc5c),_0x1f55f1={'type':'module','deno':{'permissions':{}}};_0x1f55f1['deno']['namespace']=![],_0x1f55f1['deno']['permissions']=_0x38e288,_0x1f55f1['deno']['importMap']=_0x55db62,_0x1f55f1['deno']['lock']=_0x506662,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x4921e2+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x55db62),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x506662),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x1ddc5c)['length']+'\x20('+(Object['keys'](_0x1ddc5c)['join'](',\x20')||'none')+')');let _0xc9d5ce={'worker':new Worker(_0x4b6543,_0x1f55f1),'appId':_0x4921e2,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0xf7fd12,'importMapPath':_0x55db62,'lockfilePath':_0x506662};return this['workers']['set'](_0x4921e2,_0xc9d5ce),this['events']['onCreate']?.(_0xc9d5ce),_0xc9d5ce;}async['createLock'](_0x50c86d,_0x3f4447){let _0x7833cd=I(),_0x3137fe=join(_0x7833cd['cwd'](),'storage','temp','lockfiles');await _0x7833cd['mkdir'](_0x3137fe,{'recursive':!![]});let _0x46442f=_0x50c86d+'-'+Date['now']()+'.lock',_0x1e9b97=join(_0x3137fe,_0x46442f),_0x568cdb={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x4f7d96,_0x3b924c]of Object['entries'](_0x3f4447))if(_0x3b924c['startsWith']('npm:'))_0x3b924c['replace']('npm:',''),_0x568cdb['packages']['specifiers'][_0x4f7d96]=_0x3b924c;else _0x3b924c['startsWith']('file://')&&(_0x568cdb['packages']['specifiers'][_0x4f7d96]=_0x3b924c);let _0xa08a54=JSON['stringify'](_0x568cdb,null,0x2);return await _0x7833cd['writeTextFile'](_0x1e9b97,_0xa08a54),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x1e9b97),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x3f4447)['length']+'):',Object['keys'](_0x3f4447)),_0x1e9b97;}async['createImportMap'](_0x3babef,_0x88d0fd){let _0x444e91=I(),_0x4c94e9=join(_0x444e91['cwd'](),'storage','temp','importmaps');await _0x444e91['mkdir'](_0x4c94e9,{'recursive':!![]});let _0x465006=_0x3babef+'-'+Date['now']()+'.json',_0x3d8e0b=join(_0x4c94e9,_0x465006),_0x1a3a97=JSON['stringify']({'imports':_0x88d0fd,'scopes':{}},null,0x2);return await _0x444e91['writeTextFile'](_0x3d8e0b,_0x1a3a97),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x3d8e0b),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x88d0fd)['length']+'):',Object['keys'](_0x88d0fd)['join'](',\x20')||'none'),_0x3d8e0b;}['get'](_0x3b80c7){return this['workers']['get'](_0x3b80c7);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x103661,_0x179660){let _0x4c99f0=this['workers']['get'](_0x103661);if(!_0x4c99f0)return;let _0x49ce98=_0x4c99f0['status'];_0x4c99f0['status']=_0x179660,_0x179660==='running'&&_0x49ce98==='starting'?this['events']['onReady']?.(_0x4c99f0):_0x179660==='crashed'&&this['events']['onCrash']?.(_0x4c99f0);}['touch'](_0x1c6f5b){let _0xafeaa0=this['workers']['get'](_0x1c6f5b);_0xafeaa0&&(_0xafeaa0['lastUsed']=Date['now']());}async['stop'](_0x455d74){let _0x417b88=this['workers']['get'](_0x455d74);if(_0x417b88)try{_0x417b88['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x417b88['worker']['terminate'](),_0x417b88['status']='stopped',this['events']['onStop']?.(_0x417b88),_0x417b88['importMapPath']&&await this['cleanupImportMap'](_0x417b88['importMapPath']),_0x417b88['lockfilePath']&&await this['cleanupLock'](_0x417b88['lockfilePath']);}catch(_0x23fd5b){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x455d74+':',_0x23fd5b);}finally{this['workers']['delete'](_0x455d74);}}async['cleanupImportMap'](_0x19db88){try{await I()['remove'](_0x19db88),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x19db88);}catch(_0xa7ec32){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x19db88,_0xa7ec32);}}async['cleanupLock'](_0x1b676f){try{await I()['remove'](_0x1b676f),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x1b676f);}catch(_0x10e5ff){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x1b676f,_0x10e5ff);}}async['stopAll'](){let _0x313028=Array['from'](this['workers']['keys']());await Promise['all'](_0x313028['map'](_0x1c2c7c=>this['stop'](_0x1c2c7c)));}async['restart'](_0x3b37ab,_0x1fbcf4){let _0x3fc730=this['workers']['get'](_0x3b37ab);if(!_0x3fc730)throw new Error('Worker\x20'+_0x3b37ab+'\x20not\x20found');let _0x496d8b=_0x3fc730['manifest'];return await this['stop'](_0x3b37ab),await this['create'](_0x3b37ab,_0x496d8b,_0x1fbcf4);}['checkHealth'](_0x3f02f4){let _0x2d265f=this['workers']['get'](_0x3f02f4);if(!_0x2d265f)return{'healthy':![],'reason':'Not\x20found'};if(_0x2d265f['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x2d265f['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x3067b2=Date['now']()-_0x2d265f['lastUsed'],_0x24865a=0x708*0x3e8;return _0x3067b2>_0x24865a?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x3067b2/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x34060e=0x708*0x3e8,_0x56923a){let _0x313dcf=Date['now'](),_0x23b44c=[];for(let [_0x49abf1,_0x22c0f0]of this['workers']['entries']()){let _0x4c4539=_0x313dcf-_0x22c0f0['lastUsed'];_0x4c4539>_0x34060e&&_0x23b44c['push']({'appId':_0x49abf1,'idle':_0x4c4539});}_0x23b44c['sort']((_0xe9db4c,_0xb85e17)=>_0xb85e17['idle']-_0xe9db4c['idle']);let _0x588be3=_0x56923a?_0x23b44c['slice'](0x0,_0x56923a)['map'](_0x3a5be5=>_0x3a5be5['appId']):_0x23b44c['map'](_0x955443=>_0x955443['appId']);for(let _0x115dd6 of _0x588be3)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x115dd6),await this['stop'](_0x115dd6);}['stats'](){let _0x468b2c={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x57d66f=Date['now']();for(let _0x14efdf of this['workers']['values']())_0x468b2c['byStatus'][_0x14efdf['status']]++,_0x468b2c['workers']['push']({'appId':_0x14efdf['appId'],'status':_0x14efdf['status'],'version':_0x14efdf['version'],'lastUsed':_0x14efdf['lastUsed'],'idle':_0x57d66f-_0x14efdf['lastUsed']});return _0x468b2c;}['startCleanup'](_0x3aba8e=0x12c*0x3e8,_0x5336e6){let _0x2d95ba=setInterval(()=>{this['cleanup'](_0x5336e6)['catch'](_0x30fee7=>{console['error']('Cleanup\x20failed:',_0x30fee7);});},_0x3aba8e);return()=>clearInterval(_0x2d95ba);}['delay'](_0x5e728e){return new Promise(_0x6e4ecd=>setTimeout(_0x6e4ecd,_0x5e728e));}};function W(_0x22379a,_0x28d20d){return new E(_0x22379a,_0x28d20d);}var v=f,j=class{constructor(_0xa2a3eb,_0x601ac1=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0xa2a3eb,this['timeout']=_0x601ac1);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0xd6c4de){_0xd6c4de['worker']['onmessage']=_0x423845=>{let _0x19fc76=_0x423845['data'],{appId:_0x43a13b}=_0xd6c4de;switch(_0x19fc76['type']){case'ready':this['events']['onReady'](_0x43a13b),v['info']('Worker\x20ready',{'appId':_0x43a13b,'version':_0xd6c4de['version']});break;case'log':{let {level:_0x18f3bc='info',message:_0x12cea4,meta:_0x344bcb}=_0x19fc76,_0x57e3b4={..._0x344bcb||{},'appId':_0x43a13b,'version':_0xd6c4de['version']};this['events']['onLog'](_0x43a13b,_0x18f3bc,_0x12cea4,_0x57e3b4);break;}case'result':{let {reqId:_0x3b7b05,ok:_0x19ae9b,response:_0x1bec3d,error:_0x544d0f}=_0x19fc76,_0x347876=this['pending']['get'](_0x3b7b05);if(!_0x347876){v['warn']('Unknown\x20request',{'appId':_0x43a13b,'reqId':_0x3b7b05});return;}if(this['pending']['delete'](_0x3b7b05),_0x19ae9b&&_0x1bec3d)_0x347876['resolve'](_0x1bec3d);else{let _0x13cc0c=new Error(_0x544d0f?.['message']||'Worker\x20error');_0x13cc0c['stack']=_0x544d0f?.['stack'],_0x347876['reject'](_0x13cc0c);}this['events']['onResult'](_0x43a13b,_0x3b7b05,_0x1bec3d||_0x544d0f);break;}default:v['debug']('Unknown\x20message',{'appId':_0x43a13b,'type':_0x19fc76['type']});}},_0xd6c4de['worker']['onerror']=_0x7b3e71=>{let {appId:_0x327ab7}=_0xd6c4de;v['error']('Worker\x20error',{'appId':_0x327ab7,'message':_0x7b3e71['message'],'lineno':_0x7b3e71['lineno'],'filename':_0x7b3e71['filename']}),_0xd6c4de['status']='crashed',this['rejectPending'](_0x327ab7,new Error('Worker\x20'+_0x327ab7+'\x20crashed:\x20'+_0x7b3e71['message'])),_0x7b3e71['preventDefault']();},_0xd6c4de['worker']['onmessageerror']=_0x5cb857=>{let {appId:_0x36ccab}=_0xd6c4de;v['error']('Message\x20error',{'appId':_0x36ccab,'data':_0x5cb857['data']}),_0xd6c4de['status']='crashed',_0x5cb857['preventDefault']();};}['sendInit'](_0x261f0e,_0x3d6e25,_0x44927a,_0x5b1cab){_0x261f0e['worker']['postMessage']({'type':'init','appId':_0x261f0e['appId'],'manifest':_0x44927a,'appsDir':_0x3d6e25,'serverPath':_0x5b1cab});}async['sendInvoke'](_0x125f69,_0x507b08){let _0x206f5f=this['nextId'](),_0x57aecc=_0x125f69['appId'],_0x1c6962=new Promise((_0xb6e7a7,_0x1650fa)=>{let _0x4b6a87=setTimeout(()=>{this['pending']['delete'](_0x206f5f),_0x1650fa(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x206f5f,{'resolve':_0x3bd092=>{clearTimeout(_0x4b6a87),_0xb6e7a7(_0x3bd092);},'reject':_0x1c9eee=>{clearTimeout(_0x4b6a87),_0x1650fa(_0x1c9eee);},'timestamp':Date['now'](),'appId':_0x57aecc});});return _0x125f69['worker']['postMessage']({'type':'invoke','appId':_0x125f69['appId'],'reqId':_0x206f5f,'payload':_0x507b08}),await _0x1c6962;}['rejectPending'](_0x31c473,_0x57d1e4){let _0x4ab59=0x0;for(let [_0x48cc17,_0xa4efbc]of this['pending']['entries']())_0xa4efbc['appId']===_0x31c473&&(this['pending']['delete'](_0x48cc17),_0xa4efbc['reject'](_0x57d1e4),_0x4ab59++);_0x4ab59>0x0&&v['warn']('Rejected\x20'+_0x4ab59+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x31c473});}['cleanupTimeout'](){let _0x11a571=Date['now']();for(let [_0x34ae68,_0x12c4c3]of this['pending']['entries']())_0x11a571-_0x12c4c3['timestamp']>this['timeout']&&(this['pending']['delete'](_0x34ae68),_0x12c4c3['reject'](new Error('Request\x20'+_0x34ae68+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x24a84e){let _0x1e04a5=0x0;for(let _0x38bb17 of this['pending']['values']())_0x38bb17['appId']===_0x24a84e&&_0x1e04a5++;return _0x1e04a5;}['startCleanup'](_0x2e5f2e=0x2710){let _0x5f43f3=setInterval(()=>{this['cleanupTimeout']();},_0x2e5f2e);return()=>clearInterval(_0x5f43f3);}};function $(_0x2fc436,_0x1ebf90){return new j(_0x2fc436,_0x1ebf90);}var Q=class{constructor(_0x17c5ac={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x17c5ac['logger']||f,this['config']={'appsDir':_0x17c5ac['appsDir']||this['getAppsDir'](),'scriptUrl':_0x17c5ac['scriptUrl']||this['getScriptUrl'](),'timeout':_0x17c5ac['timeout']||0x78*0x3e8,'autoCleanup':_0x17c5ac['autoCleanup']??!![],'cleanupInterval':_0x17c5ac['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x17c5ac['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x17c5ac['maxWorkers'],'reuseWorkers':_0x17c5ac['reuseWorkers']??!![],'workerReuseStrategy':_0x17c5ac['workerReuseStrategy']||'lru','enableQueue':_0x17c5ac['enableQueue']??!![],'maxQueueSize':_0x17c5ac['maxQueueSize']||0x64,'queueTimeout':_0x17c5ac['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x360a01=>this['logger']['info']('Worker\x20created',{'appId':_0x360a01['appId'],'v':_0x360a01['version']}),'onReady':_0x5cbcea=>this['lifecycle']['updateStatus'](_0x5cbcea['appId'],'running'),'onCrash':_0x86e13e=>this['logger']['error']('Worker\x20crashed',{'appId':_0x86e13e['appId'],'v':_0x86e13e['version']}),'onStop':_0x856c0e=>this['logger']['info']('Worker\x20stopped',{'appId':_0x856c0e['appId'],'v':_0x856c0e['version']})}),this['messaging']=$({'onReady':_0x14b6f9=>this['lifecycle']['updateStatus'](_0x14b6f9,'running'),'onLog':(_0x1d923c,_0x1066e9,_0x325f7a,_0x479d8e)=>{let _0x17c37c={..._0x479d8e||{},'appId':_0x1d923c};switch(_0x1066e9){case'error':this['logger']['error'](_0x325f7a,_0x17c37c);break;case'warn':this['logger']['warn'](_0x325f7a,_0x17c37c);break;case'debug':this['logger']['debug'](_0x325f7a,_0x17c37c);break;default:this['logger']['info'](_0x325f7a,_0x17c37c);break;}},'onResult':(_0x532dbb,_0x127403,_0x1bd29)=>{this['logger']['debug']('Result\x20received',{'appId':_0x532dbb,'reqId':_0x127403});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x4ff57a['cwd'](),'apps');}['getScriptUrl'](){let _0x53216c=import.meta.url,_0x60016d=_0x53216c['endsWith']('.js')||_0x53216c['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x60016d,_0x53216c)['href'];}async['ensure'](_0x8acd6b){let {id:_0x125df7}=_0x8acd6b,_0x21c150=this['lifecycle']['get'](_0x125df7);if(_0x21c150){let _0x414e00=this['lifecycle']['checkHealth'](_0x125df7);if(_0x414e00['healthy'])return this['lifecycle']['touch'](_0x125df7),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x125df7}),_0x21c150;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x125df7,'reason':_0x414e00['reason']}),await this['lifecycle']['stop'](_0x125df7);}for(;;){let _0xe6546f=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0xe6546f>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0xe6546f,'max':this['config']['maxWorkers'],'appId':_0x125df7}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x8acd6b);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x54b5e0=await this['loadManifest'](_0x125df7,_0x8acd6b['manifest']),_0x4b61c8=await this['lifecycle']['create'](_0x125df7,_0x54b5e0,this['config']['scriptUrl']),_0x2d4ef4=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x2d4ef4>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x2d4ef4,'max':this['config']['maxWorkers'],'appId':_0x125df7}),await this['lifecycle']['stop'](_0x125df7),this['config']['enableQueue'])return await this['waitSlot'](_0x8acd6b);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x2d4ef4+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x4b61c8);let _0xb80818=_0x54b5e0['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x4b61c8,this['config']['appsDir'],_0x54b5e0,_0xb80818),this['logger']['info']('Worker\x20created',{'appId':_0x125df7,'v':_0x4b61c8['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x4b61c8;}async['evictIdle'](){let _0x2aa7c9=this['lifecycle']['getAll']();if(_0x2aa7c9['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x5dfae1=[..._0x2aa7c9];this['config']['workerReuseStrategy']==='lru'?_0x5dfae1['sort']((_0x40da78,_0x27e7d2)=>_0x40da78['lastUsed']-_0x27e7d2['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x5dfae1['sort']((_0x3fc94b,_0x5ade70)=>_0x3fc94b['version']-_0x5ade70['version']);let _0xb0072b=null;for(let _0x109993 of _0x5dfae1)if(this['messaging']['getAppCount'](_0x109993['appId'])===0x0){_0xb0072b=_0x109993;break;}if(!_0xb0072b&&_0x5dfae1['length']>0x0&&(_0xb0072b=_0x5dfae1['reduce']((_0x501b9f,_0xb5b3bb)=>{let _0x1b156d=this['messaging']['getAppCount'](_0x501b9f['appId']);return this['messaging']['getAppCount'](_0xb5b3bb['appId'])<_0x1b156d?_0xb5b3bb:_0x501b9f;})),_0xb0072b){let _0x80e0ad=this['messaging']['getAppCount'](_0xb0072b['appId']);return _0x80e0ad>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0xb0072b['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0xb0072b['lastUsed'],'pendingRequests':_0x80e0ad}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0xb0072b['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0xb0072b['lastUsed']}),await this['lifecycle']['stop'](_0xb0072b['appId']),!![];}return![];}['waitSlot'](_0x34a0e9){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0xfb1a4b,_0x5da0fc)=>{let _0x1eb0db={'info':_0x34a0e9,'resolve':_0xfb1a4b,'reject':_0x5da0fc,'timestamp':Date['now']()};this['requestQueue']['push'](_0x1eb0db),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x34a0e9['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x2af528=setTimeout(()=>{let _0x14dcf8=this['requestQueue']['indexOf'](_0x1eb0db);_0x14dcf8!==-0x1&&(this['requestQueue']['splice'](_0x14dcf8,0x1),_0x5da0fc(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x1eb0db['resolve']=_0x3f8ab9=>{clearTimeout(_0x2af528),_0xfb1a4b(_0x3f8ab9);},_0x1eb0db['reject']=_0x55e998=>{clearTimeout(_0x2af528),_0x5da0fc(_0x55e998);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x1c00a0=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x1c00a0>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x5813e2=this['requestQueue']['shift']();if(!_0x5813e2)break;try{let _0x4d6a83=await this['ensure'](_0x5813e2['info']);_0x5813e2['resolve'](_0x4d6a83);}catch(_0x2331f0){_0x5813e2['reject'](_0x2331f0);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x667cd3,_0x48ee11){let _0x40da5a=this['config']['appsDir']['replace'](/\\/g,'/'),_0x4f798f=async _0x5c0b84=>{try{let _0x85ed18=globalThis['Deno'];if(!_0x85ed18)return null;let _0x215e86=await _0x85ed18['readTextFile'](_0x5c0b84);return JSON['parse'](_0x215e86);}catch{return null;}};if(_0x48ee11?.['name']){let _0x15a3ee=await _0x4f798f(_0x40da5a+'/'+_0x48ee11['name']+'/manifest.json');if(_0x15a3ee)return _0x15a3ee;}let _0x27e007=await _0x4f798f(_0x40da5a+'/'+_0x667cd3+'/manifest.json');if(_0x27e007)return _0x27e007;try{let _0x227743=globalThis['Deno'];if(_0x227743)for await(let _0x2afbc5 of _0x227743['readDir'](_0x40da5a)){if(!_0x2afbc5['isDirectory'])continue;let _0x63d315=_0x40da5a+'/'+_0x2afbc5['name']+'/manifest.json',_0x18e9b4=await _0x4f798f(_0x63d315);if(_0x18e9b4&&(_0x18e9b4['id']===_0x667cd3||_0x48ee11?.['name']&&_0x18e9b4['name']===_0x48ee11['name']))return _0x18e9b4;}}catch(_0x1c7ea9){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x667cd3,'error':_0x1c7ea9['message']});}return _0x48ee11||{'id':_0x667cd3,'name':_0x667cd3,'version':'1.0.0'};}async['invoke'](_0x58058a){let _0x47d421=_0x58058a['ctx']['app']['id'],_0x290c59=_0x58058a['ctx']['app']['name'];try{let _0x484c95={'id':_0x47d421,'manifest':{'id':_0x47d421,'name':_0x290c59}},_0x1ae1e9=await this['ensure'](_0x484c95);if(_0x1ae1e9['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x47d421}),await this['restart'](_0x47d421);let _0x315f51=await this['ensure'](_0x484c95);return this['lifecycle']['touch'](_0x47d421),await this['messaging']['sendInvoke'](_0x315f51,_0x58058a);}return this['lifecycle']['touch'](_0x47d421),await this['messaging']['sendInvoke'](_0x1ae1e9,_0x58058a);}catch(_0xb765e2){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x47d421,'error':_0xb765e2['message'],'stack':_0xb765e2['stack']}),_0xb765e2;}}async['stop'](_0x1aec4a){await this['lifecycle']['stop'](_0x1aec4a),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x54a9b5){return await this['lifecycle']['restart'](_0x54a9b5,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x5b2686=>({'appId':_0x5b2686['appId'],'status':_0x5b2686['status'],'version':_0x5b2686['version'],'lastUsed':_0x5b2686['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x25039c=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x44f2bd=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x25039c(),_0x44f2bd();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0xce1ba=>{_0xce1ba?(await this['stop'](_0xce1ba),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0xce1ba})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x565554){return new Q(_0x565554);}var S=null;function be(_0x33bb5c){S=ee(_0x33bb5c);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x106b25){return await k()['ensure'](_0x106b25);}async function xe(_0x5e7c34){return await k()['invoke'](_0x5e7c34);}function Ie(_0x157dc2){k()['stop'](_0x157dc2)['catch'](_0xb4a32c=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x157dc2,'error':_0xb4a32c['message']});});}function Re(){k()['stopAll']()['catch'](_0x4057c=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x4057c['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x12ed12){await k()['stop'](_0x12ed12);}async function Se(){await k()['stopAll']();}function Ae(_0x15c3ea){let _0x580bbb=_0x15c3ea&&typeof _0x15c3ea=='object'?_0x15c3ea:null;if(_0x580bbb&&'user'in _0x580bbb)return _0x580bbb['user'];}function H(_0x48c1fe){let _0x2f2e7a=_0x48c1fe&&typeof _0x48c1fe=='object'?_0x48c1fe:null;if(!_0x2f2e7a)return{};let _0x8eaf86={};for(let [_0x29462f,_0x2ac7fc]of Object['entries'](_0x2f2e7a))_0x29462f!=='user'&&(_0x8eaf86[_0x29462f]=_0x2ac7fc);return _0x8eaf86;}function O(_0x48e3c0){return _0x48e3c0?{'id':_0x48e3c0['manifest']?.['id']||_0x48e3c0['id']||'','name':_0x48e3c0['manifest']?.['name']||'','version':_0x48e3c0['manifest']?.['version']||'','description':_0x48e3c0['manifest']?.['description']||'','icon':_0x48e3c0['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x37bae3){return _0x37bae3?.['permissions']||_0x37bae3?.['manifest']?.['permissions']||{};}function F(_0x252973){return _0x252973?.['manifest']?.['metadata']||{};}function Ce(_0x21c256){return _0x21c256?{'appId':_0x21c256['id'],'appName':_0x21c256['manifest']?.['name']}:{};}function N(_0x246a9d,_0x2c81a7={}){let {appInfo:_0x3002fb=null,status:_0x5064d1=0x1f4,defaultMessage:_0x2c26c0='Internal\x20Server\x20Error'}=_0x2c81a7,_0x4ace43={'error':_0x2c26c0,'message':_0x246a9d?.['message']||_0x2c26c0};return _0x3002fb&&(_0x4ace43['appId']=_0x3002fb['id'],_0x4ace43['appName']=_0x3002fb['manifest']?.['name']),_0x246a9d?.['message']?.['includes']('crashed')&&(_0x4ace43['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x5064d1,'body':_0x4ace43};}function qe(_0x26cb72){return _0x26cb72?.['message']?.['includes']('crashed')||![];}function J(_0x1821dd){if(_0x1821dd)try{return JSON['parse'](_0x1821dd);}catch{return _0x1821dd;}}function B(_0x4238ab){try{let _0x227a44=new URL(_0x4238ab),_0x535d23={};for(let _0xdb6da2 of _0x227a44['searchParams']['keys']()){let _0x3ea01f=_0x227a44['searchParams']['getAll'](_0xdb6da2)['map'](_0x18eb88=>_0x18eb88);_0x3ea01f['length']<=0x1?_0x535d23[_0xdb6da2]=_0x3ea01f[0x0]??'':_0x535d23[_0xdb6da2]=_0x3ea01f;}return _0x535d23;}catch{return{};}}function Le(_0x2a2f7c){return(()=>{try{return new URL(_0x2a2f7c)['pathname'];}catch{return _0x2a2f7c;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x2ac1c8,_0x528829){let _0x456edc=_0x2ac1c8;if(_0x528829&&_0x456edc['startsWith']('/apps/'+_0x528829))_0x456edc=_0x456edc['substring'](('/apps/'+_0x528829)['length'])||'/';else{let _0x30b95a=_0x456edc['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x30b95a&&(_0x456edc=_0x30b95a[0x1]||'/');}return _0x456edc['startsWith']('/api')&&(_0x456edc=_0x456edc['substring'](0x4)||'/'),_0x456edc;}function Ue(_0x20a0e9,_0x336dd8){let _0x41ca1f=_0x20a0e9;if(_0x336dd8&&_0x41ca1f['startsWith']('/apps/'+_0x336dd8))_0x41ca1f=_0x41ca1f['substring'](('/apps/'+_0x336dd8)['length'])||'/';else{let _0x444205=_0x41ca1f['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x444205&&(_0x41ca1f=_0x444205[0x1]||'/');}return(!_0x41ca1f||_0x41ca1f==='/')&&(_0x41ca1f='/index.html'),_0x41ca1f;}async function He(_0x45edd9,_0x18f85f){return await _0x18f85f(_0x45edd9);}function _(_0x57a54b){return _0x57a54b['split']('/')['filter'](_0x1e4fec=>_0x1e4fec['length']>0x0);}function te(_0x5c8b49){try{return decodeURIComponent(_0x5c8b49);}catch{return _0x5c8b49;}}function re(_0x5b516c,_0x3cb141){let _0x30c15b=_(_0x5b516c),_0x44417d=_(_0x3cb141),_0x871633={},_0x5d72d0=0x0,_0x5adb14=0x0;for(;_0x5d72d0<_0x30c15b['length']&&_0x5adb14<_0x44417d['length'];){let _0x434fc4=_0x30c15b[_0x5d72d0],_0x541650=_0x44417d[_0x5adb14];if(_0x434fc4==='*')break;if(_0x434fc4['startsWith'](':')){let _0x19d7c9=_0x434fc4['slice'](0x1);_0x19d7c9&&(_0x871633[_0x19d7c9]=te(_0x541650)),_0x5d72d0++,_0x5adb14++;continue;}if(_0x434fc4!==_0x541650)return{};_0x5d72d0++,_0x5adb14++;}return _0x5d72d0===_0x30c15b['length']||_0x5d72d0===_0x30c15b['length']-0x1&&_0x30c15b[_0x5d72d0]==='*',_0x871633;}async function Oe(_0x4bdbd7,_0x4e70f0,_0x467c83,_0x279540,_0x33be83=void 0x0,_0x2bd8b7){let _0x27ba18=await _0x4e70f0['text'](),_0x342b88=J(_0x27ba18),_0x4f823a=B(_0x4e70f0['url']),_0x1871d0={...F(_0x4bdbd7),'user':_0x33be83},_0x227123=H(_0x1871d0),_0x3f17b5=_0x2bd8b7?re(_0x2bd8b7,_0x4e70f0['path']):{};return{'app':O(_0x4bdbd7),'permissions':T(_0x4bdbd7),'user':_0x33be83,'metadata':_0x227123,'body':_0x342b88,'query':_0x4f823a,'params':_0x3f17b5,'method':_0x467c83,'pathname':_0x279540,'requestUrl':_0x4e70f0['url'],'headers':Object['fromEntries'](_0x4e70f0['raw']['headers']['entries']())};}function Te(_0x4c61df){return{'method':_0x4c61df['method'],'pathname':_0x4c61df['pathname'],'ctx':_0x4c61df};}function Fe(_0x46eb5e,_0x6f220e){let {status:_0x3ab291=0xc8,headers:_0x402f59={},body:_0x3d495f,type:_0xe49a72}=_0x46eb5e??{};return _0xe49a72==='raw'?new globalThis['Response'](String(_0x3d495f??''),{'status':_0x3ab291,'headers':_0x402f59}):_0x6f220e(_0x3d495f,_0x3ab291);}function Ne(_0x5dbdb5,_0x285776=null){return N(_0x5dbdb5,{'appInfo':_0x285776});}var V=f;async function Ve(_0xbf9327){_0xbf9327?(await U(_0xbf9327),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0xbf9327)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x3ec120,_0x33e5f4){let _0x437f50=Object['fromEntries'](Object['entries'](_0x3ec120['headers']||{})['map'](([_0x18d525,_0x4b89a9])=>[_0x18d525['toLowerCase'](),_0x4b89a9]));return{'id':_0x3ec120['app']['id']||_0x33e5f4['appId']||'','name':_0x3ec120['app']['name']||'','version':_0x3ec120['app']['version']||'','description':_0x3ec120['app']['description']||'','metadata':{..._0x3ec120['metadata'],'permissions':_0x3ec120['permissions']},'body':_0x3ec120['body'],'query':_0x3ec120['query'],'params':_0x3ec120?.['params'],'method':_0x3ec120['method'],'pathname':_0x3ec120['pathname'],'requestUrl':_0x3ec120['requestUrl'],'user':_0x3ec120['user'],'headers':_0x437f50};}var L=class{constructor(_0x5f4d82){this['handle']=null,(this['config']=_0x5f4d82,this['logger']=_0x5f4d82['logger']||f,this['lifecycle']=W({'appsDir':_0x5f4d82['appsDir'],'timeout':_0x5f4d82['timeout'],'platformImports':_0x5f4d82['platformImports'],'libDir':_0x5f4d82['libDir']},{'onCreate':_0x2b2d45=>this['logger']['info']('Worker\x20created',{'appId':_0x2b2d45['appId']}),'onReady':_0x364566=>{this['lifecycle']['updateStatus'](_0x364566['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x364566['appId']});},'onCrash':_0x9fcf84=>this['logger']['error']('Worker\x20crashed',{'appId':_0x9fcf84['appId']}),'onStop':_0x10bde2=>this['logger']['info']('Worker\x20stopped',{'appId':_0x10bde2['appId']})}),this['messaging']=$({'onReady':_0x3ae93a=>this['lifecycle']['updateStatus'](_0x3ae93a,'running'),'onLog':(_0x5619db,_0x39e98e,_0xe4ea78,_0x2a5e92)=>{(this['logger'][_0x39e98e]||this['logger']['info'])['call'](this['logger'],_0xe4ea78,_0x2a5e92);},'onResult':()=>{}},_0x5f4d82['timeout']||0x1d4c0));}async['create'](_0xcdc57a){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x333da4=await this['lifecycle']['create'](this['config']['appId'],_0xcdc57a,this['config']['scriptUrl']);this['messaging']['setup'](_0x333da4),this['messaging']['sendInit'](_0x333da4,this['config']['appsDir'],_0xcdc57a,this['config']['serverPath']),this['handle']=_0x333da4,await this['waitForReady']();}async['waitForReady'](_0x5600e5=0x2710){let _0x346042=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x346042>_0x5600e5)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x3e243f=>setTimeout(_0x3e243f,0x64));}}async['invoke'](_0x17f5ed){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x17f5ed);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x5716e4){return new L(_0x5716e4);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};