'use strict';function c(_0x1c5cb6,_0x32b359){let _0x45473e=Object['fromEntries'](Object['entries'](_0x1c5cb6['headers']||{})['map'](([_0x464ddf,_0x39b52f])=>[_0x464ddf['toLowerCase'](),_0x39b52f]));return{'id':_0x1c5cb6['app']['id']||_0x32b359['appId']||'','name':_0x1c5cb6['app']['name']||'','version':_0x1c5cb6['app']['version']||'','description':_0x1c5cb6['app']['description']||'','metadata':{..._0x1c5cb6['metadata'],'permissions':_0x1c5cb6['permissions']},'body':_0x1c5cb6['body'],'query':_0x1c5cb6['query'],'params':_0x1c5cb6?.['params'],'method':_0x1c5cb6['method'],'pathname':_0x1c5cb6['pathname'],'requestUrl':_0x1c5cb6['requestUrl'],'user':_0x1c5cb6['user'],'headers':_0x45473e};}function f(_0x2f667b){return _0x2f667b['split']('/')['filter'](_0x101550=>_0x101550['length']>0x0);}function P(_0x448d75,_0x2cef9c){let _0x4e1cb3=f(_0x448d75),_0x3678c7=f(_0x2cef9c),_0xf57052=0x0,_0x2e6cb8=0x0;for(;_0xf57052<_0x4e1cb3['length']&&_0x2e6cb8<_0x3678c7['length'];){let _0x1e7ffc=_0x4e1cb3[_0xf57052],_0x35fd0c=_0x3678c7[_0x2e6cb8];if(_0x1e7ffc==='*')return!![];if(_0x1e7ffc['startsWith'](':')){_0xf57052++,_0x2e6cb8++;continue;}if(_0x1e7ffc!==_0x35fd0c)return![];_0xf57052++,_0x2e6cb8++;}return _0xf57052===_0x4e1cb3['length']&&_0x2e6cb8===_0x3678c7['length']||_0xf57052===_0x4e1cb3['length']-0x1&&_0x4e1cb3[_0xf57052]==='*';}function m(_0x275692,_0x285367,_0x5d7c8b){let _0xa17238=_0x285367+'\x20'+_0x5d7c8b;if(_0x275692[_0xa17238])return{'handler':_0x275692[_0xa17238],'routePattern':_0x5d7c8b};let _0x52bbc0=[];_0x5d7c8b['startsWith']('/api')?_0x52bbc0['push'](_0x5d7c8b['substring'](0x4)||'/'):_0x52bbc0['push']('/api'+_0x5d7c8b),_0x52bbc0['push'](_0x5d7c8b);for(let _0x595415 of _0x52bbc0)for(let _0x3f25b5 of Object['keys'](_0x275692)){if(!_0x3f25b5['startsWith'](_0x285367+'\x20'))continue;let _0xfeaa4d=_0x3f25b5['substring'](_0x285367['length']+0x1);if(P(_0xfeaa4d,_0x595415))return{'handler':_0x275692[_0x3f25b5],'routePattern':_0xfeaa4d};}return null;}function k(_0x2c5a8a){return typeof _0x2c5a8a=='function'?{'handler':_0x2c5a8a,'routePattern':''}:_0x2c5a8a;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0xc1a03c){let _0x17aaba=async _0x24caac=>{try{let _0x29239f=globalThis['Deno'];if(!_0x29239f)throw new Error('Deno is not available');return await _0x29239f['stat'](_0x24caac),!0x0;}catch{return![];}};if(_0xc1a03c&&typeof _0xc1a03c=='string'&&_0xc1a03c['length']>0x0)return _0xc1a03c;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x245b6c=s['manifest']?.['metadata']?.['serverPath'];if(_0x245b6c&&typeof _0x245b6c=='string'&&_0x245b6c['length']>0x0)return _0x245b6c;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x4d5d09=s['manifest']['name'];if(!_0x4d5d09)throw new Error('Manifest\x20name\x20not\x20found');let _0x285a7d=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x4d5d09+'/server.js',s['appsDir']+'/'+_0x4d5d09+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x19b5de of _0x285a7d)if(await _0x17aaba(_0x19b5de))return _0x19b5de;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x285a7d['join'](',\x20'));}function R(){let _0x3a0641=['log','info','warn','error','debug','trace'];for(let _0x5107cb of _0x3a0641){let _0xda5db2=(console[_0x5107cb]||console['log'])['bind'](console);console[_0x5107cb]=(..._0x25d906)=>{try{let _0xceb4f3=_0x25d906['map'](_0x12621d=>{if(typeof _0x12621d=='string')return _0x12621d;if(_0x12621d instanceof Error)return JSON['stringify']({'name':_0x12621d['name'],'message':_0x12621d['message'],'stack':_0x12621d['stack']});if(typeof Request<'u'&&_0x12621d instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x12621d['url'],'method':_0x12621d['method'],'headers':Object['fromEntries'](_0x12621d['headers']['entries']()),'bodyUsed':_0x12621d['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x12621d instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x12621d['status'],'headers':Object['fromEntries'](_0x12621d['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x12621d);}catch{return String(_0x12621d);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x5107cb==='log'?'info':_0x5107cb,'message':_0xceb4f3,'meta':{'appId':s['appId']}});}catch{_0xda5db2(..._0x25d906);}};}}R();async function v(_0x2fb171){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x6dfaad=(await w(_0x2fb171))['replace'](/\\/g,'/'),_0x1e31b1=(_0x6dfaad['startsWith']('file://')?_0x6dfaad:'file://'+_0x6dfaad)+'?t='+Date['now']();try{let _0x45f278=await import(_0x1e31b1);return s['module']=_0x45f278,_0x45f278;}catch(_0xd61658){throw console['error']('Failed to load module:',_0xd61658),_0xd61658;}}function b(_0x2a6c60){return _0x2a6c60 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x2a6c60,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x2d03da){return _0x2d03da['split']('/')['filter'](_0x350186=>_0x350186['length']>0x0);}function E(_0x2e1ecd){try{return decodeURIComponent(_0x2e1ecd);}catch{return _0x2e1ecd;}}function I(_0x40665e,_0x1fb6e2){let _0x34f5e1=g(_0x40665e),_0x2b3975=g(_0x1fb6e2),_0x477ee3={},_0x4eef60=0x0,_0x364a42=0x0;for(;_0x4eef60<_0x34f5e1['length']&&_0x364a42<_0x2b3975['length'];){let _0x1dad98=_0x34f5e1[_0x4eef60],_0x337939=_0x2b3975[_0x364a42];if(_0x1dad98==='*')break;if(_0x1dad98['startsWith'](':')){let _0x24d7cc=_0x1dad98['slice'](0x1);_0x24d7cc&&(_0x477ee3[_0x24d7cc]=E(_0x337939)),_0x4eef60++,_0x364a42++;continue;}if(_0x1dad98!==_0x337939)return{};_0x4eef60++,_0x364a42++;}return _0x4eef60===_0x34f5e1['length']||_0x4eef60===_0x34f5e1['length']-0x1&&_0x34f5e1[_0x4eef60]==='*',_0x477ee3;}function M(_0x5b03d7,_0x5362bc){return _0x5b03d7['startsWith']('/api')&&!_0x5362bc['startsWith']('/api')?_0x5b03d7['substring'](0x4)||'/':!_0x5b03d7['startsWith']('/api')&&_0x5362bc['startsWith']('/api')?'/api'+(_0x5b03d7['startsWith']('/')?'':'/')+_0x5b03d7:_0x5b03d7;}async function W(_0x28126b){let _0xea169e=_0x28126b['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0xea169e)&&await v(_0xea169e);let _0x196e6e=_0x28126b['ctx'],{method:_0xb5e39f,pathname:_0xc244a7}=_0x196e6e,_0x74c2f2=s['module']?.['default']||{},_0x3642e2=m(_0x74c2f2,_0xb5e39f,_0xc244a7);if(!_0x3642e2)throw Object['assign'](new Error('Route\x20'+_0xb5e39f+'\x20'+_0xc244a7+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x3c3852=k(_0x3642e2),_0x5ce2bf=c(_0x196e6e,s),_0x83ad72=_0xc244a7,_0x25ddc8=M(_0x3c3852['routePattern'],_0x83ad72),_0x22bdfe=_0x25ddc8?I(_0x25ddc8,_0x83ad72):{},_0x5f50b3=await _0x3c3852['handler']({..._0x5ce2bf,'params':{..._0x5ce2bf['params'],..._0x22bdfe}});return b(_0x5f50b3);}function D(_0x54b693){s['appId']=_0x54b693['appId'],s['manifest']=_0x54b693['manifest'],s['appsDir']=_0x54b693['appsDir'],s['serverPath']=_0x54b693['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x1ad78b){let {reqId:_0x347cb7,payload:_0x51ecf2}=_0x1ad78b;try{let _0x4a569b=await W(_0x51ecf2);self['postMessage']({'type':'result','reqId':_0x347cb7,'ok':!0x0,'response':_0x4a569b});}catch(_0x2c314e){let _0x1d344c=_0x2c314e;self['postMessage']({'type':'result','reqId':_0x347cb7,'ok':![],'error':{'message':_0x1d344c['message'],'stack':_0x1d344c['stack'],'code':_0x1d344c['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x526c8=>{let _0x423bdd=_0x526c8['data'];try{switch(_0x423bdd['type']){case'init':D(_0x423bdd);break;case'invoke':await $(_0x423bdd);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x423bdd['type']);break;}}catch(_0x153b6f){let _0x500620=_0x153b6f;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x500620['message'],'stack':_0x500620['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x500620);}}},self['onerror']=_0x540e61=>{let _0xb69a8b={'message':typeof _0x540e61=='string'?_0x540e61:_0x540e61['message'],'filename':typeof _0x540e61=='string'?void 0x0:_0x540e61['filename'],'lineno':typeof _0x540e61=='string'?void 0x0:_0x540e61['lineno'],'colno':typeof _0x540e61=='string'?void 0x0:_0x540e61['colno'],'error':typeof _0x540e61=='string'?void 0x0:_0x540e61['error']?.['message'],'stack':typeof _0x540e61=='string'?void 0x0:_0x540e61['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0xb69a8b);},self['onunhandledrejection']=_0x2b2167=>{let _0x186e6e=_0x2b2167['reason'],_0x399fa1={'appId':s['appId'],'reason':_0x186e6e instanceof Error?_0x186e6e['message']:String(_0x186e6e),'stack':_0x186e6e instanceof Error?_0x186e6e['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x399fa1);};