'use strict';function c(_0x1add25,_0x4be290){let _0x5193ef=Object['fromEntries'](Object['entries'](_0x1add25['headers']||{})['map'](([_0x9002ea,_0x3755bb])=>[_0x9002ea['toLowerCase'](),_0x3755bb]));return{'id':_0x1add25['app']['id']||_0x4be290['appId']||'','name':_0x1add25['app']['name']||'','version':_0x1add25['app']['version']||'','description':_0x1add25['app']['description']||'','metadata':{..._0x1add25['metadata'],'permissions':_0x1add25['permissions']},'body':_0x1add25['body'],'query':_0x1add25['query'],'params':_0x1add25?.['params'],'method':_0x1add25['method'],'pathname':_0x1add25['pathname'],'requestUrl':_0x1add25['requestUrl'],'user':_0x1add25['user'],'headers':_0x5193ef};}function f(_0x823aba){return _0x823aba['split']('/')['filter'](_0x2789cf=>_0x2789cf['length']>0x0);}function P(_0x4c3455,_0x5693e1){let _0x1b1534=f(_0x4c3455),_0x55a783=f(_0x5693e1),_0x469167=0x0,_0x2303ee=0x0;for(;_0x469167<_0x1b1534['length']&&_0x2303ee<_0x55a783['length'];){let _0x4149b0=_0x1b1534[_0x469167],_0x4cb5c2=_0x55a783[_0x2303ee];if(_0x4149b0==='*')return!![];if(_0x4149b0['startsWith'](':')){_0x469167++,_0x2303ee++;continue;}if(_0x4149b0!==_0x4cb5c2)return![];_0x469167++,_0x2303ee++;}return _0x469167===_0x1b1534['length']&&_0x2303ee===_0x55a783['length']||_0x469167===_0x1b1534['length']-0x1&&_0x1b1534[_0x469167]==='*';}function m(_0x18b084,_0x3ebc38,_0xc69770){let _0x56899b=_0x3ebc38+'\x20'+_0xc69770;if(_0x18b084[_0x56899b])return{'handler':_0x18b084[_0x56899b],'routePattern':_0xc69770};let _0x28c95b=[];_0xc69770['startsWith']('/api')?_0x28c95b['push'](_0xc69770['substring'](0x4)||'/'):_0x28c95b['push']('/api'+_0xc69770),_0x28c95b['push'](_0xc69770);for(let _0x364ebb of _0x28c95b)for(let _0x319829 of Object['keys'](_0x18b084)){if(!_0x319829['startsWith'](_0x3ebc38+'\x20'))continue;let _0x455586=_0x319829['substring'](_0x3ebc38['length']+0x1);if(P(_0x455586,_0x364ebb))return{'handler':_0x18b084[_0x319829],'routePattern':_0x455586};}return null;}function k(_0x4399da){return typeof _0x4399da=='function'?{'handler':_0x4399da,'routePattern':''}:_0x4399da;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x4a9182){let _0x50c9f1=async _0x46bea8=>{try{let _0x4f81d7=globalThis['Deno'];if(!_0x4f81d7)throw new Error('Deno is not available');return await _0x4f81d7['stat'](_0x46bea8),!0x0;}catch{return![];}};if(_0x4a9182&&typeof _0x4a9182=='string'&&_0x4a9182['length']>0x0)return _0x4a9182;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x2252c8=s['manifest']?.['metadata']?.['serverPath'];if(_0x2252c8&&typeof _0x2252c8=='string'&&_0x2252c8['length']>0x0)return _0x2252c8;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x18b645=s['manifest']['name'];if(!_0x18b645)throw new Error('Manifest\x20name\x20not\x20found');let _0x43c64b=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x18b645+'/server.js',s['appsDir']+'/'+_0x18b645+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x44739c of _0x43c64b)if(await _0x50c9f1(_0x44739c))return _0x44739c;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x43c64b['join'](',\x20'));}function R(){let _0x566488=['log','info','warn','error','debug','trace'];for(let _0x36b4f6 of _0x566488){let _0x11729d=(console[_0x36b4f6]||console['log'])['bind'](console);console[_0x36b4f6]=(..._0x289df2)=>{try{let _0x5ae53f=_0x289df2['map'](_0x32b716=>{if(typeof _0x32b716=='string')return _0x32b716;if(_0x32b716 instanceof Error)return JSON['stringify']({'name':_0x32b716['name'],'message':_0x32b716['message'],'stack':_0x32b716['stack']});if(typeof Request<'u'&&_0x32b716 instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x32b716['url'],'method':_0x32b716['method'],'headers':Object['fromEntries'](_0x32b716['headers']['entries']()),'bodyUsed':_0x32b716['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x32b716 instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x32b716['status'],'headers':Object['fromEntries'](_0x32b716['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x32b716);}catch{return String(_0x32b716);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x36b4f6==='log'?'info':_0x36b4f6,'message':_0x5ae53f,'meta':{'appId':s['appId']}});}catch{_0x11729d(..._0x289df2);}};}}R();async function v(_0x551f35){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x107cf1=(await w(_0x551f35))['replace'](/\\/g,'/'),_0x19a98d=(_0x107cf1['startsWith']('file://')?_0x107cf1:'file://'+_0x107cf1)+'?t='+Date['now']();try{let _0x2c0e89=await import(_0x19a98d);return s['module']=_0x2c0e89,_0x2c0e89;}catch(_0x132026){throw console['error']('Failed to load module:',_0x132026),_0x132026;}}function b(_0x3700e1){return _0x3700e1 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x3700e1,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x399a1e){return _0x399a1e['split']('/')['filter'](_0x2304fa=>_0x2304fa['length']>0x0);}function E(_0x55f2ed){try{return decodeURIComponent(_0x55f2ed);}catch{return _0x55f2ed;}}function I(_0x25155,_0x19df4b){let _0x2d0236=g(_0x25155),_0x133579=g(_0x19df4b),_0x384e7d={},_0x1f755a=0x0,_0xd304a9=0x0;for(;_0x1f755a<_0x2d0236['length']&&_0xd304a9<_0x133579['length'];){let _0x1b3d70=_0x2d0236[_0x1f755a],_0x5014b2=_0x133579[_0xd304a9];if(_0x1b3d70==='*')break;if(_0x1b3d70['startsWith'](':')){let _0x3309ee=_0x1b3d70['slice'](0x1);_0x3309ee&&(_0x384e7d[_0x3309ee]=E(_0x5014b2)),_0x1f755a++,_0xd304a9++;continue;}if(_0x1b3d70!==_0x5014b2)return{};_0x1f755a++,_0xd304a9++;}return _0x1f755a===_0x2d0236['length']||_0x1f755a===_0x2d0236['length']-0x1&&_0x2d0236[_0x1f755a]==='*',_0x384e7d;}function M(_0x4de2e2,_0x5b446c){return _0x4de2e2['startsWith']('/api')&&!_0x5b446c['startsWith']('/api')?_0x4de2e2['substring'](0x4)||'/':!_0x4de2e2['startsWith']('/api')&&_0x5b446c['startsWith']('/api')?'/api'+(_0x4de2e2['startsWith']('/')?'':'/')+_0x4de2e2:_0x4de2e2;}async function W(_0x1ba3cc){let _0x3821a1=_0x1ba3cc['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x3821a1)&&await v(_0x3821a1);let _0x5f56a9=_0x1ba3cc['ctx'],{method:_0x3363c0,pathname:_0x46e948}=_0x5f56a9,_0x3afb04=s['module']?.['default']||{},_0x26ec4d=m(_0x3afb04,_0x3363c0,_0x46e948);if(!_0x26ec4d)throw Object['assign'](new Error('Route\x20'+_0x3363c0+'\x20'+_0x46e948+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x2b2d65=k(_0x26ec4d),_0x19ef57=c(_0x5f56a9,s),_0x194692=_0x46e948,_0x4277b4=M(_0x2b2d65['routePattern'],_0x194692),_0x3bf5f0=_0x4277b4?I(_0x4277b4,_0x194692):{},_0x2b8f58=await _0x2b2d65['handler']({..._0x19ef57,'params':{..._0x19ef57['params'],..._0x3bf5f0}});return b(_0x2b8f58);}function D(_0x5063d2){s['appId']=_0x5063d2['appId'],s['manifest']=_0x5063d2['manifest'],s['appsDir']=_0x5063d2['appsDir'],s['serverPath']=_0x5063d2['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x1733c3){let {reqId:_0x211b68,payload:_0x7a2170}=_0x1733c3;try{let _0x46b59b=await W(_0x7a2170);self['postMessage']({'type':'result','reqId':_0x211b68,'ok':!0x0,'response':_0x46b59b});}catch(_0x512739){let _0x54d5cc=_0x512739;self['postMessage']({'type':'result','reqId':_0x211b68,'ok':![],'error':{'message':_0x54d5cc['message'],'stack':_0x54d5cc['stack'],'code':_0x54d5cc['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x216af1=>{let _0x2939ca=_0x216af1['data'];try{switch(_0x2939ca['type']){case'init':D(_0x2939ca);break;case'invoke':await $(_0x2939ca);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x2939ca['type']);break;}}catch(_0x436c81){let _0x7832e0=_0x436c81;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x7832e0['message'],'stack':_0x7832e0['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x7832e0);}}},self['onerror']=_0xf13715=>{let _0x20bcb6={'message':typeof _0xf13715=='string'?_0xf13715:_0xf13715['message'],'filename':typeof _0xf13715=='string'?void 0x0:_0xf13715['filename'],'lineno':typeof _0xf13715=='string'?void 0x0:_0xf13715['lineno'],'colno':typeof _0xf13715=='string'?void 0x0:_0xf13715['colno'],'error':typeof _0xf13715=='string'?void 0x0:_0xf13715['error']?.['message'],'stack':typeof _0xf13715=='string'?void 0x0:_0xf13715['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x20bcb6);},self['onunhandledrejection']=_0x5ea503=>{let _0x3e1ca5=_0x5ea503['reason'],_0x1b7bec={'appId':s['appId'],'reason':_0x3e1ca5 instanceof Error?_0x3e1ca5['message']:String(_0x3e1ca5),'stack':_0x3e1ca5 instanceof Error?_0x3e1ca5['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x1b7bec);};