import{join,dirname}from'path';import _0x1cb688 from'process';import{stat}from'fs/promises';async function ie(_0x455060){try{return await stat(_0x455060),!0x0;}catch{return![];}}var f={'error':(_0x453019,_0x17d84c)=>console['error']('[ERROR]\x20'+_0x453019,_0x17d84c),'warn':(_0x318932,_0x51228b)=>console['warn']('[WARN]\x20'+_0x318932,_0x51228b),'info':(_0x2121a0,_0x142d5c)=>console['log']('[INFO]\x20'+_0x2121a0,_0x142d5c),'debug':(_0x52924f,_0x4ad1e5)=>console['log']('[DEBUG]\x20'+_0x52924f,_0x4ad1e5)};function z(){let _0x2fbdc8=globalThis['Deno'];if(!_0x2fbdc8)throw new Error('Deno is not available');return _0x2fbdc8;}var D=class{constructor(_0x48ab7e,_0x192191='./lib',_0x373c33={}){this['manifest']=_0x48ab7e,this['libDir']=_0x192191,this['platformImports']=_0x373c33;}['buildPerms'](){let _0x4c40ae=this['manifest']['permissions']||{},_0xc7438c={};return _0x4c40ae['net']!==void 0x0&&(_0xc7438c['net']=_0x4c40ae['net']===!![]?!![]:Array['isArray'](_0x4c40ae['net'])?_0x4c40ae['net']:[]),_0x4c40ae['read']!==void 0x0&&(_0xc7438c['read']=_0x4c40ae['read']===!![]?!![]:Array['isArray'](_0x4c40ae['read'])?_0x4c40ae['read']:[]),_0x4c40ae['write']!==void 0x0&&(_0xc7438c['write']=_0x4c40ae['write']===!![]?!![]:Array['isArray'](_0x4c40ae['write'])?_0x4c40ae['write']:[]),_0x4c40ae['env']!==void 0x0&&(_0xc7438c['env']=_0x4c40ae['env']===!![]?!![]:Array['isArray'](_0x4c40ae['env'])?_0x4c40ae['env']:[]),_0x4c40ae['run']!==void 0x0&&(_0xc7438c['run']=_0x4c40ae['run']===!![]?!![]:Array['isArray'](_0x4c40ae['run'])?_0x4c40ae['run']:[]),_0x4c40ae['ffi']!==void 0x0&&(_0xc7438c['ffi']=_0x4c40ae['ffi']===!![]?!![]:Array['isArray'](_0x4c40ae['ffi'])?_0x4c40ae['ffi']:[]),_0x4c40ae['sys']!==void 0x0&&(_0xc7438c['sys']=_0x4c40ae['sys']===!![]?!![]:Array['isArray'](_0x4c40ae['sys'])?_0x4c40ae['sys']:[]),_0x4c40ae['hrtime']!==void 0x0&&(_0xc7438c['hrtime']=_0x4c40ae['hrtime']),_0xc7438c;}['normalize'](_0x1d98c3){return _0x1d98c3===!![]?[]:Array['isArray'](_0x1d98c3)?_0x1d98c3:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0xf56423){return join(this['libDir'],_0xf56423+'@*');}['getReadPaths'](){let _0x581a85=this['getImports']();_0x581a85['includes']('*')&&(_0x581a85=Object['keys'](this['platformImports']));let _0x4355d5=[];console['log']('[Permissions] Building package path patterns for imports:',_0x581a85);for(let _0x4e8d8d of _0x581a85){let _0x48881c=this['getLibPattern'](_0x4e8d8d);_0x4355d5['push'](_0x48881c),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x4e8d8d+'\x20->\x20'+_0x48881c);}return console['log']('[Permissions] Final package path patterns:',_0x4355d5),_0x4355d5;}['buildImportMap'](_0x21d8f5){let _0x22c64a=this['getImports'](),_0x373273=_0x22c64a['includes']('*')?Object['keys'](_0x21d8f5):_0x22c64a;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x373273);let _0x34ae73={};for(let _0x2ab52f of _0x373273)if(_0x21d8f5[_0x2ab52f])_0x34ae73[_0x2ab52f]=_0x21d8f5[_0x2ab52f],console['log']('[ImportMap]\x20'+_0x2ab52f+'\x20->\x20'+_0x21d8f5[_0x2ab52f]+'\x20(from\x20platform)');else try{let _0x50d8ab=z(),_0x4f7cdf=join(_0x50d8ab['cwd'](),this['libDir']),_0xecb3f2=!0x1;try{for(let _0x1a6b13 of _0x50d8ab['readDirSync'](_0x4f7cdf))if(_0x1a6b13['isDirectory']&&(_0x1a6b13['name']===_0x2ab52f||_0x1a6b13['name']['startsWith'](_0x2ab52f+'@'))){let _0x4a075c=join(_0x50d8ab['cwd'](),this['libDir'],_0x1a6b13['name'],'index.js')['replace'](/\\/g,'/'),_0x245186=new URL('file:///'+_0x4a075c)['href'];_0x34ae73[_0x2ab52f]=_0x245186,console['log']('[ImportMap]\x20'+_0x2ab52f+'\x20->\x20'+_0x245186+'\x20(from\x20lib)'),_0xecb3f2=!0x0;break;}}catch{}_0xecb3f2||console['warn']('[ImportMap]\x20Package\x20'+_0x2ab52f+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x58eadd){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x2ab52f+':',_0x58eadd);}return _0x34ae73;}['validateServerImports'](_0xbfad02){let _0x268420=this['manifest']['name']||this['manifest']['id'],_0x1a43d4=this['manifest']['metadata']?.['serverPath'],_0x47be7b=_0x445808=>_0x445808['replace'](/\\/g,'/'),_0x389d9d=z(),_0x33cc3b=_0x4e3cd6=>{try{return _0x389d9d['statSync'](_0x4e3cd6),!0x0;}catch{return![];}},_0x267f9b=_0x1a43d4?_0x47be7b(_0x1a43d4):void 0x0;if(!_0x267f9b){let _0x50389d=[_0xbfad02+'/service/server.js',_0xbfad02+'/service/server.ts',_0xbfad02+'/'+_0x268420+'/server.js',_0xbfad02+'/'+_0x268420+'/server.ts',_0xbfad02+'/server.js',_0xbfad02+'/server.ts']['map'](_0x47be7b);for(let _0x4145dc of _0x50389d)if(_0x33cc3b(_0x4145dc)){_0x267f9b=_0x4145dc;break;}}if(!_0x267f9b)return{'valid':![],'violations':['Failed to locate server module']};let _0x31c7a8='';try{_0x31c7a8=_0x389d9d['readTextFileSync'](_0x267f9b);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x267f9b};}let _0x1cd2f1=this['getImports']();if(_0x1cd2f1['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x267f9b};let _0x36a70a=_0x1cd2f1,_0x567bcc=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x54644f=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x26aa64=/\bimport\s*['"]([^'"]+)['"]/g,_0x1335dd=[],_0x4e13b8=new Set(),_0x3c49cf=_0x40bdf9=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x40bdf9),_0x476bdf=_0x57c670=>{let _0x33a5e9=_0x57c670;if(_0x33a5e9['startsWith']('./')||_0x33a5e9['startsWith']('../')||_0x33a5e9['startsWith']('/')||_0x33a5e9['startsWith']('file://')||!_0x3c49cf(_0x57c670)||_0x4e13b8['has'](_0x57c670))return;_0x4e13b8['add'](_0x57c670),_0x33a5e9['startsWith']('npm:')&&(_0x33a5e9=_0x33a5e9['substring'](0x4)),_0x33a5e9['includes']('@')&&!_0x33a5e9['startsWith']('@')&&(_0x33a5e9=_0x33a5e9['split']('@')[0x0]);let _0x1be51e=_0x33a5e9['split']('/')[0x0];_0x36a70a['includes'](_0x1be51e)||_0x36a70a['includes'](_0x57c670)||_0x1335dd['push'](_0x57c670);},_0x348eae;for(;(_0x348eae=_0x567bcc['exec'](_0x31c7a8))!==null;)_0x476bdf(_0x348eae[0x1]);for(;(_0x348eae=_0x54644f['exec'](_0x31c7a8))!==null;)_0x476bdf(_0x348eae[0x1]);for(;(_0x348eae=_0x26aa64['exec'](_0x31c7a8))!==null;)_0x476bdf(_0x348eae[0x1]);return{'valid':_0x1335dd['length']===0x0,'violations':_0x1335dd,'serverPath':_0x267f9b};}['validate'](_0x53a8c4={}){let _0x20d7e8=[],_0x5e3f66=this['manifest']['permissions']||{};try{let _0x16efb4=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x16efb4);}catch{}let _0x4ab535=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x39a558,_0xcb993d]of Object['entries'](_0x5e3f66))if(_0x39a558==='hrtime')typeof _0xcb993d!='boolean'&&_0x20d7e8['push']('Permission\x20\x27'+_0x39a558+'\x27\x20must\x20be\x20boolean');else{if(_0x39a558==='langchain')typeof _0xcb993d!='boolean'&&(typeof _0xcb993d!='object'||_0xcb993d===null)?_0x20d7e8['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0xcb993d=='object'&&(_0xcb993d===null||!('enabled'in _0xcb993d)||typeof _0xcb993d['enabled']!='boolean')&&_0x20d7e8['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x39a558==='kv')typeof _0xcb993d!='boolean'&&_0x20d7e8['push']('Permission\x20\x27'+_0x39a558+'\x27\x20must\x20be\x20boolean');else{if(_0x39a558==='mspbots')Array['isArray'](_0xcb993d)||_0x20d7e8['push']('Permission\x20\x27'+_0x39a558+'\x27\x20must\x20be\x20an\x20array');else{if(_0x39a558==='db'){if(typeof _0xcb993d!='object'||_0xcb993d===null||Array['isArray'](_0xcb993d))_0x20d7e8['push']('Permission\x20\x27'+_0x39a558+'\x27\x20must\x20be\x20an\x20object');else{let _0x413dbd=_0xcb993d,_0x306204=['user','password']['filter'](_0x188d24=>!(_0x188d24 in _0x413dbd));_0x306204['length']>0x0&&_0x20d7e8['push']('Permission\x20\x27'+_0x39a558+'\x27\x20missing\x20required\x20fields:\x20'+_0x306204['join'](',\x20'));}}else{if(_0x39a558==='imports')continue;_0x4ab535['has'](_0x39a558)||typeof _0xcb993d!='boolean'&&!Array['isArray'](_0xcb993d)&&_0x20d7e8['push']('Permission\x20\x27'+_0x39a558+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x38ab46=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x38ab46))_0x20d7e8['push']('permissions.imports must be an array');else{for(let _0x212457 of _0x38ab46)typeof _0x212457!='string'&&_0x20d7e8['push']('import\x20\x27'+_0x212457+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x20d7e8['length']===0x0,'errors':_0x20d7e8};}};function q(_0x3d5999,_0x4ecb6e,_0x5dbe7b){return new D(_0x3d5999,_0x4ecb6e,_0x5dbe7b||{});}var R=null;function I(){let _0x3f933a=globalThis['Deno'];if(!_0x3f933a)throw new Error('Deno is not available');return _0x3f933a;}async function K(){if(R)return{...R};try{let _0x5198df=I(),_0xa066e8=join(_0x5198df['cwd'](),'deno.json'),_0xfbf604=await _0x5198df['readTextFile'](_0xa066e8);return R=JSON['parse'](_0xfbf604)['imports']||{},{...R};}catch(_0x3c8b5a){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x3c8b5a),{};}}var E=class{constructor(_0x37cf13,_0x18fea3={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x37cf13['appsDir'],this['platformImportsOverride']=_0x37cf13['platformImports'],this['libDir']=_0x37cf13['libDir'],this['events']=_0x18fea3);}async['create'](_0x3b24b4,_0x10f19b,_0x5d623e){try{return await this['createWorker'](_0x3b24b4,_0x10f19b,_0x5d623e);}catch(_0x71428d){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x3b24b4+':',_0x71428d),_0x71428d;}}async['createWorker'](_0x604d00,_0x23b140,_0x5002f7){let _0x1f01b0=this['platformImportsOverride']||await K(),_0x54ce89=q(_0x23b140,this['libDir'],_0x1f01b0)['validateServerImports'](this['appsDir']);if(!_0x54ce89['valid']){let _0x3fec11=_0x54ce89['violations']['filter'](_0x216cd6=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x216cd6)),_0x1afa72=_0x54ce89['serverPath']?_0x54ce89['serverPath']:(_0x23b140['name']||_0x23b140['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x1afa72+':\x20'+_0x3fec11['join'](',\x20'));}let _0x4af45c=q(_0x23b140,this['libDir'],_0x1f01b0),_0x5b1fdd=_0x4af45c['validate'](_0x1f01b0);if(!_0x5b1fdd['valid'])throw new Error('Invalid\x20config:\x20'+_0x5b1fdd['errors']['join'](',\x20'));let _0x46226e=_0x4af45c['buildImportMap'](_0x1f01b0);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x604d00+':',_0x46226e);let _0x3bf080=_0x4af45c['buildPerms'](),_0x25df01=_0x4af45c['getReadPaths']();if(_0x3bf080['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x3bf080['read']);else{let _0x50e7e9=_0x23b140['name']||_0x604d00,_0x36501a=this['appsDir']+'/'+_0x50e7e9,_0x243e3b=[_0x36501a],_0x4c42ac=_0x23b140['metadata']?.['serverPath'];if(_0x4c42ac&&typeof _0x4c42ac=='string')try{let _0x3f6aef=dirname(_0x4c42ac)['replace'](/\\/g,'/');_0x243e3b['push'](_0x3f6aef);}catch{}_0x3bf080['read']=_0x243e3b,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x36501a);}if(_0x25df01['length']>0x0){if(_0x3bf080['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x541c3c=Array['isArray'](_0x3bf080['read'])?_0x3bf080['read']:[];_0x3bf080['read']=[..._0x541c3c,..._0x25df01],console['log']('[Worker] Added package read permissions:',_0x25df01);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x3bf080['net']||(_0x3bf080['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x604d00+':',_0x3bf080['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x3bf080['read']===!![]?'unrestricted':Array['isArray'](_0x3bf080['read'])?_0x3bf080['read']['length']:0x0));let _0x7d23f3=await this['createImportMap'](_0x604d00,_0x46226e),_0x31bffd=await this['createLock'](_0x604d00,_0x46226e),_0x413c54={'type':'module','deno':{'permissions':{}}};_0x413c54['deno']['namespace']=![],_0x413c54['deno']['permissions']=_0x3bf080,_0x413c54['deno']['importMap']=_0x7d23f3,_0x413c54['deno']['lock']=_0x31bffd,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x604d00+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x7d23f3),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x31bffd),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x46226e)['length']+'\x20('+(Object['keys'](_0x46226e)['join'](',\x20')||'none')+')');let _0x47fe19={'worker':new Worker(_0x5002f7,_0x413c54),'appId':_0x604d00,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x23b140,'importMapPath':_0x7d23f3,'lockfilePath':_0x31bffd};return this['workers']['set'](_0x604d00,_0x47fe19),this['events']['onCreate']?.(_0x47fe19),_0x47fe19;}async['createLock'](_0x3218a0,_0x5e50fc){let _0x255aa5=I(),_0x425791=join(_0x255aa5['cwd'](),'storage','temp','lockfiles');await _0x255aa5['mkdir'](_0x425791,{'recursive':!![]});let _0x4acb1b=_0x3218a0+'-'+Date['now']()+'.lock',_0xa25efc=join(_0x425791,_0x4acb1b),_0x25fdb2={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x1fc22a,_0x304e62]of Object['entries'](_0x5e50fc))if(_0x304e62['startsWith']('npm:'))_0x304e62['replace']('npm:',''),_0x25fdb2['packages']['specifiers'][_0x1fc22a]=_0x304e62;else _0x304e62['startsWith']('file://')&&(_0x25fdb2['packages']['specifiers'][_0x1fc22a]=_0x304e62);let _0x415135=JSON['stringify'](_0x25fdb2,null,0x2);return await _0x255aa5['writeTextFile'](_0xa25efc,_0x415135),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0xa25efc),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x5e50fc)['length']+'):',Object['keys'](_0x5e50fc)),_0xa25efc;}async['createImportMap'](_0x573a94,_0x337ccf){let _0x58f7bd=I(),_0x244d72=join(_0x58f7bd['cwd'](),'storage','temp','importmaps');await _0x58f7bd['mkdir'](_0x244d72,{'recursive':!![]});let _0x437eb0=_0x573a94+'-'+Date['now']()+'.json',_0xfaf16e=join(_0x244d72,_0x437eb0),_0x1f810a=JSON['stringify']({'imports':_0x337ccf,'scopes':{}},null,0x2);return await _0x58f7bd['writeTextFile'](_0xfaf16e,_0x1f810a),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0xfaf16e),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x337ccf)['length']+'):',Object['keys'](_0x337ccf)['join'](',\x20')||'none'),_0xfaf16e;}['get'](_0x3210b4){return this['workers']['get'](_0x3210b4);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x37e208,_0x460447){let _0x462bb6=this['workers']['get'](_0x37e208);if(!_0x462bb6)return;let _0x233d22=_0x462bb6['status'];_0x462bb6['status']=_0x460447,_0x460447==='running'&&_0x233d22==='starting'?this['events']['onReady']?.(_0x462bb6):_0x460447==='crashed'&&this['events']['onCrash']?.(_0x462bb6);}['touch'](_0x1397ec){let _0x282743=this['workers']['get'](_0x1397ec);_0x282743&&(_0x282743['lastUsed']=Date['now']());}async['stop'](_0x5a863b){let _0x3b72a4=this['workers']['get'](_0x5a863b);if(_0x3b72a4)try{_0x3b72a4['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x3b72a4['worker']['terminate'](),_0x3b72a4['status']='stopped',this['events']['onStop']?.(_0x3b72a4),_0x3b72a4['importMapPath']&&await this['cleanupImportMap'](_0x3b72a4['importMapPath']),_0x3b72a4['lockfilePath']&&await this['cleanupLock'](_0x3b72a4['lockfilePath']);}catch(_0x2d87b2){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x5a863b+':',_0x2d87b2);}finally{this['workers']['delete'](_0x5a863b);}}async['cleanupImportMap'](_0xdc8ef3){try{await I()['remove'](_0xdc8ef3),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0xdc8ef3);}catch(_0x36c229){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0xdc8ef3,_0x36c229);}}async['cleanupLock'](_0x1c8163){try{await I()['remove'](_0x1c8163),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x1c8163);}catch(_0x211ccd){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x1c8163,_0x211ccd);}}async['stopAll'](){let _0x28fb35=Array['from'](this['workers']['keys']());await Promise['all'](_0x28fb35['map'](_0x310301=>this['stop'](_0x310301)));}async['restart'](_0x59afb7,_0x33f409){let _0x146abc=this['workers']['get'](_0x59afb7);if(!_0x146abc)throw new Error('Worker\x20'+_0x59afb7+'\x20not\x20found');let _0x3ed6d4=_0x146abc['manifest'];return await this['stop'](_0x59afb7),await this['create'](_0x59afb7,_0x3ed6d4,_0x33f409);}['checkHealth'](_0x3b5718){let _0x17ab9f=this['workers']['get'](_0x3b5718);if(!_0x17ab9f)return{'healthy':![],'reason':'Not\x20found'};if(_0x17ab9f['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x17ab9f['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x3e2f61=Date['now']()-_0x17ab9f['lastUsed'],_0x7664cd=0x708*0x3e8;return _0x3e2f61>_0x7664cd?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x3e2f61/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x4d2723=0x708*0x3e8,_0x5a7280){let _0x1d3e7c=Date['now'](),_0x2a95b8=[];for(let [_0x2cc978,_0x176fcf]of this['workers']['entries']()){let _0x1eb89d=_0x1d3e7c-_0x176fcf['lastUsed'];_0x1eb89d>_0x4d2723&&_0x2a95b8['push']({'appId':_0x2cc978,'idle':_0x1eb89d});}_0x2a95b8['sort']((_0xa296f2,_0x5dc6fe)=>_0x5dc6fe['idle']-_0xa296f2['idle']);let _0x131276=_0x5a7280?_0x2a95b8['slice'](0x0,_0x5a7280)['map'](_0x560dde=>_0x560dde['appId']):_0x2a95b8['map'](_0x455ca8=>_0x455ca8['appId']);for(let _0x4044bb of _0x131276)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x4044bb),await this['stop'](_0x4044bb);}['stats'](){let _0x5c0db2={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x58c840=Date['now']();for(let _0x45b178 of this['workers']['values']())_0x5c0db2['byStatus'][_0x45b178['status']]++,_0x5c0db2['workers']['push']({'appId':_0x45b178['appId'],'status':_0x45b178['status'],'version':_0x45b178['version'],'lastUsed':_0x45b178['lastUsed'],'idle':_0x58c840-_0x45b178['lastUsed']});return _0x5c0db2;}['startCleanup'](_0x4fe3f4=0x12c*0x3e8,_0x7e4dc9){let _0x17e644=setInterval(()=>{this['cleanup'](_0x7e4dc9)['catch'](_0x58d08d=>{console['error']('Cleanup\x20failed:',_0x58d08d);});},_0x4fe3f4);return()=>clearInterval(_0x17e644);}['delay'](_0x244311){return new Promise(_0x591220=>setTimeout(_0x591220,_0x244311));}};function W(_0x2531cc,_0x23a18b){return new E(_0x2531cc,_0x23a18b);}var v=f,j=class{constructor(_0x2e2e5a,_0x3f6e6b=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x2e2e5a,this['timeout']=_0x3f6e6b);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x294c10){_0x294c10['worker']['onmessage']=_0x15ab32=>{let _0x268163=_0x15ab32['data'],{appId:_0x33f2bb}=_0x294c10;switch(_0x268163['type']){case'ready':this['events']['onReady'](_0x33f2bb),v['info']('Worker\x20ready',{'appId':_0x33f2bb,'version':_0x294c10['version']});break;case'log':{let {level:_0x4ab80d='info',message:_0x194b7e,meta:_0x1ecd8b}=_0x268163,_0x4d9fea={..._0x1ecd8b||{},'appId':_0x33f2bb,'version':_0x294c10['version']};this['events']['onLog'](_0x33f2bb,_0x4ab80d,_0x194b7e,_0x4d9fea);break;}case'result':{let {reqId:_0x207d8b,ok:_0x335c99,response:_0x32527b,error:_0x535423}=_0x268163,_0x425501=this['pending']['get'](_0x207d8b);if(!_0x425501){v['warn']('Unknown\x20request',{'appId':_0x33f2bb,'reqId':_0x207d8b});return;}if(this['pending']['delete'](_0x207d8b),_0x335c99&&_0x32527b)_0x425501['resolve'](_0x32527b);else{let _0x431f1c=new Error(_0x535423?.['message']||'Worker\x20error');_0x431f1c['stack']=_0x535423?.['stack'],_0x425501['reject'](_0x431f1c);}this['events']['onResult'](_0x33f2bb,_0x207d8b,_0x32527b||_0x535423);break;}default:v['debug']('Unknown\x20message',{'appId':_0x33f2bb,'type':_0x268163['type']});}},_0x294c10['worker']['onerror']=_0x54e720=>{let {appId:_0x41d0f5}=_0x294c10;v['error']('Worker\x20error',{'appId':_0x41d0f5,'message':_0x54e720['message'],'lineno':_0x54e720['lineno'],'filename':_0x54e720['filename']}),_0x294c10['status']='crashed',this['rejectPending'](_0x41d0f5,new Error('Worker\x20'+_0x41d0f5+'\x20crashed:\x20'+_0x54e720['message'])),_0x54e720['preventDefault']();},_0x294c10['worker']['onmessageerror']=_0x255018=>{let {appId:_0x57df71}=_0x294c10;v['error']('Message\x20error',{'appId':_0x57df71,'data':_0x255018['data']}),_0x294c10['status']='crashed',_0x255018['preventDefault']();};}['sendInit'](_0x1a10d0,_0x31b290,_0x327cab,_0x2612ba){_0x1a10d0['worker']['postMessage']({'type':'init','appId':_0x1a10d0['appId'],'manifest':_0x327cab,'appsDir':_0x31b290,'serverPath':_0x2612ba});}async['sendInvoke'](_0x2b35b2,_0x465f73){let _0x4432f7=this['nextId'](),_0x561d65=_0x2b35b2['appId'],_0x2025e7=new Promise((_0x385e5f,_0x205a60)=>{let _0x1ff05b=setTimeout(()=>{this['pending']['delete'](_0x4432f7),_0x205a60(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x4432f7,{'resolve':_0x45339c=>{clearTimeout(_0x1ff05b),_0x385e5f(_0x45339c);},'reject':_0x192280=>{clearTimeout(_0x1ff05b),_0x205a60(_0x192280);},'timestamp':Date['now'](),'appId':_0x561d65});});return _0x2b35b2['worker']['postMessage']({'type':'invoke','appId':_0x2b35b2['appId'],'reqId':_0x4432f7,'payload':_0x465f73}),await _0x2025e7;}['rejectPending'](_0x5ddcef,_0x5729c8){let _0x4f1444=0x0;for(let [_0x38dd0d,_0x532b0b]of this['pending']['entries']())_0x532b0b['appId']===_0x5ddcef&&(this['pending']['delete'](_0x38dd0d),_0x532b0b['reject'](_0x5729c8),_0x4f1444++);_0x4f1444>0x0&&v['warn']('Rejected\x20'+_0x4f1444+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x5ddcef});}['cleanupTimeout'](){let _0x971a78=Date['now']();for(let [_0x55aa2f,_0x589ae3]of this['pending']['entries']())_0x971a78-_0x589ae3['timestamp']>this['timeout']&&(this['pending']['delete'](_0x55aa2f),_0x589ae3['reject'](new Error('Request\x20'+_0x55aa2f+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x105c2c){let _0x2eb31c=0x0;for(let _0x15297e of this['pending']['values']())_0x15297e['appId']===_0x105c2c&&_0x2eb31c++;return _0x2eb31c;}['startCleanup'](_0x74b8a4=0x2710){let _0x4fad26=setInterval(()=>{this['cleanupTimeout']();},_0x74b8a4);return()=>clearInterval(_0x4fad26);}};function $(_0x1dec61,_0x3f3219){return new j(_0x1dec61,_0x3f3219);}var Q=class{constructor(_0xb11324={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0xb11324['logger']||f,this['config']={'appsDir':_0xb11324['appsDir']||this['getAppsDir'](),'scriptUrl':_0xb11324['scriptUrl']||this['getScriptUrl'](),'timeout':_0xb11324['timeout']||0x78*0x3e8,'autoCleanup':_0xb11324['autoCleanup']??!![],'cleanupInterval':_0xb11324['cleanupInterval']||0x168*0x3e8,'maxIdle':_0xb11324['maxIdle']||0xb4*0x3e8,'maxWorkers':_0xb11324['maxWorkers'],'reuseWorkers':_0xb11324['reuseWorkers']??!![],'workerReuseStrategy':_0xb11324['workerReuseStrategy']||'lru','enableQueue':_0xb11324['enableQueue']??!![],'maxQueueSize':_0xb11324['maxQueueSize']||0x64,'queueTimeout':_0xb11324['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x36abf0=>this['logger']['info']('Worker\x20created',{'appId':_0x36abf0['appId'],'v':_0x36abf0['version']}),'onReady':_0x4cf754=>this['lifecycle']['updateStatus'](_0x4cf754['appId'],'running'),'onCrash':_0x475e26=>this['logger']['error']('Worker\x20crashed',{'appId':_0x475e26['appId'],'v':_0x475e26['version']}),'onStop':_0x54f34b=>this['logger']['info']('Worker\x20stopped',{'appId':_0x54f34b['appId'],'v':_0x54f34b['version']})}),this['messaging']=$({'onReady':_0x10b9a7=>this['lifecycle']['updateStatus'](_0x10b9a7,'running'),'onLog':(_0x3c1d95,_0x7e76e6,_0x5a2a46,_0x559c20)=>{let _0x535300={..._0x559c20||{},'appId':_0x3c1d95};switch(_0x7e76e6){case'error':this['logger']['error'](_0x5a2a46,_0x535300);break;case'warn':this['logger']['warn'](_0x5a2a46,_0x535300);break;case'debug':this['logger']['debug'](_0x5a2a46,_0x535300);break;default:this['logger']['info'](_0x5a2a46,_0x535300);break;}},'onResult':(_0x39876e,_0x11710a,_0x1e777e)=>{this['logger']['debug']('Result\x20received',{'appId':_0x39876e,'reqId':_0x11710a});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x1cb688['cwd'](),'apps');}['getScriptUrl'](){let _0x160abb=import.meta.url,_0xa0cf41=_0x160abb['endsWith']('.js')||_0x160abb['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0xa0cf41,_0x160abb)['href'];}async['ensure'](_0x5873d6){let {id:_0x4930ee}=_0x5873d6,_0x1c09ba=this['lifecycle']['get'](_0x4930ee);if(_0x1c09ba){let _0x52e97e=this['lifecycle']['checkHealth'](_0x4930ee);if(_0x52e97e['healthy'])return this['lifecycle']['touch'](_0x4930ee),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x4930ee}),_0x1c09ba;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x4930ee,'reason':_0x52e97e['reason']}),await this['lifecycle']['stop'](_0x4930ee);}for(;;){let _0x5c6864=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x5c6864>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x5c6864,'max':this['config']['maxWorkers'],'appId':_0x4930ee}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x5873d6);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x31e70c=await this['loadManifest'](_0x4930ee,_0x5873d6['manifest']),_0x214c88=await this['lifecycle']['create'](_0x4930ee,_0x31e70c,this['config']['scriptUrl']),_0x588a18=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x588a18>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x588a18,'max':this['config']['maxWorkers'],'appId':_0x4930ee}),await this['lifecycle']['stop'](_0x4930ee),this['config']['enableQueue'])return await this['waitSlot'](_0x5873d6);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x588a18+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x214c88);let _0x34c947=_0x31e70c['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x214c88,this['config']['appsDir'],_0x31e70c,_0x34c947),this['logger']['info']('Worker\x20created',{'appId':_0x4930ee,'v':_0x214c88['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x214c88;}async['evictIdle'](){let _0x1a6b34=this['lifecycle']['getAll']();if(_0x1a6b34['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x5b3a96=[..._0x1a6b34];this['config']['workerReuseStrategy']==='lru'?_0x5b3a96['sort']((_0x2eb485,_0x3a002f)=>_0x2eb485['lastUsed']-_0x3a002f['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x5b3a96['sort']((_0x106377,_0x25a7c0)=>_0x106377['version']-_0x25a7c0['version']);let _0x187241=null;for(let _0x20577 of _0x5b3a96)if(this['messaging']['getAppCount'](_0x20577['appId'])===0x0){_0x187241=_0x20577;break;}if(!_0x187241&&_0x5b3a96['length']>0x0&&(_0x187241=_0x5b3a96['reduce']((_0x3a4805,_0x1a824b)=>{let _0x398c13=this['messaging']['getAppCount'](_0x3a4805['appId']);return this['messaging']['getAppCount'](_0x1a824b['appId'])<_0x398c13?_0x1a824b:_0x3a4805;})),_0x187241){let _0x4af846=this['messaging']['getAppCount'](_0x187241['appId']);return _0x4af846>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x187241['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x187241['lastUsed'],'pendingRequests':_0x4af846}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x187241['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x187241['lastUsed']}),await this['lifecycle']['stop'](_0x187241['appId']),!![];}return![];}['waitSlot'](_0x5ee8f){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x29dba5,_0x4863e5)=>{let _0x1bc8ff={'info':_0x5ee8f,'resolve':_0x29dba5,'reject':_0x4863e5,'timestamp':Date['now']()};this['requestQueue']['push'](_0x1bc8ff),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x5ee8f['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x26b5cb=setTimeout(()=>{let _0x1ff678=this['requestQueue']['indexOf'](_0x1bc8ff);_0x1ff678!==-0x1&&(this['requestQueue']['splice'](_0x1ff678,0x1),_0x4863e5(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x1bc8ff['resolve']=_0x130ee4=>{clearTimeout(_0x26b5cb),_0x29dba5(_0x130ee4);},_0x1bc8ff['reject']=_0x568391=>{clearTimeout(_0x26b5cb),_0x4863e5(_0x568391);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x503f45=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x503f45>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x2bbb25=this['requestQueue']['shift']();if(!_0x2bbb25)break;try{let _0x103244=await this['ensure'](_0x2bbb25['info']);_0x2bbb25['resolve'](_0x103244);}catch(_0x312b9c){_0x2bbb25['reject'](_0x312b9c);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x5ce2f5,_0x3b8732){let _0x421645=this['config']['appsDir']['replace'](/\\/g,'/'),_0xf561a2=async _0x4a45ca=>{try{let _0x5b1e2b=globalThis['Deno'];if(!_0x5b1e2b)return null;let _0x1447c8=await _0x5b1e2b['readTextFile'](_0x4a45ca);return JSON['parse'](_0x1447c8);}catch{return null;}};if(_0x3b8732?.['name']){let _0xad28d3=await _0xf561a2(_0x421645+'/'+_0x3b8732['name']+'/manifest.json');if(_0xad28d3)return _0xad28d3;}let _0x3e33db=await _0xf561a2(_0x421645+'/'+_0x5ce2f5+'/manifest.json');if(_0x3e33db)return _0x3e33db;try{let _0x29ab9e=globalThis['Deno'];if(_0x29ab9e)for await(let _0x5c43d0 of _0x29ab9e['readDir'](_0x421645)){if(!_0x5c43d0['isDirectory'])continue;let _0x3cad92=_0x421645+'/'+_0x5c43d0['name']+'/manifest.json',_0x426d3f=await _0xf561a2(_0x3cad92);if(_0x426d3f&&(_0x426d3f['id']===_0x5ce2f5||_0x3b8732?.['name']&&_0x426d3f['name']===_0x3b8732['name']))return _0x426d3f;}}catch(_0x57b85a){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x5ce2f5,'error':_0x57b85a['message']});}return _0x3b8732||{'id':_0x5ce2f5,'name':_0x5ce2f5,'version':'1.0.0'};}async['invoke'](_0x4dcccc){let _0x13b66a=_0x4dcccc['ctx']['app']['id'],_0x1f82ce=_0x4dcccc['ctx']['app']['name'];try{let _0x507c5e={'id':_0x13b66a,'manifest':{'id':_0x13b66a,'name':_0x1f82ce}},_0x52fa15=await this['ensure'](_0x507c5e);if(_0x52fa15['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x13b66a}),await this['restart'](_0x13b66a);let _0x3fccdd=await this['ensure'](_0x507c5e);return this['lifecycle']['touch'](_0x13b66a),await this['messaging']['sendInvoke'](_0x3fccdd,_0x4dcccc);}return this['lifecycle']['touch'](_0x13b66a),await this['messaging']['sendInvoke'](_0x52fa15,_0x4dcccc);}catch(_0x267321){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x13b66a,'error':_0x267321['message'],'stack':_0x267321['stack']}),_0x267321;}}async['stop'](_0x4bac5a){await this['lifecycle']['stop'](_0x4bac5a),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x342541){return await this['lifecycle']['restart'](_0x342541,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x3cc70a=>({'appId':_0x3cc70a['appId'],'status':_0x3cc70a['status'],'version':_0x3cc70a['version'],'lastUsed':_0x3cc70a['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0xc22e97=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x3a7702=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0xc22e97(),_0x3a7702();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x234ed4=>{_0x234ed4?(await this['stop'](_0x234ed4),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x234ed4})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x4f0afa){return new Q(_0x4f0afa);}var S=null;function be(_0x407bbb){S=ee(_0x407bbb);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x20e63e){return await k()['ensure'](_0x20e63e);}async function xe(_0x31e58b){return await k()['invoke'](_0x31e58b);}function Ie(_0x5a0c82){k()['stop'](_0x5a0c82)['catch'](_0x4cd4f3=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x5a0c82,'error':_0x4cd4f3['message']});});}function Re(){k()['stopAll']()['catch'](_0x7bf6a9=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x7bf6a9['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x38525e){await k()['stop'](_0x38525e);}async function Se(){await k()['stopAll']();}function Ae(_0x107802){let _0x3d0cad=_0x107802&&typeof _0x107802=='object'?_0x107802:null;if(_0x3d0cad&&'user'in _0x3d0cad)return _0x3d0cad['user'];}function H(_0x2c3ef7){let _0x65b1ff=_0x2c3ef7&&typeof _0x2c3ef7=='object'?_0x2c3ef7:null;if(!_0x65b1ff)return{};let _0x2afecd={};for(let [_0x40a44e,_0x2417a1]of Object['entries'](_0x65b1ff))_0x40a44e!=='user'&&(_0x2afecd[_0x40a44e]=_0x2417a1);return _0x2afecd;}function O(_0x2534eb){return _0x2534eb?{'id':_0x2534eb['manifest']?.['id']||_0x2534eb['id']||'','name':_0x2534eb['manifest']?.['name']||'','version':_0x2534eb['manifest']?.['version']||'','description':_0x2534eb['manifest']?.['description']||'','icon':_0x2534eb['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x4aff56){return _0x4aff56?.['permissions']||_0x4aff56?.['manifest']?.['permissions']||{};}function F(_0x510c03){return _0x510c03?.['manifest']?.['metadata']||{};}function Ce(_0x8c339b){return _0x8c339b?{'appId':_0x8c339b['id'],'appName':_0x8c339b['manifest']?.['name']}:{};}function N(_0x28340c,_0x30299e={}){let {appInfo:_0x597b2d=null,status:_0xd9f117=0x1f4,defaultMessage:_0x3528a4='Internal\x20Server\x20Error'}=_0x30299e,_0x54c307={'error':_0x3528a4,'message':_0x28340c?.['message']||_0x3528a4};return _0x597b2d&&(_0x54c307['appId']=_0x597b2d['id'],_0x54c307['appName']=_0x597b2d['manifest']?.['name']),_0x28340c?.['message']?.['includes']('crashed')&&(_0x54c307['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0xd9f117,'body':_0x54c307};}function qe(_0x480a35){return _0x480a35?.['message']?.['includes']('crashed')||![];}function J(_0x15f720){if(_0x15f720)try{return JSON['parse'](_0x15f720);}catch{return _0x15f720;}}function B(_0x385a91){try{let _0x3b1330=new URL(_0x385a91),_0x55b276={};for(let _0x411fb7 of _0x3b1330['searchParams']['keys']()){let _0x2b34bc=_0x3b1330['searchParams']['getAll'](_0x411fb7)['map'](_0x32aa11=>_0x32aa11);_0x2b34bc['length']<=0x1?_0x55b276[_0x411fb7]=_0x2b34bc[0x0]??'':_0x55b276[_0x411fb7]=_0x2b34bc;}return _0x55b276;}catch{return{};}}function Le(_0x155d57){return(()=>{try{return new URL(_0x155d57)['pathname'];}catch{return _0x155d57;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x202ca7,_0x1d861d){let _0x7cd4d6=_0x202ca7;if(_0x1d861d&&_0x7cd4d6['startsWith']('/apps/'+_0x1d861d))_0x7cd4d6=_0x7cd4d6['substring'](('/apps/'+_0x1d861d)['length'])||'/';else{let _0x3e9a0a=_0x7cd4d6['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x3e9a0a&&(_0x7cd4d6=_0x3e9a0a[0x1]||'/');}return _0x7cd4d6['startsWith']('/api')&&(_0x7cd4d6=_0x7cd4d6['substring'](0x4)||'/'),_0x7cd4d6;}function Ue(_0x36d5b6,_0x5b2ec2){let _0x2cd105=_0x36d5b6;if(_0x5b2ec2&&_0x2cd105['startsWith']('/apps/'+_0x5b2ec2))_0x2cd105=_0x2cd105['substring'](('/apps/'+_0x5b2ec2)['length'])||'/';else{let _0x2b0685=_0x2cd105['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x2b0685&&(_0x2cd105=_0x2b0685[0x1]||'/');}return(!_0x2cd105||_0x2cd105==='/')&&(_0x2cd105='/index.html'),_0x2cd105;}async function He(_0x5624df,_0x385358){return await _0x385358(_0x5624df);}function _(_0x5cbc8e){return _0x5cbc8e['split']('/')['filter'](_0xe39603=>_0xe39603['length']>0x0);}function te(_0x58bb6f){try{return decodeURIComponent(_0x58bb6f);}catch{return _0x58bb6f;}}function re(_0x1f3d63,_0x3ada93){let _0x1aa3fa=_(_0x1f3d63),_0x18ff4a=_(_0x3ada93),_0x538d10={},_0x8f0b9=0x0,_0x39e471=0x0;for(;_0x8f0b9<_0x1aa3fa['length']&&_0x39e471<_0x18ff4a['length'];){let _0x3d2778=_0x1aa3fa[_0x8f0b9],_0x2762ac=_0x18ff4a[_0x39e471];if(_0x3d2778==='*')break;if(_0x3d2778['startsWith'](':')){let _0x37c251=_0x3d2778['slice'](0x1);_0x37c251&&(_0x538d10[_0x37c251]=te(_0x2762ac)),_0x8f0b9++,_0x39e471++;continue;}if(_0x3d2778!==_0x2762ac)return{};_0x8f0b9++,_0x39e471++;}return _0x8f0b9===_0x1aa3fa['length']||_0x8f0b9===_0x1aa3fa['length']-0x1&&_0x1aa3fa[_0x8f0b9]==='*',_0x538d10;}async function Oe(_0x20d2b8,_0xb05239,_0xd32e73,_0x15df0c,_0x275de2=void 0x0,_0x1966c4){let _0x2bc87c=await _0xb05239['text'](),_0x1bf700=J(_0x2bc87c),_0x4dbb20=B(_0xb05239['url']),_0x1fb543={...F(_0x20d2b8),'user':_0x275de2},_0x1ef68b=H(_0x1fb543),_0x1a8dd3=_0x1966c4?re(_0x1966c4,_0xb05239['path']):{};return{'app':O(_0x20d2b8),'permissions':T(_0x20d2b8),'user':_0x275de2,'metadata':_0x1ef68b,'body':_0x1bf700,'query':_0x4dbb20,'params':_0x1a8dd3,'method':_0xd32e73,'pathname':_0x15df0c,'requestUrl':_0xb05239['url'],'headers':Object['fromEntries'](_0xb05239['raw']['headers']['entries']())};}function Te(_0x4368f9){return{'method':_0x4368f9['method'],'pathname':_0x4368f9['pathname'],'ctx':_0x4368f9};}function Fe(_0x2b8685,_0x1ef25b){let {status:_0x2a6cfb=0xc8,headers:_0x5f4d42={},body:_0x9ad11,type:_0x2eb221}=_0x2b8685??{};return _0x2eb221==='raw'?new globalThis['Response'](String(_0x9ad11??''),{'status':_0x2a6cfb,'headers':_0x5f4d42}):_0x1ef25b(_0x9ad11,_0x2a6cfb);}function Ne(_0x32cbc9,_0x2ae6dc=null){return N(_0x32cbc9,{'appInfo':_0x2ae6dc});}var V=f;async function Ve(_0x2346fc){_0x2346fc?(await U(_0x2346fc),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x2346fc)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x5dfac4,_0x4f5bf1){let _0x29af75=Object['fromEntries'](Object['entries'](_0x5dfac4['headers']||{})['map'](([_0x414559,_0x2e9826])=>[_0x414559['toLowerCase'](),_0x2e9826]));return{'id':_0x5dfac4['app']['id']||_0x4f5bf1['appId']||'','name':_0x5dfac4['app']['name']||'','version':_0x5dfac4['app']['version']||'','description':_0x5dfac4['app']['description']||'','metadata':{..._0x5dfac4['metadata'],'permissions':_0x5dfac4['permissions']},'body':_0x5dfac4['body'],'query':_0x5dfac4['query'],'params':_0x5dfac4?.['params'],'method':_0x5dfac4['method'],'pathname':_0x5dfac4['pathname'],'requestUrl':_0x5dfac4['requestUrl'],'user':_0x5dfac4['user'],'headers':_0x29af75};}var L=class{constructor(_0x410c2a){this['handle']=null,(this['config']=_0x410c2a,this['logger']=_0x410c2a['logger']||f,this['lifecycle']=W({'appsDir':_0x410c2a['appsDir'],'timeout':_0x410c2a['timeout'],'platformImports':_0x410c2a['platformImports'],'libDir':_0x410c2a['libDir']},{'onCreate':_0x300203=>this['logger']['info']('Worker\x20created',{'appId':_0x300203['appId']}),'onReady':_0x178580=>{this['lifecycle']['updateStatus'](_0x178580['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x178580['appId']});},'onCrash':_0x4175d8=>this['logger']['error']('Worker\x20crashed',{'appId':_0x4175d8['appId']}),'onStop':_0x5b0436=>this['logger']['info']('Worker\x20stopped',{'appId':_0x5b0436['appId']})}),this['messaging']=$({'onReady':_0xdca421=>this['lifecycle']['updateStatus'](_0xdca421,'running'),'onLog':(_0x8cf866,_0x35193d,_0x39646,_0x37dfca)=>{(this['logger'][_0x35193d]||this['logger']['info'])['call'](this['logger'],_0x39646,_0x37dfca);},'onResult':()=>{}},_0x410c2a['timeout']||0x1d4c0));}async['create'](_0x3fe2b2){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x386939=await this['lifecycle']['create'](this['config']['appId'],_0x3fe2b2,this['config']['scriptUrl']);this['messaging']['setup'](_0x386939),this['messaging']['sendInit'](_0x386939,this['config']['appsDir'],_0x3fe2b2,this['config']['serverPath']),this['handle']=_0x386939,await this['waitForReady']();}async['waitForReady'](_0x44e4a7=0x2710){let _0x360d56=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x360d56>_0x44e4a7)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x8c214d=>setTimeout(_0x8c214d,0x64));}}async['invoke'](_0x138e5b){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x138e5b);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x145859){return new L(_0x145859);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};