'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0xced53c){return _0xced53c&&_0xced53c['__esModule']?_0xced53c:{'default':_0xced53c};}var Y__default=_interopDefault(Y);async function ie(_0x58c6b3){try{return await promises['stat'](_0x58c6b3),!0x0;}catch{return![];}}var f={'error':(_0x4c0484,_0x269f2d)=>console['error']('[ERROR]\x20'+_0x4c0484,_0x269f2d),'warn':(_0x1f69a5,_0x3942fc)=>console['warn']('[WARN]\x20'+_0x1f69a5,_0x3942fc),'info':(_0x5a7957,_0x4e3944)=>console['log']('[INFO]\x20'+_0x5a7957,_0x4e3944),'debug':(_0x4ce585,_0x232d92)=>console['log']('[DEBUG]\x20'+_0x4ce585,_0x232d92)};function z(){let _0x4003fe=globalThis['Deno'];if(!_0x4003fe)throw new Error('Deno is not available');return _0x4003fe;}var D=class{constructor(_0x2137d9,_0x3db38c='./lib',_0x492f20={}){this['manifest']=_0x2137d9,this['libDir']=_0x3db38c,this['platformImports']=_0x492f20;}['buildPerms'](){let _0x13df3d=this['manifest']['permissions']||{},_0x4e8895={};return _0x13df3d['net']!==void 0x0&&(_0x4e8895['net']=_0x13df3d['net']===!![]?!![]:Array['isArray'](_0x13df3d['net'])?_0x13df3d['net']:[]),_0x13df3d['read']!==void 0x0&&(_0x4e8895['read']=_0x13df3d['read']===!![]?!![]:Array['isArray'](_0x13df3d['read'])?_0x13df3d['read']:[]),_0x13df3d['write']!==void 0x0&&(_0x4e8895['write']=_0x13df3d['write']===!![]?!![]:Array['isArray'](_0x13df3d['write'])?_0x13df3d['write']:[]),_0x13df3d['env']!==void 0x0&&(_0x4e8895['env']=_0x13df3d['env']===!![]?!![]:Array['isArray'](_0x13df3d['env'])?_0x13df3d['env']:[]),_0x13df3d['run']!==void 0x0&&(_0x4e8895['run']=_0x13df3d['run']===!![]?!![]:Array['isArray'](_0x13df3d['run'])?_0x13df3d['run']:[]),_0x13df3d['ffi']!==void 0x0&&(_0x4e8895['ffi']=_0x13df3d['ffi']===!![]?!![]:Array['isArray'](_0x13df3d['ffi'])?_0x13df3d['ffi']:[]),_0x13df3d['sys']!==void 0x0&&(_0x4e8895['sys']=_0x13df3d['sys']===!![]?!![]:Array['isArray'](_0x13df3d['sys'])?_0x13df3d['sys']:[]),_0x13df3d['hrtime']!==void 0x0&&(_0x4e8895['hrtime']=_0x13df3d['hrtime']),_0x4e8895;}['normalize'](_0x4454eb){return _0x4454eb===!![]?[]:Array['isArray'](_0x4454eb)?_0x4454eb:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x2f9101){return path.join(this['libDir'],_0x2f9101+'@*');}['getReadPaths'](){let _0x41adc0=this['getImports']();_0x41adc0['includes']('*')&&(_0x41adc0=Object['keys'](this['platformImports']));let _0xf8db8d=[];console['log']('[Permissions] Building package path patterns for imports:',_0x41adc0);for(let _0x46eae2 of _0x41adc0){let _0x5343ae=this['getLibPattern'](_0x46eae2);_0xf8db8d['push'](_0x5343ae),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x46eae2+'\x20->\x20'+_0x5343ae);}return console['log']('[Permissions] Final package path patterns:',_0xf8db8d),_0xf8db8d;}['buildImportMap'](_0x44aaf0){let _0xc646ba=this['getImports'](),_0x4ff78a=_0xc646ba['includes']('*')?Object['keys'](_0x44aaf0):_0xc646ba;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x4ff78a);let _0x4acc6e={};for(let _0xf4aea1 of _0x4ff78a)if(_0x44aaf0[_0xf4aea1])_0x4acc6e[_0xf4aea1]=_0x44aaf0[_0xf4aea1],console['log']('[ImportMap]\x20'+_0xf4aea1+'\x20->\x20'+_0x44aaf0[_0xf4aea1]+'\x20(from\x20platform)');else try{let _0x3b4b97=z(),_0x1bcb39=path.join(_0x3b4b97['cwd'](),this['libDir']),_0x295028=!0x1;try{for(let _0xb44cbd of _0x3b4b97['readDirSync'](_0x1bcb39))if(_0xb44cbd['isDirectory']&&(_0xb44cbd['name']===_0xf4aea1||_0xb44cbd['name']['startsWith'](_0xf4aea1+'@'))){let _0x15d9b9=path.join(_0x3b4b97['cwd'](),this['libDir'],_0xb44cbd['name'],'index.js')['replace'](/\\/g,'/'),_0x113bcc=new URL('file:///'+_0x15d9b9)['href'];_0x4acc6e[_0xf4aea1]=_0x113bcc,console['log']('[ImportMap]\x20'+_0xf4aea1+'\x20->\x20'+_0x113bcc+'\x20(from\x20lib)'),_0x295028=!0x0;break;}}catch{}_0x295028||console['warn']('[ImportMap]\x20Package\x20'+_0xf4aea1+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x3d673f){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0xf4aea1+':',_0x3d673f);}return _0x4acc6e;}['validateServerImports'](_0x2fba28){let _0x131d4e=this['manifest']['name']||this['manifest']['id'],_0x5b1ae5=this['manifest']['metadata']?.['serverPath'],_0x1208e1=_0x5afac6=>_0x5afac6['replace'](/\\/g,'/'),_0x2d360b=z(),_0x2a8c8a=_0x244ea4=>{try{return _0x2d360b['statSync'](_0x244ea4),!0x0;}catch{return![];}},_0x54a3ef=_0x5b1ae5?_0x1208e1(_0x5b1ae5):void 0x0;if(!_0x54a3ef){let _0x2af483=[_0x2fba28+'/service/server.js',_0x2fba28+'/service/server.ts',_0x2fba28+'/'+_0x131d4e+'/server.js',_0x2fba28+'/'+_0x131d4e+'/server.ts',_0x2fba28+'/server.js',_0x2fba28+'/server.ts']['map'](_0x1208e1);for(let _0x3c06fc of _0x2af483)if(_0x2a8c8a(_0x3c06fc)){_0x54a3ef=_0x3c06fc;break;}}if(!_0x54a3ef)return{'valid':![],'violations':['Failed to locate server module']};let _0x16f3d3='';try{_0x16f3d3=_0x2d360b['readTextFileSync'](_0x54a3ef);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x54a3ef};}let _0x587b8f=this['getImports']();if(_0x587b8f['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x54a3ef};let _0xc2a347=_0x587b8f,_0x366fdf=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x353dac=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x450475=/\bimport\s*['"]([^'"]+)['"]/g,_0x3030d8=[],_0x7bd616=new Set(),_0x3560f1=_0x3a1534=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x3a1534),_0x597838=_0x3b8e9e=>{let _0x438809=_0x3b8e9e;if(_0x438809['startsWith']('./')||_0x438809['startsWith']('../')||_0x438809['startsWith']('/')||_0x438809['startsWith']('file://')||!_0x3560f1(_0x3b8e9e)||_0x7bd616['has'](_0x3b8e9e))return;_0x7bd616['add'](_0x3b8e9e),_0x438809['startsWith']('npm:')&&(_0x438809=_0x438809['substring'](0x4)),_0x438809['includes']('@')&&!_0x438809['startsWith']('@')&&(_0x438809=_0x438809['split']('@')[0x0]);let _0xa4b0ff=_0x438809['split']('/')[0x0];_0xc2a347['includes'](_0xa4b0ff)||_0xc2a347['includes'](_0x3b8e9e)||_0x3030d8['push'](_0x3b8e9e);},_0x4de588;for(;(_0x4de588=_0x366fdf['exec'](_0x16f3d3))!==null;)_0x597838(_0x4de588[0x1]);for(;(_0x4de588=_0x353dac['exec'](_0x16f3d3))!==null;)_0x597838(_0x4de588[0x1]);for(;(_0x4de588=_0x450475['exec'](_0x16f3d3))!==null;)_0x597838(_0x4de588[0x1]);return{'valid':_0x3030d8['length']===0x0,'violations':_0x3030d8,'serverPath':_0x54a3ef};}['validate'](_0x3c445e={}){let _0x48b091=[],_0x2b229e=this['manifest']['permissions']||{};try{let _0x2e7247=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x2e7247);}catch{}let _0x3c2073=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x3f53a0,_0x1ddbe9]of Object['entries'](_0x2b229e))if(_0x3f53a0==='hrtime')typeof _0x1ddbe9!='boolean'&&_0x48b091['push']('Permission\x20\x27'+_0x3f53a0+'\x27\x20must\x20be\x20boolean');else{if(_0x3f53a0==='langchain')typeof _0x1ddbe9!='boolean'&&(typeof _0x1ddbe9!='object'||_0x1ddbe9===null)?_0x48b091['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x1ddbe9=='object'&&(_0x1ddbe9===null||!('enabled'in _0x1ddbe9)||typeof _0x1ddbe9['enabled']!='boolean')&&_0x48b091['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x3f53a0==='kv')typeof _0x1ddbe9!='boolean'&&_0x48b091['push']('Permission\x20\x27'+_0x3f53a0+'\x27\x20must\x20be\x20boolean');else{if(_0x3f53a0==='mspbots')Array['isArray'](_0x1ddbe9)||_0x48b091['push']('Permission\x20\x27'+_0x3f53a0+'\x27\x20must\x20be\x20an\x20array');else{if(_0x3f53a0==='db'){if(typeof _0x1ddbe9!='object'||_0x1ddbe9===null||Array['isArray'](_0x1ddbe9))_0x48b091['push']('Permission\x20\x27'+_0x3f53a0+'\x27\x20must\x20be\x20an\x20object');else{let _0x52f668=_0x1ddbe9,_0x561ddb=['user','password']['filter'](_0x3d6964=>!(_0x3d6964 in _0x52f668));_0x561ddb['length']>0x0&&_0x48b091['push']('Permission\x20\x27'+_0x3f53a0+'\x27\x20missing\x20required\x20fields:\x20'+_0x561ddb['join'](',\x20'));}}else{if(_0x3f53a0==='imports')continue;_0x3c2073['has'](_0x3f53a0)||typeof _0x1ddbe9!='boolean'&&!Array['isArray'](_0x1ddbe9)&&_0x48b091['push']('Permission\x20\x27'+_0x3f53a0+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x5fe83b=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x5fe83b))_0x48b091['push']('permissions.imports must be an array');else{for(let _0x3b0b42 of _0x5fe83b)typeof _0x3b0b42!='string'&&_0x48b091['push']('import\x20\x27'+_0x3b0b42+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x48b091['length']===0x0,'errors':_0x48b091};}};function q(_0xe6c94d,_0x4b6e5f,_0x1586c5){return new D(_0xe6c94d,_0x4b6e5f,_0x1586c5||{});}var R=null;function I(){let _0x4012c7=globalThis['Deno'];if(!_0x4012c7)throw new Error('Deno is not available');return _0x4012c7;}async function K(){if(R)return{...R};try{let _0x102611=I(),_0x40c5a2=path.join(_0x102611['cwd'](),'deno.json'),_0x357586=await _0x102611['readTextFile'](_0x40c5a2);return R=JSON['parse'](_0x357586)['imports']||{},{...R};}catch(_0x28cb22){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x28cb22),{};}}var E=class{constructor(_0x383b5c,_0x476a9a={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x383b5c['appsDir'],this['platformImportsOverride']=_0x383b5c['platformImports'],this['libDir']=_0x383b5c['libDir'],this['events']=_0x476a9a);}async['create'](_0x1ebcc6,_0x24c79e,_0x537c3e){try{return await this['createWorker'](_0x1ebcc6,_0x24c79e,_0x537c3e);}catch(_0x2d0564){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x1ebcc6+':',_0x2d0564),_0x2d0564;}}async['createWorker'](_0x969e53,_0x2c795c,_0xc9e65b){let _0x5f1f77=this['platformImportsOverride']||await K(),_0x10c282=q(_0x2c795c,this['libDir'],_0x5f1f77)['validateServerImports'](this['appsDir']);if(!_0x10c282['valid']){let _0x28e5e3=_0x10c282['violations']['filter'](_0x2dfa0b=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x2dfa0b)),_0x2b89c2=_0x10c282['serverPath']?_0x10c282['serverPath']:(_0x2c795c['name']||_0x2c795c['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x2b89c2+':\x20'+_0x28e5e3['join'](',\x20'));}let _0x516b48=q(_0x2c795c,this['libDir'],_0x5f1f77),_0x156c6a=_0x516b48['validate'](_0x5f1f77);if(!_0x156c6a['valid'])throw new Error('Invalid\x20config:\x20'+_0x156c6a['errors']['join'](',\x20'));let _0x34dff5=_0x516b48['buildImportMap'](_0x5f1f77);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x969e53+':',_0x34dff5);let _0x1c2ed2=_0x516b48['buildPerms'](),_0x2fb30a=_0x516b48['getReadPaths']();if(_0x1c2ed2['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x1c2ed2['read']);else{let _0x2db4c9=_0x2c795c['name']||_0x969e53,_0x112461=this['appsDir']+'/'+_0x2db4c9,_0x535e94=[_0x112461],_0x40a731=_0x2c795c['metadata']?.['serverPath'];if(_0x40a731&&typeof _0x40a731=='string')try{let _0x64c627=path.dirname(_0x40a731)['replace'](/\\/g,'/');_0x535e94['push'](_0x64c627);}catch{}_0x1c2ed2['read']=_0x535e94,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x112461);}if(_0x2fb30a['length']>0x0){if(_0x1c2ed2['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x14991d=Array['isArray'](_0x1c2ed2['read'])?_0x1c2ed2['read']:[];_0x1c2ed2['read']=[..._0x14991d,..._0x2fb30a],console['log']('[Worker] Added package read permissions:',_0x2fb30a);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x1c2ed2['net']||(_0x1c2ed2['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x969e53+':',_0x1c2ed2['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x1c2ed2['read']===!![]?'unrestricted':Array['isArray'](_0x1c2ed2['read'])?_0x1c2ed2['read']['length']:0x0));let _0xcd246b=await this['createImportMap'](_0x969e53,_0x34dff5),_0x3c115a=await this['createLock'](_0x969e53,_0x34dff5),_0xbe087d={'type':'module','deno':{'permissions':{}}};_0xbe087d['deno']['namespace']=![],_0xbe087d['deno']['permissions']=_0x1c2ed2,_0xbe087d['deno']['importMap']=_0xcd246b,_0xbe087d['deno']['lock']=_0x3c115a,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x969e53+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0xcd246b),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x3c115a),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x34dff5)['length']+'\x20('+(Object['keys'](_0x34dff5)['join'](',\x20')||'none')+')');let _0x329908={'worker':new Worker(_0xc9e65b,_0xbe087d),'appId':_0x969e53,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x2c795c,'importMapPath':_0xcd246b,'lockfilePath':_0x3c115a};return this['workers']['set'](_0x969e53,_0x329908),this['events']['onCreate']?.(_0x329908),_0x329908;}async['createLock'](_0x1fa9ce,_0x5202ee){let _0xc2c53c=I(),_0x562eeb=path.join(_0xc2c53c['cwd'](),'storage','temp','lockfiles');await _0xc2c53c['mkdir'](_0x562eeb,{'recursive':!![]});let _0x2db87a=_0x1fa9ce+'-'+Date['now']()+'.lock',_0x4c0316=path.join(_0x562eeb,_0x2db87a),_0xec5e6f={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x7339b7,_0x57429c]of Object['entries'](_0x5202ee))if(_0x57429c['startsWith']('npm:'))_0x57429c['replace']('npm:',''),_0xec5e6f['packages']['specifiers'][_0x7339b7]=_0x57429c;else _0x57429c['startsWith']('file://')&&(_0xec5e6f['packages']['specifiers'][_0x7339b7]=_0x57429c);let _0x400bce=JSON['stringify'](_0xec5e6f,null,0x2);return await _0xc2c53c['writeTextFile'](_0x4c0316,_0x400bce),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x4c0316),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x5202ee)['length']+'):',Object['keys'](_0x5202ee)),_0x4c0316;}async['createImportMap'](_0x37b951,_0x1b65f8){let _0x3f0041=I(),_0x24e0d4=path.join(_0x3f0041['cwd'](),'storage','temp','importmaps');await _0x3f0041['mkdir'](_0x24e0d4,{'recursive':!![]});let _0x38e958=_0x37b951+'-'+Date['now']()+'.json',_0x315008=path.join(_0x24e0d4,_0x38e958),_0x2c7e41=JSON['stringify']({'imports':_0x1b65f8,'scopes':{}},null,0x2);return await _0x3f0041['writeTextFile'](_0x315008,_0x2c7e41),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x315008),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x1b65f8)['length']+'):',Object['keys'](_0x1b65f8)['join'](',\x20')||'none'),_0x315008;}['get'](_0x2f9386){return this['workers']['get'](_0x2f9386);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x5f24ef,_0x4cd567){let _0x7a9b98=this['workers']['get'](_0x5f24ef);if(!_0x7a9b98)return;let _0x5c8d47=_0x7a9b98['status'];_0x7a9b98['status']=_0x4cd567,_0x4cd567==='running'&&_0x5c8d47==='starting'?this['events']['onReady']?.(_0x7a9b98):_0x4cd567==='crashed'&&this['events']['onCrash']?.(_0x7a9b98);}['touch'](_0x3fa9b7){let _0x366b5c=this['workers']['get'](_0x3fa9b7);_0x366b5c&&(_0x366b5c['lastUsed']=Date['now']());}async['stop'](_0x408e79){let _0x49c32b=this['workers']['get'](_0x408e79);if(_0x49c32b)try{_0x49c32b['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x49c32b['worker']['terminate'](),_0x49c32b['status']='stopped',this['events']['onStop']?.(_0x49c32b),_0x49c32b['importMapPath']&&await this['cleanupImportMap'](_0x49c32b['importMapPath']),_0x49c32b['lockfilePath']&&await this['cleanupLock'](_0x49c32b['lockfilePath']);}catch(_0x12cc4d){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x408e79+':',_0x12cc4d);}finally{this['workers']['delete'](_0x408e79);}}async['cleanupImportMap'](_0x492745){try{await I()['remove'](_0x492745),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x492745);}catch(_0x4e8022){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x492745,_0x4e8022);}}async['cleanupLock'](_0x2cf407){try{await I()['remove'](_0x2cf407),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x2cf407);}catch(_0xe73054){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x2cf407,_0xe73054);}}async['stopAll'](){let _0x47b777=Array['from'](this['workers']['keys']());await Promise['all'](_0x47b777['map'](_0x9f5e4c=>this['stop'](_0x9f5e4c)));}async['restart'](_0x5167e6,_0x17fb51){let _0x2cd147=this['workers']['get'](_0x5167e6);if(!_0x2cd147)throw new Error('Worker\x20'+_0x5167e6+'\x20not\x20found');let _0x15e183=_0x2cd147['manifest'];return await this['stop'](_0x5167e6),await this['create'](_0x5167e6,_0x15e183,_0x17fb51);}['checkHealth'](_0x376e05){let _0x35b5ec=this['workers']['get'](_0x376e05);if(!_0x35b5ec)return{'healthy':![],'reason':'Not\x20found'};if(_0x35b5ec['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x35b5ec['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x22dd2a=Date['now']()-_0x35b5ec['lastUsed'],_0x417d34=0x708*0x3e8;return _0x22dd2a>_0x417d34?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x22dd2a/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x12d324=0x708*0x3e8,_0x1ba6b0){let _0x2be40c=Date['now'](),_0x50c94b=[];for(let [_0xb603d0,_0x475f86]of this['workers']['entries']()){let _0x5c42ef=_0x2be40c-_0x475f86['lastUsed'];_0x5c42ef>_0x12d324&&_0x50c94b['push']({'appId':_0xb603d0,'idle':_0x5c42ef});}_0x50c94b['sort']((_0xa46fe3,_0x153812)=>_0x153812['idle']-_0xa46fe3['idle']);let _0x34d269=_0x1ba6b0?_0x50c94b['slice'](0x0,_0x1ba6b0)['map'](_0x41de25=>_0x41de25['appId']):_0x50c94b['map'](_0x43306c=>_0x43306c['appId']);for(let _0x543ef9 of _0x34d269)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x543ef9),await this['stop'](_0x543ef9);}['stats'](){let _0x5072de={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x55b012=Date['now']();for(let _0x183ac6 of this['workers']['values']())_0x5072de['byStatus'][_0x183ac6['status']]++,_0x5072de['workers']['push']({'appId':_0x183ac6['appId'],'status':_0x183ac6['status'],'version':_0x183ac6['version'],'lastUsed':_0x183ac6['lastUsed'],'idle':_0x55b012-_0x183ac6['lastUsed']});return _0x5072de;}['startCleanup'](_0x469c55=0x12c*0x3e8,_0xfc34ef){let _0x5036db=setInterval(()=>{this['cleanup'](_0xfc34ef)['catch'](_0x58c9ce=>{console['error']('Cleanup\x20failed:',_0x58c9ce);});},_0x469c55);return()=>clearInterval(_0x5036db);}['delay'](_0x2b5593){return new Promise(_0x1f7438=>setTimeout(_0x1f7438,_0x2b5593));}};function W(_0x214066,_0x2fcb06){return new E(_0x214066,_0x2fcb06);}var v=f,j=class{constructor(_0x5f6b11,_0x55758f=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x5f6b11,this['timeout']=_0x55758f);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x52ab61){_0x52ab61['worker']['onmessage']=_0x182129=>{let _0x271f5b=_0x182129['data'],{appId:_0x135666}=_0x52ab61;switch(_0x271f5b['type']){case'ready':this['events']['onReady'](_0x135666),v['info']('Worker\x20ready',{'appId':_0x135666,'version':_0x52ab61['version']});break;case'log':{let {level:_0xbdf8df='info',message:_0x1a0cc1,meta:_0x566754}=_0x271f5b,_0x342bae={..._0x566754||{},'appId':_0x135666,'version':_0x52ab61['version']};this['events']['onLog'](_0x135666,_0xbdf8df,_0x1a0cc1,_0x342bae);break;}case'result':{let {reqId:_0x231c67,ok:_0x28daa7,response:_0x326f78,error:_0x5752fb}=_0x271f5b,_0x1fa6e6=this['pending']['get'](_0x231c67);if(!_0x1fa6e6){v['warn']('Unknown\x20request',{'appId':_0x135666,'reqId':_0x231c67});return;}if(this['pending']['delete'](_0x231c67),_0x28daa7&&_0x326f78)_0x1fa6e6['resolve'](_0x326f78);else{let _0x287852=new Error(_0x5752fb?.['message']||'Worker\x20error');_0x287852['stack']=_0x5752fb?.['stack'],_0x1fa6e6['reject'](_0x287852);}this['events']['onResult'](_0x135666,_0x231c67,_0x326f78||_0x5752fb);break;}default:v['debug']('Unknown\x20message',{'appId':_0x135666,'type':_0x271f5b['type']});}},_0x52ab61['worker']['onerror']=_0x34dcc8=>{let {appId:_0x4c1574}=_0x52ab61;v['error']('Worker\x20error',{'appId':_0x4c1574,'message':_0x34dcc8['message'],'lineno':_0x34dcc8['lineno'],'filename':_0x34dcc8['filename']}),_0x52ab61['status']='crashed',this['rejectPending'](_0x4c1574,new Error('Worker\x20'+_0x4c1574+'\x20crashed:\x20'+_0x34dcc8['message'])),_0x34dcc8['preventDefault']();},_0x52ab61['worker']['onmessageerror']=_0x2676ee=>{let {appId:_0x1b06d6}=_0x52ab61;v['error']('Message\x20error',{'appId':_0x1b06d6,'data':_0x2676ee['data']}),_0x52ab61['status']='crashed',_0x2676ee['preventDefault']();};}['sendInit'](_0x57a2c5,_0x518613,_0x183f62,_0x18ec15){_0x57a2c5['worker']['postMessage']({'type':'init','appId':_0x57a2c5['appId'],'manifest':_0x183f62,'appsDir':_0x518613,'serverPath':_0x18ec15});}async['sendInvoke'](_0x1e7c19,_0xf8f25f){let _0x505818=this['nextId'](),_0x51582f=_0x1e7c19['appId'],_0x5b1e29=new Promise((_0x1478e0,_0x17fbff)=>{let _0x55a696=setTimeout(()=>{this['pending']['delete'](_0x505818),_0x17fbff(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x505818,{'resolve':_0x2fb101=>{clearTimeout(_0x55a696),_0x1478e0(_0x2fb101);},'reject':_0x42b2c2=>{clearTimeout(_0x55a696),_0x17fbff(_0x42b2c2);},'timestamp':Date['now'](),'appId':_0x51582f});});return _0x1e7c19['worker']['postMessage']({'type':'invoke','appId':_0x1e7c19['appId'],'reqId':_0x505818,'payload':_0xf8f25f}),await _0x5b1e29;}['rejectPending'](_0x1f73b9,_0x1690e4){let _0x26ece3=0x0;for(let [_0x104698,_0x49340b]of this['pending']['entries']())_0x49340b['appId']===_0x1f73b9&&(this['pending']['delete'](_0x104698),_0x49340b['reject'](_0x1690e4),_0x26ece3++);_0x26ece3>0x0&&v['warn']('Rejected\x20'+_0x26ece3+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x1f73b9});}['cleanupTimeout'](){let _0x25c3f4=Date['now']();for(let [_0x509dde,_0x2cf303]of this['pending']['entries']())_0x25c3f4-_0x2cf303['timestamp']>this['timeout']&&(this['pending']['delete'](_0x509dde),_0x2cf303['reject'](new Error('Request\x20'+_0x509dde+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x29e524){let _0x4aeba4=0x0;for(let _0x5b10dd of this['pending']['values']())_0x5b10dd['appId']===_0x29e524&&_0x4aeba4++;return _0x4aeba4;}['startCleanup'](_0x2c2ef6=0x2710){let _0x405a1a=setInterval(()=>{this['cleanupTimeout']();},_0x2c2ef6);return()=>clearInterval(_0x405a1a);}};function $(_0x5eb347,_0x22700b){return new j(_0x5eb347,_0x22700b);}var Q=class{constructor(_0x22212e={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x22212e['logger']||f,this['config']={'appsDir':_0x22212e['appsDir']||this['getAppsDir'](),'scriptUrl':_0x22212e['scriptUrl']||this['getScriptUrl'](),'timeout':_0x22212e['timeout']||0x78*0x3e8,'autoCleanup':_0x22212e['autoCleanup']??!![],'cleanupInterval':_0x22212e['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x22212e['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x22212e['maxWorkers'],'reuseWorkers':_0x22212e['reuseWorkers']??!![],'workerReuseStrategy':_0x22212e['workerReuseStrategy']||'lru','enableQueue':_0x22212e['enableQueue']??!![],'maxQueueSize':_0x22212e['maxQueueSize']||0x64,'queueTimeout':_0x22212e['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x4fc7bc=>this['logger']['info']('Worker\x20created',{'appId':_0x4fc7bc['appId'],'v':_0x4fc7bc['version']}),'onReady':_0x18005e=>this['lifecycle']['updateStatus'](_0x18005e['appId'],'running'),'onCrash':_0xd2b062=>this['logger']['error']('Worker\x20crashed',{'appId':_0xd2b062['appId'],'v':_0xd2b062['version']}),'onStop':_0x2b68be=>this['logger']['info']('Worker\x20stopped',{'appId':_0x2b68be['appId'],'v':_0x2b68be['version']})}),this['messaging']=$({'onReady':_0x4ed516=>this['lifecycle']['updateStatus'](_0x4ed516,'running'),'onLog':(_0x273414,_0x134210,_0x239ceb,_0x27ed54)=>{let _0x1a2aa0={..._0x27ed54||{},'appId':_0x273414};switch(_0x134210){case'error':this['logger']['error'](_0x239ceb,_0x1a2aa0);break;case'warn':this['logger']['warn'](_0x239ceb,_0x1a2aa0);break;case'debug':this['logger']['debug'](_0x239ceb,_0x1a2aa0);break;default:this['logger']['info'](_0x239ceb,_0x1a2aa0);break;}},'onResult':(_0x531c74,_0x5c398c,_0x215877)=>{this['logger']['debug']('Result\x20received',{'appId':_0x531c74,'reqId':_0x5c398c});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x519507=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x121563=_0x519507['endsWith']('.js')||_0x519507['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x121563,_0x519507)['href'];}async['ensure'](_0x440ef1){let {id:_0x50e6d2}=_0x440ef1,_0x210494=this['lifecycle']['get'](_0x50e6d2);if(_0x210494){let _0x114fc8=this['lifecycle']['checkHealth'](_0x50e6d2);if(_0x114fc8['healthy'])return this['lifecycle']['touch'](_0x50e6d2),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x50e6d2}),_0x210494;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x50e6d2,'reason':_0x114fc8['reason']}),await this['lifecycle']['stop'](_0x50e6d2);}for(;;){let _0x3f82af=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x3f82af>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x3f82af,'max':this['config']['maxWorkers'],'appId':_0x50e6d2}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x440ef1);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x2fa1c2=await this['loadManifest'](_0x50e6d2,_0x440ef1['manifest']),_0x50341e=await this['lifecycle']['create'](_0x50e6d2,_0x2fa1c2,this['config']['scriptUrl']),_0x467762=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x467762>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x467762,'max':this['config']['maxWorkers'],'appId':_0x50e6d2}),await this['lifecycle']['stop'](_0x50e6d2),this['config']['enableQueue'])return await this['waitSlot'](_0x440ef1);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x467762+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x50341e);let _0x57496f=_0x2fa1c2['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x50341e,this['config']['appsDir'],_0x2fa1c2,_0x57496f),this['logger']['info']('Worker\x20created',{'appId':_0x50e6d2,'v':_0x50341e['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x50341e;}async['evictIdle'](){let _0x2d0eb0=this['lifecycle']['getAll']();if(_0x2d0eb0['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x3c94b8=[..._0x2d0eb0];this['config']['workerReuseStrategy']==='lru'?_0x3c94b8['sort']((_0x3c4c00,_0x254201)=>_0x3c4c00['lastUsed']-_0x254201['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x3c94b8['sort']((_0x5e3113,_0x1544fc)=>_0x5e3113['version']-_0x1544fc['version']);let _0x1392a0=null;for(let _0x251034 of _0x3c94b8)if(this['messaging']['getAppCount'](_0x251034['appId'])===0x0){_0x1392a0=_0x251034;break;}if(!_0x1392a0&&_0x3c94b8['length']>0x0&&(_0x1392a0=_0x3c94b8['reduce']((_0x5087be,_0x5b7101)=>{let _0x302ec3=this['messaging']['getAppCount'](_0x5087be['appId']);return this['messaging']['getAppCount'](_0x5b7101['appId'])<_0x302ec3?_0x5b7101:_0x5087be;})),_0x1392a0){let _0x2c764c=this['messaging']['getAppCount'](_0x1392a0['appId']);return _0x2c764c>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x1392a0['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x1392a0['lastUsed'],'pendingRequests':_0x2c764c}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x1392a0['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x1392a0['lastUsed']}),await this['lifecycle']['stop'](_0x1392a0['appId']),!![];}return![];}['waitSlot'](_0x4d3740){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x77c7be,_0x1a1e1c)=>{let _0x134626={'info':_0x4d3740,'resolve':_0x77c7be,'reject':_0x1a1e1c,'timestamp':Date['now']()};this['requestQueue']['push'](_0x134626),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x4d3740['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x5e2a8d=setTimeout(()=>{let _0x4f89d4=this['requestQueue']['indexOf'](_0x134626);_0x4f89d4!==-0x1&&(this['requestQueue']['splice'](_0x4f89d4,0x1),_0x1a1e1c(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x134626['resolve']=_0x50b31c=>{clearTimeout(_0x5e2a8d),_0x77c7be(_0x50b31c);},_0x134626['reject']=_0x1af52b=>{clearTimeout(_0x5e2a8d),_0x1a1e1c(_0x1af52b);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x25e820=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x25e820>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x41ea43=this['requestQueue']['shift']();if(!_0x41ea43)break;try{let _0x6a1f6c=await this['ensure'](_0x41ea43['info']);_0x41ea43['resolve'](_0x6a1f6c);}catch(_0x2e9366){_0x41ea43['reject'](_0x2e9366);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x1cd52f,_0x37fdd5){let _0x19ac6f=this['config']['appsDir']['replace'](/\\/g,'/'),_0x47d364=async _0x4bdd17=>{try{let _0x300b20=globalThis['Deno'];if(!_0x300b20)return null;let _0x44ec77=await _0x300b20['readTextFile'](_0x4bdd17);return JSON['parse'](_0x44ec77);}catch{return null;}};if(_0x37fdd5?.['name']){let _0x17f66a=await _0x47d364(_0x19ac6f+'/'+_0x37fdd5['name']+'/manifest.json');if(_0x17f66a)return _0x17f66a;}let _0x16f681=await _0x47d364(_0x19ac6f+'/'+_0x1cd52f+'/manifest.json');if(_0x16f681)return _0x16f681;try{let _0x11471f=globalThis['Deno'];if(_0x11471f)for await(let _0x47c021 of _0x11471f['readDir'](_0x19ac6f)){if(!_0x47c021['isDirectory'])continue;let _0x1b8a77=_0x19ac6f+'/'+_0x47c021['name']+'/manifest.json',_0x6b80fd=await _0x47d364(_0x1b8a77);if(_0x6b80fd&&(_0x6b80fd['id']===_0x1cd52f||_0x37fdd5?.['name']&&_0x6b80fd['name']===_0x37fdd5['name']))return _0x6b80fd;}}catch(_0x38c546){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x1cd52f,'error':_0x38c546['message']});}return _0x37fdd5||{'id':_0x1cd52f,'name':_0x1cd52f,'version':'1.0.0'};}async['invoke'](_0x31a7e0){let _0x3cd5a8=_0x31a7e0['ctx']['app']['id'],_0x458854=_0x31a7e0['ctx']['app']['name'];try{let _0x224154={'id':_0x3cd5a8,'manifest':{'id':_0x3cd5a8,'name':_0x458854}},_0x5c69f4=await this['ensure'](_0x224154);if(_0x5c69f4['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x3cd5a8}),await this['restart'](_0x3cd5a8);let _0x657690=await this['ensure'](_0x224154);return this['lifecycle']['touch'](_0x3cd5a8),await this['messaging']['sendInvoke'](_0x657690,_0x31a7e0);}return this['lifecycle']['touch'](_0x3cd5a8),await this['messaging']['sendInvoke'](_0x5c69f4,_0x31a7e0);}catch(_0x3c330b){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x3cd5a8,'error':_0x3c330b['message'],'stack':_0x3c330b['stack']}),_0x3c330b;}}async['stop'](_0x3e30d6){await this['lifecycle']['stop'](_0x3e30d6),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x592f7b){return await this['lifecycle']['restart'](_0x592f7b,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x17d795=>({'appId':_0x17d795['appId'],'status':_0x17d795['status'],'version':_0x17d795['version'],'lastUsed':_0x17d795['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x52a16b=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x1e076d=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x52a16b(),_0x1e076d();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x50516f=>{_0x50516f?(await this['stop'](_0x50516f),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x50516f})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x2435d5){return new Q(_0x2435d5);}var S=null;function be(_0x3adf60){S=ee(_0x3adf60);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x512373){return await k()['ensure'](_0x512373);}async function xe(_0x55747b){return await k()['invoke'](_0x55747b);}function Ie(_0x9cbda8){k()['stop'](_0x9cbda8)['catch'](_0x335ac6=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x9cbda8,'error':_0x335ac6['message']});});}function Re(){k()['stopAll']()['catch'](_0x1837ed=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x1837ed['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x285641){await k()['stop'](_0x285641);}async function Se(){await k()['stopAll']();}function Ae(_0x4f7884){let _0x320acc=_0x4f7884&&typeof _0x4f7884=='object'?_0x4f7884:null;if(_0x320acc&&'user'in _0x320acc)return _0x320acc['user'];}function H(_0x407760){let _0x5732e4=_0x407760&&typeof _0x407760=='object'?_0x407760:null;if(!_0x5732e4)return{};let _0x4c5d2d={};for(let [_0x382088,_0x2f32bc]of Object['entries'](_0x5732e4))_0x382088!=='user'&&(_0x4c5d2d[_0x382088]=_0x2f32bc);return _0x4c5d2d;}function O(_0x302aba){return _0x302aba?{'id':_0x302aba['manifest']?.['id']||_0x302aba['id']||'','name':_0x302aba['manifest']?.['name']||'','version':_0x302aba['manifest']?.['version']||'','description':_0x302aba['manifest']?.['description']||'','icon':_0x302aba['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x41aad0){return _0x41aad0?.['permissions']||_0x41aad0?.['manifest']?.['permissions']||{};}function F(_0x3a035e){return _0x3a035e?.['manifest']?.['metadata']||{};}function Ce(_0x25d12c){return _0x25d12c?{'appId':_0x25d12c['id'],'appName':_0x25d12c['manifest']?.['name']}:{};}function N(_0x5acb98,_0x127114={}){let {appInfo:_0x505b7d=null,status:_0x4db8c7=0x1f4,defaultMessage:_0x322489='Internal\x20Server\x20Error'}=_0x127114,_0x4e3e42={'error':_0x322489,'message':_0x5acb98?.['message']||_0x322489};return _0x505b7d&&(_0x4e3e42['appId']=_0x505b7d['id'],_0x4e3e42['appName']=_0x505b7d['manifest']?.['name']),_0x5acb98?.['message']?.['includes']('crashed')&&(_0x4e3e42['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x4db8c7,'body':_0x4e3e42};}function qe(_0x2a6110){return _0x2a6110?.['message']?.['includes']('crashed')||![];}function J(_0x412015){if(_0x412015)try{return JSON['parse'](_0x412015);}catch{return _0x412015;}}function B(_0x4a779b){try{let _0x3b9392=new URL(_0x4a779b),_0x462173={};for(let _0x578c58 of _0x3b9392['searchParams']['keys']()){let _0x14b11a=_0x3b9392['searchParams']['getAll'](_0x578c58)['map'](_0x25c445=>_0x25c445);_0x14b11a['length']<=0x1?_0x462173[_0x578c58]=_0x14b11a[0x0]??'':_0x462173[_0x578c58]=_0x14b11a;}return _0x462173;}catch{return{};}}function Le(_0x30f634){return(()=>{try{return new URL(_0x30f634)['pathname'];}catch{return _0x30f634;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x54fa51,_0x3eefc6){let _0x4441d5=_0x54fa51;if(_0x3eefc6&&_0x4441d5['startsWith']('/apps/'+_0x3eefc6))_0x4441d5=_0x4441d5['substring'](('/apps/'+_0x3eefc6)['length'])||'/';else{let _0x146e40=_0x4441d5['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x146e40&&(_0x4441d5=_0x146e40[0x1]||'/');}return _0x4441d5['startsWith']('/api')&&(_0x4441d5=_0x4441d5['substring'](0x4)||'/'),_0x4441d5;}function Ue(_0x28ed2c,_0x3e4d41){let _0x289fc9=_0x28ed2c;if(_0x3e4d41&&_0x289fc9['startsWith']('/apps/'+_0x3e4d41))_0x289fc9=_0x289fc9['substring'](('/apps/'+_0x3e4d41)['length'])||'/';else{let _0x50ee26=_0x289fc9['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x50ee26&&(_0x289fc9=_0x50ee26[0x1]||'/');}return(!_0x289fc9||_0x289fc9==='/')&&(_0x289fc9='/index.html'),_0x289fc9;}async function He(_0x13421b,_0x3b7667){return await _0x3b7667(_0x13421b);}function _(_0x3c5c4b){return _0x3c5c4b['split']('/')['filter'](_0x165786=>_0x165786['length']>0x0);}function te(_0x417dd4){try{return decodeURIComponent(_0x417dd4);}catch{return _0x417dd4;}}function re(_0x54e317,_0x4b8f53){let _0x3033f3=_(_0x54e317),_0x26a625=_(_0x4b8f53),_0x33cb55={},_0x58fadd=0x0,_0xdec5dc=0x0;for(;_0x58fadd<_0x3033f3['length']&&_0xdec5dc<_0x26a625['length'];){let _0x9e0475=_0x3033f3[_0x58fadd],_0x41d06d=_0x26a625[_0xdec5dc];if(_0x9e0475==='*')break;if(_0x9e0475['startsWith'](':')){let _0xaab286=_0x9e0475['slice'](0x1);_0xaab286&&(_0x33cb55[_0xaab286]=te(_0x41d06d)),_0x58fadd++,_0xdec5dc++;continue;}if(_0x9e0475!==_0x41d06d)return{};_0x58fadd++,_0xdec5dc++;}return _0x58fadd===_0x3033f3['length']||_0x58fadd===_0x3033f3['length']-0x1&&_0x3033f3[_0x58fadd]==='*',_0x33cb55;}async function Oe(_0x29aac7,_0x48e964,_0x12bc97,_0x153cc1,_0x1c6163=void 0x0,_0x38e29f){let _0x184a35=await _0x48e964['text'](),_0x3c29e3=J(_0x184a35),_0x1c9140=B(_0x48e964['url']),_0x36ddd2={...F(_0x29aac7),'user':_0x1c6163},_0x413e3c=H(_0x36ddd2),_0x317a61=_0x38e29f?re(_0x38e29f,_0x48e964['path']):{};return{'app':O(_0x29aac7),'permissions':T(_0x29aac7),'user':_0x1c6163,'metadata':_0x413e3c,'body':_0x3c29e3,'query':_0x1c9140,'params':_0x317a61,'method':_0x12bc97,'pathname':_0x153cc1,'requestUrl':_0x48e964['url'],'headers':Object['fromEntries'](_0x48e964['raw']['headers']['entries']())};}function Te(_0xaa16c3){return{'method':_0xaa16c3['method'],'pathname':_0xaa16c3['pathname'],'ctx':_0xaa16c3};}function Fe(_0x43ab2c,_0xd885ee){let {status:_0x4a9f52=0xc8,headers:_0x24170a={},body:_0x1876a8,type:_0x159325}=_0x43ab2c??{};return _0x159325==='raw'?new globalThis['Response'](String(_0x1876a8??''),{'status':_0x4a9f52,'headers':_0x24170a}):_0xd885ee(_0x1876a8,_0x4a9f52);}function Ne(_0x488545,_0xbc9116=null){return N(_0x488545,{'appInfo':_0xbc9116});}var V=f;async function Ve(_0x26c467){_0x26c467?(await U(_0x26c467),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x26c467)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x4dc3a0,_0x36c466){let _0x2910b5=Object['fromEntries'](Object['entries'](_0x4dc3a0['headers']||{})['map'](([_0x3dfb75,_0x864a49])=>[_0x3dfb75['toLowerCase'](),_0x864a49]));return{'id':_0x4dc3a0['app']['id']||_0x36c466['appId']||'','name':_0x4dc3a0['app']['name']||'','version':_0x4dc3a0['app']['version']||'','description':_0x4dc3a0['app']['description']||'','metadata':{..._0x4dc3a0['metadata'],'permissions':_0x4dc3a0['permissions']},'body':_0x4dc3a0['body'],'query':_0x4dc3a0['query'],'params':_0x4dc3a0?.['params'],'method':_0x4dc3a0['method'],'pathname':_0x4dc3a0['pathname'],'requestUrl':_0x4dc3a0['requestUrl'],'user':_0x4dc3a0['user'],'headers':_0x2910b5};}var L=class{constructor(_0x5ce7bf){this['handle']=null,(this['config']=_0x5ce7bf,this['logger']=_0x5ce7bf['logger']||f,this['lifecycle']=W({'appsDir':_0x5ce7bf['appsDir'],'timeout':_0x5ce7bf['timeout'],'platformImports':_0x5ce7bf['platformImports'],'libDir':_0x5ce7bf['libDir']},{'onCreate':_0x5b42d4=>this['logger']['info']('Worker\x20created',{'appId':_0x5b42d4['appId']}),'onReady':_0x315c47=>{this['lifecycle']['updateStatus'](_0x315c47['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x315c47['appId']});},'onCrash':_0x14fe9c=>this['logger']['error']('Worker\x20crashed',{'appId':_0x14fe9c['appId']}),'onStop':_0x2620a9=>this['logger']['info']('Worker\x20stopped',{'appId':_0x2620a9['appId']})}),this['messaging']=$({'onReady':_0x13dfa9=>this['lifecycle']['updateStatus'](_0x13dfa9,'running'),'onLog':(_0x18dbae,_0x216beb,_0x357269,_0x247d29)=>{(this['logger'][_0x216beb]||this['logger']['info'])['call'](this['logger'],_0x357269,_0x247d29);},'onResult':()=>{}},_0x5ce7bf['timeout']||0x1d4c0));}async['create'](_0x8ddd2c){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x38035a=await this['lifecycle']['create'](this['config']['appId'],_0x8ddd2c,this['config']['scriptUrl']);this['messaging']['setup'](_0x38035a),this['messaging']['sendInit'](_0x38035a,this['config']['appsDir'],_0x8ddd2c,this['config']['serverPath']),this['handle']=_0x38035a,await this['waitForReady']();}async['waitForReady'](_0x12787e=0x2710){let _0x35d690=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x35d690>_0x12787e)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x26f1d4=>setTimeout(_0x26f1d4,0x64));}}async['invoke'](_0x2f7e59){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x2f7e59);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x52d638){return new L(_0x52d638);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;