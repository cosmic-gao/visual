import{join,dirname}from'path';import _0x16cf68 from'process';import{stat}from'fs/promises';async function ie(_0x56606b){try{return await stat(_0x56606b),!0x0;}catch{return![];}}var f={'error':(_0x4d60bd,_0x71144e)=>console['error']('[ERROR]\x20'+_0x4d60bd,_0x71144e),'warn':(_0x52f5d5,_0x4b5806)=>console['warn']('[WARN]\x20'+_0x52f5d5,_0x4b5806),'info':(_0x2ce851,_0x49347e)=>console['log']('[INFO]\x20'+_0x2ce851,_0x49347e),'debug':(_0x144eda,_0x1f0342)=>console['log']('[DEBUG]\x20'+_0x144eda,_0x1f0342)};function z(){let _0x4e065e=globalThis['Deno'];if(!_0x4e065e)throw new Error('Deno is not available');return _0x4e065e;}var D=class{constructor(_0x1f690c,_0x394e5b='./lib',_0x1fc9ba={}){this['manifest']=_0x1f690c,this['libDir']=_0x394e5b,this['platformImports']=_0x1fc9ba;}['buildPerms'](){let _0xd73275=this['manifest']['permissions']||{},_0x2772be={};return _0xd73275['net']!==void 0x0&&(_0x2772be['net']=_0xd73275['net']===!![]?!![]:Array['isArray'](_0xd73275['net'])?_0xd73275['net']:[]),_0xd73275['read']!==void 0x0&&(_0x2772be['read']=_0xd73275['read']===!![]?!![]:Array['isArray'](_0xd73275['read'])?_0xd73275['read']:[]),_0xd73275['write']!==void 0x0&&(_0x2772be['write']=_0xd73275['write']===!![]?!![]:Array['isArray'](_0xd73275['write'])?_0xd73275['write']:[]),_0xd73275['env']!==void 0x0&&(_0x2772be['env']=_0xd73275['env']===!![]?!![]:Array['isArray'](_0xd73275['env'])?_0xd73275['env']:[]),_0xd73275['run']!==void 0x0&&(_0x2772be['run']=_0xd73275['run']===!![]?!![]:Array['isArray'](_0xd73275['run'])?_0xd73275['run']:[]),_0xd73275['ffi']!==void 0x0&&(_0x2772be['ffi']=_0xd73275['ffi']===!![]?!![]:Array['isArray'](_0xd73275['ffi'])?_0xd73275['ffi']:[]),_0xd73275['sys']!==void 0x0&&(_0x2772be['sys']=_0xd73275['sys']===!![]?!![]:Array['isArray'](_0xd73275['sys'])?_0xd73275['sys']:[]),_0xd73275['hrtime']!==void 0x0&&(_0x2772be['hrtime']=_0xd73275['hrtime']),_0x2772be;}['normalize'](_0x5a733b){return _0x5a733b===!![]?[]:Array['isArray'](_0x5a733b)?_0x5a733b:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x533b3c){return join(this['libDir'],_0x533b3c+'@*');}['getReadPaths'](){let _0x3aaa43=this['getImports']();_0x3aaa43['includes']('*')&&(_0x3aaa43=Object['keys'](this['platformImports']));let _0x365161=[];console['log']('[Permissions] Building package path patterns for imports:',_0x3aaa43);for(let _0x135416 of _0x3aaa43){let _0x522338=this['getLibPattern'](_0x135416);_0x365161['push'](_0x522338),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x135416+'\x20->\x20'+_0x522338);}return console['log']('[Permissions] Final package path patterns:',_0x365161),_0x365161;}['buildImportMap'](_0x114091){let _0x36ccd6=this['getImports'](),_0x36c0af=_0x36ccd6['includes']('*')?Object['keys'](_0x114091):_0x36ccd6;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x36c0af);let _0x3ffac0={};for(let _0x5508ce of _0x36c0af)if(_0x114091[_0x5508ce])_0x3ffac0[_0x5508ce]=_0x114091[_0x5508ce],console['log']('[ImportMap]\x20'+_0x5508ce+'\x20->\x20'+_0x114091[_0x5508ce]+'\x20(from\x20platform)');else try{let _0x448822=z(),_0x4b8947=join(_0x448822['cwd'](),this['libDir']),_0x53fa0f=!0x1;try{for(let _0x32da5d of _0x448822['readDirSync'](_0x4b8947))if(_0x32da5d['isDirectory']&&(_0x32da5d['name']===_0x5508ce||_0x32da5d['name']['startsWith'](_0x5508ce+'@'))){let _0x52df1e=join(_0x448822['cwd'](),this['libDir'],_0x32da5d['name'],'index.js')['replace'](/\\/g,'/'),_0x318977=new URL('file:///'+_0x52df1e)['href'];_0x3ffac0[_0x5508ce]=_0x318977,console['log']('[ImportMap]\x20'+_0x5508ce+'\x20->\x20'+_0x318977+'\x20(from\x20lib)'),_0x53fa0f=!0x0;break;}}catch{}_0x53fa0f||console['warn']('[ImportMap]\x20Package\x20'+_0x5508ce+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x270f00){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x5508ce+':',_0x270f00);}return _0x3ffac0;}['validateServerImports'](_0x382685){let _0x154bed=this['manifest']['name']||this['manifest']['id'],_0x494e61=this['manifest']['metadata']?.['serverPath'],_0x295319=_0x40c44a=>_0x40c44a['replace'](/\\/g,'/'),_0x27a9b6=z(),_0x2d0720=_0x17e9b2=>{try{return _0x27a9b6['statSync'](_0x17e9b2),!0x0;}catch{return![];}},_0xba2df7=_0x494e61?_0x295319(_0x494e61):void 0x0;if(!_0xba2df7){let _0x156c67=[_0x382685+'/service/server.js',_0x382685+'/service/server.ts',_0x382685+'/'+_0x154bed+'/server.js',_0x382685+'/'+_0x154bed+'/server.ts',_0x382685+'/server.js',_0x382685+'/server.ts']['map'](_0x295319);for(let _0x1ad9ab of _0x156c67)if(_0x2d0720(_0x1ad9ab)){_0xba2df7=_0x1ad9ab;break;}}if(!_0xba2df7)return{'valid':![],'violations':['Failed to locate server module']};let _0x52bec4='';try{_0x52bec4=_0x27a9b6['readTextFileSync'](_0xba2df7);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0xba2df7};}let _0x311cdf=this['getImports']();if(_0x311cdf['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0xba2df7};let _0x364a3b=_0x311cdf,_0x2d6d3d=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x45181f=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x889811=/\bimport\s*['"]([^'"]+)['"]/g,_0x28b6b1=[],_0x463b5b=new Set(),_0x5d1f7a=_0x542eb7=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x542eb7),_0xdb0b3c=_0x173348=>{let _0x582ea2=_0x173348;if(_0x582ea2['startsWith']('./')||_0x582ea2['startsWith']('../')||_0x582ea2['startsWith']('/')||_0x582ea2['startsWith']('file://')||!_0x5d1f7a(_0x173348)||_0x463b5b['has'](_0x173348))return;_0x463b5b['add'](_0x173348),_0x582ea2['startsWith']('npm:')&&(_0x582ea2=_0x582ea2['substring'](0x4)),_0x582ea2['includes']('@')&&!_0x582ea2['startsWith']('@')&&(_0x582ea2=_0x582ea2['split']('@')[0x0]);let _0x3237bb=_0x582ea2['split']('/')[0x0];_0x364a3b['includes'](_0x3237bb)||_0x364a3b['includes'](_0x173348)||_0x28b6b1['push'](_0x173348);},_0x5f3908;for(;(_0x5f3908=_0x2d6d3d['exec'](_0x52bec4))!==null;)_0xdb0b3c(_0x5f3908[0x1]);for(;(_0x5f3908=_0x45181f['exec'](_0x52bec4))!==null;)_0xdb0b3c(_0x5f3908[0x1]);for(;(_0x5f3908=_0x889811['exec'](_0x52bec4))!==null;)_0xdb0b3c(_0x5f3908[0x1]);return{'valid':_0x28b6b1['length']===0x0,'violations':_0x28b6b1,'serverPath':_0xba2df7};}['validate'](_0x4acc87={}){let _0x475d68=[],_0x5d084d=this['manifest']['permissions']||{};try{let _0xc62b2e=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0xc62b2e);}catch{}let _0x5e1431=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x4be2b4,_0x3f1bab]of Object['entries'](_0x5d084d))if(_0x4be2b4==='hrtime')typeof _0x3f1bab!='boolean'&&_0x475d68['push']('Permission\x20\x27'+_0x4be2b4+'\x27\x20must\x20be\x20boolean');else{if(_0x4be2b4==='langchain')typeof _0x3f1bab!='boolean'&&(typeof _0x3f1bab!='object'||_0x3f1bab===null)?_0x475d68['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x3f1bab=='object'&&(_0x3f1bab===null||!('enabled'in _0x3f1bab)||typeof _0x3f1bab['enabled']!='boolean')&&_0x475d68['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x4be2b4==='kv')typeof _0x3f1bab!='boolean'&&_0x475d68['push']('Permission\x20\x27'+_0x4be2b4+'\x27\x20must\x20be\x20boolean');else{if(_0x4be2b4==='mspbots')Array['isArray'](_0x3f1bab)||_0x475d68['push']('Permission\x20\x27'+_0x4be2b4+'\x27\x20must\x20be\x20an\x20array');else{if(_0x4be2b4==='db'){if(typeof _0x3f1bab!='object'||_0x3f1bab===null||Array['isArray'](_0x3f1bab))_0x475d68['push']('Permission\x20\x27'+_0x4be2b4+'\x27\x20must\x20be\x20an\x20object');else{let _0x19a07a=_0x3f1bab,_0xbb62db=['user','password']['filter'](_0x382438=>!(_0x382438 in _0x19a07a));_0xbb62db['length']>0x0&&_0x475d68['push']('Permission\x20\x27'+_0x4be2b4+'\x27\x20missing\x20required\x20fields:\x20'+_0xbb62db['join'](',\x20'));}}else{if(_0x4be2b4==='imports')continue;_0x5e1431['has'](_0x4be2b4)||typeof _0x3f1bab!='boolean'&&!Array['isArray'](_0x3f1bab)&&_0x475d68['push']('Permission\x20\x27'+_0x4be2b4+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x292576=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x292576))_0x475d68['push']('permissions.imports must be an array');else{for(let _0x2f2c42 of _0x292576)typeof _0x2f2c42!='string'&&_0x475d68['push']('import\x20\x27'+_0x2f2c42+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x475d68['length']===0x0,'errors':_0x475d68};}};function q(_0x24d720,_0x4dc919,_0x4865ed){return new D(_0x24d720,_0x4dc919,_0x4865ed||{});}var R=null;function I(){let _0x2fc1b5=globalThis['Deno'];if(!_0x2fc1b5)throw new Error('Deno is not available');return _0x2fc1b5;}async function K(){if(R)return{...R};try{let _0x4ead11=I(),_0x94f007=join(_0x4ead11['cwd'](),'deno.json'),_0x51bffb=await _0x4ead11['readTextFile'](_0x94f007);return R=JSON['parse'](_0x51bffb)['imports']||{},{...R};}catch(_0x3f9a6d){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x3f9a6d),{};}}var E=class{constructor(_0x2b5c6a,_0x53d94b={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x2b5c6a['appsDir'],this['platformImportsOverride']=_0x2b5c6a['platformImports'],this['libDir']=_0x2b5c6a['libDir'],this['events']=_0x53d94b);}async['create'](_0x215328,_0x4969de,_0x21cbd9){try{return await this['createWorker'](_0x215328,_0x4969de,_0x21cbd9);}catch(_0x2075c5){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x215328+':',_0x2075c5),_0x2075c5;}}async['createWorker'](_0x1350e9,_0xbabf5,_0x9c64f0){let _0x2f927b=this['platformImportsOverride']||await K(),_0x4c34ac=q(_0xbabf5,this['libDir'],_0x2f927b)['validateServerImports'](this['appsDir']);if(!_0x4c34ac['valid']){let _0x220f32=_0x4c34ac['violations']['filter'](_0x183c79=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x183c79)),_0xafb2b1=_0x4c34ac['serverPath']?_0x4c34ac['serverPath']:(_0xbabf5['name']||_0xbabf5['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0xafb2b1+':\x20'+_0x220f32['join'](',\x20'));}let _0x5e4bea=q(_0xbabf5,this['libDir'],_0x2f927b),_0x22b0c9=_0x5e4bea['validate'](_0x2f927b);if(!_0x22b0c9['valid'])throw new Error('Invalid\x20config:\x20'+_0x22b0c9['errors']['join'](',\x20'));let _0x21c880=_0x5e4bea['buildImportMap'](_0x2f927b);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x1350e9+':',_0x21c880);let _0x590ba1=_0x5e4bea['buildPerms'](),_0x4bc021=_0x5e4bea['getReadPaths']();if(_0x590ba1['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x590ba1['read']);else{let _0x3825ed=_0xbabf5['name']||_0x1350e9,_0x3f6075=this['appsDir']+'/'+_0x3825ed,_0x985326=[_0x3f6075],_0x550fd9=_0xbabf5['metadata']?.['serverPath'];if(_0x550fd9&&typeof _0x550fd9=='string')try{let _0x541d71=dirname(_0x550fd9)['replace'](/\\/g,'/');_0x985326['push'](_0x541d71);}catch{}_0x590ba1['read']=_0x985326,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x3f6075);}if(_0x4bc021['length']>0x0){if(_0x590ba1['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x43bbbd=Array['isArray'](_0x590ba1['read'])?_0x590ba1['read']:[];_0x590ba1['read']=[..._0x43bbbd,..._0x4bc021],console['log']('[Worker] Added package read permissions:',_0x4bc021);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x590ba1['net']||(_0x590ba1['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x1350e9+':',_0x590ba1['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x590ba1['read']===!![]?'unrestricted':Array['isArray'](_0x590ba1['read'])?_0x590ba1['read']['length']:0x0));let _0x130ba8=await this['createImportMap'](_0x1350e9,_0x21c880),_0x381147=await this['createLock'](_0x1350e9,_0x21c880),_0x58c21b={'type':'module','deno':{'permissions':{}}};_0x58c21b['deno']['namespace']=![],_0x58c21b['deno']['permissions']=_0x590ba1,_0x58c21b['deno']['importMap']=_0x130ba8,_0x58c21b['deno']['lock']=_0x381147,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x1350e9+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x130ba8),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x381147),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x21c880)['length']+'\x20('+(Object['keys'](_0x21c880)['join'](',\x20')||'none')+')');let _0xf97902={'worker':new Worker(_0x9c64f0,_0x58c21b),'appId':_0x1350e9,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0xbabf5,'importMapPath':_0x130ba8,'lockfilePath':_0x381147};return this['workers']['set'](_0x1350e9,_0xf97902),this['events']['onCreate']?.(_0xf97902),_0xf97902;}async['createLock'](_0x225861,_0x490e9b){let _0x20e81d=I(),_0x30727a=join(_0x20e81d['cwd'](),'storage','temp','lockfiles');await _0x20e81d['mkdir'](_0x30727a,{'recursive':!![]});let _0x45579d=_0x225861+'-'+Date['now']()+'.lock',_0x31d4ed=join(_0x30727a,_0x45579d),_0x488db7={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x5489f0,_0x1a0b24]of Object['entries'](_0x490e9b))if(_0x1a0b24['startsWith']('npm:'))_0x1a0b24['replace']('npm:',''),_0x488db7['packages']['specifiers'][_0x5489f0]=_0x1a0b24;else _0x1a0b24['startsWith']('file://')&&(_0x488db7['packages']['specifiers'][_0x5489f0]=_0x1a0b24);let _0x311117=JSON['stringify'](_0x488db7,null,0x2);return await _0x20e81d['writeTextFile'](_0x31d4ed,_0x311117),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x31d4ed),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x490e9b)['length']+'):',Object['keys'](_0x490e9b)),_0x31d4ed;}async['createImportMap'](_0x546030,_0x4843f0){let _0x4b3c90=I(),_0x170a00=join(_0x4b3c90['cwd'](),'storage','temp','importmaps');await _0x4b3c90['mkdir'](_0x170a00,{'recursive':!![]});let _0x8a9553=_0x546030+'-'+Date['now']()+'.json',_0x198a1f=join(_0x170a00,_0x8a9553),_0x84b526=JSON['stringify']({'imports':_0x4843f0,'scopes':{}},null,0x2);return await _0x4b3c90['writeTextFile'](_0x198a1f,_0x84b526),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x198a1f),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x4843f0)['length']+'):',Object['keys'](_0x4843f0)['join'](',\x20')||'none'),_0x198a1f;}['get'](_0x4d6ed9){return this['workers']['get'](_0x4d6ed9);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x4bb9a8,_0x4fdda8){let _0x3be93c=this['workers']['get'](_0x4bb9a8);if(!_0x3be93c)return;let _0x304492=_0x3be93c['status'];_0x3be93c['status']=_0x4fdda8,_0x4fdda8==='running'&&_0x304492==='starting'?this['events']['onReady']?.(_0x3be93c):_0x4fdda8==='crashed'&&this['events']['onCrash']?.(_0x3be93c);}['touch'](_0x4c1c60){let _0x2e1e60=this['workers']['get'](_0x4c1c60);_0x2e1e60&&(_0x2e1e60['lastUsed']=Date['now']());}async['stop'](_0x1fe377){let _0x40339c=this['workers']['get'](_0x1fe377);if(_0x40339c)try{_0x40339c['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x40339c['worker']['terminate'](),_0x40339c['status']='stopped',this['events']['onStop']?.(_0x40339c),_0x40339c['importMapPath']&&await this['cleanupImportMap'](_0x40339c['importMapPath']),_0x40339c['lockfilePath']&&await this['cleanupLock'](_0x40339c['lockfilePath']);}catch(_0x1adc4d){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x1fe377+':',_0x1adc4d);}finally{this['workers']['delete'](_0x1fe377);}}async['cleanupImportMap'](_0x1b3abb){try{await I()['remove'](_0x1b3abb),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x1b3abb);}catch(_0x14a00f){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x1b3abb,_0x14a00f);}}async['cleanupLock'](_0x263fc9){try{await I()['remove'](_0x263fc9),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x263fc9);}catch(_0x201836){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x263fc9,_0x201836);}}async['stopAll'](){let _0x33203c=Array['from'](this['workers']['keys']());await Promise['all'](_0x33203c['map'](_0x13c19d=>this['stop'](_0x13c19d)));}async['restart'](_0x1da91b,_0x252c28){let _0xa8be6d=this['workers']['get'](_0x1da91b);if(!_0xa8be6d)throw new Error('Worker\x20'+_0x1da91b+'\x20not\x20found');let _0x31eb7d=_0xa8be6d['manifest'];return await this['stop'](_0x1da91b),await this['create'](_0x1da91b,_0x31eb7d,_0x252c28);}['checkHealth'](_0x16136a){let _0x3f6f33=this['workers']['get'](_0x16136a);if(!_0x3f6f33)return{'healthy':![],'reason':'Not\x20found'};if(_0x3f6f33['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x3f6f33['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x3199be=Date['now']()-_0x3f6f33['lastUsed'],_0x419fa0=0x708*0x3e8;return _0x3199be>_0x419fa0?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x3199be/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x4518e1=0x708*0x3e8,_0x51709a){let _0x522528=Date['now'](),_0x215f3c=[];for(let [_0x408da2,_0x3e7eb5]of this['workers']['entries']()){let _0x4658b6=_0x522528-_0x3e7eb5['lastUsed'];_0x4658b6>_0x4518e1&&_0x215f3c['push']({'appId':_0x408da2,'idle':_0x4658b6});}_0x215f3c['sort']((_0x1bfccd,_0x348030)=>_0x348030['idle']-_0x1bfccd['idle']);let _0x356307=_0x51709a?_0x215f3c['slice'](0x0,_0x51709a)['map'](_0x42627a=>_0x42627a['appId']):_0x215f3c['map'](_0x50dda6=>_0x50dda6['appId']);for(let _0x3421f1 of _0x356307)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x3421f1),await this['stop'](_0x3421f1);}['stats'](){let _0x45e210={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x4756c7=Date['now']();for(let _0x49415d of this['workers']['values']())_0x45e210['byStatus'][_0x49415d['status']]++,_0x45e210['workers']['push']({'appId':_0x49415d['appId'],'status':_0x49415d['status'],'version':_0x49415d['version'],'lastUsed':_0x49415d['lastUsed'],'idle':_0x4756c7-_0x49415d['lastUsed']});return _0x45e210;}['startCleanup'](_0x5de9e4=0x12c*0x3e8,_0x5ca67b){let _0x1dbeb7=setInterval(()=>{this['cleanup'](_0x5ca67b)['catch'](_0x59ab70=>{console['error']('Cleanup\x20failed:',_0x59ab70);});},_0x5de9e4);return()=>clearInterval(_0x1dbeb7);}['delay'](_0x1be4e8){return new Promise(_0x2b82d0=>setTimeout(_0x2b82d0,_0x1be4e8));}};function W(_0x48d802,_0x7b5c97){return new E(_0x48d802,_0x7b5c97);}var v=f,j=class{constructor(_0x255a2c,_0x109d6f=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x255a2c,this['timeout']=_0x109d6f);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x2b7b93){_0x2b7b93['worker']['onmessage']=_0x3c6829=>{let _0x2606ca=_0x3c6829['data'],{appId:_0x235cc1}=_0x2b7b93;switch(_0x2606ca['type']){case'ready':this['events']['onReady'](_0x235cc1),v['info']('Worker\x20ready',{'appId':_0x235cc1,'version':_0x2b7b93['version']});break;case'log':{let {level:_0x55a924='info',message:_0xbd9a10,meta:_0x21b016}=_0x2606ca,_0x31e1a8={..._0x21b016||{},'appId':_0x235cc1,'version':_0x2b7b93['version']};this['events']['onLog'](_0x235cc1,_0x55a924,_0xbd9a10,_0x31e1a8);break;}case'result':{let {reqId:_0x1c7eeb,ok:_0x38f145,response:_0x5eedfa,error:_0x2fb066}=_0x2606ca,_0x58a1a3=this['pending']['get'](_0x1c7eeb);if(!_0x58a1a3){v['warn']('Unknown\x20request',{'appId':_0x235cc1,'reqId':_0x1c7eeb});return;}if(this['pending']['delete'](_0x1c7eeb),_0x38f145&&_0x5eedfa)_0x58a1a3['resolve'](_0x5eedfa);else{let _0x409031=new Error(_0x2fb066?.['message']||'Worker\x20error');_0x409031['stack']=_0x2fb066?.['stack'],_0x58a1a3['reject'](_0x409031);}this['events']['onResult'](_0x235cc1,_0x1c7eeb,_0x5eedfa||_0x2fb066);break;}default:v['debug']('Unknown\x20message',{'appId':_0x235cc1,'type':_0x2606ca['type']});}},_0x2b7b93['worker']['onerror']=_0x45b921=>{let {appId:_0x2f8715}=_0x2b7b93;v['error']('Worker\x20error',{'appId':_0x2f8715,'message':_0x45b921['message'],'lineno':_0x45b921['lineno'],'filename':_0x45b921['filename']}),_0x2b7b93['status']='crashed',this['rejectPending'](_0x2f8715,new Error('Worker\x20'+_0x2f8715+'\x20crashed:\x20'+_0x45b921['message'])),_0x45b921['preventDefault']();},_0x2b7b93['worker']['onmessageerror']=_0x371051=>{let {appId:_0x20a815}=_0x2b7b93;v['error']('Message\x20error',{'appId':_0x20a815,'data':_0x371051['data']}),_0x2b7b93['status']='crashed',_0x371051['preventDefault']();};}['sendInit'](_0xb7dd94,_0x566cad,_0x528a26,_0xf94f84){_0xb7dd94['worker']['postMessage']({'type':'init','appId':_0xb7dd94['appId'],'manifest':_0x528a26,'appsDir':_0x566cad,'serverPath':_0xf94f84});}async['sendInvoke'](_0x5d3e89,_0x4c0df8){let _0x1eed21=this['nextId'](),_0x132596=_0x5d3e89['appId'],_0xa175ba=new Promise((_0x2064de,_0x3060a6)=>{let _0x4cb1f4=setTimeout(()=>{this['pending']['delete'](_0x1eed21),_0x3060a6(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x1eed21,{'resolve':_0xe048c=>{clearTimeout(_0x4cb1f4),_0x2064de(_0xe048c);},'reject':_0x2bae04=>{clearTimeout(_0x4cb1f4),_0x3060a6(_0x2bae04);},'timestamp':Date['now'](),'appId':_0x132596});});return _0x5d3e89['worker']['postMessage']({'type':'invoke','appId':_0x5d3e89['appId'],'reqId':_0x1eed21,'payload':_0x4c0df8}),await _0xa175ba;}['rejectPending'](_0x6023ad,_0x29998f){let _0x14c605=0x0;for(let [_0x4759e6,_0x107d64]of this['pending']['entries']())_0x107d64['appId']===_0x6023ad&&(this['pending']['delete'](_0x4759e6),_0x107d64['reject'](_0x29998f),_0x14c605++);_0x14c605>0x0&&v['warn']('Rejected\x20'+_0x14c605+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x6023ad});}['cleanupTimeout'](){let _0x55f0e7=Date['now']();for(let [_0x32d4a2,_0x13d00a]of this['pending']['entries']())_0x55f0e7-_0x13d00a['timestamp']>this['timeout']&&(this['pending']['delete'](_0x32d4a2),_0x13d00a['reject'](new Error('Request\x20'+_0x32d4a2+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x5bbfde){let _0x5e3296=0x0;for(let _0x34a0d7 of this['pending']['values']())_0x34a0d7['appId']===_0x5bbfde&&_0x5e3296++;return _0x5e3296;}['startCleanup'](_0x3afb09=0x2710){let _0x14a312=setInterval(()=>{this['cleanupTimeout']();},_0x3afb09);return()=>clearInterval(_0x14a312);}};function $(_0xf9e1fc,_0x275bae){return new j(_0xf9e1fc,_0x275bae);}var Q=class{constructor(_0x34c1ac={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x34c1ac['logger']||f,this['config']={'appsDir':_0x34c1ac['appsDir']||this['getAppsDir'](),'scriptUrl':_0x34c1ac['scriptUrl']||this['getScriptUrl'](),'timeout':_0x34c1ac['timeout']||0x78*0x3e8,'autoCleanup':_0x34c1ac['autoCleanup']??!![],'cleanupInterval':_0x34c1ac['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x34c1ac['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x34c1ac['maxWorkers'],'reuseWorkers':_0x34c1ac['reuseWorkers']??!![],'workerReuseStrategy':_0x34c1ac['workerReuseStrategy']||'lru','enableQueue':_0x34c1ac['enableQueue']??!![],'maxQueueSize':_0x34c1ac['maxQueueSize']||0x64,'queueTimeout':_0x34c1ac['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x5de4f9=>this['logger']['info']('Worker\x20created',{'appId':_0x5de4f9['appId'],'v':_0x5de4f9['version']}),'onReady':_0x3383e7=>this['lifecycle']['updateStatus'](_0x3383e7['appId'],'running'),'onCrash':_0x4e934f=>this['logger']['error']('Worker\x20crashed',{'appId':_0x4e934f['appId'],'v':_0x4e934f['version']}),'onStop':_0xafd7bd=>this['logger']['info']('Worker\x20stopped',{'appId':_0xafd7bd['appId'],'v':_0xafd7bd['version']})}),this['messaging']=$({'onReady':_0x3d5f44=>this['lifecycle']['updateStatus'](_0x3d5f44,'running'),'onLog':(_0x3d7341,_0x33cb2c,_0x5405d3,_0x50b456)=>{let _0x1c954d={..._0x50b456||{},'appId':_0x3d7341};switch(_0x33cb2c){case'error':this['logger']['error'](_0x5405d3,_0x1c954d);break;case'warn':this['logger']['warn'](_0x5405d3,_0x1c954d);break;case'debug':this['logger']['debug'](_0x5405d3,_0x1c954d);break;default:this['logger']['info'](_0x5405d3,_0x1c954d);break;}},'onResult':(_0xb77876,_0x3d532c,_0x33a638)=>{this['logger']['debug']('Result\x20received',{'appId':_0xb77876,'reqId':_0x3d532c});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x16cf68['cwd'](),'apps');}['getScriptUrl'](){let _0x3353f9=import.meta.url,_0x392505=_0x3353f9['endsWith']('.js')||_0x3353f9['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x392505,_0x3353f9)['href'];}async['ensure'](_0x94708e){let {id:_0x179ff7}=_0x94708e,_0x3ea65d=this['lifecycle']['get'](_0x179ff7);if(_0x3ea65d){let _0x4c0a47=this['lifecycle']['checkHealth'](_0x179ff7);if(_0x4c0a47['healthy'])return this['lifecycle']['touch'](_0x179ff7),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x179ff7}),_0x3ea65d;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x179ff7,'reason':_0x4c0a47['reason']}),await this['lifecycle']['stop'](_0x179ff7);}for(;;){let _0x178e2b=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x178e2b>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x178e2b,'max':this['config']['maxWorkers'],'appId':_0x179ff7}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x94708e);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x311ee5=await this['loadManifest'](_0x179ff7,_0x94708e['manifest']),_0x3ec93f=await this['lifecycle']['create'](_0x179ff7,_0x311ee5,this['config']['scriptUrl']),_0x4ff9e0=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x4ff9e0>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x4ff9e0,'max':this['config']['maxWorkers'],'appId':_0x179ff7}),await this['lifecycle']['stop'](_0x179ff7),this['config']['enableQueue'])return await this['waitSlot'](_0x94708e);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x4ff9e0+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x3ec93f);let _0x5a508a=_0x311ee5['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x3ec93f,this['config']['appsDir'],_0x311ee5,_0x5a508a),this['logger']['info']('Worker\x20created',{'appId':_0x179ff7,'v':_0x3ec93f['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x3ec93f;}async['evictIdle'](){let _0xf1f991=this['lifecycle']['getAll']();if(_0xf1f991['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x4c4f39=[..._0xf1f991];this['config']['workerReuseStrategy']==='lru'?_0x4c4f39['sort']((_0xa629f8,_0x4ee963)=>_0xa629f8['lastUsed']-_0x4ee963['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x4c4f39['sort']((_0xf794b3,_0x2dfab8)=>_0xf794b3['version']-_0x2dfab8['version']);let _0x460415=null;for(let _0x4dbd47 of _0x4c4f39)if(this['messaging']['getAppCount'](_0x4dbd47['appId'])===0x0){_0x460415=_0x4dbd47;break;}if(!_0x460415&&_0x4c4f39['length']>0x0&&(_0x460415=_0x4c4f39['reduce']((_0x36ee5f,_0x379475)=>{let _0x5dfb4a=this['messaging']['getAppCount'](_0x36ee5f['appId']);return this['messaging']['getAppCount'](_0x379475['appId'])<_0x5dfb4a?_0x379475:_0x36ee5f;})),_0x460415){let _0xcfd0ee=this['messaging']['getAppCount'](_0x460415['appId']);return _0xcfd0ee>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x460415['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x460415['lastUsed'],'pendingRequests':_0xcfd0ee}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x460415['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x460415['lastUsed']}),await this['lifecycle']['stop'](_0x460415['appId']),!![];}return![];}['waitSlot'](_0x1b81e4){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x4cd983,_0x3975a2)=>{let _0x19cacc={'info':_0x1b81e4,'resolve':_0x4cd983,'reject':_0x3975a2,'timestamp':Date['now']()};this['requestQueue']['push'](_0x19cacc),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x1b81e4['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x5a1d13=setTimeout(()=>{let _0x5236c2=this['requestQueue']['indexOf'](_0x19cacc);_0x5236c2!==-0x1&&(this['requestQueue']['splice'](_0x5236c2,0x1),_0x3975a2(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x19cacc['resolve']=_0x5b9ed8=>{clearTimeout(_0x5a1d13),_0x4cd983(_0x5b9ed8);},_0x19cacc['reject']=_0x15bd6b=>{clearTimeout(_0x5a1d13),_0x3975a2(_0x15bd6b);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x19a2f0=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x19a2f0>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x2e597c=this['requestQueue']['shift']();if(!_0x2e597c)break;try{let _0x2b8490=await this['ensure'](_0x2e597c['info']);_0x2e597c['resolve'](_0x2b8490);}catch(_0x3c3ffa){_0x2e597c['reject'](_0x3c3ffa);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x45bf8b,_0xf52dbe){let _0x6bda5e=this['config']['appsDir']['replace'](/\\/g,'/'),_0x41e392=async _0x3c5779=>{try{let _0x55be31=globalThis['Deno'];if(!_0x55be31)return null;let _0x4ba78e=await _0x55be31['readTextFile'](_0x3c5779);return JSON['parse'](_0x4ba78e);}catch{return null;}};if(_0xf52dbe?.['name']){let _0xb27381=await _0x41e392(_0x6bda5e+'/'+_0xf52dbe['name']+'/manifest.json');if(_0xb27381)return _0xb27381;}let _0x560185=await _0x41e392(_0x6bda5e+'/'+_0x45bf8b+'/manifest.json');if(_0x560185)return _0x560185;try{let _0x384f77=globalThis['Deno'];if(_0x384f77)for await(let _0x15a7b0 of _0x384f77['readDir'](_0x6bda5e)){if(!_0x15a7b0['isDirectory'])continue;let _0x4dfe2c=_0x6bda5e+'/'+_0x15a7b0['name']+'/manifest.json',_0x58d7e8=await _0x41e392(_0x4dfe2c);if(_0x58d7e8&&(_0x58d7e8['id']===_0x45bf8b||_0xf52dbe?.['name']&&_0x58d7e8['name']===_0xf52dbe['name']))return _0x58d7e8;}}catch(_0x5e7614){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x45bf8b,'error':_0x5e7614['message']});}return _0xf52dbe||{'id':_0x45bf8b,'name':_0x45bf8b,'version':'1.0.0'};}async['invoke'](_0x1c361d){let _0x2eabc7=_0x1c361d['ctx']['app']['id'],_0x27a823=_0x1c361d['ctx']['app']['name'];try{let _0x3fd742={'id':_0x2eabc7,'manifest':{'id':_0x2eabc7,'name':_0x27a823}},_0x4c9ecb=await this['ensure'](_0x3fd742);if(_0x4c9ecb['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x2eabc7}),await this['restart'](_0x2eabc7);let _0x496e20=await this['ensure'](_0x3fd742);return this['lifecycle']['touch'](_0x2eabc7),await this['messaging']['sendInvoke'](_0x496e20,_0x1c361d);}return this['lifecycle']['touch'](_0x2eabc7),await this['messaging']['sendInvoke'](_0x4c9ecb,_0x1c361d);}catch(_0x158340){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x2eabc7,'error':_0x158340['message'],'stack':_0x158340['stack']}),_0x158340;}}async['stop'](_0x573f29){await this['lifecycle']['stop'](_0x573f29),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x40c280){return await this['lifecycle']['restart'](_0x40c280,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x352388=>({'appId':_0x352388['appId'],'status':_0x352388['status'],'version':_0x352388['version'],'lastUsed':_0x352388['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x517642=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x15b97b=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x517642(),_0x15b97b();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x4ad407=>{_0x4ad407?(await this['stop'](_0x4ad407),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x4ad407})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x595b28){return new Q(_0x595b28);}var S=null;function be(_0xbaf5bb){S=ee(_0xbaf5bb);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x351987){return await k()['ensure'](_0x351987);}async function xe(_0x3704c2){return await k()['invoke'](_0x3704c2);}function Ie(_0x4a98f4){k()['stop'](_0x4a98f4)['catch'](_0x372eeb=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x4a98f4,'error':_0x372eeb['message']});});}function Re(){k()['stopAll']()['catch'](_0x89b810=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x89b810['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x119578){await k()['stop'](_0x119578);}async function Se(){await k()['stopAll']();}function Ae(_0x2b4a44){let _0x2a9d4d=_0x2b4a44&&typeof _0x2b4a44=='object'?_0x2b4a44:null;if(_0x2a9d4d&&'user'in _0x2a9d4d)return _0x2a9d4d['user'];}function H(_0x53ac41){let _0x4649d2=_0x53ac41&&typeof _0x53ac41=='object'?_0x53ac41:null;if(!_0x4649d2)return{};let _0x22a560={};for(let [_0x1f916c,_0xb24c4]of Object['entries'](_0x4649d2))_0x1f916c!=='user'&&(_0x22a560[_0x1f916c]=_0xb24c4);return _0x22a560;}function O(_0x50a386){return _0x50a386?{'id':_0x50a386['manifest']?.['id']||_0x50a386['id']||'','name':_0x50a386['manifest']?.['name']||'','version':_0x50a386['manifest']?.['version']||'','description':_0x50a386['manifest']?.['description']||'','icon':_0x50a386['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x202555){return _0x202555?.['permissions']||_0x202555?.['manifest']?.['permissions']||{};}function F(_0x1f97d9){return _0x1f97d9?.['manifest']?.['metadata']||{};}function Ce(_0x49b6ad){return _0x49b6ad?{'appId':_0x49b6ad['id'],'appName':_0x49b6ad['manifest']?.['name']}:{};}function N(_0x33822e,_0x1d10a8={}){let {appInfo:_0x386c48=null,status:_0x2e8fba=0x1f4,defaultMessage:_0x318575='Internal\x20Server\x20Error'}=_0x1d10a8,_0xc9a18={'error':_0x318575,'message':_0x33822e?.['message']||_0x318575};return _0x386c48&&(_0xc9a18['appId']=_0x386c48['id'],_0xc9a18['appName']=_0x386c48['manifest']?.['name']),_0x33822e?.['message']?.['includes']('crashed')&&(_0xc9a18['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x2e8fba,'body':_0xc9a18};}function qe(_0x4dc4f5){return _0x4dc4f5?.['message']?.['includes']('crashed')||![];}function J(_0x5c09dc){if(_0x5c09dc)try{return JSON['parse'](_0x5c09dc);}catch{return _0x5c09dc;}}function B(_0x6c3eef){try{let _0x41b6bb=new URL(_0x6c3eef),_0x21ecb8={};for(let _0xfdee91 of _0x41b6bb['searchParams']['keys']()){let _0xd01bad=_0x41b6bb['searchParams']['getAll'](_0xfdee91)['map'](_0x591ed5=>_0x591ed5);_0xd01bad['length']<=0x1?_0x21ecb8[_0xfdee91]=_0xd01bad[0x0]??'':_0x21ecb8[_0xfdee91]=_0xd01bad;}return _0x21ecb8;}catch{return{};}}function Le(_0x3f205f){return(()=>{try{return new URL(_0x3f205f)['pathname'];}catch{return _0x3f205f;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x544313,_0x38d843){let _0x3b1be1=_0x544313;if(_0x38d843&&_0x3b1be1['startsWith']('/apps/'+_0x38d843))_0x3b1be1=_0x3b1be1['substring'](('/apps/'+_0x38d843)['length'])||'/';else{let _0x4854a3=_0x3b1be1['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x4854a3&&(_0x3b1be1=_0x4854a3[0x1]||'/');}return _0x3b1be1['startsWith']('/api')&&(_0x3b1be1=_0x3b1be1['substring'](0x4)||'/'),_0x3b1be1;}function Ue(_0x598540,_0x10bad4){let _0x3195a1=_0x598540;if(_0x10bad4&&_0x3195a1['startsWith']('/apps/'+_0x10bad4))_0x3195a1=_0x3195a1['substring'](('/apps/'+_0x10bad4)['length'])||'/';else{let _0x5a2705=_0x3195a1['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x5a2705&&(_0x3195a1=_0x5a2705[0x1]||'/');}return(!_0x3195a1||_0x3195a1==='/')&&(_0x3195a1='/index.html'),_0x3195a1;}async function He(_0x61da6c,_0x34d676){return await _0x34d676(_0x61da6c);}function _(_0x49f234){return _0x49f234['split']('/')['filter'](_0x2a3b52=>_0x2a3b52['length']>0x0);}function te(_0x3a6a7d){try{return decodeURIComponent(_0x3a6a7d);}catch{return _0x3a6a7d;}}function re(_0x4e9a08,_0x58155b){let _0xabee6a=_(_0x4e9a08),_0x54f7b1=_(_0x58155b),_0x24be80={},_0x22d28f=0x0,_0x391626=0x0;for(;_0x22d28f<_0xabee6a['length']&&_0x391626<_0x54f7b1['length'];){let _0x432e70=_0xabee6a[_0x22d28f],_0x513c80=_0x54f7b1[_0x391626];if(_0x432e70==='*')break;if(_0x432e70['startsWith'](':')){let _0x12473e=_0x432e70['slice'](0x1);_0x12473e&&(_0x24be80[_0x12473e]=te(_0x513c80)),_0x22d28f++,_0x391626++;continue;}if(_0x432e70!==_0x513c80)return{};_0x22d28f++,_0x391626++;}return _0x22d28f===_0xabee6a['length']||_0x22d28f===_0xabee6a['length']-0x1&&_0xabee6a[_0x22d28f]==='*',_0x24be80;}async function Oe(_0x48e8a5,_0x2716f0,_0x512667,_0x2342cd,_0x265735=void 0x0,_0x5bf045){let _0x34d05a=await _0x2716f0['text'](),_0x477450=J(_0x34d05a),_0x1ca31b=B(_0x2716f0['url']),_0x413a8a={...F(_0x48e8a5),'user':_0x265735},_0x59b570=H(_0x413a8a),_0x3610fe=_0x5bf045?re(_0x5bf045,_0x2716f0['path']):{};return{'app':O(_0x48e8a5),'permissions':T(_0x48e8a5),'user':_0x265735,'metadata':_0x59b570,'body':_0x477450,'query':_0x1ca31b,'params':_0x3610fe,'method':_0x512667,'pathname':_0x2342cd,'requestUrl':_0x2716f0['url'],'headers':Object['fromEntries'](_0x2716f0['raw']['headers']['entries']())};}function Te(_0x487ccc){return{'method':_0x487ccc['method'],'pathname':_0x487ccc['pathname'],'ctx':_0x487ccc};}function Fe(_0x555def,_0x1fba5c){let {status:_0x4bada0=0xc8,headers:_0x11868e={},body:_0x52a7d3,type:_0x906968}=_0x555def??{};return _0x906968==='raw'?new globalThis['Response'](String(_0x52a7d3??''),{'status':_0x4bada0,'headers':_0x11868e}):_0x1fba5c(_0x52a7d3,_0x4bada0);}function Ne(_0x5ca81,_0x2d485b=null){return N(_0x5ca81,{'appInfo':_0x2d485b});}var V=f;async function Ve(_0x3284a1){_0x3284a1?(await U(_0x3284a1),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x3284a1)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x2ce702,_0x20b03f){let _0x5bb615=Object['fromEntries'](Object['entries'](_0x2ce702['headers']||{})['map'](([_0x23af37,_0x1171df])=>[_0x23af37['toLowerCase'](),_0x1171df]));return{'id':_0x2ce702['app']['id']||_0x20b03f['appId']||'','name':_0x2ce702['app']['name']||'','version':_0x2ce702['app']['version']||'','description':_0x2ce702['app']['description']||'','metadata':{..._0x2ce702['metadata'],'permissions':_0x2ce702['permissions']},'body':_0x2ce702['body'],'query':_0x2ce702['query'],'params':_0x2ce702?.['params'],'method':_0x2ce702['method'],'pathname':_0x2ce702['pathname'],'requestUrl':_0x2ce702['requestUrl'],'user':_0x2ce702['user'],'headers':_0x5bb615};}var L=class{constructor(_0x5a0b8c){this['handle']=null,(this['config']=_0x5a0b8c,this['logger']=_0x5a0b8c['logger']||f,this['lifecycle']=W({'appsDir':_0x5a0b8c['appsDir'],'timeout':_0x5a0b8c['timeout'],'platformImports':_0x5a0b8c['platformImports'],'libDir':_0x5a0b8c['libDir']},{'onCreate':_0x2dd535=>this['logger']['info']('Worker\x20created',{'appId':_0x2dd535['appId']}),'onReady':_0x58884d=>{this['lifecycle']['updateStatus'](_0x58884d['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x58884d['appId']});},'onCrash':_0x5cc9c8=>this['logger']['error']('Worker\x20crashed',{'appId':_0x5cc9c8['appId']}),'onStop':_0x7d2d3d=>this['logger']['info']('Worker\x20stopped',{'appId':_0x7d2d3d['appId']})}),this['messaging']=$({'onReady':_0x4aaae9=>this['lifecycle']['updateStatus'](_0x4aaae9,'running'),'onLog':(_0x5a39f3,_0x3e4c10,_0x556011,_0x3b9e1c)=>{(this['logger'][_0x3e4c10]||this['logger']['info'])['call'](this['logger'],_0x556011,_0x3b9e1c);},'onResult':()=>{}},_0x5a0b8c['timeout']||0x1d4c0));}async['create'](_0x19d823){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x855ee=await this['lifecycle']['create'](this['config']['appId'],_0x19d823,this['config']['scriptUrl']);this['messaging']['setup'](_0x855ee),this['messaging']['sendInit'](_0x855ee,this['config']['appsDir'],_0x19d823,this['config']['serverPath']),this['handle']=_0x855ee,await this['waitForReady']();}async['waitForReady'](_0x1755d5=0x2710){let _0x353152=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x353152>_0x1755d5)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x53169e=>setTimeout(_0x53169e,0x64));}}async['invoke'](_0x5206c7){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x5206c7);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x262eba){return new L(_0x262eba);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};