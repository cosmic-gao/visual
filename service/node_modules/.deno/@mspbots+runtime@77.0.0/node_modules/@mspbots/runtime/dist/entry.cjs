'use strict';function c(_0x2c0766,_0x4a35d1){let _0x2f40d7=Object['fromEntries'](Object['entries'](_0x2c0766['headers']||{})['map'](([_0x47b510,_0x54e615])=>[_0x47b510['toLowerCase'](),_0x54e615]));return{'id':_0x2c0766['app']['id']||_0x4a35d1['appId']||'','name':_0x2c0766['app']['name']||'','version':_0x2c0766['app']['version']||'','description':_0x2c0766['app']['description']||'','metadata':{..._0x2c0766['metadata'],'permissions':_0x2c0766['permissions']},'body':_0x2c0766['body'],'query':_0x2c0766['query'],'params':_0x2c0766?.['params'],'method':_0x2c0766['method'],'pathname':_0x2c0766['pathname'],'requestUrl':_0x2c0766['requestUrl'],'user':_0x2c0766['user'],'headers':_0x2f40d7};}function f(_0x50bf7c){return _0x50bf7c['split']('/')['filter'](_0x4ab39f=>_0x4ab39f['length']>0x0);}function P(_0x318265,_0x5373c9){let _0x6a3b0e=f(_0x318265),_0x285c48=f(_0x5373c9),_0x4a0ef4=0x0,_0x2ade3f=0x0;for(;_0x4a0ef4<_0x6a3b0e['length']&&_0x2ade3f<_0x285c48['length'];){let _0x29ec36=_0x6a3b0e[_0x4a0ef4],_0x52f4e1=_0x285c48[_0x2ade3f];if(_0x29ec36==='*')return!![];if(_0x29ec36['startsWith'](':')){_0x4a0ef4++,_0x2ade3f++;continue;}if(_0x29ec36!==_0x52f4e1)return![];_0x4a0ef4++,_0x2ade3f++;}return _0x4a0ef4===_0x6a3b0e['length']&&_0x2ade3f===_0x285c48['length']||_0x4a0ef4===_0x6a3b0e['length']-0x1&&_0x6a3b0e[_0x4a0ef4]==='*';}function m(_0x4564a0,_0x22beb7,_0x5f1bce){let _0xa4ba0a=_0x22beb7+'\x20'+_0x5f1bce;if(_0x4564a0[_0xa4ba0a])return{'handler':_0x4564a0[_0xa4ba0a],'routePattern':_0x5f1bce};let _0x50d657=[];_0x5f1bce['startsWith']('/api')?_0x50d657['push'](_0x5f1bce['substring'](0x4)||'/'):_0x50d657['push']('/api'+_0x5f1bce),_0x50d657['push'](_0x5f1bce);for(let _0x55412d of _0x50d657)for(let _0x2d5176 of Object['keys'](_0x4564a0)){if(!_0x2d5176['startsWith'](_0x22beb7+'\x20'))continue;let _0xd997d3=_0x2d5176['substring'](_0x22beb7['length']+0x1);if(P(_0xd997d3,_0x55412d))return{'handler':_0x4564a0[_0x2d5176],'routePattern':_0xd997d3};}return null;}function k(_0x574317){return typeof _0x574317=='function'?{'handler':_0x574317,'routePattern':''}:_0x574317;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x156274){let _0x101b1a=async _0x81571=>{try{let _0x3fd4f5=globalThis['Deno'];if(!_0x3fd4f5)throw new Error('Deno is not available');return await _0x3fd4f5['stat'](_0x81571),!0x0;}catch{return![];}};if(_0x156274&&typeof _0x156274=='string'&&_0x156274['length']>0x0)return _0x156274;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x3c4be9=s['manifest']?.['metadata']?.['serverPath'];if(_0x3c4be9&&typeof _0x3c4be9=='string'&&_0x3c4be9['length']>0x0)return _0x3c4be9;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x2ae7ea=s['manifest']['name'];if(!_0x2ae7ea)throw new Error('Manifest\x20name\x20not\x20found');let _0x1948df=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x2ae7ea+'/server.js',s['appsDir']+'/'+_0x2ae7ea+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x5b1432 of _0x1948df)if(await _0x101b1a(_0x5b1432))return _0x5b1432;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x1948df['join'](',\x20'));}function R(){let _0x3298ab=['log','info','warn','error','debug','trace'];for(let _0xe50f3f of _0x3298ab){let _0x51dfeb=(console[_0xe50f3f]||console['log'])['bind'](console);console[_0xe50f3f]=(..._0x128556)=>{try{let _0x465469=_0x128556['map'](_0x34a45d=>{if(typeof _0x34a45d=='string')return _0x34a45d;if(_0x34a45d instanceof Error)return JSON['stringify']({'name':_0x34a45d['name'],'message':_0x34a45d['message'],'stack':_0x34a45d['stack']});if(typeof Request<'u'&&_0x34a45d instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x34a45d['url'],'method':_0x34a45d['method'],'headers':Object['fromEntries'](_0x34a45d['headers']['entries']()),'bodyUsed':_0x34a45d['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x34a45d instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x34a45d['status'],'headers':Object['fromEntries'](_0x34a45d['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x34a45d);}catch{return String(_0x34a45d);}})['join']('\x20');self['postMessage']({'type':'log','level':_0xe50f3f==='log'?'info':_0xe50f3f,'message':_0x465469,'meta':{'appId':s['appId']}});}catch{_0x51dfeb(..._0x128556);}};}}R();async function v(_0x560ebf){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x44f0b0=(await w(_0x560ebf))['replace'](/\\/g,'/'),_0x3ee0f0=(_0x44f0b0['startsWith']('file://')?_0x44f0b0:'file://'+_0x44f0b0)+'?t='+Date['now']();try{let _0x282f9b=await import(_0x3ee0f0);return s['module']=_0x282f9b,_0x282f9b;}catch(_0x57b7d0){throw console['error']('Failed to load module:',_0x57b7d0),_0x57b7d0;}}function b(_0x4c423d){return _0x4c423d instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x4c423d,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x58422d){return _0x58422d['split']('/')['filter'](_0x5a9c20=>_0x5a9c20['length']>0x0);}function E(_0x537c64){try{return decodeURIComponent(_0x537c64);}catch{return _0x537c64;}}function I(_0x1c3598,_0x2c6389){let _0x4a88df=g(_0x1c3598),_0x40387d=g(_0x2c6389),_0x50137e={},_0x7168d5=0x0,_0x1e4b0a=0x0;for(;_0x7168d5<_0x4a88df['length']&&_0x1e4b0a<_0x40387d['length'];){let _0x4981ba=_0x4a88df[_0x7168d5],_0x55deaa=_0x40387d[_0x1e4b0a];if(_0x4981ba==='*')break;if(_0x4981ba['startsWith'](':')){let _0x19fa33=_0x4981ba['slice'](0x1);_0x19fa33&&(_0x50137e[_0x19fa33]=E(_0x55deaa)),_0x7168d5++,_0x1e4b0a++;continue;}if(_0x4981ba!==_0x55deaa)return{};_0x7168d5++,_0x1e4b0a++;}return _0x7168d5===_0x4a88df['length']||_0x7168d5===_0x4a88df['length']-0x1&&_0x4a88df[_0x7168d5]==='*',_0x50137e;}function M(_0x262482,_0xe62665){return _0x262482['startsWith']('/api')&&!_0xe62665['startsWith']('/api')?_0x262482['substring'](0x4)||'/':!_0x262482['startsWith']('/api')&&_0xe62665['startsWith']('/api')?'/api'+(_0x262482['startsWith']('/')?'':'/')+_0x262482:_0x262482;}async function W(_0xf68850){let _0x591718=_0xf68850['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x591718)&&await v(_0x591718);let _0x314fc6=_0xf68850['ctx'],{method:_0x572eea,pathname:_0x33d773}=_0x314fc6,_0x1aab4c=s['module']?.['default']||{},_0x51e396=m(_0x1aab4c,_0x572eea,_0x33d773);if(!_0x51e396)throw Object['assign'](new Error('Route\x20'+_0x572eea+'\x20'+_0x33d773+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x24e8b0=k(_0x51e396),_0x276b89=c(_0x314fc6,s),_0x26304f=_0x33d773,_0xcd95cd=M(_0x24e8b0['routePattern'],_0x26304f),_0x2fb1ce=_0xcd95cd?I(_0xcd95cd,_0x26304f):{},_0x30083e=await _0x24e8b0['handler']({..._0x276b89,'params':{..._0x276b89['params'],..._0x2fb1ce}});return b(_0x30083e);}function D(_0x56ed09){s['appId']=_0x56ed09['appId'],s['manifest']=_0x56ed09['manifest'],s['appsDir']=_0x56ed09['appsDir'],s['serverPath']=_0x56ed09['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x322fa7){let {reqId:_0x53fa7c,payload:_0x5a4653}=_0x322fa7;try{let _0x10a124=await W(_0x5a4653);self['postMessage']({'type':'result','reqId':_0x53fa7c,'ok':!0x0,'response':_0x10a124});}catch(_0x4d8bea){let _0x2a5ae3=_0x4d8bea;self['postMessage']({'type':'result','reqId':_0x53fa7c,'ok':![],'error':{'message':_0x2a5ae3['message'],'stack':_0x2a5ae3['stack'],'code':_0x2a5ae3['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x504e9f=>{let _0x25b7d7=_0x504e9f['data'];try{switch(_0x25b7d7['type']){case'init':D(_0x25b7d7);break;case'invoke':await $(_0x25b7d7);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x25b7d7['type']);break;}}catch(_0x204fec){let _0x2cda54=_0x204fec;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x2cda54['message'],'stack':_0x2cda54['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x2cda54);}}},self['onerror']=_0x48d78d=>{let _0x5af0ba={'message':typeof _0x48d78d=='string'?_0x48d78d:_0x48d78d['message'],'filename':typeof _0x48d78d=='string'?void 0x0:_0x48d78d['filename'],'lineno':typeof _0x48d78d=='string'?void 0x0:_0x48d78d['lineno'],'colno':typeof _0x48d78d=='string'?void 0x0:_0x48d78d['colno'],'error':typeof _0x48d78d=='string'?void 0x0:_0x48d78d['error']?.['message'],'stack':typeof _0x48d78d=='string'?void 0x0:_0x48d78d['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x5af0ba);},self['onunhandledrejection']=_0x5a57a0=>{let _0x4d31f0=_0x5a57a0['reason'],_0x28a982={'appId':s['appId'],'reason':_0x4d31f0 instanceof Error?_0x4d31f0['message']:String(_0x4d31f0),'stack':_0x4d31f0 instanceof Error?_0x4d31f0['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x28a982);};