'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x1499a4){return _0x1499a4&&_0x1499a4['__esModule']?_0x1499a4:{'default':_0x1499a4};}var Y__default=_interopDefault(Y);async function ie(_0x21d378){try{return await promises['stat'](_0x21d378),!0x0;}catch{return![];}}var f={'error':(_0x2f9461,_0x39550b)=>console['error']('[ERROR]\x20'+_0x2f9461,_0x39550b),'warn':(_0xa27de1,_0x566071)=>console['warn']('[WARN]\x20'+_0xa27de1,_0x566071),'info':(_0x5ed9c5,_0x1b8d8c)=>console['log']('[INFO]\x20'+_0x5ed9c5,_0x1b8d8c),'debug':(_0xe702f8,_0x2c3c73)=>console['log']('[DEBUG]\x20'+_0xe702f8,_0x2c3c73)};function z(){let _0x537dd8=globalThis['Deno'];if(!_0x537dd8)throw new Error('Deno is not available');return _0x537dd8;}var D=class{constructor(_0x16564e,_0x2e6e10='./lib',_0x1cf383={}){this['manifest']=_0x16564e,this['libDir']=_0x2e6e10,this['platformImports']=_0x1cf383;}['buildPerms'](){let _0x3745aa=this['manifest']['permissions']||{},_0x21aebb={};return _0x3745aa['net']!==void 0x0&&(_0x21aebb['net']=_0x3745aa['net']===!![]?!![]:Array['isArray'](_0x3745aa['net'])?_0x3745aa['net']:[]),_0x3745aa['read']!==void 0x0&&(_0x21aebb['read']=_0x3745aa['read']===!![]?!![]:Array['isArray'](_0x3745aa['read'])?_0x3745aa['read']:[]),_0x3745aa['write']!==void 0x0&&(_0x21aebb['write']=_0x3745aa['write']===!![]?!![]:Array['isArray'](_0x3745aa['write'])?_0x3745aa['write']:[]),_0x3745aa['env']!==void 0x0&&(_0x21aebb['env']=_0x3745aa['env']===!![]?!![]:Array['isArray'](_0x3745aa['env'])?_0x3745aa['env']:[]),_0x3745aa['run']!==void 0x0&&(_0x21aebb['run']=_0x3745aa['run']===!![]?!![]:Array['isArray'](_0x3745aa['run'])?_0x3745aa['run']:[]),_0x3745aa['ffi']!==void 0x0&&(_0x21aebb['ffi']=_0x3745aa['ffi']===!![]?!![]:Array['isArray'](_0x3745aa['ffi'])?_0x3745aa['ffi']:[]),_0x3745aa['sys']!==void 0x0&&(_0x21aebb['sys']=_0x3745aa['sys']===!![]?!![]:Array['isArray'](_0x3745aa['sys'])?_0x3745aa['sys']:[]),_0x3745aa['hrtime']!==void 0x0&&(_0x21aebb['hrtime']=_0x3745aa['hrtime']),_0x21aebb;}['normalize'](_0x155c94){return _0x155c94===!![]?[]:Array['isArray'](_0x155c94)?_0x155c94:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x5af569){return path.join(this['libDir'],_0x5af569+'@*');}['getReadPaths'](){let _0x4d397f=this['getImports']();_0x4d397f['includes']('*')&&(_0x4d397f=Object['keys'](this['platformImports']));let _0x109ccc=[];console['log']('[Permissions] Building package path patterns for imports:',_0x4d397f);for(let _0x19181b of _0x4d397f){let _0x15d1c1=this['getLibPattern'](_0x19181b);_0x109ccc['push'](_0x15d1c1),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x19181b+'\x20->\x20'+_0x15d1c1);}return console['log']('[Permissions] Final package path patterns:',_0x109ccc),_0x109ccc;}['buildImportMap'](_0x5c7177){let _0x22c1b9=this['getImports'](),_0x4510ec=_0x22c1b9['includes']('*')?Object['keys'](_0x5c7177):_0x22c1b9;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x4510ec);let _0x53d5c1={};for(let _0xa15e7a of _0x4510ec)if(_0x5c7177[_0xa15e7a])_0x53d5c1[_0xa15e7a]=_0x5c7177[_0xa15e7a],console['log']('[ImportMap]\x20'+_0xa15e7a+'\x20->\x20'+_0x5c7177[_0xa15e7a]+'\x20(from\x20platform)');else try{let _0x2956fa=z(),_0x55587c=path.join(_0x2956fa['cwd'](),this['libDir']),_0x51ed78=!0x1;try{for(let _0x31b5d3 of _0x2956fa['readDirSync'](_0x55587c))if(_0x31b5d3['isDirectory']&&(_0x31b5d3['name']===_0xa15e7a||_0x31b5d3['name']['startsWith'](_0xa15e7a+'@'))){let _0x4fa276=path.join(_0x2956fa['cwd'](),this['libDir'],_0x31b5d3['name'],'index.js')['replace'](/\\/g,'/'),_0x1144e7=new URL('file:///'+_0x4fa276)['href'];_0x53d5c1[_0xa15e7a]=_0x1144e7,console['log']('[ImportMap]\x20'+_0xa15e7a+'\x20->\x20'+_0x1144e7+'\x20(from\x20lib)'),_0x51ed78=!0x0;break;}}catch{}_0x51ed78||console['warn']('[ImportMap]\x20Package\x20'+_0xa15e7a+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x34b24c){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0xa15e7a+':',_0x34b24c);}return _0x53d5c1;}['validateServerImports'](_0x4888ff){let _0x36942b=this['manifest']['name']||this['manifest']['id'],_0x40787f=this['manifest']['metadata']?.['serverPath'],_0x42f259=_0x118e64=>_0x118e64['replace'](/\\/g,'/'),_0x28bf88=z(),_0x3fe8c1=_0x54b23d=>{try{return _0x28bf88['statSync'](_0x54b23d),!0x0;}catch{return![];}},_0x346952=_0x40787f?_0x42f259(_0x40787f):void 0x0;if(!_0x346952){let _0x285333=[_0x4888ff+'/service/server.js',_0x4888ff+'/service/server.ts',_0x4888ff+'/'+_0x36942b+'/server.js',_0x4888ff+'/'+_0x36942b+'/server.ts',_0x4888ff+'/server.js',_0x4888ff+'/server.ts']['map'](_0x42f259);for(let _0x2c23f8 of _0x285333)if(_0x3fe8c1(_0x2c23f8)){_0x346952=_0x2c23f8;break;}}if(!_0x346952)return{'valid':![],'violations':['Failed to locate server module']};let _0x27b25d='';try{_0x27b25d=_0x28bf88['readTextFileSync'](_0x346952);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x346952};}let _0x231238=this['getImports']();if(_0x231238['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x346952};let _0x72a75=_0x231238,_0x474d82=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x45d49b=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x11efcd=/\bimport\s*['"]([^'"]+)['"]/g,_0x2ba4ff=[],_0x4d9660=new Set(),_0x28f44a=_0xd8d00f=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0xd8d00f),_0x2d90c0=_0x2a032b=>{let _0x53407f=_0x2a032b;if(_0x53407f['startsWith']('./')||_0x53407f['startsWith']('../')||_0x53407f['startsWith']('/')||_0x53407f['startsWith']('file://')||!_0x28f44a(_0x2a032b)||_0x4d9660['has'](_0x2a032b))return;_0x4d9660['add'](_0x2a032b),_0x53407f['startsWith']('npm:')&&(_0x53407f=_0x53407f['substring'](0x4)),_0x53407f['includes']('@')&&!_0x53407f['startsWith']('@')&&(_0x53407f=_0x53407f['split']('@')[0x0]);let _0x3c7cee=_0x53407f['split']('/')[0x0];_0x72a75['includes'](_0x3c7cee)||_0x72a75['includes'](_0x2a032b)||_0x2ba4ff['push'](_0x2a032b);},_0x2864be;for(;(_0x2864be=_0x474d82['exec'](_0x27b25d))!==null;)_0x2d90c0(_0x2864be[0x1]);for(;(_0x2864be=_0x45d49b['exec'](_0x27b25d))!==null;)_0x2d90c0(_0x2864be[0x1]);for(;(_0x2864be=_0x11efcd['exec'](_0x27b25d))!==null;)_0x2d90c0(_0x2864be[0x1]);return{'valid':_0x2ba4ff['length']===0x0,'violations':_0x2ba4ff,'serverPath':_0x346952};}['validate'](_0x5cc221={}){let _0x58f03b=[],_0x590ac7=this['manifest']['permissions']||{};try{let _0x4d1549=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x4d1549);}catch{}let _0x163d1b=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x196691,_0x47656b]of Object['entries'](_0x590ac7))if(_0x196691==='hrtime')typeof _0x47656b!='boolean'&&_0x58f03b['push']('Permission\x20\x27'+_0x196691+'\x27\x20must\x20be\x20boolean');else{if(_0x196691==='langchain')typeof _0x47656b!='boolean'&&(typeof _0x47656b!='object'||_0x47656b===null)?_0x58f03b['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x47656b=='object'&&(_0x47656b===null||!('enabled'in _0x47656b)||typeof _0x47656b['enabled']!='boolean')&&_0x58f03b['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x196691==='kv')typeof _0x47656b!='boolean'&&_0x58f03b['push']('Permission\x20\x27'+_0x196691+'\x27\x20must\x20be\x20boolean');else{if(_0x196691==='mspbots')Array['isArray'](_0x47656b)||_0x58f03b['push']('Permission\x20\x27'+_0x196691+'\x27\x20must\x20be\x20an\x20array');else{if(_0x196691==='db'){if(typeof _0x47656b!='object'||_0x47656b===null||Array['isArray'](_0x47656b))_0x58f03b['push']('Permission\x20\x27'+_0x196691+'\x27\x20must\x20be\x20an\x20object');else{let _0x16d1de=_0x47656b,_0x23819f=['user','password']['filter'](_0x117ca1=>!(_0x117ca1 in _0x16d1de));_0x23819f['length']>0x0&&_0x58f03b['push']('Permission\x20\x27'+_0x196691+'\x27\x20missing\x20required\x20fields:\x20'+_0x23819f['join'](',\x20'));}}else{if(_0x196691==='imports')continue;_0x163d1b['has'](_0x196691)||typeof _0x47656b!='boolean'&&!Array['isArray'](_0x47656b)&&_0x58f03b['push']('Permission\x20\x27'+_0x196691+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x12bfc1=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x12bfc1))_0x58f03b['push']('permissions.imports must be an array');else{for(let _0xa1b236 of _0x12bfc1)typeof _0xa1b236!='string'&&_0x58f03b['push']('import\x20\x27'+_0xa1b236+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x58f03b['length']===0x0,'errors':_0x58f03b};}};function q(_0x15a1fc,_0x1fa1c2,_0x4e4543){return new D(_0x15a1fc,_0x1fa1c2,_0x4e4543||{});}var R=null;function I(){let _0x5e53b3=globalThis['Deno'];if(!_0x5e53b3)throw new Error('Deno is not available');return _0x5e53b3;}async function K(){if(R)return{...R};try{let _0x5e2988=I(),_0x589b32=path.join(_0x5e2988['cwd'](),'deno.json'),_0x574b91=await _0x5e2988['readTextFile'](_0x589b32);return R=JSON['parse'](_0x574b91)['imports']||{},{...R};}catch(_0x3b50c3){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x3b50c3),{};}}var E=class{constructor(_0x14bdaa,_0x514745={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x14bdaa['appsDir'],this['platformImportsOverride']=_0x14bdaa['platformImports'],this['libDir']=_0x14bdaa['libDir'],this['events']=_0x514745);}async['create'](_0x344db4,_0x108d34,_0x39d7b8){try{return await this['createWorker'](_0x344db4,_0x108d34,_0x39d7b8);}catch(_0x3f33f8){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x344db4+':',_0x3f33f8),_0x3f33f8;}}async['createWorker'](_0xcc8e1d,_0x21254d,_0x39d1fd){let _0x3dded6=this['platformImportsOverride']||await K(),_0x57deda=q(_0x21254d,this['libDir'],_0x3dded6)['validateServerImports'](this['appsDir']);if(!_0x57deda['valid']){let _0x5801d3=_0x57deda['violations']['filter'](_0x2d53b3=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x2d53b3)),_0xc24d97=_0x57deda['serverPath']?_0x57deda['serverPath']:(_0x21254d['name']||_0x21254d['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0xc24d97+':\x20'+_0x5801d3['join'](',\x20'));}let _0x3813d1=q(_0x21254d,this['libDir'],_0x3dded6),_0x1f6278=_0x3813d1['validate'](_0x3dded6);if(!_0x1f6278['valid'])throw new Error('Invalid\x20config:\x20'+_0x1f6278['errors']['join'](',\x20'));let _0x2adaa6=_0x3813d1['buildImportMap'](_0x3dded6);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0xcc8e1d+':',_0x2adaa6);let _0x4f46e0=_0x3813d1['buildPerms'](),_0x45dabe=_0x3813d1['getReadPaths']();if(_0x4f46e0['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x4f46e0['read']);else{let _0x2d85d5=_0x21254d['name']||_0xcc8e1d,_0x414b1a=this['appsDir']+'/'+_0x2d85d5,_0x34473f=[_0x414b1a],_0x58c88c=_0x21254d['metadata']?.['serverPath'];if(_0x58c88c&&typeof _0x58c88c=='string')try{let _0x4f8512=path.dirname(_0x58c88c)['replace'](/\\/g,'/');_0x34473f['push'](_0x4f8512);}catch{}_0x4f46e0['read']=_0x34473f,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x414b1a);}if(_0x45dabe['length']>0x0){if(_0x4f46e0['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x4684eb=Array['isArray'](_0x4f46e0['read'])?_0x4f46e0['read']:[];_0x4f46e0['read']=[..._0x4684eb,..._0x45dabe],console['log']('[Worker] Added package read permissions:',_0x45dabe);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x4f46e0['net']||(_0x4f46e0['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0xcc8e1d+':',_0x4f46e0['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x4f46e0['read']===!![]?'unrestricted':Array['isArray'](_0x4f46e0['read'])?_0x4f46e0['read']['length']:0x0));let _0x289cee=await this['createImportMap'](_0xcc8e1d,_0x2adaa6),_0x2fa548=await this['createLock'](_0xcc8e1d,_0x2adaa6),_0x5f21e3={'type':'module','deno':{'permissions':{}}};_0x5f21e3['deno']['namespace']=![],_0x5f21e3['deno']['permissions']=_0x4f46e0,_0x5f21e3['deno']['importMap']=_0x289cee,_0x5f21e3['deno']['lock']=_0x2fa548,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0xcc8e1d+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x289cee),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x2fa548),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x2adaa6)['length']+'\x20('+(Object['keys'](_0x2adaa6)['join'](',\x20')||'none')+')');let _0x569aa9={'worker':new Worker(_0x39d1fd,_0x5f21e3),'appId':_0xcc8e1d,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x21254d,'importMapPath':_0x289cee,'lockfilePath':_0x2fa548};return this['workers']['set'](_0xcc8e1d,_0x569aa9),this['events']['onCreate']?.(_0x569aa9),_0x569aa9;}async['createLock'](_0x3ad40e,_0x108d4f){let _0x19e94c=I(),_0x3c0bd9=path.join(_0x19e94c['cwd'](),'storage','temp','lockfiles');await _0x19e94c['mkdir'](_0x3c0bd9,{'recursive':!![]});let _0x3d653d=_0x3ad40e+'-'+Date['now']()+'.lock',_0x5312cb=path.join(_0x3c0bd9,_0x3d653d),_0x231594={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x3d7aeb,_0x5ed667]of Object['entries'](_0x108d4f))if(_0x5ed667['startsWith']('npm:'))_0x5ed667['replace']('npm:',''),_0x231594['packages']['specifiers'][_0x3d7aeb]=_0x5ed667;else _0x5ed667['startsWith']('file://')&&(_0x231594['packages']['specifiers'][_0x3d7aeb]=_0x5ed667);let _0x57ceab=JSON['stringify'](_0x231594,null,0x2);return await _0x19e94c['writeTextFile'](_0x5312cb,_0x57ceab),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x5312cb),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x108d4f)['length']+'):',Object['keys'](_0x108d4f)),_0x5312cb;}async['createImportMap'](_0x3fe574,_0x49a1d5){let _0x876b99=I(),_0x16ec02=path.join(_0x876b99['cwd'](),'storage','temp','importmaps');await _0x876b99['mkdir'](_0x16ec02,{'recursive':!![]});let _0x32d2ce=_0x3fe574+'-'+Date['now']()+'.json',_0x4942c2=path.join(_0x16ec02,_0x32d2ce),_0x154894=JSON['stringify']({'imports':_0x49a1d5,'scopes':{}},null,0x2);return await _0x876b99['writeTextFile'](_0x4942c2,_0x154894),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x4942c2),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x49a1d5)['length']+'):',Object['keys'](_0x49a1d5)['join'](',\x20')||'none'),_0x4942c2;}['get'](_0xf10ff9){return this['workers']['get'](_0xf10ff9);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x2da423,_0x2e4d2c){let _0x103c37=this['workers']['get'](_0x2da423);if(!_0x103c37)return;let _0x173446=_0x103c37['status'];_0x103c37['status']=_0x2e4d2c,_0x2e4d2c==='running'&&_0x173446==='starting'?this['events']['onReady']?.(_0x103c37):_0x2e4d2c==='crashed'&&this['events']['onCrash']?.(_0x103c37);}['touch'](_0x14dc81){let _0x14e01f=this['workers']['get'](_0x14dc81);_0x14e01f&&(_0x14e01f['lastUsed']=Date['now']());}async['stop'](_0x21f0a8){let _0x227690=this['workers']['get'](_0x21f0a8);if(_0x227690)try{_0x227690['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x227690['worker']['terminate'](),_0x227690['status']='stopped',this['events']['onStop']?.(_0x227690),_0x227690['importMapPath']&&await this['cleanupImportMap'](_0x227690['importMapPath']),_0x227690['lockfilePath']&&await this['cleanupLock'](_0x227690['lockfilePath']);}catch(_0x5dbe8f){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x21f0a8+':',_0x5dbe8f);}finally{this['workers']['delete'](_0x21f0a8);}}async['cleanupImportMap'](_0x4c7891){try{await I()['remove'](_0x4c7891),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x4c7891);}catch(_0x69bc3){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x4c7891,_0x69bc3);}}async['cleanupLock'](_0x3da981){try{await I()['remove'](_0x3da981),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x3da981);}catch(_0xd1e3ca){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x3da981,_0xd1e3ca);}}async['stopAll'](){let _0x507e27=Array['from'](this['workers']['keys']());await Promise['all'](_0x507e27['map'](_0x1d7397=>this['stop'](_0x1d7397)));}async['restart'](_0x2eb00b,_0x322880){let _0x7d8246=this['workers']['get'](_0x2eb00b);if(!_0x7d8246)throw new Error('Worker\x20'+_0x2eb00b+'\x20not\x20found');let _0x4efaa8=_0x7d8246['manifest'];return await this['stop'](_0x2eb00b),await this['create'](_0x2eb00b,_0x4efaa8,_0x322880);}['checkHealth'](_0xad7360){let _0xbff85a=this['workers']['get'](_0xad7360);if(!_0xbff85a)return{'healthy':![],'reason':'Not\x20found'};if(_0xbff85a['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0xbff85a['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x26d682=Date['now']()-_0xbff85a['lastUsed'],_0x571ef3=0x708*0x3e8;return _0x26d682>_0x571ef3?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x26d682/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x1c3dc8=0x708*0x3e8,_0x457c9d){let _0x423be4=Date['now'](),_0x4a4497=[];for(let [_0x56cbec,_0x572ee4]of this['workers']['entries']()){let _0x3e0ca9=_0x423be4-_0x572ee4['lastUsed'];_0x3e0ca9>_0x1c3dc8&&_0x4a4497['push']({'appId':_0x56cbec,'idle':_0x3e0ca9});}_0x4a4497['sort']((_0x3b3425,_0x6f7801)=>_0x6f7801['idle']-_0x3b3425['idle']);let _0x3ec8c8=_0x457c9d?_0x4a4497['slice'](0x0,_0x457c9d)['map'](_0x3429b1=>_0x3429b1['appId']):_0x4a4497['map'](_0x16e879=>_0x16e879['appId']);for(let _0x12aee0 of _0x3ec8c8)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x12aee0),await this['stop'](_0x12aee0);}['stats'](){let _0x217776={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x479cde=Date['now']();for(let _0x15a0a3 of this['workers']['values']())_0x217776['byStatus'][_0x15a0a3['status']]++,_0x217776['workers']['push']({'appId':_0x15a0a3['appId'],'status':_0x15a0a3['status'],'version':_0x15a0a3['version'],'lastUsed':_0x15a0a3['lastUsed'],'idle':_0x479cde-_0x15a0a3['lastUsed']});return _0x217776;}['startCleanup'](_0x4b2a94=0x12c*0x3e8,_0x521103){let _0x211200=setInterval(()=>{this['cleanup'](_0x521103)['catch'](_0x32556a=>{console['error']('Cleanup\x20failed:',_0x32556a);});},_0x4b2a94);return()=>clearInterval(_0x211200);}['delay'](_0x428d78){return new Promise(_0x224e94=>setTimeout(_0x224e94,_0x428d78));}};function W(_0x5083ae,_0x48d048){return new E(_0x5083ae,_0x48d048);}var v=f,j=class{constructor(_0x27ea1c,_0x187b1c=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x27ea1c,this['timeout']=_0x187b1c);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x45bf64){_0x45bf64['worker']['onmessage']=_0x19857a=>{let _0x26209e=_0x19857a['data'],{appId:_0x56a987}=_0x45bf64;switch(_0x26209e['type']){case'ready':this['events']['onReady'](_0x56a987),v['info']('Worker\x20ready',{'appId':_0x56a987,'version':_0x45bf64['version']});break;case'log':{let {level:_0x12b5bc='info',message:_0x2efb91,meta:_0xebd38}=_0x26209e,_0x3e0ccc={..._0xebd38||{},'appId':_0x56a987,'version':_0x45bf64['version']};this['events']['onLog'](_0x56a987,_0x12b5bc,_0x2efb91,_0x3e0ccc);break;}case'result':{let {reqId:_0x1787ab,ok:_0x5cf3ec,response:_0x577938,error:_0x431539}=_0x26209e,_0x1ad629=this['pending']['get'](_0x1787ab);if(!_0x1ad629){v['warn']('Unknown\x20request',{'appId':_0x56a987,'reqId':_0x1787ab});return;}if(this['pending']['delete'](_0x1787ab),_0x5cf3ec&&_0x577938)_0x1ad629['resolve'](_0x577938);else{let _0x53c4b4=new Error(_0x431539?.['message']||'Worker\x20error');_0x53c4b4['stack']=_0x431539?.['stack'],_0x1ad629['reject'](_0x53c4b4);}this['events']['onResult'](_0x56a987,_0x1787ab,_0x577938||_0x431539);break;}default:v['debug']('Unknown\x20message',{'appId':_0x56a987,'type':_0x26209e['type']});}},_0x45bf64['worker']['onerror']=_0x343d65=>{let {appId:_0x2b9362}=_0x45bf64;v['error']('Worker\x20error',{'appId':_0x2b9362,'message':_0x343d65['message'],'lineno':_0x343d65['lineno'],'filename':_0x343d65['filename']}),_0x45bf64['status']='crashed',this['rejectPending'](_0x2b9362,new Error('Worker\x20'+_0x2b9362+'\x20crashed:\x20'+_0x343d65['message'])),_0x343d65['preventDefault']();},_0x45bf64['worker']['onmessageerror']=_0x349483=>{let {appId:_0x5a4706}=_0x45bf64;v['error']('Message\x20error',{'appId':_0x5a4706,'data':_0x349483['data']}),_0x45bf64['status']='crashed',_0x349483['preventDefault']();};}['sendInit'](_0x2aede0,_0x21b31d,_0x24ed41,_0x58680a){_0x2aede0['worker']['postMessage']({'type':'init','appId':_0x2aede0['appId'],'manifest':_0x24ed41,'appsDir':_0x21b31d,'serverPath':_0x58680a});}async['sendInvoke'](_0x37b91d,_0x570247){let _0x32b06c=this['nextId'](),_0x101319=_0x37b91d['appId'],_0x3f504f=new Promise((_0x436683,_0x2d79e4)=>{let _0x5b1396=setTimeout(()=>{this['pending']['delete'](_0x32b06c),_0x2d79e4(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x32b06c,{'resolve':_0xdad43a=>{clearTimeout(_0x5b1396),_0x436683(_0xdad43a);},'reject':_0x33f4c0=>{clearTimeout(_0x5b1396),_0x2d79e4(_0x33f4c0);},'timestamp':Date['now'](),'appId':_0x101319});});return _0x37b91d['worker']['postMessage']({'type':'invoke','appId':_0x37b91d['appId'],'reqId':_0x32b06c,'payload':_0x570247}),await _0x3f504f;}['rejectPending'](_0x2bb5fd,_0x22c1be){let _0x4e25f8=0x0;for(let [_0x4089fb,_0x51bc29]of this['pending']['entries']())_0x51bc29['appId']===_0x2bb5fd&&(this['pending']['delete'](_0x4089fb),_0x51bc29['reject'](_0x22c1be),_0x4e25f8++);_0x4e25f8>0x0&&v['warn']('Rejected\x20'+_0x4e25f8+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x2bb5fd});}['cleanupTimeout'](){let _0x16db69=Date['now']();for(let [_0x20420b,_0x4603a8]of this['pending']['entries']())_0x16db69-_0x4603a8['timestamp']>this['timeout']&&(this['pending']['delete'](_0x20420b),_0x4603a8['reject'](new Error('Request\x20'+_0x20420b+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x13964a){let _0x5e9101=0x0;for(let _0x15fa44 of this['pending']['values']())_0x15fa44['appId']===_0x13964a&&_0x5e9101++;return _0x5e9101;}['startCleanup'](_0x4f48c3=0x2710){let _0x2db7df=setInterval(()=>{this['cleanupTimeout']();},_0x4f48c3);return()=>clearInterval(_0x2db7df);}};function $(_0x4ec67a,_0x3cdd0d){return new j(_0x4ec67a,_0x3cdd0d);}var Q=class{constructor(_0x1d3b81={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x1d3b81['logger']||f,this['config']={'appsDir':_0x1d3b81['appsDir']||this['getAppsDir'](),'scriptUrl':_0x1d3b81['scriptUrl']||this['getScriptUrl'](),'timeout':_0x1d3b81['timeout']||0x78*0x3e8,'autoCleanup':_0x1d3b81['autoCleanup']??!![],'cleanupInterval':_0x1d3b81['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x1d3b81['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x1d3b81['maxWorkers'],'reuseWorkers':_0x1d3b81['reuseWorkers']??!![],'workerReuseStrategy':_0x1d3b81['workerReuseStrategy']||'lru','enableQueue':_0x1d3b81['enableQueue']??!![],'maxQueueSize':_0x1d3b81['maxQueueSize']||0x64,'queueTimeout':_0x1d3b81['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x4b4b1c=>this['logger']['info']('Worker\x20created',{'appId':_0x4b4b1c['appId'],'v':_0x4b4b1c['version']}),'onReady':_0x17dbd7=>this['lifecycle']['updateStatus'](_0x17dbd7['appId'],'running'),'onCrash':_0x3129af=>this['logger']['error']('Worker\x20crashed',{'appId':_0x3129af['appId'],'v':_0x3129af['version']}),'onStop':_0x32165f=>this['logger']['info']('Worker\x20stopped',{'appId':_0x32165f['appId'],'v':_0x32165f['version']})}),this['messaging']=$({'onReady':_0x569c2a=>this['lifecycle']['updateStatus'](_0x569c2a,'running'),'onLog':(_0x28fc87,_0x407454,_0x170ecd,_0x3052aa)=>{let _0x110080={..._0x3052aa||{},'appId':_0x28fc87};switch(_0x407454){case'error':this['logger']['error'](_0x170ecd,_0x110080);break;case'warn':this['logger']['warn'](_0x170ecd,_0x110080);break;case'debug':this['logger']['debug'](_0x170ecd,_0x110080);break;default:this['logger']['info'](_0x170ecd,_0x110080);break;}},'onResult':(_0x484ad5,_0x3b9c36,_0x39cf02)=>{this['logger']['debug']('Result\x20received',{'appId':_0x484ad5,'reqId':_0x3b9c36});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x325872=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0xee67ce=_0x325872['endsWith']('.js')||_0x325872['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0xee67ce,_0x325872)['href'];}async['ensure'](_0x229bb1){let {id:_0x54c179}=_0x229bb1,_0x2bbef2=this['lifecycle']['get'](_0x54c179);if(_0x2bbef2){let _0x36b36b=this['lifecycle']['checkHealth'](_0x54c179);if(_0x36b36b['healthy'])return this['lifecycle']['touch'](_0x54c179),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x54c179}),_0x2bbef2;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x54c179,'reason':_0x36b36b['reason']}),await this['lifecycle']['stop'](_0x54c179);}for(;;){let _0x52dbaf=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x52dbaf>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x52dbaf,'max':this['config']['maxWorkers'],'appId':_0x54c179}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x229bb1);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x53cb3c=await this['loadManifest'](_0x54c179,_0x229bb1['manifest']),_0x46739b=await this['lifecycle']['create'](_0x54c179,_0x53cb3c,this['config']['scriptUrl']),_0x41d9fa=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x41d9fa>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x41d9fa,'max':this['config']['maxWorkers'],'appId':_0x54c179}),await this['lifecycle']['stop'](_0x54c179),this['config']['enableQueue'])return await this['waitSlot'](_0x229bb1);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x41d9fa+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x46739b);let _0x41d83d=_0x53cb3c['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x46739b,this['config']['appsDir'],_0x53cb3c,_0x41d83d),this['logger']['info']('Worker\x20created',{'appId':_0x54c179,'v':_0x46739b['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x46739b;}async['evictIdle'](){let _0x23692d=this['lifecycle']['getAll']();if(_0x23692d['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x518328=[..._0x23692d];this['config']['workerReuseStrategy']==='lru'?_0x518328['sort']((_0x157299,_0xaafe32)=>_0x157299['lastUsed']-_0xaafe32['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x518328['sort']((_0x2f7319,_0x11f0e5)=>_0x2f7319['version']-_0x11f0e5['version']);let _0x3c1843=null;for(let _0x40f7b6 of _0x518328)if(this['messaging']['getAppCount'](_0x40f7b6['appId'])===0x0){_0x3c1843=_0x40f7b6;break;}if(!_0x3c1843&&_0x518328['length']>0x0&&(_0x3c1843=_0x518328['reduce']((_0x26e02d,_0x1dd862)=>{let _0x16785d=this['messaging']['getAppCount'](_0x26e02d['appId']);return this['messaging']['getAppCount'](_0x1dd862['appId'])<_0x16785d?_0x1dd862:_0x26e02d;})),_0x3c1843){let _0x1137ba=this['messaging']['getAppCount'](_0x3c1843['appId']);return _0x1137ba>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x3c1843['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x3c1843['lastUsed'],'pendingRequests':_0x1137ba}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x3c1843['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x3c1843['lastUsed']}),await this['lifecycle']['stop'](_0x3c1843['appId']),!![];}return![];}['waitSlot'](_0x83e551){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x414471,_0x35b7a1)=>{let _0xcb90f5={'info':_0x83e551,'resolve':_0x414471,'reject':_0x35b7a1,'timestamp':Date['now']()};this['requestQueue']['push'](_0xcb90f5),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x83e551['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x1cb332=setTimeout(()=>{let _0x3a65a0=this['requestQueue']['indexOf'](_0xcb90f5);_0x3a65a0!==-0x1&&(this['requestQueue']['splice'](_0x3a65a0,0x1),_0x35b7a1(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0xcb90f5['resolve']=_0x3ce222=>{clearTimeout(_0x1cb332),_0x414471(_0x3ce222);},_0xcb90f5['reject']=_0x3e14e1=>{clearTimeout(_0x1cb332),_0x35b7a1(_0x3e14e1);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0xc21ac5=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0xc21ac5>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x40e97a=this['requestQueue']['shift']();if(!_0x40e97a)break;try{let _0x473fe2=await this['ensure'](_0x40e97a['info']);_0x40e97a['resolve'](_0x473fe2);}catch(_0x19c8f8){_0x40e97a['reject'](_0x19c8f8);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x597f39,_0x3bdf02){let _0xcb2682=this['config']['appsDir']['replace'](/\\/g,'/'),_0x1bd113=async _0x165001=>{try{let _0x16f376=globalThis['Deno'];if(!_0x16f376)return null;let _0x4b1dd4=await _0x16f376['readTextFile'](_0x165001);return JSON['parse'](_0x4b1dd4);}catch{return null;}};if(_0x3bdf02?.['name']){let _0x106a10=await _0x1bd113(_0xcb2682+'/'+_0x3bdf02['name']+'/manifest.json');if(_0x106a10)return _0x106a10;}let _0xee08a7=await _0x1bd113(_0xcb2682+'/'+_0x597f39+'/manifest.json');if(_0xee08a7)return _0xee08a7;try{let _0x2aa5cf=globalThis['Deno'];if(_0x2aa5cf)for await(let _0x24c632 of _0x2aa5cf['readDir'](_0xcb2682)){if(!_0x24c632['isDirectory'])continue;let _0x43c9a1=_0xcb2682+'/'+_0x24c632['name']+'/manifest.json',_0x29f9fc=await _0x1bd113(_0x43c9a1);if(_0x29f9fc&&(_0x29f9fc['id']===_0x597f39||_0x3bdf02?.['name']&&_0x29f9fc['name']===_0x3bdf02['name']))return _0x29f9fc;}}catch(_0x2facc5){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x597f39,'error':_0x2facc5['message']});}return _0x3bdf02||{'id':_0x597f39,'name':_0x597f39,'version':'1.0.0'};}async['invoke'](_0x544634){let _0x1a2a0c=_0x544634['ctx']['app']['id'],_0x2efca6=_0x544634['ctx']['app']['name'];try{let _0xa723d0={'id':_0x1a2a0c,'manifest':{'id':_0x1a2a0c,'name':_0x2efca6}},_0x30e485=await this['ensure'](_0xa723d0);if(_0x30e485['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x1a2a0c}),await this['restart'](_0x1a2a0c);let _0x4644f1=await this['ensure'](_0xa723d0);return this['lifecycle']['touch'](_0x1a2a0c),await this['messaging']['sendInvoke'](_0x4644f1,_0x544634);}return this['lifecycle']['touch'](_0x1a2a0c),await this['messaging']['sendInvoke'](_0x30e485,_0x544634);}catch(_0x41a93e){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x1a2a0c,'error':_0x41a93e['message'],'stack':_0x41a93e['stack']}),_0x41a93e;}}async['stop'](_0x3565a4){await this['lifecycle']['stop'](_0x3565a4),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x159d72){return await this['lifecycle']['restart'](_0x159d72,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x1a2cbe=>({'appId':_0x1a2cbe['appId'],'status':_0x1a2cbe['status'],'version':_0x1a2cbe['version'],'lastUsed':_0x1a2cbe['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x53f052=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x5972c5=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x53f052(),_0x5972c5();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x59fe00=>{_0x59fe00?(await this['stop'](_0x59fe00),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x59fe00})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0xa5b680){return new Q(_0xa5b680);}var S=null;function be(_0x1acdf0){S=ee(_0x1acdf0);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x413cea){return await k()['ensure'](_0x413cea);}async function xe(_0x14a9d4){return await k()['invoke'](_0x14a9d4);}function Ie(_0x120339){k()['stop'](_0x120339)['catch'](_0x3b716b=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x120339,'error':_0x3b716b['message']});});}function Re(){k()['stopAll']()['catch'](_0x38016d=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x38016d['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x39c720){await k()['stop'](_0x39c720);}async function Se(){await k()['stopAll']();}function Ae(_0x3688c7){let _0x456ade=_0x3688c7&&typeof _0x3688c7=='object'?_0x3688c7:null;if(_0x456ade&&'user'in _0x456ade)return _0x456ade['user'];}function H(_0x375656){let _0x49affa=_0x375656&&typeof _0x375656=='object'?_0x375656:null;if(!_0x49affa)return{};let _0x33f32d={};for(let [_0x1c3681,_0x2d05d0]of Object['entries'](_0x49affa))_0x1c3681!=='user'&&(_0x33f32d[_0x1c3681]=_0x2d05d0);return _0x33f32d;}function O(_0x3f12b0){return _0x3f12b0?{'id':_0x3f12b0['manifest']?.['id']||_0x3f12b0['id']||'','name':_0x3f12b0['manifest']?.['name']||'','version':_0x3f12b0['manifest']?.['version']||'','description':_0x3f12b0['manifest']?.['description']||'','icon':_0x3f12b0['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x150fe0){return _0x150fe0?.['permissions']||_0x150fe0?.['manifest']?.['permissions']||{};}function F(_0x489f2c){return _0x489f2c?.['manifest']?.['metadata']||{};}function Ce(_0x19be0e){return _0x19be0e?{'appId':_0x19be0e['id'],'appName':_0x19be0e['manifest']?.['name']}:{};}function N(_0x39876d,_0x54c689={}){let {appInfo:_0x1cbde1=null,status:_0x171cfc=0x1f4,defaultMessage:_0x453d58='Internal\x20Server\x20Error'}=_0x54c689,_0x51aa16={'error':_0x453d58,'message':_0x39876d?.['message']||_0x453d58};return _0x1cbde1&&(_0x51aa16['appId']=_0x1cbde1['id'],_0x51aa16['appName']=_0x1cbde1['manifest']?.['name']),_0x39876d?.['message']?.['includes']('crashed')&&(_0x51aa16['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x171cfc,'body':_0x51aa16};}function qe(_0x2c91c9){return _0x2c91c9?.['message']?.['includes']('crashed')||![];}function J(_0x20ae34){if(_0x20ae34)try{return JSON['parse'](_0x20ae34);}catch{return _0x20ae34;}}function B(_0x2c24cb){try{let _0x20c490=new URL(_0x2c24cb),_0x5e77bf={};for(let _0x378157 of _0x20c490['searchParams']['keys']()){let _0x5a5cd4=_0x20c490['searchParams']['getAll'](_0x378157)['map'](_0x5ca94a=>_0x5ca94a);_0x5a5cd4['length']<=0x1?_0x5e77bf[_0x378157]=_0x5a5cd4[0x0]??'':_0x5e77bf[_0x378157]=_0x5a5cd4;}return _0x5e77bf;}catch{return{};}}function Le(_0x52e61f){return(()=>{try{return new URL(_0x52e61f)['pathname'];}catch{return _0x52e61f;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x243aec,_0x229688){let _0x53eb81=_0x243aec;if(_0x229688&&_0x53eb81['startsWith']('/apps/'+_0x229688))_0x53eb81=_0x53eb81['substring'](('/apps/'+_0x229688)['length'])||'/';else{let _0x4b0369=_0x53eb81['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x4b0369&&(_0x53eb81=_0x4b0369[0x1]||'/');}return _0x53eb81['startsWith']('/api')&&(_0x53eb81=_0x53eb81['substring'](0x4)||'/'),_0x53eb81;}function Ue(_0x4fb320,_0x794a11){let _0x180556=_0x4fb320;if(_0x794a11&&_0x180556['startsWith']('/apps/'+_0x794a11))_0x180556=_0x180556['substring'](('/apps/'+_0x794a11)['length'])||'/';else{let _0x22de27=_0x180556['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x22de27&&(_0x180556=_0x22de27[0x1]||'/');}return(!_0x180556||_0x180556==='/')&&(_0x180556='/index.html'),_0x180556;}async function He(_0x29e9c1,_0x35b405){return await _0x35b405(_0x29e9c1);}function _(_0x40c97b){return _0x40c97b['split']('/')['filter'](_0xc59869=>_0xc59869['length']>0x0);}function te(_0x26e2b6){try{return decodeURIComponent(_0x26e2b6);}catch{return _0x26e2b6;}}function re(_0x1ea85e,_0x3a7a0d){let _0x285ab9=_(_0x1ea85e),_0xfaa1cd=_(_0x3a7a0d),_0x28a4c5={},_0x30dbc3=0x0,_0x1ed0dc=0x0;for(;_0x30dbc3<_0x285ab9['length']&&_0x1ed0dc<_0xfaa1cd['length'];){let _0x41a55a=_0x285ab9[_0x30dbc3],_0x1c7607=_0xfaa1cd[_0x1ed0dc];if(_0x41a55a==='*')break;if(_0x41a55a['startsWith'](':')){let _0x13704a=_0x41a55a['slice'](0x1);_0x13704a&&(_0x28a4c5[_0x13704a]=te(_0x1c7607)),_0x30dbc3++,_0x1ed0dc++;continue;}if(_0x41a55a!==_0x1c7607)return{};_0x30dbc3++,_0x1ed0dc++;}return _0x30dbc3===_0x285ab9['length']||_0x30dbc3===_0x285ab9['length']-0x1&&_0x285ab9[_0x30dbc3]==='*',_0x28a4c5;}async function Oe(_0xfe01c4,_0x3f8adc,_0x3a6889,_0x364de0,_0x2bef06=void 0x0,_0x36d4c2){let _0x3179de=await _0x3f8adc['text'](),_0x3d7d32=J(_0x3179de),_0x5cdf40=B(_0x3f8adc['url']),_0x158d67={...F(_0xfe01c4),'user':_0x2bef06},_0x3db847=H(_0x158d67),_0x5a9509=_0x36d4c2?re(_0x36d4c2,_0x3f8adc['path']):{};return{'app':O(_0xfe01c4),'permissions':T(_0xfe01c4),'user':_0x2bef06,'metadata':_0x3db847,'body':_0x3d7d32,'query':_0x5cdf40,'params':_0x5a9509,'method':_0x3a6889,'pathname':_0x364de0,'requestUrl':_0x3f8adc['url'],'headers':Object['fromEntries'](_0x3f8adc['raw']['headers']['entries']())};}function Te(_0x2c95cf){return{'method':_0x2c95cf['method'],'pathname':_0x2c95cf['pathname'],'ctx':_0x2c95cf};}function Fe(_0x4d1c9e,_0x96d61){let {status:_0x27ec56=0xc8,headers:_0x438e48={},body:_0x5ba984,type:_0x359ceb}=_0x4d1c9e??{};return _0x359ceb==='raw'?new globalThis['Response'](String(_0x5ba984??''),{'status':_0x27ec56,'headers':_0x438e48}):_0x96d61(_0x5ba984,_0x27ec56);}function Ne(_0x380066,_0x1cf863=null){return N(_0x380066,{'appInfo':_0x1cf863});}var V=f;async function Ve(_0x57e3ba){_0x57e3ba?(await U(_0x57e3ba),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x57e3ba)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x586da9,_0x4db330){let _0x6af5bd=Object['fromEntries'](Object['entries'](_0x586da9['headers']||{})['map'](([_0x576d1a,_0x18439a])=>[_0x576d1a['toLowerCase'](),_0x18439a]));return{'id':_0x586da9['app']['id']||_0x4db330['appId']||'','name':_0x586da9['app']['name']||'','version':_0x586da9['app']['version']||'','description':_0x586da9['app']['description']||'','metadata':{..._0x586da9['metadata'],'permissions':_0x586da9['permissions']},'body':_0x586da9['body'],'query':_0x586da9['query'],'params':_0x586da9?.['params'],'method':_0x586da9['method'],'pathname':_0x586da9['pathname'],'requestUrl':_0x586da9['requestUrl'],'user':_0x586da9['user'],'headers':_0x6af5bd};}var L=class{constructor(_0xbebb89){this['handle']=null,(this['config']=_0xbebb89,this['logger']=_0xbebb89['logger']||f,this['lifecycle']=W({'appsDir':_0xbebb89['appsDir'],'timeout':_0xbebb89['timeout'],'platformImports':_0xbebb89['platformImports'],'libDir':_0xbebb89['libDir']},{'onCreate':_0x55c508=>this['logger']['info']('Worker\x20created',{'appId':_0x55c508['appId']}),'onReady':_0x28f802=>{this['lifecycle']['updateStatus'](_0x28f802['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x28f802['appId']});},'onCrash':_0x393f87=>this['logger']['error']('Worker\x20crashed',{'appId':_0x393f87['appId']}),'onStop':_0x49a5a0=>this['logger']['info']('Worker\x20stopped',{'appId':_0x49a5a0['appId']})}),this['messaging']=$({'onReady':_0x4fc6fd=>this['lifecycle']['updateStatus'](_0x4fc6fd,'running'),'onLog':(_0x1b57fd,_0x69c3c,_0x45e196,_0x2de05d)=>{(this['logger'][_0x69c3c]||this['logger']['info'])['call'](this['logger'],_0x45e196,_0x2de05d);},'onResult':()=>{}},_0xbebb89['timeout']||0x1d4c0));}async['create'](_0xfe0a75){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x51a597=await this['lifecycle']['create'](this['config']['appId'],_0xfe0a75,this['config']['scriptUrl']);this['messaging']['setup'](_0x51a597),this['messaging']['sendInit'](_0x51a597,this['config']['appsDir'],_0xfe0a75,this['config']['serverPath']),this['handle']=_0x51a597,await this['waitForReady']();}async['waitForReady'](_0x5364a0=0x2710){let _0x122093=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x122093>_0x5364a0)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x230e96=>setTimeout(_0x230e96,0x64));}}async['invoke'](_0x584606){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x584606);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x2a2ba3){return new L(_0x2a2ba3);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;