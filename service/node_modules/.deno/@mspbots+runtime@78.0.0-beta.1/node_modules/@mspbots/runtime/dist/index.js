import{join,dirname}from'path';import _0xa5764c from'process';import{stat}from'fs/promises';async function ie(_0x48ba1f){try{return await stat(_0x48ba1f),!0x0;}catch{return![];}}var f={'error':(_0x2fef39,_0x450473)=>console['error']('[ERROR]\x20'+_0x2fef39,_0x450473),'warn':(_0x4cd016,_0x136bee)=>console['warn']('[WARN]\x20'+_0x4cd016,_0x136bee),'info':(_0x420bb0,_0xc7046a)=>console['log']('[INFO]\x20'+_0x420bb0,_0xc7046a),'debug':(_0x245d80,_0x1f9f51)=>console['log']('[DEBUG]\x20'+_0x245d80,_0x1f9f51)};function z(){let _0x791a11=globalThis['Deno'];if(!_0x791a11)throw new Error('Deno is not available');return _0x791a11;}var D=class{constructor(_0x1f2a04,_0x3964b4='./lib',_0x5b7d2a={}){this['manifest']=_0x1f2a04,this['libDir']=_0x3964b4,this['platformImports']=_0x5b7d2a;}['buildPerms'](){let _0x151db8=this['manifest']['permissions']||{},_0x4b78b6={};return _0x151db8['net']!==void 0x0&&(_0x4b78b6['net']=_0x151db8['net']===!![]?!![]:Array['isArray'](_0x151db8['net'])?_0x151db8['net']:[]),_0x151db8['read']!==void 0x0&&(_0x4b78b6['read']=_0x151db8['read']===!![]?!![]:Array['isArray'](_0x151db8['read'])?_0x151db8['read']:[]),_0x151db8['write']!==void 0x0&&(_0x4b78b6['write']=_0x151db8['write']===!![]?!![]:Array['isArray'](_0x151db8['write'])?_0x151db8['write']:[]),_0x151db8['env']!==void 0x0&&(_0x4b78b6['env']=_0x151db8['env']===!![]?!![]:Array['isArray'](_0x151db8['env'])?_0x151db8['env']:[]),_0x151db8['run']!==void 0x0&&(_0x4b78b6['run']=_0x151db8['run']===!![]?!![]:Array['isArray'](_0x151db8['run'])?_0x151db8['run']:[]),_0x151db8['ffi']!==void 0x0&&(_0x4b78b6['ffi']=_0x151db8['ffi']===!![]?!![]:Array['isArray'](_0x151db8['ffi'])?_0x151db8['ffi']:[]),_0x151db8['sys']!==void 0x0&&(_0x4b78b6['sys']=_0x151db8['sys']===!![]?!![]:Array['isArray'](_0x151db8['sys'])?_0x151db8['sys']:[]),_0x151db8['hrtime']!==void 0x0&&(_0x4b78b6['hrtime']=_0x151db8['hrtime']),_0x4b78b6;}['normalize'](_0x37bf40){return _0x37bf40===!![]?[]:Array['isArray'](_0x37bf40)?_0x37bf40:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x471e73){return join(this['libDir'],_0x471e73+'@*');}['getReadPaths'](){let _0x43fdb5=this['getImports']();_0x43fdb5['includes']('*')&&(_0x43fdb5=Object['keys'](this['platformImports']));let _0x114870=[];console['log']('[Permissions] Building package path patterns for imports:',_0x43fdb5);for(let _0x515542 of _0x43fdb5){let _0x5310f8=this['getLibPattern'](_0x515542);_0x114870['push'](_0x5310f8),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x515542+'\x20->\x20'+_0x5310f8);}return console['log']('[Permissions] Final package path patterns:',_0x114870),_0x114870;}['buildImportMap'](_0x38a43f){let _0x1f6f45=this['getImports'](),_0x2ab2ba=_0x1f6f45['includes']('*')?Object['keys'](_0x38a43f):_0x1f6f45;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x2ab2ba);let _0x55a862={};for(let _0x423b87 of _0x2ab2ba)if(_0x38a43f[_0x423b87])_0x55a862[_0x423b87]=_0x38a43f[_0x423b87],console['log']('[ImportMap]\x20'+_0x423b87+'\x20->\x20'+_0x38a43f[_0x423b87]+'\x20(from\x20platform)');else try{let _0x58cd59=z(),_0x413cd1=join(_0x58cd59['cwd'](),this['libDir']),_0x3c38ed=!0x1;try{for(let _0x465779 of _0x58cd59['readDirSync'](_0x413cd1))if(_0x465779['isDirectory']&&(_0x465779['name']===_0x423b87||_0x465779['name']['startsWith'](_0x423b87+'@'))){let _0x2535d1=join(_0x58cd59['cwd'](),this['libDir'],_0x465779['name'],'index.js')['replace'](/\\/g,'/'),_0xa26a61=new URL('file:///'+_0x2535d1)['href'];_0x55a862[_0x423b87]=_0xa26a61,console['log']('[ImportMap]\x20'+_0x423b87+'\x20->\x20'+_0xa26a61+'\x20(from\x20lib)'),_0x3c38ed=!0x0;break;}}catch{}_0x3c38ed||console['warn']('[ImportMap]\x20Package\x20'+_0x423b87+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x2e703c){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x423b87+':',_0x2e703c);}return _0x55a862;}['validateServerImports'](_0xf4ceaf){let _0x58b0a6=this['manifest']['name']||this['manifest']['id'],_0x5d28ba=this['manifest']['metadata']?.['serverPath'],_0x5de05e=_0x46ffdb=>_0x46ffdb['replace'](/\\/g,'/'),_0x5b77c0=z(),_0xd71fc8=_0x303226=>{try{return _0x5b77c0['statSync'](_0x303226),!0x0;}catch{return![];}},_0x142a1c=_0x5d28ba?_0x5de05e(_0x5d28ba):void 0x0;if(!_0x142a1c){let _0x2b532c=[_0xf4ceaf+'/service/server.js',_0xf4ceaf+'/service/server.ts',_0xf4ceaf+'/'+_0x58b0a6+'/server.js',_0xf4ceaf+'/'+_0x58b0a6+'/server.ts',_0xf4ceaf+'/server.js',_0xf4ceaf+'/server.ts']['map'](_0x5de05e);for(let _0x38db89 of _0x2b532c)if(_0xd71fc8(_0x38db89)){_0x142a1c=_0x38db89;break;}}if(!_0x142a1c)return{'valid':![],'violations':['Failed to locate server module']};let _0x5aeb3b='';try{_0x5aeb3b=_0x5b77c0['readTextFileSync'](_0x142a1c);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x142a1c};}let _0x547357=this['getImports']();if(_0x547357['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x142a1c};let _0x31eec2=_0x547357,_0x51bed6=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x5cd7e2=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x13e60d=/\bimport\s*['"]([^'"]+)['"]/g,_0x12203a=[],_0x12f93e=new Set(),_0x49dff4=_0x4aacc9=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x4aacc9),_0x2cf6f8=_0x3600cd=>{let _0x1b58ef=_0x3600cd;if(_0x1b58ef['startsWith']('./')||_0x1b58ef['startsWith']('../')||_0x1b58ef['startsWith']('/')||_0x1b58ef['startsWith']('file://')||!_0x49dff4(_0x3600cd)||_0x12f93e['has'](_0x3600cd))return;_0x12f93e['add'](_0x3600cd),_0x1b58ef['startsWith']('npm:')&&(_0x1b58ef=_0x1b58ef['substring'](0x4)),_0x1b58ef['includes']('@')&&!_0x1b58ef['startsWith']('@')&&(_0x1b58ef=_0x1b58ef['split']('@')[0x0]);let _0x1cc848=_0x1b58ef['split']('/')[0x0];_0x31eec2['includes'](_0x1cc848)||_0x31eec2['includes'](_0x3600cd)||_0x12203a['push'](_0x3600cd);},_0xce931f;for(;(_0xce931f=_0x51bed6['exec'](_0x5aeb3b))!==null;)_0x2cf6f8(_0xce931f[0x1]);for(;(_0xce931f=_0x5cd7e2['exec'](_0x5aeb3b))!==null;)_0x2cf6f8(_0xce931f[0x1]);for(;(_0xce931f=_0x13e60d['exec'](_0x5aeb3b))!==null;)_0x2cf6f8(_0xce931f[0x1]);return{'valid':_0x12203a['length']===0x0,'violations':_0x12203a,'serverPath':_0x142a1c};}['validate'](_0x1c6215={}){let _0x49c3d6=[],_0x5cf445=this['manifest']['permissions']||{};try{let _0x405bd3=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x405bd3);}catch{}let _0x297365=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x33faea,_0x3971e7]of Object['entries'](_0x5cf445))if(_0x33faea==='hrtime')typeof _0x3971e7!='boolean'&&_0x49c3d6['push']('Permission\x20\x27'+_0x33faea+'\x27\x20must\x20be\x20boolean');else{if(_0x33faea==='langchain')typeof _0x3971e7!='boolean'&&(typeof _0x3971e7!='object'||_0x3971e7===null)?_0x49c3d6['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x3971e7=='object'&&(_0x3971e7===null||!('enabled'in _0x3971e7)||typeof _0x3971e7['enabled']!='boolean')&&_0x49c3d6['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x33faea==='kv')typeof _0x3971e7!='boolean'&&_0x49c3d6['push']('Permission\x20\x27'+_0x33faea+'\x27\x20must\x20be\x20boolean');else{if(_0x33faea==='mspbots')Array['isArray'](_0x3971e7)||_0x49c3d6['push']('Permission\x20\x27'+_0x33faea+'\x27\x20must\x20be\x20an\x20array');else{if(_0x33faea==='db'){if(typeof _0x3971e7!='object'||_0x3971e7===null||Array['isArray'](_0x3971e7))_0x49c3d6['push']('Permission\x20\x27'+_0x33faea+'\x27\x20must\x20be\x20an\x20object');else{let _0x43bf98=_0x3971e7,_0x5ad709=['user','password']['filter'](_0x177d40=>!(_0x177d40 in _0x43bf98));_0x5ad709['length']>0x0&&_0x49c3d6['push']('Permission\x20\x27'+_0x33faea+'\x27\x20missing\x20required\x20fields:\x20'+_0x5ad709['join'](',\x20'));}}else{if(_0x33faea==='imports')continue;_0x297365['has'](_0x33faea)||typeof _0x3971e7!='boolean'&&!Array['isArray'](_0x3971e7)&&_0x49c3d6['push']('Permission\x20\x27'+_0x33faea+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x130a93=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x130a93))_0x49c3d6['push']('permissions.imports must be an array');else{for(let _0x5c0fd9 of _0x130a93)typeof _0x5c0fd9!='string'&&_0x49c3d6['push']('import\x20\x27'+_0x5c0fd9+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x49c3d6['length']===0x0,'errors':_0x49c3d6};}};function q(_0x23d3f6,_0x28ceec,_0xbf166f){return new D(_0x23d3f6,_0x28ceec,_0xbf166f||{});}var R=null;function I(){let _0x3fdfde=globalThis['Deno'];if(!_0x3fdfde)throw new Error('Deno is not available');return _0x3fdfde;}async function K(){if(R)return{...R};try{let _0x300829=I(),_0x2c9898=join(_0x300829['cwd'](),'deno.json'),_0x3beb22=await _0x300829['readTextFile'](_0x2c9898);return R=JSON['parse'](_0x3beb22)['imports']||{},{...R};}catch(_0x1604f6){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x1604f6),{};}}var E=class{constructor(_0x2a0578,_0x2459d8={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x2a0578['appsDir'],this['platformImportsOverride']=_0x2a0578['platformImports'],this['libDir']=_0x2a0578['libDir'],this['events']=_0x2459d8);}async['create'](_0x2d08ea,_0x35c17f,_0x213bad){try{return await this['createWorker'](_0x2d08ea,_0x35c17f,_0x213bad);}catch(_0x35808d){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x2d08ea+':',_0x35808d),_0x35808d;}}async['createWorker'](_0x29cfcd,_0x2e51d6,_0xec5fe1){let _0x528dfb=this['platformImportsOverride']||await K(),_0x58be84=q(_0x2e51d6,this['libDir'],_0x528dfb)['validateServerImports'](this['appsDir']);if(!_0x58be84['valid']){let _0xc05732=_0x58be84['violations']['filter'](_0x2782c3=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x2782c3)),_0x2deb3c=_0x58be84['serverPath']?_0x58be84['serverPath']:(_0x2e51d6['name']||_0x2e51d6['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x2deb3c+':\x20'+_0xc05732['join'](',\x20'));}let _0x39e0eb=q(_0x2e51d6,this['libDir'],_0x528dfb),_0x4a61e7=_0x39e0eb['validate'](_0x528dfb);if(!_0x4a61e7['valid'])throw new Error('Invalid\x20config:\x20'+_0x4a61e7['errors']['join'](',\x20'));let _0x366e05=_0x39e0eb['buildImportMap'](_0x528dfb);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x29cfcd+':',_0x366e05);let _0x262d1c=_0x39e0eb['buildPerms'](),_0x5f4f62=_0x39e0eb['getReadPaths']();if(_0x262d1c['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x262d1c['read']);else{let _0x29d8b9=_0x2e51d6['name']||_0x29cfcd,_0x34c796=this['appsDir']+'/'+_0x29d8b9,_0x43403e=[_0x34c796],_0x536881=_0x2e51d6['metadata']?.['serverPath'];if(_0x536881&&typeof _0x536881=='string')try{let _0x2bf307=dirname(_0x536881)['replace'](/\\/g,'/');_0x43403e['push'](_0x2bf307);}catch{}_0x262d1c['read']=_0x43403e,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x34c796);}if(_0x5f4f62['length']>0x0){if(_0x262d1c['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x4a946a=Array['isArray'](_0x262d1c['read'])?_0x262d1c['read']:[];_0x262d1c['read']=[..._0x4a946a,..._0x5f4f62],console['log']('[Worker] Added package read permissions:',_0x5f4f62);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x262d1c['net']||(_0x262d1c['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x29cfcd+':',_0x262d1c['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x262d1c['read']===!![]?'unrestricted':Array['isArray'](_0x262d1c['read'])?_0x262d1c['read']['length']:0x0));let _0x32c59b=await this['createImportMap'](_0x29cfcd,_0x366e05),_0x43e309=await this['createLock'](_0x29cfcd,_0x366e05),_0x81c9b0={'type':'module','deno':{'permissions':{}}};_0x81c9b0['deno']['namespace']=![],_0x81c9b0['deno']['permissions']=_0x262d1c,_0x81c9b0['deno']['importMap']=_0x32c59b,_0x81c9b0['deno']['lock']=_0x43e309,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x29cfcd+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x32c59b),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x43e309),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x366e05)['length']+'\x20('+(Object['keys'](_0x366e05)['join'](',\x20')||'none')+')');let _0x41702b={'worker':new Worker(_0xec5fe1,_0x81c9b0),'appId':_0x29cfcd,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x2e51d6,'importMapPath':_0x32c59b,'lockfilePath':_0x43e309};return this['workers']['set'](_0x29cfcd,_0x41702b),this['events']['onCreate']?.(_0x41702b),_0x41702b;}async['createLock'](_0x49a39a,_0x2b4d7a){let _0x5b59ea=I(),_0x3673b4=join(_0x5b59ea['cwd'](),'storage','temp','lockfiles');await _0x5b59ea['mkdir'](_0x3673b4,{'recursive':!![]});let _0x2189dd=_0x49a39a+'-'+Date['now']()+'.lock',_0x420fe8=join(_0x3673b4,_0x2189dd),_0x5a51e5={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x3dcd2c,_0x285e9a]of Object['entries'](_0x2b4d7a))if(_0x285e9a['startsWith']('npm:'))_0x285e9a['replace']('npm:',''),_0x5a51e5['packages']['specifiers'][_0x3dcd2c]=_0x285e9a;else _0x285e9a['startsWith']('file://')&&(_0x5a51e5['packages']['specifiers'][_0x3dcd2c]=_0x285e9a);let _0x2fd9e2=JSON['stringify'](_0x5a51e5,null,0x2);return await _0x5b59ea['writeTextFile'](_0x420fe8,_0x2fd9e2),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x420fe8),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x2b4d7a)['length']+'):',Object['keys'](_0x2b4d7a)),_0x420fe8;}async['createImportMap'](_0xdbfe9a,_0x1b02b8){let _0x34314e=I(),_0x5b081d=join(_0x34314e['cwd'](),'storage','temp','importmaps');await _0x34314e['mkdir'](_0x5b081d,{'recursive':!![]});let _0xacb521=_0xdbfe9a+'-'+Date['now']()+'.json',_0x18f778=join(_0x5b081d,_0xacb521),_0x496031=JSON['stringify']({'imports':_0x1b02b8,'scopes':{}},null,0x2);return await _0x34314e['writeTextFile'](_0x18f778,_0x496031),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x18f778),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x1b02b8)['length']+'):',Object['keys'](_0x1b02b8)['join'](',\x20')||'none'),_0x18f778;}['get'](_0x41bf8e){return this['workers']['get'](_0x41bf8e);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x12a7a3,_0x14bbc8){let _0x355f30=this['workers']['get'](_0x12a7a3);if(!_0x355f30)return;let _0x1e60cc=_0x355f30['status'];_0x355f30['status']=_0x14bbc8,_0x14bbc8==='running'&&_0x1e60cc==='starting'?this['events']['onReady']?.(_0x355f30):_0x14bbc8==='crashed'&&this['events']['onCrash']?.(_0x355f30);}['touch'](_0x13497a){let _0x1905e3=this['workers']['get'](_0x13497a);_0x1905e3&&(_0x1905e3['lastUsed']=Date['now']());}async['stop'](_0x516c09){let _0x1761ea=this['workers']['get'](_0x516c09);if(_0x1761ea)try{_0x1761ea['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x1761ea['worker']['terminate'](),_0x1761ea['status']='stopped',this['events']['onStop']?.(_0x1761ea),_0x1761ea['importMapPath']&&await this['cleanupImportMap'](_0x1761ea['importMapPath']),_0x1761ea['lockfilePath']&&await this['cleanupLock'](_0x1761ea['lockfilePath']);}catch(_0x265877){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x516c09+':',_0x265877);}finally{this['workers']['delete'](_0x516c09);}}async['cleanupImportMap'](_0x1190b5){try{await I()['remove'](_0x1190b5),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x1190b5);}catch(_0x542780){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x1190b5,_0x542780);}}async['cleanupLock'](_0x49a82a){try{await I()['remove'](_0x49a82a),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x49a82a);}catch(_0x22b667){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x49a82a,_0x22b667);}}async['stopAll'](){let _0x58b15a=Array['from'](this['workers']['keys']());await Promise['all'](_0x58b15a['map'](_0x1c52e0=>this['stop'](_0x1c52e0)));}async['restart'](_0x41eef2,_0x45275a){let _0x2e503a=this['workers']['get'](_0x41eef2);if(!_0x2e503a)throw new Error('Worker\x20'+_0x41eef2+'\x20not\x20found');let _0x2c70fa=_0x2e503a['manifest'];return await this['stop'](_0x41eef2),await this['create'](_0x41eef2,_0x2c70fa,_0x45275a);}['checkHealth'](_0x4c36cc){let _0x399026=this['workers']['get'](_0x4c36cc);if(!_0x399026)return{'healthy':![],'reason':'Not\x20found'};if(_0x399026['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x399026['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x4b84aa=Date['now']()-_0x399026['lastUsed'],_0x40825b=0x708*0x3e8;return _0x4b84aa>_0x40825b?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x4b84aa/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x435d5c=0x708*0x3e8,_0x41fbc3){let _0x4bd5f8=Date['now'](),_0x5b9b11=[];for(let [_0x2c436e,_0x45016c]of this['workers']['entries']()){let _0x23f9c3=_0x4bd5f8-_0x45016c['lastUsed'];_0x23f9c3>_0x435d5c&&_0x5b9b11['push']({'appId':_0x2c436e,'idle':_0x23f9c3});}_0x5b9b11['sort']((_0x3993a0,_0x53b1da)=>_0x53b1da['idle']-_0x3993a0['idle']);let _0x2f85e5=_0x41fbc3?_0x5b9b11['slice'](0x0,_0x41fbc3)['map'](_0x2397f1=>_0x2397f1['appId']):_0x5b9b11['map'](_0xdfed22=>_0xdfed22['appId']);for(let _0x1f993b of _0x2f85e5)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x1f993b),await this['stop'](_0x1f993b);}['stats'](){let _0x3c3bb2={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x572092=Date['now']();for(let _0x2720e0 of this['workers']['values']())_0x3c3bb2['byStatus'][_0x2720e0['status']]++,_0x3c3bb2['workers']['push']({'appId':_0x2720e0['appId'],'status':_0x2720e0['status'],'version':_0x2720e0['version'],'lastUsed':_0x2720e0['lastUsed'],'idle':_0x572092-_0x2720e0['lastUsed']});return _0x3c3bb2;}['startCleanup'](_0x46c8d7=0x12c*0x3e8,_0x3c4170){let _0x52cf6b=setInterval(()=>{this['cleanup'](_0x3c4170)['catch'](_0x524e06=>{console['error']('Cleanup\x20failed:',_0x524e06);});},_0x46c8d7);return()=>clearInterval(_0x52cf6b);}['delay'](_0x273112){return new Promise(_0x321b3a=>setTimeout(_0x321b3a,_0x273112));}};function W(_0x8d7364,_0x3c65fb){return new E(_0x8d7364,_0x3c65fb);}var v=f,j=class{constructor(_0x5cc61c,_0x2f0973=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x5cc61c,this['timeout']=_0x2f0973);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x4bf75f){_0x4bf75f['worker']['onmessage']=_0xc9448c=>{let _0x422a80=_0xc9448c['data'],{appId:_0x28ee85}=_0x4bf75f;switch(_0x422a80['type']){case'ready':this['events']['onReady'](_0x28ee85),v['info']('Worker\x20ready',{'appId':_0x28ee85,'version':_0x4bf75f['version']});break;case'log':{let {level:_0x3f0302='info',message:_0x476da2,meta:_0x1b6a80}=_0x422a80,_0x5c51a0={..._0x1b6a80||{},'appId':_0x28ee85,'version':_0x4bf75f['version']};this['events']['onLog'](_0x28ee85,_0x3f0302,_0x476da2,_0x5c51a0);break;}case'result':{let {reqId:_0xb79bf5,ok:_0x2f275c,response:_0x472af8,error:_0x4375e8}=_0x422a80,_0x52cbc1=this['pending']['get'](_0xb79bf5);if(!_0x52cbc1){v['warn']('Unknown\x20request',{'appId':_0x28ee85,'reqId':_0xb79bf5});return;}if(this['pending']['delete'](_0xb79bf5),_0x2f275c&&_0x472af8)_0x52cbc1['resolve'](_0x472af8);else{let _0xb2177b=new Error(_0x4375e8?.['message']||'Worker\x20error');_0xb2177b['stack']=_0x4375e8?.['stack'],_0x52cbc1['reject'](_0xb2177b);}this['events']['onResult'](_0x28ee85,_0xb79bf5,_0x472af8||_0x4375e8);break;}default:v['debug']('Unknown\x20message',{'appId':_0x28ee85,'type':_0x422a80['type']});}},_0x4bf75f['worker']['onerror']=_0xfe9bf0=>{let {appId:_0x18bf07}=_0x4bf75f;v['error']('Worker\x20error',{'appId':_0x18bf07,'message':_0xfe9bf0['message'],'lineno':_0xfe9bf0['lineno'],'filename':_0xfe9bf0['filename']}),_0x4bf75f['status']='crashed',this['rejectPending'](_0x18bf07,new Error('Worker\x20'+_0x18bf07+'\x20crashed:\x20'+_0xfe9bf0['message'])),_0xfe9bf0['preventDefault']();},_0x4bf75f['worker']['onmessageerror']=_0x118ebc=>{let {appId:_0x420647}=_0x4bf75f;v['error']('Message\x20error',{'appId':_0x420647,'data':_0x118ebc['data']}),_0x4bf75f['status']='crashed',_0x118ebc['preventDefault']();};}['sendInit'](_0x13452d,_0x131d81,_0x3004e3,_0x50cbcc){_0x13452d['worker']['postMessage']({'type':'init','appId':_0x13452d['appId'],'manifest':_0x3004e3,'appsDir':_0x131d81,'serverPath':_0x50cbcc});}async['sendInvoke'](_0x5023ef,_0x45b93){let _0x24ee97=this['nextId'](),_0x5d0e5e=_0x5023ef['appId'],_0x54a6f0=new Promise((_0x464174,_0x334def)=>{let _0x3e381a=setTimeout(()=>{this['pending']['delete'](_0x24ee97),_0x334def(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x24ee97,{'resolve':_0x2a5c48=>{clearTimeout(_0x3e381a),_0x464174(_0x2a5c48);},'reject':_0x1da28f=>{clearTimeout(_0x3e381a),_0x334def(_0x1da28f);},'timestamp':Date['now'](),'appId':_0x5d0e5e});});return _0x5023ef['worker']['postMessage']({'type':'invoke','appId':_0x5023ef['appId'],'reqId':_0x24ee97,'payload':_0x45b93}),await _0x54a6f0;}['rejectPending'](_0x45d13f,_0x2cea59){let _0x1e6c79=0x0;for(let [_0x33a02c,_0x48900d]of this['pending']['entries']())_0x48900d['appId']===_0x45d13f&&(this['pending']['delete'](_0x33a02c),_0x48900d['reject'](_0x2cea59),_0x1e6c79++);_0x1e6c79>0x0&&v['warn']('Rejected\x20'+_0x1e6c79+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x45d13f});}['cleanupTimeout'](){let _0x51cab5=Date['now']();for(let [_0x382d5f,_0x5dcd97]of this['pending']['entries']())_0x51cab5-_0x5dcd97['timestamp']>this['timeout']&&(this['pending']['delete'](_0x382d5f),_0x5dcd97['reject'](new Error('Request\x20'+_0x382d5f+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0xb44534){let _0x834174=0x0;for(let _0x31d00b of this['pending']['values']())_0x31d00b['appId']===_0xb44534&&_0x834174++;return _0x834174;}['startCleanup'](_0x349664=0x2710){let _0x54f6f4=setInterval(()=>{this['cleanupTimeout']();},_0x349664);return()=>clearInterval(_0x54f6f4);}};function $(_0x4ffe02,_0x308582){return new j(_0x4ffe02,_0x308582);}var Q=class{constructor(_0x52566f={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x52566f['logger']||f,this['config']={'appsDir':_0x52566f['appsDir']||this['getAppsDir'](),'scriptUrl':_0x52566f['scriptUrl']||this['getScriptUrl'](),'timeout':_0x52566f['timeout']||0x78*0x3e8,'autoCleanup':_0x52566f['autoCleanup']??!![],'cleanupInterval':_0x52566f['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x52566f['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x52566f['maxWorkers'],'reuseWorkers':_0x52566f['reuseWorkers']??!![],'workerReuseStrategy':_0x52566f['workerReuseStrategy']||'lru','enableQueue':_0x52566f['enableQueue']??!![],'maxQueueSize':_0x52566f['maxQueueSize']||0x64,'queueTimeout':_0x52566f['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x1dce2f=>this['logger']['info']('Worker\x20created',{'appId':_0x1dce2f['appId'],'v':_0x1dce2f['version']}),'onReady':_0x238621=>this['lifecycle']['updateStatus'](_0x238621['appId'],'running'),'onCrash':_0x1e43a0=>this['logger']['error']('Worker\x20crashed',{'appId':_0x1e43a0['appId'],'v':_0x1e43a0['version']}),'onStop':_0x4c0de1=>this['logger']['info']('Worker\x20stopped',{'appId':_0x4c0de1['appId'],'v':_0x4c0de1['version']})}),this['messaging']=$({'onReady':_0x5ef4f9=>this['lifecycle']['updateStatus'](_0x5ef4f9,'running'),'onLog':(_0x46b2f8,_0x559ed9,_0x3f0cde,_0x414d8a)=>{let _0x4d73d5={..._0x414d8a||{},'appId':_0x46b2f8};switch(_0x559ed9){case'error':this['logger']['error'](_0x3f0cde,_0x4d73d5);break;case'warn':this['logger']['warn'](_0x3f0cde,_0x4d73d5);break;case'debug':this['logger']['debug'](_0x3f0cde,_0x4d73d5);break;default:this['logger']['info'](_0x3f0cde,_0x4d73d5);break;}},'onResult':(_0x485ad2,_0x578d25,_0x8829bd)=>{this['logger']['debug']('Result\x20received',{'appId':_0x485ad2,'reqId':_0x578d25});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0xa5764c['cwd'](),'apps');}['getScriptUrl'](){let _0x5d4009=import.meta.url,_0x3daa1e=_0x5d4009['endsWith']('.js')||_0x5d4009['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x3daa1e,_0x5d4009)['href'];}async['ensure'](_0xe289dc){let {id:_0x4b75cd}=_0xe289dc,_0x5705db=this['lifecycle']['get'](_0x4b75cd);if(_0x5705db){let _0x6b42c0=this['lifecycle']['checkHealth'](_0x4b75cd);if(_0x6b42c0['healthy'])return this['lifecycle']['touch'](_0x4b75cd),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x4b75cd}),_0x5705db;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x4b75cd,'reason':_0x6b42c0['reason']}),await this['lifecycle']['stop'](_0x4b75cd);}for(;;){let _0x47031f=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x47031f>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x47031f,'max':this['config']['maxWorkers'],'appId':_0x4b75cd}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0xe289dc);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x101751=await this['loadManifest'](_0x4b75cd,_0xe289dc['manifest']),_0x3671d2=await this['lifecycle']['create'](_0x4b75cd,_0x101751,this['config']['scriptUrl']),_0x10eaad=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x10eaad>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x10eaad,'max':this['config']['maxWorkers'],'appId':_0x4b75cd}),await this['lifecycle']['stop'](_0x4b75cd),this['config']['enableQueue'])return await this['waitSlot'](_0xe289dc);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x10eaad+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x3671d2);let _0x536569=_0x101751['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x3671d2,this['config']['appsDir'],_0x101751,_0x536569),this['logger']['info']('Worker\x20created',{'appId':_0x4b75cd,'v':_0x3671d2['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x3671d2;}async['evictIdle'](){let _0x218fad=this['lifecycle']['getAll']();if(_0x218fad['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x297b4d=[..._0x218fad];this['config']['workerReuseStrategy']==='lru'?_0x297b4d['sort']((_0x3b2ad5,_0x38dd30)=>_0x3b2ad5['lastUsed']-_0x38dd30['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x297b4d['sort']((_0x2b0adf,_0xf1a927)=>_0x2b0adf['version']-_0xf1a927['version']);let _0x400d76=null;for(let _0x400d64 of _0x297b4d)if(this['messaging']['getAppCount'](_0x400d64['appId'])===0x0){_0x400d76=_0x400d64;break;}if(!_0x400d76&&_0x297b4d['length']>0x0&&(_0x400d76=_0x297b4d['reduce']((_0x2f4c22,_0x4e7ca3)=>{let _0x35a0b8=this['messaging']['getAppCount'](_0x2f4c22['appId']);return this['messaging']['getAppCount'](_0x4e7ca3['appId'])<_0x35a0b8?_0x4e7ca3:_0x2f4c22;})),_0x400d76){let _0x4c2d7e=this['messaging']['getAppCount'](_0x400d76['appId']);return _0x4c2d7e>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x400d76['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x400d76['lastUsed'],'pendingRequests':_0x4c2d7e}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x400d76['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x400d76['lastUsed']}),await this['lifecycle']['stop'](_0x400d76['appId']),!![];}return![];}['waitSlot'](_0x5e6d24){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x1da2e1,_0x247f2)=>{let _0x243b74={'info':_0x5e6d24,'resolve':_0x1da2e1,'reject':_0x247f2,'timestamp':Date['now']()};this['requestQueue']['push'](_0x243b74),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x5e6d24['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x1af45f=setTimeout(()=>{let _0x3a61c7=this['requestQueue']['indexOf'](_0x243b74);_0x3a61c7!==-0x1&&(this['requestQueue']['splice'](_0x3a61c7,0x1),_0x247f2(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x243b74['resolve']=_0x149944=>{clearTimeout(_0x1af45f),_0x1da2e1(_0x149944);},_0x243b74['reject']=_0x2ee7c7=>{clearTimeout(_0x1af45f),_0x247f2(_0x2ee7c7);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x504b10=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x504b10>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x5c7db2=this['requestQueue']['shift']();if(!_0x5c7db2)break;try{let _0x1e23fb=await this['ensure'](_0x5c7db2['info']);_0x5c7db2['resolve'](_0x1e23fb);}catch(_0x5e132d){_0x5c7db2['reject'](_0x5e132d);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x3b9d97,_0x361109){let _0x24a7dc=this['config']['appsDir']['replace'](/\\/g,'/'),_0xc5bad8=async _0xaa19b3=>{try{let _0x4b510d=globalThis['Deno'];if(!_0x4b510d)return null;let _0x53d5d3=await _0x4b510d['readTextFile'](_0xaa19b3);return JSON['parse'](_0x53d5d3);}catch{return null;}};if(_0x361109?.['name']){let _0x5e830c=await _0xc5bad8(_0x24a7dc+'/'+_0x361109['name']+'/manifest.json');if(_0x5e830c)return _0x5e830c;}let _0x367b6c=await _0xc5bad8(_0x24a7dc+'/'+_0x3b9d97+'/manifest.json');if(_0x367b6c)return _0x367b6c;try{let _0x5d00bf=globalThis['Deno'];if(_0x5d00bf)for await(let _0x13fbdd of _0x5d00bf['readDir'](_0x24a7dc)){if(!_0x13fbdd['isDirectory'])continue;let _0x3e947c=_0x24a7dc+'/'+_0x13fbdd['name']+'/manifest.json',_0x4f59a9=await _0xc5bad8(_0x3e947c);if(_0x4f59a9&&(_0x4f59a9['id']===_0x3b9d97||_0x361109?.['name']&&_0x4f59a9['name']===_0x361109['name']))return _0x4f59a9;}}catch(_0x21d6bd){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x3b9d97,'error':_0x21d6bd['message']});}return _0x361109||{'id':_0x3b9d97,'name':_0x3b9d97,'version':'1.0.0'};}async['invoke'](_0x4d5a5d){let _0x41cb92=_0x4d5a5d['ctx']['app']['id'],_0xda6b16=_0x4d5a5d['ctx']['app']['name'];try{let _0x44f3dd={'id':_0x41cb92,'manifest':{'id':_0x41cb92,'name':_0xda6b16}},_0x4fac9c=await this['ensure'](_0x44f3dd);if(_0x4fac9c['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x41cb92}),await this['restart'](_0x41cb92);let _0x119b8f=await this['ensure'](_0x44f3dd);return this['lifecycle']['touch'](_0x41cb92),await this['messaging']['sendInvoke'](_0x119b8f,_0x4d5a5d);}return this['lifecycle']['touch'](_0x41cb92),await this['messaging']['sendInvoke'](_0x4fac9c,_0x4d5a5d);}catch(_0x42f98c){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x41cb92,'error':_0x42f98c['message'],'stack':_0x42f98c['stack']}),_0x42f98c;}}async['stop'](_0x4982df){await this['lifecycle']['stop'](_0x4982df),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x3b041a){return await this['lifecycle']['restart'](_0x3b041a,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x1b3f49=>({'appId':_0x1b3f49['appId'],'status':_0x1b3f49['status'],'version':_0x1b3f49['version'],'lastUsed':_0x1b3f49['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x172c2c=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x20a0a5=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x172c2c(),_0x20a0a5();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x53d917=>{_0x53d917?(await this['stop'](_0x53d917),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x53d917})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x4a3fb9){return new Q(_0x4a3fb9);}var S=null;function be(_0xa4aa04){S=ee(_0xa4aa04);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x30a529){return await k()['ensure'](_0x30a529);}async function xe(_0x419835){return await k()['invoke'](_0x419835);}function Ie(_0x29f15d){k()['stop'](_0x29f15d)['catch'](_0x521a62=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x29f15d,'error':_0x521a62['message']});});}function Re(){k()['stopAll']()['catch'](_0x527fb0=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x527fb0['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x1c7bde){await k()['stop'](_0x1c7bde);}async function Se(){await k()['stopAll']();}function Ae(_0x4a993e){let _0x536283=_0x4a993e&&typeof _0x4a993e=='object'?_0x4a993e:null;if(_0x536283&&'user'in _0x536283)return _0x536283['user'];}function H(_0x15fc7a){let _0x4b49f7=_0x15fc7a&&typeof _0x15fc7a=='object'?_0x15fc7a:null;if(!_0x4b49f7)return{};let _0x203ba6={};for(let [_0x5cfcda,_0x260e36]of Object['entries'](_0x4b49f7))_0x5cfcda!=='user'&&(_0x203ba6[_0x5cfcda]=_0x260e36);return _0x203ba6;}function O(_0x2d9415){return _0x2d9415?{'id':_0x2d9415['manifest']?.['id']||_0x2d9415['id']||'','name':_0x2d9415['manifest']?.['name']||'','version':_0x2d9415['manifest']?.['version']||'','description':_0x2d9415['manifest']?.['description']||'','icon':_0x2d9415['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0xe3e80){return _0xe3e80?.['permissions']||_0xe3e80?.['manifest']?.['permissions']||{};}function F(_0x5627b3){return _0x5627b3?.['manifest']?.['metadata']||{};}function Ce(_0x35fcd6){return _0x35fcd6?{'appId':_0x35fcd6['id'],'appName':_0x35fcd6['manifest']?.['name']}:{};}function N(_0x52fbf3,_0x201d29={}){let {appInfo:_0x354a06=null,status:_0x350166=0x1f4,defaultMessage:_0x156e7d='Internal\x20Server\x20Error'}=_0x201d29,_0xd8b5d9={'error':_0x156e7d,'message':_0x52fbf3?.['message']||_0x156e7d};return _0x354a06&&(_0xd8b5d9['appId']=_0x354a06['id'],_0xd8b5d9['appName']=_0x354a06['manifest']?.['name']),_0x52fbf3?.['message']?.['includes']('crashed')&&(_0xd8b5d9['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x350166,'body':_0xd8b5d9};}function qe(_0x4e284e){return _0x4e284e?.['message']?.['includes']('crashed')||![];}function J(_0x140b2e){if(_0x140b2e)try{return JSON['parse'](_0x140b2e);}catch{return _0x140b2e;}}function B(_0x35ad94){try{let _0x54244a=new URL(_0x35ad94),_0x42809c={};for(let _0xc515 of _0x54244a['searchParams']['keys']()){let _0x2d5276=_0x54244a['searchParams']['getAll'](_0xc515)['map'](_0x55e7f5=>_0x55e7f5);_0x2d5276['length']<=0x1?_0x42809c[_0xc515]=_0x2d5276[0x0]??'':_0x42809c[_0xc515]=_0x2d5276;}return _0x42809c;}catch{return{};}}function Le(_0x24bdfc){return(()=>{try{return new URL(_0x24bdfc)['pathname'];}catch{return _0x24bdfc;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x5ecb9b,_0x1af8da){let _0x5d26eb=_0x5ecb9b;if(_0x1af8da&&_0x5d26eb['startsWith']('/apps/'+_0x1af8da))_0x5d26eb=_0x5d26eb['substring'](('/apps/'+_0x1af8da)['length'])||'/';else{let _0x5b25bc=_0x5d26eb['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x5b25bc&&(_0x5d26eb=_0x5b25bc[0x1]||'/');}return _0x5d26eb['startsWith']('/api')&&(_0x5d26eb=_0x5d26eb['substring'](0x4)||'/'),_0x5d26eb;}function Ue(_0x57fefc,_0x43a150){let _0x1587a3=_0x57fefc;if(_0x43a150&&_0x1587a3['startsWith']('/apps/'+_0x43a150))_0x1587a3=_0x1587a3['substring'](('/apps/'+_0x43a150)['length'])||'/';else{let _0x3f48e5=_0x1587a3['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x3f48e5&&(_0x1587a3=_0x3f48e5[0x1]||'/');}return(!_0x1587a3||_0x1587a3==='/')&&(_0x1587a3='/index.html'),_0x1587a3;}async function He(_0x27d833,_0x59d05b){return await _0x59d05b(_0x27d833);}function _(_0x1f525c){return _0x1f525c['split']('/')['filter'](_0x18a9a1=>_0x18a9a1['length']>0x0);}function te(_0x2e2ef4){try{return decodeURIComponent(_0x2e2ef4);}catch{return _0x2e2ef4;}}function re(_0x2c1906,_0x2a81e4){let _0x40db77=_(_0x2c1906),_0x540c45=_(_0x2a81e4),_0x644c54={},_0x35148d=0x0,_0x1d4a61=0x0;for(;_0x35148d<_0x40db77['length']&&_0x1d4a61<_0x540c45['length'];){let _0x1c4c21=_0x40db77[_0x35148d],_0x487713=_0x540c45[_0x1d4a61];if(_0x1c4c21==='*')break;if(_0x1c4c21['startsWith'](':')){let _0x29a967=_0x1c4c21['slice'](0x1);_0x29a967&&(_0x644c54[_0x29a967]=te(_0x487713)),_0x35148d++,_0x1d4a61++;continue;}if(_0x1c4c21!==_0x487713)return{};_0x35148d++,_0x1d4a61++;}return _0x35148d===_0x40db77['length']||_0x35148d===_0x40db77['length']-0x1&&_0x40db77[_0x35148d]==='*',_0x644c54;}async function Oe(_0x23150f,_0x1aecf5,_0x425235,_0x27f36c,_0x139f19=void 0x0,_0x5c81a2){let _0x1ab809=await _0x1aecf5['text'](),_0x220046=J(_0x1ab809),_0x45a5e1=B(_0x1aecf5['url']),_0x5d08ac={...F(_0x23150f),'user':_0x139f19},_0x4c12ff=H(_0x5d08ac),_0x18d91a=_0x5c81a2?re(_0x5c81a2,_0x1aecf5['path']):{};return{'app':O(_0x23150f),'permissions':T(_0x23150f),'user':_0x139f19,'metadata':_0x4c12ff,'body':_0x220046,'query':_0x45a5e1,'params':_0x18d91a,'method':_0x425235,'pathname':_0x27f36c,'requestUrl':_0x1aecf5['url'],'headers':Object['fromEntries'](_0x1aecf5['raw']['headers']['entries']())};}function Te(_0x53df6e){return{'method':_0x53df6e['method'],'pathname':_0x53df6e['pathname'],'ctx':_0x53df6e};}function Fe(_0x4a8c6a,_0xa7eda2){let {status:_0x59800b=0xc8,headers:_0x44fddb={},body:_0x4b7ec9,type:_0x5219a5}=_0x4a8c6a??{};return _0x5219a5==='raw'?new globalThis['Response'](String(_0x4b7ec9??''),{'status':_0x59800b,'headers':_0x44fddb}):_0xa7eda2(_0x4b7ec9,_0x59800b);}function Ne(_0x36d60b,_0x19916a=null){return N(_0x36d60b,{'appInfo':_0x19916a});}var V=f;async function Ve(_0xf50e2d){_0xf50e2d?(await U(_0xf50e2d),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0xf50e2d)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x39f58a,_0x364040){let _0x5cbfd4=Object['fromEntries'](Object['entries'](_0x39f58a['headers']||{})['map'](([_0x4b5ad1,_0x532591])=>[_0x4b5ad1['toLowerCase'](),_0x532591]));return{'id':_0x39f58a['app']['id']||_0x364040['appId']||'','name':_0x39f58a['app']['name']||'','version':_0x39f58a['app']['version']||'','description':_0x39f58a['app']['description']||'','metadata':{..._0x39f58a['metadata'],'permissions':_0x39f58a['permissions']},'body':_0x39f58a['body'],'query':_0x39f58a['query'],'params':_0x39f58a?.['params'],'method':_0x39f58a['method'],'pathname':_0x39f58a['pathname'],'requestUrl':_0x39f58a['requestUrl'],'user':_0x39f58a['user'],'headers':_0x5cbfd4};}var L=class{constructor(_0x16b313){this['handle']=null,(this['config']=_0x16b313,this['logger']=_0x16b313['logger']||f,this['lifecycle']=W({'appsDir':_0x16b313['appsDir'],'timeout':_0x16b313['timeout'],'platformImports':_0x16b313['platformImports'],'libDir':_0x16b313['libDir']},{'onCreate':_0x47895f=>this['logger']['info']('Worker\x20created',{'appId':_0x47895f['appId']}),'onReady':_0x2816d9=>{this['lifecycle']['updateStatus'](_0x2816d9['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x2816d9['appId']});},'onCrash':_0x352636=>this['logger']['error']('Worker\x20crashed',{'appId':_0x352636['appId']}),'onStop':_0x2e8c0e=>this['logger']['info']('Worker\x20stopped',{'appId':_0x2e8c0e['appId']})}),this['messaging']=$({'onReady':_0x1b0f0c=>this['lifecycle']['updateStatus'](_0x1b0f0c,'running'),'onLog':(_0x3f3fbf,_0xa9778a,_0x1313cc,_0x334453)=>{(this['logger'][_0xa9778a]||this['logger']['info'])['call'](this['logger'],_0x1313cc,_0x334453);},'onResult':()=>{}},_0x16b313['timeout']||0x1d4c0));}async['create'](_0x1260ee){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x23438e=await this['lifecycle']['create'](this['config']['appId'],_0x1260ee,this['config']['scriptUrl']);this['messaging']['setup'](_0x23438e),this['messaging']['sendInit'](_0x23438e,this['config']['appsDir'],_0x1260ee,this['config']['serverPath']),this['handle']=_0x23438e,await this['waitForReady']();}async['waitForReady'](_0x17cfd4=0x2710){let _0x120df8=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x120df8>_0x17cfd4)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x835290=>setTimeout(_0x835290,0x64));}}async['invoke'](_0x27c27e){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x27c27e);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x3ea374){return new L(_0x3ea374);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};