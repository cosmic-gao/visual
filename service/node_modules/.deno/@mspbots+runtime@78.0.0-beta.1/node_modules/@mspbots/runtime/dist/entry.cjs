'use strict';function c(_0x3f48b9,_0xec6ffa){let _0x3826e9=Object['fromEntries'](Object['entries'](_0x3f48b9['headers']||{})['map'](([_0x6fe306,_0x19513a])=>[_0x6fe306['toLowerCase'](),_0x19513a]));return{'id':_0x3f48b9['app']['id']||_0xec6ffa['appId']||'','name':_0x3f48b9['app']['name']||'','version':_0x3f48b9['app']['version']||'','description':_0x3f48b9['app']['description']||'','metadata':{..._0x3f48b9['metadata'],'permissions':_0x3f48b9['permissions']},'body':_0x3f48b9['body'],'query':_0x3f48b9['query'],'params':_0x3f48b9?.['params'],'method':_0x3f48b9['method'],'pathname':_0x3f48b9['pathname'],'requestUrl':_0x3f48b9['requestUrl'],'user':_0x3f48b9['user'],'headers':_0x3826e9};}function f(_0x236b68){return _0x236b68['split']('/')['filter'](_0x53517f=>_0x53517f['length']>0x0);}function P(_0x368dcb,_0x32afb4){let _0x15bc3a=f(_0x368dcb),_0x305240=f(_0x32afb4),_0x32f2a3=0x0,_0x5a8855=0x0;for(;_0x32f2a3<_0x15bc3a['length']&&_0x5a8855<_0x305240['length'];){let _0x20e9be=_0x15bc3a[_0x32f2a3],_0x53f322=_0x305240[_0x5a8855];if(_0x20e9be==='*')return!![];if(_0x20e9be['startsWith'](':')){_0x32f2a3++,_0x5a8855++;continue;}if(_0x20e9be!==_0x53f322)return![];_0x32f2a3++,_0x5a8855++;}return _0x32f2a3===_0x15bc3a['length']&&_0x5a8855===_0x305240['length']||_0x32f2a3===_0x15bc3a['length']-0x1&&_0x15bc3a[_0x32f2a3]==='*';}function m(_0x52c08a,_0x5b6d2f,_0x58e249){let _0x53f855=_0x5b6d2f+'\x20'+_0x58e249;if(_0x52c08a[_0x53f855])return{'handler':_0x52c08a[_0x53f855],'routePattern':_0x58e249};let _0x37c7d4=[];_0x58e249['startsWith']('/api')?_0x37c7d4['push'](_0x58e249['substring'](0x4)||'/'):_0x37c7d4['push']('/api'+_0x58e249),_0x37c7d4['push'](_0x58e249);for(let _0x285fad of _0x37c7d4)for(let _0x36fe41 of Object['keys'](_0x52c08a)){if(!_0x36fe41['startsWith'](_0x5b6d2f+'\x20'))continue;let _0x3fda46=_0x36fe41['substring'](_0x5b6d2f['length']+0x1);if(P(_0x3fda46,_0x285fad))return{'handler':_0x52c08a[_0x36fe41],'routePattern':_0x3fda46};}return null;}function k(_0x5a456c){return typeof _0x5a456c=='function'?{'handler':_0x5a456c,'routePattern':''}:_0x5a456c;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0xe6b5a6){let _0x44f8f8=async _0x1e22af=>{try{let _0x23cb9a=globalThis['Deno'];if(!_0x23cb9a)throw new Error('Deno is not available');return await _0x23cb9a['stat'](_0x1e22af),!0x0;}catch{return![];}};if(_0xe6b5a6&&typeof _0xe6b5a6=='string'&&_0xe6b5a6['length']>0x0)return _0xe6b5a6;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x434e7b=s['manifest']?.['metadata']?.['serverPath'];if(_0x434e7b&&typeof _0x434e7b=='string'&&_0x434e7b['length']>0x0)return _0x434e7b;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x2fea46=s['manifest']['name'];if(!_0x2fea46)throw new Error('Manifest\x20name\x20not\x20found');let _0x56725b=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x2fea46+'/server.js',s['appsDir']+'/'+_0x2fea46+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x5292b8 of _0x56725b)if(await _0x44f8f8(_0x5292b8))return _0x5292b8;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x56725b['join'](',\x20'));}function R(){let _0x53d0c8=['log','info','warn','error','debug','trace'];for(let _0x2b396e of _0x53d0c8){let _0x52d696=(console[_0x2b396e]||console['log'])['bind'](console);console[_0x2b396e]=(..._0x5bd3af)=>{try{let _0xe3c858=_0x5bd3af['map'](_0x147fab=>{if(typeof _0x147fab=='string')return _0x147fab;if(_0x147fab instanceof Error)return JSON['stringify']({'name':_0x147fab['name'],'message':_0x147fab['message'],'stack':_0x147fab['stack']});if(typeof Request<'u'&&_0x147fab instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x147fab['url'],'method':_0x147fab['method'],'headers':Object['fromEntries'](_0x147fab['headers']['entries']()),'bodyUsed':_0x147fab['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x147fab instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x147fab['status'],'headers':Object['fromEntries'](_0x147fab['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x147fab);}catch{return String(_0x147fab);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x2b396e==='log'?'info':_0x2b396e,'message':_0xe3c858,'meta':{'appId':s['appId']}});}catch{_0x52d696(..._0x5bd3af);}};}}R();async function v(_0x14f501){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x3374ef=(await w(_0x14f501))['replace'](/\\/g,'/'),_0x1c45b6=(_0x3374ef['startsWith']('file://')?_0x3374ef:'file://'+_0x3374ef)+'?t='+Date['now']();try{let _0x1807a1=await import(_0x1c45b6);return s['module']=_0x1807a1,_0x1807a1;}catch(_0x177a24){throw console['error']('Failed to load module:',_0x177a24),_0x177a24;}}function b(_0x2f9a35){return _0x2f9a35 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x2f9a35,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x567ce4){return _0x567ce4['split']('/')['filter'](_0xae0c0e=>_0xae0c0e['length']>0x0);}function E(_0x3ed4f5){try{return decodeURIComponent(_0x3ed4f5);}catch{return _0x3ed4f5;}}function I(_0x278cae,_0x27985f){let _0x54dd9d=g(_0x278cae),_0x11fc2d=g(_0x27985f),_0x4d4baf={},_0x5613fb=0x0,_0xb18d71=0x0;for(;_0x5613fb<_0x54dd9d['length']&&_0xb18d71<_0x11fc2d['length'];){let _0x2e8455=_0x54dd9d[_0x5613fb],_0x10bb6b=_0x11fc2d[_0xb18d71];if(_0x2e8455==='*')break;if(_0x2e8455['startsWith'](':')){let _0x86319e=_0x2e8455['slice'](0x1);_0x86319e&&(_0x4d4baf[_0x86319e]=E(_0x10bb6b)),_0x5613fb++,_0xb18d71++;continue;}if(_0x2e8455!==_0x10bb6b)return{};_0x5613fb++,_0xb18d71++;}return _0x5613fb===_0x54dd9d['length']||_0x5613fb===_0x54dd9d['length']-0x1&&_0x54dd9d[_0x5613fb]==='*',_0x4d4baf;}function M(_0x5f2ff3,_0x36eb4b){return _0x5f2ff3['startsWith']('/api')&&!_0x36eb4b['startsWith']('/api')?_0x5f2ff3['substring'](0x4)||'/':!_0x5f2ff3['startsWith']('/api')&&_0x36eb4b['startsWith']('/api')?'/api'+(_0x5f2ff3['startsWith']('/')?'':'/')+_0x5f2ff3:_0x5f2ff3;}async function W(_0x56543d){let _0x47f9ca=_0x56543d['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x47f9ca)&&await v(_0x47f9ca);let _0x31f0e9=_0x56543d['ctx'],{method:_0x9f545b,pathname:_0x137fa1}=_0x31f0e9,_0x167159=s['module']?.['default']||{},_0xc68448=m(_0x167159,_0x9f545b,_0x137fa1);if(!_0xc68448)throw Object['assign'](new Error('Route\x20'+_0x9f545b+'\x20'+_0x137fa1+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x1c8e8c=k(_0xc68448),_0x14a9a1=c(_0x31f0e9,s),_0x5b49f6=_0x137fa1,_0x42d4ac=M(_0x1c8e8c['routePattern'],_0x5b49f6),_0x19afad=_0x42d4ac?I(_0x42d4ac,_0x5b49f6):{},_0x258895=await _0x1c8e8c['handler']({..._0x14a9a1,'params':{..._0x14a9a1['params'],..._0x19afad}});return b(_0x258895);}function D(_0x1a45aa){s['appId']=_0x1a45aa['appId'],s['manifest']=_0x1a45aa['manifest'],s['appsDir']=_0x1a45aa['appsDir'],s['serverPath']=_0x1a45aa['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x44e2a9){let {reqId:_0x4e3ef3,payload:_0x20b493}=_0x44e2a9;try{let _0x1ba684=await W(_0x20b493);self['postMessage']({'type':'result','reqId':_0x4e3ef3,'ok':!0x0,'response':_0x1ba684});}catch(_0x21d7b0){let _0x2272a9=_0x21d7b0;self['postMessage']({'type':'result','reqId':_0x4e3ef3,'ok':![],'error':{'message':_0x2272a9['message'],'stack':_0x2272a9['stack'],'code':_0x2272a9['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x20b22=>{let _0x199ecd=_0x20b22['data'];try{switch(_0x199ecd['type']){case'init':D(_0x199ecd);break;case'invoke':await $(_0x199ecd);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x199ecd['type']);break;}}catch(_0x2e6fcf){let _0x2309cc=_0x2e6fcf;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x2309cc['message'],'stack':_0x2309cc['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x2309cc);}}},self['onerror']=_0x14085f=>{let _0x1049f4={'message':typeof _0x14085f=='string'?_0x14085f:_0x14085f['message'],'filename':typeof _0x14085f=='string'?void 0x0:_0x14085f['filename'],'lineno':typeof _0x14085f=='string'?void 0x0:_0x14085f['lineno'],'colno':typeof _0x14085f=='string'?void 0x0:_0x14085f['colno'],'error':typeof _0x14085f=='string'?void 0x0:_0x14085f['error']?.['message'],'stack':typeof _0x14085f=='string'?void 0x0:_0x14085f['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x1049f4);},self['onunhandledrejection']=_0x47e10e=>{let _0x22deca=_0x47e10e['reason'],_0x1395c7={'appId':s['appId'],'reason':_0x22deca instanceof Error?_0x22deca['message']:String(_0x22deca),'stack':_0x22deca instanceof Error?_0x22deca['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x1395c7);};