'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x189de8){return _0x189de8&&_0x189de8['__esModule']?_0x189de8:{'default':_0x189de8};}var Y__default=_interopDefault(Y);async function ie(_0x4b6bce){try{return await promises['stat'](_0x4b6bce),!0x0;}catch{return![];}}var f={'error':(_0x21cefe,_0x32297c)=>console['error']('[ERROR]\x20'+_0x21cefe,_0x32297c),'warn':(_0x491b45,_0x549a09)=>console['warn']('[WARN]\x20'+_0x491b45,_0x549a09),'info':(_0x2ecd79,_0x5c51c0)=>console['log']('[INFO]\x20'+_0x2ecd79,_0x5c51c0),'debug':(_0x1f094c,_0x79494d)=>console['log']('[DEBUG]\x20'+_0x1f094c,_0x79494d)};function z(){let _0x490d0b=globalThis['Deno'];if(!_0x490d0b)throw new Error('Deno is not available');return _0x490d0b;}var D=class{constructor(_0x1ec42f,_0x2bd8b1='./lib',_0x255e84={}){this['manifest']=_0x1ec42f,this['libDir']=_0x2bd8b1,this['platformImports']=_0x255e84;}['buildPerms'](){let _0x32bd45=this['manifest']['permissions']||{},_0x3ec978={};return _0x32bd45['net']!==void 0x0&&(_0x3ec978['net']=_0x32bd45['net']===!![]?!![]:Array['isArray'](_0x32bd45['net'])?_0x32bd45['net']:[]),_0x32bd45['read']!==void 0x0&&(_0x3ec978['read']=_0x32bd45['read']===!![]?!![]:Array['isArray'](_0x32bd45['read'])?_0x32bd45['read']:[]),_0x32bd45['write']!==void 0x0&&(_0x3ec978['write']=_0x32bd45['write']===!![]?!![]:Array['isArray'](_0x32bd45['write'])?_0x32bd45['write']:[]),_0x32bd45['env']!==void 0x0&&(_0x3ec978['env']=_0x32bd45['env']===!![]?!![]:Array['isArray'](_0x32bd45['env'])?_0x32bd45['env']:[]),_0x32bd45['run']!==void 0x0&&(_0x3ec978['run']=_0x32bd45['run']===!![]?!![]:Array['isArray'](_0x32bd45['run'])?_0x32bd45['run']:[]),_0x32bd45['ffi']!==void 0x0&&(_0x3ec978['ffi']=_0x32bd45['ffi']===!![]?!![]:Array['isArray'](_0x32bd45['ffi'])?_0x32bd45['ffi']:[]),_0x32bd45['sys']!==void 0x0&&(_0x3ec978['sys']=_0x32bd45['sys']===!![]?!![]:Array['isArray'](_0x32bd45['sys'])?_0x32bd45['sys']:[]),_0x32bd45['hrtime']!==void 0x0&&(_0x3ec978['hrtime']=_0x32bd45['hrtime']),_0x3ec978;}['normalize'](_0x3315eb){return _0x3315eb===!![]?[]:Array['isArray'](_0x3315eb)?_0x3315eb:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x35b25c){return path.join(this['libDir'],_0x35b25c+'@*');}['getReadPaths'](){let _0x3d7b25=this['getImports']();_0x3d7b25['includes']('*')&&(_0x3d7b25=Object['keys'](this['platformImports']));let _0x1c889f=[];console['log']('[Permissions] Building package path patterns for imports:',_0x3d7b25);for(let _0x2d50a3 of _0x3d7b25){let _0x290368=this['getLibPattern'](_0x2d50a3);_0x1c889f['push'](_0x290368),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x2d50a3+'\x20->\x20'+_0x290368);}return console['log']('[Permissions] Final package path patterns:',_0x1c889f),_0x1c889f;}['buildImportMap'](_0x1d7501){let _0x3f311b=this['getImports'](),_0x56a1ab=_0x3f311b['includes']('*')?Object['keys'](_0x1d7501):_0x3f311b;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x56a1ab);let _0x471519={};for(let _0x1adde3 of _0x56a1ab)if(_0x1d7501[_0x1adde3])_0x471519[_0x1adde3]=_0x1d7501[_0x1adde3],console['log']('[ImportMap]\x20'+_0x1adde3+'\x20->\x20'+_0x1d7501[_0x1adde3]+'\x20(from\x20platform)');else try{let _0x262ba6=z(),_0x54b666=path.join(_0x262ba6['cwd'](),this['libDir']),_0x22d361=!0x1;try{for(let _0x8e08f3 of _0x262ba6['readDirSync'](_0x54b666))if(_0x8e08f3['isDirectory']&&(_0x8e08f3['name']===_0x1adde3||_0x8e08f3['name']['startsWith'](_0x1adde3+'@'))){let _0x49c8ef=path.join(_0x262ba6['cwd'](),this['libDir'],_0x8e08f3['name'],'index.js')['replace'](/\\/g,'/'),_0x3df9de=new URL('file:///'+_0x49c8ef)['href'];_0x471519[_0x1adde3]=_0x3df9de,console['log']('[ImportMap]\x20'+_0x1adde3+'\x20->\x20'+_0x3df9de+'\x20(from\x20lib)'),_0x22d361=!0x0;break;}}catch{}_0x22d361||console['warn']('[ImportMap]\x20Package\x20'+_0x1adde3+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x48c3d9){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x1adde3+':',_0x48c3d9);}return _0x471519;}['validateServerImports'](_0x19d919){let _0xe06c9=this['manifest']['name']||this['manifest']['id'],_0x4b664d=this['manifest']['metadata']?.['serverPath'],_0x2fbea7=_0x1468cf=>_0x1468cf['replace'](/\\/g,'/'),_0xff02e0=z(),_0x489434=_0x27a3fe=>{try{return _0xff02e0['statSync'](_0x27a3fe),!0x0;}catch{return![];}},_0x52e868=_0x4b664d?_0x2fbea7(_0x4b664d):void 0x0;if(!_0x52e868){let _0x2a824a=[_0x19d919+'/service/server.js',_0x19d919+'/service/server.ts',_0x19d919+'/'+_0xe06c9+'/server.js',_0x19d919+'/'+_0xe06c9+'/server.ts',_0x19d919+'/server.js',_0x19d919+'/server.ts']['map'](_0x2fbea7);for(let _0x2dfa8c of _0x2a824a)if(_0x489434(_0x2dfa8c)){_0x52e868=_0x2dfa8c;break;}}if(!_0x52e868)return{'valid':![],'violations':['Failed to locate server module']};let _0x3e0b6f='';try{_0x3e0b6f=_0xff02e0['readTextFileSync'](_0x52e868);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x52e868};}let _0x26d05d=this['getImports']();if(_0x26d05d['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x52e868};let _0x331366=_0x26d05d,_0xed6c07=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x43ab2c=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0xed6200=/\bimport\s*['"]([^'"]+)['"]/g,_0x1f6199=[],_0x2b91e4=new Set(),_0x19394b=_0x2c6c6a=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x2c6c6a),_0x363f8d=_0x3f7d22=>{let _0x5747f2=_0x3f7d22;if(_0x5747f2['startsWith']('./')||_0x5747f2['startsWith']('../')||_0x5747f2['startsWith']('/')||_0x5747f2['startsWith']('file://')||!_0x19394b(_0x3f7d22)||_0x2b91e4['has'](_0x3f7d22))return;_0x2b91e4['add'](_0x3f7d22),_0x5747f2['startsWith']('npm:')&&(_0x5747f2=_0x5747f2['substring'](0x4)),_0x5747f2['includes']('@')&&!_0x5747f2['startsWith']('@')&&(_0x5747f2=_0x5747f2['split']('@')[0x0]);let _0x26b0f2=_0x5747f2['split']('/')[0x0];_0x331366['includes'](_0x26b0f2)||_0x331366['includes'](_0x3f7d22)||_0x1f6199['push'](_0x3f7d22);},_0x57c2a5;for(;(_0x57c2a5=_0xed6c07['exec'](_0x3e0b6f))!==null;)_0x363f8d(_0x57c2a5[0x1]);for(;(_0x57c2a5=_0x43ab2c['exec'](_0x3e0b6f))!==null;)_0x363f8d(_0x57c2a5[0x1]);for(;(_0x57c2a5=_0xed6200['exec'](_0x3e0b6f))!==null;)_0x363f8d(_0x57c2a5[0x1]);return{'valid':_0x1f6199['length']===0x0,'violations':_0x1f6199,'serverPath':_0x52e868};}['validate'](_0x259575={}){let _0x59b60a=[],_0x1c15e3=this['manifest']['permissions']||{};try{let _0x4c6501=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x4c6501);}catch{}let _0x3366cd=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x315165,_0x11935b]of Object['entries'](_0x1c15e3))if(_0x315165==='hrtime')typeof _0x11935b!='boolean'&&_0x59b60a['push']('Permission\x20\x27'+_0x315165+'\x27\x20must\x20be\x20boolean');else{if(_0x315165==='langchain')typeof _0x11935b!='boolean'&&(typeof _0x11935b!='object'||_0x11935b===null)?_0x59b60a['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x11935b=='object'&&(_0x11935b===null||!('enabled'in _0x11935b)||typeof _0x11935b['enabled']!='boolean')&&_0x59b60a['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x315165==='kv')typeof _0x11935b!='boolean'&&_0x59b60a['push']('Permission\x20\x27'+_0x315165+'\x27\x20must\x20be\x20boolean');else{if(_0x315165==='mspbots')Array['isArray'](_0x11935b)||_0x59b60a['push']('Permission\x20\x27'+_0x315165+'\x27\x20must\x20be\x20an\x20array');else{if(_0x315165==='db'){if(typeof _0x11935b!='object'||_0x11935b===null||Array['isArray'](_0x11935b))_0x59b60a['push']('Permission\x20\x27'+_0x315165+'\x27\x20must\x20be\x20an\x20object');else{let _0x291e2f=_0x11935b,_0x2632b5=['user','password']['filter'](_0x54fdbb=>!(_0x54fdbb in _0x291e2f));_0x2632b5['length']>0x0&&_0x59b60a['push']('Permission\x20\x27'+_0x315165+'\x27\x20missing\x20required\x20fields:\x20'+_0x2632b5['join'](',\x20'));}}else{if(_0x315165==='imports')continue;_0x3366cd['has'](_0x315165)||typeof _0x11935b!='boolean'&&!Array['isArray'](_0x11935b)&&_0x59b60a['push']('Permission\x20\x27'+_0x315165+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x4db913=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x4db913))_0x59b60a['push']('permissions.imports must be an array');else{for(let _0x33830e of _0x4db913)typeof _0x33830e!='string'&&_0x59b60a['push']('import\x20\x27'+_0x33830e+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x59b60a['length']===0x0,'errors':_0x59b60a};}};function q(_0x9ae4da,_0x24b11b,_0x2a4b4a){return new D(_0x9ae4da,_0x24b11b,_0x2a4b4a||{});}var R=null;function I(){let _0x44488b=globalThis['Deno'];if(!_0x44488b)throw new Error('Deno is not available');return _0x44488b;}async function K(){if(R)return{...R};try{let _0x1c8a50=I(),_0x51aa81=path.join(_0x1c8a50['cwd'](),'deno.json'),_0x9ded2b=await _0x1c8a50['readTextFile'](_0x51aa81);return R=JSON['parse'](_0x9ded2b)['imports']||{},{...R};}catch(_0x4e709d){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x4e709d),{};}}var E=class{constructor(_0x303785,_0x58ab3d={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x303785['appsDir'],this['platformImportsOverride']=_0x303785['platformImports'],this['libDir']=_0x303785['libDir'],this['events']=_0x58ab3d);}async['create'](_0x39c001,_0x154492,_0x54b311){try{return await this['createWorker'](_0x39c001,_0x154492,_0x54b311);}catch(_0x186b90){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x39c001+':',_0x186b90),_0x186b90;}}async['createWorker'](_0x147f28,_0x45113e,_0x88664c){let _0x2eccca=this['platformImportsOverride']||await K(),_0x5e7b81=q(_0x45113e,this['libDir'],_0x2eccca)['validateServerImports'](this['appsDir']);if(!_0x5e7b81['valid']){let _0x2f06c0=_0x5e7b81['violations']['filter'](_0x8134de=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x8134de)),_0x4276d4=_0x5e7b81['serverPath']?_0x5e7b81['serverPath']:(_0x45113e['name']||_0x45113e['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x4276d4+':\x20'+_0x2f06c0['join'](',\x20'));}let _0x429cda=q(_0x45113e,this['libDir'],_0x2eccca),_0x5dd623=_0x429cda['validate'](_0x2eccca);if(!_0x5dd623['valid'])throw new Error('Invalid\x20config:\x20'+_0x5dd623['errors']['join'](',\x20'));let _0x3bcdc2=_0x429cda['buildImportMap'](_0x2eccca);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x147f28+':',_0x3bcdc2);let _0x27f440=_0x429cda['buildPerms'](),_0x3bdc33=_0x429cda['getReadPaths']();if(_0x27f440['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x27f440['read']);else{let _0x378eb1=_0x45113e['name']||_0x147f28,_0x318355=this['appsDir']+'/'+_0x378eb1,_0x23a223=[_0x318355],_0x143e7c=_0x45113e['metadata']?.['serverPath'];if(_0x143e7c&&typeof _0x143e7c=='string')try{let _0x18df06=path.dirname(_0x143e7c)['replace'](/\\/g,'/');_0x23a223['push'](_0x18df06);}catch{}_0x27f440['read']=_0x23a223,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x318355);}if(_0x3bdc33['length']>0x0){if(_0x27f440['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x2beaec=Array['isArray'](_0x27f440['read'])?_0x27f440['read']:[];_0x27f440['read']=[..._0x2beaec,..._0x3bdc33],console['log']('[Worker] Added package read permissions:',_0x3bdc33);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x27f440['net']||(_0x27f440['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x147f28+':',_0x27f440['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x27f440['read']===!![]?'unrestricted':Array['isArray'](_0x27f440['read'])?_0x27f440['read']['length']:0x0));let _0x52500f=await this['createImportMap'](_0x147f28,_0x3bcdc2),_0x3c21b1=await this['createLock'](_0x147f28,_0x3bcdc2),_0x26558f={'type':'module','deno':{'permissions':{}}};_0x26558f['deno']['namespace']=![],_0x26558f['deno']['permissions']=_0x27f440,_0x26558f['deno']['importMap']=_0x52500f,_0x26558f['deno']['lock']=_0x3c21b1,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x147f28+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x52500f),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x3c21b1),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x3bcdc2)['length']+'\x20('+(Object['keys'](_0x3bcdc2)['join'](',\x20')||'none')+')');let _0x2461a9={'worker':new Worker(_0x88664c,_0x26558f),'appId':_0x147f28,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x45113e,'importMapPath':_0x52500f,'lockfilePath':_0x3c21b1};return this['workers']['set'](_0x147f28,_0x2461a9),this['events']['onCreate']?.(_0x2461a9),_0x2461a9;}async['createLock'](_0xafa6a8,_0x5b452c){let _0x1cb612=I(),_0x1022f3=path.join(_0x1cb612['cwd'](),'storage','temp','lockfiles');await _0x1cb612['mkdir'](_0x1022f3,{'recursive':!![]});let _0x359dd7=_0xafa6a8+'-'+Date['now']()+'.lock',_0x46401a=path.join(_0x1022f3,_0x359dd7),_0x4708b6={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x434146,_0x57fe16]of Object['entries'](_0x5b452c))if(_0x57fe16['startsWith']('npm:'))_0x57fe16['replace']('npm:',''),_0x4708b6['packages']['specifiers'][_0x434146]=_0x57fe16;else _0x57fe16['startsWith']('file://')&&(_0x4708b6['packages']['specifiers'][_0x434146]=_0x57fe16);let _0x228e63=JSON['stringify'](_0x4708b6,null,0x2);return await _0x1cb612['writeTextFile'](_0x46401a,_0x228e63),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x46401a),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x5b452c)['length']+'):',Object['keys'](_0x5b452c)),_0x46401a;}async['createImportMap'](_0x54ea6b,_0x1e2882){let _0x582ca2=I(),_0x32d133=path.join(_0x582ca2['cwd'](),'storage','temp','importmaps');await _0x582ca2['mkdir'](_0x32d133,{'recursive':!![]});let _0x2dba12=_0x54ea6b+'-'+Date['now']()+'.json',_0x2637ac=path.join(_0x32d133,_0x2dba12),_0x1430f9=JSON['stringify']({'imports':_0x1e2882,'scopes':{}},null,0x2);return await _0x582ca2['writeTextFile'](_0x2637ac,_0x1430f9),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x2637ac),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x1e2882)['length']+'):',Object['keys'](_0x1e2882)['join'](',\x20')||'none'),_0x2637ac;}['get'](_0x395235){return this['workers']['get'](_0x395235);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x30c973,_0x1e20eb){let _0x159cc5=this['workers']['get'](_0x30c973);if(!_0x159cc5)return;let _0x224509=_0x159cc5['status'];_0x159cc5['status']=_0x1e20eb,_0x1e20eb==='running'&&_0x224509==='starting'?this['events']['onReady']?.(_0x159cc5):_0x1e20eb==='crashed'&&this['events']['onCrash']?.(_0x159cc5);}['touch'](_0x2d78f3){let _0x397635=this['workers']['get'](_0x2d78f3);_0x397635&&(_0x397635['lastUsed']=Date['now']());}async['stop'](_0x53873a){let _0x121d68=this['workers']['get'](_0x53873a);if(_0x121d68)try{_0x121d68['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x121d68['worker']['terminate'](),_0x121d68['status']='stopped',this['events']['onStop']?.(_0x121d68),_0x121d68['importMapPath']&&await this['cleanupImportMap'](_0x121d68['importMapPath']),_0x121d68['lockfilePath']&&await this['cleanupLock'](_0x121d68['lockfilePath']);}catch(_0x554fe1){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x53873a+':',_0x554fe1);}finally{this['workers']['delete'](_0x53873a);}}async['cleanupImportMap'](_0x3d83e9){try{await I()['remove'](_0x3d83e9),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x3d83e9);}catch(_0x455082){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x3d83e9,_0x455082);}}async['cleanupLock'](_0x4c3e74){try{await I()['remove'](_0x4c3e74),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x4c3e74);}catch(_0x2efebc){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x4c3e74,_0x2efebc);}}async['stopAll'](){let _0x3309e1=Array['from'](this['workers']['keys']());await Promise['all'](_0x3309e1['map'](_0x348e6b=>this['stop'](_0x348e6b)));}async['restart'](_0x37abe7,_0x2ddd97){let _0x5c6564=this['workers']['get'](_0x37abe7);if(!_0x5c6564)throw new Error('Worker\x20'+_0x37abe7+'\x20not\x20found');let _0x52b26f=_0x5c6564['manifest'];return await this['stop'](_0x37abe7),await this['create'](_0x37abe7,_0x52b26f,_0x2ddd97);}['checkHealth'](_0x4400ba){let _0x388065=this['workers']['get'](_0x4400ba);if(!_0x388065)return{'healthy':![],'reason':'Not\x20found'};if(_0x388065['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x388065['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x3213e1=Date['now']()-_0x388065['lastUsed'],_0x382a59=0x708*0x3e8;return _0x3213e1>_0x382a59?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x3213e1/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x37dca6=0x708*0x3e8,_0x25c5e2){let _0x5959de=Date['now'](),_0x3de3f6=[];for(let [_0x1761e4,_0x25a241]of this['workers']['entries']()){let _0x1d29f8=_0x5959de-_0x25a241['lastUsed'];_0x1d29f8>_0x37dca6&&_0x3de3f6['push']({'appId':_0x1761e4,'idle':_0x1d29f8});}_0x3de3f6['sort']((_0x29085b,_0x243c86)=>_0x243c86['idle']-_0x29085b['idle']);let _0x3bd9d0=_0x25c5e2?_0x3de3f6['slice'](0x0,_0x25c5e2)['map'](_0x466719=>_0x466719['appId']):_0x3de3f6['map'](_0x15b48a=>_0x15b48a['appId']);for(let _0x52b254 of _0x3bd9d0)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x52b254),await this['stop'](_0x52b254);}['stats'](){let _0x2759f4={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x37acbd=Date['now']();for(let _0x373e89 of this['workers']['values']())_0x2759f4['byStatus'][_0x373e89['status']]++,_0x2759f4['workers']['push']({'appId':_0x373e89['appId'],'status':_0x373e89['status'],'version':_0x373e89['version'],'lastUsed':_0x373e89['lastUsed'],'idle':_0x37acbd-_0x373e89['lastUsed']});return _0x2759f4;}['startCleanup'](_0x429161=0x12c*0x3e8,_0x42c82b){let _0x4b02ae=setInterval(()=>{this['cleanup'](_0x42c82b)['catch'](_0x1a278c=>{console['error']('Cleanup\x20failed:',_0x1a278c);});},_0x429161);return()=>clearInterval(_0x4b02ae);}['delay'](_0x6ad103){return new Promise(_0x52d09b=>setTimeout(_0x52d09b,_0x6ad103));}};function W(_0x1470e1,_0x4147c9){return new E(_0x1470e1,_0x4147c9);}var v=f,j=class{constructor(_0x39b10d,_0x2f0b6a=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x39b10d,this['timeout']=_0x2f0b6a);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x4bdc91){_0x4bdc91['worker']['onmessage']=_0x2ff338=>{let _0x450738=_0x2ff338['data'],{appId:_0x3983b3}=_0x4bdc91;switch(_0x450738['type']){case'ready':this['events']['onReady'](_0x3983b3),v['info']('Worker\x20ready',{'appId':_0x3983b3,'version':_0x4bdc91['version']});break;case'log':{let {level:_0x57e54f='info',message:_0x50564b,meta:_0x997226}=_0x450738,_0x1de51a={..._0x997226||{},'appId':_0x3983b3,'version':_0x4bdc91['version']};this['events']['onLog'](_0x3983b3,_0x57e54f,_0x50564b,_0x1de51a);break;}case'result':{let {reqId:_0x5d2332,ok:_0x3d4696,response:_0x50cc22,error:_0x1f5ad4}=_0x450738,_0xd75e0e=this['pending']['get'](_0x5d2332);if(!_0xd75e0e){v['warn']('Unknown\x20request',{'appId':_0x3983b3,'reqId':_0x5d2332});return;}if(this['pending']['delete'](_0x5d2332),_0x3d4696&&_0x50cc22)_0xd75e0e['resolve'](_0x50cc22);else{let _0x597ca9=new Error(_0x1f5ad4?.['message']||'Worker\x20error');_0x597ca9['stack']=_0x1f5ad4?.['stack'],_0xd75e0e['reject'](_0x597ca9);}this['events']['onResult'](_0x3983b3,_0x5d2332,_0x50cc22||_0x1f5ad4);break;}default:v['debug']('Unknown\x20message',{'appId':_0x3983b3,'type':_0x450738['type']});}},_0x4bdc91['worker']['onerror']=_0x2b865f=>{let {appId:_0xd23ed9}=_0x4bdc91;v['error']('Worker\x20error',{'appId':_0xd23ed9,'message':_0x2b865f['message'],'lineno':_0x2b865f['lineno'],'filename':_0x2b865f['filename']}),_0x4bdc91['status']='crashed',this['rejectPending'](_0xd23ed9,new Error('Worker\x20'+_0xd23ed9+'\x20crashed:\x20'+_0x2b865f['message'])),_0x2b865f['preventDefault']();},_0x4bdc91['worker']['onmessageerror']=_0x4df34f=>{let {appId:_0x125239}=_0x4bdc91;v['error']('Message\x20error',{'appId':_0x125239,'data':_0x4df34f['data']}),_0x4bdc91['status']='crashed',_0x4df34f['preventDefault']();};}['sendInit'](_0x540693,_0x35072f,_0x2d33f1,_0x459ac5){_0x540693['worker']['postMessage']({'type':'init','appId':_0x540693['appId'],'manifest':_0x2d33f1,'appsDir':_0x35072f,'serverPath':_0x459ac5});}async['sendInvoke'](_0x116d90,_0x2fb941){let _0x3c12b4=this['nextId'](),_0x5cc6a7=_0x116d90['appId'],_0x254f19=new Promise((_0x19fd3a,_0x14f54c)=>{let _0x36c726=setTimeout(()=>{this['pending']['delete'](_0x3c12b4),_0x14f54c(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x3c12b4,{'resolve':_0x2b74ba=>{clearTimeout(_0x36c726),_0x19fd3a(_0x2b74ba);},'reject':_0x253971=>{clearTimeout(_0x36c726),_0x14f54c(_0x253971);},'timestamp':Date['now'](),'appId':_0x5cc6a7});});return _0x116d90['worker']['postMessage']({'type':'invoke','appId':_0x116d90['appId'],'reqId':_0x3c12b4,'payload':_0x2fb941}),await _0x254f19;}['rejectPending'](_0x9ce772,_0x1a8813){let _0x4c29d9=0x0;for(let [_0x4a4811,_0x318297]of this['pending']['entries']())_0x318297['appId']===_0x9ce772&&(this['pending']['delete'](_0x4a4811),_0x318297['reject'](_0x1a8813),_0x4c29d9++);_0x4c29d9>0x0&&v['warn']('Rejected\x20'+_0x4c29d9+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x9ce772});}['cleanupTimeout'](){let _0x1333a7=Date['now']();for(let [_0x5883ab,_0x30be54]of this['pending']['entries']())_0x1333a7-_0x30be54['timestamp']>this['timeout']&&(this['pending']['delete'](_0x5883ab),_0x30be54['reject'](new Error('Request\x20'+_0x5883ab+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x5a7930){let _0x1bd0ad=0x0;for(let _0x8cd6e1 of this['pending']['values']())_0x8cd6e1['appId']===_0x5a7930&&_0x1bd0ad++;return _0x1bd0ad;}['startCleanup'](_0x257265=0x2710){let _0x1d54d9=setInterval(()=>{this['cleanupTimeout']();},_0x257265);return()=>clearInterval(_0x1d54d9);}};function $(_0x5da1c4,_0x129e32){return new j(_0x5da1c4,_0x129e32);}var Q=class{constructor(_0x151fcd={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x151fcd['logger']||f,this['config']={'appsDir':_0x151fcd['appsDir']||this['getAppsDir'](),'scriptUrl':_0x151fcd['scriptUrl']||this['getScriptUrl'](),'timeout':_0x151fcd['timeout']||0x78*0x3e8,'autoCleanup':_0x151fcd['autoCleanup']??!![],'cleanupInterval':_0x151fcd['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x151fcd['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x151fcd['maxWorkers'],'reuseWorkers':_0x151fcd['reuseWorkers']??!![],'workerReuseStrategy':_0x151fcd['workerReuseStrategy']||'lru','enableQueue':_0x151fcd['enableQueue']??!![],'maxQueueSize':_0x151fcd['maxQueueSize']||0x64,'queueTimeout':_0x151fcd['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x40e884=>this['logger']['info']('Worker\x20created',{'appId':_0x40e884['appId'],'v':_0x40e884['version']}),'onReady':_0x3ed524=>this['lifecycle']['updateStatus'](_0x3ed524['appId'],'running'),'onCrash':_0x415ae5=>this['logger']['error']('Worker\x20crashed',{'appId':_0x415ae5['appId'],'v':_0x415ae5['version']}),'onStop':_0x3b3a52=>this['logger']['info']('Worker\x20stopped',{'appId':_0x3b3a52['appId'],'v':_0x3b3a52['version']})}),this['messaging']=$({'onReady':_0x5ab865=>this['lifecycle']['updateStatus'](_0x5ab865,'running'),'onLog':(_0x3864fe,_0x1d32d8,_0x536ac3,_0x115c61)=>{let _0x5cb50d={..._0x115c61||{},'appId':_0x3864fe};switch(_0x1d32d8){case'error':this['logger']['error'](_0x536ac3,_0x5cb50d);break;case'warn':this['logger']['warn'](_0x536ac3,_0x5cb50d);break;case'debug':this['logger']['debug'](_0x536ac3,_0x5cb50d);break;default:this['logger']['info'](_0x536ac3,_0x5cb50d);break;}},'onResult':(_0x4665f2,_0x3a957a,_0x3bbb88)=>{this['logger']['debug']('Result\x20received',{'appId':_0x4665f2,'reqId':_0x3a957a});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x149ead=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x17c29e=_0x149ead['endsWith']('.js')||_0x149ead['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x17c29e,_0x149ead)['href'];}async['ensure'](_0x5c5642){let {id:_0x42f449}=_0x5c5642,_0x5b8711=this['lifecycle']['get'](_0x42f449);if(_0x5b8711){let _0x4a9ff7=this['lifecycle']['checkHealth'](_0x42f449);if(_0x4a9ff7['healthy'])return this['lifecycle']['touch'](_0x42f449),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x42f449}),_0x5b8711;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x42f449,'reason':_0x4a9ff7['reason']}),await this['lifecycle']['stop'](_0x42f449);}for(;;){let _0x487d33=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x487d33>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x487d33,'max':this['config']['maxWorkers'],'appId':_0x42f449}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x5c5642);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x17c884=await this['loadManifest'](_0x42f449,_0x5c5642['manifest']),_0x5ea84a=await this['lifecycle']['create'](_0x42f449,_0x17c884,this['config']['scriptUrl']),_0x4f63db=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x4f63db>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x4f63db,'max':this['config']['maxWorkers'],'appId':_0x42f449}),await this['lifecycle']['stop'](_0x42f449),this['config']['enableQueue'])return await this['waitSlot'](_0x5c5642);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x4f63db+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x5ea84a);let _0x147061=_0x17c884['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x5ea84a,this['config']['appsDir'],_0x17c884,_0x147061),this['logger']['info']('Worker\x20created',{'appId':_0x42f449,'v':_0x5ea84a['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x5ea84a;}async['evictIdle'](){let _0x22de62=this['lifecycle']['getAll']();if(_0x22de62['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x2edbaf=[..._0x22de62];this['config']['workerReuseStrategy']==='lru'?_0x2edbaf['sort']((_0x334a0b,_0x6a12bc)=>_0x334a0b['lastUsed']-_0x6a12bc['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x2edbaf['sort']((_0xc6db30,_0x43fa85)=>_0xc6db30['version']-_0x43fa85['version']);let _0x5c327e=null;for(let _0x5a8567 of _0x2edbaf)if(this['messaging']['getAppCount'](_0x5a8567['appId'])===0x0){_0x5c327e=_0x5a8567;break;}if(!_0x5c327e&&_0x2edbaf['length']>0x0&&(_0x5c327e=_0x2edbaf['reduce']((_0x455b06,_0x2548f5)=>{let _0x55b317=this['messaging']['getAppCount'](_0x455b06['appId']);return this['messaging']['getAppCount'](_0x2548f5['appId'])<_0x55b317?_0x2548f5:_0x455b06;})),_0x5c327e){let _0x345b73=this['messaging']['getAppCount'](_0x5c327e['appId']);return _0x345b73>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x5c327e['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x5c327e['lastUsed'],'pendingRequests':_0x345b73}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x5c327e['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x5c327e['lastUsed']}),await this['lifecycle']['stop'](_0x5c327e['appId']),!![];}return![];}['waitSlot'](_0x35da2b){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x19c93f,_0x409f1f)=>{let _0x5969a1={'info':_0x35da2b,'resolve':_0x19c93f,'reject':_0x409f1f,'timestamp':Date['now']()};this['requestQueue']['push'](_0x5969a1),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x35da2b['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x489029=setTimeout(()=>{let _0x45797f=this['requestQueue']['indexOf'](_0x5969a1);_0x45797f!==-0x1&&(this['requestQueue']['splice'](_0x45797f,0x1),_0x409f1f(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x5969a1['resolve']=_0x6b44c3=>{clearTimeout(_0x489029),_0x19c93f(_0x6b44c3);},_0x5969a1['reject']=_0x404561=>{clearTimeout(_0x489029),_0x409f1f(_0x404561);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x7d93e2=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x7d93e2>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x1ef601=this['requestQueue']['shift']();if(!_0x1ef601)break;try{let _0x2b59ee=await this['ensure'](_0x1ef601['info']);_0x1ef601['resolve'](_0x2b59ee);}catch(_0x1178cf){_0x1ef601['reject'](_0x1178cf);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x2cb028,_0x253f0d){let _0x29afbb=this['config']['appsDir']['replace'](/\\/g,'/'),_0x4737ee=async _0x35cef1=>{try{let _0x513807=globalThis['Deno'];if(!_0x513807)return null;let _0x270347=await _0x513807['readTextFile'](_0x35cef1);return JSON['parse'](_0x270347);}catch{return null;}};if(_0x253f0d?.['name']){let _0x289da9=await _0x4737ee(_0x29afbb+'/'+_0x253f0d['name']+'/manifest.json');if(_0x289da9)return _0x289da9;}let _0x25e8c3=await _0x4737ee(_0x29afbb+'/'+_0x2cb028+'/manifest.json');if(_0x25e8c3)return _0x25e8c3;try{let _0x8c6a39=globalThis['Deno'];if(_0x8c6a39)for await(let _0x31b88f of _0x8c6a39['readDir'](_0x29afbb)){if(!_0x31b88f['isDirectory'])continue;let _0x1d1298=_0x29afbb+'/'+_0x31b88f['name']+'/manifest.json',_0x2854f9=await _0x4737ee(_0x1d1298);if(_0x2854f9&&(_0x2854f9['id']===_0x2cb028||_0x253f0d?.['name']&&_0x2854f9['name']===_0x253f0d['name']))return _0x2854f9;}}catch(_0x59ad5b){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x2cb028,'error':_0x59ad5b['message']});}return _0x253f0d||{'id':_0x2cb028,'name':_0x2cb028,'version':'1.0.0'};}async['invoke'](_0x2d5a03){let _0x227e03=_0x2d5a03['ctx']['app']['id'],_0x3c50c1=_0x2d5a03['ctx']['app']['name'];try{let _0x4e862c={'id':_0x227e03,'manifest':{'id':_0x227e03,'name':_0x3c50c1}},_0x2f0a95=await this['ensure'](_0x4e862c);if(_0x2f0a95['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x227e03}),await this['restart'](_0x227e03);let _0x10ddf7=await this['ensure'](_0x4e862c);return this['lifecycle']['touch'](_0x227e03),await this['messaging']['sendInvoke'](_0x10ddf7,_0x2d5a03);}return this['lifecycle']['touch'](_0x227e03),await this['messaging']['sendInvoke'](_0x2f0a95,_0x2d5a03);}catch(_0xfd4ebe){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x227e03,'error':_0xfd4ebe['message'],'stack':_0xfd4ebe['stack']}),_0xfd4ebe;}}async['stop'](_0xbecf4e){await this['lifecycle']['stop'](_0xbecf4e),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x494742){return await this['lifecycle']['restart'](_0x494742,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x45591d=>({'appId':_0x45591d['appId'],'status':_0x45591d['status'],'version':_0x45591d['version'],'lastUsed':_0x45591d['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x3f89b7=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x33e7ce=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x3f89b7(),_0x33e7ce();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x13c49d=>{_0x13c49d?(await this['stop'](_0x13c49d),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x13c49d})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x5a9a7e){return new Q(_0x5a9a7e);}var S=null;function be(_0x53d98a){S=ee(_0x53d98a);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x1f0778){return await k()['ensure'](_0x1f0778);}async function xe(_0x448e74){return await k()['invoke'](_0x448e74);}function Ie(_0x55f156){k()['stop'](_0x55f156)['catch'](_0x3be46a=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x55f156,'error':_0x3be46a['message']});});}function Re(){k()['stopAll']()['catch'](_0x12ace0=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x12ace0['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x57f08f){await k()['stop'](_0x57f08f);}async function Se(){await k()['stopAll']();}function Ae(_0x421e32){let _0x5d15b7=_0x421e32&&typeof _0x421e32=='object'?_0x421e32:null;if(_0x5d15b7&&'user'in _0x5d15b7)return _0x5d15b7['user'];}function H(_0xb22915){let _0x63b8ef=_0xb22915&&typeof _0xb22915=='object'?_0xb22915:null;if(!_0x63b8ef)return{};let _0x1c066c={};for(let [_0x2ae6b2,_0x42882d]of Object['entries'](_0x63b8ef))_0x2ae6b2!=='user'&&(_0x1c066c[_0x2ae6b2]=_0x42882d);return _0x1c066c;}function O(_0x43e682){return _0x43e682?{'id':_0x43e682['manifest']?.['id']||_0x43e682['id']||'','name':_0x43e682['manifest']?.['name']||'','version':_0x43e682['manifest']?.['version']||'','description':_0x43e682['manifest']?.['description']||'','icon':_0x43e682['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x520ab8){return _0x520ab8?.['permissions']||_0x520ab8?.['manifest']?.['permissions']||{};}function F(_0x5ee49d){return _0x5ee49d?.['manifest']?.['metadata']||{};}function Ce(_0xc50274){return _0xc50274?{'appId':_0xc50274['id'],'appName':_0xc50274['manifest']?.['name']}:{};}function N(_0x4fe63e,_0x9358d9={}){let {appInfo:_0x1f84d8=null,status:_0x58de9f=0x1f4,defaultMessage:_0x2929c9='Internal\x20Server\x20Error'}=_0x9358d9,_0x5710ed={'error':_0x2929c9,'message':_0x4fe63e?.['message']||_0x2929c9};return _0x1f84d8&&(_0x5710ed['appId']=_0x1f84d8['id'],_0x5710ed['appName']=_0x1f84d8['manifest']?.['name']),_0x4fe63e?.['message']?.['includes']('crashed')&&(_0x5710ed['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x58de9f,'body':_0x5710ed};}function qe(_0x23bd10){return _0x23bd10?.['message']?.['includes']('crashed')||![];}function J(_0x272bad){if(_0x272bad)try{return JSON['parse'](_0x272bad);}catch{return _0x272bad;}}function B(_0x466c99){try{let _0x191b0c=new URL(_0x466c99),_0xe78b3c={};for(let _0x3ee941 of _0x191b0c['searchParams']['keys']()){let _0x2325ef=_0x191b0c['searchParams']['getAll'](_0x3ee941)['map'](_0x1c722a=>_0x1c722a);_0x2325ef['length']<=0x1?_0xe78b3c[_0x3ee941]=_0x2325ef[0x0]??'':_0xe78b3c[_0x3ee941]=_0x2325ef;}return _0xe78b3c;}catch{return{};}}function Le(_0x102ad9){return(()=>{try{return new URL(_0x102ad9)['pathname'];}catch{return _0x102ad9;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x51dd5f,_0x52e87b){let _0x560e43=_0x51dd5f;if(_0x52e87b&&_0x560e43['startsWith']('/apps/'+_0x52e87b))_0x560e43=_0x560e43['substring'](('/apps/'+_0x52e87b)['length'])||'/';else{let _0x3f8fa6=_0x560e43['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x3f8fa6&&(_0x560e43=_0x3f8fa6[0x1]||'/');}return _0x560e43['startsWith']('/api')&&(_0x560e43=_0x560e43['substring'](0x4)||'/'),_0x560e43;}function Ue(_0x422c09,_0x4f81ba){let _0x2422fd=_0x422c09;if(_0x4f81ba&&_0x2422fd['startsWith']('/apps/'+_0x4f81ba))_0x2422fd=_0x2422fd['substring'](('/apps/'+_0x4f81ba)['length'])||'/';else{let _0x17516d=_0x2422fd['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x17516d&&(_0x2422fd=_0x17516d[0x1]||'/');}return(!_0x2422fd||_0x2422fd==='/')&&(_0x2422fd='/index.html'),_0x2422fd;}async function He(_0xd02f27,_0x100a63){return await _0x100a63(_0xd02f27);}function _(_0x39f23a){return _0x39f23a['split']('/')['filter'](_0x2eb7d7=>_0x2eb7d7['length']>0x0);}function te(_0x4ad80d){try{return decodeURIComponent(_0x4ad80d);}catch{return _0x4ad80d;}}function re(_0x423e07,_0x43b9d6){let _0x34ecbd=_(_0x423e07),_0x497171=_(_0x43b9d6),_0x2e5898={},_0x1f2a96=0x0,_0x36636f=0x0;for(;_0x1f2a96<_0x34ecbd['length']&&_0x36636f<_0x497171['length'];){let _0x3a304e=_0x34ecbd[_0x1f2a96],_0x1c918e=_0x497171[_0x36636f];if(_0x3a304e==='*')break;if(_0x3a304e['startsWith'](':')){let _0x363e13=_0x3a304e['slice'](0x1);_0x363e13&&(_0x2e5898[_0x363e13]=te(_0x1c918e)),_0x1f2a96++,_0x36636f++;continue;}if(_0x3a304e!==_0x1c918e)return{};_0x1f2a96++,_0x36636f++;}return _0x1f2a96===_0x34ecbd['length']||_0x1f2a96===_0x34ecbd['length']-0x1&&_0x34ecbd[_0x1f2a96]==='*',_0x2e5898;}async function Oe(_0x340e21,_0x21a5ed,_0x9b71a0,_0x4b7e16,_0x5a33db=void 0x0,_0x187fa8){let _0x23726d=await _0x21a5ed['text'](),_0x101395=J(_0x23726d),_0x2e1b43=B(_0x21a5ed['url']),_0xb1d1c={...F(_0x340e21),'user':_0x5a33db},_0x483f85=H(_0xb1d1c),_0x166529=_0x187fa8?re(_0x187fa8,_0x21a5ed['path']):{};return{'app':O(_0x340e21),'permissions':T(_0x340e21),'user':_0x5a33db,'metadata':_0x483f85,'body':_0x101395,'query':_0x2e1b43,'params':_0x166529,'method':_0x9b71a0,'pathname':_0x4b7e16,'requestUrl':_0x21a5ed['url'],'headers':Object['fromEntries'](_0x21a5ed['raw']['headers']['entries']())};}function Te(_0x3837b8){return{'method':_0x3837b8['method'],'pathname':_0x3837b8['pathname'],'ctx':_0x3837b8};}function Fe(_0x52ac1f,_0x130fd3){let {status:_0x396635=0xc8,headers:_0x1aab2e={},body:_0x1d9f1f,type:_0x4ea96a}=_0x52ac1f??{};return _0x4ea96a==='raw'?new globalThis['Response'](String(_0x1d9f1f??''),{'status':_0x396635,'headers':_0x1aab2e}):_0x130fd3(_0x1d9f1f,_0x396635);}function Ne(_0x1ce9fa,_0x1be2b2=null){return N(_0x1ce9fa,{'appInfo':_0x1be2b2});}var V=f;async function Ve(_0x5b7d9d){_0x5b7d9d?(await U(_0x5b7d9d),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x5b7d9d)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x4fa276,_0x264cc1){let _0x55387d=Object['fromEntries'](Object['entries'](_0x4fa276['headers']||{})['map'](([_0x24b8ee,_0x51c886])=>[_0x24b8ee['toLowerCase'](),_0x51c886]));return{'id':_0x4fa276['app']['id']||_0x264cc1['appId']||'','name':_0x4fa276['app']['name']||'','version':_0x4fa276['app']['version']||'','description':_0x4fa276['app']['description']||'','metadata':{..._0x4fa276['metadata'],'permissions':_0x4fa276['permissions']},'body':_0x4fa276['body'],'query':_0x4fa276['query'],'params':_0x4fa276?.['params'],'method':_0x4fa276['method'],'pathname':_0x4fa276['pathname'],'requestUrl':_0x4fa276['requestUrl'],'user':_0x4fa276['user'],'headers':_0x55387d};}var L=class{constructor(_0x51cfee){this['handle']=null,(this['config']=_0x51cfee,this['logger']=_0x51cfee['logger']||f,this['lifecycle']=W({'appsDir':_0x51cfee['appsDir'],'timeout':_0x51cfee['timeout'],'platformImports':_0x51cfee['platformImports'],'libDir':_0x51cfee['libDir']},{'onCreate':_0x1fcd76=>this['logger']['info']('Worker\x20created',{'appId':_0x1fcd76['appId']}),'onReady':_0x2869e8=>{this['lifecycle']['updateStatus'](_0x2869e8['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x2869e8['appId']});},'onCrash':_0x1a28ec=>this['logger']['error']('Worker\x20crashed',{'appId':_0x1a28ec['appId']}),'onStop':_0x44d924=>this['logger']['info']('Worker\x20stopped',{'appId':_0x44d924['appId']})}),this['messaging']=$({'onReady':_0x5d8874=>this['lifecycle']['updateStatus'](_0x5d8874,'running'),'onLog':(_0x51e69d,_0x156c70,_0x197081,_0x27f645)=>{(this['logger'][_0x156c70]||this['logger']['info'])['call'](this['logger'],_0x197081,_0x27f645);},'onResult':()=>{}},_0x51cfee['timeout']||0x1d4c0));}async['create'](_0x186276){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x175a47=await this['lifecycle']['create'](this['config']['appId'],_0x186276,this['config']['scriptUrl']);this['messaging']['setup'](_0x175a47),this['messaging']['sendInit'](_0x175a47,this['config']['appsDir'],_0x186276,this['config']['serverPath']),this['handle']=_0x175a47,await this['waitForReady']();}async['waitForReady'](_0x5561a9=0x2710){let _0x285b1f=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x285b1f>_0x5561a9)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x414797=>setTimeout(_0x414797,0x64));}}async['invoke'](_0x4278c9){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x4278c9);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x270374){return new L(_0x270374);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;