import{join,dirname}from'path';import _0x22d7bf from'process';import{stat}from'fs/promises';async function ie(_0x2557a8){try{return await stat(_0x2557a8),!0x0;}catch{return![];}}var f={'error':(_0x37e48f,_0x106cd1)=>console['error']('[ERROR]\x20'+_0x37e48f,_0x106cd1),'warn':(_0x12f683,_0xb8e8e3)=>console['warn']('[WARN]\x20'+_0x12f683,_0xb8e8e3),'info':(_0x4bd88a,_0x1d6a28)=>console['log']('[INFO]\x20'+_0x4bd88a,_0x1d6a28),'debug':(_0x3c6e0d,_0x5b46f9)=>console['log']('[DEBUG]\x20'+_0x3c6e0d,_0x5b46f9)};function z(){let _0xdcf3d5=globalThis['Deno'];if(!_0xdcf3d5)throw new Error('Deno is not available');return _0xdcf3d5;}var D=class{constructor(_0x3cf701,_0x576851='./lib',_0x5d4c8e={}){this['manifest']=_0x3cf701,this['libDir']=_0x576851,this['platformImports']=_0x5d4c8e;}['buildPerms'](){let _0x3ac66a=this['manifest']['permissions']||{},_0x43f982={};return _0x3ac66a['net']!==void 0x0&&(_0x43f982['net']=_0x3ac66a['net']===!![]?!![]:Array['isArray'](_0x3ac66a['net'])?_0x3ac66a['net']:[]),_0x3ac66a['read']!==void 0x0&&(_0x43f982['read']=_0x3ac66a['read']===!![]?!![]:Array['isArray'](_0x3ac66a['read'])?_0x3ac66a['read']:[]),_0x3ac66a['write']!==void 0x0&&(_0x43f982['write']=_0x3ac66a['write']===!![]?!![]:Array['isArray'](_0x3ac66a['write'])?_0x3ac66a['write']:[]),_0x3ac66a['env']!==void 0x0&&(_0x43f982['env']=_0x3ac66a['env']===!![]?!![]:Array['isArray'](_0x3ac66a['env'])?_0x3ac66a['env']:[]),_0x3ac66a['run']!==void 0x0&&(_0x43f982['run']=_0x3ac66a['run']===!![]?!![]:Array['isArray'](_0x3ac66a['run'])?_0x3ac66a['run']:[]),_0x3ac66a['ffi']!==void 0x0&&(_0x43f982['ffi']=_0x3ac66a['ffi']===!![]?!![]:Array['isArray'](_0x3ac66a['ffi'])?_0x3ac66a['ffi']:[]),_0x3ac66a['sys']!==void 0x0&&(_0x43f982['sys']=_0x3ac66a['sys']===!![]?!![]:Array['isArray'](_0x3ac66a['sys'])?_0x3ac66a['sys']:[]),_0x3ac66a['hrtime']!==void 0x0&&(_0x43f982['hrtime']=_0x3ac66a['hrtime']),_0x43f982;}['normalize'](_0x278c34){return _0x278c34===!![]?[]:Array['isArray'](_0x278c34)?_0x278c34:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x127bb5){return join(this['libDir'],_0x127bb5+'@*');}['getReadPaths'](){let _0x1278ab=this['getImports']();_0x1278ab['includes']('*')&&(_0x1278ab=Object['keys'](this['platformImports']));let _0x150b6e=[];console['log']('[Permissions] Building package path patterns for imports:',_0x1278ab);for(let _0x2d98be of _0x1278ab){let _0x5cffcd=this['getLibPattern'](_0x2d98be);_0x150b6e['push'](_0x5cffcd),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x2d98be+'\x20->\x20'+_0x5cffcd);}return console['log']('[Permissions] Final package path patterns:',_0x150b6e),_0x150b6e;}['buildImportMap'](_0x19eada){let _0x7ddae6=this['getImports'](),_0x300269=_0x7ddae6['includes']('*')?Object['keys'](_0x19eada):_0x7ddae6;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x300269);let _0x44e2b5={};for(let _0x417059 of _0x300269)if(_0x19eada[_0x417059])_0x44e2b5[_0x417059]=_0x19eada[_0x417059],console['log']('[ImportMap]\x20'+_0x417059+'\x20->\x20'+_0x19eada[_0x417059]+'\x20(from\x20platform)');else try{let _0x5a8f33=z(),_0x2ea9b1=join(_0x5a8f33['cwd'](),this['libDir']),_0x2f0dfe=!0x1;try{for(let _0x3fe235 of _0x5a8f33['readDirSync'](_0x2ea9b1))if(_0x3fe235['isDirectory']&&(_0x3fe235['name']===_0x417059||_0x3fe235['name']['startsWith'](_0x417059+'@'))){let _0x4f4cf7=join(_0x5a8f33['cwd'](),this['libDir'],_0x3fe235['name'],'index.js')['replace'](/\\/g,'/'),_0x29fd03=new URL('file:///'+_0x4f4cf7)['href'];_0x44e2b5[_0x417059]=_0x29fd03,console['log']('[ImportMap]\x20'+_0x417059+'\x20->\x20'+_0x29fd03+'\x20(from\x20lib)'),_0x2f0dfe=!0x0;break;}}catch{}_0x2f0dfe||console['warn']('[ImportMap]\x20Package\x20'+_0x417059+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x21d5da){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x417059+':',_0x21d5da);}return _0x44e2b5;}['validateServerImports'](_0x4928e9){let _0x23ff4b=this['manifest']['name']||this['manifest']['id'],_0x49d7aa=this['manifest']['metadata']?.['serverPath'],_0xdcbf27=_0x3e82a5=>_0x3e82a5['replace'](/\\/g,'/'),_0x524d68=z(),_0x28f4f9=_0x3919a3=>{try{return _0x524d68['statSync'](_0x3919a3),!0x0;}catch{return![];}},_0xca6da4=_0x49d7aa?_0xdcbf27(_0x49d7aa):void 0x0;if(!_0xca6da4){let _0x148839=[_0x4928e9+'/service/server.js',_0x4928e9+'/service/server.ts',_0x4928e9+'/'+_0x23ff4b+'/server.js',_0x4928e9+'/'+_0x23ff4b+'/server.ts',_0x4928e9+'/server.js',_0x4928e9+'/server.ts']['map'](_0xdcbf27);for(let _0x8b210a of _0x148839)if(_0x28f4f9(_0x8b210a)){_0xca6da4=_0x8b210a;break;}}if(!_0xca6da4)return{'valid':![],'violations':['Failed to locate server module']};let _0x17ad42='';try{_0x17ad42=_0x524d68['readTextFileSync'](_0xca6da4);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0xca6da4};}let _0x1841fd=this['getImports']();if(_0x1841fd['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0xca6da4};let _0x17ba0a=_0x1841fd,_0xc00375=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x2eb045=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x1be415=/\bimport\s*['"]([^'"]+)['"]/g,_0x368605=[],_0x24e51a=new Set(),_0x2eb98f=_0x523082=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x523082),_0x122cda=_0x4d3b95=>{let _0x1d1d0b=_0x4d3b95;if(_0x1d1d0b['startsWith']('./')||_0x1d1d0b['startsWith']('../')||_0x1d1d0b['startsWith']('/')||_0x1d1d0b['startsWith']('file://')||!_0x2eb98f(_0x4d3b95)||_0x24e51a['has'](_0x4d3b95))return;_0x24e51a['add'](_0x4d3b95),_0x1d1d0b['startsWith']('npm:')&&(_0x1d1d0b=_0x1d1d0b['substring'](0x4)),_0x1d1d0b['includes']('@')&&!_0x1d1d0b['startsWith']('@')&&(_0x1d1d0b=_0x1d1d0b['split']('@')[0x0]);let _0x32a8f1=_0x1d1d0b['split']('/')[0x0];_0x17ba0a['includes'](_0x32a8f1)||_0x17ba0a['includes'](_0x4d3b95)||_0x368605['push'](_0x4d3b95);},_0x5011a2;for(;(_0x5011a2=_0xc00375['exec'](_0x17ad42))!==null;)_0x122cda(_0x5011a2[0x1]);for(;(_0x5011a2=_0x2eb045['exec'](_0x17ad42))!==null;)_0x122cda(_0x5011a2[0x1]);for(;(_0x5011a2=_0x1be415['exec'](_0x17ad42))!==null;)_0x122cda(_0x5011a2[0x1]);return{'valid':_0x368605['length']===0x0,'violations':_0x368605,'serverPath':_0xca6da4};}['validate'](_0x52188d={}){let _0x48c5cf=[],_0x5333ad=this['manifest']['permissions']||{};try{let _0x32d432=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x32d432);}catch{}let _0x3a44f6=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x556838,_0x3797e8]of Object['entries'](_0x5333ad))if(_0x556838==='hrtime')typeof _0x3797e8!='boolean'&&_0x48c5cf['push']('Permission\x20\x27'+_0x556838+'\x27\x20must\x20be\x20boolean');else{if(_0x556838==='langchain')typeof _0x3797e8!='boolean'&&(typeof _0x3797e8!='object'||_0x3797e8===null)?_0x48c5cf['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x3797e8=='object'&&(_0x3797e8===null||!('enabled'in _0x3797e8)||typeof _0x3797e8['enabled']!='boolean')&&_0x48c5cf['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x556838==='kv')typeof _0x3797e8!='boolean'&&_0x48c5cf['push']('Permission\x20\x27'+_0x556838+'\x27\x20must\x20be\x20boolean');else{if(_0x556838==='mspbots')Array['isArray'](_0x3797e8)||_0x48c5cf['push']('Permission\x20\x27'+_0x556838+'\x27\x20must\x20be\x20an\x20array');else{if(_0x556838==='db'){if(typeof _0x3797e8!='object'||_0x3797e8===null||Array['isArray'](_0x3797e8))_0x48c5cf['push']('Permission\x20\x27'+_0x556838+'\x27\x20must\x20be\x20an\x20object');else{let _0x5877c1=_0x3797e8,_0x231e6e=['user','password']['filter'](_0x54acc4=>!(_0x54acc4 in _0x5877c1));_0x231e6e['length']>0x0&&_0x48c5cf['push']('Permission\x20\x27'+_0x556838+'\x27\x20missing\x20required\x20fields:\x20'+_0x231e6e['join'](',\x20'));}}else{if(_0x556838==='imports')continue;_0x3a44f6['has'](_0x556838)||typeof _0x3797e8!='boolean'&&!Array['isArray'](_0x3797e8)&&_0x48c5cf['push']('Permission\x20\x27'+_0x556838+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x58dbac=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x58dbac))_0x48c5cf['push']('permissions.imports must be an array');else{for(let _0x5e46df of _0x58dbac)typeof _0x5e46df!='string'&&_0x48c5cf['push']('import\x20\x27'+_0x5e46df+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x48c5cf['length']===0x0,'errors':_0x48c5cf};}};function q(_0x460816,_0x3f4e52,_0x407ace){return new D(_0x460816,_0x3f4e52,_0x407ace||{});}var R=null;function I(){let _0x30621c=globalThis['Deno'];if(!_0x30621c)throw new Error('Deno is not available');return _0x30621c;}async function K(){if(R)return{...R};try{let _0x438766=I(),_0x290bee=join(_0x438766['cwd'](),'deno.json'),_0x58c7f1=await _0x438766['readTextFile'](_0x290bee);return R=JSON['parse'](_0x58c7f1)['imports']||{},{...R};}catch(_0x36d82c){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x36d82c),{};}}var E=class{constructor(_0x2112d7,_0x3a7a7c={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x2112d7['appsDir'],this['platformImportsOverride']=_0x2112d7['platformImports'],this['libDir']=_0x2112d7['libDir'],this['events']=_0x3a7a7c);}async['create'](_0x5c80cc,_0x5f4256,_0x119082){try{return await this['createWorker'](_0x5c80cc,_0x5f4256,_0x119082);}catch(_0x3c4905){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x5c80cc+':',_0x3c4905),_0x3c4905;}}async['createWorker'](_0xe8edbe,_0x26481c,_0x251f49){let _0x5805c0=this['platformImportsOverride']||await K(),_0x1d7e42=q(_0x26481c,this['libDir'],_0x5805c0)['validateServerImports'](this['appsDir']);if(!_0x1d7e42['valid']){let _0x427d72=_0x1d7e42['violations']['filter'](_0x40a830=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x40a830)),_0x35a089=_0x1d7e42['serverPath']?_0x1d7e42['serverPath']:(_0x26481c['name']||_0x26481c['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x35a089+':\x20'+_0x427d72['join'](',\x20'));}let _0x565e80=q(_0x26481c,this['libDir'],_0x5805c0),_0x411736=_0x565e80['validate'](_0x5805c0);if(!_0x411736['valid'])throw new Error('Invalid\x20config:\x20'+_0x411736['errors']['join'](',\x20'));let _0x28770a=_0x565e80['buildImportMap'](_0x5805c0);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0xe8edbe+':',_0x28770a);let _0x487413=_0x565e80['buildPerms'](),_0x421de8=_0x565e80['getReadPaths']();if(_0x487413['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x487413['read']);else{let _0x59ef5d=_0x26481c['name']||_0xe8edbe,_0x32c445=this['appsDir']+'/'+_0x59ef5d,_0x230da4=[_0x32c445],_0x5f179b=_0x26481c['metadata']?.['serverPath'];if(_0x5f179b&&typeof _0x5f179b=='string')try{let _0x46eb02=dirname(_0x5f179b)['replace'](/\\/g,'/');_0x230da4['push'](_0x46eb02);}catch{}_0x487413['read']=_0x230da4,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x32c445);}if(_0x421de8['length']>0x0){if(_0x487413['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x4ae8e6=Array['isArray'](_0x487413['read'])?_0x487413['read']:[];_0x487413['read']=[..._0x4ae8e6,..._0x421de8],console['log']('[Worker] Added package read permissions:',_0x421de8);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x487413['net']||(_0x487413['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0xe8edbe+':',_0x487413['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x487413['read']===!![]?'unrestricted':Array['isArray'](_0x487413['read'])?_0x487413['read']['length']:0x0));let _0x4dec40=await this['createImportMap'](_0xe8edbe,_0x28770a),_0x340c58=await this['createLock'](_0xe8edbe,_0x28770a),_0x341c28={'type':'module','deno':{'permissions':{}}};_0x341c28['deno']['namespace']=![],_0x341c28['deno']['permissions']=_0x487413,_0x341c28['deno']['importMap']=_0x4dec40,_0x341c28['deno']['lock']=_0x340c58,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0xe8edbe+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x4dec40),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x340c58),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x28770a)['length']+'\x20('+(Object['keys'](_0x28770a)['join'](',\x20')||'none')+')');let _0x1f81f9={'worker':new Worker(_0x251f49,_0x341c28),'appId':_0xe8edbe,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x26481c,'importMapPath':_0x4dec40,'lockfilePath':_0x340c58};return this['workers']['set'](_0xe8edbe,_0x1f81f9),this['events']['onCreate']?.(_0x1f81f9),_0x1f81f9;}async['createLock'](_0x37841d,_0x4977e6){let _0x34c056=I(),_0x5e9b46=join(_0x34c056['cwd'](),'storage','temp','lockfiles');await _0x34c056['mkdir'](_0x5e9b46,{'recursive':!![]});let _0xba23da=_0x37841d+'-'+Date['now']()+'.lock',_0x141c75=join(_0x5e9b46,_0xba23da),_0x313729={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x578cad,_0x237b1a]of Object['entries'](_0x4977e6))if(_0x237b1a['startsWith']('npm:'))_0x237b1a['replace']('npm:',''),_0x313729['packages']['specifiers'][_0x578cad]=_0x237b1a;else _0x237b1a['startsWith']('file://')&&(_0x313729['packages']['specifiers'][_0x578cad]=_0x237b1a);let _0x4e8f52=JSON['stringify'](_0x313729,null,0x2);return await _0x34c056['writeTextFile'](_0x141c75,_0x4e8f52),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x141c75),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x4977e6)['length']+'):',Object['keys'](_0x4977e6)),_0x141c75;}async['createImportMap'](_0x554aa7,_0x4b58af){let _0x2e8a0c=I(),_0x469781=join(_0x2e8a0c['cwd'](),'storage','temp','importmaps');await _0x2e8a0c['mkdir'](_0x469781,{'recursive':!![]});let _0x5f3e6b=_0x554aa7+'-'+Date['now']()+'.json',_0x4b9c27=join(_0x469781,_0x5f3e6b),_0x317104=JSON['stringify']({'imports':_0x4b58af,'scopes':{}},null,0x2);return await _0x2e8a0c['writeTextFile'](_0x4b9c27,_0x317104),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x4b9c27),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x4b58af)['length']+'):',Object['keys'](_0x4b58af)['join'](',\x20')||'none'),_0x4b9c27;}['get'](_0x54a39f){return this['workers']['get'](_0x54a39f);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x5073ed,_0x59f75b){let _0x15d1f4=this['workers']['get'](_0x5073ed);if(!_0x15d1f4)return;let _0x7cc876=_0x15d1f4['status'];_0x15d1f4['status']=_0x59f75b,_0x59f75b==='running'&&_0x7cc876==='starting'?this['events']['onReady']?.(_0x15d1f4):_0x59f75b==='crashed'&&this['events']['onCrash']?.(_0x15d1f4);}['touch'](_0xb68d8f){let _0x1775a4=this['workers']['get'](_0xb68d8f);_0x1775a4&&(_0x1775a4['lastUsed']=Date['now']());}async['stop'](_0x5d56c9){let _0xbea43c=this['workers']['get'](_0x5d56c9);if(_0xbea43c)try{_0xbea43c['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0xbea43c['worker']['terminate'](),_0xbea43c['status']='stopped',this['events']['onStop']?.(_0xbea43c),_0xbea43c['importMapPath']&&await this['cleanupImportMap'](_0xbea43c['importMapPath']),_0xbea43c['lockfilePath']&&await this['cleanupLock'](_0xbea43c['lockfilePath']);}catch(_0x5dfe09){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x5d56c9+':',_0x5dfe09);}finally{this['workers']['delete'](_0x5d56c9);}}async['cleanupImportMap'](_0x196f01){try{await I()['remove'](_0x196f01),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x196f01);}catch(_0x24a15a){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x196f01,_0x24a15a);}}async['cleanupLock'](_0x2dc28c){try{await I()['remove'](_0x2dc28c),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x2dc28c);}catch(_0x2313b8){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x2dc28c,_0x2313b8);}}async['stopAll'](){let _0x130362=Array['from'](this['workers']['keys']());await Promise['all'](_0x130362['map'](_0x41f0d5=>this['stop'](_0x41f0d5)));}async['restart'](_0xc136ce,_0x5586d8){let _0x30aed7=this['workers']['get'](_0xc136ce);if(!_0x30aed7)throw new Error('Worker\x20'+_0xc136ce+'\x20not\x20found');let _0xf832d5=_0x30aed7['manifest'];return await this['stop'](_0xc136ce),await this['create'](_0xc136ce,_0xf832d5,_0x5586d8);}['checkHealth'](_0x49f479){let _0x16fdc1=this['workers']['get'](_0x49f479);if(!_0x16fdc1)return{'healthy':![],'reason':'Not\x20found'};if(_0x16fdc1['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x16fdc1['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x4e97a6=Date['now']()-_0x16fdc1['lastUsed'],_0x15f314=0x708*0x3e8;return _0x4e97a6>_0x15f314?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x4e97a6/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x5d4505=0x708*0x3e8,_0x4e5be1){let _0x5dc033=Date['now'](),_0x1272ce=[];for(let [_0x40be4f,_0x32e3e4]of this['workers']['entries']()){let _0x3607eb=_0x5dc033-_0x32e3e4['lastUsed'];_0x3607eb>_0x5d4505&&_0x1272ce['push']({'appId':_0x40be4f,'idle':_0x3607eb});}_0x1272ce['sort']((_0x43fd45,_0x16492f)=>_0x16492f['idle']-_0x43fd45['idle']);let _0x2ee711=_0x4e5be1?_0x1272ce['slice'](0x0,_0x4e5be1)['map'](_0x5af44a=>_0x5af44a['appId']):_0x1272ce['map'](_0x16e566=>_0x16e566['appId']);for(let _0x2135ac of _0x2ee711)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x2135ac),await this['stop'](_0x2135ac);}['stats'](){let _0x1cc846={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x5719b0=Date['now']();for(let _0x201493 of this['workers']['values']())_0x1cc846['byStatus'][_0x201493['status']]++,_0x1cc846['workers']['push']({'appId':_0x201493['appId'],'status':_0x201493['status'],'version':_0x201493['version'],'lastUsed':_0x201493['lastUsed'],'idle':_0x5719b0-_0x201493['lastUsed']});return _0x1cc846;}['startCleanup'](_0x1fda92=0x12c*0x3e8,_0x24d7b4){let _0xeed79c=setInterval(()=>{this['cleanup'](_0x24d7b4)['catch'](_0x3f7e86=>{console['error']('Cleanup\x20failed:',_0x3f7e86);});},_0x1fda92);return()=>clearInterval(_0xeed79c);}['delay'](_0x1f89c4){return new Promise(_0x445223=>setTimeout(_0x445223,_0x1f89c4));}};function W(_0x192d5c,_0x106974){return new E(_0x192d5c,_0x106974);}var v=f,j=class{constructor(_0x34e572,_0x3f2ff4=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x34e572,this['timeout']=_0x3f2ff4);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x55e124){_0x55e124['worker']['onmessage']=_0x5adfe3=>{let _0x13caab=_0x5adfe3['data'],{appId:_0x6aa42}=_0x55e124;switch(_0x13caab['type']){case'ready':this['events']['onReady'](_0x6aa42),v['info']('Worker\x20ready',{'appId':_0x6aa42,'version':_0x55e124['version']});break;case'log':{let {level:_0x47db3a='info',message:_0x2445c2,meta:_0x4d8fa4}=_0x13caab,_0x34271c={..._0x4d8fa4||{},'appId':_0x6aa42,'version':_0x55e124['version']};this['events']['onLog'](_0x6aa42,_0x47db3a,_0x2445c2,_0x34271c);break;}case'result':{let {reqId:_0x3bfca6,ok:_0x226f48,response:_0x10c06e,error:_0x41c91c}=_0x13caab,_0x324dc1=this['pending']['get'](_0x3bfca6);if(!_0x324dc1){v['warn']('Unknown\x20request',{'appId':_0x6aa42,'reqId':_0x3bfca6});return;}if(this['pending']['delete'](_0x3bfca6),_0x226f48&&_0x10c06e)_0x324dc1['resolve'](_0x10c06e);else{let _0x3b1852=new Error(_0x41c91c?.['message']||'Worker\x20error');_0x3b1852['stack']=_0x41c91c?.['stack'],_0x324dc1['reject'](_0x3b1852);}this['events']['onResult'](_0x6aa42,_0x3bfca6,_0x10c06e||_0x41c91c);break;}default:v['debug']('Unknown\x20message',{'appId':_0x6aa42,'type':_0x13caab['type']});}},_0x55e124['worker']['onerror']=_0x164435=>{let {appId:_0x535b56}=_0x55e124;v['error']('Worker\x20error',{'appId':_0x535b56,'message':_0x164435['message'],'lineno':_0x164435['lineno'],'filename':_0x164435['filename']}),_0x55e124['status']='crashed',this['rejectPending'](_0x535b56,new Error('Worker\x20'+_0x535b56+'\x20crashed:\x20'+_0x164435['message'])),_0x164435['preventDefault']();},_0x55e124['worker']['onmessageerror']=_0x637ebe=>{let {appId:_0x43ce54}=_0x55e124;v['error']('Message\x20error',{'appId':_0x43ce54,'data':_0x637ebe['data']}),_0x55e124['status']='crashed',_0x637ebe['preventDefault']();};}['sendInit'](_0x1d8c1b,_0x206bba,_0x169a36,_0x14c1d7){_0x1d8c1b['worker']['postMessage']({'type':'init','appId':_0x1d8c1b['appId'],'manifest':_0x169a36,'appsDir':_0x206bba,'serverPath':_0x14c1d7});}async['sendInvoke'](_0x2a602c,_0x41d467){let _0x2d8f7c=this['nextId'](),_0x4e6057=_0x2a602c['appId'],_0x88d4b6=new Promise((_0x530687,_0x12929e)=>{let _0x54ecb0=setTimeout(()=>{this['pending']['delete'](_0x2d8f7c),_0x12929e(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x2d8f7c,{'resolve':_0x31d8d6=>{clearTimeout(_0x54ecb0),_0x530687(_0x31d8d6);},'reject':_0x43ea56=>{clearTimeout(_0x54ecb0),_0x12929e(_0x43ea56);},'timestamp':Date['now'](),'appId':_0x4e6057});});return _0x2a602c['worker']['postMessage']({'type':'invoke','appId':_0x2a602c['appId'],'reqId':_0x2d8f7c,'payload':_0x41d467}),await _0x88d4b6;}['rejectPending'](_0x20b57a,_0x38d0f4){let _0x1a1384=0x0;for(let [_0x1990a9,_0x1a31ed]of this['pending']['entries']())_0x1a31ed['appId']===_0x20b57a&&(this['pending']['delete'](_0x1990a9),_0x1a31ed['reject'](_0x38d0f4),_0x1a1384++);_0x1a1384>0x0&&v['warn']('Rejected\x20'+_0x1a1384+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x20b57a});}['cleanupTimeout'](){let _0x4a0219=Date['now']();for(let [_0x3c27d1,_0x47ad1f]of this['pending']['entries']())_0x4a0219-_0x47ad1f['timestamp']>this['timeout']&&(this['pending']['delete'](_0x3c27d1),_0x47ad1f['reject'](new Error('Request\x20'+_0x3c27d1+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x21ce1a){let _0xef70a1=0x0;for(let _0x527d70 of this['pending']['values']())_0x527d70['appId']===_0x21ce1a&&_0xef70a1++;return _0xef70a1;}['startCleanup'](_0x43784c=0x2710){let _0x3b9c90=setInterval(()=>{this['cleanupTimeout']();},_0x43784c);return()=>clearInterval(_0x3b9c90);}};function $(_0x52c45b,_0x31ef23){return new j(_0x52c45b,_0x31ef23);}var Q=class{constructor(_0x116352={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x116352['logger']||f,this['config']={'appsDir':_0x116352['appsDir']||this['getAppsDir'](),'scriptUrl':_0x116352['scriptUrl']||this['getScriptUrl'](),'timeout':_0x116352['timeout']||0x78*0x3e8,'autoCleanup':_0x116352['autoCleanup']??!![],'cleanupInterval':_0x116352['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x116352['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x116352['maxWorkers'],'reuseWorkers':_0x116352['reuseWorkers']??!![],'workerReuseStrategy':_0x116352['workerReuseStrategy']||'lru','enableQueue':_0x116352['enableQueue']??!![],'maxQueueSize':_0x116352['maxQueueSize']||0x64,'queueTimeout':_0x116352['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x5405c5=>this['logger']['info']('Worker\x20created',{'appId':_0x5405c5['appId'],'v':_0x5405c5['version']}),'onReady':_0x5dded5=>this['lifecycle']['updateStatus'](_0x5dded5['appId'],'running'),'onCrash':_0x4add89=>this['logger']['error']('Worker\x20crashed',{'appId':_0x4add89['appId'],'v':_0x4add89['version']}),'onStop':_0x102805=>this['logger']['info']('Worker\x20stopped',{'appId':_0x102805['appId'],'v':_0x102805['version']})}),this['messaging']=$({'onReady':_0x27685d=>this['lifecycle']['updateStatus'](_0x27685d,'running'),'onLog':(_0x524461,_0x5c8796,_0x497d17,_0x13fa9d)=>{let _0x4c4763={..._0x13fa9d||{},'appId':_0x524461};switch(_0x5c8796){case'error':this['logger']['error'](_0x497d17,_0x4c4763);break;case'warn':this['logger']['warn'](_0x497d17,_0x4c4763);break;case'debug':this['logger']['debug'](_0x497d17,_0x4c4763);break;default:this['logger']['info'](_0x497d17,_0x4c4763);break;}},'onResult':(_0x1c3b47,_0xf1cf9,_0xb0d034)=>{this['logger']['debug']('Result\x20received',{'appId':_0x1c3b47,'reqId':_0xf1cf9});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x22d7bf['cwd'](),'apps');}['getScriptUrl'](){let _0x2c442b=import.meta.url,_0x892a2=_0x2c442b['endsWith']('.js')||_0x2c442b['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x892a2,_0x2c442b)['href'];}async['ensure'](_0x135e3a){let {id:_0xcd6d50}=_0x135e3a,_0x8045e5=this['lifecycle']['get'](_0xcd6d50);if(_0x8045e5){let _0x373709=this['lifecycle']['checkHealth'](_0xcd6d50);if(_0x373709['healthy'])return this['lifecycle']['touch'](_0xcd6d50),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0xcd6d50}),_0x8045e5;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0xcd6d50,'reason':_0x373709['reason']}),await this['lifecycle']['stop'](_0xcd6d50);}for(;;){let _0x38e66d=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x38e66d>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x38e66d,'max':this['config']['maxWorkers'],'appId':_0xcd6d50}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x135e3a);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x46d6aa=await this['loadManifest'](_0xcd6d50,_0x135e3a['manifest']),_0x52d3b5=await this['lifecycle']['create'](_0xcd6d50,_0x46d6aa,this['config']['scriptUrl']),_0x59506f=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x59506f>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x59506f,'max':this['config']['maxWorkers'],'appId':_0xcd6d50}),await this['lifecycle']['stop'](_0xcd6d50),this['config']['enableQueue'])return await this['waitSlot'](_0x135e3a);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x59506f+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x52d3b5);let _0x5d69c8=_0x46d6aa['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x52d3b5,this['config']['appsDir'],_0x46d6aa,_0x5d69c8),this['logger']['info']('Worker\x20created',{'appId':_0xcd6d50,'v':_0x52d3b5['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x52d3b5;}async['evictIdle'](){let _0x5dfc9c=this['lifecycle']['getAll']();if(_0x5dfc9c['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x468258=[..._0x5dfc9c];this['config']['workerReuseStrategy']==='lru'?_0x468258['sort']((_0x56b9c0,_0x167c37)=>_0x56b9c0['lastUsed']-_0x167c37['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x468258['sort']((_0x2723b9,_0x2c8d97)=>_0x2723b9['version']-_0x2c8d97['version']);let _0x203d69=null;for(let _0xa65fc7 of _0x468258)if(this['messaging']['getAppCount'](_0xa65fc7['appId'])===0x0){_0x203d69=_0xa65fc7;break;}if(!_0x203d69&&_0x468258['length']>0x0&&(_0x203d69=_0x468258['reduce']((_0x4b7c09,_0x5061c5)=>{let _0x2abe00=this['messaging']['getAppCount'](_0x4b7c09['appId']);return this['messaging']['getAppCount'](_0x5061c5['appId'])<_0x2abe00?_0x5061c5:_0x4b7c09;})),_0x203d69){let _0x5b4896=this['messaging']['getAppCount'](_0x203d69['appId']);return _0x5b4896>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x203d69['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x203d69['lastUsed'],'pendingRequests':_0x5b4896}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x203d69['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x203d69['lastUsed']}),await this['lifecycle']['stop'](_0x203d69['appId']),!![];}return![];}['waitSlot'](_0x37c359){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x78d7cc,_0x54d3be)=>{let _0x309142={'info':_0x37c359,'resolve':_0x78d7cc,'reject':_0x54d3be,'timestamp':Date['now']()};this['requestQueue']['push'](_0x309142),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x37c359['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x52fac1=setTimeout(()=>{let _0x34f9ba=this['requestQueue']['indexOf'](_0x309142);_0x34f9ba!==-0x1&&(this['requestQueue']['splice'](_0x34f9ba,0x1),_0x54d3be(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x309142['resolve']=_0x36598d=>{clearTimeout(_0x52fac1),_0x78d7cc(_0x36598d);},_0x309142['reject']=_0x38d60a=>{clearTimeout(_0x52fac1),_0x54d3be(_0x38d60a);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0xfca82e=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0xfca82e>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x10b449=this['requestQueue']['shift']();if(!_0x10b449)break;try{let _0x22e04e=await this['ensure'](_0x10b449['info']);_0x10b449['resolve'](_0x22e04e);}catch(_0xd4759e){_0x10b449['reject'](_0xd4759e);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x1bdd27,_0x35cd48){let _0x6673a=this['config']['appsDir']['replace'](/\\/g,'/'),_0x35c843=async _0x278e6b=>{try{let _0x3054a2=globalThis['Deno'];if(!_0x3054a2)return null;let _0x42a0bb=await _0x3054a2['readTextFile'](_0x278e6b);return JSON['parse'](_0x42a0bb);}catch{return null;}};if(_0x35cd48?.['name']){let _0xbf9fc5=await _0x35c843(_0x6673a+'/'+_0x35cd48['name']+'/manifest.json');if(_0xbf9fc5)return _0xbf9fc5;}let _0x4eeb1e=await _0x35c843(_0x6673a+'/'+_0x1bdd27+'/manifest.json');if(_0x4eeb1e)return _0x4eeb1e;try{let _0x4b33f4=globalThis['Deno'];if(_0x4b33f4)for await(let _0x483df9 of _0x4b33f4['readDir'](_0x6673a)){if(!_0x483df9['isDirectory'])continue;let _0x5ce10b=_0x6673a+'/'+_0x483df9['name']+'/manifest.json',_0x545a9f=await _0x35c843(_0x5ce10b);if(_0x545a9f&&(_0x545a9f['id']===_0x1bdd27||_0x35cd48?.['name']&&_0x545a9f['name']===_0x35cd48['name']))return _0x545a9f;}}catch(_0xb81799){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x1bdd27,'error':_0xb81799['message']});}return _0x35cd48||{'id':_0x1bdd27,'name':_0x1bdd27,'version':'1.0.0'};}async['invoke'](_0x52a7d3){let _0x132a92=_0x52a7d3['ctx']['app']['id'],_0x48ec49=_0x52a7d3['ctx']['app']['name'];try{let _0x657411={'id':_0x132a92,'manifest':{'id':_0x132a92,'name':_0x48ec49}},_0x24c415=await this['ensure'](_0x657411);if(_0x24c415['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x132a92}),await this['restart'](_0x132a92);let _0x5ea4de=await this['ensure'](_0x657411);return this['lifecycle']['touch'](_0x132a92),await this['messaging']['sendInvoke'](_0x5ea4de,_0x52a7d3);}return this['lifecycle']['touch'](_0x132a92),await this['messaging']['sendInvoke'](_0x24c415,_0x52a7d3);}catch(_0x2cb449){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x132a92,'error':_0x2cb449['message'],'stack':_0x2cb449['stack']}),_0x2cb449;}}async['stop'](_0x1ef9a8){await this['lifecycle']['stop'](_0x1ef9a8),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x1c6a2d){return await this['lifecycle']['restart'](_0x1c6a2d,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x1d10aa=>({'appId':_0x1d10aa['appId'],'status':_0x1d10aa['status'],'version':_0x1d10aa['version'],'lastUsed':_0x1d10aa['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0xd9b4b0=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x28f1a5=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0xd9b4b0(),_0x28f1a5();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x58c1b3=>{_0x58c1b3?(await this['stop'](_0x58c1b3),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x58c1b3})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x1f1125){return new Q(_0x1f1125);}var S=null;function be(_0x1572a4){S=ee(_0x1572a4);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0xe1efc8){return await k()['ensure'](_0xe1efc8);}async function xe(_0x4d080d){return await k()['invoke'](_0x4d080d);}function Ie(_0x559c96){k()['stop'](_0x559c96)['catch'](_0x3ba628=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x559c96,'error':_0x3ba628['message']});});}function Re(){k()['stopAll']()['catch'](_0x51222f=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x51222f['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x407ddb){await k()['stop'](_0x407ddb);}async function Se(){await k()['stopAll']();}function Ae(_0x2060b7){let _0x3835f6=_0x2060b7&&typeof _0x2060b7=='object'?_0x2060b7:null;if(_0x3835f6&&'user'in _0x3835f6)return _0x3835f6['user'];}function H(_0x122a57){let _0x44c492=_0x122a57&&typeof _0x122a57=='object'?_0x122a57:null;if(!_0x44c492)return{};let _0x4fbe34={};for(let [_0x15a922,_0x3767b5]of Object['entries'](_0x44c492))_0x15a922!=='user'&&(_0x4fbe34[_0x15a922]=_0x3767b5);return _0x4fbe34;}function O(_0xec81d9){return _0xec81d9?{'id':_0xec81d9['manifest']?.['id']||_0xec81d9['id']||'','name':_0xec81d9['manifest']?.['name']||'','version':_0xec81d9['manifest']?.['version']||'','description':_0xec81d9['manifest']?.['description']||'','icon':_0xec81d9['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x4e1123){return _0x4e1123?.['permissions']||_0x4e1123?.['manifest']?.['permissions']||{};}function F(_0x7783ff){return _0x7783ff?.['manifest']?.['metadata']||{};}function Ce(_0x7e912a){return _0x7e912a?{'appId':_0x7e912a['id'],'appName':_0x7e912a['manifest']?.['name']}:{};}function N(_0x2c5afe,_0x2982bc={}){let {appInfo:_0x29c19e=null,status:_0x11726f=0x1f4,defaultMessage:_0x433d28='Internal\x20Server\x20Error'}=_0x2982bc,_0x89889e={'error':_0x433d28,'message':_0x2c5afe?.['message']||_0x433d28};return _0x29c19e&&(_0x89889e['appId']=_0x29c19e['id'],_0x89889e['appName']=_0x29c19e['manifest']?.['name']),_0x2c5afe?.['message']?.['includes']('crashed')&&(_0x89889e['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x11726f,'body':_0x89889e};}function qe(_0xf64573){return _0xf64573?.['message']?.['includes']('crashed')||![];}function J(_0x4800a1){if(_0x4800a1)try{return JSON['parse'](_0x4800a1);}catch{return _0x4800a1;}}function B(_0x2d2fe0){try{let _0x21fc70=new URL(_0x2d2fe0),_0x838dbc={};for(let _0x4a99fb of _0x21fc70['searchParams']['keys']()){let _0x24b72c=_0x21fc70['searchParams']['getAll'](_0x4a99fb)['map'](_0xd3ec02=>_0xd3ec02);_0x24b72c['length']<=0x1?_0x838dbc[_0x4a99fb]=_0x24b72c[0x0]??'':_0x838dbc[_0x4a99fb]=_0x24b72c;}return _0x838dbc;}catch{return{};}}function Le(_0x1b2f9f){return(()=>{try{return new URL(_0x1b2f9f)['pathname'];}catch{return _0x1b2f9f;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x53caa9,_0x57ff6c){let _0x3f1537=_0x53caa9;if(_0x57ff6c&&_0x3f1537['startsWith']('/apps/'+_0x57ff6c))_0x3f1537=_0x3f1537['substring'](('/apps/'+_0x57ff6c)['length'])||'/';else{let _0x1a8809=_0x3f1537['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x1a8809&&(_0x3f1537=_0x1a8809[0x1]||'/');}return _0x3f1537['startsWith']('/api')&&(_0x3f1537=_0x3f1537['substring'](0x4)||'/'),_0x3f1537;}function Ue(_0x386733,_0x2926df){let _0x33b7b8=_0x386733;if(_0x2926df&&_0x33b7b8['startsWith']('/apps/'+_0x2926df))_0x33b7b8=_0x33b7b8['substring'](('/apps/'+_0x2926df)['length'])||'/';else{let _0x157aba=_0x33b7b8['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x157aba&&(_0x33b7b8=_0x157aba[0x1]||'/');}return(!_0x33b7b8||_0x33b7b8==='/')&&(_0x33b7b8='/index.html'),_0x33b7b8;}async function He(_0x59edbe,_0x305df5){return await _0x305df5(_0x59edbe);}function _(_0x358ced){return _0x358ced['split']('/')['filter'](_0x1a8564=>_0x1a8564['length']>0x0);}function te(_0x408304){try{return decodeURIComponent(_0x408304);}catch{return _0x408304;}}function re(_0x76a263,_0x36133e){let _0x1a27dd=_(_0x76a263),_0x3116ad=_(_0x36133e),_0x178694={},_0x439a9c=0x0,_0x1eb9c4=0x0;for(;_0x439a9c<_0x1a27dd['length']&&_0x1eb9c4<_0x3116ad['length'];){let _0x2a2584=_0x1a27dd[_0x439a9c],_0x397b6a=_0x3116ad[_0x1eb9c4];if(_0x2a2584==='*')break;if(_0x2a2584['startsWith'](':')){let _0x59af78=_0x2a2584['slice'](0x1);_0x59af78&&(_0x178694[_0x59af78]=te(_0x397b6a)),_0x439a9c++,_0x1eb9c4++;continue;}if(_0x2a2584!==_0x397b6a)return{};_0x439a9c++,_0x1eb9c4++;}return _0x439a9c===_0x1a27dd['length']||_0x439a9c===_0x1a27dd['length']-0x1&&_0x1a27dd[_0x439a9c]==='*',_0x178694;}async function Oe(_0x2ebc91,_0x597d90,_0x1adec3,_0x1cb3e3,_0x260b54=void 0x0,_0x5c29de){let _0x4d36c7=await _0x597d90['text'](),_0x1e2d51=J(_0x4d36c7),_0x2b04f2=B(_0x597d90['url']),_0x3ae917={...F(_0x2ebc91),'user':_0x260b54},_0x4e8509=H(_0x3ae917),_0x2c1a59=_0x5c29de?re(_0x5c29de,_0x597d90['path']):{};return{'app':O(_0x2ebc91),'permissions':T(_0x2ebc91),'user':_0x260b54,'metadata':_0x4e8509,'body':_0x1e2d51,'query':_0x2b04f2,'params':_0x2c1a59,'method':_0x1adec3,'pathname':_0x1cb3e3,'requestUrl':_0x597d90['url'],'headers':Object['fromEntries'](_0x597d90['raw']['headers']['entries']())};}function Te(_0x120cad){return{'method':_0x120cad['method'],'pathname':_0x120cad['pathname'],'ctx':_0x120cad};}function Fe(_0x1ec3f9,_0x31e7d4){let {status:_0x1de26a=0xc8,headers:_0x2e8eee={},body:_0x140908,type:_0x1784d7}=_0x1ec3f9??{};return _0x1784d7==='raw'?new globalThis['Response'](String(_0x140908??''),{'status':_0x1de26a,'headers':_0x2e8eee}):_0x31e7d4(_0x140908,_0x1de26a);}function Ne(_0x2e6a3b,_0x57e144=null){return N(_0x2e6a3b,{'appInfo':_0x57e144});}var V=f;async function Ve(_0x485c68){_0x485c68?(await U(_0x485c68),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x485c68)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x5c7f9d,_0x43c941){let _0x1605ba=Object['fromEntries'](Object['entries'](_0x5c7f9d['headers']||{})['map'](([_0x430f77,_0x1fbdd5])=>[_0x430f77['toLowerCase'](),_0x1fbdd5]));return{'id':_0x5c7f9d['app']['id']||_0x43c941['appId']||'','name':_0x5c7f9d['app']['name']||'','version':_0x5c7f9d['app']['version']||'','description':_0x5c7f9d['app']['description']||'','metadata':{..._0x5c7f9d['metadata'],'permissions':_0x5c7f9d['permissions']},'body':_0x5c7f9d['body'],'query':_0x5c7f9d['query'],'params':_0x5c7f9d?.['params'],'method':_0x5c7f9d['method'],'pathname':_0x5c7f9d['pathname'],'requestUrl':_0x5c7f9d['requestUrl'],'user':_0x5c7f9d['user'],'headers':_0x1605ba};}var L=class{constructor(_0x8b7ef0){this['handle']=null,(this['config']=_0x8b7ef0,this['logger']=_0x8b7ef0['logger']||f,this['lifecycle']=W({'appsDir':_0x8b7ef0['appsDir'],'timeout':_0x8b7ef0['timeout'],'platformImports':_0x8b7ef0['platformImports'],'libDir':_0x8b7ef0['libDir']},{'onCreate':_0x5a99eb=>this['logger']['info']('Worker\x20created',{'appId':_0x5a99eb['appId']}),'onReady':_0x130936=>{this['lifecycle']['updateStatus'](_0x130936['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x130936['appId']});},'onCrash':_0x1056b8=>this['logger']['error']('Worker\x20crashed',{'appId':_0x1056b8['appId']}),'onStop':_0xaac034=>this['logger']['info']('Worker\x20stopped',{'appId':_0xaac034['appId']})}),this['messaging']=$({'onReady':_0x49fb28=>this['lifecycle']['updateStatus'](_0x49fb28,'running'),'onLog':(_0x53801a,_0x54281f,_0x148573,_0x5e2cd5)=>{(this['logger'][_0x54281f]||this['logger']['info'])['call'](this['logger'],_0x148573,_0x5e2cd5);},'onResult':()=>{}},_0x8b7ef0['timeout']||0x1d4c0));}async['create'](_0x21e467){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x51541a=await this['lifecycle']['create'](this['config']['appId'],_0x21e467,this['config']['scriptUrl']);this['messaging']['setup'](_0x51541a),this['messaging']['sendInit'](_0x51541a,this['config']['appsDir'],_0x21e467,this['config']['serverPath']),this['handle']=_0x51541a,await this['waitForReady']();}async['waitForReady'](_0x533397=0x2710){let _0x236acc=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x236acc>_0x533397)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x523b84=>setTimeout(_0x523b84,0x64));}}async['invoke'](_0x3bcf9c){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x3bcf9c);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x2cc91a){return new L(_0x2cc91a);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};