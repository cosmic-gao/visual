'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x4fa84e){return _0x4fa84e&&_0x4fa84e['__esModule']?_0x4fa84e:{'default':_0x4fa84e};}var Y__default=_interopDefault(Y);async function ie(_0x5e30c9){try{return await promises['stat'](_0x5e30c9),!0x0;}catch{return![];}}var f={'error':(_0x51bf14,_0x48989a)=>console['error']('[ERROR]\x20'+_0x51bf14,_0x48989a),'warn':(_0x5ebd84,_0x277ae5)=>console['warn']('[WARN]\x20'+_0x5ebd84,_0x277ae5),'info':(_0x2e64ac,_0x4561cc)=>console['log']('[INFO]\x20'+_0x2e64ac,_0x4561cc),'debug':(_0x475c07,_0x1dbb39)=>console['log']('[DEBUG]\x20'+_0x475c07,_0x1dbb39)};function z(){let _0x46a69a=globalThis['Deno'];if(!_0x46a69a)throw new Error('Deno is not available');return _0x46a69a;}var D=class{constructor(_0x5c8da7,_0x5d04fe='./lib',_0x434ea4={}){this['manifest']=_0x5c8da7,this['libDir']=_0x5d04fe,this['platformImports']=_0x434ea4;}['buildPerms'](){let _0x412901=this['manifest']['permissions']||{},_0x5d321a={};return _0x412901['net']!==void 0x0&&(_0x5d321a['net']=_0x412901['net']===!![]?!![]:Array['isArray'](_0x412901['net'])?_0x412901['net']:[]),_0x412901['read']!==void 0x0&&(_0x5d321a['read']=_0x412901['read']===!![]?!![]:Array['isArray'](_0x412901['read'])?_0x412901['read']:[]),_0x412901['write']!==void 0x0&&(_0x5d321a['write']=_0x412901['write']===!![]?!![]:Array['isArray'](_0x412901['write'])?_0x412901['write']:[]),_0x412901['env']!==void 0x0&&(_0x5d321a['env']=_0x412901['env']===!![]?!![]:Array['isArray'](_0x412901['env'])?_0x412901['env']:[]),_0x412901['run']!==void 0x0&&(_0x5d321a['run']=_0x412901['run']===!![]?!![]:Array['isArray'](_0x412901['run'])?_0x412901['run']:[]),_0x412901['ffi']!==void 0x0&&(_0x5d321a['ffi']=_0x412901['ffi']===!![]?!![]:Array['isArray'](_0x412901['ffi'])?_0x412901['ffi']:[]),_0x412901['sys']!==void 0x0&&(_0x5d321a['sys']=_0x412901['sys']===!![]?!![]:Array['isArray'](_0x412901['sys'])?_0x412901['sys']:[]),_0x412901['hrtime']!==void 0x0&&(_0x5d321a['hrtime']=_0x412901['hrtime']),_0x5d321a;}['normalize'](_0x136927){return _0x136927===!![]?[]:Array['isArray'](_0x136927)?_0x136927:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x93d640){return path.join(this['libDir'],_0x93d640+'@*');}['getReadPaths'](){let _0x532a48=this['getImports']();_0x532a48['includes']('*')&&(_0x532a48=Object['keys'](this['platformImports']));let _0x502964=[];console['log']('[Permissions] Building package path patterns for imports:',_0x532a48);for(let _0x5ce64f of _0x532a48){let _0x1ed02d=this['getLibPattern'](_0x5ce64f);_0x502964['push'](_0x1ed02d),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x5ce64f+'\x20->\x20'+_0x1ed02d);}return console['log']('[Permissions] Final package path patterns:',_0x502964),_0x502964;}['buildImportMap'](_0x57a4ec){let _0x5045ae=this['getImports'](),_0x4ece04=_0x5045ae['includes']('*')?Object['keys'](_0x57a4ec):_0x5045ae;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x4ece04);let _0x2fdfac={};for(let _0x440af8 of _0x4ece04)if(_0x57a4ec[_0x440af8])_0x2fdfac[_0x440af8]=_0x57a4ec[_0x440af8],console['log']('[ImportMap]\x20'+_0x440af8+'\x20->\x20'+_0x57a4ec[_0x440af8]+'\x20(from\x20platform)');else try{let _0x4848de=z(),_0x4723cc=path.join(_0x4848de['cwd'](),this['libDir']),_0x2fa1bd=!0x1;try{for(let _0x3e381a of _0x4848de['readDirSync'](_0x4723cc))if(_0x3e381a['isDirectory']&&(_0x3e381a['name']===_0x440af8||_0x3e381a['name']['startsWith'](_0x440af8+'@'))){let _0x263c2b=path.join(_0x4848de['cwd'](),this['libDir'],_0x3e381a['name'],'index.js')['replace'](/\\/g,'/'),_0x1cac0e=new URL('file:///'+_0x263c2b)['href'];_0x2fdfac[_0x440af8]=_0x1cac0e,console['log']('[ImportMap]\x20'+_0x440af8+'\x20->\x20'+_0x1cac0e+'\x20(from\x20lib)'),_0x2fa1bd=!0x0;break;}}catch{}_0x2fa1bd||console['warn']('[ImportMap]\x20Package\x20'+_0x440af8+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x1a6496){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x440af8+':',_0x1a6496);}return _0x2fdfac;}['validateServerImports'](_0x95e681){let _0x16be19=this['manifest']['name']||this['manifest']['id'],_0x350bde=this['manifest']['metadata']?.['serverPath'],_0x18a6d7=_0x56f925=>_0x56f925['replace'](/\\/g,'/'),_0x3c9ee1=z(),_0x20ef6a=_0x252047=>{try{return _0x3c9ee1['statSync'](_0x252047),!0x0;}catch{return![];}},_0xeb5771=_0x350bde?_0x18a6d7(_0x350bde):void 0x0;if(!_0xeb5771){let _0x2b7eff=[_0x95e681+'/service/server.js',_0x95e681+'/service/server.ts',_0x95e681+'/'+_0x16be19+'/server.js',_0x95e681+'/'+_0x16be19+'/server.ts',_0x95e681+'/server.js',_0x95e681+'/server.ts']['map'](_0x18a6d7);for(let _0x58f240 of _0x2b7eff)if(_0x20ef6a(_0x58f240)){_0xeb5771=_0x58f240;break;}}if(!_0xeb5771)return{'valid':![],'violations':['Failed to locate server module']};let _0x190c2a='';try{_0x190c2a=_0x3c9ee1['readTextFileSync'](_0xeb5771);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0xeb5771};}let _0x53a683=this['getImports']();if(_0x53a683['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0xeb5771};let _0x1fed3d=_0x53a683,_0x519d6f=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0xb0c6d0=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x93b1fb=/\bimport\s*['"]([^'"]+)['"]/g,_0x392c9f=[],_0x2314f7=new Set(),_0x365779=_0x140f41=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x140f41),_0x2d1e1f=_0x33750c=>{let _0xd6079e=_0x33750c;if(_0xd6079e['startsWith']('./')||_0xd6079e['startsWith']('../')||_0xd6079e['startsWith']('/')||_0xd6079e['startsWith']('file://')||!_0x365779(_0x33750c)||_0x2314f7['has'](_0x33750c))return;_0x2314f7['add'](_0x33750c),_0xd6079e['startsWith']('npm:')&&(_0xd6079e=_0xd6079e['substring'](0x4)),_0xd6079e['includes']('@')&&!_0xd6079e['startsWith']('@')&&(_0xd6079e=_0xd6079e['split']('@')[0x0]);let _0x2f408c=_0xd6079e['split']('/')[0x0];_0x1fed3d['includes'](_0x2f408c)||_0x1fed3d['includes'](_0x33750c)||_0x392c9f['push'](_0x33750c);},_0x146775;for(;(_0x146775=_0x519d6f['exec'](_0x190c2a))!==null;)_0x2d1e1f(_0x146775[0x1]);for(;(_0x146775=_0xb0c6d0['exec'](_0x190c2a))!==null;)_0x2d1e1f(_0x146775[0x1]);for(;(_0x146775=_0x93b1fb['exec'](_0x190c2a))!==null;)_0x2d1e1f(_0x146775[0x1]);return{'valid':_0x392c9f['length']===0x0,'violations':_0x392c9f,'serverPath':_0xeb5771};}['validate'](_0x34b090={}){let _0x4cc9ad=[],_0x4cd1de=this['manifest']['permissions']||{};try{let _0x42ea35=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x42ea35);}catch{}let _0x25814d=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x546c34,_0x36b172]of Object['entries'](_0x4cd1de))if(_0x546c34==='hrtime')typeof _0x36b172!='boolean'&&_0x4cc9ad['push']('Permission\x20\x27'+_0x546c34+'\x27\x20must\x20be\x20boolean');else{if(_0x546c34==='langchain')typeof _0x36b172!='boolean'&&(typeof _0x36b172!='object'||_0x36b172===null)?_0x4cc9ad['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x36b172=='object'&&(_0x36b172===null||!('enabled'in _0x36b172)||typeof _0x36b172['enabled']!='boolean')&&_0x4cc9ad['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x546c34==='kv')typeof _0x36b172!='boolean'&&_0x4cc9ad['push']('Permission\x20\x27'+_0x546c34+'\x27\x20must\x20be\x20boolean');else{if(_0x546c34==='mspbots')Array['isArray'](_0x36b172)||_0x4cc9ad['push']('Permission\x20\x27'+_0x546c34+'\x27\x20must\x20be\x20an\x20array');else{if(_0x546c34==='db'){if(typeof _0x36b172!='object'||_0x36b172===null||Array['isArray'](_0x36b172))_0x4cc9ad['push']('Permission\x20\x27'+_0x546c34+'\x27\x20must\x20be\x20an\x20object');else{let _0x5a585d=_0x36b172,_0x3357ab=['user','password']['filter'](_0x4b6a2a=>!(_0x4b6a2a in _0x5a585d));_0x3357ab['length']>0x0&&_0x4cc9ad['push']('Permission\x20\x27'+_0x546c34+'\x27\x20missing\x20required\x20fields:\x20'+_0x3357ab['join'](',\x20'));}}else{if(_0x546c34==='imports')continue;_0x25814d['has'](_0x546c34)||typeof _0x36b172!='boolean'&&!Array['isArray'](_0x36b172)&&_0x4cc9ad['push']('Permission\x20\x27'+_0x546c34+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x363e9c=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x363e9c))_0x4cc9ad['push']('permissions.imports must be an array');else{for(let _0x152dab of _0x363e9c)typeof _0x152dab!='string'&&_0x4cc9ad['push']('import\x20\x27'+_0x152dab+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x4cc9ad['length']===0x0,'errors':_0x4cc9ad};}};function q(_0x58e530,_0x380faf,_0x616058){return new D(_0x58e530,_0x380faf,_0x616058||{});}var R=null;function I(){let _0x4b1d0c=globalThis['Deno'];if(!_0x4b1d0c)throw new Error('Deno is not available');return _0x4b1d0c;}async function K(){if(R)return{...R};try{let _0x450972=I(),_0x2e096e=path.join(_0x450972['cwd'](),'deno.json'),_0x46eb3b=await _0x450972['readTextFile'](_0x2e096e);return R=JSON['parse'](_0x46eb3b)['imports']||{},{...R};}catch(_0x3a8826){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x3a8826),{};}}var E=class{constructor(_0x3eea85,_0x14194a={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x3eea85['appsDir'],this['platformImportsOverride']=_0x3eea85['platformImports'],this['libDir']=_0x3eea85['libDir'],this['events']=_0x14194a);}async['create'](_0x5786fb,_0xd0ace1,_0x2367a8){try{return await this['createWorker'](_0x5786fb,_0xd0ace1,_0x2367a8);}catch(_0x5ef658){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x5786fb+':',_0x5ef658),_0x5ef658;}}async['createWorker'](_0x4dde4f,_0x95e48c,_0x55f774){let _0x255492=this['platformImportsOverride']||await K(),_0x1691d6=q(_0x95e48c,this['libDir'],_0x255492)['validateServerImports'](this['appsDir']);if(!_0x1691d6['valid']){let _0x2c972f=_0x1691d6['violations']['filter'](_0x4c7acb=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x4c7acb)),_0x3e9dd7=_0x1691d6['serverPath']?_0x1691d6['serverPath']:(_0x95e48c['name']||_0x95e48c['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x3e9dd7+':\x20'+_0x2c972f['join'](',\x20'));}let _0x14f16a=q(_0x95e48c,this['libDir'],_0x255492),_0x12d0d4=_0x14f16a['validate'](_0x255492);if(!_0x12d0d4['valid'])throw new Error('Invalid\x20config:\x20'+_0x12d0d4['errors']['join'](',\x20'));let _0x2d0f9a=_0x14f16a['buildImportMap'](_0x255492);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x4dde4f+':',_0x2d0f9a);let _0x3811cd=_0x14f16a['buildPerms'](),_0x14afc0=_0x14f16a['getReadPaths']();if(_0x3811cd['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x3811cd['read']);else{let _0x441330=_0x95e48c['name']||_0x4dde4f,_0x98f114=this['appsDir']+'/'+_0x441330,_0x39fc4=[_0x98f114],_0x4bc5fd=_0x95e48c['metadata']?.['serverPath'];if(_0x4bc5fd&&typeof _0x4bc5fd=='string')try{let _0x5ba8c7=path.dirname(_0x4bc5fd)['replace'](/\\/g,'/');_0x39fc4['push'](_0x5ba8c7);}catch{}_0x3811cd['read']=_0x39fc4,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x98f114);}if(_0x14afc0['length']>0x0){if(_0x3811cd['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x5978e8=Array['isArray'](_0x3811cd['read'])?_0x3811cd['read']:[];_0x3811cd['read']=[..._0x5978e8,..._0x14afc0],console['log']('[Worker] Added package read permissions:',_0x14afc0);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x3811cd['net']||(_0x3811cd['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x4dde4f+':',_0x3811cd['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x3811cd['read']===!![]?'unrestricted':Array['isArray'](_0x3811cd['read'])?_0x3811cd['read']['length']:0x0));let _0x559860=await this['createImportMap'](_0x4dde4f,_0x2d0f9a),_0x452f97=await this['createLock'](_0x4dde4f,_0x2d0f9a),_0x130a89={'type':'module','deno':{'permissions':{}}};_0x130a89['deno']['namespace']=![],_0x130a89['deno']['permissions']=_0x3811cd,_0x130a89['deno']['importMap']=_0x559860,_0x130a89['deno']['lock']=_0x452f97,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x4dde4f+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x559860),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x452f97),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x2d0f9a)['length']+'\x20('+(Object['keys'](_0x2d0f9a)['join'](',\x20')||'none')+')');let _0x531f08={'worker':new Worker(_0x55f774,_0x130a89),'appId':_0x4dde4f,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x95e48c,'importMapPath':_0x559860,'lockfilePath':_0x452f97};return this['workers']['set'](_0x4dde4f,_0x531f08),this['events']['onCreate']?.(_0x531f08),_0x531f08;}async['createLock'](_0x1ca837,_0x3f1bb7){let _0x813849=I(),_0x12aa58=path.join(_0x813849['cwd'](),'storage','temp','lockfiles');await _0x813849['mkdir'](_0x12aa58,{'recursive':!![]});let _0x458a26=_0x1ca837+'-'+Date['now']()+'.lock',_0x5bf9d9=path.join(_0x12aa58,_0x458a26),_0x4b1868={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x3d1f28,_0x105782]of Object['entries'](_0x3f1bb7))if(_0x105782['startsWith']('npm:'))_0x105782['replace']('npm:',''),_0x4b1868['packages']['specifiers'][_0x3d1f28]=_0x105782;else _0x105782['startsWith']('file://')&&(_0x4b1868['packages']['specifiers'][_0x3d1f28]=_0x105782);let _0x56173c=JSON['stringify'](_0x4b1868,null,0x2);return await _0x813849['writeTextFile'](_0x5bf9d9,_0x56173c),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x5bf9d9),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x3f1bb7)['length']+'):',Object['keys'](_0x3f1bb7)),_0x5bf9d9;}async['createImportMap'](_0x2c7fcc,_0x5ec5ac){let _0x51ff03=I(),_0x369ef5=path.join(_0x51ff03['cwd'](),'storage','temp','importmaps');await _0x51ff03['mkdir'](_0x369ef5,{'recursive':!![]});let _0x9c141f=_0x2c7fcc+'-'+Date['now']()+'.json',_0x435b8f=path.join(_0x369ef5,_0x9c141f),_0x18037e=JSON['stringify']({'imports':_0x5ec5ac,'scopes':{}},null,0x2);return await _0x51ff03['writeTextFile'](_0x435b8f,_0x18037e),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x435b8f),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x5ec5ac)['length']+'):',Object['keys'](_0x5ec5ac)['join'](',\x20')||'none'),_0x435b8f;}['get'](_0x598099){return this['workers']['get'](_0x598099);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x2f5f41,_0x5b10cc){let _0x47460b=this['workers']['get'](_0x2f5f41);if(!_0x47460b)return;let _0x24ab81=_0x47460b['status'];_0x47460b['status']=_0x5b10cc,_0x5b10cc==='running'&&_0x24ab81==='starting'?this['events']['onReady']?.(_0x47460b):_0x5b10cc==='crashed'&&this['events']['onCrash']?.(_0x47460b);}['touch'](_0x7869b9){let _0x298fb1=this['workers']['get'](_0x7869b9);_0x298fb1&&(_0x298fb1['lastUsed']=Date['now']());}async['stop'](_0x37bf80){let _0x43e928=this['workers']['get'](_0x37bf80);if(_0x43e928)try{_0x43e928['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x43e928['worker']['terminate'](),_0x43e928['status']='stopped',this['events']['onStop']?.(_0x43e928),_0x43e928['importMapPath']&&await this['cleanupImportMap'](_0x43e928['importMapPath']),_0x43e928['lockfilePath']&&await this['cleanupLock'](_0x43e928['lockfilePath']);}catch(_0x560355){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x37bf80+':',_0x560355);}finally{this['workers']['delete'](_0x37bf80);}}async['cleanupImportMap'](_0x5d483d){try{await I()['remove'](_0x5d483d),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x5d483d);}catch(_0x487257){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x5d483d,_0x487257);}}async['cleanupLock'](_0x566e67){try{await I()['remove'](_0x566e67),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x566e67);}catch(_0x2e029d){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x566e67,_0x2e029d);}}async['stopAll'](){let _0x22a71e=Array['from'](this['workers']['keys']());await Promise['all'](_0x22a71e['map'](_0x25b1c9=>this['stop'](_0x25b1c9)));}async['restart'](_0x5008e1,_0x326259){let _0x4570b6=this['workers']['get'](_0x5008e1);if(!_0x4570b6)throw new Error('Worker\x20'+_0x5008e1+'\x20not\x20found');let _0x1247e6=_0x4570b6['manifest'];return await this['stop'](_0x5008e1),await this['create'](_0x5008e1,_0x1247e6,_0x326259);}['checkHealth'](_0x220aa6){let _0xf27656=this['workers']['get'](_0x220aa6);if(!_0xf27656)return{'healthy':![],'reason':'Not\x20found'};if(_0xf27656['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0xf27656['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x389594=Date['now']()-_0xf27656['lastUsed'],_0x2e9188=0x708*0x3e8;return _0x389594>_0x2e9188?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x389594/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x3db19f=0x708*0x3e8,_0x46ae6e){let _0x5179e7=Date['now'](),_0x37e9c1=[];for(let [_0x206804,_0xb5360f]of this['workers']['entries']()){let _0x533e3b=_0x5179e7-_0xb5360f['lastUsed'];_0x533e3b>_0x3db19f&&_0x37e9c1['push']({'appId':_0x206804,'idle':_0x533e3b});}_0x37e9c1['sort']((_0x5a449c,_0x3ca20f)=>_0x3ca20f['idle']-_0x5a449c['idle']);let _0x4584a1=_0x46ae6e?_0x37e9c1['slice'](0x0,_0x46ae6e)['map'](_0x2129ed=>_0x2129ed['appId']):_0x37e9c1['map'](_0x11ec8d=>_0x11ec8d['appId']);for(let _0x30a2cc of _0x4584a1)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x30a2cc),await this['stop'](_0x30a2cc);}['stats'](){let _0x496ab0={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x1d6fe9=Date['now']();for(let _0x53d1b0 of this['workers']['values']())_0x496ab0['byStatus'][_0x53d1b0['status']]++,_0x496ab0['workers']['push']({'appId':_0x53d1b0['appId'],'status':_0x53d1b0['status'],'version':_0x53d1b0['version'],'lastUsed':_0x53d1b0['lastUsed'],'idle':_0x1d6fe9-_0x53d1b0['lastUsed']});return _0x496ab0;}['startCleanup'](_0x1b85a6=0x12c*0x3e8,_0x55c713){let _0x3d779c=setInterval(()=>{this['cleanup'](_0x55c713)['catch'](_0x317a01=>{console['error']('Cleanup\x20failed:',_0x317a01);});},_0x1b85a6);return()=>clearInterval(_0x3d779c);}['delay'](_0x54ba0e){return new Promise(_0x17019e=>setTimeout(_0x17019e,_0x54ba0e));}};function W(_0xa446f4,_0x4bffc9){return new E(_0xa446f4,_0x4bffc9);}var v=f,j=class{constructor(_0x3cc885,_0x5a63f5=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x3cc885,this['timeout']=_0x5a63f5);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x498715){_0x498715['worker']['onmessage']=_0x341b50=>{let _0x4586b9=_0x341b50['data'],{appId:_0x509ea7}=_0x498715;switch(_0x4586b9['type']){case'ready':this['events']['onReady'](_0x509ea7),v['info']('Worker\x20ready',{'appId':_0x509ea7,'version':_0x498715['version']});break;case'log':{let {level:_0x402ef9='info',message:_0x122a02,meta:_0x522ae9}=_0x4586b9,_0x438481={..._0x522ae9||{},'appId':_0x509ea7,'version':_0x498715['version']};this['events']['onLog'](_0x509ea7,_0x402ef9,_0x122a02,_0x438481);break;}case'result':{let {reqId:_0x142e92,ok:_0x523e8b,response:_0x25d020,error:_0x16717b}=_0x4586b9,_0x72f34d=this['pending']['get'](_0x142e92);if(!_0x72f34d){v['warn']('Unknown\x20request',{'appId':_0x509ea7,'reqId':_0x142e92});return;}if(this['pending']['delete'](_0x142e92),_0x523e8b&&_0x25d020)_0x72f34d['resolve'](_0x25d020);else{let _0x5c2ed7=new Error(_0x16717b?.['message']||'Worker\x20error');_0x5c2ed7['stack']=_0x16717b?.['stack'],_0x72f34d['reject'](_0x5c2ed7);}this['events']['onResult'](_0x509ea7,_0x142e92,_0x25d020||_0x16717b);break;}default:v['debug']('Unknown\x20message',{'appId':_0x509ea7,'type':_0x4586b9['type']});}},_0x498715['worker']['onerror']=_0x170d3d=>{let {appId:_0x17560c}=_0x498715;v['error']('Worker\x20error',{'appId':_0x17560c,'message':_0x170d3d['message'],'lineno':_0x170d3d['lineno'],'filename':_0x170d3d['filename']}),_0x498715['status']='crashed',this['rejectPending'](_0x17560c,new Error('Worker\x20'+_0x17560c+'\x20crashed:\x20'+_0x170d3d['message'])),_0x170d3d['preventDefault']();},_0x498715['worker']['onmessageerror']=_0x4fa5c3=>{let {appId:_0x4b0406}=_0x498715;v['error']('Message\x20error',{'appId':_0x4b0406,'data':_0x4fa5c3['data']}),_0x498715['status']='crashed',_0x4fa5c3['preventDefault']();};}['sendInit'](_0x53c876,_0x4b5f4e,_0x3ad6b1,_0x30326e){_0x53c876['worker']['postMessage']({'type':'init','appId':_0x53c876['appId'],'manifest':_0x3ad6b1,'appsDir':_0x4b5f4e,'serverPath':_0x30326e});}async['sendInvoke'](_0x180ef0,_0x6ef9b4){let _0x335aad=this['nextId'](),_0x15a2d8=_0x180ef0['appId'],_0x4bd3b1=new Promise((_0x26f7ab,_0x3c9f64)=>{let _0x4d07f2=setTimeout(()=>{this['pending']['delete'](_0x335aad),_0x3c9f64(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x335aad,{'resolve':_0x48f24d=>{clearTimeout(_0x4d07f2),_0x26f7ab(_0x48f24d);},'reject':_0x13fff9=>{clearTimeout(_0x4d07f2),_0x3c9f64(_0x13fff9);},'timestamp':Date['now'](),'appId':_0x15a2d8});});return _0x180ef0['worker']['postMessage']({'type':'invoke','appId':_0x180ef0['appId'],'reqId':_0x335aad,'payload':_0x6ef9b4}),await _0x4bd3b1;}['rejectPending'](_0x472c24,_0x365f01){let _0x2996fd=0x0;for(let [_0xa488a9,_0x5058ce]of this['pending']['entries']())_0x5058ce['appId']===_0x472c24&&(this['pending']['delete'](_0xa488a9),_0x5058ce['reject'](_0x365f01),_0x2996fd++);_0x2996fd>0x0&&v['warn']('Rejected\x20'+_0x2996fd+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x472c24});}['cleanupTimeout'](){let _0x3b958e=Date['now']();for(let [_0x8204f9,_0x354a1f]of this['pending']['entries']())_0x3b958e-_0x354a1f['timestamp']>this['timeout']&&(this['pending']['delete'](_0x8204f9),_0x354a1f['reject'](new Error('Request\x20'+_0x8204f9+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x3e91b9){let _0x40c4db=0x0;for(let _0x2a9ba5 of this['pending']['values']())_0x2a9ba5['appId']===_0x3e91b9&&_0x40c4db++;return _0x40c4db;}['startCleanup'](_0x32ce8a=0x2710){let _0x31f519=setInterval(()=>{this['cleanupTimeout']();},_0x32ce8a);return()=>clearInterval(_0x31f519);}};function $(_0x3fc4f9,_0x5a1f7a){return new j(_0x3fc4f9,_0x5a1f7a);}var Q=class{constructor(_0x1b5531={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x1b5531['logger']||f,this['config']={'appsDir':_0x1b5531['appsDir']||this['getAppsDir'](),'scriptUrl':_0x1b5531['scriptUrl']||this['getScriptUrl'](),'timeout':_0x1b5531['timeout']||0x78*0x3e8,'autoCleanup':_0x1b5531['autoCleanup']??!![],'cleanupInterval':_0x1b5531['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x1b5531['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x1b5531['maxWorkers'],'reuseWorkers':_0x1b5531['reuseWorkers']??!![],'workerReuseStrategy':_0x1b5531['workerReuseStrategy']||'lru','enableQueue':_0x1b5531['enableQueue']??!![],'maxQueueSize':_0x1b5531['maxQueueSize']||0x64,'queueTimeout':_0x1b5531['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x2d8ba9=>this['logger']['info']('Worker\x20created',{'appId':_0x2d8ba9['appId'],'v':_0x2d8ba9['version']}),'onReady':_0x1b86af=>this['lifecycle']['updateStatus'](_0x1b86af['appId'],'running'),'onCrash':_0x5c98b1=>this['logger']['error']('Worker\x20crashed',{'appId':_0x5c98b1['appId'],'v':_0x5c98b1['version']}),'onStop':_0x3b5249=>this['logger']['info']('Worker\x20stopped',{'appId':_0x3b5249['appId'],'v':_0x3b5249['version']})}),this['messaging']=$({'onReady':_0x1ac167=>this['lifecycle']['updateStatus'](_0x1ac167,'running'),'onLog':(_0x17d180,_0xe37267,_0x29fc56,_0x2642f7)=>{let _0x56a618={..._0x2642f7||{},'appId':_0x17d180};switch(_0xe37267){case'error':this['logger']['error'](_0x29fc56,_0x56a618);break;case'warn':this['logger']['warn'](_0x29fc56,_0x56a618);break;case'debug':this['logger']['debug'](_0x29fc56,_0x56a618);break;default:this['logger']['info'](_0x29fc56,_0x56a618);break;}},'onResult':(_0x1729a2,_0x2c2ebc,_0x4d3973)=>{this['logger']['debug']('Result\x20received',{'appId':_0x1729a2,'reqId':_0x2c2ebc});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x424391=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x56f315=_0x424391['endsWith']('.js')||_0x424391['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x56f315,_0x424391)['href'];}async['ensure'](_0x6e6864){let {id:_0x55bbad}=_0x6e6864,_0x5610b5=this['lifecycle']['get'](_0x55bbad);if(_0x5610b5){let _0x176642=this['lifecycle']['checkHealth'](_0x55bbad);if(_0x176642['healthy'])return this['lifecycle']['touch'](_0x55bbad),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x55bbad}),_0x5610b5;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x55bbad,'reason':_0x176642['reason']}),await this['lifecycle']['stop'](_0x55bbad);}for(;;){let _0x447b1b=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x447b1b>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x447b1b,'max':this['config']['maxWorkers'],'appId':_0x55bbad}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x6e6864);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x5c1b83=await this['loadManifest'](_0x55bbad,_0x6e6864['manifest']),_0x1a6ad2=await this['lifecycle']['create'](_0x55bbad,_0x5c1b83,this['config']['scriptUrl']),_0x37e8c1=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x37e8c1>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x37e8c1,'max':this['config']['maxWorkers'],'appId':_0x55bbad}),await this['lifecycle']['stop'](_0x55bbad),this['config']['enableQueue'])return await this['waitSlot'](_0x6e6864);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x37e8c1+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x1a6ad2);let _0x2df7ab=_0x5c1b83['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x1a6ad2,this['config']['appsDir'],_0x5c1b83,_0x2df7ab),this['logger']['info']('Worker\x20created',{'appId':_0x55bbad,'v':_0x1a6ad2['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x1a6ad2;}async['evictIdle'](){let _0xaf703=this['lifecycle']['getAll']();if(_0xaf703['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0xb437ae=[..._0xaf703];this['config']['workerReuseStrategy']==='lru'?_0xb437ae['sort']((_0x38546e,_0x4e5de0)=>_0x38546e['lastUsed']-_0x4e5de0['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0xb437ae['sort']((_0xb51caf,_0xc370e3)=>_0xb51caf['version']-_0xc370e3['version']);let _0x3b8b58=null;for(let _0x59b798 of _0xb437ae)if(this['messaging']['getAppCount'](_0x59b798['appId'])===0x0){_0x3b8b58=_0x59b798;break;}if(!_0x3b8b58&&_0xb437ae['length']>0x0&&(_0x3b8b58=_0xb437ae['reduce']((_0x350ed0,_0x421332)=>{let _0x2b934d=this['messaging']['getAppCount'](_0x350ed0['appId']);return this['messaging']['getAppCount'](_0x421332['appId'])<_0x2b934d?_0x421332:_0x350ed0;})),_0x3b8b58){let _0x32edca=this['messaging']['getAppCount'](_0x3b8b58['appId']);return _0x32edca>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x3b8b58['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x3b8b58['lastUsed'],'pendingRequests':_0x32edca}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x3b8b58['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x3b8b58['lastUsed']}),await this['lifecycle']['stop'](_0x3b8b58['appId']),!![];}return![];}['waitSlot'](_0x5c9283){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x460e75,_0x4269c0)=>{let _0x3c90c6={'info':_0x5c9283,'resolve':_0x460e75,'reject':_0x4269c0,'timestamp':Date['now']()};this['requestQueue']['push'](_0x3c90c6),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x5c9283['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x289a5d=setTimeout(()=>{let _0x391e77=this['requestQueue']['indexOf'](_0x3c90c6);_0x391e77!==-0x1&&(this['requestQueue']['splice'](_0x391e77,0x1),_0x4269c0(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x3c90c6['resolve']=_0x51da9c=>{clearTimeout(_0x289a5d),_0x460e75(_0x51da9c);},_0x3c90c6['reject']=_0x5791fb=>{clearTimeout(_0x289a5d),_0x4269c0(_0x5791fb);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x3d47d0=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x3d47d0>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x69fc24=this['requestQueue']['shift']();if(!_0x69fc24)break;try{let _0x1df126=await this['ensure'](_0x69fc24['info']);_0x69fc24['resolve'](_0x1df126);}catch(_0x36717e){_0x69fc24['reject'](_0x36717e);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x2264ba,_0x25501e){let _0x4c8972=this['config']['appsDir']['replace'](/\\/g,'/'),_0x38793d=async _0xeff4f8=>{try{let _0xa3b8f0=globalThis['Deno'];if(!_0xa3b8f0)return null;let _0x163fa6=await _0xa3b8f0['readTextFile'](_0xeff4f8);return JSON['parse'](_0x163fa6);}catch{return null;}};if(_0x25501e?.['name']){let _0x13c6f7=await _0x38793d(_0x4c8972+'/'+_0x25501e['name']+'/manifest.json');if(_0x13c6f7)return _0x13c6f7;}let _0x589d4f=await _0x38793d(_0x4c8972+'/'+_0x2264ba+'/manifest.json');if(_0x589d4f)return _0x589d4f;try{let _0x2c4d97=globalThis['Deno'];if(_0x2c4d97)for await(let _0x222272 of _0x2c4d97['readDir'](_0x4c8972)){if(!_0x222272['isDirectory'])continue;let _0x321626=_0x4c8972+'/'+_0x222272['name']+'/manifest.json',_0x5e457e=await _0x38793d(_0x321626);if(_0x5e457e&&(_0x5e457e['id']===_0x2264ba||_0x25501e?.['name']&&_0x5e457e['name']===_0x25501e['name']))return _0x5e457e;}}catch(_0x50ef28){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x2264ba,'error':_0x50ef28['message']});}return _0x25501e||{'id':_0x2264ba,'name':_0x2264ba,'version':'1.0.0'};}async['invoke'](_0x356dac){let _0x27eb3b=_0x356dac['ctx']['app']['id'],_0x258a9a=_0x356dac['ctx']['app']['name'];try{let _0x1f421f={'id':_0x27eb3b,'manifest':{'id':_0x27eb3b,'name':_0x258a9a}},_0xc7171c=await this['ensure'](_0x1f421f);if(_0xc7171c['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x27eb3b}),await this['restart'](_0x27eb3b);let _0x4e4fd5=await this['ensure'](_0x1f421f);return this['lifecycle']['touch'](_0x27eb3b),await this['messaging']['sendInvoke'](_0x4e4fd5,_0x356dac);}return this['lifecycle']['touch'](_0x27eb3b),await this['messaging']['sendInvoke'](_0xc7171c,_0x356dac);}catch(_0x32b599){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x27eb3b,'error':_0x32b599['message'],'stack':_0x32b599['stack']}),_0x32b599;}}async['stop'](_0x383e17){await this['lifecycle']['stop'](_0x383e17),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x5f397c){return await this['lifecycle']['restart'](_0x5f397c,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x2e41c2=>({'appId':_0x2e41c2['appId'],'status':_0x2e41c2['status'],'version':_0x2e41c2['version'],'lastUsed':_0x2e41c2['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0xa42fda=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x28df61=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0xa42fda(),_0x28df61();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x3a6f07=>{_0x3a6f07?(await this['stop'](_0x3a6f07),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x3a6f07})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x3392d2){return new Q(_0x3392d2);}var S=null;function be(_0x500953){S=ee(_0x500953);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x47d2a9){return await k()['ensure'](_0x47d2a9);}async function xe(_0x2e9928){return await k()['invoke'](_0x2e9928);}function Ie(_0x2ab0aa){k()['stop'](_0x2ab0aa)['catch'](_0x1dea1d=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x2ab0aa,'error':_0x1dea1d['message']});});}function Re(){k()['stopAll']()['catch'](_0x568085=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x568085['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x597555){await k()['stop'](_0x597555);}async function Se(){await k()['stopAll']();}function Ae(_0xe72e5){let _0x4680f0=_0xe72e5&&typeof _0xe72e5=='object'?_0xe72e5:null;if(_0x4680f0&&'user'in _0x4680f0)return _0x4680f0['user'];}function H(_0x5a2474){let _0x1162ef=_0x5a2474&&typeof _0x5a2474=='object'?_0x5a2474:null;if(!_0x1162ef)return{};let _0xa49b7b={};for(let [_0x543880,_0x2d2d47]of Object['entries'](_0x1162ef))_0x543880!=='user'&&(_0xa49b7b[_0x543880]=_0x2d2d47);return _0xa49b7b;}function O(_0x3911ed){return _0x3911ed?{'id':_0x3911ed['manifest']?.['id']||_0x3911ed['id']||'','name':_0x3911ed['manifest']?.['name']||'','version':_0x3911ed['manifest']?.['version']||'','description':_0x3911ed['manifest']?.['description']||'','icon':_0x3911ed['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x46b680){return _0x46b680?.['permissions']||_0x46b680?.['manifest']?.['permissions']||{};}function F(_0x1a5911){return _0x1a5911?.['manifest']?.['metadata']||{};}function Ce(_0x195bb1){return _0x195bb1?{'appId':_0x195bb1['id'],'appName':_0x195bb1['manifest']?.['name']}:{};}function N(_0x3351c5,_0x223570={}){let {appInfo:_0x5af3fd=null,status:_0x99881f=0x1f4,defaultMessage:_0x3a9d96='Internal\x20Server\x20Error'}=_0x223570,_0x57f8d4={'error':_0x3a9d96,'message':_0x3351c5?.['message']||_0x3a9d96};return _0x5af3fd&&(_0x57f8d4['appId']=_0x5af3fd['id'],_0x57f8d4['appName']=_0x5af3fd['manifest']?.['name']),_0x3351c5?.['message']?.['includes']('crashed')&&(_0x57f8d4['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x99881f,'body':_0x57f8d4};}function qe(_0x4fdd0f){return _0x4fdd0f?.['message']?.['includes']('crashed')||![];}function J(_0x2ead26){if(_0x2ead26)try{return JSON['parse'](_0x2ead26);}catch{return _0x2ead26;}}function B(_0x4f5814){try{let _0x42c104=new URL(_0x4f5814),_0xc7a073={};for(let _0x19c370 of _0x42c104['searchParams']['keys']()){let _0x57ef7a=_0x42c104['searchParams']['getAll'](_0x19c370)['map'](_0x263b3e=>_0x263b3e);_0x57ef7a['length']<=0x1?_0xc7a073[_0x19c370]=_0x57ef7a[0x0]??'':_0xc7a073[_0x19c370]=_0x57ef7a;}return _0xc7a073;}catch{return{};}}function Le(_0x27aab5){return(()=>{try{return new URL(_0x27aab5)['pathname'];}catch{return _0x27aab5;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x1ce733,_0x1f394c){let _0x2bfc74=_0x1ce733;if(_0x1f394c&&_0x2bfc74['startsWith']('/apps/'+_0x1f394c))_0x2bfc74=_0x2bfc74['substring'](('/apps/'+_0x1f394c)['length'])||'/';else{let _0x48c84c=_0x2bfc74['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x48c84c&&(_0x2bfc74=_0x48c84c[0x1]||'/');}return _0x2bfc74['startsWith']('/api')&&(_0x2bfc74=_0x2bfc74['substring'](0x4)||'/'),_0x2bfc74;}function Ue(_0x66d109,_0x5ee832){let _0x30449e=_0x66d109;if(_0x5ee832&&_0x30449e['startsWith']('/apps/'+_0x5ee832))_0x30449e=_0x30449e['substring'](('/apps/'+_0x5ee832)['length'])||'/';else{let _0x1845ce=_0x30449e['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x1845ce&&(_0x30449e=_0x1845ce[0x1]||'/');}return(!_0x30449e||_0x30449e==='/')&&(_0x30449e='/index.html'),_0x30449e;}async function He(_0x16f35e,_0x5a8a26){return await _0x5a8a26(_0x16f35e);}function _(_0x47c028){return _0x47c028['split']('/')['filter'](_0x52b1fd=>_0x52b1fd['length']>0x0);}function te(_0x16e30a){try{return decodeURIComponent(_0x16e30a);}catch{return _0x16e30a;}}function re(_0x4ac153,_0xc21e59){let _0x17bb08=_(_0x4ac153),_0x140691=_(_0xc21e59),_0x54fd88={},_0xb4e39a=0x0,_0x17b85c=0x0;for(;_0xb4e39a<_0x17bb08['length']&&_0x17b85c<_0x140691['length'];){let _0x3a634a=_0x17bb08[_0xb4e39a],_0x159436=_0x140691[_0x17b85c];if(_0x3a634a==='*')break;if(_0x3a634a['startsWith'](':')){let _0x40eb13=_0x3a634a['slice'](0x1);_0x40eb13&&(_0x54fd88[_0x40eb13]=te(_0x159436)),_0xb4e39a++,_0x17b85c++;continue;}if(_0x3a634a!==_0x159436)return{};_0xb4e39a++,_0x17b85c++;}return _0xb4e39a===_0x17bb08['length']||_0xb4e39a===_0x17bb08['length']-0x1&&_0x17bb08[_0xb4e39a]==='*',_0x54fd88;}async function Oe(_0x5b9ce0,_0x4b7990,_0x48cbd1,_0x127893,_0x358aee=void 0x0,_0x4ed39e){let _0x5cc60f=await _0x4b7990['text'](),_0x26334d=J(_0x5cc60f),_0x4e44dc=B(_0x4b7990['url']),_0x10b6d1={...F(_0x5b9ce0),'user':_0x358aee},_0x26bf40=H(_0x10b6d1),_0xf8291=_0x4ed39e?re(_0x4ed39e,_0x4b7990['path']):{};return{'app':O(_0x5b9ce0),'permissions':T(_0x5b9ce0),'user':_0x358aee,'metadata':_0x26bf40,'body':_0x26334d,'query':_0x4e44dc,'params':_0xf8291,'method':_0x48cbd1,'pathname':_0x127893,'requestUrl':_0x4b7990['url'],'headers':Object['fromEntries'](_0x4b7990['raw']['headers']['entries']())};}function Te(_0x436826){return{'method':_0x436826['method'],'pathname':_0x436826['pathname'],'ctx':_0x436826};}function Fe(_0x155ac2,_0x375ffc){let {status:_0x43be54=0xc8,headers:_0x4aa5a5={},body:_0xfad121,type:_0xd6e9d1}=_0x155ac2??{};return _0xd6e9d1==='raw'?new globalThis['Response'](String(_0xfad121??''),{'status':_0x43be54,'headers':_0x4aa5a5}):_0x375ffc(_0xfad121,_0x43be54);}function Ne(_0x1836e6,_0x14cf1a=null){return N(_0x1836e6,{'appInfo':_0x14cf1a});}var V=f;async function Ve(_0x12c506){_0x12c506?(await U(_0x12c506),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x12c506)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x18d165,_0x1dc2c1){let _0x1016d1=Object['fromEntries'](Object['entries'](_0x18d165['headers']||{})['map'](([_0x395585,_0x3eae5c])=>[_0x395585['toLowerCase'](),_0x3eae5c]));return{'id':_0x18d165['app']['id']||_0x1dc2c1['appId']||'','name':_0x18d165['app']['name']||'','version':_0x18d165['app']['version']||'','description':_0x18d165['app']['description']||'','metadata':{..._0x18d165['metadata'],'permissions':_0x18d165['permissions']},'body':_0x18d165['body'],'query':_0x18d165['query'],'params':_0x18d165?.['params'],'method':_0x18d165['method'],'pathname':_0x18d165['pathname'],'requestUrl':_0x18d165['requestUrl'],'user':_0x18d165['user'],'headers':_0x1016d1};}var L=class{constructor(_0x4f84f3){this['handle']=null,(this['config']=_0x4f84f3,this['logger']=_0x4f84f3['logger']||f,this['lifecycle']=W({'appsDir':_0x4f84f3['appsDir'],'timeout':_0x4f84f3['timeout'],'platformImports':_0x4f84f3['platformImports'],'libDir':_0x4f84f3['libDir']},{'onCreate':_0x3ceb81=>this['logger']['info']('Worker\x20created',{'appId':_0x3ceb81['appId']}),'onReady':_0x303584=>{this['lifecycle']['updateStatus'](_0x303584['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x303584['appId']});},'onCrash':_0x2cb910=>this['logger']['error']('Worker\x20crashed',{'appId':_0x2cb910['appId']}),'onStop':_0x489f74=>this['logger']['info']('Worker\x20stopped',{'appId':_0x489f74['appId']})}),this['messaging']=$({'onReady':_0x4f8bfb=>this['lifecycle']['updateStatus'](_0x4f8bfb,'running'),'onLog':(_0x204cd9,_0x12b2e1,_0x20e791,_0x44db05)=>{(this['logger'][_0x12b2e1]||this['logger']['info'])['call'](this['logger'],_0x20e791,_0x44db05);},'onResult':()=>{}},_0x4f84f3['timeout']||0x1d4c0));}async['create'](_0x352fa6){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x1a9d6b=await this['lifecycle']['create'](this['config']['appId'],_0x352fa6,this['config']['scriptUrl']);this['messaging']['setup'](_0x1a9d6b),this['messaging']['sendInit'](_0x1a9d6b,this['config']['appsDir'],_0x352fa6,this['config']['serverPath']),this['handle']=_0x1a9d6b,await this['waitForReady']();}async['waitForReady'](_0x1d3add=0x2710){let _0x20f47e=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x20f47e>_0x1d3add)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x4ae143=>setTimeout(_0x4ae143,0x64));}}async['invoke'](_0xfa86d8){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0xfa86d8);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x120ad4){return new L(_0x120ad4);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;