'use strict';function c(_0x17f22f,_0x527d57){let _0x37e8f3=Object['fromEntries'](Object['entries'](_0x17f22f['headers']||{})['map'](([_0x416f66,_0x44cf6c])=>[_0x416f66['toLowerCase'](),_0x44cf6c]));return{'id':_0x17f22f['app']['id']||_0x527d57['appId']||'','name':_0x17f22f['app']['name']||'','version':_0x17f22f['app']['version']||'','description':_0x17f22f['app']['description']||'','metadata':{..._0x17f22f['metadata'],'permissions':_0x17f22f['permissions']},'body':_0x17f22f['body'],'query':_0x17f22f['query'],'params':_0x17f22f?.['params'],'method':_0x17f22f['method'],'pathname':_0x17f22f['pathname'],'requestUrl':_0x17f22f['requestUrl'],'user':_0x17f22f['user'],'headers':_0x37e8f3};}function f(_0x31ec5b){return _0x31ec5b['split']('/')['filter'](_0x43b149=>_0x43b149['length']>0x0);}function P(_0x1c4fe5,_0x2bf2cf){let _0x1dd855=f(_0x1c4fe5),_0x425f8b=f(_0x2bf2cf),_0x22f5c8=0x0,_0x3102c3=0x0;for(;_0x22f5c8<_0x1dd855['length']&&_0x3102c3<_0x425f8b['length'];){let _0x32e3d6=_0x1dd855[_0x22f5c8],_0x22f315=_0x425f8b[_0x3102c3];if(_0x32e3d6==='*')return!![];if(_0x32e3d6['startsWith'](':')){_0x22f5c8++,_0x3102c3++;continue;}if(_0x32e3d6!==_0x22f315)return![];_0x22f5c8++,_0x3102c3++;}return _0x22f5c8===_0x1dd855['length']&&_0x3102c3===_0x425f8b['length']||_0x22f5c8===_0x1dd855['length']-0x1&&_0x1dd855[_0x22f5c8]==='*';}function m(_0x395eac,_0x7b26b7,_0x4b7866){let _0x1717fa=_0x7b26b7+'\x20'+_0x4b7866;if(_0x395eac[_0x1717fa])return{'handler':_0x395eac[_0x1717fa],'routePattern':_0x4b7866};let _0x457017=[];_0x4b7866['startsWith']('/api')?_0x457017['push'](_0x4b7866['substring'](0x4)||'/'):_0x457017['push']('/api'+_0x4b7866),_0x457017['push'](_0x4b7866);for(let _0x29f46f of _0x457017)for(let _0x5b860c of Object['keys'](_0x395eac)){if(!_0x5b860c['startsWith'](_0x7b26b7+'\x20'))continue;let _0x2acc9c=_0x5b860c['substring'](_0x7b26b7['length']+0x1);if(P(_0x2acc9c,_0x29f46f))return{'handler':_0x395eac[_0x5b860c],'routePattern':_0x2acc9c};}return null;}function k(_0x57cd23){return typeof _0x57cd23=='function'?{'handler':_0x57cd23,'routePattern':''}:_0x57cd23;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x23145d){let _0x2dd406=async _0x3e611c=>{try{let _0x278b91=globalThis['Deno'];if(!_0x278b91)throw new Error('Deno is not available');return await _0x278b91['stat'](_0x3e611c),!0x0;}catch{return![];}};if(_0x23145d&&typeof _0x23145d=='string'&&_0x23145d['length']>0x0)return _0x23145d;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x974dfd=s['manifest']?.['metadata']?.['serverPath'];if(_0x974dfd&&typeof _0x974dfd=='string'&&_0x974dfd['length']>0x0)return _0x974dfd;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x24cb5e=s['manifest']['name'];if(!_0x24cb5e)throw new Error('Manifest\x20name\x20not\x20found');let _0x1e103c=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x24cb5e+'/server.js',s['appsDir']+'/'+_0x24cb5e+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x3bd8b3 of _0x1e103c)if(await _0x2dd406(_0x3bd8b3))return _0x3bd8b3;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x1e103c['join'](',\x20'));}function R(){let _0xc0d67=['log','info','warn','error','debug','trace'];for(let _0x7f11b of _0xc0d67){let _0xb06281=(console[_0x7f11b]||console['log'])['bind'](console);console[_0x7f11b]=(..._0x309d37)=>{try{let _0x29b1a8=_0x309d37['map'](_0x54180f=>{if(typeof _0x54180f=='string')return _0x54180f;if(_0x54180f instanceof Error)return JSON['stringify']({'name':_0x54180f['name'],'message':_0x54180f['message'],'stack':_0x54180f['stack']});if(typeof Request<'u'&&_0x54180f instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x54180f['url'],'method':_0x54180f['method'],'headers':Object['fromEntries'](_0x54180f['headers']['entries']()),'bodyUsed':_0x54180f['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x54180f instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x54180f['status'],'headers':Object['fromEntries'](_0x54180f['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x54180f);}catch{return String(_0x54180f);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x7f11b==='log'?'info':_0x7f11b,'message':_0x29b1a8,'meta':{'appId':s['appId']}});}catch{_0xb06281(..._0x309d37);}};}}R();async function v(_0x4a73fd){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x125a87=(await w(_0x4a73fd))['replace'](/\\/g,'/'),_0x41b82d=(_0x125a87['startsWith']('file://')?_0x125a87:'file://'+_0x125a87)+'?t='+Date['now']();try{let _0x4094f3=await import(_0x41b82d);return s['module']=_0x4094f3,_0x4094f3;}catch(_0x3f657f){throw console['error']('Failed to load module:',_0x3f657f),_0x3f657f;}}function b(_0x52e9c8){return _0x52e9c8 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x52e9c8,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x12bea7){return _0x12bea7['split']('/')['filter'](_0x6f96df=>_0x6f96df['length']>0x0);}function E(_0x5721d5){try{return decodeURIComponent(_0x5721d5);}catch{return _0x5721d5;}}function I(_0x4e948,_0x45930e){let _0x244ddc=g(_0x4e948),_0x348386=g(_0x45930e),_0x96d9a6={},_0x397e07=0x0,_0x2df937=0x0;for(;_0x397e07<_0x244ddc['length']&&_0x2df937<_0x348386['length'];){let _0x484715=_0x244ddc[_0x397e07],_0x1cf71b=_0x348386[_0x2df937];if(_0x484715==='*')break;if(_0x484715['startsWith'](':')){let _0x3e66fb=_0x484715['slice'](0x1);_0x3e66fb&&(_0x96d9a6[_0x3e66fb]=E(_0x1cf71b)),_0x397e07++,_0x2df937++;continue;}if(_0x484715!==_0x1cf71b)return{};_0x397e07++,_0x2df937++;}return _0x397e07===_0x244ddc['length']||_0x397e07===_0x244ddc['length']-0x1&&_0x244ddc[_0x397e07]==='*',_0x96d9a6;}function M(_0xad5520,_0x56e0c6){return _0xad5520['startsWith']('/api')&&!_0x56e0c6['startsWith']('/api')?_0xad5520['substring'](0x4)||'/':!_0xad5520['startsWith']('/api')&&_0x56e0c6['startsWith']('/api')?'/api'+(_0xad5520['startsWith']('/')?'':'/')+_0xad5520:_0xad5520;}async function W(_0x1ddae4){let _0x2c3a87=_0x1ddae4['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x2c3a87)&&await v(_0x2c3a87);let _0x54e749=_0x1ddae4['ctx'],{method:_0x58f630,pathname:_0x45017c}=_0x54e749,_0xbf28fd=s['module']?.['default']||{},_0x56ba77=m(_0xbf28fd,_0x58f630,_0x45017c);if(!_0x56ba77)throw Object['assign'](new Error('Route\x20'+_0x58f630+'\x20'+_0x45017c+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x53de69=k(_0x56ba77),_0x4f6b57=c(_0x54e749,s),_0x582321=_0x45017c,_0x12f7b0=M(_0x53de69['routePattern'],_0x582321),_0x5d63c7=_0x12f7b0?I(_0x12f7b0,_0x582321):{},_0x1db25b=await _0x53de69['handler']({..._0x4f6b57,'params':{..._0x4f6b57['params'],..._0x5d63c7}});return b(_0x1db25b);}function D(_0x5333b2){s['appId']=_0x5333b2['appId'],s['manifest']=_0x5333b2['manifest'],s['appsDir']=_0x5333b2['appsDir'],s['serverPath']=_0x5333b2['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x12d492){let {reqId:_0x298172,payload:_0x453f7b}=_0x12d492;try{let _0x790c91=await W(_0x453f7b);self['postMessage']({'type':'result','reqId':_0x298172,'ok':!0x0,'response':_0x790c91});}catch(_0x5dff26){let _0x4624e4=_0x5dff26;self['postMessage']({'type':'result','reqId':_0x298172,'ok':![],'error':{'message':_0x4624e4['message'],'stack':_0x4624e4['stack'],'code':_0x4624e4['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x1722b5=>{let _0x85563e=_0x1722b5['data'];try{switch(_0x85563e['type']){case'init':D(_0x85563e);break;case'invoke':await $(_0x85563e);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x85563e['type']);break;}}catch(_0x4e9b79){let _0x306639=_0x4e9b79;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x306639['message'],'stack':_0x306639['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x306639);}}},self['onerror']=_0x4259e6=>{let _0x1340f2={'message':typeof _0x4259e6=='string'?_0x4259e6:_0x4259e6['message'],'filename':typeof _0x4259e6=='string'?void 0x0:_0x4259e6['filename'],'lineno':typeof _0x4259e6=='string'?void 0x0:_0x4259e6['lineno'],'colno':typeof _0x4259e6=='string'?void 0x0:_0x4259e6['colno'],'error':typeof _0x4259e6=='string'?void 0x0:_0x4259e6['error']?.['message'],'stack':typeof _0x4259e6=='string'?void 0x0:_0x4259e6['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x1340f2);},self['onunhandledrejection']=_0x34f118=>{let _0x4f30b1=_0x34f118['reason'],_0x983124={'appId':s['appId'],'reason':_0x4f30b1 instanceof Error?_0x4f30b1['message']:String(_0x4f30b1),'stack':_0x4f30b1 instanceof Error?_0x4f30b1['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x983124);};