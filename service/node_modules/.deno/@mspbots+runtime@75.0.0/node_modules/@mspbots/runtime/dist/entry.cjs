'use strict';function c(_0x3ffffe,_0xf31593){let _0x57f3f8=Object['fromEntries'](Object['entries'](_0x3ffffe['headers']||{})['map'](([_0x52059a,_0x3193ea])=>[_0x52059a['toLowerCase'](),_0x3193ea]));return{'id':_0x3ffffe['app']['id']||_0xf31593['appId']||'','name':_0x3ffffe['app']['name']||'','version':_0x3ffffe['app']['version']||'','description':_0x3ffffe['app']['description']||'','metadata':{..._0x3ffffe['metadata'],'permissions':_0x3ffffe['permissions']},'body':_0x3ffffe['body'],'query':_0x3ffffe['query'],'params':_0x3ffffe?.['params'],'method':_0x3ffffe['method'],'pathname':_0x3ffffe['pathname'],'requestUrl':_0x3ffffe['requestUrl'],'user':_0x3ffffe['user'],'headers':_0x57f3f8};}function f(_0x47bc59){return _0x47bc59['split']('/')['filter'](_0x17eb4a=>_0x17eb4a['length']>0x0);}function P(_0x39c0a1,_0x5bb25a){let _0x1fc686=f(_0x39c0a1),_0x11973f=f(_0x5bb25a),_0x2056c6=0x0,_0x1486fb=0x0;for(;_0x2056c6<_0x1fc686['length']&&_0x1486fb<_0x11973f['length'];){let _0x48401e=_0x1fc686[_0x2056c6],_0x19a37c=_0x11973f[_0x1486fb];if(_0x48401e==='*')return!![];if(_0x48401e['startsWith'](':')){_0x2056c6++,_0x1486fb++;continue;}if(_0x48401e!==_0x19a37c)return![];_0x2056c6++,_0x1486fb++;}return _0x2056c6===_0x1fc686['length']&&_0x1486fb===_0x11973f['length']||_0x2056c6===_0x1fc686['length']-0x1&&_0x1fc686[_0x2056c6]==='*';}function m(_0x1e6757,_0x191bd4,_0x499087){let _0x5cdf03=_0x191bd4+'\x20'+_0x499087;if(_0x1e6757[_0x5cdf03])return{'handler':_0x1e6757[_0x5cdf03],'routePattern':_0x499087};let _0x1b13b4=[];_0x499087['startsWith']('/api')?_0x1b13b4['push'](_0x499087['substring'](0x4)||'/'):_0x1b13b4['push']('/api'+_0x499087),_0x1b13b4['push'](_0x499087);for(let _0x1f5afd of _0x1b13b4)for(let _0x11327a of Object['keys'](_0x1e6757)){if(!_0x11327a['startsWith'](_0x191bd4+'\x20'))continue;let _0x290d4c=_0x11327a['substring'](_0x191bd4['length']+0x1);if(P(_0x290d4c,_0x1f5afd))return{'handler':_0x1e6757[_0x11327a],'routePattern':_0x290d4c};}return null;}function k(_0x5cec4b){return typeof _0x5cec4b=='function'?{'handler':_0x5cec4b,'routePattern':''}:_0x5cec4b;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x4ec378){let _0x447e67=async _0x53ea59=>{try{let _0xe05993=globalThis['Deno'];if(!_0xe05993)throw new Error('Deno is not available');return await _0xe05993['stat'](_0x53ea59),!0x0;}catch{return![];}};if(_0x4ec378&&typeof _0x4ec378=='string'&&_0x4ec378['length']>0x0)return _0x4ec378;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x1264ea=s['manifest']?.['metadata']?.['serverPath'];if(_0x1264ea&&typeof _0x1264ea=='string'&&_0x1264ea['length']>0x0)return _0x1264ea;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x2285aa=s['manifest']['name'];if(!_0x2285aa)throw new Error('Manifest\x20name\x20not\x20found');let _0xd56f53=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x2285aa+'/server.js',s['appsDir']+'/'+_0x2285aa+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x565063 of _0xd56f53)if(await _0x447e67(_0x565063))return _0x565063;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0xd56f53['join'](',\x20'));}function R(){let _0x4d55a0=['log','info','warn','error','debug','trace'];for(let _0x2b2c84 of _0x4d55a0){let _0x1220ea=(console[_0x2b2c84]||console['log'])['bind'](console);console[_0x2b2c84]=(..._0x255a32)=>{try{let _0x394c54=_0x255a32['map'](_0xbf0473=>{if(typeof _0xbf0473=='string')return _0xbf0473;if(_0xbf0473 instanceof Error)return JSON['stringify']({'name':_0xbf0473['name'],'message':_0xbf0473['message'],'stack':_0xbf0473['stack']});if(typeof Request<'u'&&_0xbf0473 instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0xbf0473['url'],'method':_0xbf0473['method'],'headers':Object['fromEntries'](_0xbf0473['headers']['entries']()),'bodyUsed':_0xbf0473['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0xbf0473 instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0xbf0473['status'],'headers':Object['fromEntries'](_0xbf0473['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0xbf0473);}catch{return String(_0xbf0473);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x2b2c84==='log'?'info':_0x2b2c84,'message':_0x394c54,'meta':{'appId':s['appId']}});}catch{_0x1220ea(..._0x255a32);}};}}R();async function v(_0x1e5a07){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x45dcef=(await w(_0x1e5a07))['replace'](/\\/g,'/'),_0x56d105=(_0x45dcef['startsWith']('file://')?_0x45dcef:'file://'+_0x45dcef)+'?t='+Date['now']();try{let _0x4c4066=await import(_0x56d105);return s['module']=_0x4c4066,_0x4c4066;}catch(_0x3e822b){throw console['error']('Failed to load module:',_0x3e822b),_0x3e822b;}}function b(_0xdb7fee){return _0xdb7fee instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0xdb7fee,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x2d6a2e){return _0x2d6a2e['split']('/')['filter'](_0x355602=>_0x355602['length']>0x0);}function E(_0x1414f6){try{return decodeURIComponent(_0x1414f6);}catch{return _0x1414f6;}}function I(_0x16a413,_0x26b4be){let _0x373dd3=g(_0x16a413),_0x5e3a78=g(_0x26b4be),_0x3a3b3f={},_0x2b6b53=0x0,_0x31267a=0x0;for(;_0x2b6b53<_0x373dd3['length']&&_0x31267a<_0x5e3a78['length'];){let _0x260004=_0x373dd3[_0x2b6b53],_0x43d930=_0x5e3a78[_0x31267a];if(_0x260004==='*')break;if(_0x260004['startsWith'](':')){let _0x1d638c=_0x260004['slice'](0x1);_0x1d638c&&(_0x3a3b3f[_0x1d638c]=E(_0x43d930)),_0x2b6b53++,_0x31267a++;continue;}if(_0x260004!==_0x43d930)return{};_0x2b6b53++,_0x31267a++;}return _0x2b6b53===_0x373dd3['length']||_0x2b6b53===_0x373dd3['length']-0x1&&_0x373dd3[_0x2b6b53]==='*',_0x3a3b3f;}function M(_0x4b24a5,_0x58bc0b){return _0x4b24a5['startsWith']('/api')&&!_0x58bc0b['startsWith']('/api')?_0x4b24a5['substring'](0x4)||'/':!_0x4b24a5['startsWith']('/api')&&_0x58bc0b['startsWith']('/api')?'/api'+(_0x4b24a5['startsWith']('/')?'':'/')+_0x4b24a5:_0x4b24a5;}async function W(_0x2a2cb6){let _0x499941=_0x2a2cb6['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x499941)&&await v(_0x499941);let _0xba034b=_0x2a2cb6['ctx'],{method:_0x430fcc,pathname:_0x230d0b}=_0xba034b,_0x92131d=s['module']?.['default']||{},_0x24d14a=m(_0x92131d,_0x430fcc,_0x230d0b);if(!_0x24d14a)throw Object['assign'](new Error('Route\x20'+_0x430fcc+'\x20'+_0x230d0b+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x52034d=k(_0x24d14a),_0x58e991=c(_0xba034b,s),_0x1582cd=_0x230d0b,_0x40d1b2=M(_0x52034d['routePattern'],_0x1582cd),_0x223f44=_0x40d1b2?I(_0x40d1b2,_0x1582cd):{},_0x30826c=await _0x52034d['handler']({..._0x58e991,'params':{..._0x58e991['params'],..._0x223f44}});return b(_0x30826c);}function D(_0x3843d2){s['appId']=_0x3843d2['appId'],s['manifest']=_0x3843d2['manifest'],s['appsDir']=_0x3843d2['appsDir'],s['serverPath']=_0x3843d2['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x11e4d2){let {reqId:_0x2fa674,payload:_0x2e2a43}=_0x11e4d2;try{let _0x32f32f=await W(_0x2e2a43);self['postMessage']({'type':'result','reqId':_0x2fa674,'ok':!0x0,'response':_0x32f32f});}catch(_0xdf73fe){let _0x226485=_0xdf73fe;self['postMessage']({'type':'result','reqId':_0x2fa674,'ok':![],'error':{'message':_0x226485['message'],'stack':_0x226485['stack'],'code':_0x226485['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x233566=>{let _0x3cd43f=_0x233566['data'];try{switch(_0x3cd43f['type']){case'init':D(_0x3cd43f);break;case'invoke':await $(_0x3cd43f);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x3cd43f['type']);break;}}catch(_0x4b5d50){let _0x2732cf=_0x4b5d50;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x2732cf['message'],'stack':_0x2732cf['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x2732cf);}}},self['onerror']=_0x5be47b=>{let _0x4979fc={'message':typeof _0x5be47b=='string'?_0x5be47b:_0x5be47b['message'],'filename':typeof _0x5be47b=='string'?void 0x0:_0x5be47b['filename'],'lineno':typeof _0x5be47b=='string'?void 0x0:_0x5be47b['lineno'],'colno':typeof _0x5be47b=='string'?void 0x0:_0x5be47b['colno'],'error':typeof _0x5be47b=='string'?void 0x0:_0x5be47b['error']?.['message'],'stack':typeof _0x5be47b=='string'?void 0x0:_0x5be47b['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x4979fc);},self['onunhandledrejection']=_0x1bf5a5=>{let _0x537946=_0x1bf5a5['reason'],_0x2ba315={'appId':s['appId'],'reason':_0x537946 instanceof Error?_0x537946['message']:String(_0x537946),'stack':_0x537946 instanceof Error?_0x537946['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x2ba315);};