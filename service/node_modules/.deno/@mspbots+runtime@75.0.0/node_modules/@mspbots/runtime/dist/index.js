import{join,dirname}from'path';import _0x140f08 from'process';import{stat}from'fs/promises';async function ie(_0x58a954){try{return await stat(_0x58a954),!0x0;}catch{return![];}}var f={'error':(_0x17e456,_0x5d8c39)=>console['error']('[ERROR]\x20'+_0x17e456,_0x5d8c39),'warn':(_0x58c217,_0x1b8168)=>console['warn']('[WARN]\x20'+_0x58c217,_0x1b8168),'info':(_0x10931d,_0x2a47f2)=>console['log']('[INFO]\x20'+_0x10931d,_0x2a47f2),'debug':(_0x3b2006,_0x5047aa)=>console['log']('[DEBUG]\x20'+_0x3b2006,_0x5047aa)};function z(){let _0xac6a83=globalThis['Deno'];if(!_0xac6a83)throw new Error('Deno is not available');return _0xac6a83;}var D=class{constructor(_0x22311d,_0x13e4ec='./lib',_0x1d68cf={}){this['manifest']=_0x22311d,this['libDir']=_0x13e4ec,this['platformImports']=_0x1d68cf;}['buildPerms'](){let _0x48accb=this['manifest']['permissions']||{},_0x1abf30={};return _0x48accb['net']!==void 0x0&&(_0x1abf30['net']=_0x48accb['net']===!![]?!![]:Array['isArray'](_0x48accb['net'])?_0x48accb['net']:[]),_0x48accb['read']!==void 0x0&&(_0x1abf30['read']=_0x48accb['read']===!![]?!![]:Array['isArray'](_0x48accb['read'])?_0x48accb['read']:[]),_0x48accb['write']!==void 0x0&&(_0x1abf30['write']=_0x48accb['write']===!![]?!![]:Array['isArray'](_0x48accb['write'])?_0x48accb['write']:[]),_0x48accb['env']!==void 0x0&&(_0x1abf30['env']=_0x48accb['env']===!![]?!![]:Array['isArray'](_0x48accb['env'])?_0x48accb['env']:[]),_0x48accb['run']!==void 0x0&&(_0x1abf30['run']=_0x48accb['run']===!![]?!![]:Array['isArray'](_0x48accb['run'])?_0x48accb['run']:[]),_0x48accb['ffi']!==void 0x0&&(_0x1abf30['ffi']=_0x48accb['ffi']===!![]?!![]:Array['isArray'](_0x48accb['ffi'])?_0x48accb['ffi']:[]),_0x48accb['sys']!==void 0x0&&(_0x1abf30['sys']=_0x48accb['sys']===!![]?!![]:Array['isArray'](_0x48accb['sys'])?_0x48accb['sys']:[]),_0x48accb['hrtime']!==void 0x0&&(_0x1abf30['hrtime']=_0x48accb['hrtime']),_0x1abf30;}['normalize'](_0x184577){return _0x184577===!![]?[]:Array['isArray'](_0x184577)?_0x184577:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x51a093){return join(this['libDir'],_0x51a093+'@*');}['getReadPaths'](){let _0x170faa=this['getImports']();_0x170faa['includes']('*')&&(_0x170faa=Object['keys'](this['platformImports']));let _0x4a09cd=[];console['log']('[Permissions] Building package path patterns for imports:',_0x170faa);for(let _0x5392b of _0x170faa){let _0x43937b=this['getLibPattern'](_0x5392b);_0x4a09cd['push'](_0x43937b),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x5392b+'\x20->\x20'+_0x43937b);}return console['log']('[Permissions] Final package path patterns:',_0x4a09cd),_0x4a09cd;}['buildImportMap'](_0x53f41e){let _0xa6f074=this['getImports'](),_0x57ebd8=_0xa6f074['includes']('*')?Object['keys'](_0x53f41e):_0xa6f074;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x57ebd8);let _0x3ff52f={};for(let _0x5ae235 of _0x57ebd8)if(_0x53f41e[_0x5ae235])_0x3ff52f[_0x5ae235]=_0x53f41e[_0x5ae235],console['log']('[ImportMap]\x20'+_0x5ae235+'\x20->\x20'+_0x53f41e[_0x5ae235]+'\x20(from\x20platform)');else try{let _0x380511=z(),_0x16df36=join(_0x380511['cwd'](),this['libDir']),_0x91868e=!0x1;try{for(let _0x18496f of _0x380511['readDirSync'](_0x16df36))if(_0x18496f['isDirectory']&&(_0x18496f['name']===_0x5ae235||_0x18496f['name']['startsWith'](_0x5ae235+'@'))){let _0x1a7231=join(_0x380511['cwd'](),this['libDir'],_0x18496f['name'],'index.js')['replace'](/\\/g,'/'),_0x1ffd7b=new URL('file:///'+_0x1a7231)['href'];_0x3ff52f[_0x5ae235]=_0x1ffd7b,console['log']('[ImportMap]\x20'+_0x5ae235+'\x20->\x20'+_0x1ffd7b+'\x20(from\x20lib)'),_0x91868e=!0x0;break;}}catch{}_0x91868e||console['warn']('[ImportMap]\x20Package\x20'+_0x5ae235+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x20bc6f){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x5ae235+':',_0x20bc6f);}return _0x3ff52f;}['validateServerImports'](_0x2b5ab3){let _0x4ae5b9=this['manifest']['name']||this['manifest']['id'],_0x1b5bbe=this['manifest']['metadata']?.['serverPath'],_0x3ba6b9=_0x3b2eed=>_0x3b2eed['replace'](/\\/g,'/'),_0x6ca982=z(),_0x1fab94=_0x1bb737=>{try{return _0x6ca982['statSync'](_0x1bb737),!0x0;}catch{return![];}},_0x4ebcbc=_0x1b5bbe?_0x3ba6b9(_0x1b5bbe):void 0x0;if(!_0x4ebcbc){let _0x4d32ff=[_0x2b5ab3+'/service/server.js',_0x2b5ab3+'/service/server.ts',_0x2b5ab3+'/'+_0x4ae5b9+'/server.js',_0x2b5ab3+'/'+_0x4ae5b9+'/server.ts',_0x2b5ab3+'/server.js',_0x2b5ab3+'/server.ts']['map'](_0x3ba6b9);for(let _0x15794a of _0x4d32ff)if(_0x1fab94(_0x15794a)){_0x4ebcbc=_0x15794a;break;}}if(!_0x4ebcbc)return{'valid':![],'violations':['Failed to locate server module']};let _0x3fce2f='';try{_0x3fce2f=_0x6ca982['readTextFileSync'](_0x4ebcbc);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x4ebcbc};}let _0x3dd169=this['getImports']();if(_0x3dd169['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x4ebcbc};let _0x54812c=_0x3dd169,_0x47fb80=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x59b52b=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0xef73df=/\bimport\s*['"]([^'"]+)['"]/g,_0x12edd8=[],_0x182b39=new Set(),_0x13e130=_0x383f49=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x383f49),_0x486e55=_0x32a3a0=>{let _0x2d014c=_0x32a3a0;if(_0x2d014c['startsWith']('./')||_0x2d014c['startsWith']('../')||_0x2d014c['startsWith']('/')||_0x2d014c['startsWith']('file://')||!_0x13e130(_0x32a3a0)||_0x182b39['has'](_0x32a3a0))return;_0x182b39['add'](_0x32a3a0),_0x2d014c['startsWith']('npm:')&&(_0x2d014c=_0x2d014c['substring'](0x4)),_0x2d014c['includes']('@')&&!_0x2d014c['startsWith']('@')&&(_0x2d014c=_0x2d014c['split']('@')[0x0]);let _0x1b2575=_0x2d014c['split']('/')[0x0];_0x54812c['includes'](_0x1b2575)||_0x54812c['includes'](_0x32a3a0)||_0x12edd8['push'](_0x32a3a0);},_0x7b0695;for(;(_0x7b0695=_0x47fb80['exec'](_0x3fce2f))!==null;)_0x486e55(_0x7b0695[0x1]);for(;(_0x7b0695=_0x59b52b['exec'](_0x3fce2f))!==null;)_0x486e55(_0x7b0695[0x1]);for(;(_0x7b0695=_0xef73df['exec'](_0x3fce2f))!==null;)_0x486e55(_0x7b0695[0x1]);return{'valid':_0x12edd8['length']===0x0,'violations':_0x12edd8,'serverPath':_0x4ebcbc};}['validate'](_0x47ff12={}){let _0x15aea7=[],_0x3225cb=this['manifest']['permissions']||{};for(let [_0x336f2e,_0x405ea4]of Object['entries'](_0x3225cb))if(_0x336f2e==='hrtime')typeof _0x405ea4!='boolean'&&_0x15aea7['push']('Permission\x20\x27'+_0x336f2e+'\x27\x20must\x20be\x20boolean');else{if(_0x336f2e==='db'){if(typeof _0x405ea4!='object'||_0x405ea4===null||Array['isArray'](_0x405ea4))_0x15aea7['push']('Permission\x20\x27'+_0x336f2e+'\x27\x20must\x20be\x20an\x20object');else{let _0x198e07=_0x405ea4,_0x33a6cb=['user','password']['filter'](_0x495b0e=>!(_0x495b0e in _0x198e07));_0x33a6cb['length']>0x0&&_0x15aea7['push']('Permission\x20\x27'+_0x336f2e+'\x27\x20missing\x20required\x20fields:\x20'+_0x33a6cb['join'](',\x20'));}}else{if(_0x336f2e==='imports')continue;}}let _0x4df00a=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x4df00a))_0x15aea7['push']('permissions.imports must be an array');else{for(let _0x4ebb47 of _0x4df00a)typeof _0x4ebb47!='string'&&_0x15aea7['push']('import\x20\x27'+_0x4ebb47+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x15aea7['length']===0x0,'errors':_0x15aea7};}};function q(_0x435bef,_0x521227,_0xa77506){return new D(_0x435bef,_0x521227,_0xa77506||{});}var R=null;function I(){let _0x3875cc=globalThis['Deno'];if(!_0x3875cc)throw new Error('Deno is not available');return _0x3875cc;}async function K(){if(R)return{...R};try{let _0x239c77=I(),_0x3498f4=join(_0x239c77['cwd'](),'deno.json'),_0x1ddee6=await _0x239c77['readTextFile'](_0x3498f4);return R=JSON['parse'](_0x1ddee6)['imports']||{},{...R};}catch(_0x5335c4){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x5335c4),{};}}var E=class{constructor(_0x22cff7,_0x195ad8={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x22cff7['appsDir'],this['platformImportsOverride']=_0x22cff7['platformImports'],this['libDir']=_0x22cff7['libDir'],this['events']=_0x195ad8);}async['create'](_0x57a05e,_0x807ae8,_0x1e995f){try{return await this['createWorker'](_0x57a05e,_0x807ae8,_0x1e995f);}catch(_0x49e79d){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x57a05e+':',_0x49e79d),_0x49e79d;}}async['createWorker'](_0x349dbf,_0x4e2d42,_0x405cde){let _0x4e66c2=this['platformImportsOverride']||await K(),_0x2a1eaf=q(_0x4e2d42,this['libDir'],_0x4e66c2)['validateServerImports'](this['appsDir']);if(!_0x2a1eaf['valid']){let _0x21ea5a=_0x2a1eaf['violations']['filter'](_0x14acef=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x14acef)),_0x316f64=_0x2a1eaf['serverPath']?_0x2a1eaf['serverPath']:(_0x4e2d42['name']||_0x4e2d42['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x316f64+':\x20'+_0x21ea5a['join'](',\x20'));}let _0x16dce6=q(_0x4e2d42,this['libDir'],_0x4e66c2),_0x38af9f=_0x16dce6['validate'](_0x4e66c2);if(!_0x38af9f['valid'])throw new Error('Invalid\x20config:\x20'+_0x38af9f['errors']['join'](',\x20'));let _0x31db8b=_0x16dce6['buildImportMap'](_0x4e66c2);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x349dbf+':',_0x31db8b);let _0x105d73=_0x16dce6['buildPerms'](),_0x5399ed=_0x16dce6['getReadPaths']();if(_0x105d73['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x105d73['read']);else{let _0x3c95cc=_0x4e2d42['name']||_0x349dbf,_0x453c3c=this['appsDir']+'/'+_0x3c95cc,_0x40c05c=[_0x453c3c],_0x38b4a6=_0x4e2d42['metadata']?.['serverPath'];if(_0x38b4a6&&typeof _0x38b4a6=='string')try{let _0x459db9=dirname(_0x38b4a6)['replace'](/\\/g,'/');_0x40c05c['push'](_0x459db9);}catch{}_0x105d73['read']=_0x40c05c,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x453c3c);}if(_0x5399ed['length']>0x0){if(_0x105d73['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x16013b=Array['isArray'](_0x105d73['read'])?_0x105d73['read']:[];_0x105d73['read']=[..._0x16013b,..._0x5399ed],console['log']('[Worker] Added package read permissions:',_0x5399ed);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x105d73['net']||(_0x105d73['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x349dbf+':',_0x105d73['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x105d73['read']===!![]?'unrestricted':Array['isArray'](_0x105d73['read'])?_0x105d73['read']['length']:0x0));let _0x3f0fd4=await this['createImportMap'](_0x349dbf,_0x31db8b),_0x25c841=await this['createLock'](_0x349dbf,_0x31db8b),_0x44aab0={'type':'module','deno':{'permissions':{}}};_0x44aab0['deno']['namespace']=![],_0x44aab0['deno']['permissions']=_0x105d73,_0x44aab0['deno']['importMap']=_0x3f0fd4,_0x44aab0['deno']['lock']=_0x25c841,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x349dbf+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x3f0fd4),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x25c841),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x31db8b)['length']+'\x20('+(Object['keys'](_0x31db8b)['join'](',\x20')||'none')+')');let _0x50aa28={'worker':new Worker(_0x405cde,_0x44aab0),'appId':_0x349dbf,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x4e2d42,'importMapPath':_0x3f0fd4,'lockfilePath':_0x25c841};return this['workers']['set'](_0x349dbf,_0x50aa28),this['events']['onCreate']?.(_0x50aa28),_0x50aa28;}async['createLock'](_0xb4c5f3,_0x1cd7dd){let _0x3f64c5=I(),_0x505245=join(_0x3f64c5['cwd'](),'storage','temp','lockfiles');await _0x3f64c5['mkdir'](_0x505245,{'recursive':!![]});let _0x3e2316=_0xb4c5f3+'-'+Date['now']()+'.lock',_0x2d848c=join(_0x505245,_0x3e2316),_0x543c1e={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x5caace,_0x86b7fb]of Object['entries'](_0x1cd7dd))if(_0x86b7fb['startsWith']('npm:'))_0x86b7fb['replace']('npm:',''),_0x543c1e['packages']['specifiers'][_0x5caace]=_0x86b7fb;else _0x86b7fb['startsWith']('file://')&&(_0x543c1e['packages']['specifiers'][_0x5caace]=_0x86b7fb);let _0x52ba6e=JSON['stringify'](_0x543c1e,null,0x2);return await _0x3f64c5['writeTextFile'](_0x2d848c,_0x52ba6e),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x2d848c),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x1cd7dd)['length']+'):',Object['keys'](_0x1cd7dd)),_0x2d848c;}async['createImportMap'](_0x4062f4,_0x3afffe){let _0x595aa6=I(),_0xaac1a1=join(_0x595aa6['cwd'](),'storage','temp','importmaps');await _0x595aa6['mkdir'](_0xaac1a1,{'recursive':!![]});let _0x379011=_0x4062f4+'-'+Date['now']()+'.json',_0x9fe877=join(_0xaac1a1,_0x379011),_0x11ef33=JSON['stringify']({'imports':_0x3afffe,'scopes':{}},null,0x2);return await _0x595aa6['writeTextFile'](_0x9fe877,_0x11ef33),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x9fe877),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x3afffe)['length']+'):',Object['keys'](_0x3afffe)['join'](',\x20')||'none'),_0x9fe877;}['get'](_0x41c1da){return this['workers']['get'](_0x41c1da);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x21a73f,_0x7d1592){let _0xa09864=this['workers']['get'](_0x21a73f);if(!_0xa09864)return;let _0x44525c=_0xa09864['status'];_0xa09864['status']=_0x7d1592,_0x7d1592==='running'&&_0x44525c==='starting'?this['events']['onReady']?.(_0xa09864):_0x7d1592==='crashed'&&this['events']['onCrash']?.(_0xa09864);}['touch'](_0x260e90){let _0x217458=this['workers']['get'](_0x260e90);_0x217458&&(_0x217458['lastUsed']=Date['now']());}async['stop'](_0x182d8d){let _0x261c03=this['workers']['get'](_0x182d8d);if(_0x261c03)try{_0x261c03['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x261c03['worker']['terminate'](),_0x261c03['status']='stopped',this['events']['onStop']?.(_0x261c03),_0x261c03['importMapPath']&&await this['cleanupImportMap'](_0x261c03['importMapPath']),_0x261c03['lockfilePath']&&await this['cleanupLock'](_0x261c03['lockfilePath']);}catch(_0x30313d){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x182d8d+':',_0x30313d);}finally{this['workers']['delete'](_0x182d8d);}}async['cleanupImportMap'](_0xfce2e8){try{await I()['remove'](_0xfce2e8),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0xfce2e8);}catch(_0x17e98b){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0xfce2e8,_0x17e98b);}}async['cleanupLock'](_0x3c99a3){try{await I()['remove'](_0x3c99a3),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x3c99a3);}catch(_0x546733){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x3c99a3,_0x546733);}}async['stopAll'](){let _0x6eca4f=Array['from'](this['workers']['keys']());await Promise['all'](_0x6eca4f['map'](_0x1fa494=>this['stop'](_0x1fa494)));}async['restart'](_0x14b855,_0x4639a6){let _0x229e82=this['workers']['get'](_0x14b855);if(!_0x229e82)throw new Error('Worker\x20'+_0x14b855+'\x20not\x20found');let _0x22fe0d=_0x229e82['manifest'];return await this['stop'](_0x14b855),await this['create'](_0x14b855,_0x22fe0d,_0x4639a6);}['checkHealth'](_0x232ec8){let _0x21b4b0=this['workers']['get'](_0x232ec8);if(!_0x21b4b0)return{'healthy':![],'reason':'Not\x20found'};if(_0x21b4b0['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x21b4b0['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x577fe2=Date['now']()-_0x21b4b0['lastUsed'],_0x6851ef=0x708*0x3e8;return _0x577fe2>_0x6851ef?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x577fe2/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x4638e4=0x708*0x3e8,_0x240b54){let _0x37bb34=Date['now'](),_0x59498a=[];for(let [_0x18b509,_0x377755]of this['workers']['entries']()){let _0x4f37b0=_0x37bb34-_0x377755['lastUsed'];_0x4f37b0>_0x4638e4&&_0x59498a['push']({'appId':_0x18b509,'idle':_0x4f37b0});}_0x59498a['sort']((_0x3a547a,_0x4942a7)=>_0x4942a7['idle']-_0x3a547a['idle']);let _0x1ecc07=_0x240b54?_0x59498a['slice'](0x0,_0x240b54)['map'](_0x147193=>_0x147193['appId']):_0x59498a['map'](_0x414a99=>_0x414a99['appId']);for(let _0x1eab37 of _0x1ecc07)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x1eab37),await this['stop'](_0x1eab37);}['stats'](){let _0x5a0a58={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x222a3f=Date['now']();for(let _0x51f089 of this['workers']['values']())_0x5a0a58['byStatus'][_0x51f089['status']]++,_0x5a0a58['workers']['push']({'appId':_0x51f089['appId'],'status':_0x51f089['status'],'version':_0x51f089['version'],'lastUsed':_0x51f089['lastUsed'],'idle':_0x222a3f-_0x51f089['lastUsed']});return _0x5a0a58;}['startCleanup'](_0x247b79=0x12c*0x3e8,_0x291e03){let _0x54f218=setInterval(()=>{this['cleanup'](_0x291e03)['catch'](_0x18d6ba=>{console['error']('Cleanup\x20failed:',_0x18d6ba);});},_0x247b79);return()=>clearInterval(_0x54f218);}['delay'](_0x4d1399){return new Promise(_0x5629ad=>setTimeout(_0x5629ad,_0x4d1399));}};function W(_0x3b5555,_0xe1512e){return new E(_0x3b5555,_0xe1512e);}var v=f,j=class{constructor(_0x1ff6b0,_0x284c79=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x1ff6b0,this['timeout']=_0x284c79);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x418a9c){_0x418a9c['worker']['onmessage']=_0x22bd26=>{let _0x1345df=_0x22bd26['data'],{appId:_0x4867a7}=_0x418a9c;switch(_0x1345df['type']){case'ready':this['events']['onReady'](_0x4867a7),v['info']('Worker\x20ready',{'appId':_0x4867a7,'version':_0x418a9c['version']});break;case'log':{let {level:_0x9ccd1d='info',message:_0x779af7,meta:_0xb7f976}=_0x1345df,_0x173bbd={..._0xb7f976||{},'appId':_0x4867a7,'version':_0x418a9c['version']};this['events']['onLog'](_0x4867a7,_0x9ccd1d,_0x779af7,_0x173bbd);break;}case'result':{let {reqId:_0xc7e67c,ok:_0x3b334f,response:_0x2324ad,error:_0x3b9d4a}=_0x1345df,_0x28ccda=this['pending']['get'](_0xc7e67c);if(!_0x28ccda){v['warn']('Unknown\x20request',{'appId':_0x4867a7,'reqId':_0xc7e67c});return;}if(this['pending']['delete'](_0xc7e67c),_0x3b334f&&_0x2324ad)_0x28ccda['resolve'](_0x2324ad);else{let _0x997c1e=new Error(_0x3b9d4a?.['message']||'Worker\x20error');_0x997c1e['stack']=_0x3b9d4a?.['stack'],_0x28ccda['reject'](_0x997c1e);}this['events']['onResult'](_0x4867a7,_0xc7e67c,_0x2324ad||_0x3b9d4a);break;}default:v['debug']('Unknown\x20message',{'appId':_0x4867a7,'type':_0x1345df['type']});}},_0x418a9c['worker']['onerror']=_0x202601=>{let {appId:_0x180369}=_0x418a9c;v['error']('Worker\x20error',{'appId':_0x180369,'message':_0x202601['message'],'lineno':_0x202601['lineno'],'filename':_0x202601['filename']}),_0x418a9c['status']='crashed',this['rejectPending'](_0x180369,new Error('Worker\x20'+_0x180369+'\x20crashed:\x20'+_0x202601['message'])),_0x202601['preventDefault']();},_0x418a9c['worker']['onmessageerror']=_0x59034f=>{let {appId:_0x14576c}=_0x418a9c;v['error']('Message\x20error',{'appId':_0x14576c,'data':_0x59034f['data']}),_0x418a9c['status']='crashed',_0x59034f['preventDefault']();};}['sendInit'](_0xd06b63,_0x19d67c,_0x4a30fb,_0x1aae8e){_0xd06b63['worker']['postMessage']({'type':'init','appId':_0xd06b63['appId'],'manifest':_0x4a30fb,'appsDir':_0x19d67c,'serverPath':_0x1aae8e});}async['sendInvoke'](_0x428f41,_0x5108af){let _0x2c8030=this['nextId'](),_0x52da72=_0x428f41['appId'],_0x7f3436=new Promise((_0x237f28,_0x140985)=>{let _0x4565ca=setTimeout(()=>{this['pending']['delete'](_0x2c8030),_0x140985(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x2c8030,{'resolve':_0x5c73d7=>{clearTimeout(_0x4565ca),_0x237f28(_0x5c73d7);},'reject':_0x248008=>{clearTimeout(_0x4565ca),_0x140985(_0x248008);},'timestamp':Date['now'](),'appId':_0x52da72});});return _0x428f41['worker']['postMessage']({'type':'invoke','appId':_0x428f41['appId'],'reqId':_0x2c8030,'payload':_0x5108af}),await _0x7f3436;}['rejectPending'](_0x551f34,_0x293cd2){let _0xc3af65=0x0;for(let [_0x292a2e,_0x2e75ca]of this['pending']['entries']())_0x2e75ca['appId']===_0x551f34&&(this['pending']['delete'](_0x292a2e),_0x2e75ca['reject'](_0x293cd2),_0xc3af65++);_0xc3af65>0x0&&v['warn']('Rejected\x20'+_0xc3af65+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x551f34});}['cleanupTimeout'](){let _0x236626=Date['now']();for(let [_0x3b7699,_0x382000]of this['pending']['entries']())_0x236626-_0x382000['timestamp']>this['timeout']&&(this['pending']['delete'](_0x3b7699),_0x382000['reject'](new Error('Request\x20'+_0x3b7699+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x19da0a){let _0x3fbbdb=0x0;for(let _0x88c9b2 of this['pending']['values']())_0x88c9b2['appId']===_0x19da0a&&_0x3fbbdb++;return _0x3fbbdb;}['startCleanup'](_0x52cca5=0x2710){let _0x49b2c0=setInterval(()=>{this['cleanupTimeout']();},_0x52cca5);return()=>clearInterval(_0x49b2c0);}};function S(_0x20d857,_0x2faa6d){return new j(_0x20d857,_0x2faa6d);}var Q=class{constructor(_0x4df84c={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x4df84c['logger']||f,this['config']={'appsDir':_0x4df84c['appsDir']||this['getAppsDir'](),'scriptUrl':_0x4df84c['scriptUrl']||this['getScriptUrl'](),'timeout':_0x4df84c['timeout']||0x78*0x3e8,'autoCleanup':_0x4df84c['autoCleanup']??!![],'cleanupInterval':_0x4df84c['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x4df84c['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x4df84c['maxWorkers'],'reuseWorkers':_0x4df84c['reuseWorkers']??!![],'workerReuseStrategy':_0x4df84c['workerReuseStrategy']||'lru','enableQueue':_0x4df84c['enableQueue']??!![],'maxQueueSize':_0x4df84c['maxQueueSize']||0x64,'queueTimeout':_0x4df84c['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x16f192=>this['logger']['info']('Worker\x20created',{'appId':_0x16f192['appId'],'v':_0x16f192['version']}),'onReady':_0x52bb02=>this['lifecycle']['updateStatus'](_0x52bb02['appId'],'running'),'onCrash':_0x905d9d=>this['logger']['error']('Worker\x20crashed',{'appId':_0x905d9d['appId'],'v':_0x905d9d['version']}),'onStop':_0x25ce03=>this['logger']['info']('Worker\x20stopped',{'appId':_0x25ce03['appId'],'v':_0x25ce03['version']})}),this['messaging']=S({'onReady':_0x47c8c3=>this['lifecycle']['updateStatus'](_0x47c8c3,'running'),'onLog':(_0x9bbdad,_0x4c44a0,_0x564bcf,_0x40dc9d)=>{let _0x453cbc={..._0x40dc9d||{},'appId':_0x9bbdad};switch(_0x4c44a0){case'error':this['logger']['error'](_0x564bcf,_0x453cbc);break;case'warn':this['logger']['warn'](_0x564bcf,_0x453cbc);break;case'debug':this['logger']['debug'](_0x564bcf,_0x453cbc);break;default:this['logger']['info'](_0x564bcf,_0x453cbc);break;}},'onResult':(_0xa0ff4d,_0x5d9160,_0x386672)=>{this['logger']['debug']('Result\x20received',{'appId':_0xa0ff4d,'reqId':_0x5d9160});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x140f08['cwd'](),'apps');}['getScriptUrl'](){let _0x59be55=import.meta.url,_0x5251e8=_0x59be55['endsWith']('.js')||_0x59be55['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x5251e8,_0x59be55)['href'];}async['ensure'](_0x28d8d9){let {id:_0x3200d1}=_0x28d8d9,_0xf2d7c4=this['lifecycle']['get'](_0x3200d1);if(_0xf2d7c4){let _0x3d2d1e=this['lifecycle']['checkHealth'](_0x3200d1);if(_0x3d2d1e['healthy'])return this['lifecycle']['touch'](_0x3200d1),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x3200d1}),_0xf2d7c4;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x3200d1,'reason':_0x3d2d1e['reason']}),await this['lifecycle']['stop'](_0x3200d1);}for(;;){let _0x34246c=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x34246c>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x34246c,'max':this['config']['maxWorkers'],'appId':_0x3200d1}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x28d8d9);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x19b267=await this['loadManifest'](_0x3200d1,_0x28d8d9['manifest']),_0xd13077=await this['lifecycle']['create'](_0x3200d1,_0x19b267,this['config']['scriptUrl']),_0x1c6ca2=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x1c6ca2>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x1c6ca2,'max':this['config']['maxWorkers'],'appId':_0x3200d1}),await this['lifecycle']['stop'](_0x3200d1),this['config']['enableQueue'])return await this['waitSlot'](_0x28d8d9);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x1c6ca2+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0xd13077);let _0x25a4f1=_0x19b267['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0xd13077,this['config']['appsDir'],_0x19b267,_0x25a4f1),this['logger']['info']('Worker\x20created',{'appId':_0x3200d1,'v':_0xd13077['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0xd13077;}async['evictIdle'](){let _0x33d04f=this['lifecycle']['getAll']();if(_0x33d04f['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x4816f3=[..._0x33d04f];this['config']['workerReuseStrategy']==='lru'?_0x4816f3['sort']((_0x493878,_0x396697)=>_0x493878['lastUsed']-_0x396697['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x4816f3['sort']((_0x551d02,_0x5e87f3)=>_0x551d02['version']-_0x5e87f3['version']);let _0x16d4cc=null;for(let _0xfdcb2 of _0x4816f3)if(this['messaging']['getAppCount'](_0xfdcb2['appId'])===0x0){_0x16d4cc=_0xfdcb2;break;}if(!_0x16d4cc&&_0x4816f3['length']>0x0&&(_0x16d4cc=_0x4816f3['reduce']((_0x5783fd,_0x56e47b)=>{let _0x4145a8=this['messaging']['getAppCount'](_0x5783fd['appId']);return this['messaging']['getAppCount'](_0x56e47b['appId'])<_0x4145a8?_0x56e47b:_0x5783fd;})),_0x16d4cc){let _0x2ca8a0=this['messaging']['getAppCount'](_0x16d4cc['appId']);return _0x2ca8a0>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x16d4cc['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x16d4cc['lastUsed'],'pendingRequests':_0x2ca8a0}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x16d4cc['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x16d4cc['lastUsed']}),await this['lifecycle']['stop'](_0x16d4cc['appId']),!![];}return![];}['waitSlot'](_0x59d957){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x43a5b7,_0x2aa1b1)=>{let _0x238d27={'info':_0x59d957,'resolve':_0x43a5b7,'reject':_0x2aa1b1,'timestamp':Date['now']()};this['requestQueue']['push'](_0x238d27),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x59d957['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x259f88=setTimeout(()=>{let _0x177a84=this['requestQueue']['indexOf'](_0x238d27);_0x177a84!==-0x1&&(this['requestQueue']['splice'](_0x177a84,0x1),_0x2aa1b1(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x238d27['resolve']=_0x4e79bb=>{clearTimeout(_0x259f88),_0x43a5b7(_0x4e79bb);},_0x238d27['reject']=_0x3f8be7=>{clearTimeout(_0x259f88),_0x2aa1b1(_0x3f8be7);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x350708=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x350708>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0xd22422=this['requestQueue']['shift']();if(!_0xd22422)break;try{let _0x20464c=await this['ensure'](_0xd22422['info']);_0xd22422['resolve'](_0x20464c);}catch(_0x4bf184){_0xd22422['reject'](_0x4bf184);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x389cad,_0x37e034){let _0xc6773e=this['config']['appsDir']['replace'](/\\/g,'/'),_0x47a8b6=async _0x3dc67d=>{try{let _0x2b282f=globalThis['Deno'];if(!_0x2b282f)return null;let _0x825ac1=await _0x2b282f['readTextFile'](_0x3dc67d);return JSON['parse'](_0x825ac1);}catch{return null;}};if(_0x37e034?.['name']){let _0x5dd405=await _0x47a8b6(_0xc6773e+'/'+_0x37e034['name']+'/manifest.json');if(_0x5dd405)return _0x5dd405;}let _0x5be80b=await _0x47a8b6(_0xc6773e+'/'+_0x389cad+'/manifest.json');if(_0x5be80b)return _0x5be80b;try{let _0x41244c=globalThis['Deno'];if(_0x41244c)for await(let _0x294b02 of _0x41244c['readDir'](_0xc6773e)){if(!_0x294b02['isDirectory'])continue;let _0x28bb54=_0xc6773e+'/'+_0x294b02['name']+'/manifest.json',_0x19b3da=await _0x47a8b6(_0x28bb54);if(_0x19b3da&&(_0x19b3da['id']===_0x389cad||_0x37e034?.['name']&&_0x19b3da['name']===_0x37e034['name']))return _0x19b3da;}}catch(_0x1010a9){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x389cad,'error':_0x1010a9['message']});}return _0x37e034||{'id':_0x389cad,'name':_0x389cad,'version':'1.0.0'};}async['invoke'](_0x4bcb0c){let _0x4ab4b9=_0x4bcb0c['ctx']['app']['id'],_0x4de347=_0x4bcb0c['ctx']['app']['name'];try{let _0x5c8f00={'id':_0x4ab4b9,'manifest':{'id':_0x4ab4b9,'name':_0x4de347}},_0x4f5225=await this['ensure'](_0x5c8f00);if(_0x4f5225['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x4ab4b9}),await this['restart'](_0x4ab4b9);let _0x4f0e30=await this['ensure'](_0x5c8f00);return this['lifecycle']['touch'](_0x4ab4b9),await this['messaging']['sendInvoke'](_0x4f0e30,_0x4bcb0c);}return this['lifecycle']['touch'](_0x4ab4b9),await this['messaging']['sendInvoke'](_0x4f5225,_0x4bcb0c);}catch(_0x1d3298){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x4ab4b9,'error':_0x1d3298['message'],'stack':_0x1d3298['stack']}),_0x1d3298;}}async['stop'](_0x560a0b){await this['lifecycle']['stop'](_0x560a0b),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x14c79a){return await this['lifecycle']['restart'](_0x14c79a,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x3c297e=>({'appId':_0x3c297e['appId'],'status':_0x3c297e['status'],'version':_0x3c297e['version'],'lastUsed':_0x3c297e['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x7a3681=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x5d93ef=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x7a3681(),_0x5d93ef();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x209399=>{_0x209399?(await this['stop'](_0x209399),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x209399})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x4bc80a){return new Q(_0x4bc80a);}var $=null;function be(_0x53ccf5){$=ee(_0x53ccf5);}function k(){if(!$)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return $;}async function xe(_0x463ee5){return await k()['ensure'](_0x463ee5);}async function Pe(_0x3f22a2){return await k()['invoke'](_0x3f22a2);}function Ie(_0x373d0c){k()['stop'](_0x373d0c)['catch'](_0xd65a7c=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x373d0c,'error':_0xd65a7c['message']});});}function Re(){k()['stopAll']()['catch'](_0x56781e=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x56781e['message']});});}function We(){return k()['getStats']();}function Se(){return $;}async function U(_0x10c3ab){await k()['stop'](_0x10c3ab);}async function $e(){await k()['stopAll']();}function Ce(_0x452d31){let _0x3f6608=_0x452d31&&typeof _0x452d31=='object'?_0x452d31:null;if(_0x3f6608&&'user'in _0x3f6608)return _0x3f6608['user'];}function H(_0x5cc5d9){let _0xf155cb=_0x5cc5d9&&typeof _0x5cc5d9=='object'?_0x5cc5d9:null;if(!_0xf155cb)return{};let _0x26cc56={};for(let [_0x153ab4,_0x20a6dc]of Object['entries'](_0xf155cb))_0x153ab4!=='user'&&(_0x26cc56[_0x153ab4]=_0x20a6dc);return _0x26cc56;}function O(_0x3f499a){return _0x3f499a?{'id':_0x3f499a['manifest']?.['id']||_0x3f499a['id']||'','name':_0x3f499a['manifest']?.['name']||'','version':_0x3f499a['manifest']?.['version']||'','description':_0x3f499a['manifest']?.['description']||'','icon':_0x3f499a['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x5983c1){return _0x5983c1?.['permissions']||_0x5983c1?.['manifest']?.['permissions']||{};}function F(_0x5b7b9e){return _0x5b7b9e?.['manifest']?.['metadata']||{};}function Ae(_0x5d8d63){return _0x5d8d63?{'appId':_0x5d8d63['id'],'appName':_0x5d8d63['manifest']?.['name']}:{};}function N(_0x484b53,_0xbd6f7a={}){let {appInfo:_0xc2da54=null,status:_0x296031=0x1f4,defaultMessage:_0x2efa0c='Internal\x20Server\x20Error'}=_0xbd6f7a,_0x7cf276={'error':_0x2efa0c,'message':_0x484b53?.['message']||_0x2efa0c};return _0xc2da54&&(_0x7cf276['appId']=_0xc2da54['id'],_0x7cf276['appName']=_0xc2da54['manifest']?.['name']),_0x484b53?.['message']?.['includes']('crashed')&&(_0x7cf276['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x296031,'body':_0x7cf276};}function qe(_0x583ea5){return _0x583ea5?.['message']?.['includes']('crashed')||![];}function J(_0x4b328f){if(_0x4b328f)try{return JSON['parse'](_0x4b328f);}catch{return _0x4b328f;}}function B(_0x528d19){try{let _0x320edb=new URL(_0x528d19),_0x15a35e={};for(let _0x546481 of _0x320edb['searchParams']['keys']()){let _0x40f6fe=_0x320edb['searchParams']['getAll'](_0x546481)['map'](_0x3c813f=>_0x3c813f);_0x40f6fe['length']<=0x1?_0x15a35e[_0x546481]=_0x40f6fe[0x0]??'':_0x15a35e[_0x546481]=_0x40f6fe;}return _0x15a35e;}catch{return{};}}function Le(_0x193d01){return(()=>{try{return new URL(_0x193d01)['pathname'];}catch{return _0x193d01;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x4ef4be,_0x5a9d17){let _0x4a965a=_0x4ef4be;if(_0x5a9d17&&_0x4a965a['startsWith']('/apps/'+_0x5a9d17))_0x4a965a=_0x4a965a['substring'](('/apps/'+_0x5a9d17)['length'])||'/';else{let _0x4e7087=_0x4a965a['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x4e7087&&(_0x4a965a=_0x4e7087[0x1]||'/');}return _0x4a965a['startsWith']('/api')&&(_0x4a965a=_0x4a965a['substring'](0x4)||'/'),_0x4a965a;}function Ue(_0xd4e0ad,_0x202726){let _0x4eab05=_0xd4e0ad;if(_0x202726&&_0x4eab05['startsWith']('/apps/'+_0x202726))_0x4eab05=_0x4eab05['substring'](('/apps/'+_0x202726)['length'])||'/';else{let _0x217e38=_0x4eab05['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x217e38&&(_0x4eab05=_0x217e38[0x1]||'/');}return(!_0x4eab05||_0x4eab05==='/')&&(_0x4eab05='/index.html'),_0x4eab05;}async function He(_0x1b77ae,_0xa86462){return await _0xa86462(_0x1b77ae);}function _(_0x147834){return _0x147834['split']('/')['filter'](_0x1fd4b7=>_0x1fd4b7['length']>0x0);}function te(_0xeff250){try{return decodeURIComponent(_0xeff250);}catch{return _0xeff250;}}function re(_0x10c046,_0x3f99b7){let _0x2b251e=_(_0x10c046),_0x504e7b=_(_0x3f99b7),_0x55dae1={},_0x28c1ee=0x0,_0x17e7bf=0x0;for(;_0x28c1ee<_0x2b251e['length']&&_0x17e7bf<_0x504e7b['length'];){let _0x10914a=_0x2b251e[_0x28c1ee],_0x49bdfc=_0x504e7b[_0x17e7bf];if(_0x10914a==='*')break;if(_0x10914a['startsWith'](':')){let _0x5428b3=_0x10914a['slice'](0x1);_0x5428b3&&(_0x55dae1[_0x5428b3]=te(_0x49bdfc)),_0x28c1ee++,_0x17e7bf++;continue;}if(_0x10914a!==_0x49bdfc)return{};_0x28c1ee++,_0x17e7bf++;}return _0x28c1ee===_0x2b251e['length']||_0x28c1ee===_0x2b251e['length']-0x1&&_0x2b251e[_0x28c1ee]==='*',_0x55dae1;}async function Oe(_0x2a5c9a,_0x17d7be,_0x16bdd6,_0x1ff8e8,_0x20473e=void 0x0,_0x4a6960){let _0x4521c9=await _0x17d7be['text'](),_0x536c57=J(_0x4521c9),_0x48318a=B(_0x17d7be['url']),_0x5ca9d4={...F(_0x2a5c9a),'user':_0x20473e},_0xfc473a=H(_0x5ca9d4),_0x29294d=_0x4a6960?re(_0x4a6960,_0x17d7be['path']):{};return{'app':O(_0x2a5c9a),'permissions':T(_0x2a5c9a),'user':_0x20473e,'metadata':_0xfc473a,'body':_0x536c57,'query':_0x48318a,'params':_0x29294d,'method':_0x16bdd6,'pathname':_0x1ff8e8,'requestUrl':_0x17d7be['url'],'headers':Object['fromEntries'](_0x17d7be['raw']['headers']['entries']())};}function Te(_0x22d7fd){return{'method':_0x22d7fd['method'],'pathname':_0x22d7fd['pathname'],'ctx':_0x22d7fd};}function Fe(_0x543690,_0x551939){let {status:_0x156000=0xc8,headers:_0x5a8599={},body:_0x581514,type:_0x575274}=_0x543690??{};return _0x575274==='raw'?new globalThis['Response'](String(_0x581514??''),{'status':_0x156000,'headers':_0x5a8599}):_0x551939(_0x581514,_0x156000);}function Ne(_0x430fc9,_0x14c7c2=null){return N(_0x430fc9,{'appInfo':_0x14c7c2});}var V=f;async function Ve(_0x43ae07){_0x43ae07?(await U(_0x43ae07),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x43ae07)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x364507,_0xdea49d){let _0x43aff2=Object['fromEntries'](Object['entries'](_0x364507['headers']||{})['map'](([_0x4cf90f,_0x4b4055])=>[_0x4cf90f['toLowerCase'](),_0x4b4055]));return{'id':_0x364507['app']['id']||_0xdea49d['appId']||'','name':_0x364507['app']['name']||'','version':_0x364507['app']['version']||'','description':_0x364507['app']['description']||'','metadata':{..._0x364507['metadata'],'permissions':_0x364507['permissions']},'body':_0x364507['body'],'query':_0x364507['query'],'params':_0x364507?.['params'],'method':_0x364507['method'],'pathname':_0x364507['pathname'],'requestUrl':_0x364507['requestUrl'],'user':_0x364507['user'],'headers':_0x43aff2};}var L=class{constructor(_0x6b9921){this['handle']=null,(this['config']=_0x6b9921,this['logger']=_0x6b9921['logger']||f,this['lifecycle']=W({'appsDir':_0x6b9921['appsDir'],'timeout':_0x6b9921['timeout'],'platformImports':_0x6b9921['platformImports'],'libDir':_0x6b9921['libDir']},{'onCreate':_0x4505af=>this['logger']['info']('Worker\x20created',{'appId':_0x4505af['appId']}),'onReady':_0x16872d=>{this['lifecycle']['updateStatus'](_0x16872d['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x16872d['appId']});},'onCrash':_0x5f592a=>this['logger']['error']('Worker\x20crashed',{'appId':_0x5f592a['appId']}),'onStop':_0x2f6662=>this['logger']['info']('Worker\x20stopped',{'appId':_0x2f6662['appId']})}),this['messaging']=S({'onReady':_0x2ee347=>this['lifecycle']['updateStatus'](_0x2ee347,'running'),'onLog':(_0x1ee13e,_0x37b4cc,_0x4e08d7,_0x3febf1)=>{(this['logger'][_0x37b4cc]||this['logger']['info'])['call'](this['logger'],_0x4e08d7,_0x3febf1);},'onResult':()=>{}},_0x6b9921['timeout']||0x1d4c0));}async['create'](_0x209f6d){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x277421=await this['lifecycle']['create'](this['config']['appId'],_0x209f6d,this['config']['scriptUrl']);this['messaging']['setup'](_0x277421),this['messaging']['sendInit'](_0x277421,this['config']['appsDir'],_0x209f6d,this['config']['serverPath']),this['handle']=_0x277421,await this['waitForReady']();}async['waitForReady'](_0x3c61c7=0x2710){let _0x324ed4=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x324ed4>_0x3c61c7)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x152cbf=>setTimeout(_0x152cbf,0x64));}}async['invoke'](_0x132990){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x132990);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x24977e){return new L(_0x24977e);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,S as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,xe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ce as extractUser,He as findApp,Ae as getAppLogMeta,Ze as getCacheSize,Se as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,Pe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,$e as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};