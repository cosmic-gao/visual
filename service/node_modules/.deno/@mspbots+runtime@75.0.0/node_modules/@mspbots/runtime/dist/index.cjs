'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x1e3fb3){return _0x1e3fb3&&_0x1e3fb3['__esModule']?_0x1e3fb3:{'default':_0x1e3fb3};}var Y__default=_interopDefault(Y);async function ie(_0x6040a1){try{return await promises['stat'](_0x6040a1),!0x0;}catch{return![];}}var f={'error':(_0x3f3721,_0x1b6486)=>console['error']('[ERROR]\x20'+_0x3f3721,_0x1b6486),'warn':(_0x4dfe39,_0x2d7760)=>console['warn']('[WARN]\x20'+_0x4dfe39,_0x2d7760),'info':(_0x5b85ca,_0x32cf6a)=>console['log']('[INFO]\x20'+_0x5b85ca,_0x32cf6a),'debug':(_0x39f903,_0x3ac648)=>console['log']('[DEBUG]\x20'+_0x39f903,_0x3ac648)};function z(){let _0x58eafa=globalThis['Deno'];if(!_0x58eafa)throw new Error('Deno is not available');return _0x58eafa;}var D=class{constructor(_0x44b2e5,_0x4564de='./lib',_0x115ecf={}){this['manifest']=_0x44b2e5,this['libDir']=_0x4564de,this['platformImports']=_0x115ecf;}['buildPerms'](){let _0x5f0d96=this['manifest']['permissions']||{},_0x1e80df={};return _0x5f0d96['net']!==void 0x0&&(_0x1e80df['net']=_0x5f0d96['net']===!![]?!![]:Array['isArray'](_0x5f0d96['net'])?_0x5f0d96['net']:[]),_0x5f0d96['read']!==void 0x0&&(_0x1e80df['read']=_0x5f0d96['read']===!![]?!![]:Array['isArray'](_0x5f0d96['read'])?_0x5f0d96['read']:[]),_0x5f0d96['write']!==void 0x0&&(_0x1e80df['write']=_0x5f0d96['write']===!![]?!![]:Array['isArray'](_0x5f0d96['write'])?_0x5f0d96['write']:[]),_0x5f0d96['env']!==void 0x0&&(_0x1e80df['env']=_0x5f0d96['env']===!![]?!![]:Array['isArray'](_0x5f0d96['env'])?_0x5f0d96['env']:[]),_0x5f0d96['run']!==void 0x0&&(_0x1e80df['run']=_0x5f0d96['run']===!![]?!![]:Array['isArray'](_0x5f0d96['run'])?_0x5f0d96['run']:[]),_0x5f0d96['ffi']!==void 0x0&&(_0x1e80df['ffi']=_0x5f0d96['ffi']===!![]?!![]:Array['isArray'](_0x5f0d96['ffi'])?_0x5f0d96['ffi']:[]),_0x5f0d96['sys']!==void 0x0&&(_0x1e80df['sys']=_0x5f0d96['sys']===!![]?!![]:Array['isArray'](_0x5f0d96['sys'])?_0x5f0d96['sys']:[]),_0x5f0d96['hrtime']!==void 0x0&&(_0x1e80df['hrtime']=_0x5f0d96['hrtime']),_0x1e80df;}['normalize'](_0x20b0f1){return _0x20b0f1===!![]?[]:Array['isArray'](_0x20b0f1)?_0x20b0f1:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0xcf2553){return path.join(this['libDir'],_0xcf2553+'@*');}['getReadPaths'](){let _0x1ebb34=this['getImports']();_0x1ebb34['includes']('*')&&(_0x1ebb34=Object['keys'](this['platformImports']));let _0x581fed=[];console['log']('[Permissions] Building package path patterns for imports:',_0x1ebb34);for(let _0xb283c of _0x1ebb34){let _0x6861ef=this['getLibPattern'](_0xb283c);_0x581fed['push'](_0x6861ef),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0xb283c+'\x20->\x20'+_0x6861ef);}return console['log']('[Permissions] Final package path patterns:',_0x581fed),_0x581fed;}['buildImportMap'](_0x185498){let _0x42ca8e=this['getImports'](),_0x24d3fe=_0x42ca8e['includes']('*')?Object['keys'](_0x185498):_0x42ca8e;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x24d3fe);let _0x31f343={};for(let _0x1d288c of _0x24d3fe)if(_0x185498[_0x1d288c])_0x31f343[_0x1d288c]=_0x185498[_0x1d288c],console['log']('[ImportMap]\x20'+_0x1d288c+'\x20->\x20'+_0x185498[_0x1d288c]+'\x20(from\x20platform)');else try{let _0x1479db=z(),_0x2b6c17=path.join(_0x1479db['cwd'](),this['libDir']),_0x3e1aeb=!0x1;try{for(let _0x257777 of _0x1479db['readDirSync'](_0x2b6c17))if(_0x257777['isDirectory']&&(_0x257777['name']===_0x1d288c||_0x257777['name']['startsWith'](_0x1d288c+'@'))){let _0x33d2a0=path.join(_0x1479db['cwd'](),this['libDir'],_0x257777['name'],'index.js')['replace'](/\\/g,'/'),_0x18d5b2=new URL('file:///'+_0x33d2a0)['href'];_0x31f343[_0x1d288c]=_0x18d5b2,console['log']('[ImportMap]\x20'+_0x1d288c+'\x20->\x20'+_0x18d5b2+'\x20(from\x20lib)'),_0x3e1aeb=!0x0;break;}}catch{}_0x3e1aeb||console['warn']('[ImportMap]\x20Package\x20'+_0x1d288c+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x30a574){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x1d288c+':',_0x30a574);}return _0x31f343;}['validateServerImports'](_0x2e8377){let _0x525bd5=this['manifest']['name']||this['manifest']['id'],_0x529315=this['manifest']['metadata']?.['serverPath'],_0x2afc99=_0xd946be=>_0xd946be['replace'](/\\/g,'/'),_0x246e8e=z(),_0x17fe19=_0x5102cf=>{try{return _0x246e8e['statSync'](_0x5102cf),!0x0;}catch{return![];}},_0x2ce355=_0x529315?_0x2afc99(_0x529315):void 0x0;if(!_0x2ce355){let _0x23c0dd=[_0x2e8377+'/service/server.js',_0x2e8377+'/service/server.ts',_0x2e8377+'/'+_0x525bd5+'/server.js',_0x2e8377+'/'+_0x525bd5+'/server.ts',_0x2e8377+'/server.js',_0x2e8377+'/server.ts']['map'](_0x2afc99);for(let _0x1e6678 of _0x23c0dd)if(_0x17fe19(_0x1e6678)){_0x2ce355=_0x1e6678;break;}}if(!_0x2ce355)return{'valid':![],'violations':['Failed to locate server module']};let _0x2e2495='';try{_0x2e2495=_0x246e8e['readTextFileSync'](_0x2ce355);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x2ce355};}let _0x4e5507=this['getImports']();if(_0x4e5507['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x2ce355};let _0x11cb10=_0x4e5507,_0x39a438=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x4b9943=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x77b68d=/\bimport\s*['"]([^'"]+)['"]/g,_0x280cb2=[],_0x5a29bf=new Set(),_0x57802a=_0x16bac3=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x16bac3),_0x1b0e0e=_0x4db76e=>{let _0xd03b9a=_0x4db76e;if(_0xd03b9a['startsWith']('./')||_0xd03b9a['startsWith']('../')||_0xd03b9a['startsWith']('/')||_0xd03b9a['startsWith']('file://')||!_0x57802a(_0x4db76e)||_0x5a29bf['has'](_0x4db76e))return;_0x5a29bf['add'](_0x4db76e),_0xd03b9a['startsWith']('npm:')&&(_0xd03b9a=_0xd03b9a['substring'](0x4)),_0xd03b9a['includes']('@')&&!_0xd03b9a['startsWith']('@')&&(_0xd03b9a=_0xd03b9a['split']('@')[0x0]);let _0x290b94=_0xd03b9a['split']('/')[0x0];_0x11cb10['includes'](_0x290b94)||_0x11cb10['includes'](_0x4db76e)||_0x280cb2['push'](_0x4db76e);},_0x117fe7;for(;(_0x117fe7=_0x39a438['exec'](_0x2e2495))!==null;)_0x1b0e0e(_0x117fe7[0x1]);for(;(_0x117fe7=_0x4b9943['exec'](_0x2e2495))!==null;)_0x1b0e0e(_0x117fe7[0x1]);for(;(_0x117fe7=_0x77b68d['exec'](_0x2e2495))!==null;)_0x1b0e0e(_0x117fe7[0x1]);return{'valid':_0x280cb2['length']===0x0,'violations':_0x280cb2,'serverPath':_0x2ce355};}['validate'](_0x66c795={}){let _0xd038d4=[],_0x28fea3=this['manifest']['permissions']||{};for(let [_0x2037f6,_0x4c417c]of Object['entries'](_0x28fea3))if(_0x2037f6==='hrtime')typeof _0x4c417c!='boolean'&&_0xd038d4['push']('Permission\x20\x27'+_0x2037f6+'\x27\x20must\x20be\x20boolean');else{if(_0x2037f6==='db'){if(typeof _0x4c417c!='object'||_0x4c417c===null||Array['isArray'](_0x4c417c))_0xd038d4['push']('Permission\x20\x27'+_0x2037f6+'\x27\x20must\x20be\x20an\x20object');else{let _0x328127=_0x4c417c,_0x16924b=['user','password']['filter'](_0x359a03=>!(_0x359a03 in _0x328127));_0x16924b['length']>0x0&&_0xd038d4['push']('Permission\x20\x27'+_0x2037f6+'\x27\x20missing\x20required\x20fields:\x20'+_0x16924b['join'](',\x20'));}}else{if(_0x2037f6==='imports')continue;}}let _0x18f1ad=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x18f1ad))_0xd038d4['push']('permissions.imports must be an array');else{for(let _0x26101c of _0x18f1ad)typeof _0x26101c!='string'&&_0xd038d4['push']('import\x20\x27'+_0x26101c+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0xd038d4['length']===0x0,'errors':_0xd038d4};}};function q(_0x4f9cb5,_0x433a5e,_0x226018){return new D(_0x4f9cb5,_0x433a5e,_0x226018||{});}var R=null;function I(){let _0x11b511=globalThis['Deno'];if(!_0x11b511)throw new Error('Deno is not available');return _0x11b511;}async function K(){if(R)return{...R};try{let _0x1cea2b=I(),_0x3fecc5=path.join(_0x1cea2b['cwd'](),'deno.json'),_0xea7ae=await _0x1cea2b['readTextFile'](_0x3fecc5);return R=JSON['parse'](_0xea7ae)['imports']||{},{...R};}catch(_0x6127cd){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x6127cd),{};}}var E=class{constructor(_0x6081ad,_0x5e7d62={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x6081ad['appsDir'],this['platformImportsOverride']=_0x6081ad['platformImports'],this['libDir']=_0x6081ad['libDir'],this['events']=_0x5e7d62);}async['create'](_0x2f554e,_0x5c2289,_0x7b63cb){try{return await this['createWorker'](_0x2f554e,_0x5c2289,_0x7b63cb);}catch(_0x5116ab){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x2f554e+':',_0x5116ab),_0x5116ab;}}async['createWorker'](_0x5270a6,_0x6bbd11,_0x5ebf30){let _0x46abc5=this['platformImportsOverride']||await K(),_0x3923bf=q(_0x6bbd11,this['libDir'],_0x46abc5)['validateServerImports'](this['appsDir']);if(!_0x3923bf['valid']){let _0x2cbd1c=_0x3923bf['violations']['filter'](_0x11d242=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x11d242)),_0x4e33b5=_0x3923bf['serverPath']?_0x3923bf['serverPath']:(_0x6bbd11['name']||_0x6bbd11['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x4e33b5+':\x20'+_0x2cbd1c['join'](',\x20'));}let _0x42b970=q(_0x6bbd11,this['libDir'],_0x46abc5),_0x16a7a3=_0x42b970['validate'](_0x46abc5);if(!_0x16a7a3['valid'])throw new Error('Invalid\x20config:\x20'+_0x16a7a3['errors']['join'](',\x20'));let _0x3bb80b=_0x42b970['buildImportMap'](_0x46abc5);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x5270a6+':',_0x3bb80b);let _0x1ad57b=_0x42b970['buildPerms'](),_0xc3d974=_0x42b970['getReadPaths']();if(_0x1ad57b['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x1ad57b['read']);else{let _0x39506d=_0x6bbd11['name']||_0x5270a6,_0x4fc4b2=this['appsDir']+'/'+_0x39506d,_0x31f68f=[_0x4fc4b2],_0x4f4b26=_0x6bbd11['metadata']?.['serverPath'];if(_0x4f4b26&&typeof _0x4f4b26=='string')try{let _0x14f0ca=path.dirname(_0x4f4b26)['replace'](/\\/g,'/');_0x31f68f['push'](_0x14f0ca);}catch{}_0x1ad57b['read']=_0x31f68f,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x4fc4b2);}if(_0xc3d974['length']>0x0){if(_0x1ad57b['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x5b322e=Array['isArray'](_0x1ad57b['read'])?_0x1ad57b['read']:[];_0x1ad57b['read']=[..._0x5b322e,..._0xc3d974],console['log']('[Worker] Added package read permissions:',_0xc3d974);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x1ad57b['net']||(_0x1ad57b['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x5270a6+':',_0x1ad57b['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x1ad57b['read']===!![]?'unrestricted':Array['isArray'](_0x1ad57b['read'])?_0x1ad57b['read']['length']:0x0));let _0x32bed5=await this['createImportMap'](_0x5270a6,_0x3bb80b),_0x358d4d=await this['createLock'](_0x5270a6,_0x3bb80b),_0x119101={'type':'module','deno':{'permissions':{}}};_0x119101['deno']['namespace']=![],_0x119101['deno']['permissions']=_0x1ad57b,_0x119101['deno']['importMap']=_0x32bed5,_0x119101['deno']['lock']=_0x358d4d,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x5270a6+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x32bed5),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x358d4d),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x3bb80b)['length']+'\x20('+(Object['keys'](_0x3bb80b)['join'](',\x20')||'none')+')');let _0x4798ac={'worker':new Worker(_0x5ebf30,_0x119101),'appId':_0x5270a6,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x6bbd11,'importMapPath':_0x32bed5,'lockfilePath':_0x358d4d};return this['workers']['set'](_0x5270a6,_0x4798ac),this['events']['onCreate']?.(_0x4798ac),_0x4798ac;}async['createLock'](_0x8c7afa,_0xc9cd71){let _0x44a4b2=I(),_0x1a3d43=path.join(_0x44a4b2['cwd'](),'storage','temp','lockfiles');await _0x44a4b2['mkdir'](_0x1a3d43,{'recursive':!![]});let _0x355bb5=_0x8c7afa+'-'+Date['now']()+'.lock',_0x1b8d76=path.join(_0x1a3d43,_0x355bb5),_0x3c4757={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x2d84e6,_0x420343]of Object['entries'](_0xc9cd71))if(_0x420343['startsWith']('npm:'))_0x420343['replace']('npm:',''),_0x3c4757['packages']['specifiers'][_0x2d84e6]=_0x420343;else _0x420343['startsWith']('file://')&&(_0x3c4757['packages']['specifiers'][_0x2d84e6]=_0x420343);let _0x4732a7=JSON['stringify'](_0x3c4757,null,0x2);return await _0x44a4b2['writeTextFile'](_0x1b8d76,_0x4732a7),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x1b8d76),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0xc9cd71)['length']+'):',Object['keys'](_0xc9cd71)),_0x1b8d76;}async['createImportMap'](_0x503d14,_0x40c84c){let _0x2060ff=I(),_0x5a055e=path.join(_0x2060ff['cwd'](),'storage','temp','importmaps');await _0x2060ff['mkdir'](_0x5a055e,{'recursive':!![]});let _0x23d945=_0x503d14+'-'+Date['now']()+'.json',_0x515950=path.join(_0x5a055e,_0x23d945),_0x2bcb09=JSON['stringify']({'imports':_0x40c84c,'scopes':{}},null,0x2);return await _0x2060ff['writeTextFile'](_0x515950,_0x2bcb09),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x515950),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x40c84c)['length']+'):',Object['keys'](_0x40c84c)['join'](',\x20')||'none'),_0x515950;}['get'](_0x5c00fa){return this['workers']['get'](_0x5c00fa);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x4f38c4,_0x4c282a){let _0x2c0495=this['workers']['get'](_0x4f38c4);if(!_0x2c0495)return;let _0x3f4c58=_0x2c0495['status'];_0x2c0495['status']=_0x4c282a,_0x4c282a==='running'&&_0x3f4c58==='starting'?this['events']['onReady']?.(_0x2c0495):_0x4c282a==='crashed'&&this['events']['onCrash']?.(_0x2c0495);}['touch'](_0x527bb3){let _0x47992d=this['workers']['get'](_0x527bb3);_0x47992d&&(_0x47992d['lastUsed']=Date['now']());}async['stop'](_0x1a600d){let _0x597e66=this['workers']['get'](_0x1a600d);if(_0x597e66)try{_0x597e66['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x597e66['worker']['terminate'](),_0x597e66['status']='stopped',this['events']['onStop']?.(_0x597e66),_0x597e66['importMapPath']&&await this['cleanupImportMap'](_0x597e66['importMapPath']),_0x597e66['lockfilePath']&&await this['cleanupLock'](_0x597e66['lockfilePath']);}catch(_0x3bd23c){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x1a600d+':',_0x3bd23c);}finally{this['workers']['delete'](_0x1a600d);}}async['cleanupImportMap'](_0x57c82b){try{await I()['remove'](_0x57c82b),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x57c82b);}catch(_0x346f8e){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x57c82b,_0x346f8e);}}async['cleanupLock'](_0x50c4fb){try{await I()['remove'](_0x50c4fb),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x50c4fb);}catch(_0x2166f8){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x50c4fb,_0x2166f8);}}async['stopAll'](){let _0xcff1ed=Array['from'](this['workers']['keys']());await Promise['all'](_0xcff1ed['map'](_0x48dffc=>this['stop'](_0x48dffc)));}async['restart'](_0x5df927,_0x863124){let _0x144ca9=this['workers']['get'](_0x5df927);if(!_0x144ca9)throw new Error('Worker\x20'+_0x5df927+'\x20not\x20found');let _0xa50bd9=_0x144ca9['manifest'];return await this['stop'](_0x5df927),await this['create'](_0x5df927,_0xa50bd9,_0x863124);}['checkHealth'](_0x48f27a){let _0x479ed3=this['workers']['get'](_0x48f27a);if(!_0x479ed3)return{'healthy':![],'reason':'Not\x20found'};if(_0x479ed3['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x479ed3['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x33322e=Date['now']()-_0x479ed3['lastUsed'],_0x3f0263=0x708*0x3e8;return _0x33322e>_0x3f0263?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x33322e/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x36d46c=0x708*0x3e8,_0xd7c510){let _0x394bf7=Date['now'](),_0x15a287=[];for(let [_0xe9c082,_0x2843d6]of this['workers']['entries']()){let _0x15614e=_0x394bf7-_0x2843d6['lastUsed'];_0x15614e>_0x36d46c&&_0x15a287['push']({'appId':_0xe9c082,'idle':_0x15614e});}_0x15a287['sort']((_0x38f342,_0x291f06)=>_0x291f06['idle']-_0x38f342['idle']);let _0x25e018=_0xd7c510?_0x15a287['slice'](0x0,_0xd7c510)['map'](_0x50a10d=>_0x50a10d['appId']):_0x15a287['map'](_0x117c0b=>_0x117c0b['appId']);for(let _0x4c9f0a of _0x25e018)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x4c9f0a),await this['stop'](_0x4c9f0a);}['stats'](){let _0x1ebafc={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x37df6a=Date['now']();for(let _0x509fed of this['workers']['values']())_0x1ebafc['byStatus'][_0x509fed['status']]++,_0x1ebafc['workers']['push']({'appId':_0x509fed['appId'],'status':_0x509fed['status'],'version':_0x509fed['version'],'lastUsed':_0x509fed['lastUsed'],'idle':_0x37df6a-_0x509fed['lastUsed']});return _0x1ebafc;}['startCleanup'](_0x538507=0x12c*0x3e8,_0x3ab4a3){let _0x4dadbf=setInterval(()=>{this['cleanup'](_0x3ab4a3)['catch'](_0x4bb5bc=>{console['error']('Cleanup\x20failed:',_0x4bb5bc);});},_0x538507);return()=>clearInterval(_0x4dadbf);}['delay'](_0xa69b39){return new Promise(_0xcf0396=>setTimeout(_0xcf0396,_0xa69b39));}};function W(_0x27e7f5,_0x5a4c89){return new E(_0x27e7f5,_0x5a4c89);}var v=f,j=class{constructor(_0x3e6402,_0x200dbc=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x3e6402,this['timeout']=_0x200dbc);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x4956de){_0x4956de['worker']['onmessage']=_0x28c202=>{let _0x333d82=_0x28c202['data'],{appId:_0x371928}=_0x4956de;switch(_0x333d82['type']){case'ready':this['events']['onReady'](_0x371928),v['info']('Worker\x20ready',{'appId':_0x371928,'version':_0x4956de['version']});break;case'log':{let {level:_0x202bdc='info',message:_0x2b92bf,meta:_0x165805}=_0x333d82,_0x5f4af1={..._0x165805||{},'appId':_0x371928,'version':_0x4956de['version']};this['events']['onLog'](_0x371928,_0x202bdc,_0x2b92bf,_0x5f4af1);break;}case'result':{let {reqId:_0x1bf0c9,ok:_0x56ad7a,response:_0x39daee,error:_0x391f56}=_0x333d82,_0x370d6a=this['pending']['get'](_0x1bf0c9);if(!_0x370d6a){v['warn']('Unknown\x20request',{'appId':_0x371928,'reqId':_0x1bf0c9});return;}if(this['pending']['delete'](_0x1bf0c9),_0x56ad7a&&_0x39daee)_0x370d6a['resolve'](_0x39daee);else{let _0x1d7f10=new Error(_0x391f56?.['message']||'Worker\x20error');_0x1d7f10['stack']=_0x391f56?.['stack'],_0x370d6a['reject'](_0x1d7f10);}this['events']['onResult'](_0x371928,_0x1bf0c9,_0x39daee||_0x391f56);break;}default:v['debug']('Unknown\x20message',{'appId':_0x371928,'type':_0x333d82['type']});}},_0x4956de['worker']['onerror']=_0x3d0052=>{let {appId:_0x3dcc3e}=_0x4956de;v['error']('Worker\x20error',{'appId':_0x3dcc3e,'message':_0x3d0052['message'],'lineno':_0x3d0052['lineno'],'filename':_0x3d0052['filename']}),_0x4956de['status']='crashed',this['rejectPending'](_0x3dcc3e,new Error('Worker\x20'+_0x3dcc3e+'\x20crashed:\x20'+_0x3d0052['message'])),_0x3d0052['preventDefault']();},_0x4956de['worker']['onmessageerror']=_0x452349=>{let {appId:_0x437308}=_0x4956de;v['error']('Message\x20error',{'appId':_0x437308,'data':_0x452349['data']}),_0x4956de['status']='crashed',_0x452349['preventDefault']();};}['sendInit'](_0x5734ad,_0x4bc565,_0x581d70,_0x24f8a4){_0x5734ad['worker']['postMessage']({'type':'init','appId':_0x5734ad['appId'],'manifest':_0x581d70,'appsDir':_0x4bc565,'serverPath':_0x24f8a4});}async['sendInvoke'](_0x2bc350,_0x56282a){let _0x46139c=this['nextId'](),_0x346d3c=_0x2bc350['appId'],_0x11a6f4=new Promise((_0x1fa4d2,_0x29be80)=>{let _0x492bdf=setTimeout(()=>{this['pending']['delete'](_0x46139c),_0x29be80(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x46139c,{'resolve':_0x230353=>{clearTimeout(_0x492bdf),_0x1fa4d2(_0x230353);},'reject':_0x1dda3f=>{clearTimeout(_0x492bdf),_0x29be80(_0x1dda3f);},'timestamp':Date['now'](),'appId':_0x346d3c});});return _0x2bc350['worker']['postMessage']({'type':'invoke','appId':_0x2bc350['appId'],'reqId':_0x46139c,'payload':_0x56282a}),await _0x11a6f4;}['rejectPending'](_0x4e30f6,_0x24bffb){let _0x1355af=0x0;for(let [_0x11d1e7,_0x2cbc1b]of this['pending']['entries']())_0x2cbc1b['appId']===_0x4e30f6&&(this['pending']['delete'](_0x11d1e7),_0x2cbc1b['reject'](_0x24bffb),_0x1355af++);_0x1355af>0x0&&v['warn']('Rejected\x20'+_0x1355af+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x4e30f6});}['cleanupTimeout'](){let _0x114512=Date['now']();for(let [_0x1938f9,_0x5f4c2d]of this['pending']['entries']())_0x114512-_0x5f4c2d['timestamp']>this['timeout']&&(this['pending']['delete'](_0x1938f9),_0x5f4c2d['reject'](new Error('Request\x20'+_0x1938f9+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x286740){let _0x2929cf=0x0;for(let _0x49b63f of this['pending']['values']())_0x49b63f['appId']===_0x286740&&_0x2929cf++;return _0x2929cf;}['startCleanup'](_0x185049=0x2710){let _0x64f0d=setInterval(()=>{this['cleanupTimeout']();},_0x185049);return()=>clearInterval(_0x64f0d);}};function S(_0x6b2dda,_0xed8b8c){return new j(_0x6b2dda,_0xed8b8c);}var Q=class{constructor(_0x21c9fe={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x21c9fe['logger']||f,this['config']={'appsDir':_0x21c9fe['appsDir']||this['getAppsDir'](),'scriptUrl':_0x21c9fe['scriptUrl']||this['getScriptUrl'](),'timeout':_0x21c9fe['timeout']||0x78*0x3e8,'autoCleanup':_0x21c9fe['autoCleanup']??!![],'cleanupInterval':_0x21c9fe['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x21c9fe['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x21c9fe['maxWorkers'],'reuseWorkers':_0x21c9fe['reuseWorkers']??!![],'workerReuseStrategy':_0x21c9fe['workerReuseStrategy']||'lru','enableQueue':_0x21c9fe['enableQueue']??!![],'maxQueueSize':_0x21c9fe['maxQueueSize']||0x64,'queueTimeout':_0x21c9fe['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x4fc801=>this['logger']['info']('Worker\x20created',{'appId':_0x4fc801['appId'],'v':_0x4fc801['version']}),'onReady':_0x4e3506=>this['lifecycle']['updateStatus'](_0x4e3506['appId'],'running'),'onCrash':_0xe6cecd=>this['logger']['error']('Worker\x20crashed',{'appId':_0xe6cecd['appId'],'v':_0xe6cecd['version']}),'onStop':_0x3a2c12=>this['logger']['info']('Worker\x20stopped',{'appId':_0x3a2c12['appId'],'v':_0x3a2c12['version']})}),this['messaging']=S({'onReady':_0x369a8b=>this['lifecycle']['updateStatus'](_0x369a8b,'running'),'onLog':(_0x3ba0e7,_0x52742a,_0x264e62,_0x2eced4)=>{let _0x96fde3={..._0x2eced4||{},'appId':_0x3ba0e7};switch(_0x52742a){case'error':this['logger']['error'](_0x264e62,_0x96fde3);break;case'warn':this['logger']['warn'](_0x264e62,_0x96fde3);break;case'debug':this['logger']['debug'](_0x264e62,_0x96fde3);break;default:this['logger']['info'](_0x264e62,_0x96fde3);break;}},'onResult':(_0x4028ed,_0x1b2109,_0x130490)=>{this['logger']['debug']('Result\x20received',{'appId':_0x4028ed,'reqId':_0x1b2109});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x3376e6=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x1d7b0a=_0x3376e6['endsWith']('.js')||_0x3376e6['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x1d7b0a,_0x3376e6)['href'];}async['ensure'](_0x51f1d5){let {id:_0x31f7fd}=_0x51f1d5,_0x518ca0=this['lifecycle']['get'](_0x31f7fd);if(_0x518ca0){let _0x1c45de=this['lifecycle']['checkHealth'](_0x31f7fd);if(_0x1c45de['healthy'])return this['lifecycle']['touch'](_0x31f7fd),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x31f7fd}),_0x518ca0;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x31f7fd,'reason':_0x1c45de['reason']}),await this['lifecycle']['stop'](_0x31f7fd);}for(;;){let _0x4ec334=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x4ec334>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x4ec334,'max':this['config']['maxWorkers'],'appId':_0x31f7fd}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x51f1d5);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x370416=await this['loadManifest'](_0x31f7fd,_0x51f1d5['manifest']),_0xa13f2c=await this['lifecycle']['create'](_0x31f7fd,_0x370416,this['config']['scriptUrl']),_0x2290a2=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x2290a2>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x2290a2,'max':this['config']['maxWorkers'],'appId':_0x31f7fd}),await this['lifecycle']['stop'](_0x31f7fd),this['config']['enableQueue'])return await this['waitSlot'](_0x51f1d5);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x2290a2+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0xa13f2c);let _0x3d9859=_0x370416['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0xa13f2c,this['config']['appsDir'],_0x370416,_0x3d9859),this['logger']['info']('Worker\x20created',{'appId':_0x31f7fd,'v':_0xa13f2c['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0xa13f2c;}async['evictIdle'](){let _0x5ebcd8=this['lifecycle']['getAll']();if(_0x5ebcd8['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x5bf4e4=[..._0x5ebcd8];this['config']['workerReuseStrategy']==='lru'?_0x5bf4e4['sort']((_0x446edd,_0x2fe432)=>_0x446edd['lastUsed']-_0x2fe432['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x5bf4e4['sort']((_0x456dfb,_0x6ad2b4)=>_0x456dfb['version']-_0x6ad2b4['version']);let _0x458a0f=null;for(let _0x558bff of _0x5bf4e4)if(this['messaging']['getAppCount'](_0x558bff['appId'])===0x0){_0x458a0f=_0x558bff;break;}if(!_0x458a0f&&_0x5bf4e4['length']>0x0&&(_0x458a0f=_0x5bf4e4['reduce']((_0x117d9c,_0x60089a)=>{let _0x9349cb=this['messaging']['getAppCount'](_0x117d9c['appId']);return this['messaging']['getAppCount'](_0x60089a['appId'])<_0x9349cb?_0x60089a:_0x117d9c;})),_0x458a0f){let _0x341fc0=this['messaging']['getAppCount'](_0x458a0f['appId']);return _0x341fc0>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x458a0f['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x458a0f['lastUsed'],'pendingRequests':_0x341fc0}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x458a0f['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x458a0f['lastUsed']}),await this['lifecycle']['stop'](_0x458a0f['appId']),!![];}return![];}['waitSlot'](_0x4aec07){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x125612,_0x2d27b2)=>{let _0x5659ab={'info':_0x4aec07,'resolve':_0x125612,'reject':_0x2d27b2,'timestamp':Date['now']()};this['requestQueue']['push'](_0x5659ab),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x4aec07['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x2d1357=setTimeout(()=>{let _0xeb28de=this['requestQueue']['indexOf'](_0x5659ab);_0xeb28de!==-0x1&&(this['requestQueue']['splice'](_0xeb28de,0x1),_0x2d27b2(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x5659ab['resolve']=_0x42b366=>{clearTimeout(_0x2d1357),_0x125612(_0x42b366);},_0x5659ab['reject']=_0x4d0e70=>{clearTimeout(_0x2d1357),_0x2d27b2(_0x4d0e70);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x1c3692=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x1c3692>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x233783=this['requestQueue']['shift']();if(!_0x233783)break;try{let _0x189e5e=await this['ensure'](_0x233783['info']);_0x233783['resolve'](_0x189e5e);}catch(_0x5f03ed){_0x233783['reject'](_0x5f03ed);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x2ac341,_0x5e0d61){let _0x2e803e=this['config']['appsDir']['replace'](/\\/g,'/'),_0x4fb307=async _0x54b9bd=>{try{let _0x48a7f5=globalThis['Deno'];if(!_0x48a7f5)return null;let _0x11ce7c=await _0x48a7f5['readTextFile'](_0x54b9bd);return JSON['parse'](_0x11ce7c);}catch{return null;}};if(_0x5e0d61?.['name']){let _0x4e290e=await _0x4fb307(_0x2e803e+'/'+_0x5e0d61['name']+'/manifest.json');if(_0x4e290e)return _0x4e290e;}let _0x55d264=await _0x4fb307(_0x2e803e+'/'+_0x2ac341+'/manifest.json');if(_0x55d264)return _0x55d264;try{let _0x331f59=globalThis['Deno'];if(_0x331f59)for await(let _0xa297d0 of _0x331f59['readDir'](_0x2e803e)){if(!_0xa297d0['isDirectory'])continue;let _0x4c0008=_0x2e803e+'/'+_0xa297d0['name']+'/manifest.json',_0x476352=await _0x4fb307(_0x4c0008);if(_0x476352&&(_0x476352['id']===_0x2ac341||_0x5e0d61?.['name']&&_0x476352['name']===_0x5e0d61['name']))return _0x476352;}}catch(_0x32310e){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x2ac341,'error':_0x32310e['message']});}return _0x5e0d61||{'id':_0x2ac341,'name':_0x2ac341,'version':'1.0.0'};}async['invoke'](_0x2c6ef1){let _0x59405a=_0x2c6ef1['ctx']['app']['id'],_0x3ee74c=_0x2c6ef1['ctx']['app']['name'];try{let _0x1b4916={'id':_0x59405a,'manifest':{'id':_0x59405a,'name':_0x3ee74c}},_0x1e60b9=await this['ensure'](_0x1b4916);if(_0x1e60b9['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x59405a}),await this['restart'](_0x59405a);let _0xff61dc=await this['ensure'](_0x1b4916);return this['lifecycle']['touch'](_0x59405a),await this['messaging']['sendInvoke'](_0xff61dc,_0x2c6ef1);}return this['lifecycle']['touch'](_0x59405a),await this['messaging']['sendInvoke'](_0x1e60b9,_0x2c6ef1);}catch(_0x360dfb){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x59405a,'error':_0x360dfb['message'],'stack':_0x360dfb['stack']}),_0x360dfb;}}async['stop'](_0x233ae9){await this['lifecycle']['stop'](_0x233ae9),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x5d555c){return await this['lifecycle']['restart'](_0x5d555c,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x338080=>({'appId':_0x338080['appId'],'status':_0x338080['status'],'version':_0x338080['version'],'lastUsed':_0x338080['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x1ada30=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x39adb7=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x1ada30(),_0x39adb7();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x9ee91=>{_0x9ee91?(await this['stop'](_0x9ee91),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x9ee91})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x1b4d7e){return new Q(_0x1b4d7e);}var $=null;function be(_0x236d49){$=ee(_0x236d49);}function k(){if(!$)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return $;}async function xe(_0x3b0f14){return await k()['ensure'](_0x3b0f14);}async function Pe(_0x22e7ed){return await k()['invoke'](_0x22e7ed);}function Ie(_0x17b02d){k()['stop'](_0x17b02d)['catch'](_0x7da759=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x17b02d,'error':_0x7da759['message']});});}function Re(){k()['stopAll']()['catch'](_0x21b55d=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x21b55d['message']});});}function We(){return k()['getStats']();}function Se(){return $;}async function U(_0x541932){await k()['stop'](_0x541932);}async function $e(){await k()['stopAll']();}function Ce(_0x4d57d6){let _0x3f08d3=_0x4d57d6&&typeof _0x4d57d6=='object'?_0x4d57d6:null;if(_0x3f08d3&&'user'in _0x3f08d3)return _0x3f08d3['user'];}function H(_0x5e2125){let _0x140f55=_0x5e2125&&typeof _0x5e2125=='object'?_0x5e2125:null;if(!_0x140f55)return{};let _0x52011b={};for(let [_0x541dd3,_0x198ae2]of Object['entries'](_0x140f55))_0x541dd3!=='user'&&(_0x52011b[_0x541dd3]=_0x198ae2);return _0x52011b;}function O(_0x24620c){return _0x24620c?{'id':_0x24620c['manifest']?.['id']||_0x24620c['id']||'','name':_0x24620c['manifest']?.['name']||'','version':_0x24620c['manifest']?.['version']||'','description':_0x24620c['manifest']?.['description']||'','icon':_0x24620c['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x40e663){return _0x40e663?.['permissions']||_0x40e663?.['manifest']?.['permissions']||{};}function F(_0x10424d){return _0x10424d?.['manifest']?.['metadata']||{};}function Ae(_0x2ee13d){return _0x2ee13d?{'appId':_0x2ee13d['id'],'appName':_0x2ee13d['manifest']?.['name']}:{};}function N(_0x5384fb,_0x283a1b={}){let {appInfo:_0x5e8f90=null,status:_0x43d73f=0x1f4,defaultMessage:_0xb84be0='Internal\x20Server\x20Error'}=_0x283a1b,_0x2d174d={'error':_0xb84be0,'message':_0x5384fb?.['message']||_0xb84be0};return _0x5e8f90&&(_0x2d174d['appId']=_0x5e8f90['id'],_0x2d174d['appName']=_0x5e8f90['manifest']?.['name']),_0x5384fb?.['message']?.['includes']('crashed')&&(_0x2d174d['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x43d73f,'body':_0x2d174d};}function qe(_0x55e26b){return _0x55e26b?.['message']?.['includes']('crashed')||![];}function J(_0x14dad6){if(_0x14dad6)try{return JSON['parse'](_0x14dad6);}catch{return _0x14dad6;}}function B(_0x3d5caf){try{let _0x86dee0=new URL(_0x3d5caf),_0x13c0f6={};for(let _0x33e1a3 of _0x86dee0['searchParams']['keys']()){let _0x497945=_0x86dee0['searchParams']['getAll'](_0x33e1a3)['map'](_0x459447=>_0x459447);_0x497945['length']<=0x1?_0x13c0f6[_0x33e1a3]=_0x497945[0x0]??'':_0x13c0f6[_0x33e1a3]=_0x497945;}return _0x13c0f6;}catch{return{};}}function Le(_0x8ef10e){return(()=>{try{return new URL(_0x8ef10e)['pathname'];}catch{return _0x8ef10e;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x310249,_0x56b147){let _0x32e321=_0x310249;if(_0x56b147&&_0x32e321['startsWith']('/apps/'+_0x56b147))_0x32e321=_0x32e321['substring'](('/apps/'+_0x56b147)['length'])||'/';else{let _0x4c77fc=_0x32e321['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x4c77fc&&(_0x32e321=_0x4c77fc[0x1]||'/');}return _0x32e321['startsWith']('/api')&&(_0x32e321=_0x32e321['substring'](0x4)||'/'),_0x32e321;}function Ue(_0x1bf606,_0x556014){let _0x39c05c=_0x1bf606;if(_0x556014&&_0x39c05c['startsWith']('/apps/'+_0x556014))_0x39c05c=_0x39c05c['substring'](('/apps/'+_0x556014)['length'])||'/';else{let _0x595030=_0x39c05c['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x595030&&(_0x39c05c=_0x595030[0x1]||'/');}return(!_0x39c05c||_0x39c05c==='/')&&(_0x39c05c='/index.html'),_0x39c05c;}async function He(_0x9ff943,_0x22f01c){return await _0x22f01c(_0x9ff943);}function _(_0x2f8d60){return _0x2f8d60['split']('/')['filter'](_0x398164=>_0x398164['length']>0x0);}function te(_0x3a39e6){try{return decodeURIComponent(_0x3a39e6);}catch{return _0x3a39e6;}}function re(_0x57ace6,_0x1efa38){let _0x527c51=_(_0x57ace6),_0x34309d=_(_0x1efa38),_0x38db04={},_0x4c05ae=0x0,_0x29c185=0x0;for(;_0x4c05ae<_0x527c51['length']&&_0x29c185<_0x34309d['length'];){let _0x43d934=_0x527c51[_0x4c05ae],_0x165647=_0x34309d[_0x29c185];if(_0x43d934==='*')break;if(_0x43d934['startsWith'](':')){let _0x2d1d4e=_0x43d934['slice'](0x1);_0x2d1d4e&&(_0x38db04[_0x2d1d4e]=te(_0x165647)),_0x4c05ae++,_0x29c185++;continue;}if(_0x43d934!==_0x165647)return{};_0x4c05ae++,_0x29c185++;}return _0x4c05ae===_0x527c51['length']||_0x4c05ae===_0x527c51['length']-0x1&&_0x527c51[_0x4c05ae]==='*',_0x38db04;}async function Oe(_0xeeb900,_0x4e90bc,_0x500af4,_0xb33145,_0xfec8b0=void 0x0,_0x5bfb44){let _0x2448f9=await _0x4e90bc['text'](),_0x7db545=J(_0x2448f9),_0x43c399=B(_0x4e90bc['url']),_0x44d648={...F(_0xeeb900),'user':_0xfec8b0},_0x11a6e7=H(_0x44d648),_0x237b19=_0x5bfb44?re(_0x5bfb44,_0x4e90bc['path']):{};return{'app':O(_0xeeb900),'permissions':T(_0xeeb900),'user':_0xfec8b0,'metadata':_0x11a6e7,'body':_0x7db545,'query':_0x43c399,'params':_0x237b19,'method':_0x500af4,'pathname':_0xb33145,'requestUrl':_0x4e90bc['url'],'headers':Object['fromEntries'](_0x4e90bc['raw']['headers']['entries']())};}function Te(_0x77ad85){return{'method':_0x77ad85['method'],'pathname':_0x77ad85['pathname'],'ctx':_0x77ad85};}function Fe(_0x377f23,_0x39fac2){let {status:_0x2538df=0xc8,headers:_0x4f7eca={},body:_0x110df0,type:_0x54b2b5}=_0x377f23??{};return _0x54b2b5==='raw'?new globalThis['Response'](String(_0x110df0??''),{'status':_0x2538df,'headers':_0x4f7eca}):_0x39fac2(_0x110df0,_0x2538df);}function Ne(_0x623534,_0x1fdf84=null){return N(_0x623534,{'appInfo':_0x1fdf84});}var V=f;async function Ve(_0x2d9620){_0x2d9620?(await U(_0x2d9620),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x2d9620)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x1fe2fa,_0xf1f42f){let _0x1664fc=Object['fromEntries'](Object['entries'](_0x1fe2fa['headers']||{})['map'](([_0x38945a,_0x581fe6])=>[_0x38945a['toLowerCase'](),_0x581fe6]));return{'id':_0x1fe2fa['app']['id']||_0xf1f42f['appId']||'','name':_0x1fe2fa['app']['name']||'','version':_0x1fe2fa['app']['version']||'','description':_0x1fe2fa['app']['description']||'','metadata':{..._0x1fe2fa['metadata'],'permissions':_0x1fe2fa['permissions']},'body':_0x1fe2fa['body'],'query':_0x1fe2fa['query'],'params':_0x1fe2fa?.['params'],'method':_0x1fe2fa['method'],'pathname':_0x1fe2fa['pathname'],'requestUrl':_0x1fe2fa['requestUrl'],'user':_0x1fe2fa['user'],'headers':_0x1664fc};}var L=class{constructor(_0x4e9b9e){this['handle']=null,(this['config']=_0x4e9b9e,this['logger']=_0x4e9b9e['logger']||f,this['lifecycle']=W({'appsDir':_0x4e9b9e['appsDir'],'timeout':_0x4e9b9e['timeout'],'platformImports':_0x4e9b9e['platformImports'],'libDir':_0x4e9b9e['libDir']},{'onCreate':_0xec2d80=>this['logger']['info']('Worker\x20created',{'appId':_0xec2d80['appId']}),'onReady':_0x2582c4=>{this['lifecycle']['updateStatus'](_0x2582c4['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x2582c4['appId']});},'onCrash':_0x58bd79=>this['logger']['error']('Worker\x20crashed',{'appId':_0x58bd79['appId']}),'onStop':_0x4bbf1a=>this['logger']['info']('Worker\x20stopped',{'appId':_0x4bbf1a['appId']})}),this['messaging']=S({'onReady':_0x254ba1=>this['lifecycle']['updateStatus'](_0x254ba1,'running'),'onLog':(_0x216876,_0x4cc8c6,_0x1af1ef,_0x495f19)=>{(this['logger'][_0x4cc8c6]||this['logger']['info'])['call'](this['logger'],_0x1af1ef,_0x495f19);},'onResult':()=>{}},_0x4e9b9e['timeout']||0x1d4c0));}async['create'](_0xa03709){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0xe88216=await this['lifecycle']['create'](this['config']['appId'],_0xa03709,this['config']['scriptUrl']);this['messaging']['setup'](_0xe88216),this['messaging']['sendInit'](_0xe88216,this['config']['appsDir'],_0xa03709,this['config']['serverPath']),this['handle']=_0xe88216,await this['waitForReady']();}async['waitForReady'](_0x43ddb4=0x2710){let _0x4cc510=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x4cc510>_0x43ddb4)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x52deec=>setTimeout(_0x52deec,0x64));}}async['invoke'](_0x544847){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x544847);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x1769f0){return new L(_0x1769f0);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=S,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=xe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ce,exports['findApp']=He,exports['getAppLogMeta']=Ae,exports['getCacheSize']=Ze,exports['getWorkerManager']=Se,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=Pe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=$e,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;