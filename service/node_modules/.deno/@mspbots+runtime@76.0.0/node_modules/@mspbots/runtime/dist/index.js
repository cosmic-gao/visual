import{join,dirname}from'path';import _0x19ef84 from'process';import{stat}from'fs/promises';async function ie(_0x221b33){try{return await stat(_0x221b33),!0x0;}catch{return![];}}var f={'error':(_0x5a4696,_0x4e2e36)=>console['error']('[ERROR]\x20'+_0x5a4696,_0x4e2e36),'warn':(_0x53d6fa,_0x298980)=>console['warn']('[WARN]\x20'+_0x53d6fa,_0x298980),'info':(_0x27b80a,_0xfacc93)=>console['log']('[INFO]\x20'+_0x27b80a,_0xfacc93),'debug':(_0xa50e6b,_0x2f7479)=>console['log']('[DEBUG]\x20'+_0xa50e6b,_0x2f7479)};function z(){let _0x997aaf=globalThis['Deno'];if(!_0x997aaf)throw new Error('Deno is not available');return _0x997aaf;}var D=class{constructor(_0x1e1602,_0x558d16='./lib',_0x4f7726={}){this['manifest']=_0x1e1602,this['libDir']=_0x558d16,this['platformImports']=_0x4f7726;}['buildPerms'](){let _0x440007=this['manifest']['permissions']||{},_0x2958f8={};return _0x440007['net']!==void 0x0&&(_0x2958f8['net']=_0x440007['net']===!![]?!![]:Array['isArray'](_0x440007['net'])?_0x440007['net']:[]),_0x440007['read']!==void 0x0&&(_0x2958f8['read']=_0x440007['read']===!![]?!![]:Array['isArray'](_0x440007['read'])?_0x440007['read']:[]),_0x440007['write']!==void 0x0&&(_0x2958f8['write']=_0x440007['write']===!![]?!![]:Array['isArray'](_0x440007['write'])?_0x440007['write']:[]),_0x440007['env']!==void 0x0&&(_0x2958f8['env']=_0x440007['env']===!![]?!![]:Array['isArray'](_0x440007['env'])?_0x440007['env']:[]),_0x440007['run']!==void 0x0&&(_0x2958f8['run']=_0x440007['run']===!![]?!![]:Array['isArray'](_0x440007['run'])?_0x440007['run']:[]),_0x440007['ffi']!==void 0x0&&(_0x2958f8['ffi']=_0x440007['ffi']===!![]?!![]:Array['isArray'](_0x440007['ffi'])?_0x440007['ffi']:[]),_0x440007['sys']!==void 0x0&&(_0x2958f8['sys']=_0x440007['sys']===!![]?!![]:Array['isArray'](_0x440007['sys'])?_0x440007['sys']:[]),_0x440007['hrtime']!==void 0x0&&(_0x2958f8['hrtime']=_0x440007['hrtime']),_0x2958f8;}['normalize'](_0xae260d){return _0xae260d===!![]?[]:Array['isArray'](_0xae260d)?_0xae260d:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0xe748e3){return join(this['libDir'],_0xe748e3+'@*');}['getReadPaths'](){let _0x10500c=this['getImports']();_0x10500c['includes']('*')&&(_0x10500c=Object['keys'](this['platformImports']));let _0x567b56=[];console['log']('[Permissions] Building package path patterns for imports:',_0x10500c);for(let _0x294d5b of _0x10500c){let _0x110d89=this['getLibPattern'](_0x294d5b);_0x567b56['push'](_0x110d89),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x294d5b+'\x20->\x20'+_0x110d89);}return console['log']('[Permissions] Final package path patterns:',_0x567b56),_0x567b56;}['buildImportMap'](_0x499036){let _0x4b6f4e=this['getImports'](),_0x8d2724=_0x4b6f4e['includes']('*')?Object['keys'](_0x499036):_0x4b6f4e;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x8d2724);let _0x4a98f6={};for(let _0x466939 of _0x8d2724)if(_0x499036[_0x466939])_0x4a98f6[_0x466939]=_0x499036[_0x466939],console['log']('[ImportMap]\x20'+_0x466939+'\x20->\x20'+_0x499036[_0x466939]+'\x20(from\x20platform)');else try{let _0x495cbd=z(),_0x3ab263=join(_0x495cbd['cwd'](),this['libDir']),_0x1d8fa7=!0x1;try{for(let _0x28449a of _0x495cbd['readDirSync'](_0x3ab263))if(_0x28449a['isDirectory']&&(_0x28449a['name']===_0x466939||_0x28449a['name']['startsWith'](_0x466939+'@'))){let _0x2cc5b5=join(_0x495cbd['cwd'](),this['libDir'],_0x28449a['name'],'index.js')['replace'](/\\/g,'/'),_0x24b01e=new URL('file:///'+_0x2cc5b5)['href'];_0x4a98f6[_0x466939]=_0x24b01e,console['log']('[ImportMap]\x20'+_0x466939+'\x20->\x20'+_0x24b01e+'\x20(from\x20lib)'),_0x1d8fa7=!0x0;break;}}catch{}_0x1d8fa7||console['warn']('[ImportMap]\x20Package\x20'+_0x466939+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x162f44){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x466939+':',_0x162f44);}return _0x4a98f6;}['validateServerImports'](_0x45016e){let _0x248ffc=this['manifest']['name']||this['manifest']['id'],_0x167f2f=this['manifest']['metadata']?.['serverPath'],_0x1084cc=_0x386484=>_0x386484['replace'](/\\/g,'/'),_0x37e61c=z(),_0x3d297f=_0x10f2cb=>{try{return _0x37e61c['statSync'](_0x10f2cb),!0x0;}catch{return![];}},_0x466fac=_0x167f2f?_0x1084cc(_0x167f2f):void 0x0;if(!_0x466fac){let _0x3761f2=[_0x45016e+'/service/server.js',_0x45016e+'/service/server.ts',_0x45016e+'/'+_0x248ffc+'/server.js',_0x45016e+'/'+_0x248ffc+'/server.ts',_0x45016e+'/server.js',_0x45016e+'/server.ts']['map'](_0x1084cc);for(let _0x539b2d of _0x3761f2)if(_0x3d297f(_0x539b2d)){_0x466fac=_0x539b2d;break;}}if(!_0x466fac)return{'valid':![],'violations':['Failed to locate server module']};let _0x329956='';try{_0x329956=_0x37e61c['readTextFileSync'](_0x466fac);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x466fac};}let _0xbd30ab=this['getImports']();if(_0xbd30ab['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x466fac};let _0x548a88=_0xbd30ab,_0x3d2bc2=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x586db0=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x500a14=/\bimport\s*['"]([^'"]+)['"]/g,_0x1b4139=[],_0x5706c6=new Set(),_0x5ca975=_0x2ada50=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x2ada50),_0x27de73=_0x4cc34c=>{let _0x3e337d=_0x4cc34c;if(_0x3e337d['startsWith']('./')||_0x3e337d['startsWith']('../')||_0x3e337d['startsWith']('/')||_0x3e337d['startsWith']('file://')||!_0x5ca975(_0x4cc34c)||_0x5706c6['has'](_0x4cc34c))return;_0x5706c6['add'](_0x4cc34c),_0x3e337d['startsWith']('npm:')&&(_0x3e337d=_0x3e337d['substring'](0x4)),_0x3e337d['includes']('@')&&!_0x3e337d['startsWith']('@')&&(_0x3e337d=_0x3e337d['split']('@')[0x0]);let _0x2e9c32=_0x3e337d['split']('/')[0x0];_0x548a88['includes'](_0x2e9c32)||_0x548a88['includes'](_0x4cc34c)||_0x1b4139['push'](_0x4cc34c);},_0x2f616f;for(;(_0x2f616f=_0x3d2bc2['exec'](_0x329956))!==null;)_0x27de73(_0x2f616f[0x1]);for(;(_0x2f616f=_0x586db0['exec'](_0x329956))!==null;)_0x27de73(_0x2f616f[0x1]);for(;(_0x2f616f=_0x500a14['exec'](_0x329956))!==null;)_0x27de73(_0x2f616f[0x1]);return{'valid':_0x1b4139['length']===0x0,'violations':_0x1b4139,'serverPath':_0x466fac};}['validate'](_0x50f94b={}){let _0x122794=[],_0x3a231b=this['manifest']['permissions']||{};try{let _0x4f4d5c=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x4f4d5c);}catch{}let _0x132ef6=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x153c82,_0x562a5c]of Object['entries'](_0x3a231b))if(_0x153c82==='hrtime')typeof _0x562a5c!='boolean'&&_0x122794['push']('Permission\x20\x27'+_0x153c82+'\x27\x20must\x20be\x20boolean');else{if(_0x153c82==='langchain')typeof _0x562a5c!='boolean'&&(typeof _0x562a5c!='object'||_0x562a5c===null)?_0x122794['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x562a5c=='object'&&(_0x562a5c===null||!('enabled'in _0x562a5c)||typeof _0x562a5c['enabled']!='boolean')&&_0x122794['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x153c82==='kv')typeof _0x562a5c!='boolean'&&_0x122794['push']('Permission\x20\x27'+_0x153c82+'\x27\x20must\x20be\x20boolean');else{if(_0x153c82==='mspbots')Array['isArray'](_0x562a5c)||_0x122794['push']('Permission\x20\x27'+_0x153c82+'\x27\x20must\x20be\x20an\x20array');else{if(_0x153c82==='db'){if(typeof _0x562a5c!='object'||_0x562a5c===null||Array['isArray'](_0x562a5c))_0x122794['push']('Permission\x20\x27'+_0x153c82+'\x27\x20must\x20be\x20an\x20object');else{let _0x259e01=_0x562a5c,_0x400d0d=['user','password']['filter'](_0xc95bd4=>!(_0xc95bd4 in _0x259e01));_0x400d0d['length']>0x0&&_0x122794['push']('Permission\x20\x27'+_0x153c82+'\x27\x20missing\x20required\x20fields:\x20'+_0x400d0d['join'](',\x20'));}}else{if(_0x153c82==='imports')continue;_0x132ef6['has'](_0x153c82)||typeof _0x562a5c!='boolean'&&!Array['isArray'](_0x562a5c)&&_0x122794['push']('Permission\x20\x27'+_0x153c82+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x536803=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x536803))_0x122794['push']('permissions.imports must be an array');else{for(let _0x5ed477 of _0x536803)typeof _0x5ed477!='string'&&_0x122794['push']('import\x20\x27'+_0x5ed477+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x122794['length']===0x0,'errors':_0x122794};}};function q(_0x896b,_0x40c90b,_0x403e2a){return new D(_0x896b,_0x40c90b,_0x403e2a||{});}var R=null;function I(){let _0xc9db1c=globalThis['Deno'];if(!_0xc9db1c)throw new Error('Deno is not available');return _0xc9db1c;}async function K(){if(R)return{...R};try{let _0x2e88f5=I(),_0x4d0de5=join(_0x2e88f5['cwd'](),'deno.json'),_0x9d7a54=await _0x2e88f5['readTextFile'](_0x4d0de5);return R=JSON['parse'](_0x9d7a54)['imports']||{},{...R};}catch(_0x10414c){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x10414c),{};}}var E=class{constructor(_0x127333,_0x154d87={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x127333['appsDir'],this['platformImportsOverride']=_0x127333['platformImports'],this['libDir']=_0x127333['libDir'],this['events']=_0x154d87);}async['create'](_0x352d2e,_0x3658d5,_0xb88d22){try{return await this['createWorker'](_0x352d2e,_0x3658d5,_0xb88d22);}catch(_0x2ea6d0){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x352d2e+':',_0x2ea6d0),_0x2ea6d0;}}async['createWorker'](_0x430753,_0x4dbcaf,_0x58eebd){let _0x4a16d8=this['platformImportsOverride']||await K(),_0x31beb3=q(_0x4dbcaf,this['libDir'],_0x4a16d8)['validateServerImports'](this['appsDir']);if(!_0x31beb3['valid']){let _0x4e9b1c=_0x31beb3['violations']['filter'](_0x595990=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x595990)),_0x1b06a9=_0x31beb3['serverPath']?_0x31beb3['serverPath']:(_0x4dbcaf['name']||_0x4dbcaf['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x1b06a9+':\x20'+_0x4e9b1c['join'](',\x20'));}let _0x366ff9=q(_0x4dbcaf,this['libDir'],_0x4a16d8),_0x747e5a=_0x366ff9['validate'](_0x4a16d8);if(!_0x747e5a['valid'])throw new Error('Invalid\x20config:\x20'+_0x747e5a['errors']['join'](',\x20'));let _0x408822=_0x366ff9['buildImportMap'](_0x4a16d8);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x430753+':',_0x408822);let _0x28510f=_0x366ff9['buildPerms'](),_0x524fbf=_0x366ff9['getReadPaths']();if(_0x28510f['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x28510f['read']);else{let _0x30833b=_0x4dbcaf['name']||_0x430753,_0x6230f0=this['appsDir']+'/'+_0x30833b,_0x4205ab=[_0x6230f0],_0x44d97b=_0x4dbcaf['metadata']?.['serverPath'];if(_0x44d97b&&typeof _0x44d97b=='string')try{let _0x4f0ac8=dirname(_0x44d97b)['replace'](/\\/g,'/');_0x4205ab['push'](_0x4f0ac8);}catch{}_0x28510f['read']=_0x4205ab,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x6230f0);}if(_0x524fbf['length']>0x0){if(_0x28510f['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x55c9d0=Array['isArray'](_0x28510f['read'])?_0x28510f['read']:[];_0x28510f['read']=[..._0x55c9d0,..._0x524fbf],console['log']('[Worker] Added package read permissions:',_0x524fbf);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x28510f['net']||(_0x28510f['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x430753+':',_0x28510f['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x28510f['read']===!![]?'unrestricted':Array['isArray'](_0x28510f['read'])?_0x28510f['read']['length']:0x0));let _0x37b685=await this['createImportMap'](_0x430753,_0x408822),_0xb443a2=await this['createLock'](_0x430753,_0x408822),_0x32ed90={'type':'module','deno':{'permissions':{}}};_0x32ed90['deno']['namespace']=![],_0x32ed90['deno']['permissions']=_0x28510f,_0x32ed90['deno']['importMap']=_0x37b685,_0x32ed90['deno']['lock']=_0xb443a2,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x430753+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x37b685),console['log']('\x20\x20-\x20Lockfile:\x20'+_0xb443a2),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x408822)['length']+'\x20('+(Object['keys'](_0x408822)['join'](',\x20')||'none')+')');let _0x2c0b0b={'worker':new Worker(_0x58eebd,_0x32ed90),'appId':_0x430753,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x4dbcaf,'importMapPath':_0x37b685,'lockfilePath':_0xb443a2};return this['workers']['set'](_0x430753,_0x2c0b0b),this['events']['onCreate']?.(_0x2c0b0b),_0x2c0b0b;}async['createLock'](_0x108e1d,_0x3838d1){let _0x10cbfa=I(),_0x5c6e86=join(_0x10cbfa['cwd'](),'storage','temp','lockfiles');await _0x10cbfa['mkdir'](_0x5c6e86,{'recursive':!![]});let _0x42f2e4=_0x108e1d+'-'+Date['now']()+'.lock',_0x442692=join(_0x5c6e86,_0x42f2e4),_0x46542e={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x1b48f0,_0x2e9894]of Object['entries'](_0x3838d1))if(_0x2e9894['startsWith']('npm:'))_0x2e9894['replace']('npm:',''),_0x46542e['packages']['specifiers'][_0x1b48f0]=_0x2e9894;else _0x2e9894['startsWith']('file://')&&(_0x46542e['packages']['specifiers'][_0x1b48f0]=_0x2e9894);let _0x347355=JSON['stringify'](_0x46542e,null,0x2);return await _0x10cbfa['writeTextFile'](_0x442692,_0x347355),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x442692),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x3838d1)['length']+'):',Object['keys'](_0x3838d1)),_0x442692;}async['createImportMap'](_0x82b28d,_0xea46d9){let _0x438985=I(),_0x36b856=join(_0x438985['cwd'](),'storage','temp','importmaps');await _0x438985['mkdir'](_0x36b856,{'recursive':!![]});let _0x599b92=_0x82b28d+'-'+Date['now']()+'.json',_0x3623fd=join(_0x36b856,_0x599b92),_0x1d14cc=JSON['stringify']({'imports':_0xea46d9,'scopes':{}},null,0x2);return await _0x438985['writeTextFile'](_0x3623fd,_0x1d14cc),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x3623fd),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0xea46d9)['length']+'):',Object['keys'](_0xea46d9)['join'](',\x20')||'none'),_0x3623fd;}['get'](_0x2d9baa){return this['workers']['get'](_0x2d9baa);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x2f39dd,_0x3abf24){let _0x32ddc1=this['workers']['get'](_0x2f39dd);if(!_0x32ddc1)return;let _0x19d1f9=_0x32ddc1['status'];_0x32ddc1['status']=_0x3abf24,_0x3abf24==='running'&&_0x19d1f9==='starting'?this['events']['onReady']?.(_0x32ddc1):_0x3abf24==='crashed'&&this['events']['onCrash']?.(_0x32ddc1);}['touch'](_0x5c24b5){let _0x1adcb8=this['workers']['get'](_0x5c24b5);_0x1adcb8&&(_0x1adcb8['lastUsed']=Date['now']());}async['stop'](_0x2b6166){let _0x18d795=this['workers']['get'](_0x2b6166);if(_0x18d795)try{_0x18d795['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x18d795['worker']['terminate'](),_0x18d795['status']='stopped',this['events']['onStop']?.(_0x18d795),_0x18d795['importMapPath']&&await this['cleanupImportMap'](_0x18d795['importMapPath']),_0x18d795['lockfilePath']&&await this['cleanupLock'](_0x18d795['lockfilePath']);}catch(_0x5307bf){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x2b6166+':',_0x5307bf);}finally{this['workers']['delete'](_0x2b6166);}}async['cleanupImportMap'](_0x3142a5){try{await I()['remove'](_0x3142a5),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x3142a5);}catch(_0x17c4d5){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x3142a5,_0x17c4d5);}}async['cleanupLock'](_0x48f6f6){try{await I()['remove'](_0x48f6f6),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x48f6f6);}catch(_0x509561){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x48f6f6,_0x509561);}}async['stopAll'](){let _0x20d31f=Array['from'](this['workers']['keys']());await Promise['all'](_0x20d31f['map'](_0x1293a6=>this['stop'](_0x1293a6)));}async['restart'](_0x4ebb29,_0x2d2ea){let _0x32839a=this['workers']['get'](_0x4ebb29);if(!_0x32839a)throw new Error('Worker\x20'+_0x4ebb29+'\x20not\x20found');let _0x7d91c0=_0x32839a['manifest'];return await this['stop'](_0x4ebb29),await this['create'](_0x4ebb29,_0x7d91c0,_0x2d2ea);}['checkHealth'](_0x53edca){let _0x28188f=this['workers']['get'](_0x53edca);if(!_0x28188f)return{'healthy':![],'reason':'Not\x20found'};if(_0x28188f['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x28188f['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x538297=Date['now']()-_0x28188f['lastUsed'],_0x39abd8=0x708*0x3e8;return _0x538297>_0x39abd8?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x538297/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x23039b=0x708*0x3e8,_0x144f8b){let _0x327bf4=Date['now'](),_0x432ba7=[];for(let [_0x404138,_0x3eb88a]of this['workers']['entries']()){let _0x2ee3aa=_0x327bf4-_0x3eb88a['lastUsed'];_0x2ee3aa>_0x23039b&&_0x432ba7['push']({'appId':_0x404138,'idle':_0x2ee3aa});}_0x432ba7['sort']((_0x40a4e6,_0x281e5c)=>_0x281e5c['idle']-_0x40a4e6['idle']);let _0x2ea112=_0x144f8b?_0x432ba7['slice'](0x0,_0x144f8b)['map'](_0xd0b88a=>_0xd0b88a['appId']):_0x432ba7['map'](_0x1cf6cb=>_0x1cf6cb['appId']);for(let _0x3ebb7a of _0x2ea112)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x3ebb7a),await this['stop'](_0x3ebb7a);}['stats'](){let _0x44c326={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x408158=Date['now']();for(let _0x298a19 of this['workers']['values']())_0x44c326['byStatus'][_0x298a19['status']]++,_0x44c326['workers']['push']({'appId':_0x298a19['appId'],'status':_0x298a19['status'],'version':_0x298a19['version'],'lastUsed':_0x298a19['lastUsed'],'idle':_0x408158-_0x298a19['lastUsed']});return _0x44c326;}['startCleanup'](_0x161885=0x12c*0x3e8,_0x42b948){let _0x96bd6a=setInterval(()=>{this['cleanup'](_0x42b948)['catch'](_0x3119c0=>{console['error']('Cleanup\x20failed:',_0x3119c0);});},_0x161885);return()=>clearInterval(_0x96bd6a);}['delay'](_0x343f83){return new Promise(_0x3c9974=>setTimeout(_0x3c9974,_0x343f83));}};function W(_0x40df5b,_0x3aa584){return new E(_0x40df5b,_0x3aa584);}var v=f,j=class{constructor(_0x32b1c9,_0x49e938=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x32b1c9,this['timeout']=_0x49e938);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x4d15d4){_0x4d15d4['worker']['onmessage']=_0x2f2992=>{let _0x45c0dc=_0x2f2992['data'],{appId:_0x4a5e9a}=_0x4d15d4;switch(_0x45c0dc['type']){case'ready':this['events']['onReady'](_0x4a5e9a),v['info']('Worker\x20ready',{'appId':_0x4a5e9a,'version':_0x4d15d4['version']});break;case'log':{let {level:_0x1d5e1f='info',message:_0x24d652,meta:_0x425551}=_0x45c0dc,_0x4fb706={..._0x425551||{},'appId':_0x4a5e9a,'version':_0x4d15d4['version']};this['events']['onLog'](_0x4a5e9a,_0x1d5e1f,_0x24d652,_0x4fb706);break;}case'result':{let {reqId:_0x3e0689,ok:_0x4a1562,response:_0x5f1f08,error:_0x15b388}=_0x45c0dc,_0x1bfdc1=this['pending']['get'](_0x3e0689);if(!_0x1bfdc1){v['warn']('Unknown\x20request',{'appId':_0x4a5e9a,'reqId':_0x3e0689});return;}if(this['pending']['delete'](_0x3e0689),_0x4a1562&&_0x5f1f08)_0x1bfdc1['resolve'](_0x5f1f08);else{let _0x29ef9e=new Error(_0x15b388?.['message']||'Worker\x20error');_0x29ef9e['stack']=_0x15b388?.['stack'],_0x1bfdc1['reject'](_0x29ef9e);}this['events']['onResult'](_0x4a5e9a,_0x3e0689,_0x5f1f08||_0x15b388);break;}default:v['debug']('Unknown\x20message',{'appId':_0x4a5e9a,'type':_0x45c0dc['type']});}},_0x4d15d4['worker']['onerror']=_0x3f7f50=>{let {appId:_0xb327d8}=_0x4d15d4;v['error']('Worker\x20error',{'appId':_0xb327d8,'message':_0x3f7f50['message'],'lineno':_0x3f7f50['lineno'],'filename':_0x3f7f50['filename']}),_0x4d15d4['status']='crashed',this['rejectPending'](_0xb327d8,new Error('Worker\x20'+_0xb327d8+'\x20crashed:\x20'+_0x3f7f50['message'])),_0x3f7f50['preventDefault']();},_0x4d15d4['worker']['onmessageerror']=_0x513a62=>{let {appId:_0x2a374d}=_0x4d15d4;v['error']('Message\x20error',{'appId':_0x2a374d,'data':_0x513a62['data']}),_0x4d15d4['status']='crashed',_0x513a62['preventDefault']();};}['sendInit'](_0x575044,_0x28bb03,_0x3c2f6c,_0x18e026){_0x575044['worker']['postMessage']({'type':'init','appId':_0x575044['appId'],'manifest':_0x3c2f6c,'appsDir':_0x28bb03,'serverPath':_0x18e026});}async['sendInvoke'](_0x4bef1d,_0x4e4a32){let _0x361586=this['nextId'](),_0x1b0b57=_0x4bef1d['appId'],_0x58b3b0=new Promise((_0xe949dd,_0x440a42)=>{let _0x1bea3e=setTimeout(()=>{this['pending']['delete'](_0x361586),_0x440a42(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x361586,{'resolve':_0x21bd5d=>{clearTimeout(_0x1bea3e),_0xe949dd(_0x21bd5d);},'reject':_0x300b8b=>{clearTimeout(_0x1bea3e),_0x440a42(_0x300b8b);},'timestamp':Date['now'](),'appId':_0x1b0b57});});return _0x4bef1d['worker']['postMessage']({'type':'invoke','appId':_0x4bef1d['appId'],'reqId':_0x361586,'payload':_0x4e4a32}),await _0x58b3b0;}['rejectPending'](_0x102092,_0x183f8a){let _0x3ebe6a=0x0;for(let [_0x205651,_0x47eb31]of this['pending']['entries']())_0x47eb31['appId']===_0x102092&&(this['pending']['delete'](_0x205651),_0x47eb31['reject'](_0x183f8a),_0x3ebe6a++);_0x3ebe6a>0x0&&v['warn']('Rejected\x20'+_0x3ebe6a+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x102092});}['cleanupTimeout'](){let _0xb0bd25=Date['now']();for(let [_0x265a43,_0x4ed902]of this['pending']['entries']())_0xb0bd25-_0x4ed902['timestamp']>this['timeout']&&(this['pending']['delete'](_0x265a43),_0x4ed902['reject'](new Error('Request\x20'+_0x265a43+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x3d329e){let _0x426d3b=0x0;for(let _0x29a68b of this['pending']['values']())_0x29a68b['appId']===_0x3d329e&&_0x426d3b++;return _0x426d3b;}['startCleanup'](_0x1b1759=0x2710){let _0x7aeb4=setInterval(()=>{this['cleanupTimeout']();},_0x1b1759);return()=>clearInterval(_0x7aeb4);}};function $(_0x31b483,_0x1b0be7){return new j(_0x31b483,_0x1b0be7);}var Q=class{constructor(_0x146eed={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x146eed['logger']||f,this['config']={'appsDir':_0x146eed['appsDir']||this['getAppsDir'](),'scriptUrl':_0x146eed['scriptUrl']||this['getScriptUrl'](),'timeout':_0x146eed['timeout']||0x78*0x3e8,'autoCleanup':_0x146eed['autoCleanup']??!![],'cleanupInterval':_0x146eed['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x146eed['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x146eed['maxWorkers'],'reuseWorkers':_0x146eed['reuseWorkers']??!![],'workerReuseStrategy':_0x146eed['workerReuseStrategy']||'lru','enableQueue':_0x146eed['enableQueue']??!![],'maxQueueSize':_0x146eed['maxQueueSize']||0x64,'queueTimeout':_0x146eed['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x1397f0=>this['logger']['info']('Worker\x20created',{'appId':_0x1397f0['appId'],'v':_0x1397f0['version']}),'onReady':_0x16d007=>this['lifecycle']['updateStatus'](_0x16d007['appId'],'running'),'onCrash':_0x5490ac=>this['logger']['error']('Worker\x20crashed',{'appId':_0x5490ac['appId'],'v':_0x5490ac['version']}),'onStop':_0x4b7498=>this['logger']['info']('Worker\x20stopped',{'appId':_0x4b7498['appId'],'v':_0x4b7498['version']})}),this['messaging']=$({'onReady':_0x574002=>this['lifecycle']['updateStatus'](_0x574002,'running'),'onLog':(_0x20de6b,_0x256c6a,_0x3d7cd7,_0x2cb996)=>{let _0x14a1bb={..._0x2cb996||{},'appId':_0x20de6b};switch(_0x256c6a){case'error':this['logger']['error'](_0x3d7cd7,_0x14a1bb);break;case'warn':this['logger']['warn'](_0x3d7cd7,_0x14a1bb);break;case'debug':this['logger']['debug'](_0x3d7cd7,_0x14a1bb);break;default:this['logger']['info'](_0x3d7cd7,_0x14a1bb);break;}},'onResult':(_0x1ed084,_0x1ffb74,_0x2161de)=>{this['logger']['debug']('Result\x20received',{'appId':_0x1ed084,'reqId':_0x1ffb74});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x19ef84['cwd'](),'apps');}['getScriptUrl'](){let _0xa3a54=import.meta.url,_0x13aedc=_0xa3a54['endsWith']('.js')||_0xa3a54['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x13aedc,_0xa3a54)['href'];}async['ensure'](_0x1c2b53){let {id:_0x2870c3}=_0x1c2b53,_0x2d6143=this['lifecycle']['get'](_0x2870c3);if(_0x2d6143){let _0x4c25cd=this['lifecycle']['checkHealth'](_0x2870c3);if(_0x4c25cd['healthy'])return this['lifecycle']['touch'](_0x2870c3),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x2870c3}),_0x2d6143;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x2870c3,'reason':_0x4c25cd['reason']}),await this['lifecycle']['stop'](_0x2870c3);}for(;;){let _0x82f92a=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x82f92a>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x82f92a,'max':this['config']['maxWorkers'],'appId':_0x2870c3}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x1c2b53);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x2b86b5=await this['loadManifest'](_0x2870c3,_0x1c2b53['manifest']),_0x4c57d8=await this['lifecycle']['create'](_0x2870c3,_0x2b86b5,this['config']['scriptUrl']),_0x331b8a=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x331b8a>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x331b8a,'max':this['config']['maxWorkers'],'appId':_0x2870c3}),await this['lifecycle']['stop'](_0x2870c3),this['config']['enableQueue'])return await this['waitSlot'](_0x1c2b53);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x331b8a+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x4c57d8);let _0x454f5d=_0x2b86b5['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x4c57d8,this['config']['appsDir'],_0x2b86b5,_0x454f5d),this['logger']['info']('Worker\x20created',{'appId':_0x2870c3,'v':_0x4c57d8['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x4c57d8;}async['evictIdle'](){let _0x260600=this['lifecycle']['getAll']();if(_0x260600['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0xe83e19=[..._0x260600];this['config']['workerReuseStrategy']==='lru'?_0xe83e19['sort']((_0x2ee52f,_0x47fbdc)=>_0x2ee52f['lastUsed']-_0x47fbdc['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0xe83e19['sort']((_0xffe44a,_0x221ca7)=>_0xffe44a['version']-_0x221ca7['version']);let _0x334fda=null;for(let _0x2dac2c of _0xe83e19)if(this['messaging']['getAppCount'](_0x2dac2c['appId'])===0x0){_0x334fda=_0x2dac2c;break;}if(!_0x334fda&&_0xe83e19['length']>0x0&&(_0x334fda=_0xe83e19['reduce']((_0x56cd55,_0x3e47bd)=>{let _0x4d668f=this['messaging']['getAppCount'](_0x56cd55['appId']);return this['messaging']['getAppCount'](_0x3e47bd['appId'])<_0x4d668f?_0x3e47bd:_0x56cd55;})),_0x334fda){let _0x3d35f0=this['messaging']['getAppCount'](_0x334fda['appId']);return _0x3d35f0>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x334fda['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x334fda['lastUsed'],'pendingRequests':_0x3d35f0}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x334fda['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x334fda['lastUsed']}),await this['lifecycle']['stop'](_0x334fda['appId']),!![];}return![];}['waitSlot'](_0x5ec472){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x482bd3,_0x2e3d34)=>{let _0x4b105d={'info':_0x5ec472,'resolve':_0x482bd3,'reject':_0x2e3d34,'timestamp':Date['now']()};this['requestQueue']['push'](_0x4b105d),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x5ec472['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x41dbd8=setTimeout(()=>{let _0x150cb7=this['requestQueue']['indexOf'](_0x4b105d);_0x150cb7!==-0x1&&(this['requestQueue']['splice'](_0x150cb7,0x1),_0x2e3d34(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x4b105d['resolve']=_0x516e6d=>{clearTimeout(_0x41dbd8),_0x482bd3(_0x516e6d);},_0x4b105d['reject']=_0x436e50=>{clearTimeout(_0x41dbd8),_0x2e3d34(_0x436e50);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x5a7a9b=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x5a7a9b>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x4069ca=this['requestQueue']['shift']();if(!_0x4069ca)break;try{let _0x1999aa=await this['ensure'](_0x4069ca['info']);_0x4069ca['resolve'](_0x1999aa);}catch(_0x14ee6e){_0x4069ca['reject'](_0x14ee6e);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0xbfb76,_0x512873){let _0x59803e=this['config']['appsDir']['replace'](/\\/g,'/'),_0x1cf1af=async _0x1ecf97=>{try{let _0x264787=globalThis['Deno'];if(!_0x264787)return null;let _0xe80dc3=await _0x264787['readTextFile'](_0x1ecf97);return JSON['parse'](_0xe80dc3);}catch{return null;}};if(_0x512873?.['name']){let _0x597d18=await _0x1cf1af(_0x59803e+'/'+_0x512873['name']+'/manifest.json');if(_0x597d18)return _0x597d18;}let _0x1a48ae=await _0x1cf1af(_0x59803e+'/'+_0xbfb76+'/manifest.json');if(_0x1a48ae)return _0x1a48ae;try{let _0x1f58a8=globalThis['Deno'];if(_0x1f58a8)for await(let _0x5d3a60 of _0x1f58a8['readDir'](_0x59803e)){if(!_0x5d3a60['isDirectory'])continue;let _0x4d16fe=_0x59803e+'/'+_0x5d3a60['name']+'/manifest.json',_0x13aa17=await _0x1cf1af(_0x4d16fe);if(_0x13aa17&&(_0x13aa17['id']===_0xbfb76||_0x512873?.['name']&&_0x13aa17['name']===_0x512873['name']))return _0x13aa17;}}catch(_0x4128f7){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0xbfb76,'error':_0x4128f7['message']});}return _0x512873||{'id':_0xbfb76,'name':_0xbfb76,'version':'1.0.0'};}async['invoke'](_0xdbc67c){let _0x1d93ce=_0xdbc67c['ctx']['app']['id'],_0x12840c=_0xdbc67c['ctx']['app']['name'];try{let _0x5125b0={'id':_0x1d93ce,'manifest':{'id':_0x1d93ce,'name':_0x12840c}},_0x4d85b7=await this['ensure'](_0x5125b0);if(_0x4d85b7['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x1d93ce}),await this['restart'](_0x1d93ce);let _0x2bdfc4=await this['ensure'](_0x5125b0);return this['lifecycle']['touch'](_0x1d93ce),await this['messaging']['sendInvoke'](_0x2bdfc4,_0xdbc67c);}return this['lifecycle']['touch'](_0x1d93ce),await this['messaging']['sendInvoke'](_0x4d85b7,_0xdbc67c);}catch(_0x2d3760){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x1d93ce,'error':_0x2d3760['message'],'stack':_0x2d3760['stack']}),_0x2d3760;}}async['stop'](_0x231e5f){await this['lifecycle']['stop'](_0x231e5f),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x326dea){return await this['lifecycle']['restart'](_0x326dea,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x3457c3=>({'appId':_0x3457c3['appId'],'status':_0x3457c3['status'],'version':_0x3457c3['version'],'lastUsed':_0x3457c3['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x39a53f=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x38ef36=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x39a53f(),_0x38ef36();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x257945=>{_0x257945?(await this['stop'](_0x257945),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x257945})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x2ccaa9){return new Q(_0x2ccaa9);}var S=null;function be(_0x16cda){S=ee(_0x16cda);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x2e0510){return await k()['ensure'](_0x2e0510);}async function xe(_0x579e00){return await k()['invoke'](_0x579e00);}function Ie(_0x383b7e){k()['stop'](_0x383b7e)['catch'](_0x371c7b=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x383b7e,'error':_0x371c7b['message']});});}function Re(){k()['stopAll']()['catch'](_0x7bfabf=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x7bfabf['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x5b040c){await k()['stop'](_0x5b040c);}async function Se(){await k()['stopAll']();}function Ae(_0x426401){let _0x59c643=_0x426401&&typeof _0x426401=='object'?_0x426401:null;if(_0x59c643&&'user'in _0x59c643)return _0x59c643['user'];}function H(_0xdf6d1a){let _0x2cdc17=_0xdf6d1a&&typeof _0xdf6d1a=='object'?_0xdf6d1a:null;if(!_0x2cdc17)return{};let _0x1e1f0e={};for(let [_0x3ea933,_0x30bf47]of Object['entries'](_0x2cdc17))_0x3ea933!=='user'&&(_0x1e1f0e[_0x3ea933]=_0x30bf47);return _0x1e1f0e;}function O(_0x16a57b){return _0x16a57b?{'id':_0x16a57b['manifest']?.['id']||_0x16a57b['id']||'','name':_0x16a57b['manifest']?.['name']||'','version':_0x16a57b['manifest']?.['version']||'','description':_0x16a57b['manifest']?.['description']||'','icon':_0x16a57b['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x4b877c){return _0x4b877c?.['permissions']||_0x4b877c?.['manifest']?.['permissions']||{};}function F(_0x49a151){return _0x49a151?.['manifest']?.['metadata']||{};}function Ce(_0x3f635e){return _0x3f635e?{'appId':_0x3f635e['id'],'appName':_0x3f635e['manifest']?.['name']}:{};}function N(_0x126647,_0x527212={}){let {appInfo:_0x3d0796=null,status:_0x1f765d=0x1f4,defaultMessage:_0xd7c044='Internal\x20Server\x20Error'}=_0x527212,_0x2cfa0f={'error':_0xd7c044,'message':_0x126647?.['message']||_0xd7c044};return _0x3d0796&&(_0x2cfa0f['appId']=_0x3d0796['id'],_0x2cfa0f['appName']=_0x3d0796['manifest']?.['name']),_0x126647?.['message']?.['includes']('crashed')&&(_0x2cfa0f['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x1f765d,'body':_0x2cfa0f};}function qe(_0x1e281e){return _0x1e281e?.['message']?.['includes']('crashed')||![];}function J(_0x2d8b3a){if(_0x2d8b3a)try{return JSON['parse'](_0x2d8b3a);}catch{return _0x2d8b3a;}}function B(_0x5ec434){try{let _0x201910=new URL(_0x5ec434),_0x35eaa7={};for(let _0x579cf3 of _0x201910['searchParams']['keys']()){let _0x167931=_0x201910['searchParams']['getAll'](_0x579cf3)['map'](_0x399ad2=>_0x399ad2);_0x167931['length']<=0x1?_0x35eaa7[_0x579cf3]=_0x167931[0x0]??'':_0x35eaa7[_0x579cf3]=_0x167931;}return _0x35eaa7;}catch{return{};}}function Le(_0x95d180){return(()=>{try{return new URL(_0x95d180)['pathname'];}catch{return _0x95d180;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x4ca058,_0xfcab12){let _0x511beb=_0x4ca058;if(_0xfcab12&&_0x511beb['startsWith']('/apps/'+_0xfcab12))_0x511beb=_0x511beb['substring'](('/apps/'+_0xfcab12)['length'])||'/';else{let _0x57d5ac=_0x511beb['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x57d5ac&&(_0x511beb=_0x57d5ac[0x1]||'/');}return _0x511beb['startsWith']('/api')&&(_0x511beb=_0x511beb['substring'](0x4)||'/'),_0x511beb;}function Ue(_0x24454c,_0x4c5349){let _0x383383=_0x24454c;if(_0x4c5349&&_0x383383['startsWith']('/apps/'+_0x4c5349))_0x383383=_0x383383['substring'](('/apps/'+_0x4c5349)['length'])||'/';else{let _0x131e7a=_0x383383['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x131e7a&&(_0x383383=_0x131e7a[0x1]||'/');}return(!_0x383383||_0x383383==='/')&&(_0x383383='/index.html'),_0x383383;}async function He(_0x4d4293,_0x18847a){return await _0x18847a(_0x4d4293);}function _(_0x450de1){return _0x450de1['split']('/')['filter'](_0x385559=>_0x385559['length']>0x0);}function te(_0x1edda5){try{return decodeURIComponent(_0x1edda5);}catch{return _0x1edda5;}}function re(_0x27bc42,_0x5859e8){let _0x1614ec=_(_0x27bc42),_0x536e3c=_(_0x5859e8),_0x3cca31={},_0x1406c5=0x0,_0x3cabf0=0x0;for(;_0x1406c5<_0x1614ec['length']&&_0x3cabf0<_0x536e3c['length'];){let _0x294350=_0x1614ec[_0x1406c5],_0x4cc49b=_0x536e3c[_0x3cabf0];if(_0x294350==='*')break;if(_0x294350['startsWith'](':')){let _0x36327e=_0x294350['slice'](0x1);_0x36327e&&(_0x3cca31[_0x36327e]=te(_0x4cc49b)),_0x1406c5++,_0x3cabf0++;continue;}if(_0x294350!==_0x4cc49b)return{};_0x1406c5++,_0x3cabf0++;}return _0x1406c5===_0x1614ec['length']||_0x1406c5===_0x1614ec['length']-0x1&&_0x1614ec[_0x1406c5]==='*',_0x3cca31;}async function Oe(_0x78d291,_0x1bb00c,_0x3e55e1,_0x18c2ac,_0x38ba4d=void 0x0,_0x3e9b8a){let _0x36e4db=await _0x1bb00c['text'](),_0x53912f=J(_0x36e4db),_0x4062a5=B(_0x1bb00c['url']),_0x414d50={...F(_0x78d291),'user':_0x38ba4d},_0x45bc32=H(_0x414d50),_0x4a7f53=_0x3e9b8a?re(_0x3e9b8a,_0x1bb00c['path']):{};return{'app':O(_0x78d291),'permissions':T(_0x78d291),'user':_0x38ba4d,'metadata':_0x45bc32,'body':_0x53912f,'query':_0x4062a5,'params':_0x4a7f53,'method':_0x3e55e1,'pathname':_0x18c2ac,'requestUrl':_0x1bb00c['url'],'headers':Object['fromEntries'](_0x1bb00c['raw']['headers']['entries']())};}function Te(_0x343f36){return{'method':_0x343f36['method'],'pathname':_0x343f36['pathname'],'ctx':_0x343f36};}function Fe(_0x32c508,_0xede7bf){let {status:_0x134c21=0xc8,headers:_0xf9e35={},body:_0x529e3d,type:_0x2c594e}=_0x32c508??{};return _0x2c594e==='raw'?new globalThis['Response'](String(_0x529e3d??''),{'status':_0x134c21,'headers':_0xf9e35}):_0xede7bf(_0x529e3d,_0x134c21);}function Ne(_0x27de65,_0x1ae1f9=null){return N(_0x27de65,{'appInfo':_0x1ae1f9});}var V=f;async function Ve(_0x4f3d99){_0x4f3d99?(await U(_0x4f3d99),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x4f3d99)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x5f2af6,_0x124680){let _0x4394b1=Object['fromEntries'](Object['entries'](_0x5f2af6['headers']||{})['map'](([_0x16782a,_0x23b931])=>[_0x16782a['toLowerCase'](),_0x23b931]));return{'id':_0x5f2af6['app']['id']||_0x124680['appId']||'','name':_0x5f2af6['app']['name']||'','version':_0x5f2af6['app']['version']||'','description':_0x5f2af6['app']['description']||'','metadata':{..._0x5f2af6['metadata'],'permissions':_0x5f2af6['permissions']},'body':_0x5f2af6['body'],'query':_0x5f2af6['query'],'params':_0x5f2af6?.['params'],'method':_0x5f2af6['method'],'pathname':_0x5f2af6['pathname'],'requestUrl':_0x5f2af6['requestUrl'],'user':_0x5f2af6['user'],'headers':_0x4394b1};}var L=class{constructor(_0xff2899){this['handle']=null,(this['config']=_0xff2899,this['logger']=_0xff2899['logger']||f,this['lifecycle']=W({'appsDir':_0xff2899['appsDir'],'timeout':_0xff2899['timeout'],'platformImports':_0xff2899['platformImports'],'libDir':_0xff2899['libDir']},{'onCreate':_0x133ab5=>this['logger']['info']('Worker\x20created',{'appId':_0x133ab5['appId']}),'onReady':_0x469d37=>{this['lifecycle']['updateStatus'](_0x469d37['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x469d37['appId']});},'onCrash':_0x34dc35=>this['logger']['error']('Worker\x20crashed',{'appId':_0x34dc35['appId']}),'onStop':_0x4fe16d=>this['logger']['info']('Worker\x20stopped',{'appId':_0x4fe16d['appId']})}),this['messaging']=$({'onReady':_0x492468=>this['lifecycle']['updateStatus'](_0x492468,'running'),'onLog':(_0x1aecc1,_0x3a5234,_0x3948a6,_0x3c5f7a)=>{(this['logger'][_0x3a5234]||this['logger']['info'])['call'](this['logger'],_0x3948a6,_0x3c5f7a);},'onResult':()=>{}},_0xff2899['timeout']||0x1d4c0));}async['create'](_0x707cdb){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x3f3fd5=await this['lifecycle']['create'](this['config']['appId'],_0x707cdb,this['config']['scriptUrl']);this['messaging']['setup'](_0x3f3fd5),this['messaging']['sendInit'](_0x3f3fd5,this['config']['appsDir'],_0x707cdb,this['config']['serverPath']),this['handle']=_0x3f3fd5,await this['waitForReady']();}async['waitForReady'](_0x5bcd96=0x2710){let _0x3173d1=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x3173d1>_0x5bcd96)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x2fc4ac=>setTimeout(_0x2fc4ac,0x64));}}async['invoke'](_0x463615){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x463615);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x86549d){return new L(_0x86549d);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};