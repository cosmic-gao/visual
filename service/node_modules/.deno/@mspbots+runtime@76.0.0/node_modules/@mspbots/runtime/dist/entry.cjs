'use strict';function c(_0x1087d0,_0x5e8456){let _0x3351b0=Object['fromEntries'](Object['entries'](_0x1087d0['headers']||{})['map'](([_0x2a849c,_0xadf9a5])=>[_0x2a849c['toLowerCase'](),_0xadf9a5]));return{'id':_0x1087d0['app']['id']||_0x5e8456['appId']||'','name':_0x1087d0['app']['name']||'','version':_0x1087d0['app']['version']||'','description':_0x1087d0['app']['description']||'','metadata':{..._0x1087d0['metadata'],'permissions':_0x1087d0['permissions']},'body':_0x1087d0['body'],'query':_0x1087d0['query'],'params':_0x1087d0?.['params'],'method':_0x1087d0['method'],'pathname':_0x1087d0['pathname'],'requestUrl':_0x1087d0['requestUrl'],'user':_0x1087d0['user'],'headers':_0x3351b0};}function f(_0x4170a3){return _0x4170a3['split']('/')['filter'](_0x469fc0=>_0x469fc0['length']>0x0);}function P(_0x4ba9d7,_0x3cccd5){let _0x1eed94=f(_0x4ba9d7),_0x3d2dd6=f(_0x3cccd5),_0x3c9b69=0x0,_0x28c631=0x0;for(;_0x3c9b69<_0x1eed94['length']&&_0x28c631<_0x3d2dd6['length'];){let _0x2d0ec5=_0x1eed94[_0x3c9b69],_0x416f55=_0x3d2dd6[_0x28c631];if(_0x2d0ec5==='*')return!![];if(_0x2d0ec5['startsWith'](':')){_0x3c9b69++,_0x28c631++;continue;}if(_0x2d0ec5!==_0x416f55)return![];_0x3c9b69++,_0x28c631++;}return _0x3c9b69===_0x1eed94['length']&&_0x28c631===_0x3d2dd6['length']||_0x3c9b69===_0x1eed94['length']-0x1&&_0x1eed94[_0x3c9b69]==='*';}function m(_0x221147,_0x4db130,_0x1d0251){let _0xdb8145=_0x4db130+'\x20'+_0x1d0251;if(_0x221147[_0xdb8145])return{'handler':_0x221147[_0xdb8145],'routePattern':_0x1d0251};let _0x473300=[];_0x1d0251['startsWith']('/api')?_0x473300['push'](_0x1d0251['substring'](0x4)||'/'):_0x473300['push']('/api'+_0x1d0251),_0x473300['push'](_0x1d0251);for(let _0x814c5e of _0x473300)for(let _0x537e84 of Object['keys'](_0x221147)){if(!_0x537e84['startsWith'](_0x4db130+'\x20'))continue;let _0x2c258f=_0x537e84['substring'](_0x4db130['length']+0x1);if(P(_0x2c258f,_0x814c5e))return{'handler':_0x221147[_0x537e84],'routePattern':_0x2c258f};}return null;}function k(_0x228abe){return typeof _0x228abe=='function'?{'handler':_0x228abe,'routePattern':''}:_0x228abe;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x5be3bd){let _0x4ea0cb=async _0x44866d=>{try{let _0x1d1049=globalThis['Deno'];if(!_0x1d1049)throw new Error('Deno is not available');return await _0x1d1049['stat'](_0x44866d),!0x0;}catch{return![];}};if(_0x5be3bd&&typeof _0x5be3bd=='string'&&_0x5be3bd['length']>0x0)return _0x5be3bd;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x4679cf=s['manifest']?.['metadata']?.['serverPath'];if(_0x4679cf&&typeof _0x4679cf=='string'&&_0x4679cf['length']>0x0)return _0x4679cf;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x5b3943=s['manifest']['name'];if(!_0x5b3943)throw new Error('Manifest\x20name\x20not\x20found');let _0x17036a=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x5b3943+'/server.js',s['appsDir']+'/'+_0x5b3943+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x18b62f of _0x17036a)if(await _0x4ea0cb(_0x18b62f))return _0x18b62f;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x17036a['join'](',\x20'));}function R(){let _0x2f9af0=['log','info','warn','error','debug','trace'];for(let _0x54138e of _0x2f9af0){let _0x519a5c=(console[_0x54138e]||console['log'])['bind'](console);console[_0x54138e]=(..._0x14ab44)=>{try{let _0x37e75e=_0x14ab44['map'](_0x158fa8=>{if(typeof _0x158fa8=='string')return _0x158fa8;if(_0x158fa8 instanceof Error)return JSON['stringify']({'name':_0x158fa8['name'],'message':_0x158fa8['message'],'stack':_0x158fa8['stack']});if(typeof Request<'u'&&_0x158fa8 instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x158fa8['url'],'method':_0x158fa8['method'],'headers':Object['fromEntries'](_0x158fa8['headers']['entries']()),'bodyUsed':_0x158fa8['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x158fa8 instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x158fa8['status'],'headers':Object['fromEntries'](_0x158fa8['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x158fa8);}catch{return String(_0x158fa8);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x54138e==='log'?'info':_0x54138e,'message':_0x37e75e,'meta':{'appId':s['appId']}});}catch{_0x519a5c(..._0x14ab44);}};}}R();async function v(_0x400a29){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x48393c=(await w(_0x400a29))['replace'](/\\/g,'/'),_0x37dd1f=(_0x48393c['startsWith']('file://')?_0x48393c:'file://'+_0x48393c)+'?t='+Date['now']();try{let _0x5878f9=await import(_0x37dd1f);return s['module']=_0x5878f9,_0x5878f9;}catch(_0x69450d){throw console['error']('Failed to load module:',_0x69450d),_0x69450d;}}function b(_0x3bb759){return _0x3bb759 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x3bb759,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x4317ab){return _0x4317ab['split']('/')['filter'](_0x2df841=>_0x2df841['length']>0x0);}function E(_0x18cab9){try{return decodeURIComponent(_0x18cab9);}catch{return _0x18cab9;}}function I(_0x5f1a23,_0x1f750f){let _0x260aeb=g(_0x5f1a23),_0xe4d262=g(_0x1f750f),_0x51f558={},_0x99c58c=0x0,_0x1557a9=0x0;for(;_0x99c58c<_0x260aeb['length']&&_0x1557a9<_0xe4d262['length'];){let _0x1de536=_0x260aeb[_0x99c58c],_0x30ef34=_0xe4d262[_0x1557a9];if(_0x1de536==='*')break;if(_0x1de536['startsWith'](':')){let _0x1ed009=_0x1de536['slice'](0x1);_0x1ed009&&(_0x51f558[_0x1ed009]=E(_0x30ef34)),_0x99c58c++,_0x1557a9++;continue;}if(_0x1de536!==_0x30ef34)return{};_0x99c58c++,_0x1557a9++;}return _0x99c58c===_0x260aeb['length']||_0x99c58c===_0x260aeb['length']-0x1&&_0x260aeb[_0x99c58c]==='*',_0x51f558;}function M(_0xe1d279,_0x4cc73a){return _0xe1d279['startsWith']('/api')&&!_0x4cc73a['startsWith']('/api')?_0xe1d279['substring'](0x4)||'/':!_0xe1d279['startsWith']('/api')&&_0x4cc73a['startsWith']('/api')?'/api'+(_0xe1d279['startsWith']('/')?'':'/')+_0xe1d279:_0xe1d279;}async function W(_0x2b72f4){let _0x2adf21=_0x2b72f4['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x2adf21)&&await v(_0x2adf21);let _0x319589=_0x2b72f4['ctx'],{method:_0x5ab78f,pathname:_0x2ded6d}=_0x319589,_0x2cc948=s['module']?.['default']||{},_0x24d5a7=m(_0x2cc948,_0x5ab78f,_0x2ded6d);if(!_0x24d5a7)throw Object['assign'](new Error('Route\x20'+_0x5ab78f+'\x20'+_0x2ded6d+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x4d9565=k(_0x24d5a7),_0x2ad27e=c(_0x319589,s),_0x4ad862=_0x2ded6d,_0x3663bd=M(_0x4d9565['routePattern'],_0x4ad862),_0x488288=_0x3663bd?I(_0x3663bd,_0x4ad862):{},_0x1e8be8=await _0x4d9565['handler']({..._0x2ad27e,'params':{..._0x2ad27e['params'],..._0x488288}});return b(_0x1e8be8);}function D(_0x123301){s['appId']=_0x123301['appId'],s['manifest']=_0x123301['manifest'],s['appsDir']=_0x123301['appsDir'],s['serverPath']=_0x123301['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x3831a0){let {reqId:_0x4c3efb,payload:_0xf1a97}=_0x3831a0;try{let _0x570368=await W(_0xf1a97);self['postMessage']({'type':'result','reqId':_0x4c3efb,'ok':!0x0,'response':_0x570368});}catch(_0x2a97fe){let _0xf5d01c=_0x2a97fe;self['postMessage']({'type':'result','reqId':_0x4c3efb,'ok':![],'error':{'message':_0xf5d01c['message'],'stack':_0xf5d01c['stack'],'code':_0xf5d01c['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x3bbff=>{let _0x4cf4e9=_0x3bbff['data'];try{switch(_0x4cf4e9['type']){case'init':D(_0x4cf4e9);break;case'invoke':await $(_0x4cf4e9);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x4cf4e9['type']);break;}}catch(_0x465e4d){let _0x23aff3=_0x465e4d;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x23aff3['message'],'stack':_0x23aff3['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x23aff3);}}},self['onerror']=_0x241382=>{let _0x2aed93={'message':typeof _0x241382=='string'?_0x241382:_0x241382['message'],'filename':typeof _0x241382=='string'?void 0x0:_0x241382['filename'],'lineno':typeof _0x241382=='string'?void 0x0:_0x241382['lineno'],'colno':typeof _0x241382=='string'?void 0x0:_0x241382['colno'],'error':typeof _0x241382=='string'?void 0x0:_0x241382['error']?.['message'],'stack':typeof _0x241382=='string'?void 0x0:_0x241382['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x2aed93);},self['onunhandledrejection']=_0x59516c=>{let _0x4fc0b0=_0x59516c['reason'],_0x3ab070={'appId':s['appId'],'reason':_0x4fc0b0 instanceof Error?_0x4fc0b0['message']:String(_0x4fc0b0),'stack':_0x4fc0b0 instanceof Error?_0x4fc0b0['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x3ab070);};