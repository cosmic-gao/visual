'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x2fcd6f){return _0x2fcd6f&&_0x2fcd6f['__esModule']?_0x2fcd6f:{'default':_0x2fcd6f};}var Y__default=_interopDefault(Y);async function ie(_0x5e9181){try{return await promises['stat'](_0x5e9181),!0x0;}catch{return![];}}var f={'error':(_0x3ce23b,_0x30b99a)=>console['error']('[ERROR]\x20'+_0x3ce23b,_0x30b99a),'warn':(_0x2aa0a6,_0x4cbc0d)=>console['warn']('[WARN]\x20'+_0x2aa0a6,_0x4cbc0d),'info':(_0x34c50f,_0x49f05b)=>console['log']('[INFO]\x20'+_0x34c50f,_0x49f05b),'debug':(_0x5f1c3b,_0xfca25f)=>console['log']('[DEBUG]\x20'+_0x5f1c3b,_0xfca25f)};function z(){let _0x38cfa0=globalThis['Deno'];if(!_0x38cfa0)throw new Error('Deno is not available');return _0x38cfa0;}var D=class{constructor(_0x1fccd2,_0x52f5fe='./lib',_0x33c7bf={}){this['manifest']=_0x1fccd2,this['libDir']=_0x52f5fe,this['platformImports']=_0x33c7bf;}['buildPerms'](){let _0x19c909=this['manifest']['permissions']||{},_0x1a60d9={};return _0x19c909['net']!==void 0x0&&(_0x1a60d9['net']=_0x19c909['net']===!![]?!![]:Array['isArray'](_0x19c909['net'])?_0x19c909['net']:[]),_0x19c909['read']!==void 0x0&&(_0x1a60d9['read']=_0x19c909['read']===!![]?!![]:Array['isArray'](_0x19c909['read'])?_0x19c909['read']:[]),_0x19c909['write']!==void 0x0&&(_0x1a60d9['write']=_0x19c909['write']===!![]?!![]:Array['isArray'](_0x19c909['write'])?_0x19c909['write']:[]),_0x19c909['env']!==void 0x0&&(_0x1a60d9['env']=_0x19c909['env']===!![]?!![]:Array['isArray'](_0x19c909['env'])?_0x19c909['env']:[]),_0x19c909['run']!==void 0x0&&(_0x1a60d9['run']=_0x19c909['run']===!![]?!![]:Array['isArray'](_0x19c909['run'])?_0x19c909['run']:[]),_0x19c909['ffi']!==void 0x0&&(_0x1a60d9['ffi']=_0x19c909['ffi']===!![]?!![]:Array['isArray'](_0x19c909['ffi'])?_0x19c909['ffi']:[]),_0x19c909['sys']!==void 0x0&&(_0x1a60d9['sys']=_0x19c909['sys']===!![]?!![]:Array['isArray'](_0x19c909['sys'])?_0x19c909['sys']:[]),_0x19c909['hrtime']!==void 0x0&&(_0x1a60d9['hrtime']=_0x19c909['hrtime']),_0x1a60d9;}['normalize'](_0x1f6716){return _0x1f6716===!![]?[]:Array['isArray'](_0x1f6716)?_0x1f6716:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x314b0c){return path.join(this['libDir'],_0x314b0c+'@*');}['getReadPaths'](){let _0x1c9e05=this['getImports']();_0x1c9e05['includes']('*')&&(_0x1c9e05=Object['keys'](this['platformImports']));let _0x6b2759=[];console['log']('[Permissions] Building package path patterns for imports:',_0x1c9e05);for(let _0x58c3e3 of _0x1c9e05){let _0x250d71=this['getLibPattern'](_0x58c3e3);_0x6b2759['push'](_0x250d71),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x58c3e3+'\x20->\x20'+_0x250d71);}return console['log']('[Permissions] Final package path patterns:',_0x6b2759),_0x6b2759;}['buildImportMap'](_0x3343a6){let _0xabffa3=this['getImports'](),_0x4185a5=_0xabffa3['includes']('*')?Object['keys'](_0x3343a6):_0xabffa3;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x4185a5);let _0x4fa398={};for(let _0x5e3709 of _0x4185a5)if(_0x3343a6[_0x5e3709])_0x4fa398[_0x5e3709]=_0x3343a6[_0x5e3709],console['log']('[ImportMap]\x20'+_0x5e3709+'\x20->\x20'+_0x3343a6[_0x5e3709]+'\x20(from\x20platform)');else try{let _0x413646=z(),_0x2afc2b=path.join(_0x413646['cwd'](),this['libDir']),_0x4f838a=!0x1;try{for(let _0x18c908 of _0x413646['readDirSync'](_0x2afc2b))if(_0x18c908['isDirectory']&&(_0x18c908['name']===_0x5e3709||_0x18c908['name']['startsWith'](_0x5e3709+'@'))){let _0x2f9d42=path.join(_0x413646['cwd'](),this['libDir'],_0x18c908['name'],'index.js')['replace'](/\\/g,'/'),_0x219a4f=new URL('file:///'+_0x2f9d42)['href'];_0x4fa398[_0x5e3709]=_0x219a4f,console['log']('[ImportMap]\x20'+_0x5e3709+'\x20->\x20'+_0x219a4f+'\x20(from\x20lib)'),_0x4f838a=!0x0;break;}}catch{}_0x4f838a||console['warn']('[ImportMap]\x20Package\x20'+_0x5e3709+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x50ec87){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x5e3709+':',_0x50ec87);}return _0x4fa398;}['validateServerImports'](_0x237321){let _0x31f296=this['manifest']['name']||this['manifest']['id'],_0x58a0ff=this['manifest']['metadata']?.['serverPath'],_0x935cb5=_0xfc80cb=>_0xfc80cb['replace'](/\\/g,'/'),_0x130f98=z(),_0x3ed01c=_0x3f73fa=>{try{return _0x130f98['statSync'](_0x3f73fa),!0x0;}catch{return![];}},_0x1a8036=_0x58a0ff?_0x935cb5(_0x58a0ff):void 0x0;if(!_0x1a8036){let _0x5916d2=[_0x237321+'/service/server.js',_0x237321+'/service/server.ts',_0x237321+'/'+_0x31f296+'/server.js',_0x237321+'/'+_0x31f296+'/server.ts',_0x237321+'/server.js',_0x237321+'/server.ts']['map'](_0x935cb5);for(let _0xc9ff of _0x5916d2)if(_0x3ed01c(_0xc9ff)){_0x1a8036=_0xc9ff;break;}}if(!_0x1a8036)return{'valid':![],'violations':['Failed to locate server module']};let _0x5dde58='';try{_0x5dde58=_0x130f98['readTextFileSync'](_0x1a8036);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x1a8036};}let _0x16711d=this['getImports']();if(_0x16711d['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x1a8036};let _0xb71ee2=_0x16711d,_0x536e88=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x3877c8=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x33226c=/\bimport\s*['"]([^'"]+)['"]/g,_0x521efe=[],_0x31f8f2=new Set(),_0x3d2648=_0x2ead6a=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x2ead6a),_0xb0c5f0=_0x2ffbf2=>{let _0x29c90d=_0x2ffbf2;if(_0x29c90d['startsWith']('./')||_0x29c90d['startsWith']('../')||_0x29c90d['startsWith']('/')||_0x29c90d['startsWith']('file://')||!_0x3d2648(_0x2ffbf2)||_0x31f8f2['has'](_0x2ffbf2))return;_0x31f8f2['add'](_0x2ffbf2),_0x29c90d['startsWith']('npm:')&&(_0x29c90d=_0x29c90d['substring'](0x4)),_0x29c90d['includes']('@')&&!_0x29c90d['startsWith']('@')&&(_0x29c90d=_0x29c90d['split']('@')[0x0]);let _0x9402fb=_0x29c90d['split']('/')[0x0];_0xb71ee2['includes'](_0x9402fb)||_0xb71ee2['includes'](_0x2ffbf2)||_0x521efe['push'](_0x2ffbf2);},_0xcb23fc;for(;(_0xcb23fc=_0x536e88['exec'](_0x5dde58))!==null;)_0xb0c5f0(_0xcb23fc[0x1]);for(;(_0xcb23fc=_0x3877c8['exec'](_0x5dde58))!==null;)_0xb0c5f0(_0xcb23fc[0x1]);for(;(_0xcb23fc=_0x33226c['exec'](_0x5dde58))!==null;)_0xb0c5f0(_0xcb23fc[0x1]);return{'valid':_0x521efe['length']===0x0,'violations':_0x521efe,'serverPath':_0x1a8036};}['validate'](_0x5117c0={}){let _0x280724=[],_0x265180=this['manifest']['permissions']||{};try{let _0x2021c5=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x2021c5);}catch{}let _0x364160=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x1673dc,_0x2364aa]of Object['entries'](_0x265180))if(_0x1673dc==='hrtime')typeof _0x2364aa!='boolean'&&_0x280724['push']('Permission\x20\x27'+_0x1673dc+'\x27\x20must\x20be\x20boolean');else{if(_0x1673dc==='langchain')typeof _0x2364aa!='boolean'&&(typeof _0x2364aa!='object'||_0x2364aa===null)?_0x280724['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x2364aa=='object'&&(_0x2364aa===null||!('enabled'in _0x2364aa)||typeof _0x2364aa['enabled']!='boolean')&&_0x280724['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x1673dc==='kv')typeof _0x2364aa!='boolean'&&_0x280724['push']('Permission\x20\x27'+_0x1673dc+'\x27\x20must\x20be\x20boolean');else{if(_0x1673dc==='mspbots')Array['isArray'](_0x2364aa)||_0x280724['push']('Permission\x20\x27'+_0x1673dc+'\x27\x20must\x20be\x20an\x20array');else{if(_0x1673dc==='db'){if(typeof _0x2364aa!='object'||_0x2364aa===null||Array['isArray'](_0x2364aa))_0x280724['push']('Permission\x20\x27'+_0x1673dc+'\x27\x20must\x20be\x20an\x20object');else{let _0x3066c7=_0x2364aa,_0x498434=['user','password']['filter'](_0x426347=>!(_0x426347 in _0x3066c7));_0x498434['length']>0x0&&_0x280724['push']('Permission\x20\x27'+_0x1673dc+'\x27\x20missing\x20required\x20fields:\x20'+_0x498434['join'](',\x20'));}}else{if(_0x1673dc==='imports')continue;_0x364160['has'](_0x1673dc)||typeof _0x2364aa!='boolean'&&!Array['isArray'](_0x2364aa)&&_0x280724['push']('Permission\x20\x27'+_0x1673dc+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x5bc299=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x5bc299))_0x280724['push']('permissions.imports must be an array');else{for(let _0x3a4acf of _0x5bc299)typeof _0x3a4acf!='string'&&_0x280724['push']('import\x20\x27'+_0x3a4acf+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x280724['length']===0x0,'errors':_0x280724};}};function q(_0x3a8324,_0x52bddf,_0x28dda4){return new D(_0x3a8324,_0x52bddf,_0x28dda4||{});}var R=null;function I(){let _0x4f4998=globalThis['Deno'];if(!_0x4f4998)throw new Error('Deno is not available');return _0x4f4998;}async function K(){if(R)return{...R};try{let _0x47ee58=I(),_0xa52f25=path.join(_0x47ee58['cwd'](),'deno.json'),_0x287eac=await _0x47ee58['readTextFile'](_0xa52f25);return R=JSON['parse'](_0x287eac)['imports']||{},{...R};}catch(_0x138172){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x138172),{};}}var E=class{constructor(_0x2a1f3a,_0x52e3fd={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x2a1f3a['appsDir'],this['platformImportsOverride']=_0x2a1f3a['platformImports'],this['libDir']=_0x2a1f3a['libDir'],this['events']=_0x52e3fd);}async['create'](_0x250653,_0x4d20b9,_0x17a230){try{return await this['createWorker'](_0x250653,_0x4d20b9,_0x17a230);}catch(_0x26c0eb){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x250653+':',_0x26c0eb),_0x26c0eb;}}async['createWorker'](_0x3be2cb,_0x4036ee,_0x53388b){let _0x3e95c5=this['platformImportsOverride']||await K(),_0x800c51=q(_0x4036ee,this['libDir'],_0x3e95c5)['validateServerImports'](this['appsDir']);if(!_0x800c51['valid']){let _0x34c224=_0x800c51['violations']['filter'](_0x2da034=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x2da034)),_0x4f7e9f=_0x800c51['serverPath']?_0x800c51['serverPath']:(_0x4036ee['name']||_0x4036ee['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x4f7e9f+':\x20'+_0x34c224['join'](',\x20'));}let _0x14d45d=q(_0x4036ee,this['libDir'],_0x3e95c5),_0x3de715=_0x14d45d['validate'](_0x3e95c5);if(!_0x3de715['valid'])throw new Error('Invalid\x20config:\x20'+_0x3de715['errors']['join'](',\x20'));let _0xf9a9ba=_0x14d45d['buildImportMap'](_0x3e95c5);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x3be2cb+':',_0xf9a9ba);let _0x584856=_0x14d45d['buildPerms'](),_0x2a48b0=_0x14d45d['getReadPaths']();if(_0x584856['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x584856['read']);else{let _0x33769a=_0x4036ee['name']||_0x3be2cb,_0x703488=this['appsDir']+'/'+_0x33769a,_0xa1c190=[_0x703488],_0xc2cf07=_0x4036ee['metadata']?.['serverPath'];if(_0xc2cf07&&typeof _0xc2cf07=='string')try{let _0x422352=path.dirname(_0xc2cf07)['replace'](/\\/g,'/');_0xa1c190['push'](_0x422352);}catch{}_0x584856['read']=_0xa1c190,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x703488);}if(_0x2a48b0['length']>0x0){if(_0x584856['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x52c34c=Array['isArray'](_0x584856['read'])?_0x584856['read']:[];_0x584856['read']=[..._0x52c34c,..._0x2a48b0],console['log']('[Worker] Added package read permissions:',_0x2a48b0);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x584856['net']||(_0x584856['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x3be2cb+':',_0x584856['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x584856['read']===!![]?'unrestricted':Array['isArray'](_0x584856['read'])?_0x584856['read']['length']:0x0));let _0xc41d85=await this['createImportMap'](_0x3be2cb,_0xf9a9ba),_0xe77428=await this['createLock'](_0x3be2cb,_0xf9a9ba),_0x3c18f1={'type':'module','deno':{'permissions':{}}};_0x3c18f1['deno']['namespace']=![],_0x3c18f1['deno']['permissions']=_0x584856,_0x3c18f1['deno']['importMap']=_0xc41d85,_0x3c18f1['deno']['lock']=_0xe77428,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x3be2cb+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0xc41d85),console['log']('\x20\x20-\x20Lockfile:\x20'+_0xe77428),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0xf9a9ba)['length']+'\x20('+(Object['keys'](_0xf9a9ba)['join'](',\x20')||'none')+')');let _0x15a38d={'worker':new Worker(_0x53388b,_0x3c18f1),'appId':_0x3be2cb,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x4036ee,'importMapPath':_0xc41d85,'lockfilePath':_0xe77428};return this['workers']['set'](_0x3be2cb,_0x15a38d),this['events']['onCreate']?.(_0x15a38d),_0x15a38d;}async['createLock'](_0x3c0a12,_0xa00118){let _0x5b8379=I(),_0x2a7a06=path.join(_0x5b8379['cwd'](),'storage','temp','lockfiles');await _0x5b8379['mkdir'](_0x2a7a06,{'recursive':!![]});let _0x26d360=_0x3c0a12+'-'+Date['now']()+'.lock',_0x11e746=path.join(_0x2a7a06,_0x26d360),_0x4b74bd={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0xcb432c,_0x29b11d]of Object['entries'](_0xa00118))if(_0x29b11d['startsWith']('npm:'))_0x29b11d['replace']('npm:',''),_0x4b74bd['packages']['specifiers'][_0xcb432c]=_0x29b11d;else _0x29b11d['startsWith']('file://')&&(_0x4b74bd['packages']['specifiers'][_0xcb432c]=_0x29b11d);let _0x58c90f=JSON['stringify'](_0x4b74bd,null,0x2);return await _0x5b8379['writeTextFile'](_0x11e746,_0x58c90f),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x11e746),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0xa00118)['length']+'):',Object['keys'](_0xa00118)),_0x11e746;}async['createImportMap'](_0x5d50bd,_0x6c5111){let _0xf18c31=I(),_0x52c129=path.join(_0xf18c31['cwd'](),'storage','temp','importmaps');await _0xf18c31['mkdir'](_0x52c129,{'recursive':!![]});let _0x5a8b9e=_0x5d50bd+'-'+Date['now']()+'.json',_0x30068d=path.join(_0x52c129,_0x5a8b9e),_0x1ba646=JSON['stringify']({'imports':_0x6c5111,'scopes':{}},null,0x2);return await _0xf18c31['writeTextFile'](_0x30068d,_0x1ba646),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x30068d),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x6c5111)['length']+'):',Object['keys'](_0x6c5111)['join'](',\x20')||'none'),_0x30068d;}['get'](_0x5836c6){return this['workers']['get'](_0x5836c6);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0xaac01a,_0x4292ce){let _0x1baac2=this['workers']['get'](_0xaac01a);if(!_0x1baac2)return;let _0x96788a=_0x1baac2['status'];_0x1baac2['status']=_0x4292ce,_0x4292ce==='running'&&_0x96788a==='starting'?this['events']['onReady']?.(_0x1baac2):_0x4292ce==='crashed'&&this['events']['onCrash']?.(_0x1baac2);}['touch'](_0x2172e8){let _0x20cf4d=this['workers']['get'](_0x2172e8);_0x20cf4d&&(_0x20cf4d['lastUsed']=Date['now']());}async['stop'](_0x461bf2){let _0x20ab77=this['workers']['get'](_0x461bf2);if(_0x20ab77)try{_0x20ab77['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x20ab77['worker']['terminate'](),_0x20ab77['status']='stopped',this['events']['onStop']?.(_0x20ab77),_0x20ab77['importMapPath']&&await this['cleanupImportMap'](_0x20ab77['importMapPath']),_0x20ab77['lockfilePath']&&await this['cleanupLock'](_0x20ab77['lockfilePath']);}catch(_0x50ea61){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x461bf2+':',_0x50ea61);}finally{this['workers']['delete'](_0x461bf2);}}async['cleanupImportMap'](_0x40dd9c){try{await I()['remove'](_0x40dd9c),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x40dd9c);}catch(_0x4948f0){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x40dd9c,_0x4948f0);}}async['cleanupLock'](_0xd05909){try{await I()['remove'](_0xd05909),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0xd05909);}catch(_0x1f0bf4){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0xd05909,_0x1f0bf4);}}async['stopAll'](){let _0xf02d1b=Array['from'](this['workers']['keys']());await Promise['all'](_0xf02d1b['map'](_0x5bd7b1=>this['stop'](_0x5bd7b1)));}async['restart'](_0x362591,_0x40c7ca){let _0x303206=this['workers']['get'](_0x362591);if(!_0x303206)throw new Error('Worker\x20'+_0x362591+'\x20not\x20found');let _0x2ea298=_0x303206['manifest'];return await this['stop'](_0x362591),await this['create'](_0x362591,_0x2ea298,_0x40c7ca);}['checkHealth'](_0x4cda5f){let _0x578c44=this['workers']['get'](_0x4cda5f);if(!_0x578c44)return{'healthy':![],'reason':'Not\x20found'};if(_0x578c44['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x578c44['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x3ee0c3=Date['now']()-_0x578c44['lastUsed'],_0x11b3e5=0x708*0x3e8;return _0x3ee0c3>_0x11b3e5?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x3ee0c3/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x159127=0x708*0x3e8,_0x51f2e7){let _0x5df44b=Date['now'](),_0x183c2d=[];for(let [_0x50caae,_0x148c41]of this['workers']['entries']()){let _0x3620cf=_0x5df44b-_0x148c41['lastUsed'];_0x3620cf>_0x159127&&_0x183c2d['push']({'appId':_0x50caae,'idle':_0x3620cf});}_0x183c2d['sort']((_0x492a78,_0x2b8e54)=>_0x2b8e54['idle']-_0x492a78['idle']);let _0x5cc9ce=_0x51f2e7?_0x183c2d['slice'](0x0,_0x51f2e7)['map'](_0x43e502=>_0x43e502['appId']):_0x183c2d['map'](_0x3e6f0c=>_0x3e6f0c['appId']);for(let _0x49d3df of _0x5cc9ce)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x49d3df),await this['stop'](_0x49d3df);}['stats'](){let _0x6fe336={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x54bd4a=Date['now']();for(let _0x1143fd of this['workers']['values']())_0x6fe336['byStatus'][_0x1143fd['status']]++,_0x6fe336['workers']['push']({'appId':_0x1143fd['appId'],'status':_0x1143fd['status'],'version':_0x1143fd['version'],'lastUsed':_0x1143fd['lastUsed'],'idle':_0x54bd4a-_0x1143fd['lastUsed']});return _0x6fe336;}['startCleanup'](_0x52d235=0x12c*0x3e8,_0x5340b3){let _0x37c7ac=setInterval(()=>{this['cleanup'](_0x5340b3)['catch'](_0x41b225=>{console['error']('Cleanup\x20failed:',_0x41b225);});},_0x52d235);return()=>clearInterval(_0x37c7ac);}['delay'](_0x144d7c){return new Promise(_0x37ef27=>setTimeout(_0x37ef27,_0x144d7c));}};function W(_0x42f616,_0x2ab957){return new E(_0x42f616,_0x2ab957);}var v=f,j=class{constructor(_0x5c215c,_0x1bfdd9=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x5c215c,this['timeout']=_0x1bfdd9);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x5a37d6){_0x5a37d6['worker']['onmessage']=_0x4140b1=>{let _0x2418ad=_0x4140b1['data'],{appId:_0x25a6d3}=_0x5a37d6;switch(_0x2418ad['type']){case'ready':this['events']['onReady'](_0x25a6d3),v['info']('Worker\x20ready',{'appId':_0x25a6d3,'version':_0x5a37d6['version']});break;case'log':{let {level:_0x326ecd='info',message:_0x88397d,meta:_0x18cd6c}=_0x2418ad,_0x4174c1={..._0x18cd6c||{},'appId':_0x25a6d3,'version':_0x5a37d6['version']};this['events']['onLog'](_0x25a6d3,_0x326ecd,_0x88397d,_0x4174c1);break;}case'result':{let {reqId:_0x464c3b,ok:_0x40e92d,response:_0x20de16,error:_0x4e54b7}=_0x2418ad,_0x9a1e7=this['pending']['get'](_0x464c3b);if(!_0x9a1e7){v['warn']('Unknown\x20request',{'appId':_0x25a6d3,'reqId':_0x464c3b});return;}if(this['pending']['delete'](_0x464c3b),_0x40e92d&&_0x20de16)_0x9a1e7['resolve'](_0x20de16);else{let _0x435a59=new Error(_0x4e54b7?.['message']||'Worker\x20error');_0x435a59['stack']=_0x4e54b7?.['stack'],_0x9a1e7['reject'](_0x435a59);}this['events']['onResult'](_0x25a6d3,_0x464c3b,_0x20de16||_0x4e54b7);break;}default:v['debug']('Unknown\x20message',{'appId':_0x25a6d3,'type':_0x2418ad['type']});}},_0x5a37d6['worker']['onerror']=_0x86eaf1=>{let {appId:_0x37985a}=_0x5a37d6;v['error']('Worker\x20error',{'appId':_0x37985a,'message':_0x86eaf1['message'],'lineno':_0x86eaf1['lineno'],'filename':_0x86eaf1['filename']}),_0x5a37d6['status']='crashed',this['rejectPending'](_0x37985a,new Error('Worker\x20'+_0x37985a+'\x20crashed:\x20'+_0x86eaf1['message'])),_0x86eaf1['preventDefault']();},_0x5a37d6['worker']['onmessageerror']=_0x3b663f=>{let {appId:_0xfc3745}=_0x5a37d6;v['error']('Message\x20error',{'appId':_0xfc3745,'data':_0x3b663f['data']}),_0x5a37d6['status']='crashed',_0x3b663f['preventDefault']();};}['sendInit'](_0x53baa3,_0x3a76ac,_0xea8d1,_0x66da79){_0x53baa3['worker']['postMessage']({'type':'init','appId':_0x53baa3['appId'],'manifest':_0xea8d1,'appsDir':_0x3a76ac,'serverPath':_0x66da79});}async['sendInvoke'](_0x2d1aa5,_0x18e47d){let _0x47f8da=this['nextId'](),_0x207ad9=_0x2d1aa5['appId'],_0x31f6e3=new Promise((_0x2f1bc1,_0x5d4d7d)=>{let _0x191e1d=setTimeout(()=>{this['pending']['delete'](_0x47f8da),_0x5d4d7d(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x47f8da,{'resolve':_0x2fe74d=>{clearTimeout(_0x191e1d),_0x2f1bc1(_0x2fe74d);},'reject':_0x55a872=>{clearTimeout(_0x191e1d),_0x5d4d7d(_0x55a872);},'timestamp':Date['now'](),'appId':_0x207ad9});});return _0x2d1aa5['worker']['postMessage']({'type':'invoke','appId':_0x2d1aa5['appId'],'reqId':_0x47f8da,'payload':_0x18e47d}),await _0x31f6e3;}['rejectPending'](_0x43ac00,_0x4893b8){let _0x2966b6=0x0;for(let [_0x49aeca,_0x528992]of this['pending']['entries']())_0x528992['appId']===_0x43ac00&&(this['pending']['delete'](_0x49aeca),_0x528992['reject'](_0x4893b8),_0x2966b6++);_0x2966b6>0x0&&v['warn']('Rejected\x20'+_0x2966b6+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x43ac00});}['cleanupTimeout'](){let _0x4b349d=Date['now']();for(let [_0x231b2a,_0x4e9831]of this['pending']['entries']())_0x4b349d-_0x4e9831['timestamp']>this['timeout']&&(this['pending']['delete'](_0x231b2a),_0x4e9831['reject'](new Error('Request\x20'+_0x231b2a+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x133aa6){let _0x2135ff=0x0;for(let _0x25724e of this['pending']['values']())_0x25724e['appId']===_0x133aa6&&_0x2135ff++;return _0x2135ff;}['startCleanup'](_0x4f1b25=0x2710){let _0x3ef6b0=setInterval(()=>{this['cleanupTimeout']();},_0x4f1b25);return()=>clearInterval(_0x3ef6b0);}};function $(_0x13b8a0,_0x3607d5){return new j(_0x13b8a0,_0x3607d5);}var Q=class{constructor(_0x28b1bc={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x28b1bc['logger']||f,this['config']={'appsDir':_0x28b1bc['appsDir']||this['getAppsDir'](),'scriptUrl':_0x28b1bc['scriptUrl']||this['getScriptUrl'](),'timeout':_0x28b1bc['timeout']||0x78*0x3e8,'autoCleanup':_0x28b1bc['autoCleanup']??!![],'cleanupInterval':_0x28b1bc['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x28b1bc['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x28b1bc['maxWorkers'],'reuseWorkers':_0x28b1bc['reuseWorkers']??!![],'workerReuseStrategy':_0x28b1bc['workerReuseStrategy']||'lru','enableQueue':_0x28b1bc['enableQueue']??!![],'maxQueueSize':_0x28b1bc['maxQueueSize']||0x64,'queueTimeout':_0x28b1bc['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x25e23c=>this['logger']['info']('Worker\x20created',{'appId':_0x25e23c['appId'],'v':_0x25e23c['version']}),'onReady':_0x269411=>this['lifecycle']['updateStatus'](_0x269411['appId'],'running'),'onCrash':_0x1538a6=>this['logger']['error']('Worker\x20crashed',{'appId':_0x1538a6['appId'],'v':_0x1538a6['version']}),'onStop':_0x565d11=>this['logger']['info']('Worker\x20stopped',{'appId':_0x565d11['appId'],'v':_0x565d11['version']})}),this['messaging']=$({'onReady':_0x267ef2=>this['lifecycle']['updateStatus'](_0x267ef2,'running'),'onLog':(_0x234abf,_0x5e6294,_0x1941bc,_0x3bf8cd)=>{let _0x5a4748={..._0x3bf8cd||{},'appId':_0x234abf};switch(_0x5e6294){case'error':this['logger']['error'](_0x1941bc,_0x5a4748);break;case'warn':this['logger']['warn'](_0x1941bc,_0x5a4748);break;case'debug':this['logger']['debug'](_0x1941bc,_0x5a4748);break;default:this['logger']['info'](_0x1941bc,_0x5a4748);break;}},'onResult':(_0xb872b2,_0x456d80,_0x314ca9)=>{this['logger']['debug']('Result\x20received',{'appId':_0xb872b2,'reqId':_0x456d80});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x583019=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x1945c2=_0x583019['endsWith']('.js')||_0x583019['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x1945c2,_0x583019)['href'];}async['ensure'](_0x3ea10e){let {id:_0x416de6}=_0x3ea10e,_0x546528=this['lifecycle']['get'](_0x416de6);if(_0x546528){let _0x48d44f=this['lifecycle']['checkHealth'](_0x416de6);if(_0x48d44f['healthy'])return this['lifecycle']['touch'](_0x416de6),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x416de6}),_0x546528;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x416de6,'reason':_0x48d44f['reason']}),await this['lifecycle']['stop'](_0x416de6);}for(;;){let _0x4eec6b=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x4eec6b>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x4eec6b,'max':this['config']['maxWorkers'],'appId':_0x416de6}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x3ea10e);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x5f17c8=await this['loadManifest'](_0x416de6,_0x3ea10e['manifest']),_0x482e3d=await this['lifecycle']['create'](_0x416de6,_0x5f17c8,this['config']['scriptUrl']),_0x25a9f0=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x25a9f0>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x25a9f0,'max':this['config']['maxWorkers'],'appId':_0x416de6}),await this['lifecycle']['stop'](_0x416de6),this['config']['enableQueue'])return await this['waitSlot'](_0x3ea10e);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x25a9f0+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x482e3d);let _0x380434=_0x5f17c8['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x482e3d,this['config']['appsDir'],_0x5f17c8,_0x380434),this['logger']['info']('Worker\x20created',{'appId':_0x416de6,'v':_0x482e3d['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x482e3d;}async['evictIdle'](){let _0x5b34e7=this['lifecycle']['getAll']();if(_0x5b34e7['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x18dccc=[..._0x5b34e7];this['config']['workerReuseStrategy']==='lru'?_0x18dccc['sort']((_0x488498,_0x350528)=>_0x488498['lastUsed']-_0x350528['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x18dccc['sort']((_0x15ebdf,_0x1d7845)=>_0x15ebdf['version']-_0x1d7845['version']);let _0x50d15e=null;for(let _0x4c65d7 of _0x18dccc)if(this['messaging']['getAppCount'](_0x4c65d7['appId'])===0x0){_0x50d15e=_0x4c65d7;break;}if(!_0x50d15e&&_0x18dccc['length']>0x0&&(_0x50d15e=_0x18dccc['reduce']((_0x31b360,_0x3b8c07)=>{let _0x49502d=this['messaging']['getAppCount'](_0x31b360['appId']);return this['messaging']['getAppCount'](_0x3b8c07['appId'])<_0x49502d?_0x3b8c07:_0x31b360;})),_0x50d15e){let _0x43aa67=this['messaging']['getAppCount'](_0x50d15e['appId']);return _0x43aa67>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x50d15e['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x50d15e['lastUsed'],'pendingRequests':_0x43aa67}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x50d15e['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x50d15e['lastUsed']}),await this['lifecycle']['stop'](_0x50d15e['appId']),!![];}return![];}['waitSlot'](_0x6a8ce0){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x3958b6,_0x2188e3)=>{let _0x538f21={'info':_0x6a8ce0,'resolve':_0x3958b6,'reject':_0x2188e3,'timestamp':Date['now']()};this['requestQueue']['push'](_0x538f21),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x6a8ce0['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x5bec8a=setTimeout(()=>{let _0x2a882e=this['requestQueue']['indexOf'](_0x538f21);_0x2a882e!==-0x1&&(this['requestQueue']['splice'](_0x2a882e,0x1),_0x2188e3(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x538f21['resolve']=_0x2c641b=>{clearTimeout(_0x5bec8a),_0x3958b6(_0x2c641b);},_0x538f21['reject']=_0x42d4a8=>{clearTimeout(_0x5bec8a),_0x2188e3(_0x42d4a8);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x5dff51=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x5dff51>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x2198f1=this['requestQueue']['shift']();if(!_0x2198f1)break;try{let _0x1c603e=await this['ensure'](_0x2198f1['info']);_0x2198f1['resolve'](_0x1c603e);}catch(_0x426cb7){_0x2198f1['reject'](_0x426cb7);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x12feb4,_0x4f8911){let _0x30af7e=this['config']['appsDir']['replace'](/\\/g,'/'),_0xc1bbd6=async _0xfd4d8e=>{try{let _0x34e53f=globalThis['Deno'];if(!_0x34e53f)return null;let _0x3b9bdf=await _0x34e53f['readTextFile'](_0xfd4d8e);return JSON['parse'](_0x3b9bdf);}catch{return null;}};if(_0x4f8911?.['name']){let _0x1fed44=await _0xc1bbd6(_0x30af7e+'/'+_0x4f8911['name']+'/manifest.json');if(_0x1fed44)return _0x1fed44;}let _0xcf54b1=await _0xc1bbd6(_0x30af7e+'/'+_0x12feb4+'/manifest.json');if(_0xcf54b1)return _0xcf54b1;try{let _0x2dfa73=globalThis['Deno'];if(_0x2dfa73)for await(let _0x4564de of _0x2dfa73['readDir'](_0x30af7e)){if(!_0x4564de['isDirectory'])continue;let _0x45fc94=_0x30af7e+'/'+_0x4564de['name']+'/manifest.json',_0xe51546=await _0xc1bbd6(_0x45fc94);if(_0xe51546&&(_0xe51546['id']===_0x12feb4||_0x4f8911?.['name']&&_0xe51546['name']===_0x4f8911['name']))return _0xe51546;}}catch(_0x1dce06){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x12feb4,'error':_0x1dce06['message']});}return _0x4f8911||{'id':_0x12feb4,'name':_0x12feb4,'version':'1.0.0'};}async['invoke'](_0xba6dfa){let _0x5e494d=_0xba6dfa['ctx']['app']['id'],_0x23b09b=_0xba6dfa['ctx']['app']['name'];try{let _0x51e32e={'id':_0x5e494d,'manifest':{'id':_0x5e494d,'name':_0x23b09b}},_0x79239e=await this['ensure'](_0x51e32e);if(_0x79239e['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x5e494d}),await this['restart'](_0x5e494d);let _0x1d3265=await this['ensure'](_0x51e32e);return this['lifecycle']['touch'](_0x5e494d),await this['messaging']['sendInvoke'](_0x1d3265,_0xba6dfa);}return this['lifecycle']['touch'](_0x5e494d),await this['messaging']['sendInvoke'](_0x79239e,_0xba6dfa);}catch(_0x550fac){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x5e494d,'error':_0x550fac['message'],'stack':_0x550fac['stack']}),_0x550fac;}}async['stop'](_0x3cbf24){await this['lifecycle']['stop'](_0x3cbf24),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x124fb5){return await this['lifecycle']['restart'](_0x124fb5,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x5a5fe2=>({'appId':_0x5a5fe2['appId'],'status':_0x5a5fe2['status'],'version':_0x5a5fe2['version'],'lastUsed':_0x5a5fe2['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x587b81=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x5b4329=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x587b81(),_0x5b4329();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x482103=>{_0x482103?(await this['stop'](_0x482103),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x482103})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x1f1d97){return new Q(_0x1f1d97);}var S=null;function be(_0x2bbba5){S=ee(_0x2bbba5);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x2dd15c){return await k()['ensure'](_0x2dd15c);}async function xe(_0x275bbf){return await k()['invoke'](_0x275bbf);}function Ie(_0x538433){k()['stop'](_0x538433)['catch'](_0x51bfe6=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x538433,'error':_0x51bfe6['message']});});}function Re(){k()['stopAll']()['catch'](_0x3c0e10=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x3c0e10['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x599718){await k()['stop'](_0x599718);}async function Se(){await k()['stopAll']();}function Ae(_0x3540ee){let _0x3e0b48=_0x3540ee&&typeof _0x3540ee=='object'?_0x3540ee:null;if(_0x3e0b48&&'user'in _0x3e0b48)return _0x3e0b48['user'];}function H(_0x1787b8){let _0x300556=_0x1787b8&&typeof _0x1787b8=='object'?_0x1787b8:null;if(!_0x300556)return{};let _0x39418d={};for(let [_0x512283,_0x37b04c]of Object['entries'](_0x300556))_0x512283!=='user'&&(_0x39418d[_0x512283]=_0x37b04c);return _0x39418d;}function O(_0x16a497){return _0x16a497?{'id':_0x16a497['manifest']?.['id']||_0x16a497['id']||'','name':_0x16a497['manifest']?.['name']||'','version':_0x16a497['manifest']?.['version']||'','description':_0x16a497['manifest']?.['description']||'','icon':_0x16a497['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x45e89b){return _0x45e89b?.['permissions']||_0x45e89b?.['manifest']?.['permissions']||{};}function F(_0x4c002d){return _0x4c002d?.['manifest']?.['metadata']||{};}function Ce(_0x6d2994){return _0x6d2994?{'appId':_0x6d2994['id'],'appName':_0x6d2994['manifest']?.['name']}:{};}function N(_0x4d4e10,_0x332f3a={}){let {appInfo:_0x6208e8=null,status:_0x58d90c=0x1f4,defaultMessage:_0x2b698c='Internal\x20Server\x20Error'}=_0x332f3a,_0x5a02a5={'error':_0x2b698c,'message':_0x4d4e10?.['message']||_0x2b698c};return _0x6208e8&&(_0x5a02a5['appId']=_0x6208e8['id'],_0x5a02a5['appName']=_0x6208e8['manifest']?.['name']),_0x4d4e10?.['message']?.['includes']('crashed')&&(_0x5a02a5['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x58d90c,'body':_0x5a02a5};}function qe(_0x30b195){return _0x30b195?.['message']?.['includes']('crashed')||![];}function J(_0xf2102d){if(_0xf2102d)try{return JSON['parse'](_0xf2102d);}catch{return _0xf2102d;}}function B(_0x43c353){try{let _0x1a0407=new URL(_0x43c353),_0x5c1a6d={};for(let _0x838dd6 of _0x1a0407['searchParams']['keys']()){let _0x33e92d=_0x1a0407['searchParams']['getAll'](_0x838dd6)['map'](_0x2d44a6=>_0x2d44a6);_0x33e92d['length']<=0x1?_0x5c1a6d[_0x838dd6]=_0x33e92d[0x0]??'':_0x5c1a6d[_0x838dd6]=_0x33e92d;}return _0x5c1a6d;}catch{return{};}}function Le(_0x3595ba){return(()=>{try{return new URL(_0x3595ba)['pathname'];}catch{return _0x3595ba;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x25138a,_0x1e325a){let _0x58e6ee=_0x25138a;if(_0x1e325a&&_0x58e6ee['startsWith']('/apps/'+_0x1e325a))_0x58e6ee=_0x58e6ee['substring'](('/apps/'+_0x1e325a)['length'])||'/';else{let _0x19c9f5=_0x58e6ee['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x19c9f5&&(_0x58e6ee=_0x19c9f5[0x1]||'/');}return _0x58e6ee['startsWith']('/api')&&(_0x58e6ee=_0x58e6ee['substring'](0x4)||'/'),_0x58e6ee;}function Ue(_0x382eb,_0x3e4c4d){let _0xcdee87=_0x382eb;if(_0x3e4c4d&&_0xcdee87['startsWith']('/apps/'+_0x3e4c4d))_0xcdee87=_0xcdee87['substring'](('/apps/'+_0x3e4c4d)['length'])||'/';else{let _0x2bea0a=_0xcdee87['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x2bea0a&&(_0xcdee87=_0x2bea0a[0x1]||'/');}return(!_0xcdee87||_0xcdee87==='/')&&(_0xcdee87='/index.html'),_0xcdee87;}async function He(_0x5722bf,_0x2bc3ea){return await _0x2bc3ea(_0x5722bf);}function _(_0x52adbe){return _0x52adbe['split']('/')['filter'](_0x55f3d9=>_0x55f3d9['length']>0x0);}function te(_0x219e85){try{return decodeURIComponent(_0x219e85);}catch{return _0x219e85;}}function re(_0x5166c2,_0x5165c9){let _0x32c4c5=_(_0x5166c2),_0x17ae8b=_(_0x5165c9),_0x2cb90f={},_0x4fb67d=0x0,_0x3122d8=0x0;for(;_0x4fb67d<_0x32c4c5['length']&&_0x3122d8<_0x17ae8b['length'];){let _0x43b868=_0x32c4c5[_0x4fb67d],_0xbd6d64=_0x17ae8b[_0x3122d8];if(_0x43b868==='*')break;if(_0x43b868['startsWith'](':')){let _0x1e6ad7=_0x43b868['slice'](0x1);_0x1e6ad7&&(_0x2cb90f[_0x1e6ad7]=te(_0xbd6d64)),_0x4fb67d++,_0x3122d8++;continue;}if(_0x43b868!==_0xbd6d64)return{};_0x4fb67d++,_0x3122d8++;}return _0x4fb67d===_0x32c4c5['length']||_0x4fb67d===_0x32c4c5['length']-0x1&&_0x32c4c5[_0x4fb67d]==='*',_0x2cb90f;}async function Oe(_0x29a624,_0x1097b8,_0x325817,_0x5e633b,_0x1ee3af=void 0x0,_0x32dd64){let _0x1f0867=await _0x1097b8['text'](),_0x244bdc=J(_0x1f0867),_0x4d03d2=B(_0x1097b8['url']),_0x2f7807={...F(_0x29a624),'user':_0x1ee3af},_0x2f249c=H(_0x2f7807),_0x14a1f9=_0x32dd64?re(_0x32dd64,_0x1097b8['path']):{};return{'app':O(_0x29a624),'permissions':T(_0x29a624),'user':_0x1ee3af,'metadata':_0x2f249c,'body':_0x244bdc,'query':_0x4d03d2,'params':_0x14a1f9,'method':_0x325817,'pathname':_0x5e633b,'requestUrl':_0x1097b8['url'],'headers':Object['fromEntries'](_0x1097b8['raw']['headers']['entries']())};}function Te(_0x245527){return{'method':_0x245527['method'],'pathname':_0x245527['pathname'],'ctx':_0x245527};}function Fe(_0x472703,_0x4edfdd){let {status:_0x346c65=0xc8,headers:_0x5f05d6={},body:_0x257660,type:_0x278758}=_0x472703??{};return _0x278758==='raw'?new globalThis['Response'](String(_0x257660??''),{'status':_0x346c65,'headers':_0x5f05d6}):_0x4edfdd(_0x257660,_0x346c65);}function Ne(_0x2bd93b,_0x4e1bcf=null){return N(_0x2bd93b,{'appInfo':_0x4e1bcf});}var V=f;async function Ve(_0x2c88a6){_0x2c88a6?(await U(_0x2c88a6),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x2c88a6)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x59c823,_0x46c2cf){let _0x371240=Object['fromEntries'](Object['entries'](_0x59c823['headers']||{})['map'](([_0x34f2c0,_0x129505])=>[_0x34f2c0['toLowerCase'](),_0x129505]));return{'id':_0x59c823['app']['id']||_0x46c2cf['appId']||'','name':_0x59c823['app']['name']||'','version':_0x59c823['app']['version']||'','description':_0x59c823['app']['description']||'','metadata':{..._0x59c823['metadata'],'permissions':_0x59c823['permissions']},'body':_0x59c823['body'],'query':_0x59c823['query'],'params':_0x59c823?.['params'],'method':_0x59c823['method'],'pathname':_0x59c823['pathname'],'requestUrl':_0x59c823['requestUrl'],'user':_0x59c823['user'],'headers':_0x371240};}var L=class{constructor(_0x4881b0){this['handle']=null,(this['config']=_0x4881b0,this['logger']=_0x4881b0['logger']||f,this['lifecycle']=W({'appsDir':_0x4881b0['appsDir'],'timeout':_0x4881b0['timeout'],'platformImports':_0x4881b0['platformImports'],'libDir':_0x4881b0['libDir']},{'onCreate':_0x41672c=>this['logger']['info']('Worker\x20created',{'appId':_0x41672c['appId']}),'onReady':_0x2cefff=>{this['lifecycle']['updateStatus'](_0x2cefff['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x2cefff['appId']});},'onCrash':_0x4d6725=>this['logger']['error']('Worker\x20crashed',{'appId':_0x4d6725['appId']}),'onStop':_0x3c81cb=>this['logger']['info']('Worker\x20stopped',{'appId':_0x3c81cb['appId']})}),this['messaging']=$({'onReady':_0x595a66=>this['lifecycle']['updateStatus'](_0x595a66,'running'),'onLog':(_0x1f835e,_0x40af67,_0x6894f2,_0xd6d674)=>{(this['logger'][_0x40af67]||this['logger']['info'])['call'](this['logger'],_0x6894f2,_0xd6d674);},'onResult':()=>{}},_0x4881b0['timeout']||0x1d4c0));}async['create'](_0x2db59f){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x39b385=await this['lifecycle']['create'](this['config']['appId'],_0x2db59f,this['config']['scriptUrl']);this['messaging']['setup'](_0x39b385),this['messaging']['sendInit'](_0x39b385,this['config']['appsDir'],_0x2db59f,this['config']['serverPath']),this['handle']=_0x39b385,await this['waitForReady']();}async['waitForReady'](_0x2ca793=0x2710){let _0x3ad063=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x3ad063>_0x2ca793)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x9957bf=>setTimeout(_0x9957bf,0x64));}}async['invoke'](_0x10d160){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x10d160);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x2cba87){return new L(_0x2cba87);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;