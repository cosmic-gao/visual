'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x116bc5){return _0x116bc5&&_0x116bc5['__esModule']?_0x116bc5:{'default':_0x116bc5};}var Y__default=_interopDefault(Y);async function ie(_0x4e7595){try{return await promises['stat'](_0x4e7595),!0x0;}catch{return![];}}var f={'error':(_0x51be43,_0x47c958)=>console['error']('[ERROR]\x20'+_0x51be43,_0x47c958),'warn':(_0x547d18,_0x353de6)=>console['warn']('[WARN]\x20'+_0x547d18,_0x353de6),'info':(_0x599b0d,_0x50afc1)=>console['log']('[INFO]\x20'+_0x599b0d,_0x50afc1),'debug':(_0x1eede3,_0x54a569)=>console['log']('[DEBUG]\x20'+_0x1eede3,_0x54a569)};function z(){let _0xf17a53=globalThis['Deno'];if(!_0xf17a53)throw new Error('Deno is not available');return _0xf17a53;}var D=class{constructor(_0x460334,_0x716df9='./lib',_0xbb6749={}){this['manifest']=_0x460334,this['libDir']=_0x716df9,this['platformImports']=_0xbb6749;}['buildPerms'](){let _0x1dcc7f=this['manifest']['permissions']||{},_0x548c50={};return _0x1dcc7f['net']!==void 0x0&&(_0x548c50['net']=_0x1dcc7f['net']===!![]?!![]:Array['isArray'](_0x1dcc7f['net'])?_0x1dcc7f['net']:[]),_0x1dcc7f['read']!==void 0x0&&(_0x548c50['read']=_0x1dcc7f['read']===!![]?!![]:Array['isArray'](_0x1dcc7f['read'])?_0x1dcc7f['read']:[]),_0x1dcc7f['write']!==void 0x0&&(_0x548c50['write']=_0x1dcc7f['write']===!![]?!![]:Array['isArray'](_0x1dcc7f['write'])?_0x1dcc7f['write']:[]),_0x1dcc7f['env']!==void 0x0&&(_0x548c50['env']=_0x1dcc7f['env']===!![]?!![]:Array['isArray'](_0x1dcc7f['env'])?_0x1dcc7f['env']:[]),_0x1dcc7f['run']!==void 0x0&&(_0x548c50['run']=_0x1dcc7f['run']===!![]?!![]:Array['isArray'](_0x1dcc7f['run'])?_0x1dcc7f['run']:[]),_0x1dcc7f['ffi']!==void 0x0&&(_0x548c50['ffi']=_0x1dcc7f['ffi']===!![]?!![]:Array['isArray'](_0x1dcc7f['ffi'])?_0x1dcc7f['ffi']:[]),_0x1dcc7f['sys']!==void 0x0&&(_0x548c50['sys']=_0x1dcc7f['sys']===!![]?!![]:Array['isArray'](_0x1dcc7f['sys'])?_0x1dcc7f['sys']:[]),_0x1dcc7f['hrtime']!==void 0x0&&(_0x548c50['hrtime']=_0x1dcc7f['hrtime']),_0x548c50;}['normalize'](_0x3abde1){return _0x3abde1===!![]?[]:Array['isArray'](_0x3abde1)?_0x3abde1:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x42d607){return path.join(this['libDir'],_0x42d607+'@*');}['getReadPaths'](){let _0x3bc0b0=this['getImports']();_0x3bc0b0['includes']('*')&&(_0x3bc0b0=Object['keys'](this['platformImports']));let _0x4e5fb1=[];console['log']('[Permissions] Building package path patterns for imports:',_0x3bc0b0);for(let _0x324ffd of _0x3bc0b0){let _0x1a066f=this['getLibPattern'](_0x324ffd);_0x4e5fb1['push'](_0x1a066f),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x324ffd+'\x20->\x20'+_0x1a066f);}return console['log']('[Permissions] Final package path patterns:',_0x4e5fb1),_0x4e5fb1;}['buildImportMap'](_0x399c46){let _0x38de1a=this['getImports'](),_0x3f1816=_0x38de1a['includes']('*')?Object['keys'](_0x399c46):_0x38de1a;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x3f1816);let _0x222a5c={};for(let _0x3ec181 of _0x3f1816)if(_0x399c46[_0x3ec181])_0x222a5c[_0x3ec181]=_0x399c46[_0x3ec181],console['log']('[ImportMap]\x20'+_0x3ec181+'\x20->\x20'+_0x399c46[_0x3ec181]+'\x20(from\x20platform)');else try{let _0x46b181=z(),_0x3433b0=path.join(_0x46b181['cwd'](),this['libDir']),_0xee96f=!0x1;try{for(let _0x40e0fc of _0x46b181['readDirSync'](_0x3433b0))if(_0x40e0fc['isDirectory']&&(_0x40e0fc['name']===_0x3ec181||_0x40e0fc['name']['startsWith'](_0x3ec181+'@'))){let _0x4b00d2=path.join(_0x46b181['cwd'](),this['libDir'],_0x40e0fc['name'],'index.js')['replace'](/\\/g,'/'),_0x1954c4=new URL('file:///'+_0x4b00d2)['href'];_0x222a5c[_0x3ec181]=_0x1954c4,console['log']('[ImportMap]\x20'+_0x3ec181+'\x20->\x20'+_0x1954c4+'\x20(from\x20lib)'),_0xee96f=!0x0;break;}}catch{}_0xee96f||console['warn']('[ImportMap]\x20Package\x20'+_0x3ec181+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x348c62){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x3ec181+':',_0x348c62);}return _0x222a5c;}['validateServerImports'](_0x475e84){let _0x48abdf=this['manifest']['name']||this['manifest']['id'],_0x37c259=this['manifest']['metadata']?.['serverPath'],_0x3b5271=_0x30964a=>_0x30964a['replace'](/\\/g,'/'),_0x51238f=z(),_0xe8b8b=_0x5749a8=>{try{return _0x51238f['statSync'](_0x5749a8),!0x0;}catch{return![];}},_0x1b42b6=_0x37c259?_0x3b5271(_0x37c259):void 0x0;if(!_0x1b42b6){let _0x416c4e=[_0x475e84+'/service/server.js',_0x475e84+'/service/server.ts',_0x475e84+'/'+_0x48abdf+'/server.js',_0x475e84+'/'+_0x48abdf+'/server.ts',_0x475e84+'/server.js',_0x475e84+'/server.ts']['map'](_0x3b5271);for(let _0x41a259 of _0x416c4e)if(_0xe8b8b(_0x41a259)){_0x1b42b6=_0x41a259;break;}}if(!_0x1b42b6)return{'valid':![],'violations':['Failed to locate server module']};let _0xbeacba='';try{_0xbeacba=_0x51238f['readTextFileSync'](_0x1b42b6);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x1b42b6};}let _0x5e1d43=this['getImports']();if(_0x5e1d43['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x1b42b6};let _0x3507d6=_0x5e1d43,_0x10de1f=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0xab279b=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x49b86c=/\bimport\s*['"]([^'"]+)['"]/g,_0x2b87f9=[],_0x235837=new Set(),_0x19adad=_0x3595db=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x3595db),_0x492d27=_0x46ce5f=>{let _0x101e20=_0x46ce5f;if(_0x101e20['startsWith']('./')||_0x101e20['startsWith']('../')||_0x101e20['startsWith']('/')||_0x101e20['startsWith']('file://')||!_0x19adad(_0x46ce5f)||_0x235837['has'](_0x46ce5f))return;_0x235837['add'](_0x46ce5f),_0x101e20['startsWith']('npm:')&&(_0x101e20=_0x101e20['substring'](0x4)),_0x101e20['includes']('@')&&!_0x101e20['startsWith']('@')&&(_0x101e20=_0x101e20['split']('@')[0x0]);let _0x1c886f=_0x101e20['split']('/')[0x0];_0x3507d6['includes'](_0x1c886f)||_0x3507d6['includes'](_0x46ce5f)||_0x2b87f9['push'](_0x46ce5f);},_0x7fa332;for(;(_0x7fa332=_0x10de1f['exec'](_0xbeacba))!==null;)_0x492d27(_0x7fa332[0x1]);for(;(_0x7fa332=_0xab279b['exec'](_0xbeacba))!==null;)_0x492d27(_0x7fa332[0x1]);for(;(_0x7fa332=_0x49b86c['exec'](_0xbeacba))!==null;)_0x492d27(_0x7fa332[0x1]);return{'valid':_0x2b87f9['length']===0x0,'violations':_0x2b87f9,'serverPath':_0x1b42b6};}['validate'](_0x8cdef8={}){let _0x16b69c=[],_0x1717e6=this['manifest']['permissions']||{};try{let _0x2f20a7=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x2f20a7);}catch{}let _0xae434e=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x49bb8e,_0x338621]of Object['entries'](_0x1717e6))if(_0x49bb8e==='hrtime')typeof _0x338621!='boolean'&&_0x16b69c['push']('Permission\x20\x27'+_0x49bb8e+'\x27\x20must\x20be\x20boolean');else{if(_0x49bb8e==='langchain')typeof _0x338621!='boolean'&&(typeof _0x338621!='object'||_0x338621===null)?_0x16b69c['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x338621=='object'&&(_0x338621===null||!('enabled'in _0x338621)||typeof _0x338621['enabled']!='boolean')&&_0x16b69c['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x49bb8e==='kv')typeof _0x338621!='boolean'&&_0x16b69c['push']('Permission\x20\x27'+_0x49bb8e+'\x27\x20must\x20be\x20boolean');else{if(_0x49bb8e==='mspbots')Array['isArray'](_0x338621)||_0x16b69c['push']('Permission\x20\x27'+_0x49bb8e+'\x27\x20must\x20be\x20an\x20array');else{if(_0x49bb8e==='db'){if(typeof _0x338621!='object'||_0x338621===null||Array['isArray'](_0x338621))_0x16b69c['push']('Permission\x20\x27'+_0x49bb8e+'\x27\x20must\x20be\x20an\x20object');else{let _0x3e8010=_0x338621,_0x42d649=['user','password']['filter'](_0x4bed70=>!(_0x4bed70 in _0x3e8010));_0x42d649['length']>0x0&&_0x16b69c['push']('Permission\x20\x27'+_0x49bb8e+'\x27\x20missing\x20required\x20fields:\x20'+_0x42d649['join'](',\x20'));}}else{if(_0x49bb8e==='imports')continue;_0xae434e['has'](_0x49bb8e)||typeof _0x338621!='boolean'&&!Array['isArray'](_0x338621)&&_0x16b69c['push']('Permission\x20\x27'+_0x49bb8e+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x37b24f=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x37b24f))_0x16b69c['push']('permissions.imports must be an array');else{for(let _0x473126 of _0x37b24f)typeof _0x473126!='string'&&_0x16b69c['push']('import\x20\x27'+_0x473126+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x16b69c['length']===0x0,'errors':_0x16b69c};}};function q(_0x30d3e9,_0x2bf375,_0x59c0a5){return new D(_0x30d3e9,_0x2bf375,_0x59c0a5||{});}var R=null;function I(){let _0x59be72=globalThis['Deno'];if(!_0x59be72)throw new Error('Deno is not available');return _0x59be72;}async function K(){if(R)return{...R};try{let _0x486ce6=I(),_0x5c0026=path.join(_0x486ce6['cwd'](),'deno.json'),_0x2432d4=await _0x486ce6['readTextFile'](_0x5c0026);return R=JSON['parse'](_0x2432d4)['imports']||{},{...R};}catch(_0x261834){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x261834),{};}}var E=class{constructor(_0x392fae,_0x5991a2={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x392fae['appsDir'],this['platformImportsOverride']=_0x392fae['platformImports'],this['libDir']=_0x392fae['libDir'],this['events']=_0x5991a2);}async['create'](_0xb70498,_0x263a66,_0x10bc76){try{return await this['createWorker'](_0xb70498,_0x263a66,_0x10bc76);}catch(_0x45a8a3){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0xb70498+':',_0x45a8a3),_0x45a8a3;}}async['createWorker'](_0x1b8243,_0x5af339,_0x19ddab){let _0x500f4=this['platformImportsOverride']||await K(),_0x2d5f7b=q(_0x5af339,this['libDir'],_0x500f4)['validateServerImports'](this['appsDir']);if(!_0x2d5f7b['valid']){let _0xa10b1b=_0x2d5f7b['violations']['filter'](_0x165715=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x165715)),_0x144975=_0x2d5f7b['serverPath']?_0x2d5f7b['serverPath']:(_0x5af339['name']||_0x5af339['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x144975+':\x20'+_0xa10b1b['join'](',\x20'));}let _0x3f2a3b=q(_0x5af339,this['libDir'],_0x500f4),_0x51f06a=_0x3f2a3b['validate'](_0x500f4);if(!_0x51f06a['valid'])throw new Error('Invalid\x20config:\x20'+_0x51f06a['errors']['join'](',\x20'));let _0x1f5474=_0x3f2a3b['buildImportMap'](_0x500f4);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x1b8243+':',_0x1f5474);let _0x200e7e=_0x3f2a3b['buildPerms'](),_0x2fde91=_0x3f2a3b['getReadPaths']();if(_0x200e7e['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x200e7e['read']);else{let _0x59085a=_0x5af339['name']||_0x1b8243,_0x42c545=this['appsDir']+'/'+_0x59085a,_0x5ecf01=[_0x42c545],_0x4b0593=_0x5af339['metadata']?.['serverPath'];if(_0x4b0593&&typeof _0x4b0593=='string')try{let _0x12bffe=path.dirname(_0x4b0593)['replace'](/\\/g,'/');_0x5ecf01['push'](_0x12bffe);}catch{}_0x200e7e['read']=_0x5ecf01,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x42c545);}if(_0x2fde91['length']>0x0){if(_0x200e7e['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x2c8c22=Array['isArray'](_0x200e7e['read'])?_0x200e7e['read']:[];_0x200e7e['read']=[..._0x2c8c22,..._0x2fde91],console['log']('[Worker] Added package read permissions:',_0x2fde91);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x200e7e['net']||(_0x200e7e['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x1b8243+':',_0x200e7e['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x200e7e['read']===!![]?'unrestricted':Array['isArray'](_0x200e7e['read'])?_0x200e7e['read']['length']:0x0));let _0x53f39d=await this['createImportMap'](_0x1b8243,_0x1f5474),_0x1ac544=await this['createLock'](_0x1b8243,_0x1f5474),_0x128f49={'type':'module','deno':{'permissions':{}}};_0x128f49['deno']['namespace']=![],_0x128f49['deno']['permissions']=_0x200e7e,_0x128f49['deno']['importMap']=_0x53f39d,_0x128f49['deno']['lock']=_0x1ac544,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x1b8243+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x53f39d),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x1ac544),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x1f5474)['length']+'\x20('+(Object['keys'](_0x1f5474)['join'](',\x20')||'none')+')');let _0x521a1a={'worker':new Worker(_0x19ddab,_0x128f49),'appId':_0x1b8243,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x5af339,'importMapPath':_0x53f39d,'lockfilePath':_0x1ac544};return this['workers']['set'](_0x1b8243,_0x521a1a),this['events']['onCreate']?.(_0x521a1a),_0x521a1a;}async['createLock'](_0x52e319,_0x2013d4){let _0x1e38c6=I(),_0xf2703c=path.join(_0x1e38c6['cwd'](),'storage','temp','lockfiles');await _0x1e38c6['mkdir'](_0xf2703c,{'recursive':!![]});let _0x8e05df=_0x52e319+'-'+Date['now']()+'.lock',_0x586b8f=path.join(_0xf2703c,_0x8e05df),_0x47c2cf={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x2043a6,_0xa69bcc]of Object['entries'](_0x2013d4))if(_0xa69bcc['startsWith']('npm:'))_0xa69bcc['replace']('npm:',''),_0x47c2cf['packages']['specifiers'][_0x2043a6]=_0xa69bcc;else _0xa69bcc['startsWith']('file://')&&(_0x47c2cf['packages']['specifiers'][_0x2043a6]=_0xa69bcc);let _0x3ccea6=JSON['stringify'](_0x47c2cf,null,0x2);return await _0x1e38c6['writeTextFile'](_0x586b8f,_0x3ccea6),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x586b8f),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x2013d4)['length']+'):',Object['keys'](_0x2013d4)),_0x586b8f;}async['createImportMap'](_0x26eed6,_0xaed261){let _0x3234ca=I(),_0x449468=path.join(_0x3234ca['cwd'](),'storage','temp','importmaps');await _0x3234ca['mkdir'](_0x449468,{'recursive':!![]});let _0x1fd6df=_0x26eed6+'-'+Date['now']()+'.json',_0x4026f0=path.join(_0x449468,_0x1fd6df),_0x2a1f63=JSON['stringify']({'imports':_0xaed261,'scopes':{}},null,0x2);return await _0x3234ca['writeTextFile'](_0x4026f0,_0x2a1f63),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x4026f0),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0xaed261)['length']+'):',Object['keys'](_0xaed261)['join'](',\x20')||'none'),_0x4026f0;}['get'](_0x1bd4b6){return this['workers']['get'](_0x1bd4b6);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x51c508,_0xf18b5b){let _0x44aa16=this['workers']['get'](_0x51c508);if(!_0x44aa16)return;let _0x2183f1=_0x44aa16['status'];_0x44aa16['status']=_0xf18b5b,_0xf18b5b==='running'&&_0x2183f1==='starting'?this['events']['onReady']?.(_0x44aa16):_0xf18b5b==='crashed'&&this['events']['onCrash']?.(_0x44aa16);}['touch'](_0x2cfc83){let _0x102553=this['workers']['get'](_0x2cfc83);_0x102553&&(_0x102553['lastUsed']=Date['now']());}async['stop'](_0x3e4619){let _0x405f80=this['workers']['get'](_0x3e4619);if(_0x405f80)try{_0x405f80['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x405f80['worker']['terminate'](),_0x405f80['status']='stopped',this['events']['onStop']?.(_0x405f80),_0x405f80['importMapPath']&&await this['cleanupImportMap'](_0x405f80['importMapPath']),_0x405f80['lockfilePath']&&await this['cleanupLock'](_0x405f80['lockfilePath']);}catch(_0x13b6a5){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x3e4619+':',_0x13b6a5);}finally{this['workers']['delete'](_0x3e4619);}}async['cleanupImportMap'](_0x1c8746){try{await I()['remove'](_0x1c8746),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x1c8746);}catch(_0x5b36a4){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x1c8746,_0x5b36a4);}}async['cleanupLock'](_0x4614b7){try{await I()['remove'](_0x4614b7),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x4614b7);}catch(_0x299d1f){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x4614b7,_0x299d1f);}}async['stopAll'](){let _0x16c592=Array['from'](this['workers']['keys']());await Promise['all'](_0x16c592['map'](_0xe673ea=>this['stop'](_0xe673ea)));}async['restart'](_0x4697b2,_0x538f2f){let _0x42dbe6=this['workers']['get'](_0x4697b2);if(!_0x42dbe6)throw new Error('Worker\x20'+_0x4697b2+'\x20not\x20found');let _0x4a430e=_0x42dbe6['manifest'];return await this['stop'](_0x4697b2),await this['create'](_0x4697b2,_0x4a430e,_0x538f2f);}['checkHealth'](_0x5e0ed4){let _0x14c90a=this['workers']['get'](_0x5e0ed4);if(!_0x14c90a)return{'healthy':![],'reason':'Not\x20found'};if(_0x14c90a['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x14c90a['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x355968=Date['now']()-_0x14c90a['lastUsed'],_0x52dbff=0x708*0x3e8;return _0x355968>_0x52dbff?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x355968/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x402dfa=0x708*0x3e8,_0x28667a){let _0x334a0a=Date['now'](),_0x17dac8=[];for(let [_0x57420d,_0x5768cf]of this['workers']['entries']()){let _0x4b2dad=_0x334a0a-_0x5768cf['lastUsed'];_0x4b2dad>_0x402dfa&&_0x17dac8['push']({'appId':_0x57420d,'idle':_0x4b2dad});}_0x17dac8['sort']((_0x3a7513,_0x3111be)=>_0x3111be['idle']-_0x3a7513['idle']);let _0x5a6a11=_0x28667a?_0x17dac8['slice'](0x0,_0x28667a)['map'](_0x43b16f=>_0x43b16f['appId']):_0x17dac8['map'](_0x10bcdb=>_0x10bcdb['appId']);for(let _0x3edacd of _0x5a6a11)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x3edacd),await this['stop'](_0x3edacd);}['stats'](){let _0x3a0e25={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x54d91c=Date['now']();for(let _0x23fe67 of this['workers']['values']())_0x3a0e25['byStatus'][_0x23fe67['status']]++,_0x3a0e25['workers']['push']({'appId':_0x23fe67['appId'],'status':_0x23fe67['status'],'version':_0x23fe67['version'],'lastUsed':_0x23fe67['lastUsed'],'idle':_0x54d91c-_0x23fe67['lastUsed']});return _0x3a0e25;}['startCleanup'](_0x353ed1=0x12c*0x3e8,_0x23ab13){let _0x255abc=setInterval(()=>{this['cleanup'](_0x23ab13)['catch'](_0x1a87f5=>{console['error']('Cleanup\x20failed:',_0x1a87f5);});},_0x353ed1);return()=>clearInterval(_0x255abc);}['delay'](_0x4a3946){return new Promise(_0x158558=>setTimeout(_0x158558,_0x4a3946));}};function W(_0x43ed0b,_0x5b9dcc){return new E(_0x43ed0b,_0x5b9dcc);}var v=f,j=class{constructor(_0x540c3e,_0x298d33=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x540c3e,this['timeout']=_0x298d33);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x4951fd){_0x4951fd['worker']['onmessage']=_0x542e4a=>{let _0x3a082f=_0x542e4a['data'],{appId:_0x49a564}=_0x4951fd;switch(_0x3a082f['type']){case'ready':this['events']['onReady'](_0x49a564),v['info']('Worker\x20ready',{'appId':_0x49a564,'version':_0x4951fd['version']});break;case'log':{let {level:_0x4f3b3='info',message:_0x10458f,meta:_0xcbe1b7}=_0x3a082f,_0x2ac9ef={..._0xcbe1b7||{},'appId':_0x49a564,'version':_0x4951fd['version']};this['events']['onLog'](_0x49a564,_0x4f3b3,_0x10458f,_0x2ac9ef);break;}case'result':{let {reqId:_0x54cad6,ok:_0x147fff,response:_0x548678,error:_0x412655}=_0x3a082f,_0x16c89c=this['pending']['get'](_0x54cad6);if(!_0x16c89c){v['warn']('Unknown\x20request',{'appId':_0x49a564,'reqId':_0x54cad6});return;}if(this['pending']['delete'](_0x54cad6),_0x147fff&&_0x548678)_0x16c89c['resolve'](_0x548678);else{let _0x1239e3=new Error(_0x412655?.['message']||'Worker\x20error');_0x1239e3['stack']=_0x412655?.['stack'],_0x16c89c['reject'](_0x1239e3);}this['events']['onResult'](_0x49a564,_0x54cad6,_0x548678||_0x412655);break;}default:v['debug']('Unknown\x20message',{'appId':_0x49a564,'type':_0x3a082f['type']});}},_0x4951fd['worker']['onerror']=_0x11209b=>{let {appId:_0x1c0ef0}=_0x4951fd;v['error']('Worker\x20error',{'appId':_0x1c0ef0,'message':_0x11209b['message'],'lineno':_0x11209b['lineno'],'filename':_0x11209b['filename']}),_0x4951fd['status']='crashed',this['rejectPending'](_0x1c0ef0,new Error('Worker\x20'+_0x1c0ef0+'\x20crashed:\x20'+_0x11209b['message'])),_0x11209b['preventDefault']();},_0x4951fd['worker']['onmessageerror']=_0x1f12d5=>{let {appId:_0x235b80}=_0x4951fd;v['error']('Message\x20error',{'appId':_0x235b80,'data':_0x1f12d5['data']}),_0x4951fd['status']='crashed',_0x1f12d5['preventDefault']();};}['sendInit'](_0x5cd980,_0x62853e,_0x226f43,_0x22276a){_0x5cd980['worker']['postMessage']({'type':'init','appId':_0x5cd980['appId'],'manifest':_0x226f43,'appsDir':_0x62853e,'serverPath':_0x22276a});}async['sendInvoke'](_0x504d85,_0x3b5f32){let _0x44debc=this['nextId'](),_0x504baf=_0x504d85['appId'],_0x514629=new Promise((_0x3d5bc0,_0x5b12eb)=>{let _0x192f3f=setTimeout(()=>{this['pending']['delete'](_0x44debc),_0x5b12eb(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x44debc,{'resolve':_0x4363ed=>{clearTimeout(_0x192f3f),_0x3d5bc0(_0x4363ed);},'reject':_0x47dbb8=>{clearTimeout(_0x192f3f),_0x5b12eb(_0x47dbb8);},'timestamp':Date['now'](),'appId':_0x504baf});});return _0x504d85['worker']['postMessage']({'type':'invoke','appId':_0x504d85['appId'],'reqId':_0x44debc,'payload':_0x3b5f32}),await _0x514629;}['rejectPending'](_0x2757db,_0x3c628c){let _0x28b53c=0x0;for(let [_0x6395ab,_0xec188a]of this['pending']['entries']())_0xec188a['appId']===_0x2757db&&(this['pending']['delete'](_0x6395ab),_0xec188a['reject'](_0x3c628c),_0x28b53c++);_0x28b53c>0x0&&v['warn']('Rejected\x20'+_0x28b53c+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x2757db});}['cleanupTimeout'](){let _0x48885e=Date['now']();for(let [_0x3ce319,_0x2c8aa3]of this['pending']['entries']())_0x48885e-_0x2c8aa3['timestamp']>this['timeout']&&(this['pending']['delete'](_0x3ce319),_0x2c8aa3['reject'](new Error('Request\x20'+_0x3ce319+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x4d507a){let _0x54dac9=0x0;for(let _0x4c8b2b of this['pending']['values']())_0x4c8b2b['appId']===_0x4d507a&&_0x54dac9++;return _0x54dac9;}['startCleanup'](_0x447fe1=0x2710){let _0x10043d=setInterval(()=>{this['cleanupTimeout']();},_0x447fe1);return()=>clearInterval(_0x10043d);}};function $(_0x2f3ae2,_0x394106){return new j(_0x2f3ae2,_0x394106);}var Q=class{constructor(_0x3bf05a={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x3bf05a['logger']||f,this['config']={'appsDir':_0x3bf05a['appsDir']||this['getAppsDir'](),'scriptUrl':_0x3bf05a['scriptUrl']||this['getScriptUrl'](),'timeout':_0x3bf05a['timeout']||0x78*0x3e8,'autoCleanup':_0x3bf05a['autoCleanup']??!![],'cleanupInterval':_0x3bf05a['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x3bf05a['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x3bf05a['maxWorkers'],'reuseWorkers':_0x3bf05a['reuseWorkers']??!![],'workerReuseStrategy':_0x3bf05a['workerReuseStrategy']||'lru','enableQueue':_0x3bf05a['enableQueue']??!![],'maxQueueSize':_0x3bf05a['maxQueueSize']||0x64,'queueTimeout':_0x3bf05a['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x23e8f3=>this['logger']['info']('Worker\x20created',{'appId':_0x23e8f3['appId'],'v':_0x23e8f3['version']}),'onReady':_0x36fdcf=>this['lifecycle']['updateStatus'](_0x36fdcf['appId'],'running'),'onCrash':_0x3e629c=>this['logger']['error']('Worker\x20crashed',{'appId':_0x3e629c['appId'],'v':_0x3e629c['version']}),'onStop':_0x22d8f4=>this['logger']['info']('Worker\x20stopped',{'appId':_0x22d8f4['appId'],'v':_0x22d8f4['version']})}),this['messaging']=$({'onReady':_0x37683e=>this['lifecycle']['updateStatus'](_0x37683e,'running'),'onLog':(_0x567877,_0x5c67ad,_0x32f4cf,_0x26a1e0)=>{let _0x1c7def={..._0x26a1e0||{},'appId':_0x567877};switch(_0x5c67ad){case'error':this['logger']['error'](_0x32f4cf,_0x1c7def);break;case'warn':this['logger']['warn'](_0x32f4cf,_0x1c7def);break;case'debug':this['logger']['debug'](_0x32f4cf,_0x1c7def);break;default:this['logger']['info'](_0x32f4cf,_0x1c7def);break;}},'onResult':(_0x4fae5a,_0x4ec145,_0x21df6c)=>{this['logger']['debug']('Result\x20received',{'appId':_0x4fae5a,'reqId':_0x4ec145});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x512df7=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x2ce6b6=_0x512df7['endsWith']('.js')||_0x512df7['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x2ce6b6,_0x512df7)['href'];}async['ensure'](_0x169829){let {id:_0x53f21c}=_0x169829,_0x22134a=this['lifecycle']['get'](_0x53f21c);if(_0x22134a){let _0x5b313e=this['lifecycle']['checkHealth'](_0x53f21c);if(_0x5b313e['healthy'])return this['lifecycle']['touch'](_0x53f21c),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x53f21c}),_0x22134a;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x53f21c,'reason':_0x5b313e['reason']}),await this['lifecycle']['stop'](_0x53f21c);}for(;;){let _0x2270f0=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x2270f0>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x2270f0,'max':this['config']['maxWorkers'],'appId':_0x53f21c}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x169829);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x5d3afd=await this['loadManifest'](_0x53f21c,_0x169829['manifest']),_0xa2a7f0=await this['lifecycle']['create'](_0x53f21c,_0x5d3afd,this['config']['scriptUrl']),_0x4c43a0=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x4c43a0>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x4c43a0,'max':this['config']['maxWorkers'],'appId':_0x53f21c}),await this['lifecycle']['stop'](_0x53f21c),this['config']['enableQueue'])return await this['waitSlot'](_0x169829);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x4c43a0+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0xa2a7f0);let _0x52de3e=_0x5d3afd['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0xa2a7f0,this['config']['appsDir'],_0x5d3afd,_0x52de3e),this['logger']['info']('Worker\x20created',{'appId':_0x53f21c,'v':_0xa2a7f0['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0xa2a7f0;}async['evictIdle'](){let _0x38593c=this['lifecycle']['getAll']();if(_0x38593c['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x184620=[..._0x38593c];this['config']['workerReuseStrategy']==='lru'?_0x184620['sort']((_0x218877,_0x471302)=>_0x218877['lastUsed']-_0x471302['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x184620['sort']((_0x42f6ef,_0x3f7922)=>_0x42f6ef['version']-_0x3f7922['version']);let _0x3a3dc4=null;for(let _0x467936 of _0x184620)if(this['messaging']['getAppCount'](_0x467936['appId'])===0x0){_0x3a3dc4=_0x467936;break;}if(!_0x3a3dc4&&_0x184620['length']>0x0&&(_0x3a3dc4=_0x184620['reduce']((_0x1eeb54,_0x4667e3)=>{let _0x1bde29=this['messaging']['getAppCount'](_0x1eeb54['appId']);return this['messaging']['getAppCount'](_0x4667e3['appId'])<_0x1bde29?_0x4667e3:_0x1eeb54;})),_0x3a3dc4){let _0x120451=this['messaging']['getAppCount'](_0x3a3dc4['appId']);return _0x120451>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x3a3dc4['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x3a3dc4['lastUsed'],'pendingRequests':_0x120451}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x3a3dc4['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x3a3dc4['lastUsed']}),await this['lifecycle']['stop'](_0x3a3dc4['appId']),!![];}return![];}['waitSlot'](_0x442e58){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x3e41b6,_0x468e58)=>{let _0x53cf1a={'info':_0x442e58,'resolve':_0x3e41b6,'reject':_0x468e58,'timestamp':Date['now']()};this['requestQueue']['push'](_0x53cf1a),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x442e58['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x2d668f=setTimeout(()=>{let _0x1c9c55=this['requestQueue']['indexOf'](_0x53cf1a);_0x1c9c55!==-0x1&&(this['requestQueue']['splice'](_0x1c9c55,0x1),_0x468e58(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x53cf1a['resolve']=_0xffff8b=>{clearTimeout(_0x2d668f),_0x3e41b6(_0xffff8b);},_0x53cf1a['reject']=_0x42a617=>{clearTimeout(_0x2d668f),_0x468e58(_0x42a617);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x5b6dc3=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x5b6dc3>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x127b2c=this['requestQueue']['shift']();if(!_0x127b2c)break;try{let _0x55d859=await this['ensure'](_0x127b2c['info']);_0x127b2c['resolve'](_0x55d859);}catch(_0x390dab){_0x127b2c['reject'](_0x390dab);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x42ab6a,_0x483422){let _0x1d67da=this['config']['appsDir']['replace'](/\\/g,'/'),_0x5e793e=async _0x4ed638=>{try{let _0x989af9=globalThis['Deno'];if(!_0x989af9)return null;let _0x1038c2=await _0x989af9['readTextFile'](_0x4ed638);return JSON['parse'](_0x1038c2);}catch{return null;}};if(_0x483422?.['name']){let _0x3ff286=await _0x5e793e(_0x1d67da+'/'+_0x483422['name']+'/manifest.json');if(_0x3ff286)return _0x3ff286;}let _0x3169d8=await _0x5e793e(_0x1d67da+'/'+_0x42ab6a+'/manifest.json');if(_0x3169d8)return _0x3169d8;try{let _0x47b9a9=globalThis['Deno'];if(_0x47b9a9)for await(let _0x1bef6f of _0x47b9a9['readDir'](_0x1d67da)){if(!_0x1bef6f['isDirectory'])continue;let _0x2a8daf=_0x1d67da+'/'+_0x1bef6f['name']+'/manifest.json',_0x59ac7d=await _0x5e793e(_0x2a8daf);if(_0x59ac7d&&(_0x59ac7d['id']===_0x42ab6a||_0x483422?.['name']&&_0x59ac7d['name']===_0x483422['name']))return _0x59ac7d;}}catch(_0xdc1184){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x42ab6a,'error':_0xdc1184['message']});}return _0x483422||{'id':_0x42ab6a,'name':_0x42ab6a,'version':'1.0.0'};}async['invoke'](_0x4a9e63){let _0x5c6205=_0x4a9e63['ctx']['app']['id'],_0x59e2af=_0x4a9e63['ctx']['app']['name'];try{let _0x441a94={'id':_0x5c6205,'manifest':{'id':_0x5c6205,'name':_0x59e2af}},_0xba828c=await this['ensure'](_0x441a94);if(_0xba828c['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x5c6205}),await this['restart'](_0x5c6205);let _0x3a9c37=await this['ensure'](_0x441a94);return this['lifecycle']['touch'](_0x5c6205),await this['messaging']['sendInvoke'](_0x3a9c37,_0x4a9e63);}return this['lifecycle']['touch'](_0x5c6205),await this['messaging']['sendInvoke'](_0xba828c,_0x4a9e63);}catch(_0x4f65f8){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x5c6205,'error':_0x4f65f8['message'],'stack':_0x4f65f8['stack']}),_0x4f65f8;}}async['stop'](_0xc8cd48){await this['lifecycle']['stop'](_0xc8cd48),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x507b94){return await this['lifecycle']['restart'](_0x507b94,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x2ea438=>({'appId':_0x2ea438['appId'],'status':_0x2ea438['status'],'version':_0x2ea438['version'],'lastUsed':_0x2ea438['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x52c569=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x2c729b=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x52c569(),_0x2c729b();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x420be0=>{_0x420be0?(await this['stop'](_0x420be0),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x420be0})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x1733ab){return new Q(_0x1733ab);}var S=null;function be(_0x4000dc){S=ee(_0x4000dc);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x52c155){return await k()['ensure'](_0x52c155);}async function xe(_0x354182){return await k()['invoke'](_0x354182);}function Ie(_0x44ccd8){k()['stop'](_0x44ccd8)['catch'](_0x307710=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x44ccd8,'error':_0x307710['message']});});}function Re(){k()['stopAll']()['catch'](_0x401dad=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x401dad['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x49678f){await k()['stop'](_0x49678f);}async function Se(){await k()['stopAll']();}function Ae(_0x384dbd){let _0x4442e6=_0x384dbd&&typeof _0x384dbd=='object'?_0x384dbd:null;if(_0x4442e6&&'user'in _0x4442e6)return _0x4442e6['user'];}function H(_0x762560){let _0x542442=_0x762560&&typeof _0x762560=='object'?_0x762560:null;if(!_0x542442)return{};let _0x4f8b7c={};for(let [_0x1e8832,_0x3d7269]of Object['entries'](_0x542442))_0x1e8832!=='user'&&(_0x4f8b7c[_0x1e8832]=_0x3d7269);return _0x4f8b7c;}function O(_0x557a3e){return _0x557a3e?{'id':_0x557a3e['manifest']?.['id']||_0x557a3e['id']||'','name':_0x557a3e['manifest']?.['name']||'','version':_0x557a3e['manifest']?.['version']||'','description':_0x557a3e['manifest']?.['description']||'','icon':_0x557a3e['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x2c6f6d){return _0x2c6f6d?.['permissions']||_0x2c6f6d?.['manifest']?.['permissions']||{};}function F(_0x55cdd6){return _0x55cdd6?.['manifest']?.['metadata']||{};}function Ce(_0x36b117){return _0x36b117?{'appId':_0x36b117['id'],'appName':_0x36b117['manifest']?.['name']}:{};}function N(_0x32eef5,_0x4ef95b={}){let {appInfo:_0x20aeba=null,status:_0x5262b1=0x1f4,defaultMessage:_0x4837cf='Internal\x20Server\x20Error'}=_0x4ef95b,_0x53a049={'error':_0x4837cf,'message':_0x32eef5?.['message']||_0x4837cf};return _0x20aeba&&(_0x53a049['appId']=_0x20aeba['id'],_0x53a049['appName']=_0x20aeba['manifest']?.['name']),_0x32eef5?.['message']?.['includes']('crashed')&&(_0x53a049['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x5262b1,'body':_0x53a049};}function qe(_0x5bd6f3){return _0x5bd6f3?.['message']?.['includes']('crashed')||![];}function J(_0x374ab7){if(_0x374ab7)try{return JSON['parse'](_0x374ab7);}catch{return _0x374ab7;}}function B(_0x3d1747){try{let _0x55662b=new URL(_0x3d1747),_0x12b3ef={};for(let _0x27a3b0 of _0x55662b['searchParams']['keys']()){let _0x7b343b=_0x55662b['searchParams']['getAll'](_0x27a3b0)['map'](_0xce92e9=>_0xce92e9);_0x7b343b['length']<=0x1?_0x12b3ef[_0x27a3b0]=_0x7b343b[0x0]??'':_0x12b3ef[_0x27a3b0]=_0x7b343b;}return _0x12b3ef;}catch{return{};}}function Le(_0x2f79cc){return(()=>{try{return new URL(_0x2f79cc)['pathname'];}catch{return _0x2f79cc;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x1e102b,_0x3ed528){let _0x4843d9=_0x1e102b;if(_0x3ed528&&_0x4843d9['startsWith']('/apps/'+_0x3ed528))_0x4843d9=_0x4843d9['substring'](('/apps/'+_0x3ed528)['length'])||'/';else{let _0x2b0418=_0x4843d9['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x2b0418&&(_0x4843d9=_0x2b0418[0x1]||'/');}return _0x4843d9['startsWith']('/api')&&(_0x4843d9=_0x4843d9['substring'](0x4)||'/'),_0x4843d9;}function Ue(_0x2fbfcc,_0x3fdfb5){let _0x262e4d=_0x2fbfcc;if(_0x3fdfb5&&_0x262e4d['startsWith']('/apps/'+_0x3fdfb5))_0x262e4d=_0x262e4d['substring'](('/apps/'+_0x3fdfb5)['length'])||'/';else{let _0x1dca6f=_0x262e4d['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x1dca6f&&(_0x262e4d=_0x1dca6f[0x1]||'/');}return(!_0x262e4d||_0x262e4d==='/')&&(_0x262e4d='/index.html'),_0x262e4d;}async function He(_0x2cfdd5,_0x205b7d){return await _0x205b7d(_0x2cfdd5);}function _(_0x4ba27b){return _0x4ba27b['split']('/')['filter'](_0x54b2b3=>_0x54b2b3['length']>0x0);}function te(_0x19c232){try{return decodeURIComponent(_0x19c232);}catch{return _0x19c232;}}function re(_0x361073,_0x399a51){let _0x189783=_(_0x361073),_0x2a88bf=_(_0x399a51),_0x3d6193={},_0x5322e8=0x0,_0x73e7ac=0x0;for(;_0x5322e8<_0x189783['length']&&_0x73e7ac<_0x2a88bf['length'];){let _0x4cf5ce=_0x189783[_0x5322e8],_0x550555=_0x2a88bf[_0x73e7ac];if(_0x4cf5ce==='*')break;if(_0x4cf5ce['startsWith'](':')){let _0x1132a9=_0x4cf5ce['slice'](0x1);_0x1132a9&&(_0x3d6193[_0x1132a9]=te(_0x550555)),_0x5322e8++,_0x73e7ac++;continue;}if(_0x4cf5ce!==_0x550555)return{};_0x5322e8++,_0x73e7ac++;}return _0x5322e8===_0x189783['length']||_0x5322e8===_0x189783['length']-0x1&&_0x189783[_0x5322e8]==='*',_0x3d6193;}async function Oe(_0xbe1fb2,_0x21ef12,_0x183ff6,_0x15d4fe,_0x2ed123=void 0x0,_0x2e4c93){let _0x3ebba1=await _0x21ef12['text'](),_0x374375=J(_0x3ebba1),_0x50afbf=B(_0x21ef12['url']),_0x43862f={...F(_0xbe1fb2),'user':_0x2ed123},_0x5b33b7=H(_0x43862f),_0x46cf8d=_0x2e4c93?re(_0x2e4c93,_0x21ef12['path']):{};return{'app':O(_0xbe1fb2),'permissions':T(_0xbe1fb2),'user':_0x2ed123,'metadata':_0x5b33b7,'body':_0x374375,'query':_0x50afbf,'params':_0x46cf8d,'method':_0x183ff6,'pathname':_0x15d4fe,'requestUrl':_0x21ef12['url'],'headers':Object['fromEntries'](_0x21ef12['raw']['headers']['entries']())};}function Te(_0x2b0d57){return{'method':_0x2b0d57['method'],'pathname':_0x2b0d57['pathname'],'ctx':_0x2b0d57};}function Fe(_0x4e9c3d,_0x3fb2dd){let {status:_0x448b03=0xc8,headers:_0x297aa3={},body:_0x55626b,type:_0x3cc30b}=_0x4e9c3d??{};return _0x3cc30b==='raw'?new globalThis['Response'](String(_0x55626b??''),{'status':_0x448b03,'headers':_0x297aa3}):_0x3fb2dd(_0x55626b,_0x448b03);}function Ne(_0x305ef4,_0x5d9cad=null){return N(_0x305ef4,{'appInfo':_0x5d9cad});}var V=f;async function Ve(_0x23ea34){_0x23ea34?(await U(_0x23ea34),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x23ea34)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x3572c2,_0x811a56){let _0x11eca8=Object['fromEntries'](Object['entries'](_0x3572c2['headers']||{})['map'](([_0x51c3ed,_0x149b8f])=>[_0x51c3ed['toLowerCase'](),_0x149b8f]));return{'id':_0x3572c2['app']['id']||_0x811a56['appId']||'','name':_0x3572c2['app']['name']||'','version':_0x3572c2['app']['version']||'','description':_0x3572c2['app']['description']||'','metadata':{..._0x3572c2['metadata'],'permissions':_0x3572c2['permissions']},'body':_0x3572c2['body'],'query':_0x3572c2['query'],'params':_0x3572c2?.['params'],'method':_0x3572c2['method'],'pathname':_0x3572c2['pathname'],'requestUrl':_0x3572c2['requestUrl'],'user':_0x3572c2['user'],'headers':_0x11eca8};}var L=class{constructor(_0xb7d74){this['handle']=null,(this['config']=_0xb7d74,this['logger']=_0xb7d74['logger']||f,this['lifecycle']=W({'appsDir':_0xb7d74['appsDir'],'timeout':_0xb7d74['timeout'],'platformImports':_0xb7d74['platformImports'],'libDir':_0xb7d74['libDir']},{'onCreate':_0x42360e=>this['logger']['info']('Worker\x20created',{'appId':_0x42360e['appId']}),'onReady':_0x512c44=>{this['lifecycle']['updateStatus'](_0x512c44['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x512c44['appId']});},'onCrash':_0x5cf804=>this['logger']['error']('Worker\x20crashed',{'appId':_0x5cf804['appId']}),'onStop':_0x869696=>this['logger']['info']('Worker\x20stopped',{'appId':_0x869696['appId']})}),this['messaging']=$({'onReady':_0x69c72b=>this['lifecycle']['updateStatus'](_0x69c72b,'running'),'onLog':(_0x17e3f5,_0x52d29e,_0x2d7900,_0x3641d4)=>{(this['logger'][_0x52d29e]||this['logger']['info'])['call'](this['logger'],_0x2d7900,_0x3641d4);},'onResult':()=>{}},_0xb7d74['timeout']||0x1d4c0));}async['create'](_0x3e6478){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x19b33d=await this['lifecycle']['create'](this['config']['appId'],_0x3e6478,this['config']['scriptUrl']);this['messaging']['setup'](_0x19b33d),this['messaging']['sendInit'](_0x19b33d,this['config']['appsDir'],_0x3e6478,this['config']['serverPath']),this['handle']=_0x19b33d,await this['waitForReady']();}async['waitForReady'](_0x2b3e15=0x2710){let _0x2bcbac=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x2bcbac>_0x2b3e15)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0xfc3753=>setTimeout(_0xfc3753,0x64));}}async['invoke'](_0x4ff0a5){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x4ff0a5);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x53f25d){return new L(_0x53f25d);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;