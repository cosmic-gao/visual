import{join,dirname}from'path';import _0x30d3ef from'process';import{stat}from'fs/promises';async function ie(_0x1bc880){try{return await stat(_0x1bc880),!0x0;}catch{return![];}}var f={'error':(_0x2c1265,_0x2fbab5)=>console['error']('[ERROR]\x20'+_0x2c1265,_0x2fbab5),'warn':(_0x2c8abc,_0x541501)=>console['warn']('[WARN]\x20'+_0x2c8abc,_0x541501),'info':(_0x56f730,_0x5ef8fb)=>console['log']('[INFO]\x20'+_0x56f730,_0x5ef8fb),'debug':(_0x105686,_0x381374)=>console['log']('[DEBUG]\x20'+_0x105686,_0x381374)};function z(){let _0x226b47=globalThis['Deno'];if(!_0x226b47)throw new Error('Deno is not available');return _0x226b47;}var D=class{constructor(_0x5c47f1,_0x481a08='./lib',_0x41faf5={}){this['manifest']=_0x5c47f1,this['libDir']=_0x481a08,this['platformImports']=_0x41faf5;}['buildPerms'](){let _0x5cf06a=this['manifest']['permissions']||{},_0x590d42={};return _0x5cf06a['net']!==void 0x0&&(_0x590d42['net']=_0x5cf06a['net']===!![]?!![]:Array['isArray'](_0x5cf06a['net'])?_0x5cf06a['net']:[]),_0x5cf06a['read']!==void 0x0&&(_0x590d42['read']=_0x5cf06a['read']===!![]?!![]:Array['isArray'](_0x5cf06a['read'])?_0x5cf06a['read']:[]),_0x5cf06a['write']!==void 0x0&&(_0x590d42['write']=_0x5cf06a['write']===!![]?!![]:Array['isArray'](_0x5cf06a['write'])?_0x5cf06a['write']:[]),_0x5cf06a['env']!==void 0x0&&(_0x590d42['env']=_0x5cf06a['env']===!![]?!![]:Array['isArray'](_0x5cf06a['env'])?_0x5cf06a['env']:[]),_0x5cf06a['run']!==void 0x0&&(_0x590d42['run']=_0x5cf06a['run']===!![]?!![]:Array['isArray'](_0x5cf06a['run'])?_0x5cf06a['run']:[]),_0x5cf06a['ffi']!==void 0x0&&(_0x590d42['ffi']=_0x5cf06a['ffi']===!![]?!![]:Array['isArray'](_0x5cf06a['ffi'])?_0x5cf06a['ffi']:[]),_0x5cf06a['sys']!==void 0x0&&(_0x590d42['sys']=_0x5cf06a['sys']===!![]?!![]:Array['isArray'](_0x5cf06a['sys'])?_0x5cf06a['sys']:[]),_0x5cf06a['hrtime']!==void 0x0&&(_0x590d42['hrtime']=_0x5cf06a['hrtime']),_0x590d42;}['normalize'](_0x5095a0){return _0x5095a0===!![]?[]:Array['isArray'](_0x5095a0)?_0x5095a0:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x476f77){return join(this['libDir'],_0x476f77+'@*');}['getReadPaths'](){let _0x492404=this['getImports']();_0x492404['includes']('*')&&(_0x492404=Object['keys'](this['platformImports']));let _0x22218b=[];console['log']('[Permissions] Building package path patterns for imports:',_0x492404);for(let _0x408b17 of _0x492404){let _0x26da5c=this['getLibPattern'](_0x408b17);_0x22218b['push'](_0x26da5c),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x408b17+'\x20->\x20'+_0x26da5c);}return console['log']('[Permissions] Final package path patterns:',_0x22218b),_0x22218b;}['buildImportMap'](_0x2f422b){let _0x2e5e8e=this['getImports'](),_0x35c136=_0x2e5e8e['includes']('*')?Object['keys'](_0x2f422b):_0x2e5e8e;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x35c136);let _0x254832={};for(let _0x4252c2 of _0x35c136)if(_0x2f422b[_0x4252c2])_0x254832[_0x4252c2]=_0x2f422b[_0x4252c2],console['log']('[ImportMap]\x20'+_0x4252c2+'\x20->\x20'+_0x2f422b[_0x4252c2]+'\x20(from\x20platform)');else try{let _0x3ef6c7=z(),_0x4fdc86=join(_0x3ef6c7['cwd'](),this['libDir']),_0x500521=!0x1;try{for(let _0x33ba40 of _0x3ef6c7['readDirSync'](_0x4fdc86))if(_0x33ba40['isDirectory']&&(_0x33ba40['name']===_0x4252c2||_0x33ba40['name']['startsWith'](_0x4252c2+'@'))){let _0x1d6665=join(_0x3ef6c7['cwd'](),this['libDir'],_0x33ba40['name'],'index.js')['replace'](/\\/g,'/'),_0x4a38ea=new URL('file:///'+_0x1d6665)['href'];_0x254832[_0x4252c2]=_0x4a38ea,console['log']('[ImportMap]\x20'+_0x4252c2+'\x20->\x20'+_0x4a38ea+'\x20(from\x20lib)'),_0x500521=!0x0;break;}}catch{}_0x500521||console['warn']('[ImportMap]\x20Package\x20'+_0x4252c2+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x4a33a0){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x4252c2+':',_0x4a33a0);}return _0x254832;}['validateServerImports'](_0x5770d5){let _0xb264c8=this['manifest']['name']||this['manifest']['id'],_0x33177b=this['manifest']['metadata']?.['serverPath'],_0x7018e2=_0x27fb9d=>_0x27fb9d['replace'](/\\/g,'/'),_0x2394ca=z(),_0x4c3b0e=_0x2dba40=>{try{return _0x2394ca['statSync'](_0x2dba40),!0x0;}catch{return![];}},_0x5e8c47=_0x33177b?_0x7018e2(_0x33177b):void 0x0;if(!_0x5e8c47){let _0x57bdd9=[_0x5770d5+'/service/server.js',_0x5770d5+'/service/server.ts',_0x5770d5+'/'+_0xb264c8+'/server.js',_0x5770d5+'/'+_0xb264c8+'/server.ts',_0x5770d5+'/server.js',_0x5770d5+'/server.ts']['map'](_0x7018e2);for(let _0xb1a3f0 of _0x57bdd9)if(_0x4c3b0e(_0xb1a3f0)){_0x5e8c47=_0xb1a3f0;break;}}if(!_0x5e8c47)return{'valid':![],'violations':['Failed to locate server module']};let _0x7133b0='';try{_0x7133b0=_0x2394ca['readTextFileSync'](_0x5e8c47);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x5e8c47};}let _0x3b7639=this['getImports']();if(_0x3b7639['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x5e8c47};let _0x4850e4=_0x3b7639,_0x299c8d=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x5a7809=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x5ebce1=/\bimport\s*['"]([^'"]+)['"]/g,_0x2c5906=[],_0xf855e7=new Set(),_0x18b862=_0x4f0cd8=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x4f0cd8),_0x581a39=_0x585ff6=>{let _0x52c5dd=_0x585ff6;if(_0x52c5dd['startsWith']('./')||_0x52c5dd['startsWith']('../')||_0x52c5dd['startsWith']('/')||_0x52c5dd['startsWith']('file://')||!_0x18b862(_0x585ff6)||_0xf855e7['has'](_0x585ff6))return;_0xf855e7['add'](_0x585ff6),_0x52c5dd['startsWith']('npm:')&&(_0x52c5dd=_0x52c5dd['substring'](0x4)),_0x52c5dd['includes']('@')&&!_0x52c5dd['startsWith']('@')&&(_0x52c5dd=_0x52c5dd['split']('@')[0x0]);let _0x247953=_0x52c5dd['split']('/')[0x0];_0x4850e4['includes'](_0x247953)||_0x4850e4['includes'](_0x585ff6)||_0x2c5906['push'](_0x585ff6);},_0x25d751;for(;(_0x25d751=_0x299c8d['exec'](_0x7133b0))!==null;)_0x581a39(_0x25d751[0x1]);for(;(_0x25d751=_0x5a7809['exec'](_0x7133b0))!==null;)_0x581a39(_0x25d751[0x1]);for(;(_0x25d751=_0x5ebce1['exec'](_0x7133b0))!==null;)_0x581a39(_0x25d751[0x1]);return{'valid':_0x2c5906['length']===0x0,'violations':_0x2c5906,'serverPath':_0x5e8c47};}['validate'](_0x347663={}){let _0xcaec91=[],_0x44fbe1=this['manifest']['permissions']||{};try{let _0x3c3713=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x3c3713);}catch{}let _0x5ed081=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x225dfb,_0x1b9832]of Object['entries'](_0x44fbe1))if(_0x225dfb==='hrtime')typeof _0x1b9832!='boolean'&&_0xcaec91['push']('Permission\x20\x27'+_0x225dfb+'\x27\x20must\x20be\x20boolean');else{if(_0x225dfb==='langchain')typeof _0x1b9832!='boolean'&&(typeof _0x1b9832!='object'||_0x1b9832===null)?_0xcaec91['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x1b9832=='object'&&(_0x1b9832===null||!('enabled'in _0x1b9832)||typeof _0x1b9832['enabled']!='boolean')&&_0xcaec91['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x225dfb==='kv')typeof _0x1b9832!='boolean'&&_0xcaec91['push']('Permission\x20\x27'+_0x225dfb+'\x27\x20must\x20be\x20boolean');else{if(_0x225dfb==='mspbots')Array['isArray'](_0x1b9832)||_0xcaec91['push']('Permission\x20\x27'+_0x225dfb+'\x27\x20must\x20be\x20an\x20array');else{if(_0x225dfb==='db'){if(typeof _0x1b9832!='object'||_0x1b9832===null||Array['isArray'](_0x1b9832))_0xcaec91['push']('Permission\x20\x27'+_0x225dfb+'\x27\x20must\x20be\x20an\x20object');else{let _0x26cb97=_0x1b9832,_0x311315=['user','password']['filter'](_0x37ef1a=>!(_0x37ef1a in _0x26cb97));_0x311315['length']>0x0&&_0xcaec91['push']('Permission\x20\x27'+_0x225dfb+'\x27\x20missing\x20required\x20fields:\x20'+_0x311315['join'](',\x20'));}}else{if(_0x225dfb==='imports')continue;_0x5ed081['has'](_0x225dfb)||typeof _0x1b9832!='boolean'&&!Array['isArray'](_0x1b9832)&&_0xcaec91['push']('Permission\x20\x27'+_0x225dfb+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x3dbd0d=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x3dbd0d))_0xcaec91['push']('permissions.imports must be an array');else{for(let _0x2ff7fc of _0x3dbd0d)typeof _0x2ff7fc!='string'&&_0xcaec91['push']('import\x20\x27'+_0x2ff7fc+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0xcaec91['length']===0x0,'errors':_0xcaec91};}};function q(_0x34199a,_0x5d2b18,_0x39b26d){return new D(_0x34199a,_0x5d2b18,_0x39b26d||{});}var R=null;function I(){let _0x3e07ce=globalThis['Deno'];if(!_0x3e07ce)throw new Error('Deno is not available');return _0x3e07ce;}async function K(){if(R)return{...R};try{let _0x123eed=I(),_0x4b72d6=join(_0x123eed['cwd'](),'deno.json'),_0x22f2a3=await _0x123eed['readTextFile'](_0x4b72d6);return R=JSON['parse'](_0x22f2a3)['imports']||{},{...R};}catch(_0x1eb345){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x1eb345),{};}}var E=class{constructor(_0x2a1225,_0x582927={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x2a1225['appsDir'],this['platformImportsOverride']=_0x2a1225['platformImports'],this['libDir']=_0x2a1225['libDir'],this['events']=_0x582927);}async['create'](_0x3ffb83,_0x259da9,_0x4af3e7){try{return await this['createWorker'](_0x3ffb83,_0x259da9,_0x4af3e7);}catch(_0x26f9eb){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x3ffb83+':',_0x26f9eb),_0x26f9eb;}}async['createWorker'](_0x24bbfb,_0x3a5547,_0x33a6f8){let _0x41b224=this['platformImportsOverride']||await K(),_0x503ec7=q(_0x3a5547,this['libDir'],_0x41b224)['validateServerImports'](this['appsDir']);if(!_0x503ec7['valid']){let _0x3e5184=_0x503ec7['violations']['filter'](_0x530fee=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x530fee)),_0xd61504=_0x503ec7['serverPath']?_0x503ec7['serverPath']:(_0x3a5547['name']||_0x3a5547['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0xd61504+':\x20'+_0x3e5184['join'](',\x20'));}let _0x317b11=q(_0x3a5547,this['libDir'],_0x41b224),_0x55429e=_0x317b11['validate'](_0x41b224);if(!_0x55429e['valid'])throw new Error('Invalid\x20config:\x20'+_0x55429e['errors']['join'](',\x20'));let _0x4bbd2c=_0x317b11['buildImportMap'](_0x41b224);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x24bbfb+':',_0x4bbd2c);let _0x547e49=_0x317b11['buildPerms'](),_0x5e0a83=_0x317b11['getReadPaths']();if(_0x547e49['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x547e49['read']);else{let _0x4087e0=_0x3a5547['name']||_0x24bbfb,_0x456fca=this['appsDir']+'/'+_0x4087e0,_0x3f73ca=[_0x456fca],_0x4b3a1a=_0x3a5547['metadata']?.['serverPath'];if(_0x4b3a1a&&typeof _0x4b3a1a=='string')try{let _0x727a99=dirname(_0x4b3a1a)['replace'](/\\/g,'/');_0x3f73ca['push'](_0x727a99);}catch{}_0x547e49['read']=_0x3f73ca,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x456fca);}if(_0x5e0a83['length']>0x0){if(_0x547e49['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0xfc835f=Array['isArray'](_0x547e49['read'])?_0x547e49['read']:[];_0x547e49['read']=[..._0xfc835f,..._0x5e0a83],console['log']('[Worker] Added package read permissions:',_0x5e0a83);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x547e49['net']||(_0x547e49['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x24bbfb+':',_0x547e49['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x547e49['read']===!![]?'unrestricted':Array['isArray'](_0x547e49['read'])?_0x547e49['read']['length']:0x0));let _0x497e35=await this['createImportMap'](_0x24bbfb,_0x4bbd2c),_0x32730f=await this['createLock'](_0x24bbfb,_0x4bbd2c),_0x1c1a09={'type':'module','deno':{'permissions':{}}};_0x1c1a09['deno']['namespace']=![],_0x1c1a09['deno']['permissions']=_0x547e49,_0x1c1a09['deno']['importMap']=_0x497e35,_0x1c1a09['deno']['lock']=_0x32730f,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x24bbfb+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x497e35),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x32730f),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x4bbd2c)['length']+'\x20('+(Object['keys'](_0x4bbd2c)['join'](',\x20')||'none')+')');let _0x3a4781={'worker':new Worker(_0x33a6f8,_0x1c1a09),'appId':_0x24bbfb,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x3a5547,'importMapPath':_0x497e35,'lockfilePath':_0x32730f};return this['workers']['set'](_0x24bbfb,_0x3a4781),this['events']['onCreate']?.(_0x3a4781),_0x3a4781;}async['createLock'](_0x18ad56,_0x35dc9a){let _0x528135=I(),_0x183fa2=join(_0x528135['cwd'](),'storage','temp','lockfiles');await _0x528135['mkdir'](_0x183fa2,{'recursive':!![]});let _0x33f0b1=_0x18ad56+'-'+Date['now']()+'.lock',_0x479d7b=join(_0x183fa2,_0x33f0b1),_0xcb7a5b={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x3d248c,_0x20d82e]of Object['entries'](_0x35dc9a))if(_0x20d82e['startsWith']('npm:'))_0x20d82e['replace']('npm:',''),_0xcb7a5b['packages']['specifiers'][_0x3d248c]=_0x20d82e;else _0x20d82e['startsWith']('file://')&&(_0xcb7a5b['packages']['specifiers'][_0x3d248c]=_0x20d82e);let _0x1e0e03=JSON['stringify'](_0xcb7a5b,null,0x2);return await _0x528135['writeTextFile'](_0x479d7b,_0x1e0e03),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x479d7b),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x35dc9a)['length']+'):',Object['keys'](_0x35dc9a)),_0x479d7b;}async['createImportMap'](_0x41abac,_0x3a72d6){let _0x1f5a4a=I(),_0x36fca2=join(_0x1f5a4a['cwd'](),'storage','temp','importmaps');await _0x1f5a4a['mkdir'](_0x36fca2,{'recursive':!![]});let _0xcfe7bf=_0x41abac+'-'+Date['now']()+'.json',_0x79f6d4=join(_0x36fca2,_0xcfe7bf),_0x449735=JSON['stringify']({'imports':_0x3a72d6,'scopes':{}},null,0x2);return await _0x1f5a4a['writeTextFile'](_0x79f6d4,_0x449735),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x79f6d4),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x3a72d6)['length']+'):',Object['keys'](_0x3a72d6)['join'](',\x20')||'none'),_0x79f6d4;}['get'](_0x4c8183){return this['workers']['get'](_0x4c8183);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x3dbf41,_0x5d41e0){let _0x51a3aa=this['workers']['get'](_0x3dbf41);if(!_0x51a3aa)return;let _0xa9c9f=_0x51a3aa['status'];_0x51a3aa['status']=_0x5d41e0,_0x5d41e0==='running'&&_0xa9c9f==='starting'?this['events']['onReady']?.(_0x51a3aa):_0x5d41e0==='crashed'&&this['events']['onCrash']?.(_0x51a3aa);}['touch'](_0x439f79){let _0x163674=this['workers']['get'](_0x439f79);_0x163674&&(_0x163674['lastUsed']=Date['now']());}async['stop'](_0x578e58){let _0x50b0e6=this['workers']['get'](_0x578e58);if(_0x50b0e6)try{_0x50b0e6['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x50b0e6['worker']['terminate'](),_0x50b0e6['status']='stopped',this['events']['onStop']?.(_0x50b0e6),_0x50b0e6['importMapPath']&&await this['cleanupImportMap'](_0x50b0e6['importMapPath']),_0x50b0e6['lockfilePath']&&await this['cleanupLock'](_0x50b0e6['lockfilePath']);}catch(_0x4953b5){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x578e58+':',_0x4953b5);}finally{this['workers']['delete'](_0x578e58);}}async['cleanupImportMap'](_0x14d524){try{await I()['remove'](_0x14d524),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x14d524);}catch(_0x504477){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x14d524,_0x504477);}}async['cleanupLock'](_0xa082f0){try{await I()['remove'](_0xa082f0),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0xa082f0);}catch(_0x54a914){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0xa082f0,_0x54a914);}}async['stopAll'](){let _0x5c160e=Array['from'](this['workers']['keys']());await Promise['all'](_0x5c160e['map'](_0x5717fb=>this['stop'](_0x5717fb)));}async['restart'](_0x583c8f,_0xe55478){let _0x513d02=this['workers']['get'](_0x583c8f);if(!_0x513d02)throw new Error('Worker\x20'+_0x583c8f+'\x20not\x20found');let _0x3e16d2=_0x513d02['manifest'];return await this['stop'](_0x583c8f),await this['create'](_0x583c8f,_0x3e16d2,_0xe55478);}['checkHealth'](_0x2fb2ab){let _0x29b47e=this['workers']['get'](_0x2fb2ab);if(!_0x29b47e)return{'healthy':![],'reason':'Not\x20found'};if(_0x29b47e['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x29b47e['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0xa91230=Date['now']()-_0x29b47e['lastUsed'],_0x18c32b=0x708*0x3e8;return _0xa91230>_0x18c32b?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0xa91230/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x50cc65=0x708*0x3e8,_0x293dbb){let _0x3f7645=Date['now'](),_0x619728=[];for(let [_0x48e821,_0x608946]of this['workers']['entries']()){let _0x145c91=_0x3f7645-_0x608946['lastUsed'];_0x145c91>_0x50cc65&&_0x619728['push']({'appId':_0x48e821,'idle':_0x145c91});}_0x619728['sort']((_0x40ca72,_0x5cc578)=>_0x5cc578['idle']-_0x40ca72['idle']);let _0x360192=_0x293dbb?_0x619728['slice'](0x0,_0x293dbb)['map'](_0x240a34=>_0x240a34['appId']):_0x619728['map'](_0x3ba91f=>_0x3ba91f['appId']);for(let _0x3f70cf of _0x360192)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x3f70cf),await this['stop'](_0x3f70cf);}['stats'](){let _0x40bfdb={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x45b8b3=Date['now']();for(let _0x3dd7ab of this['workers']['values']())_0x40bfdb['byStatus'][_0x3dd7ab['status']]++,_0x40bfdb['workers']['push']({'appId':_0x3dd7ab['appId'],'status':_0x3dd7ab['status'],'version':_0x3dd7ab['version'],'lastUsed':_0x3dd7ab['lastUsed'],'idle':_0x45b8b3-_0x3dd7ab['lastUsed']});return _0x40bfdb;}['startCleanup'](_0x18f30c=0x12c*0x3e8,_0x492725){let _0x348174=setInterval(()=>{this['cleanup'](_0x492725)['catch'](_0x3f21b5=>{console['error']('Cleanup\x20failed:',_0x3f21b5);});},_0x18f30c);return()=>clearInterval(_0x348174);}['delay'](_0x19d45e){return new Promise(_0x335412=>setTimeout(_0x335412,_0x19d45e));}};function W(_0xd99dbf,_0x5eeedd){return new E(_0xd99dbf,_0x5eeedd);}var v=f,j=class{constructor(_0x1729c8,_0x4e44af=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x1729c8,this['timeout']=_0x4e44af);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x276ed2){_0x276ed2['worker']['onmessage']=_0x33a885=>{let _0x40b69b=_0x33a885['data'],{appId:_0x585795}=_0x276ed2;switch(_0x40b69b['type']){case'ready':this['events']['onReady'](_0x585795),v['info']('Worker\x20ready',{'appId':_0x585795,'version':_0x276ed2['version']});break;case'log':{let {level:_0x2010bb='info',message:_0x3d70e8,meta:_0x1a6ae7}=_0x40b69b,_0x8c966={..._0x1a6ae7||{},'appId':_0x585795,'version':_0x276ed2['version']};this['events']['onLog'](_0x585795,_0x2010bb,_0x3d70e8,_0x8c966);break;}case'result':{let {reqId:_0x196cbc,ok:_0x55bfc4,response:_0x47fc36,error:_0x4ccf8d}=_0x40b69b,_0x3fa415=this['pending']['get'](_0x196cbc);if(!_0x3fa415){v['warn']('Unknown\x20request',{'appId':_0x585795,'reqId':_0x196cbc});return;}if(this['pending']['delete'](_0x196cbc),_0x55bfc4&&_0x47fc36)_0x3fa415['resolve'](_0x47fc36);else{let _0x641ff7=new Error(_0x4ccf8d?.['message']||'Worker\x20error');_0x641ff7['stack']=_0x4ccf8d?.['stack'],_0x3fa415['reject'](_0x641ff7);}this['events']['onResult'](_0x585795,_0x196cbc,_0x47fc36||_0x4ccf8d);break;}default:v['debug']('Unknown\x20message',{'appId':_0x585795,'type':_0x40b69b['type']});}},_0x276ed2['worker']['onerror']=_0x8c84c2=>{let {appId:_0x2de1b6}=_0x276ed2;v['error']('Worker\x20error',{'appId':_0x2de1b6,'message':_0x8c84c2['message'],'lineno':_0x8c84c2['lineno'],'filename':_0x8c84c2['filename']}),_0x276ed2['status']='crashed',this['rejectPending'](_0x2de1b6,new Error('Worker\x20'+_0x2de1b6+'\x20crashed:\x20'+_0x8c84c2['message'])),_0x8c84c2['preventDefault']();},_0x276ed2['worker']['onmessageerror']=_0x5f1974=>{let {appId:_0x7660ef}=_0x276ed2;v['error']('Message\x20error',{'appId':_0x7660ef,'data':_0x5f1974['data']}),_0x276ed2['status']='crashed',_0x5f1974['preventDefault']();};}['sendInit'](_0x559bba,_0x3de918,_0x5d126b,_0x55adfb){_0x559bba['worker']['postMessage']({'type':'init','appId':_0x559bba['appId'],'manifest':_0x5d126b,'appsDir':_0x3de918,'serverPath':_0x55adfb});}async['sendInvoke'](_0x5a3cd8,_0x1413d2){let _0x365f7e=this['nextId'](),_0x4c6185=_0x5a3cd8['appId'],_0x4cc0d0=new Promise((_0x15ea75,_0x40a770)=>{let _0x25a813=setTimeout(()=>{this['pending']['delete'](_0x365f7e),_0x40a770(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x365f7e,{'resolve':_0x46bfbf=>{clearTimeout(_0x25a813),_0x15ea75(_0x46bfbf);},'reject':_0x4ce61b=>{clearTimeout(_0x25a813),_0x40a770(_0x4ce61b);},'timestamp':Date['now'](),'appId':_0x4c6185});});return _0x5a3cd8['worker']['postMessage']({'type':'invoke','appId':_0x5a3cd8['appId'],'reqId':_0x365f7e,'payload':_0x1413d2}),await _0x4cc0d0;}['rejectPending'](_0x328cc8,_0x1ec1a2){let _0x2cc5e2=0x0;for(let [_0x49733d,_0x32a908]of this['pending']['entries']())_0x32a908['appId']===_0x328cc8&&(this['pending']['delete'](_0x49733d),_0x32a908['reject'](_0x1ec1a2),_0x2cc5e2++);_0x2cc5e2>0x0&&v['warn']('Rejected\x20'+_0x2cc5e2+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x328cc8});}['cleanupTimeout'](){let _0x3b6967=Date['now']();for(let [_0x2c306a,_0x50f22a]of this['pending']['entries']())_0x3b6967-_0x50f22a['timestamp']>this['timeout']&&(this['pending']['delete'](_0x2c306a),_0x50f22a['reject'](new Error('Request\x20'+_0x2c306a+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x4d625d){let _0x26f8ec=0x0;for(let _0x52b20d of this['pending']['values']())_0x52b20d['appId']===_0x4d625d&&_0x26f8ec++;return _0x26f8ec;}['startCleanup'](_0x4d784b=0x2710){let _0x1f30b5=setInterval(()=>{this['cleanupTimeout']();},_0x4d784b);return()=>clearInterval(_0x1f30b5);}};function $(_0x29c30c,_0x518700){return new j(_0x29c30c,_0x518700);}var Q=class{constructor(_0x292929={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x292929['logger']||f,this['config']={'appsDir':_0x292929['appsDir']||this['getAppsDir'](),'scriptUrl':_0x292929['scriptUrl']||this['getScriptUrl'](),'timeout':_0x292929['timeout']||0x78*0x3e8,'autoCleanup':_0x292929['autoCleanup']??!![],'cleanupInterval':_0x292929['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x292929['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x292929['maxWorkers'],'reuseWorkers':_0x292929['reuseWorkers']??!![],'workerReuseStrategy':_0x292929['workerReuseStrategy']||'lru','enableQueue':_0x292929['enableQueue']??!![],'maxQueueSize':_0x292929['maxQueueSize']||0x64,'queueTimeout':_0x292929['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x5b005c=>this['logger']['info']('Worker\x20created',{'appId':_0x5b005c['appId'],'v':_0x5b005c['version']}),'onReady':_0x17c799=>this['lifecycle']['updateStatus'](_0x17c799['appId'],'running'),'onCrash':_0x1c9063=>this['logger']['error']('Worker\x20crashed',{'appId':_0x1c9063['appId'],'v':_0x1c9063['version']}),'onStop':_0x5187f4=>this['logger']['info']('Worker\x20stopped',{'appId':_0x5187f4['appId'],'v':_0x5187f4['version']})}),this['messaging']=$({'onReady':_0x4c491c=>this['lifecycle']['updateStatus'](_0x4c491c,'running'),'onLog':(_0xfb449f,_0x5ddccc,_0x24803a,_0x1a3eff)=>{let _0x3479cb={..._0x1a3eff||{},'appId':_0xfb449f};switch(_0x5ddccc){case'error':this['logger']['error'](_0x24803a,_0x3479cb);break;case'warn':this['logger']['warn'](_0x24803a,_0x3479cb);break;case'debug':this['logger']['debug'](_0x24803a,_0x3479cb);break;default:this['logger']['info'](_0x24803a,_0x3479cb);break;}},'onResult':(_0x1e78e6,_0x4ac793,_0x36756a)=>{this['logger']['debug']('Result\x20received',{'appId':_0x1e78e6,'reqId':_0x4ac793});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x30d3ef['cwd'](),'apps');}['getScriptUrl'](){let _0x5a3529=import.meta.url,_0x42380f=_0x5a3529['endsWith']('.js')||_0x5a3529['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x42380f,_0x5a3529)['href'];}async['ensure'](_0xfd11d1){let {id:_0x1983a4}=_0xfd11d1,_0x488ec8=this['lifecycle']['get'](_0x1983a4);if(_0x488ec8){let _0xdec55b=this['lifecycle']['checkHealth'](_0x1983a4);if(_0xdec55b['healthy'])return this['lifecycle']['touch'](_0x1983a4),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x1983a4}),_0x488ec8;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x1983a4,'reason':_0xdec55b['reason']}),await this['lifecycle']['stop'](_0x1983a4);}for(;;){let _0x58b860=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x58b860>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x58b860,'max':this['config']['maxWorkers'],'appId':_0x1983a4}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0xfd11d1);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x4468c9=await this['loadManifest'](_0x1983a4,_0xfd11d1['manifest']),_0x407515=await this['lifecycle']['create'](_0x1983a4,_0x4468c9,this['config']['scriptUrl']),_0xc52119=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0xc52119>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0xc52119,'max':this['config']['maxWorkers'],'appId':_0x1983a4}),await this['lifecycle']['stop'](_0x1983a4),this['config']['enableQueue'])return await this['waitSlot'](_0xfd11d1);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0xc52119+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x407515);let _0x337b21=_0x4468c9['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x407515,this['config']['appsDir'],_0x4468c9,_0x337b21),this['logger']['info']('Worker\x20created',{'appId':_0x1983a4,'v':_0x407515['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x407515;}async['evictIdle'](){let _0x3fd07f=this['lifecycle']['getAll']();if(_0x3fd07f['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x33a398=[..._0x3fd07f];this['config']['workerReuseStrategy']==='lru'?_0x33a398['sort']((_0x50f5a1,_0xf8eb34)=>_0x50f5a1['lastUsed']-_0xf8eb34['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x33a398['sort']((_0x229d25,_0x2b0108)=>_0x229d25['version']-_0x2b0108['version']);let _0xa8f244=null;for(let _0x426f73 of _0x33a398)if(this['messaging']['getAppCount'](_0x426f73['appId'])===0x0){_0xa8f244=_0x426f73;break;}if(!_0xa8f244&&_0x33a398['length']>0x0&&(_0xa8f244=_0x33a398['reduce']((_0x3ddbb2,_0x340a6c)=>{let _0x5df374=this['messaging']['getAppCount'](_0x3ddbb2['appId']);return this['messaging']['getAppCount'](_0x340a6c['appId'])<_0x5df374?_0x340a6c:_0x3ddbb2;})),_0xa8f244){let _0xc01108=this['messaging']['getAppCount'](_0xa8f244['appId']);return _0xc01108>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0xa8f244['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0xa8f244['lastUsed'],'pendingRequests':_0xc01108}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0xa8f244['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0xa8f244['lastUsed']}),await this['lifecycle']['stop'](_0xa8f244['appId']),!![];}return![];}['waitSlot'](_0x1fa71e){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x3ec3eb,_0xda1ece)=>{let _0x1c82ed={'info':_0x1fa71e,'resolve':_0x3ec3eb,'reject':_0xda1ece,'timestamp':Date['now']()};this['requestQueue']['push'](_0x1c82ed),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x1fa71e['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x57fba3=setTimeout(()=>{let _0x5233d5=this['requestQueue']['indexOf'](_0x1c82ed);_0x5233d5!==-0x1&&(this['requestQueue']['splice'](_0x5233d5,0x1),_0xda1ece(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x1c82ed['resolve']=_0x3240f8=>{clearTimeout(_0x57fba3),_0x3ec3eb(_0x3240f8);},_0x1c82ed['reject']=_0x3b8761=>{clearTimeout(_0x57fba3),_0xda1ece(_0x3b8761);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x51aab8=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x51aab8>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x54231d=this['requestQueue']['shift']();if(!_0x54231d)break;try{let _0x7fd9d0=await this['ensure'](_0x54231d['info']);_0x54231d['resolve'](_0x7fd9d0);}catch(_0x2d651e){_0x54231d['reject'](_0x2d651e);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x3cb9a8,_0x210a00){let _0x14deb2=this['config']['appsDir']['replace'](/\\/g,'/'),_0x219578=async _0x235e83=>{try{let _0x368086=globalThis['Deno'];if(!_0x368086)return null;let _0x589320=await _0x368086['readTextFile'](_0x235e83);return JSON['parse'](_0x589320);}catch{return null;}};if(_0x210a00?.['name']){let _0xbe9f93=await _0x219578(_0x14deb2+'/'+_0x210a00['name']+'/manifest.json');if(_0xbe9f93)return _0xbe9f93;}let _0x262369=await _0x219578(_0x14deb2+'/'+_0x3cb9a8+'/manifest.json');if(_0x262369)return _0x262369;try{let _0x45e234=globalThis['Deno'];if(_0x45e234)for await(let _0x110df8 of _0x45e234['readDir'](_0x14deb2)){if(!_0x110df8['isDirectory'])continue;let _0x3345b4=_0x14deb2+'/'+_0x110df8['name']+'/manifest.json',_0x3ae1f7=await _0x219578(_0x3345b4);if(_0x3ae1f7&&(_0x3ae1f7['id']===_0x3cb9a8||_0x210a00?.['name']&&_0x3ae1f7['name']===_0x210a00['name']))return _0x3ae1f7;}}catch(_0x18f3b6){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x3cb9a8,'error':_0x18f3b6['message']});}return _0x210a00||{'id':_0x3cb9a8,'name':_0x3cb9a8,'version':'1.0.0'};}async['invoke'](_0x4756ad){let _0x59895c=_0x4756ad['ctx']['app']['id'],_0xe69c7a=_0x4756ad['ctx']['app']['name'];try{let _0x2d0df0={'id':_0x59895c,'manifest':{'id':_0x59895c,'name':_0xe69c7a}},_0x414533=await this['ensure'](_0x2d0df0);if(_0x414533['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x59895c}),await this['restart'](_0x59895c);let _0x1f6053=await this['ensure'](_0x2d0df0);return this['lifecycle']['touch'](_0x59895c),await this['messaging']['sendInvoke'](_0x1f6053,_0x4756ad);}return this['lifecycle']['touch'](_0x59895c),await this['messaging']['sendInvoke'](_0x414533,_0x4756ad);}catch(_0x39bd57){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x59895c,'error':_0x39bd57['message'],'stack':_0x39bd57['stack']}),_0x39bd57;}}async['stop'](_0x1ab130){await this['lifecycle']['stop'](_0x1ab130),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x33cd55){return await this['lifecycle']['restart'](_0x33cd55,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x332802=>({'appId':_0x332802['appId'],'status':_0x332802['status'],'version':_0x332802['version'],'lastUsed':_0x332802['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x3b4c59=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x529131=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x3b4c59(),_0x529131();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x2137b0=>{_0x2137b0?(await this['stop'](_0x2137b0),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x2137b0})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x459af0){return new Q(_0x459af0);}var S=null;function be(_0x53582f){S=ee(_0x53582f);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x393ddc){return await k()['ensure'](_0x393ddc);}async function xe(_0x4a6228){return await k()['invoke'](_0x4a6228);}function Ie(_0x51e57a){k()['stop'](_0x51e57a)['catch'](_0x3d36cb=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x51e57a,'error':_0x3d36cb['message']});});}function Re(){k()['stopAll']()['catch'](_0x321385=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x321385['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x1f2f6e){await k()['stop'](_0x1f2f6e);}async function Se(){await k()['stopAll']();}function Ae(_0x5446c9){let _0xcbc37=_0x5446c9&&typeof _0x5446c9=='object'?_0x5446c9:null;if(_0xcbc37&&'user'in _0xcbc37)return _0xcbc37['user'];}function H(_0x4aa3b5){let _0x331dc7=_0x4aa3b5&&typeof _0x4aa3b5=='object'?_0x4aa3b5:null;if(!_0x331dc7)return{};let _0x335fff={};for(let [_0x4398b3,_0xa853b7]of Object['entries'](_0x331dc7))_0x4398b3!=='user'&&(_0x335fff[_0x4398b3]=_0xa853b7);return _0x335fff;}function O(_0x1cb24f){return _0x1cb24f?{'id':_0x1cb24f['manifest']?.['id']||_0x1cb24f['id']||'','name':_0x1cb24f['manifest']?.['name']||'','version':_0x1cb24f['manifest']?.['version']||'','description':_0x1cb24f['manifest']?.['description']||'','icon':_0x1cb24f['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x11476d){return _0x11476d?.['permissions']||_0x11476d?.['manifest']?.['permissions']||{};}function F(_0x435249){return _0x435249?.['manifest']?.['metadata']||{};}function Ce(_0x43ae74){return _0x43ae74?{'appId':_0x43ae74['id'],'appName':_0x43ae74['manifest']?.['name']}:{};}function N(_0x12bcf2,_0x11013d={}){let {appInfo:_0x4661e5=null,status:_0x2beacd=0x1f4,defaultMessage:_0x41e0fa='Internal\x20Server\x20Error'}=_0x11013d,_0x4d0429={'error':_0x41e0fa,'message':_0x12bcf2?.['message']||_0x41e0fa};return _0x4661e5&&(_0x4d0429['appId']=_0x4661e5['id'],_0x4d0429['appName']=_0x4661e5['manifest']?.['name']),_0x12bcf2?.['message']?.['includes']('crashed')&&(_0x4d0429['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x2beacd,'body':_0x4d0429};}function qe(_0x170f1c){return _0x170f1c?.['message']?.['includes']('crashed')||![];}function J(_0x572c04){if(_0x572c04)try{return JSON['parse'](_0x572c04);}catch{return _0x572c04;}}function B(_0x40699f){try{let _0x367703=new URL(_0x40699f),_0x327d43={};for(let _0x541cc1 of _0x367703['searchParams']['keys']()){let _0x4044c0=_0x367703['searchParams']['getAll'](_0x541cc1)['map'](_0x4aa947=>_0x4aa947);_0x4044c0['length']<=0x1?_0x327d43[_0x541cc1]=_0x4044c0[0x0]??'':_0x327d43[_0x541cc1]=_0x4044c0;}return _0x327d43;}catch{return{};}}function Le(_0x5a953f){return(()=>{try{return new URL(_0x5a953f)['pathname'];}catch{return _0x5a953f;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x571ed8,_0x506061){let _0x7955c2=_0x571ed8;if(_0x506061&&_0x7955c2['startsWith']('/apps/'+_0x506061))_0x7955c2=_0x7955c2['substring'](('/apps/'+_0x506061)['length'])||'/';else{let _0x4231cc=_0x7955c2['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x4231cc&&(_0x7955c2=_0x4231cc[0x1]||'/');}return _0x7955c2['startsWith']('/api')&&(_0x7955c2=_0x7955c2['substring'](0x4)||'/'),_0x7955c2;}function Ue(_0x7a9d4b,_0xbe37be){let _0x4b3797=_0x7a9d4b;if(_0xbe37be&&_0x4b3797['startsWith']('/apps/'+_0xbe37be))_0x4b3797=_0x4b3797['substring'](('/apps/'+_0xbe37be)['length'])||'/';else{let _0x400c97=_0x4b3797['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x400c97&&(_0x4b3797=_0x400c97[0x1]||'/');}return(!_0x4b3797||_0x4b3797==='/')&&(_0x4b3797='/index.html'),_0x4b3797;}async function He(_0x10da4b,_0x2039d3){return await _0x2039d3(_0x10da4b);}function _(_0x3d0da7){return _0x3d0da7['split']('/')['filter'](_0x269440=>_0x269440['length']>0x0);}function te(_0x54f214){try{return decodeURIComponent(_0x54f214);}catch{return _0x54f214;}}function re(_0x473fd0,_0x44f3ce){let _0x1e4fe3=_(_0x473fd0),_0x51c33b=_(_0x44f3ce),_0x2bf450={},_0x5f8bf3=0x0,_0xf375e9=0x0;for(;_0x5f8bf3<_0x1e4fe3['length']&&_0xf375e9<_0x51c33b['length'];){let _0x13cd2a=_0x1e4fe3[_0x5f8bf3],_0x20fccf=_0x51c33b[_0xf375e9];if(_0x13cd2a==='*')break;if(_0x13cd2a['startsWith'](':')){let _0x544b86=_0x13cd2a['slice'](0x1);_0x544b86&&(_0x2bf450[_0x544b86]=te(_0x20fccf)),_0x5f8bf3++,_0xf375e9++;continue;}if(_0x13cd2a!==_0x20fccf)return{};_0x5f8bf3++,_0xf375e9++;}return _0x5f8bf3===_0x1e4fe3['length']||_0x5f8bf3===_0x1e4fe3['length']-0x1&&_0x1e4fe3[_0x5f8bf3]==='*',_0x2bf450;}async function Oe(_0xf69658,_0x45b7a9,_0x34dac6,_0xec2186,_0x5583ba=void 0x0,_0x555c64){let _0x4b069c=await _0x45b7a9['text'](),_0x4d393a=J(_0x4b069c),_0x3809ec=B(_0x45b7a9['url']),_0x460df7={...F(_0xf69658),'user':_0x5583ba},_0xa7d53d=H(_0x460df7),_0x4dca55=_0x555c64?re(_0x555c64,_0x45b7a9['path']):{};return{'app':O(_0xf69658),'permissions':T(_0xf69658),'user':_0x5583ba,'metadata':_0xa7d53d,'body':_0x4d393a,'query':_0x3809ec,'params':_0x4dca55,'method':_0x34dac6,'pathname':_0xec2186,'requestUrl':_0x45b7a9['url'],'headers':Object['fromEntries'](_0x45b7a9['raw']['headers']['entries']())};}function Te(_0x2079a0){return{'method':_0x2079a0['method'],'pathname':_0x2079a0['pathname'],'ctx':_0x2079a0};}function Fe(_0x3c8bc1,_0x283241){let {status:_0x3fd154=0xc8,headers:_0x545f73={},body:_0x23e9ae,type:_0x287ef0}=_0x3c8bc1??{};return _0x287ef0==='raw'?new globalThis['Response'](String(_0x23e9ae??''),{'status':_0x3fd154,'headers':_0x545f73}):_0x283241(_0x23e9ae,_0x3fd154);}function Ne(_0xb015fe,_0x1cedd0=null){return N(_0xb015fe,{'appInfo':_0x1cedd0});}var V=f;async function Ve(_0x4337d1){_0x4337d1?(await U(_0x4337d1),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x4337d1)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x1996e6,_0x2a5ce6){let _0x20aa3b=Object['fromEntries'](Object['entries'](_0x1996e6['headers']||{})['map'](([_0x2129d2,_0x5bf841])=>[_0x2129d2['toLowerCase'](),_0x5bf841]));return{'id':_0x1996e6['app']['id']||_0x2a5ce6['appId']||'','name':_0x1996e6['app']['name']||'','version':_0x1996e6['app']['version']||'','description':_0x1996e6['app']['description']||'','metadata':{..._0x1996e6['metadata'],'permissions':_0x1996e6['permissions']},'body':_0x1996e6['body'],'query':_0x1996e6['query'],'params':_0x1996e6?.['params'],'method':_0x1996e6['method'],'pathname':_0x1996e6['pathname'],'requestUrl':_0x1996e6['requestUrl'],'user':_0x1996e6['user'],'headers':_0x20aa3b};}var L=class{constructor(_0x37911c){this['handle']=null,(this['config']=_0x37911c,this['logger']=_0x37911c['logger']||f,this['lifecycle']=W({'appsDir':_0x37911c['appsDir'],'timeout':_0x37911c['timeout'],'platformImports':_0x37911c['platformImports'],'libDir':_0x37911c['libDir']},{'onCreate':_0x1fb808=>this['logger']['info']('Worker\x20created',{'appId':_0x1fb808['appId']}),'onReady':_0x45b8c7=>{this['lifecycle']['updateStatus'](_0x45b8c7['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x45b8c7['appId']});},'onCrash':_0x20a775=>this['logger']['error']('Worker\x20crashed',{'appId':_0x20a775['appId']}),'onStop':_0x379e21=>this['logger']['info']('Worker\x20stopped',{'appId':_0x379e21['appId']})}),this['messaging']=$({'onReady':_0x54fe18=>this['lifecycle']['updateStatus'](_0x54fe18,'running'),'onLog':(_0x4885e1,_0x2219eb,_0x263828,_0x50c0ba)=>{(this['logger'][_0x2219eb]||this['logger']['info'])['call'](this['logger'],_0x263828,_0x50c0ba);},'onResult':()=>{}},_0x37911c['timeout']||0x1d4c0));}async['create'](_0x2a2892){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x2ba3b7=await this['lifecycle']['create'](this['config']['appId'],_0x2a2892,this['config']['scriptUrl']);this['messaging']['setup'](_0x2ba3b7),this['messaging']['sendInit'](_0x2ba3b7,this['config']['appsDir'],_0x2a2892,this['config']['serverPath']),this['handle']=_0x2ba3b7,await this['waitForReady']();}async['waitForReady'](_0x28f069=0x2710){let _0x38449a=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x38449a>_0x28f069)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x4958ea=>setTimeout(_0x4958ea,0x64));}}async['invoke'](_0x2eb02b){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x2eb02b);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x95693a){return new L(_0x95693a);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};