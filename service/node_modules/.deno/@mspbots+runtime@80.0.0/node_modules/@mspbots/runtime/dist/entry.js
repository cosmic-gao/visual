function c(_0x2b1654,_0x22a6bd){let _0x366646=Object['fromEntries'](Object['entries'](_0x2b1654['headers']||{})['map'](([_0x671fc3,_0x1b63b2])=>[_0x671fc3['toLowerCase'](),_0x1b63b2]));return{'id':_0x2b1654['app']['id']||_0x22a6bd['appId']||'','name':_0x2b1654['app']['name']||'','version':_0x2b1654['app']['version']||'','description':_0x2b1654['app']['description']||'','metadata':{..._0x2b1654['metadata'],'permissions':_0x2b1654['permissions']},'body':_0x2b1654['body'],'query':_0x2b1654['query'],'params':_0x2b1654?.['params'],'method':_0x2b1654['method'],'pathname':_0x2b1654['pathname'],'requestUrl':_0x2b1654['requestUrl'],'user':_0x2b1654['user'],'headers':_0x366646};}function f(_0x4bbf15){return _0x4bbf15['split']('/')['filter'](_0x369755=>_0x369755['length']>0x0);}function P(_0x8e4986,_0x4777f4){let _0x8793e3=f(_0x8e4986),_0x185c6b=f(_0x4777f4),_0x45b438=0x0,_0x942483=0x0;for(;_0x45b438<_0x8793e3['length']&&_0x942483<_0x185c6b['length'];){let _0x335dcb=_0x8793e3[_0x45b438],_0xe42ad3=_0x185c6b[_0x942483];if(_0x335dcb==='*')return!![];if(_0x335dcb['startsWith'](':')){_0x45b438++,_0x942483++;continue;}if(_0x335dcb!==_0xe42ad3)return![];_0x45b438++,_0x942483++;}return _0x45b438===_0x8793e3['length']&&_0x942483===_0x185c6b['length']||_0x45b438===_0x8793e3['length']-0x1&&_0x8793e3[_0x45b438]==='*';}function m(_0x1aaeef,_0x56b084,_0x185812){let _0x21b0ef=_0x56b084+'\x20'+_0x185812;if(_0x1aaeef[_0x21b0ef])return{'handler':_0x1aaeef[_0x21b0ef],'routePattern':_0x185812};let _0x46c1f5=[];_0x185812['startsWith']('/api')?_0x46c1f5['push'](_0x185812['substring'](0x4)||'/'):_0x46c1f5['push']('/api'+_0x185812),_0x46c1f5['push'](_0x185812);for(let _0x159df4 of _0x46c1f5)for(let _0x15c554 of Object['keys'](_0x1aaeef)){if(!_0x15c554['startsWith'](_0x56b084+'\x20'))continue;let _0x2f2a25=_0x15c554['substring'](_0x56b084['length']+0x1);if(P(_0x2f2a25,_0x159df4))return{'handler':_0x1aaeef[_0x15c554],'routePattern':_0x2f2a25};}return null;}function k(_0x73d1da){return typeof _0x73d1da=='function'?{'handler':_0x73d1da,'routePattern':''}:_0x73d1da;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x14f5db){let _0xbea920=async _0x4850cf=>{try{let _0x575080=globalThis['Deno'];if(!_0x575080)throw new Error('Deno is not available');return await _0x575080['stat'](_0x4850cf),!0x0;}catch{return![];}};if(_0x14f5db&&typeof _0x14f5db=='string'&&_0x14f5db['length']>0x0)return _0x14f5db;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x1c20ce=s['manifest']?.['metadata']?.['serverPath'];if(_0x1c20ce&&typeof _0x1c20ce=='string'&&_0x1c20ce['length']>0x0)return _0x1c20ce;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x496a23=s['manifest']['name'];if(!_0x496a23)throw new Error('Manifest\x20name\x20not\x20found');let _0x5829ac=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x496a23+'/server.js',s['appsDir']+'/'+_0x496a23+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x440b81 of _0x5829ac)if(await _0xbea920(_0x440b81))return _0x440b81;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x5829ac['join'](',\x20'));}function R(){let _0xe61d8d=['log','info','warn','error','debug','trace'];for(let _0x196d77 of _0xe61d8d){let _0x5b8834=(console[_0x196d77]||console['log'])['bind'](console);console[_0x196d77]=(..._0x5a661e)=>{try{let _0x1a3d20=_0x5a661e['map'](_0x641003=>{if(typeof _0x641003=='string')return _0x641003;if(_0x641003 instanceof Error)return JSON['stringify']({'name':_0x641003['name'],'message':_0x641003['message'],'stack':_0x641003['stack']});if(typeof Request<'u'&&_0x641003 instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x641003['url'],'method':_0x641003['method'],'headers':Object['fromEntries'](_0x641003['headers']['entries']()),'bodyUsed':_0x641003['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x641003 instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x641003['status'],'headers':Object['fromEntries'](_0x641003['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x641003);}catch{return String(_0x641003);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x196d77==='log'?'info':_0x196d77,'message':_0x1a3d20,'meta':{'appId':s['appId']}});}catch{_0x5b8834(..._0x5a661e);}};}}R();async function v(_0x2d3ea3){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x39c2e7=(await w(_0x2d3ea3))['replace'](/\\/g,'/'),_0x3ae2a9=(_0x39c2e7['startsWith']('file://')?_0x39c2e7:'file://'+_0x39c2e7)+'?t='+Date['now']();try{let _0x114f5c=await import(_0x3ae2a9);return s['module']=_0x114f5c,_0x114f5c;}catch(_0x49d063){throw console['error']('Failed to load module:',_0x49d063),_0x49d063;}}function b(_0x1153b7){return _0x1153b7 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x1153b7,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0xf181d5){return _0xf181d5['split']('/')['filter'](_0x60c1db=>_0x60c1db['length']>0x0);}function E(_0x262549){try{return decodeURIComponent(_0x262549);}catch{return _0x262549;}}function I(_0x5cddd9,_0x4afe33){let _0x2d3354=g(_0x5cddd9),_0x32bc66=g(_0x4afe33),_0x136739={},_0x249a1c=0x0,_0x13a98f=0x0;for(;_0x249a1c<_0x2d3354['length']&&_0x13a98f<_0x32bc66['length'];){let _0x2721f7=_0x2d3354[_0x249a1c],_0x3ad422=_0x32bc66[_0x13a98f];if(_0x2721f7==='*')break;if(_0x2721f7['startsWith'](':')){let _0x33ea0e=_0x2721f7['slice'](0x1);_0x33ea0e&&(_0x136739[_0x33ea0e]=E(_0x3ad422)),_0x249a1c++,_0x13a98f++;continue;}if(_0x2721f7!==_0x3ad422)return{};_0x249a1c++,_0x13a98f++;}return _0x249a1c===_0x2d3354['length']||_0x249a1c===_0x2d3354['length']-0x1&&_0x2d3354[_0x249a1c]==='*',_0x136739;}function M(_0x13ccb6,_0x241dda){return _0x13ccb6['startsWith']('/api')&&!_0x241dda['startsWith']('/api')?_0x13ccb6['substring'](0x4)||'/':!_0x13ccb6['startsWith']('/api')&&_0x241dda['startsWith']('/api')?'/api'+(_0x13ccb6['startsWith']('/')?'':'/')+_0x13ccb6:_0x13ccb6;}async function W(_0x1cdbae){let _0x100011=_0x1cdbae['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x100011)&&await v(_0x100011);let _0x178b9b=_0x1cdbae['ctx'],{method:_0x2bbf59,pathname:_0x10372e}=_0x178b9b,_0x57a31e=s['module']?.['default']||{},_0x4344fa=m(_0x57a31e,_0x2bbf59,_0x10372e);if(!_0x4344fa)throw Object['assign'](new Error('Route\x20'+_0x2bbf59+'\x20'+_0x10372e+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x3c09a7=k(_0x4344fa),_0xe3caf7=c(_0x178b9b,s),_0xbe220a=_0x10372e,_0x1f0150=M(_0x3c09a7['routePattern'],_0xbe220a),_0x3263c2=_0x1f0150?I(_0x1f0150,_0xbe220a):{},_0x12ccb1=await _0x3c09a7['handler']({..._0xe3caf7,'params':{..._0xe3caf7['params'],..._0x3263c2}});return b(_0x12ccb1);}function D(_0x2ed565){s['appId']=_0x2ed565['appId'],s['manifest']=_0x2ed565['manifest'],s['appsDir']=_0x2ed565['appsDir'],s['serverPath']=_0x2ed565['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x1044f5){let {reqId:_0x579d8e,payload:_0x24e70d}=_0x1044f5;try{let _0x4a2d9b=await W(_0x24e70d);self['postMessage']({'type':'result','reqId':_0x579d8e,'ok':!0x0,'response':_0x4a2d9b});}catch(_0x1dd6e6){let _0x4550c3=_0x1dd6e6;self['postMessage']({'type':'result','reqId':_0x579d8e,'ok':![],'error':{'message':_0x4550c3['message'],'stack':_0x4550c3['stack'],'code':_0x4550c3['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x53f129=>{let _0x241804=_0x53f129['data'];try{switch(_0x241804['type']){case'init':D(_0x241804);break;case'invoke':await $(_0x241804);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x241804['type']);break;}}catch(_0x5eab17){let _0x393bb4=_0x5eab17;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x393bb4['message'],'stack':_0x393bb4['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x393bb4);}}},self['onerror']=_0x4c17d4=>{let _0x44bf39={'message':typeof _0x4c17d4=='string'?_0x4c17d4:_0x4c17d4['message'],'filename':typeof _0x4c17d4=='string'?void 0x0:_0x4c17d4['filename'],'lineno':typeof _0x4c17d4=='string'?void 0x0:_0x4c17d4['lineno'],'colno':typeof _0x4c17d4=='string'?void 0x0:_0x4c17d4['colno'],'error':typeof _0x4c17d4=='string'?void 0x0:_0x4c17d4['error']?.['message'],'stack':typeof _0x4c17d4=='string'?void 0x0:_0x4c17d4['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x44bf39);},self['onunhandledrejection']=_0x1b90de=>{let _0x59c797=_0x1b90de['reason'],_0x4ecb1d={'appId':s['appId'],'reason':_0x59c797 instanceof Error?_0x59c797['message']:String(_0x59c797),'stack':_0x59c797 instanceof Error?_0x59c797['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x4ecb1d);};