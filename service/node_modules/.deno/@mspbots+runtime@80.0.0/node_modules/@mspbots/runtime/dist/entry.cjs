'use strict';function c(_0x447780,_0x4b8d98){let _0x39009b=Object['fromEntries'](Object['entries'](_0x447780['headers']||{})['map'](([_0x345ab8,_0x3525f1])=>[_0x345ab8['toLowerCase'](),_0x3525f1]));return{'id':_0x447780['app']['id']||_0x4b8d98['appId']||'','name':_0x447780['app']['name']||'','version':_0x447780['app']['version']||'','description':_0x447780['app']['description']||'','metadata':{..._0x447780['metadata'],'permissions':_0x447780['permissions']},'body':_0x447780['body'],'query':_0x447780['query'],'params':_0x447780?.['params'],'method':_0x447780['method'],'pathname':_0x447780['pathname'],'requestUrl':_0x447780['requestUrl'],'user':_0x447780['user'],'headers':_0x39009b};}function f(_0x30c673){return _0x30c673['split']('/')['filter'](_0x246bd9=>_0x246bd9['length']>0x0);}function P(_0x251ee8,_0x3a84d2){let _0x52eaa9=f(_0x251ee8),_0x58c3da=f(_0x3a84d2),_0x39bc0b=0x0,_0x48bc9a=0x0;for(;_0x39bc0b<_0x52eaa9['length']&&_0x48bc9a<_0x58c3da['length'];){let _0xe2b5b6=_0x52eaa9[_0x39bc0b],_0x2c151f=_0x58c3da[_0x48bc9a];if(_0xe2b5b6==='*')return!![];if(_0xe2b5b6['startsWith'](':')){_0x39bc0b++,_0x48bc9a++;continue;}if(_0xe2b5b6!==_0x2c151f)return![];_0x39bc0b++,_0x48bc9a++;}return _0x39bc0b===_0x52eaa9['length']&&_0x48bc9a===_0x58c3da['length']||_0x39bc0b===_0x52eaa9['length']-0x1&&_0x52eaa9[_0x39bc0b]==='*';}function m(_0x494045,_0x280070,_0x1a85a5){let _0x228aa7=_0x280070+'\x20'+_0x1a85a5;if(_0x494045[_0x228aa7])return{'handler':_0x494045[_0x228aa7],'routePattern':_0x1a85a5};let _0x5aec79=[];_0x1a85a5['startsWith']('/api')?_0x5aec79['push'](_0x1a85a5['substring'](0x4)||'/'):_0x5aec79['push']('/api'+_0x1a85a5),_0x5aec79['push'](_0x1a85a5);for(let _0x14dc30 of _0x5aec79)for(let _0x4a62ca of Object['keys'](_0x494045)){if(!_0x4a62ca['startsWith'](_0x280070+'\x20'))continue;let _0x2e5898=_0x4a62ca['substring'](_0x280070['length']+0x1);if(P(_0x2e5898,_0x14dc30))return{'handler':_0x494045[_0x4a62ca],'routePattern':_0x2e5898};}return null;}function k(_0xab0724){return typeof _0xab0724=='function'?{'handler':_0xab0724,'routePattern':''}:_0xab0724;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x34a1d2){let _0x5d13b3=async _0x44d0f8=>{try{let _0x308041=globalThis['Deno'];if(!_0x308041)throw new Error('Deno is not available');return await _0x308041['stat'](_0x44d0f8),!0x0;}catch{return![];}};if(_0x34a1d2&&typeof _0x34a1d2=='string'&&_0x34a1d2['length']>0x0)return _0x34a1d2;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x436df5=s['manifest']?.['metadata']?.['serverPath'];if(_0x436df5&&typeof _0x436df5=='string'&&_0x436df5['length']>0x0)return _0x436df5;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x539b55=s['manifest']['name'];if(!_0x539b55)throw new Error('Manifest\x20name\x20not\x20found');let _0x171233=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x539b55+'/server.js',s['appsDir']+'/'+_0x539b55+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x2a2fe4 of _0x171233)if(await _0x5d13b3(_0x2a2fe4))return _0x2a2fe4;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x171233['join'](',\x20'));}function R(){let _0x56d3fc=['log','info','warn','error','debug','trace'];for(let _0x589551 of _0x56d3fc){let _0x87742c=(console[_0x589551]||console['log'])['bind'](console);console[_0x589551]=(..._0x1d97a0)=>{try{let _0x497809=_0x1d97a0['map'](_0xa544a0=>{if(typeof _0xa544a0=='string')return _0xa544a0;if(_0xa544a0 instanceof Error)return JSON['stringify']({'name':_0xa544a0['name'],'message':_0xa544a0['message'],'stack':_0xa544a0['stack']});if(typeof Request<'u'&&_0xa544a0 instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0xa544a0['url'],'method':_0xa544a0['method'],'headers':Object['fromEntries'](_0xa544a0['headers']['entries']()),'bodyUsed':_0xa544a0['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0xa544a0 instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0xa544a0['status'],'headers':Object['fromEntries'](_0xa544a0['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0xa544a0);}catch{return String(_0xa544a0);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x589551==='log'?'info':_0x589551,'message':_0x497809,'meta':{'appId':s['appId']}});}catch{_0x87742c(..._0x1d97a0);}};}}R();async function v(_0xb52ed5){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0xf45f88=(await w(_0xb52ed5))['replace'](/\\/g,'/'),_0x4818ca=(_0xf45f88['startsWith']('file://')?_0xf45f88:'file://'+_0xf45f88)+'?t='+Date['now']();try{let _0x19e88e=await import(_0x4818ca);return s['module']=_0x19e88e,_0x19e88e;}catch(_0x1988c0){throw console['error']('Failed to load module:',_0x1988c0),_0x1988c0;}}function b(_0x2943da){return _0x2943da instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x2943da,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x185415){return _0x185415['split']('/')['filter'](_0x2caf05=>_0x2caf05['length']>0x0);}function E(_0x1be14f){try{return decodeURIComponent(_0x1be14f);}catch{return _0x1be14f;}}function I(_0x47d80b,_0x3a3e89){let _0x2a23e4=g(_0x47d80b),_0x8a93d1=g(_0x3a3e89),_0x2d5e1a={},_0x214bfa=0x0,_0x401679=0x0;for(;_0x214bfa<_0x2a23e4['length']&&_0x401679<_0x8a93d1['length'];){let _0x2f94b1=_0x2a23e4[_0x214bfa],_0x4ff0ad=_0x8a93d1[_0x401679];if(_0x2f94b1==='*')break;if(_0x2f94b1['startsWith'](':')){let _0x5ac83f=_0x2f94b1['slice'](0x1);_0x5ac83f&&(_0x2d5e1a[_0x5ac83f]=E(_0x4ff0ad)),_0x214bfa++,_0x401679++;continue;}if(_0x2f94b1!==_0x4ff0ad)return{};_0x214bfa++,_0x401679++;}return _0x214bfa===_0x2a23e4['length']||_0x214bfa===_0x2a23e4['length']-0x1&&_0x2a23e4[_0x214bfa]==='*',_0x2d5e1a;}function M(_0x4a31fa,_0x33f5f6){return _0x4a31fa['startsWith']('/api')&&!_0x33f5f6['startsWith']('/api')?_0x4a31fa['substring'](0x4)||'/':!_0x4a31fa['startsWith']('/api')&&_0x33f5f6['startsWith']('/api')?'/api'+(_0x4a31fa['startsWith']('/')?'':'/')+_0x4a31fa:_0x4a31fa;}async function W(_0x37ea45){let _0x2fecf3=_0x37ea45['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x2fecf3)&&await v(_0x2fecf3);let _0x5b9fa9=_0x37ea45['ctx'],{method:_0x1bdd77,pathname:_0x2fc654}=_0x5b9fa9,_0x56e525=s['module']?.['default']||{},_0x4681d1=m(_0x56e525,_0x1bdd77,_0x2fc654);if(!_0x4681d1)throw Object['assign'](new Error('Route\x20'+_0x1bdd77+'\x20'+_0x2fc654+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x28908b=k(_0x4681d1),_0xbbda40=c(_0x5b9fa9,s),_0x2f8b83=_0x2fc654,_0x128f3e=M(_0x28908b['routePattern'],_0x2f8b83),_0x1b9969=_0x128f3e?I(_0x128f3e,_0x2f8b83):{},_0x5aef66=await _0x28908b['handler']({..._0xbbda40,'params':{..._0xbbda40['params'],..._0x1b9969}});return b(_0x5aef66);}function D(_0x21707e){s['appId']=_0x21707e['appId'],s['manifest']=_0x21707e['manifest'],s['appsDir']=_0x21707e['appsDir'],s['serverPath']=_0x21707e['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x4c327f){let {reqId:_0x48c1b8,payload:_0x174a70}=_0x4c327f;try{let _0x4781d6=await W(_0x174a70);self['postMessage']({'type':'result','reqId':_0x48c1b8,'ok':!0x0,'response':_0x4781d6});}catch(_0x3fe4b2){let _0x52edc5=_0x3fe4b2;self['postMessage']({'type':'result','reqId':_0x48c1b8,'ok':![],'error':{'message':_0x52edc5['message'],'stack':_0x52edc5['stack'],'code':_0x52edc5['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x22422a=>{let _0x462882=_0x22422a['data'];try{switch(_0x462882['type']){case'init':D(_0x462882);break;case'invoke':await $(_0x462882);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x462882['type']);break;}}catch(_0x23bcca){let _0x48086d=_0x23bcca;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x48086d['message'],'stack':_0x48086d['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x48086d);}}},self['onerror']=_0x3de02b=>{let _0x4214cf={'message':typeof _0x3de02b=='string'?_0x3de02b:_0x3de02b['message'],'filename':typeof _0x3de02b=='string'?void 0x0:_0x3de02b['filename'],'lineno':typeof _0x3de02b=='string'?void 0x0:_0x3de02b['lineno'],'colno':typeof _0x3de02b=='string'?void 0x0:_0x3de02b['colno'],'error':typeof _0x3de02b=='string'?void 0x0:_0x3de02b['error']?.['message'],'stack':typeof _0x3de02b=='string'?void 0x0:_0x3de02b['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x4214cf);},self['onunhandledrejection']=_0x40761c=>{let _0x3dc69a=_0x40761c['reason'],_0x4b08ab={'appId':s['appId'],'reason':_0x3dc69a instanceof Error?_0x3dc69a['message']:String(_0x3dc69a),'stack':_0x3dc69a instanceof Error?_0x3dc69a['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x4b08ab);};