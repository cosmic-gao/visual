'use strict';function c(_0x2e4eff,_0x18e38e){let _0x54299d=Object['fromEntries'](Object['entries'](_0x2e4eff['headers']||{})['map'](([_0x14adad,_0x2a4549])=>[_0x14adad['toLowerCase'](),_0x2a4549]));return{'id':_0x2e4eff['app']['id']||_0x18e38e['appId']||'','name':_0x2e4eff['app']['name']||'','version':_0x2e4eff['app']['version']||'','description':_0x2e4eff['app']['description']||'','metadata':{..._0x2e4eff['metadata'],'permissions':_0x2e4eff['permissions']},'body':_0x2e4eff['body'],'query':_0x2e4eff['query'],'params':_0x2e4eff?.['params'],'method':_0x2e4eff['method'],'pathname':_0x2e4eff['pathname'],'requestUrl':_0x2e4eff['requestUrl'],'user':_0x2e4eff['user'],'headers':_0x54299d};}function f(_0x558c46){return _0x558c46['split']('/')['filter'](_0x28e9c5=>_0x28e9c5['length']>0x0);}function P(_0x542f4e,_0x4f9b99){let _0x1fd929=f(_0x542f4e),_0x49f8af=f(_0x4f9b99),_0x2997c7=0x0,_0x1dd71a=0x0;for(;_0x2997c7<_0x1fd929['length']&&_0x1dd71a<_0x49f8af['length'];){let _0x9a3438=_0x1fd929[_0x2997c7],_0x2c1006=_0x49f8af[_0x1dd71a];if(_0x9a3438==='*')return!![];if(_0x9a3438['startsWith'](':')){_0x2997c7++,_0x1dd71a++;continue;}if(_0x9a3438!==_0x2c1006)return![];_0x2997c7++,_0x1dd71a++;}return _0x2997c7===_0x1fd929['length']&&_0x1dd71a===_0x49f8af['length']||_0x2997c7===_0x1fd929['length']-0x1&&_0x1fd929[_0x2997c7]==='*';}function m(_0x454237,_0x4205cf,_0x4730bc){let _0x1ffa3a=_0x4205cf+'\x20'+_0x4730bc;if(_0x454237[_0x1ffa3a])return{'handler':_0x454237[_0x1ffa3a],'routePattern':_0x4730bc};let _0x4639e2=[];_0x4730bc['startsWith']('/api')?_0x4639e2['push'](_0x4730bc['substring'](0x4)||'/'):_0x4639e2['push']('/api'+_0x4730bc),_0x4639e2['push'](_0x4730bc);for(let _0x5af650 of _0x4639e2)for(let _0x3fac0b of Object['keys'](_0x454237)){if(!_0x3fac0b['startsWith'](_0x4205cf+'\x20'))continue;let _0x7d829c=_0x3fac0b['substring'](_0x4205cf['length']+0x1);if(P(_0x7d829c,_0x5af650))return{'handler':_0x454237[_0x3fac0b],'routePattern':_0x7d829c};}return null;}function k(_0x6817a4){return typeof _0x6817a4=='function'?{'handler':_0x6817a4,'routePattern':''}:_0x6817a4;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x4e749c){let _0x5ca8c5=async _0x2e415d=>{try{let _0x22246c=globalThis['Deno'];if(!_0x22246c)throw new Error('Deno is not available');return await _0x22246c['stat'](_0x2e415d),!0x0;}catch{return![];}};if(_0x4e749c&&typeof _0x4e749c=='string'&&_0x4e749c['length']>0x0)return _0x4e749c;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x320a1b=s['manifest']?.['metadata']?.['serverPath'];if(_0x320a1b&&typeof _0x320a1b=='string'&&_0x320a1b['length']>0x0)return _0x320a1b;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0x4e6fd8=s['manifest']['name'];if(!_0x4e6fd8)throw new Error('Manifest\x20name\x20not\x20found');let _0x2feddc=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0x4e6fd8+'/server.js',s['appsDir']+'/'+_0x4e6fd8+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x4ef5a8 of _0x2feddc)if(await _0x5ca8c5(_0x4ef5a8))return _0x4ef5a8;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x2feddc['join'](',\x20'));}function R(){let _0x3aa4da=['log','info','warn','error','debug','trace'];for(let _0xf8aef3 of _0x3aa4da){let _0x545fa1=(console[_0xf8aef3]||console['log'])['bind'](console);console[_0xf8aef3]=(..._0x47e568)=>{try{let _0xe9f785=_0x47e568['map'](_0x52acd2=>{if(typeof _0x52acd2=='string')return _0x52acd2;if(_0x52acd2 instanceof Error)return JSON['stringify']({'name':_0x52acd2['name'],'message':_0x52acd2['message'],'stack':_0x52acd2['stack']});if(typeof Request<'u'&&_0x52acd2 instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x52acd2['url'],'method':_0x52acd2['method'],'headers':Object['fromEntries'](_0x52acd2['headers']['entries']()),'bodyUsed':_0x52acd2['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x52acd2 instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x52acd2['status'],'headers':Object['fromEntries'](_0x52acd2['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x52acd2);}catch{return String(_0x52acd2);}})['join']('\x20');self['postMessage']({'type':'log','level':_0xf8aef3==='log'?'info':_0xf8aef3,'message':_0xe9f785,'meta':{'appId':s['appId']}});}catch{_0x545fa1(..._0x47e568);}};}}R();async function v(_0x227292){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x3114f4=(await w(_0x227292))['replace'](/\\/g,'/'),_0x424d05=(_0x3114f4['startsWith']('file://')?_0x3114f4:'file://'+_0x3114f4)+'?t='+Date['now']();try{let _0x38a8b1=await import(_0x424d05);return s['module']=_0x38a8b1,_0x38a8b1;}catch(_0x4e1d72){throw console['error']('Failed to load module:',_0x4e1d72),_0x4e1d72;}}function b(_0x4297a4){return _0x4297a4 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x4297a4,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x1a6a16){return _0x1a6a16['split']('/')['filter'](_0x3034dc=>_0x3034dc['length']>0x0);}function E(_0xbbbcb4){try{return decodeURIComponent(_0xbbbcb4);}catch{return _0xbbbcb4;}}function I(_0x4d9bc6,_0x5e41c4){let _0x4e725f=g(_0x4d9bc6),_0x1ca9f2=g(_0x5e41c4),_0x6dd652={},_0x153965=0x0,_0xc1539b=0x0;for(;_0x153965<_0x4e725f['length']&&_0xc1539b<_0x1ca9f2['length'];){let _0x4bc33d=_0x4e725f[_0x153965],_0xf33932=_0x1ca9f2[_0xc1539b];if(_0x4bc33d==='*')break;if(_0x4bc33d['startsWith'](':')){let _0x35d383=_0x4bc33d['slice'](0x1);_0x35d383&&(_0x6dd652[_0x35d383]=E(_0xf33932)),_0x153965++,_0xc1539b++;continue;}if(_0x4bc33d!==_0xf33932)return{};_0x153965++,_0xc1539b++;}return _0x153965===_0x4e725f['length']||_0x153965===_0x4e725f['length']-0x1&&_0x4e725f[_0x153965]==='*',_0x6dd652;}function M(_0x20f3d1,_0x461052){return _0x20f3d1['startsWith']('/api')&&!_0x461052['startsWith']('/api')?_0x20f3d1['substring'](0x4)||'/':!_0x20f3d1['startsWith']('/api')&&_0x461052['startsWith']('/api')?'/api'+(_0x20f3d1['startsWith']('/')?'':'/')+_0x20f3d1:_0x20f3d1;}async function W(_0x4b8b68){let _0x451f03=_0x4b8b68['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x451f03)&&await v(_0x451f03);let _0x3d919c=_0x4b8b68['ctx'],{method:_0x4cf94a,pathname:_0x390577}=_0x3d919c,_0x2794c5=s['module']?.['default']||{},_0x433b8d=m(_0x2794c5,_0x4cf94a,_0x390577);if(!_0x433b8d)throw Object['assign'](new Error('Route\x20'+_0x4cf94a+'\x20'+_0x390577+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x36e5a9=k(_0x433b8d),_0x1e6851=c(_0x3d919c,s),_0x206b6c=_0x390577,_0x301d12=M(_0x36e5a9['routePattern'],_0x206b6c),_0x2bcc95=_0x301d12?I(_0x301d12,_0x206b6c):{},_0x2340e6=await _0x36e5a9['handler']({..._0x1e6851,'params':{..._0x1e6851['params'],..._0x2bcc95}});return b(_0x2340e6);}function D(_0x3d0bc4){s['appId']=_0x3d0bc4['appId'],s['manifest']=_0x3d0bc4['manifest'],s['appsDir']=_0x3d0bc4['appsDir'],s['serverPath']=_0x3d0bc4['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x431960){let {reqId:_0xc89fa,payload:_0x482633}=_0x431960;try{let _0x1916c6=await W(_0x482633);self['postMessage']({'type':'result','reqId':_0xc89fa,'ok':!0x0,'response':_0x1916c6});}catch(_0x253446){let _0x2d6048=_0x253446;self['postMessage']({'type':'result','reqId':_0xc89fa,'ok':![],'error':{'message':_0x2d6048['message'],'stack':_0x2d6048['stack'],'code':_0x2d6048['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x33a589=>{let _0x225698=_0x33a589['data'];try{switch(_0x225698['type']){case'init':D(_0x225698);break;case'invoke':await $(_0x225698);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x225698['type']);break;}}catch(_0x1222a0){let _0x58d165=_0x1222a0;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x58d165['message'],'stack':_0x58d165['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x58d165);}}},self['onerror']=_0x355c8a=>{let _0x28d87f={'message':typeof _0x355c8a=='string'?_0x355c8a:_0x355c8a['message'],'filename':typeof _0x355c8a=='string'?void 0x0:_0x355c8a['filename'],'lineno':typeof _0x355c8a=='string'?void 0x0:_0x355c8a['lineno'],'colno':typeof _0x355c8a=='string'?void 0x0:_0x355c8a['colno'],'error':typeof _0x355c8a=='string'?void 0x0:_0x355c8a['error']?.['message'],'stack':typeof _0x355c8a=='string'?void 0x0:_0x355c8a['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x28d87f);},self['onunhandledrejection']=_0x4e1061=>{let _0x389971=_0x4e1061['reason'],_0x3394e4={'appId':s['appId'],'reason':_0x389971 instanceof Error?_0x389971['message']:String(_0x389971),'stack':_0x389971 instanceof Error?_0x389971['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x3394e4);};