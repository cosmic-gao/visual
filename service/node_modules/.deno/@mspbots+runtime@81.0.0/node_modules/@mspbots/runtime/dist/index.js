import{join,dirname}from'path';import _0x96666 from'process';import{stat}from'fs/promises';async function ie(_0x5063f2){try{return await stat(_0x5063f2),!0x0;}catch{return![];}}var f={'error':(_0x146170,_0x46104a)=>console['error']('[ERROR]\x20'+_0x146170,_0x46104a),'warn':(_0x3cf16d,_0x30c6fe)=>console['warn']('[WARN]\x20'+_0x3cf16d,_0x30c6fe),'info':(_0x5f27cc,_0x5e02d9)=>console['log']('[INFO]\x20'+_0x5f27cc,_0x5e02d9),'debug':(_0x476249,_0xa00f14)=>console['log']('[DEBUG]\x20'+_0x476249,_0xa00f14)};function z(){let _0x492b22=globalThis['Deno'];if(!_0x492b22)throw new Error('Deno is not available');return _0x492b22;}var D=class{constructor(_0x374f0c,_0x386867='./lib',_0x43ab46={}){this['manifest']=_0x374f0c,this['libDir']=_0x386867,this['platformImports']=_0x43ab46;}['buildPerms'](){let _0x371b90=this['manifest']['permissions']||{},_0x5de8ab={};return _0x371b90['net']!==void 0x0&&(_0x5de8ab['net']=_0x371b90['net']===!![]?!![]:Array['isArray'](_0x371b90['net'])?_0x371b90['net']:[]),_0x371b90['read']!==void 0x0&&(_0x5de8ab['read']=_0x371b90['read']===!![]?!![]:Array['isArray'](_0x371b90['read'])?_0x371b90['read']:[]),_0x371b90['write']!==void 0x0&&(_0x5de8ab['write']=_0x371b90['write']===!![]?!![]:Array['isArray'](_0x371b90['write'])?_0x371b90['write']:[]),_0x371b90['env']!==void 0x0&&(_0x5de8ab['env']=_0x371b90['env']===!![]?!![]:Array['isArray'](_0x371b90['env'])?_0x371b90['env']:[]),_0x371b90['run']!==void 0x0&&(_0x5de8ab['run']=_0x371b90['run']===!![]?!![]:Array['isArray'](_0x371b90['run'])?_0x371b90['run']:[]),_0x371b90['ffi']!==void 0x0&&(_0x5de8ab['ffi']=_0x371b90['ffi']===!![]?!![]:Array['isArray'](_0x371b90['ffi'])?_0x371b90['ffi']:[]),_0x371b90['sys']!==void 0x0&&(_0x5de8ab['sys']=_0x371b90['sys']===!![]?!![]:Array['isArray'](_0x371b90['sys'])?_0x371b90['sys']:[]),_0x371b90['hrtime']!==void 0x0&&(_0x5de8ab['hrtime']=_0x371b90['hrtime']),_0x5de8ab;}['normalize'](_0x3f609a){return _0x3f609a===!![]?[]:Array['isArray'](_0x3f609a)?_0x3f609a:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x3833ab){return join(this['libDir'],_0x3833ab+'@*');}['getReadPaths'](){let _0x1ba61a=this['getImports']();_0x1ba61a['includes']('*')&&(_0x1ba61a=Object['keys'](this['platformImports']));let _0x36bcf2=[];console['log']('[Permissions] Building package path patterns for imports:',_0x1ba61a);for(let _0xabdab7 of _0x1ba61a){let _0x125986=this['getLibPattern'](_0xabdab7);_0x36bcf2['push'](_0x125986),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0xabdab7+'\x20->\x20'+_0x125986);}return console['log']('[Permissions] Final package path patterns:',_0x36bcf2),_0x36bcf2;}['buildImportMap'](_0x1e5421){let _0xe35cd9=this['getImports'](),_0x5b8f34=_0xe35cd9['includes']('*')?Object['keys'](_0x1e5421):_0xe35cd9;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x5b8f34);let _0x5facb0={};for(let _0x6b0d69 of _0x5b8f34)if(_0x1e5421[_0x6b0d69])_0x5facb0[_0x6b0d69]=_0x1e5421[_0x6b0d69],console['log']('[ImportMap]\x20'+_0x6b0d69+'\x20->\x20'+_0x1e5421[_0x6b0d69]+'\x20(from\x20platform)');else try{let _0x583db7=z(),_0x149930=join(_0x583db7['cwd'](),this['libDir']),_0x5405bb=!0x1;try{for(let _0x56571b of _0x583db7['readDirSync'](_0x149930))if(_0x56571b['isDirectory']&&(_0x56571b['name']===_0x6b0d69||_0x56571b['name']['startsWith'](_0x6b0d69+'@'))){let _0x66d230=join(_0x583db7['cwd'](),this['libDir'],_0x56571b['name'],'index.js')['replace'](/\\/g,'/'),_0x50ff54=new URL('file:///'+_0x66d230)['href'];_0x5facb0[_0x6b0d69]=_0x50ff54,console['log']('[ImportMap]\x20'+_0x6b0d69+'\x20->\x20'+_0x50ff54+'\x20(from\x20lib)'),_0x5405bb=!0x0;break;}}catch{}_0x5405bb||console['warn']('[ImportMap]\x20Package\x20'+_0x6b0d69+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x73cd3){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x6b0d69+':',_0x73cd3);}return _0x5facb0;}['validateServerImports'](_0x50157b){let _0x5e3f21=this['manifest']['name']||this['manifest']['id'],_0x19702c=this['manifest']['metadata']?.['serverPath'],_0x4f384e=_0x224e77=>_0x224e77['replace'](/\\/g,'/'),_0x366c56=z(),_0x1f0dbf=_0x14a2b9=>{try{return _0x366c56['statSync'](_0x14a2b9),!0x0;}catch{return![];}},_0x492291=_0x19702c?_0x4f384e(_0x19702c):void 0x0;if(!_0x492291){let _0x4649d2=[_0x50157b+'/service/server.js',_0x50157b+'/service/server.ts',_0x50157b+'/'+_0x5e3f21+'/server.js',_0x50157b+'/'+_0x5e3f21+'/server.ts',_0x50157b+'/server.js',_0x50157b+'/server.ts']['map'](_0x4f384e);for(let _0x2d69e4 of _0x4649d2)if(_0x1f0dbf(_0x2d69e4)){_0x492291=_0x2d69e4;break;}}if(!_0x492291)return{'valid':![],'violations':['Failed to locate server module']};let _0x55b9ed='';try{_0x55b9ed=_0x366c56['readTextFileSync'](_0x492291);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x492291};}let _0x4c58f3=this['getImports']();if(_0x4c58f3['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x492291};let _0x3e9d78=_0x4c58f3,_0x450773=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x7d4940=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x4f6f75=/\bimport\s*['"]([^'"]+)['"]/g,_0x487b30=[],_0x18c1f2=new Set(),_0x30ee9b=_0x456b50=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x456b50),_0x19e0a0=_0x41ee4e=>{let _0x448221=_0x41ee4e;if(_0x448221['startsWith']('./')||_0x448221['startsWith']('../')||_0x448221['startsWith']('/')||_0x448221['startsWith']('file://')||!_0x30ee9b(_0x41ee4e)||_0x18c1f2['has'](_0x41ee4e))return;_0x18c1f2['add'](_0x41ee4e),_0x448221['startsWith']('npm:')&&(_0x448221=_0x448221['substring'](0x4)),_0x448221['includes']('@')&&!_0x448221['startsWith']('@')&&(_0x448221=_0x448221['split']('@')[0x0]);let _0x30bb93=_0x448221['split']('/')[0x0];_0x3e9d78['includes'](_0x30bb93)||_0x3e9d78['includes'](_0x41ee4e)||_0x487b30['push'](_0x41ee4e);},_0x236679;for(;(_0x236679=_0x450773['exec'](_0x55b9ed))!==null;)_0x19e0a0(_0x236679[0x1]);for(;(_0x236679=_0x7d4940['exec'](_0x55b9ed))!==null;)_0x19e0a0(_0x236679[0x1]);for(;(_0x236679=_0x4f6f75['exec'](_0x55b9ed))!==null;)_0x19e0a0(_0x236679[0x1]);return{'valid':_0x487b30['length']===0x0,'violations':_0x487b30,'serverPath':_0x492291};}['validate'](_0x38e10c={}){let _0x59dd3a=[],_0x4c7a93=this['manifest']['permissions']||{};try{let _0x362c88=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x362c88);}catch{}let _0x34fb8b=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x73bee3,_0x138d73]of Object['entries'](_0x4c7a93))if(_0x73bee3==='hrtime')typeof _0x138d73!='boolean'&&_0x59dd3a['push']('Permission\x20\x27'+_0x73bee3+'\x27\x20must\x20be\x20boolean');else{if(_0x73bee3==='langchain')typeof _0x138d73!='boolean'&&(typeof _0x138d73!='object'||_0x138d73===null)?_0x59dd3a['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x138d73=='object'&&(_0x138d73===null||!('enabled'in _0x138d73)||typeof _0x138d73['enabled']!='boolean')&&_0x59dd3a['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x73bee3==='kv')typeof _0x138d73!='boolean'&&_0x59dd3a['push']('Permission\x20\x27'+_0x73bee3+'\x27\x20must\x20be\x20boolean');else{if(_0x73bee3==='mspbots')Array['isArray'](_0x138d73)||_0x59dd3a['push']('Permission\x20\x27'+_0x73bee3+'\x27\x20must\x20be\x20an\x20array');else{if(_0x73bee3==='db'){if(typeof _0x138d73!='object'||_0x138d73===null||Array['isArray'](_0x138d73))_0x59dd3a['push']('Permission\x20\x27'+_0x73bee3+'\x27\x20must\x20be\x20an\x20object');else{let _0x8a1d4a=_0x138d73,_0x5ae280=['user','password']['filter'](_0xe1f29c=>!(_0xe1f29c in _0x8a1d4a));_0x5ae280['length']>0x0&&_0x59dd3a['push']('Permission\x20\x27'+_0x73bee3+'\x27\x20missing\x20required\x20fields:\x20'+_0x5ae280['join'](',\x20'));}}else{if(_0x73bee3==='imports')continue;_0x34fb8b['has'](_0x73bee3)||typeof _0x138d73!='boolean'&&!Array['isArray'](_0x138d73)&&_0x59dd3a['push']('Permission\x20\x27'+_0x73bee3+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x5c8bb2=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x5c8bb2))_0x59dd3a['push']('permissions.imports must be an array');else{for(let _0x243c29 of _0x5c8bb2)typeof _0x243c29!='string'&&_0x59dd3a['push']('import\x20\x27'+_0x243c29+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x59dd3a['length']===0x0,'errors':_0x59dd3a};}};function q(_0x17fea4,_0x2cd2a8,_0x584256){return new D(_0x17fea4,_0x2cd2a8,_0x584256||{});}var R=null;function I(){let _0x5afcd9=globalThis['Deno'];if(!_0x5afcd9)throw new Error('Deno is not available');return _0x5afcd9;}async function K(){if(R)return{...R};try{let _0x21e140=I(),_0x29c35d=join(_0x21e140['cwd'](),'deno.json'),_0x420aec=await _0x21e140['readTextFile'](_0x29c35d);return R=JSON['parse'](_0x420aec)['imports']||{},{...R};}catch(_0x180837){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x180837),{};}}var E=class{constructor(_0xd3fcc9,_0x2433f8={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0xd3fcc9['appsDir'],this['platformImportsOverride']=_0xd3fcc9['platformImports'],this['libDir']=_0xd3fcc9['libDir'],this['events']=_0x2433f8);}async['create'](_0xc3a08e,_0x2e43ee,_0xbe42ee){try{return await this['createWorker'](_0xc3a08e,_0x2e43ee,_0xbe42ee);}catch(_0x386460){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0xc3a08e+':',_0x386460),_0x386460;}}async['createWorker'](_0x17bb80,_0x2c8c6b,_0x425873){let _0x30c590=this['platformImportsOverride']||await K(),_0xc7acd0=q(_0x2c8c6b,this['libDir'],_0x30c590)['validateServerImports'](this['appsDir']);if(!_0xc7acd0['valid']){let _0x77b263=_0xc7acd0['violations']['filter'](_0x52cec2=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x52cec2)),_0x176d92=_0xc7acd0['serverPath']?_0xc7acd0['serverPath']:(_0x2c8c6b['name']||_0x2c8c6b['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x176d92+':\x20'+_0x77b263['join'](',\x20'));}let _0x55abcf=q(_0x2c8c6b,this['libDir'],_0x30c590),_0x18a726=_0x55abcf['validate'](_0x30c590);if(!_0x18a726['valid'])throw new Error('Invalid\x20config:\x20'+_0x18a726['errors']['join'](',\x20'));let _0x2b3cae=_0x55abcf['buildImportMap'](_0x30c590);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x17bb80+':',_0x2b3cae);let _0x143e51=_0x55abcf['buildPerms'](),_0x4c6e8e=_0x55abcf['getReadPaths']();if(_0x143e51['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x143e51['read']);else{let _0x149fbf=_0x2c8c6b['name']||_0x17bb80,_0x214729=this['appsDir']+'/'+_0x149fbf,_0x10fe40=[_0x214729],_0x7e82e0=_0x2c8c6b['metadata']?.['serverPath'];if(_0x7e82e0&&typeof _0x7e82e0=='string')try{let _0x3b9482=dirname(_0x7e82e0)['replace'](/\\/g,'/');_0x10fe40['push'](_0x3b9482);}catch{}_0x143e51['read']=_0x10fe40,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x214729);}if(_0x4c6e8e['length']>0x0){if(_0x143e51['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x1e53e8=Array['isArray'](_0x143e51['read'])?_0x143e51['read']:[];_0x143e51['read']=[..._0x1e53e8,..._0x4c6e8e],console['log']('[Worker] Added package read permissions:',_0x4c6e8e);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x143e51['net']||(_0x143e51['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x17bb80+':',_0x143e51['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x143e51['read']===!![]?'unrestricted':Array['isArray'](_0x143e51['read'])?_0x143e51['read']['length']:0x0));let _0x5e0d43=await this['createImportMap'](_0x17bb80,_0x2b3cae),_0x29a9a9=await this['createLock'](_0x17bb80,_0x2b3cae),_0x503b38={'type':'module','deno':{'permissions':{}}};_0x503b38['deno']['namespace']=![],_0x503b38['deno']['permissions']=_0x143e51,_0x503b38['deno']['importMap']=_0x5e0d43,_0x503b38['deno']['lock']=_0x29a9a9,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x17bb80+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x5e0d43),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x29a9a9),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x2b3cae)['length']+'\x20('+(Object['keys'](_0x2b3cae)['join'](',\x20')||'none')+')');let _0x368e34={'worker':new Worker(_0x425873,_0x503b38),'appId':_0x17bb80,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x2c8c6b,'importMapPath':_0x5e0d43,'lockfilePath':_0x29a9a9};return this['workers']['set'](_0x17bb80,_0x368e34),this['events']['onCreate']?.(_0x368e34),_0x368e34;}async['createLock'](_0x21dc22,_0xc15192){let _0x4ab380=I(),_0x274216=join(_0x4ab380['cwd'](),'storage','temp','lockfiles');await _0x4ab380['mkdir'](_0x274216,{'recursive':!![]});let _0x13134d=_0x21dc22+'-'+Date['now']()+'.lock',_0x111709=join(_0x274216,_0x13134d),_0xb4d469={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0xee1d62,_0x1e650b]of Object['entries'](_0xc15192))if(_0x1e650b['startsWith']('npm:'))_0x1e650b['replace']('npm:',''),_0xb4d469['packages']['specifiers'][_0xee1d62]=_0x1e650b;else _0x1e650b['startsWith']('file://')&&(_0xb4d469['packages']['specifiers'][_0xee1d62]=_0x1e650b);let _0x2fe789=JSON['stringify'](_0xb4d469,null,0x2);return await _0x4ab380['writeTextFile'](_0x111709,_0x2fe789),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x111709),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0xc15192)['length']+'):',Object['keys'](_0xc15192)),_0x111709;}async['createImportMap'](_0x48ec3c,_0x177233){let _0x36e554=I(),_0x1d3535=join(_0x36e554['cwd'](),'storage','temp','importmaps');await _0x36e554['mkdir'](_0x1d3535,{'recursive':!![]});let _0x211b5f=_0x48ec3c+'-'+Date['now']()+'.json',_0x392c5c=join(_0x1d3535,_0x211b5f),_0xdb16a3=JSON['stringify']({'imports':_0x177233,'scopes':{}},null,0x2);return await _0x36e554['writeTextFile'](_0x392c5c,_0xdb16a3),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x392c5c),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x177233)['length']+'):',Object['keys'](_0x177233)['join'](',\x20')||'none'),_0x392c5c;}['get'](_0x142ec0){return this['workers']['get'](_0x142ec0);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x822f30,_0x28de45){let _0x45c4db=this['workers']['get'](_0x822f30);if(!_0x45c4db)return;let _0x3c63e5=_0x45c4db['status'];_0x45c4db['status']=_0x28de45,_0x28de45==='running'&&_0x3c63e5==='starting'?this['events']['onReady']?.(_0x45c4db):_0x28de45==='crashed'&&this['events']['onCrash']?.(_0x45c4db);}['touch'](_0x193622){let _0x4ae23f=this['workers']['get'](_0x193622);_0x4ae23f&&(_0x4ae23f['lastUsed']=Date['now']());}async['stop'](_0x426abe){let _0x519800=this['workers']['get'](_0x426abe);if(_0x519800)try{_0x519800['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x519800['worker']['terminate'](),_0x519800['status']='stopped',this['events']['onStop']?.(_0x519800),_0x519800['importMapPath']&&await this['cleanupImportMap'](_0x519800['importMapPath']),_0x519800['lockfilePath']&&await this['cleanupLock'](_0x519800['lockfilePath']);}catch(_0x12dbb8){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x426abe+':',_0x12dbb8);}finally{this['workers']['delete'](_0x426abe);}}async['cleanupImportMap'](_0x24f081){try{await I()['remove'](_0x24f081),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x24f081);}catch(_0x463186){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x24f081,_0x463186);}}async['cleanupLock'](_0x37811e){try{await I()['remove'](_0x37811e),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x37811e);}catch(_0x358bf3){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x37811e,_0x358bf3);}}async['stopAll'](){let _0x5e99e4=Array['from'](this['workers']['keys']());await Promise['all'](_0x5e99e4['map'](_0xd18d7b=>this['stop'](_0xd18d7b)));}async['restart'](_0x54667f,_0x182351){let _0x1a218d=this['workers']['get'](_0x54667f);if(!_0x1a218d)throw new Error('Worker\x20'+_0x54667f+'\x20not\x20found');let _0x13e99d=_0x1a218d['manifest'];return await this['stop'](_0x54667f),await this['create'](_0x54667f,_0x13e99d,_0x182351);}['checkHealth'](_0x241810){let _0x372c53=this['workers']['get'](_0x241810);if(!_0x372c53)return{'healthy':![],'reason':'Not\x20found'};if(_0x372c53['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x372c53['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x383b6f=Date['now']()-_0x372c53['lastUsed'],_0x1325a5=0x708*0x3e8;return _0x383b6f>_0x1325a5?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x383b6f/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x3b474d=0x708*0x3e8,_0x135e8e){let _0x3f462d=Date['now'](),_0x203eee=[];for(let [_0x2e38cc,_0x526ee1]of this['workers']['entries']()){let _0x374fd6=_0x3f462d-_0x526ee1['lastUsed'];_0x374fd6>_0x3b474d&&_0x203eee['push']({'appId':_0x2e38cc,'idle':_0x374fd6});}_0x203eee['sort']((_0xba1e4c,_0x484a87)=>_0x484a87['idle']-_0xba1e4c['idle']);let _0x3f3304=_0x135e8e?_0x203eee['slice'](0x0,_0x135e8e)['map'](_0x5bae23=>_0x5bae23['appId']):_0x203eee['map'](_0x438250=>_0x438250['appId']);for(let _0x583b5d of _0x3f3304)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x583b5d),await this['stop'](_0x583b5d);}['stats'](){let _0x3a6cb8={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x51c7b2=Date['now']();for(let _0x28af74 of this['workers']['values']())_0x3a6cb8['byStatus'][_0x28af74['status']]++,_0x3a6cb8['workers']['push']({'appId':_0x28af74['appId'],'status':_0x28af74['status'],'version':_0x28af74['version'],'lastUsed':_0x28af74['lastUsed'],'idle':_0x51c7b2-_0x28af74['lastUsed']});return _0x3a6cb8;}['startCleanup'](_0x50549d=0x12c*0x3e8,_0x166397){let _0x3e9e1b=setInterval(()=>{this['cleanup'](_0x166397)['catch'](_0x42fc3c=>{console['error']('Cleanup\x20failed:',_0x42fc3c);});},_0x50549d);return()=>clearInterval(_0x3e9e1b);}['delay'](_0x5c42d7){return new Promise(_0x6a67f1=>setTimeout(_0x6a67f1,_0x5c42d7));}};function W(_0x49955b,_0x44b2ef){return new E(_0x49955b,_0x44b2ef);}var v=f,j=class{constructor(_0x55a944,_0x458aa5=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x55a944,this['timeout']=_0x458aa5);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x38483d){_0x38483d['worker']['onmessage']=_0x1c8a59=>{let _0x1db404=_0x1c8a59['data'],{appId:_0x43285f}=_0x38483d;switch(_0x1db404['type']){case'ready':this['events']['onReady'](_0x43285f),v['info']('Worker\x20ready',{'appId':_0x43285f,'version':_0x38483d['version']});break;case'log':{let {level:_0x15794d='info',message:_0x48b16d,meta:_0x38a6b3}=_0x1db404,_0x2c69f6={..._0x38a6b3||{},'appId':_0x43285f,'version':_0x38483d['version']};this['events']['onLog'](_0x43285f,_0x15794d,_0x48b16d,_0x2c69f6);break;}case'result':{let {reqId:_0x20be78,ok:_0x45b4fc,response:_0x29ee4f,error:_0x44ac4a}=_0x1db404,_0x1e2355=this['pending']['get'](_0x20be78);if(!_0x1e2355){v['warn']('Unknown\x20request',{'appId':_0x43285f,'reqId':_0x20be78});return;}if(this['pending']['delete'](_0x20be78),_0x45b4fc&&_0x29ee4f)_0x1e2355['resolve'](_0x29ee4f);else{let _0xfef4e3=new Error(_0x44ac4a?.['message']||'Worker\x20error');_0xfef4e3['stack']=_0x44ac4a?.['stack'],_0x1e2355['reject'](_0xfef4e3);}this['events']['onResult'](_0x43285f,_0x20be78,_0x29ee4f||_0x44ac4a);break;}default:v['debug']('Unknown\x20message',{'appId':_0x43285f,'type':_0x1db404['type']});}},_0x38483d['worker']['onerror']=_0x52bc39=>{let {appId:_0x1d10ca}=_0x38483d;v['error']('Worker\x20error',{'appId':_0x1d10ca,'message':_0x52bc39['message'],'lineno':_0x52bc39['lineno'],'filename':_0x52bc39['filename']}),_0x38483d['status']='crashed',this['rejectPending'](_0x1d10ca,new Error('Worker\x20'+_0x1d10ca+'\x20crashed:\x20'+_0x52bc39['message'])),_0x52bc39['preventDefault']();},_0x38483d['worker']['onmessageerror']=_0x578b11=>{let {appId:_0x36d1cb}=_0x38483d;v['error']('Message\x20error',{'appId':_0x36d1cb,'data':_0x578b11['data']}),_0x38483d['status']='crashed',_0x578b11['preventDefault']();};}['sendInit'](_0xc695f4,_0x330e14,_0x380ad9,_0x599148){_0xc695f4['worker']['postMessage']({'type':'init','appId':_0xc695f4['appId'],'manifest':_0x380ad9,'appsDir':_0x330e14,'serverPath':_0x599148});}async['sendInvoke'](_0x27dba9,_0x42346d){let _0x30d010=this['nextId'](),_0x3934a4=_0x27dba9['appId'],_0x13c060=new Promise((_0x111377,_0x2a3392)=>{let _0x46afeb=setTimeout(()=>{this['pending']['delete'](_0x30d010),_0x2a3392(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x30d010,{'resolve':_0x477c6f=>{clearTimeout(_0x46afeb),_0x111377(_0x477c6f);},'reject':_0x244740=>{clearTimeout(_0x46afeb),_0x2a3392(_0x244740);},'timestamp':Date['now'](),'appId':_0x3934a4});});return _0x27dba9['worker']['postMessage']({'type':'invoke','appId':_0x27dba9['appId'],'reqId':_0x30d010,'payload':_0x42346d}),await _0x13c060;}['rejectPending'](_0xf04cc6,_0x175910){let _0x10cd60=0x0;for(let [_0x508c63,_0x2cf955]of this['pending']['entries']())_0x2cf955['appId']===_0xf04cc6&&(this['pending']['delete'](_0x508c63),_0x2cf955['reject'](_0x175910),_0x10cd60++);_0x10cd60>0x0&&v['warn']('Rejected\x20'+_0x10cd60+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0xf04cc6});}['cleanupTimeout'](){let _0x37eea2=Date['now']();for(let [_0x21982e,_0x526ec8]of this['pending']['entries']())_0x37eea2-_0x526ec8['timestamp']>this['timeout']&&(this['pending']['delete'](_0x21982e),_0x526ec8['reject'](new Error('Request\x20'+_0x21982e+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x25f0cb){let _0x1d9821=0x0;for(let _0x12deb6 of this['pending']['values']())_0x12deb6['appId']===_0x25f0cb&&_0x1d9821++;return _0x1d9821;}['startCleanup'](_0x59d845=0x2710){let _0x36cdd3=setInterval(()=>{this['cleanupTimeout']();},_0x59d845);return()=>clearInterval(_0x36cdd3);}};function $(_0x364118,_0x21ffc1){return new j(_0x364118,_0x21ffc1);}var Q=class{constructor(_0x567bc4={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x567bc4['logger']||f,this['config']={'appsDir':_0x567bc4['appsDir']||this['getAppsDir'](),'scriptUrl':_0x567bc4['scriptUrl']||this['getScriptUrl'](),'timeout':_0x567bc4['timeout']||0x78*0x3e8,'autoCleanup':_0x567bc4['autoCleanup']??!![],'cleanupInterval':_0x567bc4['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x567bc4['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x567bc4['maxWorkers'],'reuseWorkers':_0x567bc4['reuseWorkers']??!![],'workerReuseStrategy':_0x567bc4['workerReuseStrategy']||'lru','enableQueue':_0x567bc4['enableQueue']??!![],'maxQueueSize':_0x567bc4['maxQueueSize']||0x64,'queueTimeout':_0x567bc4['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x5ebbf9=>this['logger']['info']('Worker\x20created',{'appId':_0x5ebbf9['appId'],'v':_0x5ebbf9['version']}),'onReady':_0x39e7f6=>this['lifecycle']['updateStatus'](_0x39e7f6['appId'],'running'),'onCrash':_0x11bfe1=>this['logger']['error']('Worker\x20crashed',{'appId':_0x11bfe1['appId'],'v':_0x11bfe1['version']}),'onStop':_0x42ad19=>this['logger']['info']('Worker\x20stopped',{'appId':_0x42ad19['appId'],'v':_0x42ad19['version']})}),this['messaging']=$({'onReady':_0x5a3851=>this['lifecycle']['updateStatus'](_0x5a3851,'running'),'onLog':(_0x381569,_0x5c50dd,_0x3d0cd3,_0x4284a1)=>{let _0x14ab79={..._0x4284a1||{},'appId':_0x381569};switch(_0x5c50dd){case'error':this['logger']['error'](_0x3d0cd3,_0x14ab79);break;case'warn':this['logger']['warn'](_0x3d0cd3,_0x14ab79);break;case'debug':this['logger']['debug'](_0x3d0cd3,_0x14ab79);break;default:this['logger']['info'](_0x3d0cd3,_0x14ab79);break;}},'onResult':(_0x2bcd67,_0x4f3cbd,_0x36bf46)=>{this['logger']['debug']('Result\x20received',{'appId':_0x2bcd67,'reqId':_0x4f3cbd});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x96666['cwd'](),'apps');}['getScriptUrl'](){let _0x5d35e2=import.meta.url,_0x385b3f=_0x5d35e2['endsWith']('.js')||_0x5d35e2['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x385b3f,_0x5d35e2)['href'];}async['ensure'](_0x17c7fd){let {id:_0x5ede8b}=_0x17c7fd,_0x5f4d6b=this['lifecycle']['get'](_0x5ede8b);if(_0x5f4d6b){let _0xdb900d=this['lifecycle']['checkHealth'](_0x5ede8b);if(_0xdb900d['healthy'])return this['lifecycle']['touch'](_0x5ede8b),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x5ede8b}),_0x5f4d6b;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x5ede8b,'reason':_0xdb900d['reason']}),await this['lifecycle']['stop'](_0x5ede8b);}for(;;){let _0x3840c5=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x3840c5>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x3840c5,'max':this['config']['maxWorkers'],'appId':_0x5ede8b}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x17c7fd);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x3398ee=await this['loadManifest'](_0x5ede8b,_0x17c7fd['manifest']),_0x21bb39=await this['lifecycle']['create'](_0x5ede8b,_0x3398ee,this['config']['scriptUrl']),_0x4f4db7=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x4f4db7>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x4f4db7,'max':this['config']['maxWorkers'],'appId':_0x5ede8b}),await this['lifecycle']['stop'](_0x5ede8b),this['config']['enableQueue'])return await this['waitSlot'](_0x17c7fd);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x4f4db7+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x21bb39);let _0x2c0cf1=_0x3398ee['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x21bb39,this['config']['appsDir'],_0x3398ee,_0x2c0cf1),this['logger']['info']('Worker\x20created',{'appId':_0x5ede8b,'v':_0x21bb39['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x21bb39;}async['evictIdle'](){let _0x4c707f=this['lifecycle']['getAll']();if(_0x4c707f['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x27ebe4=[..._0x4c707f];this['config']['workerReuseStrategy']==='lru'?_0x27ebe4['sort']((_0x14c27b,_0x301316)=>_0x14c27b['lastUsed']-_0x301316['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x27ebe4['sort']((_0x43c156,_0x50b039)=>_0x43c156['version']-_0x50b039['version']);let _0x5744a8=null;for(let _0x59cee5 of _0x27ebe4)if(this['messaging']['getAppCount'](_0x59cee5['appId'])===0x0){_0x5744a8=_0x59cee5;break;}if(!_0x5744a8&&_0x27ebe4['length']>0x0&&(_0x5744a8=_0x27ebe4['reduce']((_0x261391,_0x4b749a)=>{let _0x4ef752=this['messaging']['getAppCount'](_0x261391['appId']);return this['messaging']['getAppCount'](_0x4b749a['appId'])<_0x4ef752?_0x4b749a:_0x261391;})),_0x5744a8){let _0x1312cb=this['messaging']['getAppCount'](_0x5744a8['appId']);return _0x1312cb>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x5744a8['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x5744a8['lastUsed'],'pendingRequests':_0x1312cb}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x5744a8['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x5744a8['lastUsed']}),await this['lifecycle']['stop'](_0x5744a8['appId']),!![];}return![];}['waitSlot'](_0x5b8e69){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x471c4f,_0x38e1ac)=>{let _0x1ee67c={'info':_0x5b8e69,'resolve':_0x471c4f,'reject':_0x38e1ac,'timestamp':Date['now']()};this['requestQueue']['push'](_0x1ee67c),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x5b8e69['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x5b956c=setTimeout(()=>{let _0x233e11=this['requestQueue']['indexOf'](_0x1ee67c);_0x233e11!==-0x1&&(this['requestQueue']['splice'](_0x233e11,0x1),_0x38e1ac(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x1ee67c['resolve']=_0x29f40d=>{clearTimeout(_0x5b956c),_0x471c4f(_0x29f40d);},_0x1ee67c['reject']=_0x2e1410=>{clearTimeout(_0x5b956c),_0x38e1ac(_0x2e1410);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0xfecf98=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0xfecf98>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x1669d2=this['requestQueue']['shift']();if(!_0x1669d2)break;try{let _0x41fc93=await this['ensure'](_0x1669d2['info']);_0x1669d2['resolve'](_0x41fc93);}catch(_0x19540c){_0x1669d2['reject'](_0x19540c);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x7bbc78,_0x59ee28){let _0xabf8d2=this['config']['appsDir']['replace'](/\\/g,'/'),_0x5744cb=async _0x57fac8=>{try{let _0x536d11=globalThis['Deno'];if(!_0x536d11)return null;let _0x436dea=await _0x536d11['readTextFile'](_0x57fac8);return JSON['parse'](_0x436dea);}catch{return null;}};if(_0x59ee28?.['name']){let _0x2640cb=await _0x5744cb(_0xabf8d2+'/'+_0x59ee28['name']+'/manifest.json');if(_0x2640cb)return _0x2640cb;}let _0xa9f201=await _0x5744cb(_0xabf8d2+'/'+_0x7bbc78+'/manifest.json');if(_0xa9f201)return _0xa9f201;try{let _0xbc1d3c=globalThis['Deno'];if(_0xbc1d3c)for await(let _0x2112bc of _0xbc1d3c['readDir'](_0xabf8d2)){if(!_0x2112bc['isDirectory'])continue;let _0x3e2847=_0xabf8d2+'/'+_0x2112bc['name']+'/manifest.json',_0x297104=await _0x5744cb(_0x3e2847);if(_0x297104&&(_0x297104['id']===_0x7bbc78||_0x59ee28?.['name']&&_0x297104['name']===_0x59ee28['name']))return _0x297104;}}catch(_0x2b4cfe){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x7bbc78,'error':_0x2b4cfe['message']});}return _0x59ee28||{'id':_0x7bbc78,'name':_0x7bbc78,'version':'1.0.0'};}async['invoke'](_0x3b34ad){let _0x475ac4=_0x3b34ad['ctx']['app']['id'],_0x313d2d=_0x3b34ad['ctx']['app']['name'];try{let _0x20824d={'id':_0x475ac4,'manifest':{'id':_0x475ac4,'name':_0x313d2d}},_0x68589d=await this['ensure'](_0x20824d);if(_0x68589d['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x475ac4}),await this['restart'](_0x475ac4);let _0x51d6a8=await this['ensure'](_0x20824d);return this['lifecycle']['touch'](_0x475ac4),await this['messaging']['sendInvoke'](_0x51d6a8,_0x3b34ad);}return this['lifecycle']['touch'](_0x475ac4),await this['messaging']['sendInvoke'](_0x68589d,_0x3b34ad);}catch(_0xfd974c){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x475ac4,'error':_0xfd974c['message'],'stack':_0xfd974c['stack']}),_0xfd974c;}}async['stop'](_0x5ea964){await this['lifecycle']['stop'](_0x5ea964),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x4e378c){return await this['lifecycle']['restart'](_0x4e378c,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x3a06c4=>({'appId':_0x3a06c4['appId'],'status':_0x3a06c4['status'],'version':_0x3a06c4['version'],'lastUsed':_0x3a06c4['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x91fa5d=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x59c56d=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x91fa5d(),_0x59c56d();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x49af63=>{_0x49af63?(await this['stop'](_0x49af63),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x49af63})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0xa0bda4){return new Q(_0xa0bda4);}var S=null;function be(_0x1ee1d4){S=ee(_0x1ee1d4);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x2ada01){return await k()['ensure'](_0x2ada01);}async function xe(_0x5153b6){return await k()['invoke'](_0x5153b6);}function Ie(_0x2640f9){k()['stop'](_0x2640f9)['catch'](_0x35f506=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x2640f9,'error':_0x35f506['message']});});}function Re(){k()['stopAll']()['catch'](_0x812219=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x812219['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x274f22){await k()['stop'](_0x274f22);}async function Se(){await k()['stopAll']();}function Ae(_0x3b8016){let _0x296dc7=_0x3b8016&&typeof _0x3b8016=='object'?_0x3b8016:null;if(_0x296dc7&&'user'in _0x296dc7)return _0x296dc7['user'];}function H(_0x18d99b){let _0x2f7feb=_0x18d99b&&typeof _0x18d99b=='object'?_0x18d99b:null;if(!_0x2f7feb)return{};let _0x5a9218={};for(let [_0x42ee0c,_0x7b4381]of Object['entries'](_0x2f7feb))_0x42ee0c!=='user'&&(_0x5a9218[_0x42ee0c]=_0x7b4381);return _0x5a9218;}function O(_0x19c74a){return _0x19c74a?{'id':_0x19c74a['manifest']?.['id']||_0x19c74a['id']||'','name':_0x19c74a['manifest']?.['name']||'','version':_0x19c74a['manifest']?.['version']||'','description':_0x19c74a['manifest']?.['description']||'','icon':_0x19c74a['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x16c4d8){return _0x16c4d8?.['permissions']||_0x16c4d8?.['manifest']?.['permissions']||{};}function F(_0x5b9bc9){return _0x5b9bc9?.['manifest']?.['metadata']||{};}function Ce(_0x51b162){return _0x51b162?{'appId':_0x51b162['id'],'appName':_0x51b162['manifest']?.['name']}:{};}function N(_0x187e38,_0x3c1b5a={}){let {appInfo:_0x48112f=null,status:_0x47e5af=0x1f4,defaultMessage:_0x372fdf='Internal\x20Server\x20Error'}=_0x3c1b5a,_0x446cd9={'error':_0x372fdf,'message':_0x187e38?.['message']||_0x372fdf};return _0x48112f&&(_0x446cd9['appId']=_0x48112f['id'],_0x446cd9['appName']=_0x48112f['manifest']?.['name']),_0x187e38?.['message']?.['includes']('crashed')&&(_0x446cd9['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x47e5af,'body':_0x446cd9};}function qe(_0x44bf5f){return _0x44bf5f?.['message']?.['includes']('crashed')||![];}function J(_0x95819e){if(_0x95819e)try{return JSON['parse'](_0x95819e);}catch{return _0x95819e;}}function B(_0x42918d){try{let _0x1ec9f0=new URL(_0x42918d),_0x5db1f7={};for(let _0x2d1020 of _0x1ec9f0['searchParams']['keys']()){let _0x1c6766=_0x1ec9f0['searchParams']['getAll'](_0x2d1020)['map'](_0x181a24=>_0x181a24);_0x1c6766['length']<=0x1?_0x5db1f7[_0x2d1020]=_0x1c6766[0x0]??'':_0x5db1f7[_0x2d1020]=_0x1c6766;}return _0x5db1f7;}catch{return{};}}function Le(_0x184133){return(()=>{try{return new URL(_0x184133)['pathname'];}catch{return _0x184133;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x2b9e38,_0x1dc7cd){let _0x582131=_0x2b9e38;if(_0x1dc7cd&&_0x582131['startsWith']('/apps/'+_0x1dc7cd))_0x582131=_0x582131['substring'](('/apps/'+_0x1dc7cd)['length'])||'/';else{let _0x4bc7fe=_0x582131['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x4bc7fe&&(_0x582131=_0x4bc7fe[0x1]||'/');}return _0x582131['startsWith']('/api')&&(_0x582131=_0x582131['substring'](0x4)||'/'),_0x582131;}function Ue(_0x2eeb14,_0x482f7c){let _0x19d95e=_0x2eeb14;if(_0x482f7c&&_0x19d95e['startsWith']('/apps/'+_0x482f7c))_0x19d95e=_0x19d95e['substring'](('/apps/'+_0x482f7c)['length'])||'/';else{let _0x18b968=_0x19d95e['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x18b968&&(_0x19d95e=_0x18b968[0x1]||'/');}return(!_0x19d95e||_0x19d95e==='/')&&(_0x19d95e='/index.html'),_0x19d95e;}async function He(_0x4e4dff,_0x527bc7){return await _0x527bc7(_0x4e4dff);}function _(_0x3d4064){return _0x3d4064['split']('/')['filter'](_0x1ca421=>_0x1ca421['length']>0x0);}function te(_0x38f4cf){try{return decodeURIComponent(_0x38f4cf);}catch{return _0x38f4cf;}}function re(_0x1d2e8,_0x201ecb){let _0x344ea6=_(_0x1d2e8),_0x5df42a=_(_0x201ecb),_0x24e2b9={},_0x253a7e=0x0,_0x446403=0x0;for(;_0x253a7e<_0x344ea6['length']&&_0x446403<_0x5df42a['length'];){let _0x266443=_0x344ea6[_0x253a7e],_0x709c1b=_0x5df42a[_0x446403];if(_0x266443==='*')break;if(_0x266443['startsWith'](':')){let _0x44e156=_0x266443['slice'](0x1);_0x44e156&&(_0x24e2b9[_0x44e156]=te(_0x709c1b)),_0x253a7e++,_0x446403++;continue;}if(_0x266443!==_0x709c1b)return{};_0x253a7e++,_0x446403++;}return _0x253a7e===_0x344ea6['length']||_0x253a7e===_0x344ea6['length']-0x1&&_0x344ea6[_0x253a7e]==='*',_0x24e2b9;}async function Oe(_0x294436,_0x555e71,_0x3f0f3f,_0x60fde2,_0x890cc8=void 0x0,_0x4528bf){let _0xe44063=await _0x555e71['text'](),_0x8be454=J(_0xe44063),_0x389ffb=B(_0x555e71['url']),_0x250dca={...F(_0x294436),'user':_0x890cc8},_0x44d71e=H(_0x250dca),_0x349225=_0x4528bf?re(_0x4528bf,_0x555e71['path']):{};return{'app':O(_0x294436),'permissions':T(_0x294436),'user':_0x890cc8,'metadata':_0x44d71e,'body':_0x8be454,'query':_0x389ffb,'params':_0x349225,'method':_0x3f0f3f,'pathname':_0x60fde2,'requestUrl':_0x555e71['url'],'headers':Object['fromEntries'](_0x555e71['raw']['headers']['entries']())};}function Te(_0x1dac44){return{'method':_0x1dac44['method'],'pathname':_0x1dac44['pathname'],'ctx':_0x1dac44};}function Fe(_0x43f83c,_0x159650){let {status:_0x469cf6=0xc8,headers:_0xfecf6e={},body:_0x3a772c,type:_0x103ded}=_0x43f83c??{};return _0x103ded==='raw'?new globalThis['Response'](String(_0x3a772c??''),{'status':_0x469cf6,'headers':_0xfecf6e}):_0x159650(_0x3a772c,_0x469cf6);}function Ne(_0x52bd4e,_0x556908=null){return N(_0x52bd4e,{'appInfo':_0x556908});}var V=f;async function Ve(_0x5621cb){_0x5621cb?(await U(_0x5621cb),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x5621cb)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x220e9d,_0x4857cc){let _0x152786=Object['fromEntries'](Object['entries'](_0x220e9d['headers']||{})['map'](([_0x4574e7,_0x4de723])=>[_0x4574e7['toLowerCase'](),_0x4de723]));return{'id':_0x220e9d['app']['id']||_0x4857cc['appId']||'','name':_0x220e9d['app']['name']||'','version':_0x220e9d['app']['version']||'','description':_0x220e9d['app']['description']||'','metadata':{..._0x220e9d['metadata'],'permissions':_0x220e9d['permissions']},'body':_0x220e9d['body'],'query':_0x220e9d['query'],'params':_0x220e9d?.['params'],'method':_0x220e9d['method'],'pathname':_0x220e9d['pathname'],'requestUrl':_0x220e9d['requestUrl'],'user':_0x220e9d['user'],'headers':_0x152786};}var L=class{constructor(_0x2a9add){this['handle']=null,(this['config']=_0x2a9add,this['logger']=_0x2a9add['logger']||f,this['lifecycle']=W({'appsDir':_0x2a9add['appsDir'],'timeout':_0x2a9add['timeout'],'platformImports':_0x2a9add['platformImports'],'libDir':_0x2a9add['libDir']},{'onCreate':_0x1627d3=>this['logger']['info']('Worker\x20created',{'appId':_0x1627d3['appId']}),'onReady':_0x4d1ca4=>{this['lifecycle']['updateStatus'](_0x4d1ca4['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x4d1ca4['appId']});},'onCrash':_0x5473ed=>this['logger']['error']('Worker\x20crashed',{'appId':_0x5473ed['appId']}),'onStop':_0x5f2824=>this['logger']['info']('Worker\x20stopped',{'appId':_0x5f2824['appId']})}),this['messaging']=$({'onReady':_0x53a0e0=>this['lifecycle']['updateStatus'](_0x53a0e0,'running'),'onLog':(_0x641ac3,_0x200ea9,_0x5a7816,_0xc72672)=>{(this['logger'][_0x200ea9]||this['logger']['info'])['call'](this['logger'],_0x5a7816,_0xc72672);},'onResult':()=>{}},_0x2a9add['timeout']||0x1d4c0));}async['create'](_0x57ca2a){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x4bf8cf=await this['lifecycle']['create'](this['config']['appId'],_0x57ca2a,this['config']['scriptUrl']);this['messaging']['setup'](_0x4bf8cf),this['messaging']['sendInit'](_0x4bf8cf,this['config']['appsDir'],_0x57ca2a,this['config']['serverPath']),this['handle']=_0x4bf8cf,await this['waitForReady']();}async['waitForReady'](_0x5849c5=0x2710){let _0x27dcf6=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x27dcf6>_0x5849c5)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x38dfb6=>setTimeout(_0x38dfb6,0x64));}}async['invoke'](_0x68d6ef){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x68d6ef);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x340847){return new L(_0x340847);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,$ as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,Pe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ae as extractUser,He as findApp,Ce as getAppLogMeta,Ze as getCacheSize,$e as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,xe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,Se as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};