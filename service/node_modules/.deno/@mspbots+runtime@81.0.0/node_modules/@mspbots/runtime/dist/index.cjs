'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x371e6b){return _0x371e6b&&_0x371e6b['__esModule']?_0x371e6b:{'default':_0x371e6b};}var Y__default=_interopDefault(Y);async function ie(_0x4caf8a){try{return await promises['stat'](_0x4caf8a),!0x0;}catch{return![];}}var f={'error':(_0x36eb35,_0x555a19)=>console['error']('[ERROR]\x20'+_0x36eb35,_0x555a19),'warn':(_0x2f83d1,_0x4ec228)=>console['warn']('[WARN]\x20'+_0x2f83d1,_0x4ec228),'info':(_0x239e5d,_0x183d67)=>console['log']('[INFO]\x20'+_0x239e5d,_0x183d67),'debug':(_0x455834,_0x12e756)=>console['log']('[DEBUG]\x20'+_0x455834,_0x12e756)};function z(){let _0x327013=globalThis['Deno'];if(!_0x327013)throw new Error('Deno is not available');return _0x327013;}var D=class{constructor(_0x13c47b,_0x2346d3='./lib',_0x2c1bf9={}){this['manifest']=_0x13c47b,this['libDir']=_0x2346d3,this['platformImports']=_0x2c1bf9;}['buildPerms'](){let _0x55ab74=this['manifest']['permissions']||{},_0x935016={};return _0x55ab74['net']!==void 0x0&&(_0x935016['net']=_0x55ab74['net']===!![]?!![]:Array['isArray'](_0x55ab74['net'])?_0x55ab74['net']:[]),_0x55ab74['read']!==void 0x0&&(_0x935016['read']=_0x55ab74['read']===!![]?!![]:Array['isArray'](_0x55ab74['read'])?_0x55ab74['read']:[]),_0x55ab74['write']!==void 0x0&&(_0x935016['write']=_0x55ab74['write']===!![]?!![]:Array['isArray'](_0x55ab74['write'])?_0x55ab74['write']:[]),_0x55ab74['env']!==void 0x0&&(_0x935016['env']=_0x55ab74['env']===!![]?!![]:Array['isArray'](_0x55ab74['env'])?_0x55ab74['env']:[]),_0x55ab74['run']!==void 0x0&&(_0x935016['run']=_0x55ab74['run']===!![]?!![]:Array['isArray'](_0x55ab74['run'])?_0x55ab74['run']:[]),_0x55ab74['ffi']!==void 0x0&&(_0x935016['ffi']=_0x55ab74['ffi']===!![]?!![]:Array['isArray'](_0x55ab74['ffi'])?_0x55ab74['ffi']:[]),_0x55ab74['sys']!==void 0x0&&(_0x935016['sys']=_0x55ab74['sys']===!![]?!![]:Array['isArray'](_0x55ab74['sys'])?_0x55ab74['sys']:[]),_0x55ab74['hrtime']!==void 0x0&&(_0x935016['hrtime']=_0x55ab74['hrtime']),_0x935016;}['normalize'](_0x4433e3){return _0x4433e3===!![]?[]:Array['isArray'](_0x4433e3)?_0x4433e3:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x19af2b){return path.join(this['libDir'],_0x19af2b+'@*');}['getReadPaths'](){let _0x538448=this['getImports']();_0x538448['includes']('*')&&(_0x538448=Object['keys'](this['platformImports']));let _0x11d09b=[];console['log']('[Permissions] Building package path patterns for imports:',_0x538448);for(let _0x59e6c0 of _0x538448){let _0x2eb98f=this['getLibPattern'](_0x59e6c0);_0x11d09b['push'](_0x2eb98f),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x59e6c0+'\x20->\x20'+_0x2eb98f);}return console['log']('[Permissions] Final package path patterns:',_0x11d09b),_0x11d09b;}['buildImportMap'](_0x3d42f5){let _0x4f5e4f=this['getImports'](),_0x484b69=_0x4f5e4f['includes']('*')?Object['keys'](_0x3d42f5):_0x4f5e4f;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x484b69);let _0x137438={};for(let _0x30f433 of _0x484b69)if(_0x3d42f5[_0x30f433])_0x137438[_0x30f433]=_0x3d42f5[_0x30f433],console['log']('[ImportMap]\x20'+_0x30f433+'\x20->\x20'+_0x3d42f5[_0x30f433]+'\x20(from\x20platform)');else try{let _0x1e0506=z(),_0x268980=path.join(_0x1e0506['cwd'](),this['libDir']),_0x41bcaf=!0x1;try{for(let _0x58cc25 of _0x1e0506['readDirSync'](_0x268980))if(_0x58cc25['isDirectory']&&(_0x58cc25['name']===_0x30f433||_0x58cc25['name']['startsWith'](_0x30f433+'@'))){let _0x21b5b8=path.join(_0x1e0506['cwd'](),this['libDir'],_0x58cc25['name'],'index.js')['replace'](/\\/g,'/'),_0x13f37e=new URL('file:///'+_0x21b5b8)['href'];_0x137438[_0x30f433]=_0x13f37e,console['log']('[ImportMap]\x20'+_0x30f433+'\x20->\x20'+_0x13f37e+'\x20(from\x20lib)'),_0x41bcaf=!0x0;break;}}catch{}_0x41bcaf||console['warn']('[ImportMap]\x20Package\x20'+_0x30f433+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x4a07bd){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x30f433+':',_0x4a07bd);}return _0x137438;}['validateServerImports'](_0x2a5736){let _0xeca513=this['manifest']['name']||this['manifest']['id'],_0x226a29=this['manifest']['metadata']?.['serverPath'],_0x14e248=_0x4fad5d=>_0x4fad5d['replace'](/\\/g,'/'),_0x48325a=z(),_0x5073e9=_0xe15457=>{try{return _0x48325a['statSync'](_0xe15457),!0x0;}catch{return![];}},_0x4a5876=_0x226a29?_0x14e248(_0x226a29):void 0x0;if(!_0x4a5876){let _0x2bd722=[_0x2a5736+'/service/server.js',_0x2a5736+'/service/server.ts',_0x2a5736+'/'+_0xeca513+'/server.js',_0x2a5736+'/'+_0xeca513+'/server.ts',_0x2a5736+'/server.js',_0x2a5736+'/server.ts']['map'](_0x14e248);for(let _0x4bbbd7 of _0x2bd722)if(_0x5073e9(_0x4bbbd7)){_0x4a5876=_0x4bbbd7;break;}}if(!_0x4a5876)return{'valid':![],'violations':['Failed to locate server module']};let _0x2f52bc='';try{_0x2f52bc=_0x48325a['readTextFileSync'](_0x4a5876);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x4a5876};}let _0x2cc8c8=this['getImports']();if(_0x2cc8c8['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x4a5876};let _0x41bed6=_0x2cc8c8,_0x4249d5=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x4c635c=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x2d3ee4=/\bimport\s*['"]([^'"]+)['"]/g,_0x57c022=[],_0x33458a=new Set(),_0x338876=_0x3fd939=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x3fd939),_0x2b2562=_0x249645=>{let _0x4c5961=_0x249645;if(_0x4c5961['startsWith']('./')||_0x4c5961['startsWith']('../')||_0x4c5961['startsWith']('/')||_0x4c5961['startsWith']('file://')||!_0x338876(_0x249645)||_0x33458a['has'](_0x249645))return;_0x33458a['add'](_0x249645),_0x4c5961['startsWith']('npm:')&&(_0x4c5961=_0x4c5961['substring'](0x4)),_0x4c5961['includes']('@')&&!_0x4c5961['startsWith']('@')&&(_0x4c5961=_0x4c5961['split']('@')[0x0]);let _0x5e41e2=_0x4c5961['split']('/')[0x0];_0x41bed6['includes'](_0x5e41e2)||_0x41bed6['includes'](_0x249645)||_0x57c022['push'](_0x249645);},_0x27bd89;for(;(_0x27bd89=_0x4249d5['exec'](_0x2f52bc))!==null;)_0x2b2562(_0x27bd89[0x1]);for(;(_0x27bd89=_0x4c635c['exec'](_0x2f52bc))!==null;)_0x2b2562(_0x27bd89[0x1]);for(;(_0x27bd89=_0x2d3ee4['exec'](_0x2f52bc))!==null;)_0x2b2562(_0x27bd89[0x1]);return{'valid':_0x57c022['length']===0x0,'violations':_0x57c022,'serverPath':_0x4a5876};}['validate'](_0x1e9f77={}){let _0x17e463=[],_0xcf289b=this['manifest']['permissions']||{};try{let _0x236d00=this['manifest']['metadata']?.['serverPath']?'dev:package.json.manifest':'core:apps/<name>/manifest.json';console['log']('[Permissions]\x20Manifest\x20source:',_0x236d00);}catch{}let _0x42f6e6=new Set(['hrtime','langchain','kv','http','mspbots','imports','db']);for(let [_0x286526,_0x3db06f]of Object['entries'](_0xcf289b))if(_0x286526==='hrtime')typeof _0x3db06f!='boolean'&&_0x17e463['push']('Permission\x20\x27'+_0x286526+'\x27\x20must\x20be\x20boolean');else{if(_0x286526==='langchain')typeof _0x3db06f!='boolean'&&(typeof _0x3db06f!='object'||_0x3db06f===null)?_0x17e463['push']('Permission\x20\x27langchain\x27\x20must\x20be\x20boolean\x20or\x20object\x20with\x20\x27enabled\x27\x20field'):typeof _0x3db06f=='object'&&(_0x3db06f===null||!('enabled'in _0x3db06f)||typeof _0x3db06f['enabled']!='boolean')&&_0x17e463['push']('Permission\x20\x27langchain.enabled\x27\x20must\x20be\x20boolean');else{if(_0x286526==='kv')typeof _0x3db06f!='boolean'&&_0x17e463['push']('Permission\x20\x27'+_0x286526+'\x27\x20must\x20be\x20boolean');else{if(_0x286526==='mspbots')Array['isArray'](_0x3db06f)||_0x17e463['push']('Permission\x20\x27'+_0x286526+'\x27\x20must\x20be\x20an\x20array');else{if(_0x286526==='db'){if(typeof _0x3db06f!='object'||_0x3db06f===null||Array['isArray'](_0x3db06f))_0x17e463['push']('Permission\x20\x27'+_0x286526+'\x27\x20must\x20be\x20an\x20object');else{let _0x54fda8=_0x3db06f,_0xdd1a7e=['user','password']['filter'](_0xc927a5=>!(_0xc927a5 in _0x54fda8));_0xdd1a7e['length']>0x0&&_0x17e463['push']('Permission\x20\x27'+_0x286526+'\x27\x20missing\x20required\x20fields:\x20'+_0xdd1a7e['join'](',\x20'));}}else{if(_0x286526==='imports')continue;_0x42f6e6['has'](_0x286526)||typeof _0x3db06f!='boolean'&&!Array['isArray'](_0x3db06f)&&_0x17e463['push']('Permission\x20\x27'+_0x286526+'\x27\x20must\x20be\x20boolean\x20or\x20array');}}}}}let _0x17c5c6=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x17c5c6))_0x17e463['push']('permissions.imports must be an array');else{for(let _0xbb52ff of _0x17c5c6)typeof _0xbb52ff!='string'&&_0x17e463['push']('import\x20\x27'+_0xbb52ff+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x17e463['length']===0x0,'errors':_0x17e463};}};function q(_0x1e55c2,_0xab5f11,_0xffa3db){return new D(_0x1e55c2,_0xab5f11,_0xffa3db||{});}var R=null;function I(){let _0x478b7e=globalThis['Deno'];if(!_0x478b7e)throw new Error('Deno is not available');return _0x478b7e;}async function K(){if(R)return{...R};try{let _0x343be5=I(),_0x5aed02=path.join(_0x343be5['cwd'](),'deno.json'),_0x10de60=await _0x343be5['readTextFile'](_0x5aed02);return R=JSON['parse'](_0x10de60)['imports']||{},{...R};}catch(_0x4e28e1){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x4e28e1),{};}}var E=class{constructor(_0x13525d,_0x431e2b={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x13525d['appsDir'],this['platformImportsOverride']=_0x13525d['platformImports'],this['libDir']=_0x13525d['libDir'],this['events']=_0x431e2b);}async['create'](_0xcac3b7,_0x111b04,_0x2fa4f4){try{return await this['createWorker'](_0xcac3b7,_0x111b04,_0x2fa4f4);}catch(_0xfd7470){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0xcac3b7+':',_0xfd7470),_0xfd7470;}}async['createWorker'](_0x222da2,_0x1ac902,_0x10c5a0){let _0x5b8076=this['platformImportsOverride']||await K(),_0x41d43d=q(_0x1ac902,this['libDir'],_0x5b8076)['validateServerImports'](this['appsDir']);if(!_0x41d43d['valid']){let _0x2e06ff=_0x41d43d['violations']['filter'](_0x186130=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x186130)),_0xc746a3=_0x41d43d['serverPath']?_0x41d43d['serverPath']:(_0x1ac902['name']||_0x1ac902['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0xc746a3+':\x20'+_0x2e06ff['join'](',\x20'));}let _0x2a66ee=q(_0x1ac902,this['libDir'],_0x5b8076),_0x179c6d=_0x2a66ee['validate'](_0x5b8076);if(!_0x179c6d['valid'])throw new Error('Invalid\x20config:\x20'+_0x179c6d['errors']['join'](',\x20'));let _0x4da9a4=_0x2a66ee['buildImportMap'](_0x5b8076);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x222da2+':',_0x4da9a4);let _0x57b361=_0x2a66ee['buildPerms'](),_0x2f2202=_0x2a66ee['getReadPaths']();if(_0x57b361['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x57b361['read']);else{let _0x3ccc85=_0x1ac902['name']||_0x222da2,_0x4ee108=this['appsDir']+'/'+_0x3ccc85,_0x1da90c=[_0x4ee108],_0x2ec408=_0x1ac902['metadata']?.['serverPath'];if(_0x2ec408&&typeof _0x2ec408=='string')try{let _0xa72c26=path.dirname(_0x2ec408)['replace'](/\\/g,'/');_0x1da90c['push'](_0xa72c26);}catch{}_0x57b361['read']=_0x1da90c,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x4ee108);}if(_0x2f2202['length']>0x0){if(_0x57b361['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x1f89de=Array['isArray'](_0x57b361['read'])?_0x57b361['read']:[];_0x57b361['read']=[..._0x1f89de,..._0x2f2202],console['log']('[Worker] Added package read permissions:',_0x2f2202);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x57b361['net']||(_0x57b361['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x222da2+':',_0x57b361['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x57b361['read']===!![]?'unrestricted':Array['isArray'](_0x57b361['read'])?_0x57b361['read']['length']:0x0));let _0x40497f=await this['createImportMap'](_0x222da2,_0x4da9a4),_0x34333c=await this['createLock'](_0x222da2,_0x4da9a4),_0x4be230={'type':'module','deno':{'permissions':{}}};_0x4be230['deno']['namespace']=![],_0x4be230['deno']['permissions']=_0x57b361,_0x4be230['deno']['importMap']=_0x40497f,_0x4be230['deno']['lock']=_0x34333c,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x222da2+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x40497f),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x34333c),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x4da9a4)['length']+'\x20('+(Object['keys'](_0x4da9a4)['join'](',\x20')||'none')+')');let _0x1826c9={'worker':new Worker(_0x10c5a0,_0x4be230),'appId':_0x222da2,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x1ac902,'importMapPath':_0x40497f,'lockfilePath':_0x34333c};return this['workers']['set'](_0x222da2,_0x1826c9),this['events']['onCreate']?.(_0x1826c9),_0x1826c9;}async['createLock'](_0x1679c6,_0x450200){let _0x20306c=I(),_0x2d7ac4=path.join(_0x20306c['cwd'](),'storage','temp','lockfiles');await _0x20306c['mkdir'](_0x2d7ac4,{'recursive':!![]});let _0x5e11df=_0x1679c6+'-'+Date['now']()+'.lock',_0x2dded0=path.join(_0x2d7ac4,_0x5e11df),_0x301c92={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x5a6822,_0x45370f]of Object['entries'](_0x450200))if(_0x45370f['startsWith']('npm:'))_0x45370f['replace']('npm:',''),_0x301c92['packages']['specifiers'][_0x5a6822]=_0x45370f;else _0x45370f['startsWith']('file://')&&(_0x301c92['packages']['specifiers'][_0x5a6822]=_0x45370f);let _0x4e9456=JSON['stringify'](_0x301c92,null,0x2);return await _0x20306c['writeTextFile'](_0x2dded0,_0x4e9456),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x2dded0),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x450200)['length']+'):',Object['keys'](_0x450200)),_0x2dded0;}async['createImportMap'](_0x15a328,_0x2f0df8){let _0x381b25=I(),_0x594851=path.join(_0x381b25['cwd'](),'storage','temp','importmaps');await _0x381b25['mkdir'](_0x594851,{'recursive':!![]});let _0x335131=_0x15a328+'-'+Date['now']()+'.json',_0x25b2b2=path.join(_0x594851,_0x335131),_0x4e4e7a=JSON['stringify']({'imports':_0x2f0df8,'scopes':{}},null,0x2);return await _0x381b25['writeTextFile'](_0x25b2b2,_0x4e4e7a),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x25b2b2),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x2f0df8)['length']+'):',Object['keys'](_0x2f0df8)['join'](',\x20')||'none'),_0x25b2b2;}['get'](_0x5ecbda){return this['workers']['get'](_0x5ecbda);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x22596f,_0x29ffa2){let _0x19322d=this['workers']['get'](_0x22596f);if(!_0x19322d)return;let _0x2379ff=_0x19322d['status'];_0x19322d['status']=_0x29ffa2,_0x29ffa2==='running'&&_0x2379ff==='starting'?this['events']['onReady']?.(_0x19322d):_0x29ffa2==='crashed'&&this['events']['onCrash']?.(_0x19322d);}['touch'](_0x26690f){let _0xb53f2f=this['workers']['get'](_0x26690f);_0xb53f2f&&(_0xb53f2f['lastUsed']=Date['now']());}async['stop'](_0x2787bc){let _0x57884c=this['workers']['get'](_0x2787bc);if(_0x57884c)try{_0x57884c['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x57884c['worker']['terminate'](),_0x57884c['status']='stopped',this['events']['onStop']?.(_0x57884c),_0x57884c['importMapPath']&&await this['cleanupImportMap'](_0x57884c['importMapPath']),_0x57884c['lockfilePath']&&await this['cleanupLock'](_0x57884c['lockfilePath']);}catch(_0x2efe7a){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x2787bc+':',_0x2efe7a);}finally{this['workers']['delete'](_0x2787bc);}}async['cleanupImportMap'](_0x4b7fec){try{await I()['remove'](_0x4b7fec),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x4b7fec);}catch(_0x53e990){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x4b7fec,_0x53e990);}}async['cleanupLock'](_0x4060c9){try{await I()['remove'](_0x4060c9),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x4060c9);}catch(_0x4cf7c1){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x4060c9,_0x4cf7c1);}}async['stopAll'](){let _0x3cf090=Array['from'](this['workers']['keys']());await Promise['all'](_0x3cf090['map'](_0x4c05ec=>this['stop'](_0x4c05ec)));}async['restart'](_0x5d21a1,_0x568380){let _0x31292f=this['workers']['get'](_0x5d21a1);if(!_0x31292f)throw new Error('Worker\x20'+_0x5d21a1+'\x20not\x20found');let _0x4adac8=_0x31292f['manifest'];return await this['stop'](_0x5d21a1),await this['create'](_0x5d21a1,_0x4adac8,_0x568380);}['checkHealth'](_0xa0aeea){let _0x24b548=this['workers']['get'](_0xa0aeea);if(!_0x24b548)return{'healthy':![],'reason':'Not\x20found'};if(_0x24b548['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x24b548['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x4624e6=Date['now']()-_0x24b548['lastUsed'],_0x533075=0x708*0x3e8;return _0x4624e6>_0x533075?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x4624e6/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x50928f=0x708*0x3e8,_0x521d57){let _0x42bacb=Date['now'](),_0x90ffe8=[];for(let [_0x2ae5b3,_0x2e72cf]of this['workers']['entries']()){let _0x39e59b=_0x42bacb-_0x2e72cf['lastUsed'];_0x39e59b>_0x50928f&&_0x90ffe8['push']({'appId':_0x2ae5b3,'idle':_0x39e59b});}_0x90ffe8['sort']((_0x7f2e53,_0x12d4a8)=>_0x12d4a8['idle']-_0x7f2e53['idle']);let _0x5d8180=_0x521d57?_0x90ffe8['slice'](0x0,_0x521d57)['map'](_0x416ba0=>_0x416ba0['appId']):_0x90ffe8['map'](_0xcbbd01=>_0xcbbd01['appId']);for(let _0x55f337 of _0x5d8180)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x55f337),await this['stop'](_0x55f337);}['stats'](){let _0x55cd14={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x59561c=Date['now']();for(let _0x5db518 of this['workers']['values']())_0x55cd14['byStatus'][_0x5db518['status']]++,_0x55cd14['workers']['push']({'appId':_0x5db518['appId'],'status':_0x5db518['status'],'version':_0x5db518['version'],'lastUsed':_0x5db518['lastUsed'],'idle':_0x59561c-_0x5db518['lastUsed']});return _0x55cd14;}['startCleanup'](_0x3e0de0=0x12c*0x3e8,_0x1ea32b){let _0x43763f=setInterval(()=>{this['cleanup'](_0x1ea32b)['catch'](_0x265e55=>{console['error']('Cleanup\x20failed:',_0x265e55);});},_0x3e0de0);return()=>clearInterval(_0x43763f);}['delay'](_0x39a48c){return new Promise(_0x5d68c8=>setTimeout(_0x5d68c8,_0x39a48c));}};function W(_0x546191,_0x42f10d){return new E(_0x546191,_0x42f10d);}var v=f,j=class{constructor(_0x527851,_0xf82ccb=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x527851,this['timeout']=_0xf82ccb);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x2b257f){_0x2b257f['worker']['onmessage']=_0x8f7174=>{let _0x2b6150=_0x8f7174['data'],{appId:_0x20925f}=_0x2b257f;switch(_0x2b6150['type']){case'ready':this['events']['onReady'](_0x20925f),v['info']('Worker\x20ready',{'appId':_0x20925f,'version':_0x2b257f['version']});break;case'log':{let {level:_0x2fc0c5='info',message:_0x4427f4,meta:_0x10f3f4}=_0x2b6150,_0x530452={..._0x10f3f4||{},'appId':_0x20925f,'version':_0x2b257f['version']};this['events']['onLog'](_0x20925f,_0x2fc0c5,_0x4427f4,_0x530452);break;}case'result':{let {reqId:_0x43bdfc,ok:_0x125c27,response:_0x28db42,error:_0x10f594}=_0x2b6150,_0x15d474=this['pending']['get'](_0x43bdfc);if(!_0x15d474){v['warn']('Unknown\x20request',{'appId':_0x20925f,'reqId':_0x43bdfc});return;}if(this['pending']['delete'](_0x43bdfc),_0x125c27&&_0x28db42)_0x15d474['resolve'](_0x28db42);else{let _0xc66a84=new Error(_0x10f594?.['message']||'Worker\x20error');_0xc66a84['stack']=_0x10f594?.['stack'],_0x15d474['reject'](_0xc66a84);}this['events']['onResult'](_0x20925f,_0x43bdfc,_0x28db42||_0x10f594);break;}default:v['debug']('Unknown\x20message',{'appId':_0x20925f,'type':_0x2b6150['type']});}},_0x2b257f['worker']['onerror']=_0x1a494a=>{let {appId:_0x110e74}=_0x2b257f;v['error']('Worker\x20error',{'appId':_0x110e74,'message':_0x1a494a['message'],'lineno':_0x1a494a['lineno'],'filename':_0x1a494a['filename']}),_0x2b257f['status']='crashed',this['rejectPending'](_0x110e74,new Error('Worker\x20'+_0x110e74+'\x20crashed:\x20'+_0x1a494a['message'])),_0x1a494a['preventDefault']();},_0x2b257f['worker']['onmessageerror']=_0x5ac6e0=>{let {appId:_0x546a09}=_0x2b257f;v['error']('Message\x20error',{'appId':_0x546a09,'data':_0x5ac6e0['data']}),_0x2b257f['status']='crashed',_0x5ac6e0['preventDefault']();};}['sendInit'](_0x283cf8,_0x1e55ec,_0x1f0349,_0x51ed9c){_0x283cf8['worker']['postMessage']({'type':'init','appId':_0x283cf8['appId'],'manifest':_0x1f0349,'appsDir':_0x1e55ec,'serverPath':_0x51ed9c});}async['sendInvoke'](_0x31a719,_0x460810){let _0x5efb37=this['nextId'](),_0x5fa383=_0x31a719['appId'],_0x37e82d=new Promise((_0x49d174,_0x5b0ee2)=>{let _0x530c00=setTimeout(()=>{this['pending']['delete'](_0x5efb37),_0x5b0ee2(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x5efb37,{'resolve':_0x56e400=>{clearTimeout(_0x530c00),_0x49d174(_0x56e400);},'reject':_0x1556d0=>{clearTimeout(_0x530c00),_0x5b0ee2(_0x1556d0);},'timestamp':Date['now'](),'appId':_0x5fa383});});return _0x31a719['worker']['postMessage']({'type':'invoke','appId':_0x31a719['appId'],'reqId':_0x5efb37,'payload':_0x460810}),await _0x37e82d;}['rejectPending'](_0x1bea8e,_0x1b837d){let _0xf87b06=0x0;for(let [_0x285500,_0x49f35f]of this['pending']['entries']())_0x49f35f['appId']===_0x1bea8e&&(this['pending']['delete'](_0x285500),_0x49f35f['reject'](_0x1b837d),_0xf87b06++);_0xf87b06>0x0&&v['warn']('Rejected\x20'+_0xf87b06+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x1bea8e});}['cleanupTimeout'](){let _0x183de7=Date['now']();for(let [_0x29f9ed,_0xf793b]of this['pending']['entries']())_0x183de7-_0xf793b['timestamp']>this['timeout']&&(this['pending']['delete'](_0x29f9ed),_0xf793b['reject'](new Error('Request\x20'+_0x29f9ed+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x292a92){let _0x40058b=0x0;for(let _0x36c4e8 of this['pending']['values']())_0x36c4e8['appId']===_0x292a92&&_0x40058b++;return _0x40058b;}['startCleanup'](_0x520c1b=0x2710){let _0x5b640d=setInterval(()=>{this['cleanupTimeout']();},_0x520c1b);return()=>clearInterval(_0x5b640d);}};function $(_0x2a0e6e,_0x2933de){return new j(_0x2a0e6e,_0x2933de);}var Q=class{constructor(_0x4f3037={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x4f3037['logger']||f,this['config']={'appsDir':_0x4f3037['appsDir']||this['getAppsDir'](),'scriptUrl':_0x4f3037['scriptUrl']||this['getScriptUrl'](),'timeout':_0x4f3037['timeout']||0x78*0x3e8,'autoCleanup':_0x4f3037['autoCleanup']??!![],'cleanupInterval':_0x4f3037['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x4f3037['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x4f3037['maxWorkers'],'reuseWorkers':_0x4f3037['reuseWorkers']??!![],'workerReuseStrategy':_0x4f3037['workerReuseStrategy']||'lru','enableQueue':_0x4f3037['enableQueue']??!![],'maxQueueSize':_0x4f3037['maxQueueSize']||0x64,'queueTimeout':_0x4f3037['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x2775c9=>this['logger']['info']('Worker\x20created',{'appId':_0x2775c9['appId'],'v':_0x2775c9['version']}),'onReady':_0x124a32=>this['lifecycle']['updateStatus'](_0x124a32['appId'],'running'),'onCrash':_0x4e6c4e=>this['logger']['error']('Worker\x20crashed',{'appId':_0x4e6c4e['appId'],'v':_0x4e6c4e['version']}),'onStop':_0x4de5d6=>this['logger']['info']('Worker\x20stopped',{'appId':_0x4de5d6['appId'],'v':_0x4de5d6['version']})}),this['messaging']=$({'onReady':_0x3520d8=>this['lifecycle']['updateStatus'](_0x3520d8,'running'),'onLog':(_0x10baed,_0x580878,_0x15c132,_0x423280)=>{let _0x41de78={..._0x423280||{},'appId':_0x10baed};switch(_0x580878){case'error':this['logger']['error'](_0x15c132,_0x41de78);break;case'warn':this['logger']['warn'](_0x15c132,_0x41de78);break;case'debug':this['logger']['debug'](_0x15c132,_0x41de78);break;default:this['logger']['info'](_0x15c132,_0x41de78);break;}},'onResult':(_0x7d189e,_0x533fa5,_0x54c41f)=>{this['logger']['debug']('Result\x20received',{'appId':_0x7d189e,'reqId':_0x533fa5});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x59ed72=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x1bf9b7=_0x59ed72['endsWith']('.js')||_0x59ed72['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x1bf9b7,_0x59ed72)['href'];}async['ensure'](_0x3cb2e1){let {id:_0x4ddd82}=_0x3cb2e1,_0x47f52c=this['lifecycle']['get'](_0x4ddd82);if(_0x47f52c){let _0x9020d4=this['lifecycle']['checkHealth'](_0x4ddd82);if(_0x9020d4['healthy'])return this['lifecycle']['touch'](_0x4ddd82),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x4ddd82}),_0x47f52c;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x4ddd82,'reason':_0x9020d4['reason']}),await this['lifecycle']['stop'](_0x4ddd82);}for(;;){let _0x45ecd8=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x45ecd8>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x45ecd8,'max':this['config']['maxWorkers'],'appId':_0x4ddd82}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x3cb2e1);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x3fd52f=await this['loadManifest'](_0x4ddd82,_0x3cb2e1['manifest']),_0x1f464a=await this['lifecycle']['create'](_0x4ddd82,_0x3fd52f,this['config']['scriptUrl']),_0x174ad1=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x174ad1>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x174ad1,'max':this['config']['maxWorkers'],'appId':_0x4ddd82}),await this['lifecycle']['stop'](_0x4ddd82),this['config']['enableQueue'])return await this['waitSlot'](_0x3cb2e1);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x174ad1+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x1f464a);let _0x424d7c=_0x3fd52f['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x1f464a,this['config']['appsDir'],_0x3fd52f,_0x424d7c),this['logger']['info']('Worker\x20created',{'appId':_0x4ddd82,'v':_0x1f464a['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x1f464a;}async['evictIdle'](){let _0x57a97e=this['lifecycle']['getAll']();if(_0x57a97e['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x5a69a0=[..._0x57a97e];this['config']['workerReuseStrategy']==='lru'?_0x5a69a0['sort']((_0x43f220,_0x19b398)=>_0x43f220['lastUsed']-_0x19b398['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x5a69a0['sort']((_0x4eda63,_0x50d623)=>_0x4eda63['version']-_0x50d623['version']);let _0xdedc20=null;for(let _0x39c739 of _0x5a69a0)if(this['messaging']['getAppCount'](_0x39c739['appId'])===0x0){_0xdedc20=_0x39c739;break;}if(!_0xdedc20&&_0x5a69a0['length']>0x0&&(_0xdedc20=_0x5a69a0['reduce']((_0x155321,_0x16fd7c)=>{let _0x20f4bf=this['messaging']['getAppCount'](_0x155321['appId']);return this['messaging']['getAppCount'](_0x16fd7c['appId'])<_0x20f4bf?_0x16fd7c:_0x155321;})),_0xdedc20){let _0x3ba03a=this['messaging']['getAppCount'](_0xdedc20['appId']);return _0x3ba03a>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0xdedc20['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0xdedc20['lastUsed'],'pendingRequests':_0x3ba03a}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0xdedc20['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0xdedc20['lastUsed']}),await this['lifecycle']['stop'](_0xdedc20['appId']),!![];}return![];}['waitSlot'](_0x4c7e72){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x1e4a58,_0x30b49c)=>{let _0x2ff6b8={'info':_0x4c7e72,'resolve':_0x1e4a58,'reject':_0x30b49c,'timestamp':Date['now']()};this['requestQueue']['push'](_0x2ff6b8),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x4c7e72['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x5d3486=setTimeout(()=>{let _0x15b8a3=this['requestQueue']['indexOf'](_0x2ff6b8);_0x15b8a3!==-0x1&&(this['requestQueue']['splice'](_0x15b8a3,0x1),_0x30b49c(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x2ff6b8['resolve']=_0x13d0ee=>{clearTimeout(_0x5d3486),_0x1e4a58(_0x13d0ee);},_0x2ff6b8['reject']=_0x191caf=>{clearTimeout(_0x5d3486),_0x30b49c(_0x191caf);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x554ab6=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x554ab6>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x4fc413=this['requestQueue']['shift']();if(!_0x4fc413)break;try{let _0x556c17=await this['ensure'](_0x4fc413['info']);_0x4fc413['resolve'](_0x556c17);}catch(_0x3c49af){_0x4fc413['reject'](_0x3c49af);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x51fa57,_0x3e308f){let _0x4d093a=this['config']['appsDir']['replace'](/\\/g,'/'),_0x2de9ea=async _0x22ae5a=>{try{let _0x2a4447=globalThis['Deno'];if(!_0x2a4447)return null;let _0x370c48=await _0x2a4447['readTextFile'](_0x22ae5a);return JSON['parse'](_0x370c48);}catch{return null;}};if(_0x3e308f?.['name']){let _0x240e56=await _0x2de9ea(_0x4d093a+'/'+_0x3e308f['name']+'/manifest.json');if(_0x240e56)return _0x240e56;}let _0x43f6d0=await _0x2de9ea(_0x4d093a+'/'+_0x51fa57+'/manifest.json');if(_0x43f6d0)return _0x43f6d0;try{let _0x10f1b6=globalThis['Deno'];if(_0x10f1b6)for await(let _0x4f7a98 of _0x10f1b6['readDir'](_0x4d093a)){if(!_0x4f7a98['isDirectory'])continue;let _0x6eb6a3=_0x4d093a+'/'+_0x4f7a98['name']+'/manifest.json',_0x2e8e9c=await _0x2de9ea(_0x6eb6a3);if(_0x2e8e9c&&(_0x2e8e9c['id']===_0x51fa57||_0x3e308f?.['name']&&_0x2e8e9c['name']===_0x3e308f['name']))return _0x2e8e9c;}}catch(_0x52ed05){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x51fa57,'error':_0x52ed05['message']});}return _0x3e308f||{'id':_0x51fa57,'name':_0x51fa57,'version':'1.0.0'};}async['invoke'](_0x2dd660){let _0x10d7f7=_0x2dd660['ctx']['app']['id'],_0x19f324=_0x2dd660['ctx']['app']['name'];try{let _0x3f1c34={'id':_0x10d7f7,'manifest':{'id':_0x10d7f7,'name':_0x19f324}},_0x2921e3=await this['ensure'](_0x3f1c34);if(_0x2921e3['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x10d7f7}),await this['restart'](_0x10d7f7);let _0x5d7879=await this['ensure'](_0x3f1c34);return this['lifecycle']['touch'](_0x10d7f7),await this['messaging']['sendInvoke'](_0x5d7879,_0x2dd660);}return this['lifecycle']['touch'](_0x10d7f7),await this['messaging']['sendInvoke'](_0x2921e3,_0x2dd660);}catch(_0x232647){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x10d7f7,'error':_0x232647['message'],'stack':_0x232647['stack']}),_0x232647;}}async['stop'](_0x2bbdb0){await this['lifecycle']['stop'](_0x2bbdb0),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x152db3){return await this['lifecycle']['restart'](_0x152db3,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x4abdbb=>({'appId':_0x4abdbb['appId'],'status':_0x4abdbb['status'],'version':_0x4abdbb['version'],'lastUsed':_0x4abdbb['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x3673f1=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x2accd5=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x3673f1(),_0x2accd5();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x3d31e0=>{_0x3d31e0?(await this['stop'](_0x3d31e0),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x3d31e0})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x76877a){return new Q(_0x76877a);}var S=null;function be(_0x45cb41){S=ee(_0x45cb41);}function k(){if(!S)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return S;}async function Pe(_0x254424){return await k()['ensure'](_0x254424);}async function xe(_0x267080){return await k()['invoke'](_0x267080);}function Ie(_0x16f588){k()['stop'](_0x16f588)['catch'](_0x4964aa=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x16f588,'error':_0x4964aa['message']});});}function Re(){k()['stopAll']()['catch'](_0x471008=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x471008['message']});});}function We(){return k()['getStats']();}function $e(){return S;}async function U(_0x3a7a28){await k()['stop'](_0x3a7a28);}async function Se(){await k()['stopAll']();}function Ae(_0x4a80f5){let _0x5a25e7=_0x4a80f5&&typeof _0x4a80f5=='object'?_0x4a80f5:null;if(_0x5a25e7&&'user'in _0x5a25e7)return _0x5a25e7['user'];}function H(_0x38f6d2){let _0x28b675=_0x38f6d2&&typeof _0x38f6d2=='object'?_0x38f6d2:null;if(!_0x28b675)return{};let _0x14b493={};for(let [_0x4cbbe1,_0x454735]of Object['entries'](_0x28b675))_0x4cbbe1!=='user'&&(_0x14b493[_0x4cbbe1]=_0x454735);return _0x14b493;}function O(_0xe2597a){return _0xe2597a?{'id':_0xe2597a['manifest']?.['id']||_0xe2597a['id']||'','name':_0xe2597a['manifest']?.['name']||'','version':_0xe2597a['manifest']?.['version']||'','description':_0xe2597a['manifest']?.['description']||'','icon':_0xe2597a['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x34dc52){return _0x34dc52?.['permissions']||_0x34dc52?.['manifest']?.['permissions']||{};}function F(_0x1c9211){return _0x1c9211?.['manifest']?.['metadata']||{};}function Ce(_0x2974c4){return _0x2974c4?{'appId':_0x2974c4['id'],'appName':_0x2974c4['manifest']?.['name']}:{};}function N(_0x1c8f25,_0x2477c5={}){let {appInfo:_0x7bc4d5=null,status:_0x44b445=0x1f4,defaultMessage:_0xb42bd5='Internal\x20Server\x20Error'}=_0x2477c5,_0x3e53db={'error':_0xb42bd5,'message':_0x1c8f25?.['message']||_0xb42bd5};return _0x7bc4d5&&(_0x3e53db['appId']=_0x7bc4d5['id'],_0x3e53db['appName']=_0x7bc4d5['manifest']?.['name']),_0x1c8f25?.['message']?.['includes']('crashed')&&(_0x3e53db['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x44b445,'body':_0x3e53db};}function qe(_0x34ac98){return _0x34ac98?.['message']?.['includes']('crashed')||![];}function J(_0x3610d9){if(_0x3610d9)try{return JSON['parse'](_0x3610d9);}catch{return _0x3610d9;}}function B(_0xc3150c){try{let _0x1aa14a=new URL(_0xc3150c),_0x2c28a9={};for(let _0x13e043 of _0x1aa14a['searchParams']['keys']()){let _0x28daaa=_0x1aa14a['searchParams']['getAll'](_0x13e043)['map'](_0x424e5b=>_0x424e5b);_0x28daaa['length']<=0x1?_0x2c28a9[_0x13e043]=_0x28daaa[0x0]??'':_0x2c28a9[_0x13e043]=_0x28daaa;}return _0x2c28a9;}catch{return{};}}function Le(_0xf8b9e9){return(()=>{try{return new URL(_0xf8b9e9)['pathname'];}catch{return _0xf8b9e9;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0xd40443,_0x110929){let _0x5eafd0=_0xd40443;if(_0x110929&&_0x5eafd0['startsWith']('/apps/'+_0x110929))_0x5eafd0=_0x5eafd0['substring'](('/apps/'+_0x110929)['length'])||'/';else{let _0x122f1=_0x5eafd0['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x122f1&&(_0x5eafd0=_0x122f1[0x1]||'/');}return _0x5eafd0['startsWith']('/api')&&(_0x5eafd0=_0x5eafd0['substring'](0x4)||'/'),_0x5eafd0;}function Ue(_0x3d59ed,_0x2c493e){let _0x12fb52=_0x3d59ed;if(_0x2c493e&&_0x12fb52['startsWith']('/apps/'+_0x2c493e))_0x12fb52=_0x12fb52['substring'](('/apps/'+_0x2c493e)['length'])||'/';else{let _0x153e0d=_0x12fb52['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x153e0d&&(_0x12fb52=_0x153e0d[0x1]||'/');}return(!_0x12fb52||_0x12fb52==='/')&&(_0x12fb52='/index.html'),_0x12fb52;}async function He(_0x4bdd6e,_0x3c239e){return await _0x3c239e(_0x4bdd6e);}function _(_0x9c9ae4){return _0x9c9ae4['split']('/')['filter'](_0x390ab8=>_0x390ab8['length']>0x0);}function te(_0x339ae7){try{return decodeURIComponent(_0x339ae7);}catch{return _0x339ae7;}}function re(_0x55c7e3,_0x343347){let _0x3d9516=_(_0x55c7e3),_0x5bed1d=_(_0x343347),_0x369f04={},_0x4cc165=0x0,_0x343104=0x0;for(;_0x4cc165<_0x3d9516['length']&&_0x343104<_0x5bed1d['length'];){let _0x48f1a7=_0x3d9516[_0x4cc165],_0x53a3cc=_0x5bed1d[_0x343104];if(_0x48f1a7==='*')break;if(_0x48f1a7['startsWith'](':')){let _0x4d0c23=_0x48f1a7['slice'](0x1);_0x4d0c23&&(_0x369f04[_0x4d0c23]=te(_0x53a3cc)),_0x4cc165++,_0x343104++;continue;}if(_0x48f1a7!==_0x53a3cc)return{};_0x4cc165++,_0x343104++;}return _0x4cc165===_0x3d9516['length']||_0x4cc165===_0x3d9516['length']-0x1&&_0x3d9516[_0x4cc165]==='*',_0x369f04;}async function Oe(_0x2e89eb,_0x492ed7,_0x1b76dd,_0x2b1dfd,_0x5f140f=void 0x0,_0x326bab){let _0x49b77a=await _0x492ed7['text'](),_0x2c6886=J(_0x49b77a),_0x1f8bde=B(_0x492ed7['url']),_0x4759b9={...F(_0x2e89eb),'user':_0x5f140f},_0x48dd57=H(_0x4759b9),_0x2e3bfa=_0x326bab?re(_0x326bab,_0x492ed7['path']):{};return{'app':O(_0x2e89eb),'permissions':T(_0x2e89eb),'user':_0x5f140f,'metadata':_0x48dd57,'body':_0x2c6886,'query':_0x1f8bde,'params':_0x2e3bfa,'method':_0x1b76dd,'pathname':_0x2b1dfd,'requestUrl':_0x492ed7['url'],'headers':Object['fromEntries'](_0x492ed7['raw']['headers']['entries']())};}function Te(_0x1f5ca8){return{'method':_0x1f5ca8['method'],'pathname':_0x1f5ca8['pathname'],'ctx':_0x1f5ca8};}function Fe(_0x3fe738,_0x23fd94){let {status:_0x72a232=0xc8,headers:_0x2c1af2={},body:_0x2d6edc,type:_0x21ed23}=_0x3fe738??{};return _0x21ed23==='raw'?new globalThis['Response'](String(_0x2d6edc??''),{'status':_0x72a232,'headers':_0x2c1af2}):_0x23fd94(_0x2d6edc,_0x72a232);}function Ne(_0x47288c,_0x5cad6e=null){return N(_0x47288c,{'appInfo':_0x5cad6e});}var V=f;async function Ve(_0x3a4e53){_0x3a4e53?(await U(_0x3a4e53),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x3a4e53)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x443743,_0x17f3c7){let _0x4368bd=Object['fromEntries'](Object['entries'](_0x443743['headers']||{})['map'](([_0x38b70e,_0x5202df])=>[_0x38b70e['toLowerCase'](),_0x5202df]));return{'id':_0x443743['app']['id']||_0x17f3c7['appId']||'','name':_0x443743['app']['name']||'','version':_0x443743['app']['version']||'','description':_0x443743['app']['description']||'','metadata':{..._0x443743['metadata'],'permissions':_0x443743['permissions']},'body':_0x443743['body'],'query':_0x443743['query'],'params':_0x443743?.['params'],'method':_0x443743['method'],'pathname':_0x443743['pathname'],'requestUrl':_0x443743['requestUrl'],'user':_0x443743['user'],'headers':_0x4368bd};}var L=class{constructor(_0x3da841){this['handle']=null,(this['config']=_0x3da841,this['logger']=_0x3da841['logger']||f,this['lifecycle']=W({'appsDir':_0x3da841['appsDir'],'timeout':_0x3da841['timeout'],'platformImports':_0x3da841['platformImports'],'libDir':_0x3da841['libDir']},{'onCreate':_0x5dc584=>this['logger']['info']('Worker\x20created',{'appId':_0x5dc584['appId']}),'onReady':_0x3ca705=>{this['lifecycle']['updateStatus'](_0x3ca705['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x3ca705['appId']});},'onCrash':_0xc34dce=>this['logger']['error']('Worker\x20crashed',{'appId':_0xc34dce['appId']}),'onStop':_0x119163=>this['logger']['info']('Worker\x20stopped',{'appId':_0x119163['appId']})}),this['messaging']=$({'onReady':_0x261ea7=>this['lifecycle']['updateStatus'](_0x261ea7,'running'),'onLog':(_0xc258bc,_0x22dfab,_0x586ae6,_0x16173e)=>{(this['logger'][_0x22dfab]||this['logger']['info'])['call'](this['logger'],_0x586ae6,_0x16173e);},'onResult':()=>{}},_0x3da841['timeout']||0x1d4c0));}async['create'](_0x30cd12){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x1b4bfd=await this['lifecycle']['create'](this['config']['appId'],_0x30cd12,this['config']['scriptUrl']);this['messaging']['setup'](_0x1b4bfd),this['messaging']['sendInit'](_0x1b4bfd,this['config']['appsDir'],_0x30cd12,this['config']['serverPath']),this['handle']=_0x1b4bfd,await this['waitForReady']();}async['waitForReady'](_0x56cea5=0x2710){let _0x4b3767=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x4b3767>_0x56cea5)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x5e7a12=>setTimeout(_0x5e7a12,0x64));}}async['invoke'](_0x43d00e){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x43d00e);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x46300f){return new L(_0x46300f);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=$,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=Pe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ae,exports['findApp']=He,exports['getAppLogMeta']=Ce,exports['getCacheSize']=Ze,exports['getWorkerManager']=$e,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=xe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=Se,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;