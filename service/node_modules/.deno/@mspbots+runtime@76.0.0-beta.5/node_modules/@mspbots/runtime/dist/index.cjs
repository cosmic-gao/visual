'use strict';var path=require('path'),Y=require('process'),promises=require('fs/promises'),_documentCurrentScript=typeof document!=='undefined'?document['currentScript']:null;function _interopDefault(_0x9c3765){return _0x9c3765&&_0x9c3765['__esModule']?_0x9c3765:{'default':_0x9c3765};}var Y__default=_interopDefault(Y);async function ie(_0x497d0f){try{return await promises['stat'](_0x497d0f),!0x0;}catch{return![];}}var f={'error':(_0x10cd99,_0x54c963)=>console['error']('[ERROR]\x20'+_0x10cd99,_0x54c963),'warn':(_0x1029c3,_0x2defe1)=>console['warn']('[WARN]\x20'+_0x1029c3,_0x2defe1),'info':(_0x485ee8,_0x75e02d)=>console['log']('[INFO]\x20'+_0x485ee8,_0x75e02d),'debug':(_0x112b7b,_0x28788b)=>console['log']('[DEBUG]\x20'+_0x112b7b,_0x28788b)};function z(){let _0x462a3a=globalThis['Deno'];if(!_0x462a3a)throw new Error('Deno is not available');return _0x462a3a;}var D=class{constructor(_0x123a94,_0x3482c4='./lib',_0x5dbf2f={}){this['manifest']=_0x123a94,this['libDir']=_0x3482c4,this['platformImports']=_0x5dbf2f;}['buildPerms'](){let _0x1e8d4b=this['manifest']['permissions']||{},_0x21d60b={};return _0x1e8d4b['net']!==void 0x0&&(_0x21d60b['net']=_0x1e8d4b['net']===!![]?!![]:Array['isArray'](_0x1e8d4b['net'])?_0x1e8d4b['net']:[]),_0x1e8d4b['read']!==void 0x0&&(_0x21d60b['read']=_0x1e8d4b['read']===!![]?!![]:Array['isArray'](_0x1e8d4b['read'])?_0x1e8d4b['read']:[]),_0x1e8d4b['write']!==void 0x0&&(_0x21d60b['write']=_0x1e8d4b['write']===!![]?!![]:Array['isArray'](_0x1e8d4b['write'])?_0x1e8d4b['write']:[]),_0x1e8d4b['env']!==void 0x0&&(_0x21d60b['env']=_0x1e8d4b['env']===!![]?!![]:Array['isArray'](_0x1e8d4b['env'])?_0x1e8d4b['env']:[]),_0x1e8d4b['run']!==void 0x0&&(_0x21d60b['run']=_0x1e8d4b['run']===!![]?!![]:Array['isArray'](_0x1e8d4b['run'])?_0x1e8d4b['run']:[]),_0x1e8d4b['ffi']!==void 0x0&&(_0x21d60b['ffi']=_0x1e8d4b['ffi']===!![]?!![]:Array['isArray'](_0x1e8d4b['ffi'])?_0x1e8d4b['ffi']:[]),_0x1e8d4b['sys']!==void 0x0&&(_0x21d60b['sys']=_0x1e8d4b['sys']===!![]?!![]:Array['isArray'](_0x1e8d4b['sys'])?_0x1e8d4b['sys']:[]),_0x1e8d4b['hrtime']!==void 0x0&&(_0x21d60b['hrtime']=_0x1e8d4b['hrtime']),_0x21d60b;}['normalize'](_0x5b2fdf){return _0x5b2fdf===!![]?[]:Array['isArray'](_0x5b2fdf)?_0x5b2fdf:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x3b1b6e){return path.join(this['libDir'],_0x3b1b6e+'@*');}['getReadPaths'](){let _0xfc982c=this['getImports']();_0xfc982c['includes']('*')&&(_0xfc982c=Object['keys'](this['platformImports']));let _0x283583=[];console['log']('[Permissions] Building package path patterns for imports:',_0xfc982c);for(let _0x224e9a of _0xfc982c){let _0x9f4a7b=this['getLibPattern'](_0x224e9a);_0x283583['push'](_0x9f4a7b),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x224e9a+'\x20->\x20'+_0x9f4a7b);}return console['log']('[Permissions] Final package path patterns:',_0x283583),_0x283583;}['buildImportMap'](_0x5eec2a){let _0x4ed9ca=this['getImports'](),_0x2e94f5=_0x4ed9ca['includes']('*')?Object['keys'](_0x5eec2a):_0x4ed9ca;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x2e94f5);let _0x162d25={};for(let _0x33cc9c of _0x2e94f5)if(_0x5eec2a[_0x33cc9c])_0x162d25[_0x33cc9c]=_0x5eec2a[_0x33cc9c],console['log']('[ImportMap]\x20'+_0x33cc9c+'\x20->\x20'+_0x5eec2a[_0x33cc9c]+'\x20(from\x20platform)');else try{let _0x2a299d=z(),_0x2d6519=path.join(_0x2a299d['cwd'](),this['libDir']),_0x3a26fa=!0x1;try{for(let _0x186d2e of _0x2a299d['readDirSync'](_0x2d6519))if(_0x186d2e['isDirectory']&&(_0x186d2e['name']===_0x33cc9c||_0x186d2e['name']['startsWith'](_0x33cc9c+'@'))){let _0x180d7a=path.join(_0x2a299d['cwd'](),this['libDir'],_0x186d2e['name'],'index.js')['replace'](/\\/g,'/'),_0x1be742=new URL('file:///'+_0x180d7a)['href'];_0x162d25[_0x33cc9c]=_0x1be742,console['log']('[ImportMap]\x20'+_0x33cc9c+'\x20->\x20'+_0x1be742+'\x20(from\x20lib)'),_0x3a26fa=!0x0;break;}}catch{}_0x3a26fa||console['warn']('[ImportMap]\x20Package\x20'+_0x33cc9c+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x39a13e){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x33cc9c+':',_0x39a13e);}return _0x162d25;}['validateServerImports'](_0xd29efb){let _0xfeffa9=this['manifest']['name']||this['manifest']['id'],_0x503bf3=this['manifest']['metadata']?.['serverPath'],_0x4565b7=_0x5337b8=>_0x5337b8['replace'](/\\/g,'/'),_0x2a6084=z(),_0x532482=_0x36732f=>{try{return _0x2a6084['statSync'](_0x36732f),!0x0;}catch{return![];}},_0xaf885a=_0x503bf3?_0x4565b7(_0x503bf3):void 0x0;if(!_0xaf885a){let _0x24638e=[_0xd29efb+'/service/server.js',_0xd29efb+'/service/server.ts',_0xd29efb+'/'+_0xfeffa9+'/server.js',_0xd29efb+'/'+_0xfeffa9+'/server.ts',_0xd29efb+'/server.js',_0xd29efb+'/server.ts']['map'](_0x4565b7);for(let _0x1c0e56 of _0x24638e)if(_0x532482(_0x1c0e56)){_0xaf885a=_0x1c0e56;break;}}if(!_0xaf885a)return{'valid':![],'violations':['Failed to locate server module']};let _0x494d1d='';try{_0x494d1d=_0x2a6084['readTextFileSync'](_0xaf885a);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0xaf885a};}let _0x4b11d5=this['getImports']();if(_0x4b11d5['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0xaf885a};let _0x285c4a=_0x4b11d5,_0x214c54=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x2edcb1=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x222999=/\bimport\s*['"]([^'"]+)['"]/g,_0x4ab6cb=[],_0x2a6dda=new Set(),_0xc6d821=_0x543efe=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x543efe),_0x471dad=_0x262599=>{let _0x1503be=_0x262599;if(_0x1503be['startsWith']('./')||_0x1503be['startsWith']('../')||_0x1503be['startsWith']('/')||_0x1503be['startsWith']('file://')||!_0xc6d821(_0x262599)||_0x2a6dda['has'](_0x262599))return;_0x2a6dda['add'](_0x262599),_0x1503be['startsWith']('npm:')&&(_0x1503be=_0x1503be['substring'](0x4)),_0x1503be['includes']('@')&&!_0x1503be['startsWith']('@')&&(_0x1503be=_0x1503be['split']('@')[0x0]);let _0x4dc547=_0x1503be['split']('/')[0x0];_0x285c4a['includes'](_0x4dc547)||_0x285c4a['includes'](_0x262599)||_0x4ab6cb['push'](_0x262599);},_0x513d18;for(;(_0x513d18=_0x214c54['exec'](_0x494d1d))!==null;)_0x471dad(_0x513d18[0x1]);for(;(_0x513d18=_0x2edcb1['exec'](_0x494d1d))!==null;)_0x471dad(_0x513d18[0x1]);for(;(_0x513d18=_0x222999['exec'](_0x494d1d))!==null;)_0x471dad(_0x513d18[0x1]);return{'valid':_0x4ab6cb['length']===0x0,'violations':_0x4ab6cb,'serverPath':_0xaf885a};}['validate'](_0x4bb307={}){let _0x310b9d=[],_0x6217a3=this['manifest']['permissions']||{};for(let [_0x1ebc34,_0x3b3009]of Object['entries'](_0x6217a3))if(_0x1ebc34==='hrtime')typeof _0x3b3009!='boolean'&&_0x310b9d['push']('Permission\x20\x27'+_0x1ebc34+'\x27\x20must\x20be\x20boolean');else{if(_0x1ebc34==='db'){if(typeof _0x3b3009!='object'||_0x3b3009===null||Array['isArray'](_0x3b3009))_0x310b9d['push']('Permission\x20\x27'+_0x1ebc34+'\x27\x20must\x20be\x20an\x20object');else{let _0x55931b=_0x3b3009,_0x92a03a=['user','password']['filter'](_0x4a0fa6=>!(_0x4a0fa6 in _0x55931b));_0x92a03a['length']>0x0&&_0x310b9d['push']('Permission\x20\x27'+_0x1ebc34+'\x27\x20missing\x20required\x20fields:\x20'+_0x92a03a['join'](',\x20'));}}else{if(_0x1ebc34==='imports')continue;}}let _0x223c1c=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x223c1c))_0x310b9d['push']('permissions.imports must be an array');else{for(let _0x5eca44 of _0x223c1c)typeof _0x5eca44!='string'&&_0x310b9d['push']('import\x20\x27'+_0x5eca44+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x310b9d['length']===0x0,'errors':_0x310b9d};}};function q(_0x377291,_0x1c1291,_0x5c4489){return new D(_0x377291,_0x1c1291,_0x5c4489||{});}var R=null;function I(){let _0x4dd012=globalThis['Deno'];if(!_0x4dd012)throw new Error('Deno is not available');return _0x4dd012;}async function K(){if(R)return{...R};try{let _0x4263e9=I(),_0x57b992=path.join(_0x4263e9['cwd'](),'deno.json'),_0x555ce9=await _0x4263e9['readTextFile'](_0x57b992);return R=JSON['parse'](_0x555ce9)['imports']||{},{...R};}catch(_0x10ce2f){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x10ce2f),{};}}var E=class{constructor(_0xb24e4f,_0x26fff9={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0xb24e4f['appsDir'],this['platformImportsOverride']=_0xb24e4f['platformImports'],this['libDir']=_0xb24e4f['libDir'],this['events']=_0x26fff9);}async['create'](_0x459939,_0x23d83e,_0x4c1333){try{return await this['createWorker'](_0x459939,_0x23d83e,_0x4c1333);}catch(_0x2f4732){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x459939+':',_0x2f4732),_0x2f4732;}}async['createWorker'](_0x5ad167,_0x5d6a0d,_0x487ad1){let _0x246fb7=this['platformImportsOverride']||await K(),_0x1c8843=q(_0x5d6a0d,this['libDir'],_0x246fb7)['validateServerImports'](this['appsDir']);if(!_0x1c8843['valid']){let _0x298c05=_0x1c8843['violations']['filter'](_0x391c5a=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x391c5a)),_0xa081b=_0x1c8843['serverPath']?_0x1c8843['serverPath']:(_0x5d6a0d['name']||_0x5d6a0d['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0xa081b+':\x20'+_0x298c05['join'](',\x20'));}let _0x53c68d=q(_0x5d6a0d,this['libDir'],_0x246fb7),_0x2f3e3f=_0x53c68d['validate'](_0x246fb7);if(!_0x2f3e3f['valid'])throw new Error('Invalid\x20config:\x20'+_0x2f3e3f['errors']['join'](',\x20'));let _0x27fb88=_0x53c68d['buildImportMap'](_0x246fb7);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0x5ad167+':',_0x27fb88);let _0x269f18=_0x53c68d['buildPerms'](),_0x5dba31=_0x53c68d['getReadPaths']();if(_0x269f18['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x269f18['read']);else{let _0x177c49=_0x5d6a0d['name']||_0x5ad167,_0x27a408=this['appsDir']+'/'+_0x177c49,_0x864447=[_0x27a408],_0x4b7c06=_0x5d6a0d['metadata']?.['serverPath'];if(_0x4b7c06&&typeof _0x4b7c06=='string')try{let _0x2b710c=path.dirname(_0x4b7c06)['replace'](/\\/g,'/');_0x864447['push'](_0x2b710c);}catch{}_0x269f18['read']=_0x864447,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x27a408);}if(_0x5dba31['length']>0x0){if(_0x269f18['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x56e94e=Array['isArray'](_0x269f18['read'])?_0x269f18['read']:[];_0x269f18['read']=[..._0x56e94e,..._0x5dba31],console['log']('[Worker] Added package read permissions:',_0x5dba31);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x269f18['net']||(_0x269f18['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0x5ad167+':',_0x269f18['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x269f18['read']===!![]?'unrestricted':Array['isArray'](_0x269f18['read'])?_0x269f18['read']['length']:0x0));let _0x49fe27=await this['createImportMap'](_0x5ad167,_0x27fb88),_0x55bf7b=await this['createLock'](_0x5ad167,_0x27fb88),_0x4b644b={'type':'module','deno':{'permissions':{}}};_0x4b644b['deno']['namespace']=![],_0x4b644b['deno']['permissions']=_0x269f18,_0x4b644b['deno']['importMap']=_0x49fe27,_0x4b644b['deno']['lock']=_0x55bf7b,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0x5ad167+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0x49fe27),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x55bf7b),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x27fb88)['length']+'\x20('+(Object['keys'](_0x27fb88)['join'](',\x20')||'none')+')');let _0x2c8183={'worker':new Worker(_0x487ad1,_0x4b644b),'appId':_0x5ad167,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x5d6a0d,'importMapPath':_0x49fe27,'lockfilePath':_0x55bf7b};return this['workers']['set'](_0x5ad167,_0x2c8183),this['events']['onCreate']?.(_0x2c8183),_0x2c8183;}async['createLock'](_0x169c99,_0x5f7297){let _0x4760f0=I(),_0x442090=path.join(_0x4760f0['cwd'](),'storage','temp','lockfiles');await _0x4760f0['mkdir'](_0x442090,{'recursive':!![]});let _0x2fc91e=_0x169c99+'-'+Date['now']()+'.lock',_0x1a6ac5=path.join(_0x442090,_0x2fc91e),_0x3f27dd={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x3553e1,_0xa9d6d3]of Object['entries'](_0x5f7297))if(_0xa9d6d3['startsWith']('npm:'))_0xa9d6d3['replace']('npm:',''),_0x3f27dd['packages']['specifiers'][_0x3553e1]=_0xa9d6d3;else _0xa9d6d3['startsWith']('file://')&&(_0x3f27dd['packages']['specifiers'][_0x3553e1]=_0xa9d6d3);let _0x4c46ce=JSON['stringify'](_0x3f27dd,null,0x2);return await _0x4760f0['writeTextFile'](_0x1a6ac5,_0x4c46ce),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x1a6ac5),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x5f7297)['length']+'):',Object['keys'](_0x5f7297)),_0x1a6ac5;}async['createImportMap'](_0x35d0b9,_0x5e3257){let _0x5a752b=I(),_0x3a3338=path.join(_0x5a752b['cwd'](),'storage','temp','importmaps');await _0x5a752b['mkdir'](_0x3a3338,{'recursive':!![]});let _0x5abc5c=_0x35d0b9+'-'+Date['now']()+'.json',_0x470d5f=path.join(_0x3a3338,_0x5abc5c),_0x227255=JSON['stringify']({'imports':_0x5e3257,'scopes':{}},null,0x2);return await _0x5a752b['writeTextFile'](_0x470d5f,_0x227255),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x470d5f),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x5e3257)['length']+'):',Object['keys'](_0x5e3257)['join'](',\x20')||'none'),_0x470d5f;}['get'](_0x4f4cef){return this['workers']['get'](_0x4f4cef);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x400c4d,_0x9905b1){let _0x5c8d61=this['workers']['get'](_0x400c4d);if(!_0x5c8d61)return;let _0x312707=_0x5c8d61['status'];_0x5c8d61['status']=_0x9905b1,_0x9905b1==='running'&&_0x312707==='starting'?this['events']['onReady']?.(_0x5c8d61):_0x9905b1==='crashed'&&this['events']['onCrash']?.(_0x5c8d61);}['touch'](_0x39d851){let _0x5ecfbb=this['workers']['get'](_0x39d851);_0x5ecfbb&&(_0x5ecfbb['lastUsed']=Date['now']());}async['stop'](_0x2128f3){let _0x30f605=this['workers']['get'](_0x2128f3);if(_0x30f605)try{_0x30f605['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x30f605['worker']['terminate'](),_0x30f605['status']='stopped',this['events']['onStop']?.(_0x30f605),_0x30f605['importMapPath']&&await this['cleanupImportMap'](_0x30f605['importMapPath']),_0x30f605['lockfilePath']&&await this['cleanupLock'](_0x30f605['lockfilePath']);}catch(_0x341087){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x2128f3+':',_0x341087);}finally{this['workers']['delete'](_0x2128f3);}}async['cleanupImportMap'](_0x6761f4){try{await I()['remove'](_0x6761f4),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x6761f4);}catch(_0xa8fdc8){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x6761f4,_0xa8fdc8);}}async['cleanupLock'](_0x1cdd13){try{await I()['remove'](_0x1cdd13),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x1cdd13);}catch(_0x2e9952){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x1cdd13,_0x2e9952);}}async['stopAll'](){let _0x11ea92=Array['from'](this['workers']['keys']());await Promise['all'](_0x11ea92['map'](_0x4f6d41=>this['stop'](_0x4f6d41)));}async['restart'](_0x53b79f,_0x55852e){let _0x75fe22=this['workers']['get'](_0x53b79f);if(!_0x75fe22)throw new Error('Worker\x20'+_0x53b79f+'\x20not\x20found');let _0x57de52=_0x75fe22['manifest'];return await this['stop'](_0x53b79f),await this['create'](_0x53b79f,_0x57de52,_0x55852e);}['checkHealth'](_0x14e46b){let _0x1ced15=this['workers']['get'](_0x14e46b);if(!_0x1ced15)return{'healthy':![],'reason':'Not\x20found'};if(_0x1ced15['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x1ced15['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0x2307be=Date['now']()-_0x1ced15['lastUsed'],_0x2fbfa4=0x708*0x3e8;return _0x2307be>_0x2fbfa4?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0x2307be/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x200d9b=0x708*0x3e8,_0x4c4b7d){let _0x1b1c62=Date['now'](),_0x5b4a9c=[];for(let [_0x117d00,_0x4c5c88]of this['workers']['entries']()){let _0xb2645b=_0x1b1c62-_0x4c5c88['lastUsed'];_0xb2645b>_0x200d9b&&_0x5b4a9c['push']({'appId':_0x117d00,'idle':_0xb2645b});}_0x5b4a9c['sort']((_0x290a11,_0x29150e)=>_0x29150e['idle']-_0x290a11['idle']);let _0x593381=_0x4c4b7d?_0x5b4a9c['slice'](0x0,_0x4c4b7d)['map'](_0x17157d=>_0x17157d['appId']):_0x5b4a9c['map'](_0x174635=>_0x174635['appId']);for(let _0x5e3ec7 of _0x593381)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x5e3ec7),await this['stop'](_0x5e3ec7);}['stats'](){let _0x3311e8={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x25e6f4=Date['now']();for(let _0x281057 of this['workers']['values']())_0x3311e8['byStatus'][_0x281057['status']]++,_0x3311e8['workers']['push']({'appId':_0x281057['appId'],'status':_0x281057['status'],'version':_0x281057['version'],'lastUsed':_0x281057['lastUsed'],'idle':_0x25e6f4-_0x281057['lastUsed']});return _0x3311e8;}['startCleanup'](_0x535f6d=0x12c*0x3e8,_0x260bc1){let _0x520268=setInterval(()=>{this['cleanup'](_0x260bc1)['catch'](_0x58ddc2=>{console['error']('Cleanup\x20failed:',_0x58ddc2);});},_0x535f6d);return()=>clearInterval(_0x520268);}['delay'](_0x24766d){return new Promise(_0x4c4b8a=>setTimeout(_0x4c4b8a,_0x24766d));}};function W(_0x96a117,_0x291de){return new E(_0x96a117,_0x291de);}var v=f,j=class{constructor(_0x3bcc05,_0x23027a=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x3bcc05,this['timeout']=_0x23027a);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x1ca55a){_0x1ca55a['worker']['onmessage']=_0x4a1540=>{let _0x243a64=_0x4a1540['data'],{appId:_0x32d87d}=_0x1ca55a;switch(_0x243a64['type']){case'ready':this['events']['onReady'](_0x32d87d),v['info']('Worker\x20ready',{'appId':_0x32d87d,'version':_0x1ca55a['version']});break;case'log':{let {level:_0x46adc6='info',message:_0x1cdd56,meta:_0x12d0be}=_0x243a64,_0x13cd58={..._0x12d0be||{},'appId':_0x32d87d,'version':_0x1ca55a['version']};this['events']['onLog'](_0x32d87d,_0x46adc6,_0x1cdd56,_0x13cd58);break;}case'result':{let {reqId:_0x298618,ok:_0x4d752c,response:_0x53b83e,error:_0x586c39}=_0x243a64,_0x2ca4ca=this['pending']['get'](_0x298618);if(!_0x2ca4ca){v['warn']('Unknown\x20request',{'appId':_0x32d87d,'reqId':_0x298618});return;}if(this['pending']['delete'](_0x298618),_0x4d752c&&_0x53b83e)_0x2ca4ca['resolve'](_0x53b83e);else{let _0x4972c0=new Error(_0x586c39?.['message']||'Worker\x20error');_0x4972c0['stack']=_0x586c39?.['stack'],_0x2ca4ca['reject'](_0x4972c0);}this['events']['onResult'](_0x32d87d,_0x298618,_0x53b83e||_0x586c39);break;}default:v['debug']('Unknown\x20message',{'appId':_0x32d87d,'type':_0x243a64['type']});}},_0x1ca55a['worker']['onerror']=_0x521cb4=>{let {appId:_0x366ef6}=_0x1ca55a;v['error']('Worker\x20error',{'appId':_0x366ef6,'message':_0x521cb4['message'],'lineno':_0x521cb4['lineno'],'filename':_0x521cb4['filename']}),_0x1ca55a['status']='crashed',this['rejectPending'](_0x366ef6,new Error('Worker\x20'+_0x366ef6+'\x20crashed:\x20'+_0x521cb4['message'])),_0x521cb4['preventDefault']();},_0x1ca55a['worker']['onmessageerror']=_0x166fcd=>{let {appId:_0x5add7c}=_0x1ca55a;v['error']('Message\x20error',{'appId':_0x5add7c,'data':_0x166fcd['data']}),_0x1ca55a['status']='crashed',_0x166fcd['preventDefault']();};}['sendInit'](_0x4553e0,_0x57afe1,_0x12923b,_0x29c65a){_0x4553e0['worker']['postMessage']({'type':'init','appId':_0x4553e0['appId'],'manifest':_0x12923b,'appsDir':_0x57afe1,'serverPath':_0x29c65a});}async['sendInvoke'](_0x90e62a,_0x48601d){let _0xa1f591=this['nextId'](),_0xb2cae9=_0x90e62a['appId'],_0x4b3426=new Promise((_0x16138f,_0x5ae41a)=>{let _0x546898=setTimeout(()=>{this['pending']['delete'](_0xa1f591),_0x5ae41a(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0xa1f591,{'resolve':_0x651f1=>{clearTimeout(_0x546898),_0x16138f(_0x651f1);},'reject':_0x3b3a6f=>{clearTimeout(_0x546898),_0x5ae41a(_0x3b3a6f);},'timestamp':Date['now'](),'appId':_0xb2cae9});});return _0x90e62a['worker']['postMessage']({'type':'invoke','appId':_0x90e62a['appId'],'reqId':_0xa1f591,'payload':_0x48601d}),await _0x4b3426;}['rejectPending'](_0x3bc762,_0x225f27){let _0x5d9149=0x0;for(let [_0x68ae8a,_0x377165]of this['pending']['entries']())_0x377165['appId']===_0x3bc762&&(this['pending']['delete'](_0x68ae8a),_0x377165['reject'](_0x225f27),_0x5d9149++);_0x5d9149>0x0&&v['warn']('Rejected\x20'+_0x5d9149+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x3bc762});}['cleanupTimeout'](){let _0x4c474f=Date['now']();for(let [_0x2eee33,_0x2fcc78]of this['pending']['entries']())_0x4c474f-_0x2fcc78['timestamp']>this['timeout']&&(this['pending']['delete'](_0x2eee33),_0x2fcc78['reject'](new Error('Request\x20'+_0x2eee33+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0xec9868){let _0x55e940=0x0;for(let _0xb44f78 of this['pending']['values']())_0xb44f78['appId']===_0xec9868&&_0x55e940++;return _0x55e940;}['startCleanup'](_0x1c8020=0x2710){let _0x1f6864=setInterval(()=>{this['cleanupTimeout']();},_0x1c8020);return()=>clearInterval(_0x1f6864);}};function S(_0x178926,_0xc5350c){return new j(_0x178926,_0xc5350c);}var Q=class{constructor(_0x3cf6a6={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x3cf6a6['logger']||f,this['config']={'appsDir':_0x3cf6a6['appsDir']||this['getAppsDir'](),'scriptUrl':_0x3cf6a6['scriptUrl']||this['getScriptUrl'](),'timeout':_0x3cf6a6['timeout']||0x78*0x3e8,'autoCleanup':_0x3cf6a6['autoCleanup']??!![],'cleanupInterval':_0x3cf6a6['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x3cf6a6['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x3cf6a6['maxWorkers'],'reuseWorkers':_0x3cf6a6['reuseWorkers']??!![],'workerReuseStrategy':_0x3cf6a6['workerReuseStrategy']||'lru','enableQueue':_0x3cf6a6['enableQueue']??!![],'maxQueueSize':_0x3cf6a6['maxQueueSize']||0x64,'queueTimeout':_0x3cf6a6['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x54df67=>this['logger']['info']('Worker\x20created',{'appId':_0x54df67['appId'],'v':_0x54df67['version']}),'onReady':_0x223159=>this['lifecycle']['updateStatus'](_0x223159['appId'],'running'),'onCrash':_0x2aabdf=>this['logger']['error']('Worker\x20crashed',{'appId':_0x2aabdf['appId'],'v':_0x2aabdf['version']}),'onStop':_0x320b59=>this['logger']['info']('Worker\x20stopped',{'appId':_0x320b59['appId'],'v':_0x320b59['version']})}),this['messaging']=S({'onReady':_0x238081=>this['lifecycle']['updateStatus'](_0x238081,'running'),'onLog':(_0xa41d4e,_0x1a4403,_0x165f3e,_0x5766c4)=>{let _0x466e6b={..._0x5766c4||{},'appId':_0xa41d4e};switch(_0x1a4403){case'error':this['logger']['error'](_0x165f3e,_0x466e6b);break;case'warn':this['logger']['warn'](_0x165f3e,_0x466e6b);break;case'debug':this['logger']['debug'](_0x165f3e,_0x466e6b);break;default:this['logger']['info'](_0x165f3e,_0x466e6b);break;}},'onResult':(_0x5e25d3,_0x4fb28a,_0x2022fe)=>{this['logger']['debug']('Result\x20received',{'appId':_0x5e25d3,'reqId':_0x4fb28a});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return path.join(Y__default['default']['cwd'](),'apps');}['getScriptUrl'](){let _0x133ba3=typeof document==='undefined'?require('u'+'rl')['pathToFileURL'](__filename)['href']:_documentCurrentScript&&_documentCurrentScript['tagName']['toUpperCase']()==='SCRIPT'&&_documentCurrentScript['src']||new URL('index.cjs',document['baseURI'])['href'],_0x2ad685=_0x133ba3['endsWith']('.js')||_0x133ba3['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0x2ad685,_0x133ba3)['href'];}async['ensure'](_0x5b6376){let {id:_0x14db50}=_0x5b6376,_0xc009d6=this['lifecycle']['get'](_0x14db50);if(_0xc009d6){let _0x7c5b89=this['lifecycle']['checkHealth'](_0x14db50);if(_0x7c5b89['healthy'])return this['lifecycle']['touch'](_0x14db50),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x14db50}),_0xc009d6;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x14db50,'reason':_0x7c5b89['reason']}),await this['lifecycle']['stop'](_0x14db50);}for(;;){let _0x42ab82=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x42ab82>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x42ab82,'max':this['config']['maxWorkers'],'appId':_0x14db50}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x5b6376);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x263c84=await this['loadManifest'](_0x14db50,_0x5b6376['manifest']),_0x5c855f=await this['lifecycle']['create'](_0x14db50,_0x263c84,this['config']['scriptUrl']),_0x143ffe=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x143ffe>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x143ffe,'max':this['config']['maxWorkers'],'appId':_0x14db50}),await this['lifecycle']['stop'](_0x14db50),this['config']['enableQueue'])return await this['waitSlot'](_0x5b6376);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x143ffe+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x5c855f);let _0x4de1ba=_0x263c84['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x5c855f,this['config']['appsDir'],_0x263c84,_0x4de1ba),this['logger']['info']('Worker\x20created',{'appId':_0x14db50,'v':_0x5c855f['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x5c855f;}async['evictIdle'](){let _0x4b1110=this['lifecycle']['getAll']();if(_0x4b1110['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0xcb5ffe=[..._0x4b1110];this['config']['workerReuseStrategy']==='lru'?_0xcb5ffe['sort']((_0xa7a9cb,_0x22f5ab)=>_0xa7a9cb['lastUsed']-_0x22f5ab['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0xcb5ffe['sort']((_0x97ae22,_0x2f42e1)=>_0x97ae22['version']-_0x2f42e1['version']);let _0x356b60=null;for(let _0x2b6e1e of _0xcb5ffe)if(this['messaging']['getAppCount'](_0x2b6e1e['appId'])===0x0){_0x356b60=_0x2b6e1e;break;}if(!_0x356b60&&_0xcb5ffe['length']>0x0&&(_0x356b60=_0xcb5ffe['reduce']((_0x2fc0df,_0x176eb0)=>{let _0x3a407d=this['messaging']['getAppCount'](_0x2fc0df['appId']);return this['messaging']['getAppCount'](_0x176eb0['appId'])<_0x3a407d?_0x176eb0:_0x2fc0df;})),_0x356b60){let _0x3688d1=this['messaging']['getAppCount'](_0x356b60['appId']);return _0x3688d1>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x356b60['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x356b60['lastUsed'],'pendingRequests':_0x3688d1}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x356b60['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x356b60['lastUsed']}),await this['lifecycle']['stop'](_0x356b60['appId']),!![];}return![];}['waitSlot'](_0x2eb90e){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x1c7eb9,_0x5f3c31)=>{let _0x6c2df8={'info':_0x2eb90e,'resolve':_0x1c7eb9,'reject':_0x5f3c31,'timestamp':Date['now']()};this['requestQueue']['push'](_0x6c2df8),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0x2eb90e['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x5bf64b=setTimeout(()=>{let _0x2c45f0=this['requestQueue']['indexOf'](_0x6c2df8);_0x2c45f0!==-0x1&&(this['requestQueue']['splice'](_0x2c45f0,0x1),_0x5f3c31(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x6c2df8['resolve']=_0x11548d=>{clearTimeout(_0x5bf64b),_0x1c7eb9(_0x11548d);},_0x6c2df8['reject']=_0x5deefb=>{clearTimeout(_0x5bf64b),_0x5f3c31(_0x5deefb);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x2d69c8=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x2d69c8>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x1d5fdf=this['requestQueue']['shift']();if(!_0x1d5fdf)break;try{let _0x1b0c11=await this['ensure'](_0x1d5fdf['info']);_0x1d5fdf['resolve'](_0x1b0c11);}catch(_0x5b2466){_0x1d5fdf['reject'](_0x5b2466);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x5b1ec8,_0x37b96a){let _0x2b74e0=this['config']['appsDir']['replace'](/\\/g,'/'),_0x3c2cf6=async _0x44380f=>{try{let _0x4fc10d=globalThis['Deno'];if(!_0x4fc10d)return null;let _0x45cc75=await _0x4fc10d['readTextFile'](_0x44380f);return JSON['parse'](_0x45cc75);}catch{return null;}};if(_0x37b96a?.['name']){let _0x3b14ce=await _0x3c2cf6(_0x2b74e0+'/'+_0x37b96a['name']+'/manifest.json');if(_0x3b14ce)return _0x3b14ce;}let _0x3e1ac6=await _0x3c2cf6(_0x2b74e0+'/'+_0x5b1ec8+'/manifest.json');if(_0x3e1ac6)return _0x3e1ac6;try{let _0x33e913=globalThis['Deno'];if(_0x33e913)for await(let _0x6b1c27 of _0x33e913['readDir'](_0x2b74e0)){if(!_0x6b1c27['isDirectory'])continue;let _0xfcfc3d=_0x2b74e0+'/'+_0x6b1c27['name']+'/manifest.json',_0x1ae2ba=await _0x3c2cf6(_0xfcfc3d);if(_0x1ae2ba&&(_0x1ae2ba['id']===_0x5b1ec8||_0x37b96a?.['name']&&_0x1ae2ba['name']===_0x37b96a['name']))return _0x1ae2ba;}}catch(_0xaa10b4){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x5b1ec8,'error':_0xaa10b4['message']});}return _0x37b96a||{'id':_0x5b1ec8,'name':_0x5b1ec8,'version':'1.0.0'};}async['invoke'](_0x1941f0){let _0x5b24eb=_0x1941f0['ctx']['app']['id'],_0x384abf=_0x1941f0['ctx']['app']['name'];try{let _0x331932={'id':_0x5b24eb,'manifest':{'id':_0x5b24eb,'name':_0x384abf}},_0x52f3d9=await this['ensure'](_0x331932);if(_0x52f3d9['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x5b24eb}),await this['restart'](_0x5b24eb);let _0x54930d=await this['ensure'](_0x331932);return this['lifecycle']['touch'](_0x5b24eb),await this['messaging']['sendInvoke'](_0x54930d,_0x1941f0);}return this['lifecycle']['touch'](_0x5b24eb),await this['messaging']['sendInvoke'](_0x52f3d9,_0x1941f0);}catch(_0x20d1a5){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x5b24eb,'error':_0x20d1a5['message'],'stack':_0x20d1a5['stack']}),_0x20d1a5;}}async['stop'](_0x26ff31){await this['lifecycle']['stop'](_0x26ff31),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x21ee4c){return await this['lifecycle']['restart'](_0x21ee4c,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x5642a8=>({'appId':_0x5642a8['appId'],'status':_0x5642a8['status'],'version':_0x5642a8['version'],'lastUsed':_0x5642a8['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x1cd4cc=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x3ede5a=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x1cd4cc(),_0x3ede5a();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x39af11=>{_0x39af11?(await this['stop'](_0x39af11),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x39af11})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x4e3c15){return new Q(_0x4e3c15);}var $=null;function be(_0x3a8cea){$=ee(_0x3a8cea);}function k(){if(!$)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return $;}async function xe(_0x7dff0){return await k()['ensure'](_0x7dff0);}async function Pe(_0x37a256){return await k()['invoke'](_0x37a256);}function Ie(_0x696af3){k()['stop'](_0x696af3)['catch'](_0x20af98=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x696af3,'error':_0x20af98['message']});});}function Re(){k()['stopAll']()['catch'](_0x5e70af=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x5e70af['message']});});}function We(){return k()['getStats']();}function Se(){return $;}async function U(_0x529a61){await k()['stop'](_0x529a61);}async function $e(){await k()['stopAll']();}function Ce(_0xac1709){let _0x4c27d4=_0xac1709&&typeof _0xac1709=='object'?_0xac1709:null;if(_0x4c27d4&&'user'in _0x4c27d4)return _0x4c27d4['user'];}function H(_0x3b11be){let _0xb74fd0=_0x3b11be&&typeof _0x3b11be=='object'?_0x3b11be:null;if(!_0xb74fd0)return{};let _0x468033={};for(let [_0x2ec485,_0x52de5f]of Object['entries'](_0xb74fd0))_0x2ec485!=='user'&&(_0x468033[_0x2ec485]=_0x52de5f);return _0x468033;}function O(_0x2218ac){return _0x2218ac?{'id':_0x2218ac['manifest']?.['id']||_0x2218ac['id']||'','name':_0x2218ac['manifest']?.['name']||'','version':_0x2218ac['manifest']?.['version']||'','description':_0x2218ac['manifest']?.['description']||'','icon':_0x2218ac['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x206c96){return _0x206c96?.['permissions']||_0x206c96?.['manifest']?.['permissions']||{};}function F(_0x2a54fe){return _0x2a54fe?.['manifest']?.['metadata']||{};}function Ae(_0xef9ee9){return _0xef9ee9?{'appId':_0xef9ee9['id'],'appName':_0xef9ee9['manifest']?.['name']}:{};}function N(_0x4fc5e9,_0x514177={}){let {appInfo:_0x20755e=null,status:_0x19fe5f=0x1f4,defaultMessage:_0xf95254='Internal\x20Server\x20Error'}=_0x514177,_0x34de42={'error':_0xf95254,'message':_0x4fc5e9?.['message']||_0xf95254};return _0x20755e&&(_0x34de42['appId']=_0x20755e['id'],_0x34de42['appName']=_0x20755e['manifest']?.['name']),_0x4fc5e9?.['message']?.['includes']('crashed')&&(_0x34de42['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x19fe5f,'body':_0x34de42};}function qe(_0x58c576){return _0x58c576?.['message']?.['includes']('crashed')||![];}function J(_0x481d36){if(_0x481d36)try{return JSON['parse'](_0x481d36);}catch{return _0x481d36;}}function B(_0x435ba2){try{let _0x463740=new URL(_0x435ba2),_0x4a45a3={};for(let _0x50f66c of _0x463740['searchParams']['keys']()){let _0x49ea36=_0x463740['searchParams']['getAll'](_0x50f66c)['map'](_0x2a744c=>_0x2a744c);_0x49ea36['length']<=0x1?_0x4a45a3[_0x50f66c]=_0x49ea36[0x0]??'':_0x4a45a3[_0x50f66c]=_0x49ea36;}return _0x4a45a3;}catch{return{};}}function Le(_0x3cc127){return(()=>{try{return new URL(_0x3cc127)['pathname'];}catch{return _0x3cc127;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x380d8d,_0x3a64ff){let _0x55db17=_0x380d8d;if(_0x3a64ff&&_0x55db17['startsWith']('/apps/'+_0x3a64ff))_0x55db17=_0x55db17['substring'](('/apps/'+_0x3a64ff)['length'])||'/';else{let _0x44f7cc=_0x55db17['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x44f7cc&&(_0x55db17=_0x44f7cc[0x1]||'/');}return _0x55db17['startsWith']('/api')&&(_0x55db17=_0x55db17['substring'](0x4)||'/'),_0x55db17;}function Ue(_0x50758a,_0x4b660e){let _0x59013a=_0x50758a;if(_0x4b660e&&_0x59013a['startsWith']('/apps/'+_0x4b660e))_0x59013a=_0x59013a['substring'](('/apps/'+_0x4b660e)['length'])||'/';else{let _0x5a352f=_0x59013a['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x5a352f&&(_0x59013a=_0x5a352f[0x1]||'/');}return(!_0x59013a||_0x59013a==='/')&&(_0x59013a='/index.html'),_0x59013a;}async function He(_0x238be5,_0xba8a2c){return await _0xba8a2c(_0x238be5);}function _(_0xf12b9){return _0xf12b9['split']('/')['filter'](_0x300e7d=>_0x300e7d['length']>0x0);}function te(_0x27450d){try{return decodeURIComponent(_0x27450d);}catch{return _0x27450d;}}function re(_0x37917c,_0x5640be){let _0x445ccc=_(_0x37917c),_0x232d65=_(_0x5640be),_0x3dd17c={},_0x983023=0x0,_0x49d4dc=0x0;for(;_0x983023<_0x445ccc['length']&&_0x49d4dc<_0x232d65['length'];){let _0x5c6076=_0x445ccc[_0x983023],_0x5e6af6=_0x232d65[_0x49d4dc];if(_0x5c6076==='*')break;if(_0x5c6076['startsWith'](':')){let _0x2951f1=_0x5c6076['slice'](0x1);_0x2951f1&&(_0x3dd17c[_0x2951f1]=te(_0x5e6af6)),_0x983023++,_0x49d4dc++;continue;}if(_0x5c6076!==_0x5e6af6)return{};_0x983023++,_0x49d4dc++;}return _0x983023===_0x445ccc['length']||_0x983023===_0x445ccc['length']-0x1&&_0x445ccc[_0x983023]==='*',_0x3dd17c;}async function Oe(_0x2eace3,_0x2272cb,_0x18f647,_0x55f6af,_0x27dd6b=void 0x0,_0x5524b3){let _0x290e74=await _0x2272cb['text'](),_0x320f9b=J(_0x290e74),_0x3b3939=B(_0x2272cb['url']),_0x1769ce={...F(_0x2eace3),'user':_0x27dd6b},_0x4690cd=H(_0x1769ce),_0x5ac010=_0x5524b3?re(_0x5524b3,_0x2272cb['path']):{};return{'app':O(_0x2eace3),'permissions':T(_0x2eace3),'user':_0x27dd6b,'metadata':_0x4690cd,'body':_0x320f9b,'query':_0x3b3939,'params':_0x5ac010,'method':_0x18f647,'pathname':_0x55f6af,'requestUrl':_0x2272cb['url'],'headers':Object['fromEntries'](_0x2272cb['raw']['headers']['entries']())};}function Te(_0x1444d9){return{'method':_0x1444d9['method'],'pathname':_0x1444d9['pathname'],'ctx':_0x1444d9};}function Fe(_0x2ba48d,_0x4c5716){let {status:_0xbea30d=0xc8,headers:_0x2178ee={},body:_0x41a33e,type:_0x3f3f0a}=_0x2ba48d??{};return _0x3f3f0a==='raw'?new globalThis['Response'](String(_0x41a33e??''),{'status':_0xbea30d,'headers':_0x2178ee}):_0x4c5716(_0x41a33e,_0xbea30d);}function Ne(_0x50b6fc,_0x1654b3=null){return N(_0x50b6fc,{'appInfo':_0x1654b3});}var V=f;async function Ve(_0x432b02){_0x432b02?(await U(_0x432b02),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x432b02)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x103c76,_0x595a3f){let _0x443b69=Object['fromEntries'](Object['entries'](_0x103c76['headers']||{})['map'](([_0x1264cb,_0x487f2f])=>[_0x1264cb['toLowerCase'](),_0x487f2f]));return{'id':_0x103c76['app']['id']||_0x595a3f['appId']||'','name':_0x103c76['app']['name']||'','version':_0x103c76['app']['version']||'','description':_0x103c76['app']['description']||'','metadata':{..._0x103c76['metadata'],'permissions':_0x103c76['permissions']},'body':_0x103c76['body'],'query':_0x103c76['query'],'params':_0x103c76?.['params'],'method':_0x103c76['method'],'pathname':_0x103c76['pathname'],'requestUrl':_0x103c76['requestUrl'],'user':_0x103c76['user'],'headers':_0x443b69};}var L=class{constructor(_0x3a1f45){this['handle']=null,(this['config']=_0x3a1f45,this['logger']=_0x3a1f45['logger']||f,this['lifecycle']=W({'appsDir':_0x3a1f45['appsDir'],'timeout':_0x3a1f45['timeout'],'platformImports':_0x3a1f45['platformImports'],'libDir':_0x3a1f45['libDir']},{'onCreate':_0xcc6c10=>this['logger']['info']('Worker\x20created',{'appId':_0xcc6c10['appId']}),'onReady':_0x2e4a8b=>{this['lifecycle']['updateStatus'](_0x2e4a8b['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x2e4a8b['appId']});},'onCrash':_0x36c781=>this['logger']['error']('Worker\x20crashed',{'appId':_0x36c781['appId']}),'onStop':_0x4d3077=>this['logger']['info']('Worker\x20stopped',{'appId':_0x4d3077['appId']})}),this['messaging']=S({'onReady':_0x1903f6=>this['lifecycle']['updateStatus'](_0x1903f6,'running'),'onLog':(_0x4ea0a9,_0x38a0c1,_0x474ffb,_0x2aadcd)=>{(this['logger'][_0x38a0c1]||this['logger']['info'])['call'](this['logger'],_0x474ffb,_0x2aadcd);},'onResult':()=>{}},_0x3a1f45['timeout']||0x1d4c0));}async['create'](_0x333fa2){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x43abb8=await this['lifecycle']['create'](this['config']['appId'],_0x333fa2,this['config']['scriptUrl']);this['messaging']['setup'](_0x43abb8),this['messaging']['sendInit'](_0x43abb8,this['config']['appsDir'],_0x333fa2,this['config']['serverPath']),this['handle']=_0x43abb8,await this['waitForReady']();}async['waitForReady'](_0x4be3d5=0x2710){let _0x2cf459=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x2cf459>_0x4be3d5)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x223181=>setTimeout(_0x223181,0x64));}}async['invoke'](_0x24ee85){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x24ee85);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x367567){return new L(_0x367567);}exports['Executor']=L,exports['Lifecycle']=E,exports['Manager']=Q,exports['Messaging']=j,exports['PermManager']=D,exports['buildErrorResponse']=N,exports['buildParams']=Ke,exports['buildPayload']=Te,exports['clearModuleCache']=Ve,exports['createExecutor']=rt,exports['createLifecycle']=W,exports['createManager']=ee,exports['createMessaging']=S,exports['createPermManager']=q,exports['createRequestCtx']=Oe,exports['defaultLogger']=f,exports['ensureWorker']=xe,exports['extractApi']=ze,exports['extractAppInfo']=O,exports['extractAppMetadata']=F,exports['extractIdentifier']=Le,exports['extractMetadata']=H,exports['extractPermissions']=T,exports['extractStatic']=Ue,exports['extractUser']=Ce,exports['findApp']=He,exports['getAppLogMeta']=Ae,exports['getCacheSize']=Ze,exports['getWorkerManager']=Se,exports['getWorkerStats']=We,exports['handleError']=Ne,exports['handleResponse']=Fe,exports['initManager']=be,exports['invokeApp']=Pe,exports['isWorkerCrashError']=qe,exports['parseBody']=J,exports['parseQuery']=B,exports['pathExists']=ie,exports['stopAllWorkers']=$e,exports['stopWorker']=U,exports['terminateAllWorkers']=Re,exports['terminateWorker']=Ie;