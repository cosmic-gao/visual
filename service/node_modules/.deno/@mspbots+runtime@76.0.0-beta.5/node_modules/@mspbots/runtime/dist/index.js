import{join,dirname}from'path';import _0x29abc8 from'process';import{stat}from'fs/promises';async function ie(_0x49e243){try{return await stat(_0x49e243),!0x0;}catch{return![];}}var f={'error':(_0x224e98,_0xd6eb61)=>console['error']('[ERROR]\x20'+_0x224e98,_0xd6eb61),'warn':(_0x4fcbfb,_0x45c614)=>console['warn']('[WARN]\x20'+_0x4fcbfb,_0x45c614),'info':(_0x1f428d,_0x3b0c42)=>console['log']('[INFO]\x20'+_0x1f428d,_0x3b0c42),'debug':(_0x551e57,_0x53a60f)=>console['log']('[DEBUG]\x20'+_0x551e57,_0x53a60f)};function z(){let _0x5cacdd=globalThis['Deno'];if(!_0x5cacdd)throw new Error('Deno is not available');return _0x5cacdd;}var D=class{constructor(_0x36ff9c,_0x1ef5de='./lib',_0x4c178a={}){this['manifest']=_0x36ff9c,this['libDir']=_0x1ef5de,this['platformImports']=_0x4c178a;}['buildPerms'](){let _0x2968b3=this['manifest']['permissions']||{},_0x5c896a={};return _0x2968b3['net']!==void 0x0&&(_0x5c896a['net']=_0x2968b3['net']===!![]?!![]:Array['isArray'](_0x2968b3['net'])?_0x2968b3['net']:[]),_0x2968b3['read']!==void 0x0&&(_0x5c896a['read']=_0x2968b3['read']===!![]?!![]:Array['isArray'](_0x2968b3['read'])?_0x2968b3['read']:[]),_0x2968b3['write']!==void 0x0&&(_0x5c896a['write']=_0x2968b3['write']===!![]?!![]:Array['isArray'](_0x2968b3['write'])?_0x2968b3['write']:[]),_0x2968b3['env']!==void 0x0&&(_0x5c896a['env']=_0x2968b3['env']===!![]?!![]:Array['isArray'](_0x2968b3['env'])?_0x2968b3['env']:[]),_0x2968b3['run']!==void 0x0&&(_0x5c896a['run']=_0x2968b3['run']===!![]?!![]:Array['isArray'](_0x2968b3['run'])?_0x2968b3['run']:[]),_0x2968b3['ffi']!==void 0x0&&(_0x5c896a['ffi']=_0x2968b3['ffi']===!![]?!![]:Array['isArray'](_0x2968b3['ffi'])?_0x2968b3['ffi']:[]),_0x2968b3['sys']!==void 0x0&&(_0x5c896a['sys']=_0x2968b3['sys']===!![]?!![]:Array['isArray'](_0x2968b3['sys'])?_0x2968b3['sys']:[]),_0x2968b3['hrtime']!==void 0x0&&(_0x5c896a['hrtime']=_0x2968b3['hrtime']),_0x5c896a;}['normalize'](_0x207cf1){return _0x207cf1===!![]?[]:Array['isArray'](_0x207cf1)?_0x207cf1:[];}['getImports'](){return this['manifest']['permissions']?.['imports']||[];}['getLibPattern'](_0x4397c1){return join(this['libDir'],_0x4397c1+'@*');}['getReadPaths'](){let _0x31735e=this['getImports']();_0x31735e['includes']('*')&&(_0x31735e=Object['keys'](this['platformImports']));let _0x531fdd=[];console['log']('[Permissions] Building package path patterns for imports:',_0x31735e);for(let _0x2af336 of _0x31735e){let _0xbf9080=this['getLibPattern'](_0x2af336);_0x531fdd['push'](_0xbf9080),console['log']('[Permissions]\x20Package\x20path\x20pattern:\x20'+_0x2af336+'\x20->\x20'+_0xbf9080);}return console['log']('[Permissions] Final package path patterns:',_0x531fdd),_0x531fdd;}['buildImportMap'](_0x573709){let _0x4cebbf=this['getImports'](),_0x55d227=_0x4cebbf['includes']('*')?Object['keys'](_0x573709):_0x4cebbf;console['log']('[ImportMap]\x20Building\x20import\x20map\x20for\x20allowed\x20imports:',_0x55d227);let _0x2cba9f={};for(let _0x2e71a3 of _0x55d227)if(_0x573709[_0x2e71a3])_0x2cba9f[_0x2e71a3]=_0x573709[_0x2e71a3],console['log']('[ImportMap]\x20'+_0x2e71a3+'\x20->\x20'+_0x573709[_0x2e71a3]+'\x20(from\x20platform)');else try{let _0x286fb5=z(),_0x403907=join(_0x286fb5['cwd'](),this['libDir']),_0x193a7c=!0x1;try{for(let _0x96cfc1 of _0x286fb5['readDirSync'](_0x403907))if(_0x96cfc1['isDirectory']&&(_0x96cfc1['name']===_0x2e71a3||_0x96cfc1['name']['startsWith'](_0x2e71a3+'@'))){let _0x162349=join(_0x286fb5['cwd'](),this['libDir'],_0x96cfc1['name'],'index.js')['replace'](/\\/g,'/'),_0xd8e4=new URL('file:///'+_0x162349)['href'];_0x2cba9f[_0x2e71a3]=_0xd8e4,console['log']('[ImportMap]\x20'+_0x2e71a3+'\x20->\x20'+_0xd8e4+'\x20(from\x20lib)'),_0x193a7c=!0x0;break;}}catch{}_0x193a7c||console['warn']('[ImportMap]\x20Package\x20'+_0x2e71a3+'\x20not\x20mapped\x20(not\x20found\x20in\x20lib\x20or\x20platform\x20imports)');}catch(_0x4ba7a9){console['warn']('[ImportMap]\x20Failed\x20to\x20process\x20package\x20'+_0x2e71a3+':',_0x4ba7a9);}return _0x2cba9f;}['validateServerImports'](_0x595c10){let _0x5a13cf=this['manifest']['name']||this['manifest']['id'],_0x5b1100=this['manifest']['metadata']?.['serverPath'],_0x32bff6=_0xf62406=>_0xf62406['replace'](/\\/g,'/'),_0x8638ba=z(),_0x173bf0=_0x2caa5f=>{try{return _0x8638ba['statSync'](_0x2caa5f),!0x0;}catch{return![];}},_0x156a2f=_0x5b1100?_0x32bff6(_0x5b1100):void 0x0;if(!_0x156a2f){let _0x5c34cd=[_0x595c10+'/service/server.js',_0x595c10+'/service/server.ts',_0x595c10+'/'+_0x5a13cf+'/server.js',_0x595c10+'/'+_0x5a13cf+'/server.ts',_0x595c10+'/server.js',_0x595c10+'/server.ts']['map'](_0x32bff6);for(let _0x4a5eb5 of _0x5c34cd)if(_0x173bf0(_0x4a5eb5)){_0x156a2f=_0x4a5eb5;break;}}if(!_0x156a2f)return{'valid':![],'violations':['Failed to locate server module']};let _0x45c983='';try{_0x45c983=_0x8638ba['readTextFileSync'](_0x156a2f);}catch{return{'valid':![],'violations':['Failed to read server module'],'serverPath':_0x156a2f};}let _0x198db0=this['getImports']();if(_0x198db0['includes']('*'))return{'valid':!![],'violations':[],'serverPath':_0x156a2f};let _0xe42a9e=_0x198db0,_0x1dbab9=/\bimport\s*(?:type\s+)?(?:{[^}]*}|[\w\*\$,]+)?\s*from\s*['"]([^'"]+)['"]/g,_0x2d0b2d=/\bimport\(\s*['"]([^'"]+)['"]\s*\)/g,_0x222237=/\bimport\s*['"]([^'"]+)['"]/g,_0x51f680=[],_0x9dad97=new Set(),_0x508d7e=_0x222eb6=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x222eb6),_0x25fd9e=_0x2151a9=>{let _0x71a8ab=_0x2151a9;if(_0x71a8ab['startsWith']('./')||_0x71a8ab['startsWith']('../')||_0x71a8ab['startsWith']('/')||_0x71a8ab['startsWith']('file://')||!_0x508d7e(_0x2151a9)||_0x9dad97['has'](_0x2151a9))return;_0x9dad97['add'](_0x2151a9),_0x71a8ab['startsWith']('npm:')&&(_0x71a8ab=_0x71a8ab['substring'](0x4)),_0x71a8ab['includes']('@')&&!_0x71a8ab['startsWith']('@')&&(_0x71a8ab=_0x71a8ab['split']('@')[0x0]);let _0x3c5eff=_0x71a8ab['split']('/')[0x0];_0xe42a9e['includes'](_0x3c5eff)||_0xe42a9e['includes'](_0x2151a9)||_0x51f680['push'](_0x2151a9);},_0x95e0b5;for(;(_0x95e0b5=_0x1dbab9['exec'](_0x45c983))!==null;)_0x25fd9e(_0x95e0b5[0x1]);for(;(_0x95e0b5=_0x2d0b2d['exec'](_0x45c983))!==null;)_0x25fd9e(_0x95e0b5[0x1]);for(;(_0x95e0b5=_0x222237['exec'](_0x45c983))!==null;)_0x25fd9e(_0x95e0b5[0x1]);return{'valid':_0x51f680['length']===0x0,'violations':_0x51f680,'serverPath':_0x156a2f};}['validate'](_0x4126c9={}){let _0x373a74=[],_0x4b759f=this['manifest']['permissions']||{};for(let [_0x14995f,_0x3e8920]of Object['entries'](_0x4b759f))if(_0x14995f==='hrtime')typeof _0x3e8920!='boolean'&&_0x373a74['push']('Permission\x20\x27'+_0x14995f+'\x27\x20must\x20be\x20boolean');else{if(_0x14995f==='db'){if(typeof _0x3e8920!='object'||_0x3e8920===null||Array['isArray'](_0x3e8920))_0x373a74['push']('Permission\x20\x27'+_0x14995f+'\x27\x20must\x20be\x20an\x20object');else{let _0x33c074=_0x3e8920,_0x599332=['user','password']['filter'](_0x5bb802=>!(_0x5bb802 in _0x33c074));_0x599332['length']>0x0&&_0x373a74['push']('Permission\x20\x27'+_0x14995f+'\x27\x20missing\x20required\x20fields:\x20'+_0x599332['join'](',\x20'));}}else{if(_0x14995f==='imports')continue;}}let _0x176ef0=this['manifest']['permissions']?.['imports']||[];if(!Array['isArray'](_0x176ef0))_0x373a74['push']('permissions.imports must be an array');else{for(let _0x42fe99 of _0x176ef0)typeof _0x42fe99!='string'&&_0x373a74['push']('import\x20\x27'+_0x42fe99+'\x27\x20must\x20be\x20a\x20string');}return{'valid':_0x373a74['length']===0x0,'errors':_0x373a74};}};function q(_0x289b84,_0x9fa3d3,_0x118253){return new D(_0x289b84,_0x9fa3d3,_0x118253||{});}var R=null;function I(){let _0x30f5d7=globalThis['Deno'];if(!_0x30f5d7)throw new Error('Deno is not available');return _0x30f5d7;}async function K(){if(R)return{...R};try{let _0x7a90d9=I(),_0x1cb64c=join(_0x7a90d9['cwd'](),'deno.json'),_0x1c5a64=await _0x7a90d9['readTextFile'](_0x1cb64c);return R=JSON['parse'](_0x1c5a64)['imports']||{},{...R};}catch(_0x5f4305){return console['warn']('Failed\x20to\x20load\x20platform\x20imports:',_0x5f4305),{};}}var E=class{constructor(_0x22d42f,_0x4ced2f={}){this['workers']=new Map(),this['version']=0x1,(this['appsDir']=_0x22d42f['appsDir'],this['platformImportsOverride']=_0x22d42f['platformImports'],this['libDir']=_0x22d42f['libDir'],this['events']=_0x4ced2f);}async['create'](_0x1259b9,_0xd7708e,_0x59b5ec){try{return await this['createWorker'](_0x1259b9,_0xd7708e,_0x59b5ec);}catch(_0x400387){throw console['error']('Failed\x20to\x20create\x20worker\x20for\x20'+_0x1259b9+':',_0x400387),_0x400387;}}async['createWorker'](_0xce944b,_0x36f71e,_0x5a8f57){let _0x41187c=this['platformImportsOverride']||await K(),_0x2a5bce=q(_0x36f71e,this['libDir'],_0x41187c)['validateServerImports'](this['appsDir']);if(!_0x2a5bce['valid']){let _0x5fdc3e=_0x2a5bce['violations']['filter'](_0x18d190=>/^[A-Za-z0-9@\/\:\.\-\_]+$/['test'](_0x18d190)),_0x3b492e=_0x2a5bce['serverPath']?_0x2a5bce['serverPath']:(_0x36f71e['name']||_0x36f71e['id'])+'/server.js';throw new Error('Unauthorized\x20imports\x20in\x20'+_0x3b492e+':\x20'+_0x5fdc3e['join'](',\x20'));}let _0x1359d1=q(_0x36f71e,this['libDir'],_0x41187c),_0x243326=_0x1359d1['validate'](_0x41187c);if(!_0x243326['valid'])throw new Error('Invalid\x20config:\x20'+_0x243326['errors']['join'](',\x20'));let _0x1dbfc5=_0x1359d1['buildImportMap'](_0x41187c);console['log']('[Worker]\x20Import\x20Map\x20for\x20'+_0xce944b+':',_0x1dbfc5);let _0x5f45f7=_0x1359d1['buildPerms'](),_0x2215e5=_0x1359d1['getReadPaths']();if(_0x5f45f7['read'])console['log']('[Worker] Custom read permissions from manifest:',_0x5f45f7['read']);else{let _0x5a6cc4=_0x36f71e['name']||_0xce944b,_0x5afcbd=this['appsDir']+'/'+_0x5a6cc4,_0x55c0b3=[_0x5afcbd],_0x2d2a63=_0x36f71e['metadata']?.['serverPath'];if(_0x2d2a63&&typeof _0x2d2a63=='string')try{let _0x114ce0=dirname(_0x2d2a63)['replace'](/\\/g,'/');_0x55c0b3['push'](_0x114ce0);}catch{}_0x5f45f7['read']=_0x55c0b3,console['log']('[Worker]\x20Base\x20read\x20permission\x20(app\x20directory\x20only):\x20'+_0x5afcbd);}if(_0x2215e5['length']>0x0){if(_0x5f45f7['read']===!![])console['log']('[Worker] Read permission is already unrestricted (true), skipping package paths');else{let _0x44122c=Array['isArray'](_0x5f45f7['read'])?_0x5f45f7['read']:[];_0x5f45f7['read']=[..._0x44122c,..._0x2215e5],console['log']('[Worker] Added package read permissions:',_0x2215e5);}}else console['log']('[Worker] No packages declared in manifest.permissions.imports');_0x5f45f7['net']||(_0x5f45f7['net']=[],console['log']('[Worker]\x20Net\x20permission:\x20disabled\x20(no\x20remote\x20imports\x20allowed)')),console['log']('[Worker]\x20Final\x20read\x20permissions\x20for\x20'+_0xce944b+':',_0x5f45f7['read']),console['log']('[Worker]\x20Total\x20read\x20permission\x20scopes:\x20'+(_0x5f45f7['read']===!![]?'unrestricted':Array['isArray'](_0x5f45f7['read'])?_0x5f45f7['read']['length']:0x0));let _0xc4a75c=await this['createImportMap'](_0xce944b,_0x1dbfc5),_0x7003e2=await this['createLock'](_0xce944b,_0x1dbfc5),_0x254222={'type':'module','deno':{'permissions':{}}};_0x254222['deno']['namespace']=![],_0x254222['deno']['permissions']=_0x5f45f7,_0x254222['deno']['importMap']=_0xc4a75c,_0x254222['deno']['lock']=_0x7003e2,console['log']('[Worker]\x20Creating\x20worker\x20for\x20'+_0xce944b+'\x20with\x20security\x20restrictions:'),console['log']('\x20\x20-\x20Import\x20Map:\x20'+_0xc4a75c),console['log']('\x20\x20-\x20Lockfile:\x20'+_0x7003e2),console['log']('\x20\x20-\x20Options:\x20cachedOnly=true,\x20noRemote=true,\x20noNpm=true,\x20namespace=false'),console['log']('\x20\x20-\x20Allowed\x20packages:\x20'+Object['keys'](_0x1dbfc5)['length']+'\x20('+(Object['keys'](_0x1dbfc5)['join'](',\x20')||'none')+')');let _0x54970b={'worker':new Worker(_0x5a8f57,_0x254222),'appId':_0xce944b,'status':'starting','version':this['version']++,'lastUsed':Date['now'](),'manifest':_0x36f71e,'importMapPath':_0xc4a75c,'lockfilePath':_0x7003e2};return this['workers']['set'](_0xce944b,_0x54970b),this['events']['onCreate']?.(_0x54970b),_0x54970b;}async['createLock'](_0x1ba8eb,_0x4179b5){let _0x192b2d=I(),_0x553106=join(_0x192b2d['cwd'](),'storage','temp','lockfiles');await _0x192b2d['mkdir'](_0x553106,{'recursive':!![]});let _0x535b74=_0x1ba8eb+'-'+Date['now']()+'.lock',_0x46e0b9=join(_0x553106,_0x535b74),_0x362f4d={'version':'3','packages':{'specifiers':{}},'remote':{},'npm':{}};for(let [_0x144aba,_0x28f71e]of Object['entries'](_0x4179b5))if(_0x28f71e['startsWith']('npm:'))_0x28f71e['replace']('npm:',''),_0x362f4d['packages']['specifiers'][_0x144aba]=_0x28f71e;else _0x28f71e['startsWith']('file://')&&(_0x362f4d['packages']['specifiers'][_0x144aba]=_0x28f71e);let _0xe16c03=JSON['stringify'](_0x362f4d,null,0x2);return await _0x192b2d['writeTextFile'](_0x46e0b9,_0xe16c03),console['log']('[Worker]\x20Created\x20lockfile:\x20'+_0x46e0b9),console['log']('[Worker]\x20Locked\x20packages\x20('+Object['keys'](_0x4179b5)['length']+'):',Object['keys'](_0x4179b5)),_0x46e0b9;}async['createImportMap'](_0x40e5b9,_0x177640){let _0x27c75c=I(),_0x5b0d6c=join(_0x27c75c['cwd'](),'storage','temp','importmaps');await _0x27c75c['mkdir'](_0x5b0d6c,{'recursive':!![]});let _0x565b2e=_0x40e5b9+'-'+Date['now']()+'.json',_0x3c0a2a=join(_0x5b0d6c,_0x565b2e),_0x29eea0=JSON['stringify']({'imports':_0x177640,'scopes':{}},null,0x2);return await _0x27c75c['writeTextFile'](_0x3c0a2a,_0x29eea0),console['log']('[Worker]\x20Created\x20Import\x20Map\x20file:\x20'+_0x3c0a2a),console['log']('[Worker]\x20Declared\x20packages\x20('+Object['keys'](_0x177640)['length']+'):',Object['keys'](_0x177640)['join'](',\x20')||'none'),_0x3c0a2a;}['get'](_0x5b715e){return this['workers']['get'](_0x5b715e);}['getAll'](){return Array['from'](this['workers']['values']());}['getSize'](){return this['workers']['size'];}['updateStatus'](_0x153a30,_0x338f30){let _0x4ec8d0=this['workers']['get'](_0x153a30);if(!_0x4ec8d0)return;let _0x4ac8fe=_0x4ec8d0['status'];_0x4ec8d0['status']=_0x338f30,_0x338f30==='running'&&_0x4ac8fe==='starting'?this['events']['onReady']?.(_0x4ec8d0):_0x338f30==='crashed'&&this['events']['onCrash']?.(_0x4ec8d0);}['touch'](_0x2b97d7){let _0x5cd5cc=this['workers']['get'](_0x2b97d7);_0x5cd5cc&&(_0x5cd5cc['lastUsed']=Date['now']());}async['stop'](_0x577b62){let _0x479b63=this['workers']['get'](_0x577b62);if(_0x479b63)try{_0x479b63['worker']['postMessage']({'type':'shutdown'}),await this['delay'](0x64),_0x479b63['worker']['terminate'](),_0x479b63['status']='stopped',this['events']['onStop']?.(_0x479b63),_0x479b63['importMapPath']&&await this['cleanupImportMap'](_0x479b63['importMapPath']),_0x479b63['lockfilePath']&&await this['cleanupLock'](_0x479b63['lockfilePath']);}catch(_0x595949){console['error']('Failed\x20to\x20stop\x20worker\x20'+_0x577b62+':',_0x595949);}finally{this['workers']['delete'](_0x577b62);}}async['cleanupImportMap'](_0x5a4122){try{await I()['remove'](_0x5a4122),console['log']('[Worker]\x20Cleaned\x20up\x20Import\x20Map\x20file:\x20'+_0x5a4122);}catch(_0x278e21){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Import\x20Map\x20file:\x20'+_0x5a4122,_0x278e21);}}async['cleanupLock'](_0x3a85ca){try{await I()['remove'](_0x3a85ca),console['log']('[Worker]\x20Cleaned\x20up\x20Lockfile:\x20'+_0x3a85ca);}catch(_0x19bcaa){console['warn']('[Worker]\x20Failed\x20to\x20cleanup\x20Lockfile:\x20'+_0x3a85ca,_0x19bcaa);}}async['stopAll'](){let _0xa73305=Array['from'](this['workers']['keys']());await Promise['all'](_0xa73305['map'](_0x28fce1=>this['stop'](_0x28fce1)));}async['restart'](_0x33896a,_0x803066){let _0x5a8da4=this['workers']['get'](_0x33896a);if(!_0x5a8da4)throw new Error('Worker\x20'+_0x33896a+'\x20not\x20found');let _0x3b7e8a=_0x5a8da4['manifest'];return await this['stop'](_0x33896a),await this['create'](_0x33896a,_0x3b7e8a,_0x803066);}['checkHealth'](_0xf4b253){let _0x479e42=this['workers']['get'](_0xf4b253);if(!_0x479e42)return{'healthy':![],'reason':'Not\x20found'};if(_0x479e42['status']==='crashed')return{'healthy':![],'reason':'Crashed'};if(_0x479e42['status']==='stopped')return{'healthy':![],'reason':'Stopped'};let _0xa7eb67=Date['now']()-_0x479e42['lastUsed'],_0x4fc8a2=0x708*0x3e8;return _0xa7eb67>_0x4fc8a2?{'healthy':![],'reason':'Idle\x20'+Math['floor'](_0xa7eb67/0x3e8)+'s'}:{'healthy':!![]};}async['cleanup'](_0x1aa251=0x708*0x3e8,_0x576602){let _0xbadadf=Date['now'](),_0xedfd73=[];for(let [_0x34b8f1,_0x22d66f]of this['workers']['entries']()){let _0x27b19a=_0xbadadf-_0x22d66f['lastUsed'];_0x27b19a>_0x1aa251&&_0xedfd73['push']({'appId':_0x34b8f1,'idle':_0x27b19a});}_0xedfd73['sort']((_0x423083,_0x2efdbc)=>_0x2efdbc['idle']-_0x423083['idle']);let _0x4ca7e5=_0x576602?_0xedfd73['slice'](0x0,_0x576602)['map'](_0x57c0d0=>_0x57c0d0['appId']):_0xedfd73['map'](_0x2b62cb=>_0x2b62cb['appId']);for(let _0x1eb1ab of _0x4ca7e5)console['log']('Cleaning\x20up\x20idle\x20worker:\x20'+_0x1eb1ab),await this['stop'](_0x1eb1ab);}['stats'](){let _0x4ab0a0={'total':this['workers']['size'],'byStatus':{'starting':0x0,'running':0x0,'crashed':0x0,'stopped':0x0},'workers':[]},_0x3031e2=Date['now']();for(let _0x519108 of this['workers']['values']())_0x4ab0a0['byStatus'][_0x519108['status']]++,_0x4ab0a0['workers']['push']({'appId':_0x519108['appId'],'status':_0x519108['status'],'version':_0x519108['version'],'lastUsed':_0x519108['lastUsed'],'idle':_0x3031e2-_0x519108['lastUsed']});return _0x4ab0a0;}['startCleanup'](_0x17e310=0x12c*0x3e8,_0x36c74d){let _0x561967=setInterval(()=>{this['cleanup'](_0x36c74d)['catch'](_0x77157=>{console['error']('Cleanup\x20failed:',_0x77157);});},_0x17e310);return()=>clearInterval(_0x561967);}['delay'](_0xdac15c){return new Promise(_0x348f7c=>setTimeout(_0x348f7c,_0xdac15c));}};function W(_0x58dbd6,_0x25e97a){return new E(_0x58dbd6,_0x25e97a);}var v=f,j=class{constructor(_0x28bfaa,_0x5bb829=0x78*0x3e8){this['pending']=new Map(),this['seq']=0x1,(this['events']=_0x28bfaa,this['timeout']=_0x5bb829);}['nextId'](){return Date['now']()+'-'+this['seq']++;}['setup'](_0x12325a){_0x12325a['worker']['onmessage']=_0x49beb0=>{let _0x33ed7c=_0x49beb0['data'],{appId:_0x525fd1}=_0x12325a;switch(_0x33ed7c['type']){case'ready':this['events']['onReady'](_0x525fd1),v['info']('Worker\x20ready',{'appId':_0x525fd1,'version':_0x12325a['version']});break;case'log':{let {level:_0x429be0='info',message:_0x4042ba,meta:_0x2f8173}=_0x33ed7c,_0x134556={..._0x2f8173||{},'appId':_0x525fd1,'version':_0x12325a['version']};this['events']['onLog'](_0x525fd1,_0x429be0,_0x4042ba,_0x134556);break;}case'result':{let {reqId:_0x73e82f,ok:_0x274c94,response:_0x3a951d,error:_0x5ca573}=_0x33ed7c,_0x3b8172=this['pending']['get'](_0x73e82f);if(!_0x3b8172){v['warn']('Unknown\x20request',{'appId':_0x525fd1,'reqId':_0x73e82f});return;}if(this['pending']['delete'](_0x73e82f),_0x274c94&&_0x3a951d)_0x3b8172['resolve'](_0x3a951d);else{let _0x5b9832=new Error(_0x5ca573?.['message']||'Worker\x20error');_0x5b9832['stack']=_0x5ca573?.['stack'],_0x3b8172['reject'](_0x5b9832);}this['events']['onResult'](_0x525fd1,_0x73e82f,_0x3a951d||_0x5ca573);break;}default:v['debug']('Unknown\x20message',{'appId':_0x525fd1,'type':_0x33ed7c['type']});}},_0x12325a['worker']['onerror']=_0x1ad5f8=>{let {appId:_0x34785a}=_0x12325a;v['error']('Worker\x20error',{'appId':_0x34785a,'message':_0x1ad5f8['message'],'lineno':_0x1ad5f8['lineno'],'filename':_0x1ad5f8['filename']}),_0x12325a['status']='crashed',this['rejectPending'](_0x34785a,new Error('Worker\x20'+_0x34785a+'\x20crashed:\x20'+_0x1ad5f8['message'])),_0x1ad5f8['preventDefault']();},_0x12325a['worker']['onmessageerror']=_0x4198ad=>{let {appId:_0x4bc45a}=_0x12325a;v['error']('Message\x20error',{'appId':_0x4bc45a,'data':_0x4198ad['data']}),_0x12325a['status']='crashed',_0x4198ad['preventDefault']();};}['sendInit'](_0x2611cf,_0xffec82,_0x1c363c,_0x25943d){_0x2611cf['worker']['postMessage']({'type':'init','appId':_0x2611cf['appId'],'manifest':_0x1c363c,'appsDir':_0xffec82,'serverPath':_0x25943d});}async['sendInvoke'](_0x5dfecf,_0xf20e75){let _0x22015a=this['nextId'](),_0x380a5d=_0x5dfecf['appId'],_0x504aa1=new Promise((_0x2df16a,_0x2e15a8)=>{let _0x33b933=setTimeout(()=>{this['pending']['delete'](_0x22015a),_0x2e15a8(new Error('Request\x20timeout\x20after\x20'+this['timeout']+'ms'));},this['timeout']);this['pending']['set'](_0x22015a,{'resolve':_0x5d4ee8=>{clearTimeout(_0x33b933),_0x2df16a(_0x5d4ee8);},'reject':_0x29da36=>{clearTimeout(_0x33b933),_0x2e15a8(_0x29da36);},'timestamp':Date['now'](),'appId':_0x380a5d});});return _0x5dfecf['worker']['postMessage']({'type':'invoke','appId':_0x5dfecf['appId'],'reqId':_0x22015a,'payload':_0xf20e75}),await _0x504aa1;}['rejectPending'](_0x188a0c,_0x1383de){let _0x3eae9d=0x0;for(let [_0x236926,_0x93936a]of this['pending']['entries']())_0x93936a['appId']===_0x188a0c&&(this['pending']['delete'](_0x236926),_0x93936a['reject'](_0x1383de),_0x3eae9d++);_0x3eae9d>0x0&&v['warn']('Rejected\x20'+_0x3eae9d+'\x20pending\x20requests\x20for\x20crashed\x20worker',{'appId':_0x188a0c});}['cleanupTimeout'](){let _0x4dedf7=Date['now']();for(let [_0x21a636,_0xf3c8a6]of this['pending']['entries']())_0x4dedf7-_0xf3c8a6['timestamp']>this['timeout']&&(this['pending']['delete'](_0x21a636),_0xf3c8a6['reject'](new Error('Request\x20'+_0x21a636+'\x20timeout')));}['getPendingCount'](){return this['pending']['size'];}['getAppCount'](_0x2bef66){let _0x4bcae8=0x0;for(let _0x88e564 of this['pending']['values']())_0x88e564['appId']===_0x2bef66&&_0x4bcae8++;return _0x4bcae8;}['startCleanup'](_0x3f86d4=0x2710){let _0x33f10e=setInterval(()=>{this['cleanupTimeout']();},_0x3f86d4);return()=>clearInterval(_0x33f10e);}};function S(_0x218107,_0x38e763){return new j(_0x218107,_0x38e763);}var Q=class{constructor(_0x49353f={}){this['requestQueue']=[],this['queueProcessing']=![],(this['logger']=_0x49353f['logger']||f,this['config']={'appsDir':_0x49353f['appsDir']||this['getAppsDir'](),'scriptUrl':_0x49353f['scriptUrl']||this['getScriptUrl'](),'timeout':_0x49353f['timeout']||0x78*0x3e8,'autoCleanup':_0x49353f['autoCleanup']??!![],'cleanupInterval':_0x49353f['cleanupInterval']||0x168*0x3e8,'maxIdle':_0x49353f['maxIdle']||0xb4*0x3e8,'maxWorkers':_0x49353f['maxWorkers'],'reuseWorkers':_0x49353f['reuseWorkers']??!![],'workerReuseStrategy':_0x49353f['workerReuseStrategy']||'lru','enableQueue':_0x49353f['enableQueue']??!![],'maxQueueSize':_0x49353f['maxQueueSize']||0x64,'queueTimeout':_0x49353f['queueTimeout']||0x7530},this['lifecycle']=W({'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout']},{'onCreate':_0x3012a1=>this['logger']['info']('Worker\x20created',{'appId':_0x3012a1['appId'],'v':_0x3012a1['version']}),'onReady':_0x1d55e4=>this['lifecycle']['updateStatus'](_0x1d55e4['appId'],'running'),'onCrash':_0x38fddd=>this['logger']['error']('Worker\x20crashed',{'appId':_0x38fddd['appId'],'v':_0x38fddd['version']}),'onStop':_0x4d5b9c=>this['logger']['info']('Worker\x20stopped',{'appId':_0x4d5b9c['appId'],'v':_0x4d5b9c['version']})}),this['messaging']=S({'onReady':_0x15ab11=>this['lifecycle']['updateStatus'](_0x15ab11,'running'),'onLog':(_0x52112b,_0x41888c,_0x2b907d,_0x424adc)=>{let _0xd22760={..._0x424adc||{},'appId':_0x52112b};switch(_0x41888c){case'error':this['logger']['error'](_0x2b907d,_0xd22760);break;case'warn':this['logger']['warn'](_0x2b907d,_0xd22760);break;case'debug':this['logger']['debug'](_0x2b907d,_0xd22760);break;default:this['logger']['info'](_0x2b907d,_0xd22760);break;}},'onResult':(_0x1c6f0a,_0x6cb93c,_0x56776d)=>{this['logger']['debug']('Result\x20received',{'appId':_0x1c6f0a,'reqId':_0x6cb93c});}},this['config']['timeout']),this['config']['autoCleanup']&&this['startCleanup']());}['getAppsDir'](){return join(_0x29abc8['cwd'](),'apps');}['getScriptUrl'](){let _0x53cc96=import.meta.url,_0xe3b40b=_0x53cc96['endsWith']('.js')||_0x53cc96['endsWith']('.cjs')?'./entry.js':'./entry.ts';return new URL(_0xe3b40b,_0x53cc96)['href'];}async['ensure'](_0x9c4d6b){let {id:_0x4653c9}=_0x9c4d6b,_0x3d5d71=this['lifecycle']['get'](_0x4653c9);if(_0x3d5d71){let _0x586a3b=this['lifecycle']['checkHealth'](_0x4653c9);if(_0x586a3b['healthy'])return this['lifecycle']['touch'](_0x4653c9),this['logger']['debug']('Reusing\x20existing\x20worker',{'appId':_0x4653c9}),_0x3d5d71;this['logger']['warn']('Worker\x20unhealthy,\x20restarting',{'appId':_0x4653c9,'reason':_0x586a3b['reason']}),await this['lifecycle']['stop'](_0x4653c9);}for(;;){let _0x5f3a4f=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x5f3a4f>=this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20pool\x20limit\x20reached',{'current':_0x5f3a4f,'max':this['config']['maxWorkers'],'appId':_0x4653c9}),!await this['evictIdle']()){if(this['config']['enableQueue'])return await this['waitSlot'](_0x9c4d6b);throw new Error('Worker\x20pool\x20limit\x20reached\x20('+this['config']['maxWorkers']+')\x20and\x20no\x20idle\x20workers\x20available.\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}continue;}break;}let _0x8b3644=await this['loadManifest'](_0x4653c9,_0x9c4d6b['manifest']),_0x74717f=await this['lifecycle']['create'](_0x4653c9,_0x8b3644,this['config']['scriptUrl']),_0x2aa41a=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x2aa41a>this['config']['maxWorkers']){if(this['logger']['warn']('Worker\x20created\x20but\x20exceeds\x20limit,\x20stopping\x20it\x20and\x20queuing\x20request',{'current':_0x2aa41a,'max':this['config']['maxWorkers'],'appId':_0x4653c9}),await this['lifecycle']['stop'](_0x4653c9),this['config']['enableQueue'])return await this['waitSlot'](_0x9c4d6b);throw new Error('Worker\x20pool\x20limit\x20exceeded\x20('+_0x2aa41a+'\x20>\x20'+this['config']['maxWorkers']+').\x20Queue\x20is\x20disabled.\x20Please\x20enable\x20queue\x20or\x20increase\x20maxWorkers.');}this['messaging']['setup'](_0x74717f);let _0x4fd466=_0x8b3644['metadata']?.['serverPath'];return await this['messaging']['sendInit'](_0x74717f,this['config']['appsDir'],_0x8b3644,_0x4fd466),this['logger']['info']('Worker\x20created',{'appId':_0x4653c9,'v':_0x74717f['version'],'poolSize':this['lifecycle']['getSize'](),'maxWorkers':this['config']['maxWorkers']}),this['processQueue'](),_0x74717f;}async['evictIdle'](){let _0x58b68c=this['lifecycle']['getAll']();if(_0x58b68c['length']===0x0)return![];if(this['config']['workerReuseStrategy']==='none')return this['logger']['warn']('Worker\x20reuse\x20strategy\x20is\x20\x22none\x22,\x20cannot\x20evict\x20worker'),![];let _0x47632e=[..._0x58b68c];this['config']['workerReuseStrategy']==='lru'?_0x47632e['sort']((_0x439282,_0x5eabb2)=>_0x439282['lastUsed']-_0x5eabb2['lastUsed']):this['config']['workerReuseStrategy']==='fifo'&&_0x47632e['sort']((_0x5099c1,_0x37ccc0)=>_0x5099c1['version']-_0x37ccc0['version']);let _0x37eccc=null;for(let _0x5672e3 of _0x47632e)if(this['messaging']['getAppCount'](_0x5672e3['appId'])===0x0){_0x37eccc=_0x5672e3;break;}if(!_0x37eccc&&_0x47632e['length']>0x0&&(_0x37eccc=_0x47632e['reduce']((_0x28399f,_0x52e3d9)=>{let _0x374b97=this['messaging']['getAppCount'](_0x28399f['appId']);return this['messaging']['getAppCount'](_0x52e3d9['appId'])<_0x374b97?_0x52e3d9:_0x28399f;})),_0x37eccc){let _0xd7c1d2=this['messaging']['getAppCount'](_0x37eccc['appId']);return _0xd7c1d2>0x0?this['logger']['warn']('Evicting\x20worker\x20with\x20pending\x20requests',{'appId':_0x37eccc['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x37eccc['lastUsed'],'pendingRequests':_0xd7c1d2}):this['logger']['info']('Evicting\x20idle\x20worker\x20to\x20make\x20room',{'appId':_0x37eccc['appId'],'strategy':this['config']['workerReuseStrategy'],'lastUsed':_0x37eccc['lastUsed']}),await this['lifecycle']['stop'](_0x37eccc['appId']),!![];}return![];}['waitSlot'](_0xb43ac2){if(this['requestQueue']['length']>=this['config']['maxQueueSize'])throw new Error('Worker\x20queue\x20is\x20full\x20('+this['config']['maxQueueSize']+').\x20Please\x20try\x20again\x20later\x20or\x20increase\x20maxQueueSize.');return new Promise((_0x1a1a8f,_0x3a8b7b)=>{let _0x29d154={'info':_0xb43ac2,'resolve':_0x1a1a8f,'reject':_0x3a8b7b,'timestamp':Date['now']()};this['requestQueue']['push'](_0x29d154),this['logger']['info']('Request\x20queued\x20for\x20worker\x20slot',{'appId':_0xb43ac2['id'],'queueSize':this['requestQueue']['length'],'maxQueueSize':this['config']['maxQueueSize']});let _0x262704=setTimeout(()=>{let _0x4bd478=this['requestQueue']['indexOf'](_0x29d154);_0x4bd478!==-0x1&&(this['requestQueue']['splice'](_0x4bd478,0x1),_0x3a8b7b(new Error('Worker\x20queue\x20timeout\x20after\x20'+this['config']['queueTimeout']+'ms')));},this['config']['queueTimeout']);_0x29d154['resolve']=_0x17c816=>{clearTimeout(_0x262704),_0x1a1a8f(_0x17c816);},_0x29d154['reject']=_0x2653da=>{clearTimeout(_0x262704),_0x3a8b7b(_0x2653da);};});}async['processQueue'](){if(!(this['queueProcessing']||this['requestQueue']['length']===0x0)){this['queueProcessing']=!![];try{for(;this['requestQueue']['length']>0x0;){let _0x148645=this['lifecycle']['getSize']();if(this['config']['maxWorkers']&&_0x148645>=this['config']['maxWorkers']&&!await this['evictIdle']())break;let _0x4cc7fc=this['requestQueue']['shift']();if(!_0x4cc7fc)break;try{let _0x171eb9=await this['ensure'](_0x4cc7fc['info']);_0x4cc7fc['resolve'](_0x171eb9);}catch(_0x2bb437){_0x4cc7fc['reject'](_0x2bb437);}}}finally{this['queueProcessing']=![];}}}async['loadManifest'](_0x20f7b1,_0x45bc46){let _0x5bdb4d=this['config']['appsDir']['replace'](/\\/g,'/'),_0x499083=async _0x2e2199=>{try{let _0x2dcb28=globalThis['Deno'];if(!_0x2dcb28)return null;let _0x45d731=await _0x2dcb28['readTextFile'](_0x2e2199);return JSON['parse'](_0x45d731);}catch{return null;}};if(_0x45bc46?.['name']){let _0x4ca982=await _0x499083(_0x5bdb4d+'/'+_0x45bc46['name']+'/manifest.json');if(_0x4ca982)return _0x4ca982;}let _0x319bbf=await _0x499083(_0x5bdb4d+'/'+_0x20f7b1+'/manifest.json');if(_0x319bbf)return _0x319bbf;try{let _0x3a7840=globalThis['Deno'];if(_0x3a7840)for await(let _0x5cc67e of _0x3a7840['readDir'](_0x5bdb4d)){if(!_0x5cc67e['isDirectory'])continue;let _0x18971a=_0x5bdb4d+'/'+_0x5cc67e['name']+'/manifest.json',_0x5192bf=await _0x499083(_0x18971a);if(_0x5192bf&&(_0x5192bf['id']===_0x20f7b1||_0x45bc46?.['name']&&_0x5192bf['name']===_0x45bc46['name']))return _0x5192bf;}}catch(_0x24700d){this['logger']['warn']('Failed\x20to\x20scan\x20apps\x20for\x20manifest',{'appId':_0x20f7b1,'error':_0x24700d['message']});}return _0x45bc46||{'id':_0x20f7b1,'name':_0x20f7b1,'version':'1.0.0'};}async['invoke'](_0x147bd5){let _0x46b36c=_0x147bd5['ctx']['app']['id'],_0x348aac=_0x147bd5['ctx']['app']['name'];try{let _0x36b229={'id':_0x46b36c,'manifest':{'id':_0x46b36c,'name':_0x348aac}},_0x452aec=await this['ensure'](_0x36b229);if(_0x452aec['status']==='crashed'){this['logger']['warn']('Worker\x20crashed,\x20attempting\x20restart',{'appId':_0x46b36c}),await this['restart'](_0x46b36c);let _0x3a2559=await this['ensure'](_0x36b229);return this['lifecycle']['touch'](_0x46b36c),await this['messaging']['sendInvoke'](_0x3a2559,_0x147bd5);}return this['lifecycle']['touch'](_0x46b36c),await this['messaging']['sendInvoke'](_0x452aec,_0x147bd5);}catch(_0x41964b){throw this['logger']['error']('Worker\x20invoke\x20failed',{'appId':_0x46b36c,'error':_0x41964b['message'],'stack':_0x41964b['stack']}),_0x41964b;}}async['stop'](_0x48af4c){await this['lifecycle']['stop'](_0x48af4c),this['processQueue']();}async['stopAll'](){await this['lifecycle']['stopAll'](),this['stopCleanupTask']();}async['restart'](_0x49c6fd){return await this['lifecycle']['restart'](_0x49c6fd,this['config']['scriptUrl']);}['getStats'](){return this['lifecycle']['stats']()['workers']['map'](_0x493b81=>({'appId':_0x493b81['appId'],'status':_0x493b81['status'],'version':_0x493b81['version'],'lastUsed':_0x493b81['lastUsed']}));}['getDetailedStats'](){return{'lifecycle':this['lifecycle']['stats'](),'pending':this['messaging']['getPendingCount'](),'queue':{'size':this['requestQueue']['length'],'maxSize':this['config']['maxQueueSize'],'enabled':this['config']['enableQueue']},'config':{'appsDir':this['config']['appsDir'],'timeout':this['config']['timeout'],'autoCleanup':this['config']['autoCleanup'],'maxWorkers':this['config']['maxWorkers'],'reuseWorkers':this['config']['reuseWorkers'],'workerReuseStrategy':this['config']['workerReuseStrategy'],'enableQueue':this['config']['enableQueue'],'maxQueueSize':this['config']['maxQueueSize'],'queueTimeout':this['config']['queueTimeout']},'poolSize':this['lifecycle']['getSize']()};}['getPoolSize'](){return this['lifecycle']['getSize']();}['startCleanup'](){let _0x26f65d=this['lifecycle']['startCleanup'](this['config']['cleanupInterval'],this['config']['maxIdle']),_0x57ce29=this['messaging']['startCleanup'](0x2710);this['stopCleanup']=()=>{_0x26f65d(),_0x57ce29();},this['logger']['info']('Auto\x20cleanup\x20started',{'interval':this['config']['cleanupInterval'],'maxIdle':this['config']['maxIdle']});}['stopCleanupTask'](){this['stopCleanup']&&(this['stopCleanup'](),this['stopCleanup']=void 0x0,this['logger']['info']('Auto\x20cleanup\x20stopped'));}async['cleanup'](){await this['lifecycle']['cleanup'](this['config']['maxIdle']),this['messaging']['cleanupTimeout'](),this['processQueue']();}['createClearCacheFunction'](){return async _0x38da80=>{_0x38da80?(await this['stop'](_0x38da80),this['logger']['info']('Cache\x20cleared\x20for\x20app',{'appId':_0x38da80})):(await this['stopAll'](),this['logger']['info']('Cache\x20cleared\x20for\x20all\x20apps'));};}};function ee(_0x11b2f3){return new Q(_0x11b2f3);}var $=null;function be(_0x1abe92){$=ee(_0x1abe92);}function k(){if(!$)throw new Error('Runtime\x20Manager\x20not\x20initialized.\x20Call\x20initManager(config)\x20first.');return $;}async function xe(_0x27f3f1){return await k()['ensure'](_0x27f3f1);}async function Pe(_0x1c5061){return await k()['invoke'](_0x1c5061);}function Ie(_0x4e7497){k()['stop'](_0x4e7497)['catch'](_0x3f3bd2=>{f['error']('Failed\x20to\x20stop\x20worker',{'appId':_0x4e7497,'error':_0x3f3bd2['message']});});}function Re(){k()['stopAll']()['catch'](_0x66a95b=>{f['error']('Failed\x20to\x20stop\x20all\x20workers',{'error':_0x66a95b['message']});});}function We(){return k()['getStats']();}function Se(){return $;}async function U(_0x190430){await k()['stop'](_0x190430);}async function $e(){await k()['stopAll']();}function Ce(_0x572f4e){let _0x2be482=_0x572f4e&&typeof _0x572f4e=='object'?_0x572f4e:null;if(_0x2be482&&'user'in _0x2be482)return _0x2be482['user'];}function H(_0x414c74){let _0xc1df6e=_0x414c74&&typeof _0x414c74=='object'?_0x414c74:null;if(!_0xc1df6e)return{};let _0x5ac577={};for(let [_0x2685be,_0x3c7fc9]of Object['entries'](_0xc1df6e))_0x2685be!=='user'&&(_0x5ac577[_0x2685be]=_0x3c7fc9);return _0x5ac577;}function O(_0x3bbd18){return _0x3bbd18?{'id':_0x3bbd18['manifest']?.['id']||_0x3bbd18['id']||'','name':_0x3bbd18['manifest']?.['name']||'','version':_0x3bbd18['manifest']?.['version']||'','description':_0x3bbd18['manifest']?.['description']||'','icon':_0x3bbd18['manifest']?.['icon']||''}:{'id':'','name':'','version':'','description':'','icon':''};}function T(_0x48e4e3){return _0x48e4e3?.['permissions']||_0x48e4e3?.['manifest']?.['permissions']||{};}function F(_0x125201){return _0x125201?.['manifest']?.['metadata']||{};}function Ae(_0x52d078){return _0x52d078?{'appId':_0x52d078['id'],'appName':_0x52d078['manifest']?.['name']}:{};}function N(_0x4a88e5,_0x5c9721={}){let {appInfo:_0xf9c631=null,status:_0x1246cd=0x1f4,defaultMessage:_0x4bdd64='Internal\x20Server\x20Error'}=_0x5c9721,_0x16ff7d={'error':_0x4bdd64,'message':_0x4a88e5?.['message']||_0x4bdd64};return _0xf9c631&&(_0x16ff7d['appId']=_0xf9c631['id'],_0x16ff7d['appName']=_0xf9c631['manifest']?.['name']),_0x4a88e5?.['message']?.['includes']('crashed')&&(_0x16ff7d['message']='Application\x20worker\x20crashed.\x20It\x20will\x20be\x20automatically\x20restarted\x20on\x20next\x20request.'),{'status':_0x1246cd,'body':_0x16ff7d};}function qe(_0x2aa45d){return _0x2aa45d?.['message']?.['includes']('crashed')||![];}function J(_0x1cfa88){if(_0x1cfa88)try{return JSON['parse'](_0x1cfa88);}catch{return _0x1cfa88;}}function B(_0x251c19){try{let _0x1d495f=new URL(_0x251c19),_0x4bb0c9={};for(let _0x18d2a9 of _0x1d495f['searchParams']['keys']()){let _0x22c37a=_0x1d495f['searchParams']['getAll'](_0x18d2a9)['map'](_0x532242=>_0x532242);_0x22c37a['length']<=0x1?_0x4bb0c9[_0x18d2a9]=_0x22c37a[0x0]??'':_0x4bb0c9[_0x18d2a9]=_0x22c37a;}return _0x4bb0c9;}catch{return{};}}function Le(_0x24c0ba){return(()=>{try{return new URL(_0x24c0ba)['pathname'];}catch{return _0x24c0ba;}})()['match'](/^\/apps\/([^\/]+)(?:\/|$)/)?.[0x1]||'';}function ze(_0x2b5472,_0x27099e){let _0x2b8932=_0x2b5472;if(_0x27099e&&_0x2b8932['startsWith']('/apps/'+_0x27099e))_0x2b8932=_0x2b8932['substring'](('/apps/'+_0x27099e)['length'])||'/';else{let _0x58480c=_0x2b8932['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x58480c&&(_0x2b8932=_0x58480c[0x1]||'/');}return _0x2b8932['startsWith']('/api')&&(_0x2b8932=_0x2b8932['substring'](0x4)||'/'),_0x2b8932;}function Ue(_0x12230f,_0x53f391){let _0x274b31=_0x12230f;if(_0x53f391&&_0x274b31['startsWith']('/apps/'+_0x53f391))_0x274b31=_0x274b31['substring'](('/apps/'+_0x53f391)['length'])||'/';else{let _0x3cc788=_0x274b31['match'](/^\/apps\/[^\/]+(\/.*)?$/);_0x3cc788&&(_0x274b31=_0x3cc788[0x1]||'/');}return(!_0x274b31||_0x274b31==='/')&&(_0x274b31='/index.html'),_0x274b31;}async function He(_0x48eb99,_0x3d72c8){return await _0x3d72c8(_0x48eb99);}function _(_0x24b963){return _0x24b963['split']('/')['filter'](_0x2be9ab=>_0x2be9ab['length']>0x0);}function te(_0x24399f){try{return decodeURIComponent(_0x24399f);}catch{return _0x24399f;}}function re(_0x368d09,_0x2bcb0f){let _0x2c3ee2=_(_0x368d09),_0xd8a7d0=_(_0x2bcb0f),_0x1faa29={},_0x19f147=0x0,_0x5d3b48=0x0;for(;_0x19f147<_0x2c3ee2['length']&&_0x5d3b48<_0xd8a7d0['length'];){let _0x1eaa74=_0x2c3ee2[_0x19f147],_0x3a3250=_0xd8a7d0[_0x5d3b48];if(_0x1eaa74==='*')break;if(_0x1eaa74['startsWith'](':')){let _0x1fda2f=_0x1eaa74['slice'](0x1);_0x1fda2f&&(_0x1faa29[_0x1fda2f]=te(_0x3a3250)),_0x19f147++,_0x5d3b48++;continue;}if(_0x1eaa74!==_0x3a3250)return{};_0x19f147++,_0x5d3b48++;}return _0x19f147===_0x2c3ee2['length']||_0x19f147===_0x2c3ee2['length']-0x1&&_0x2c3ee2[_0x19f147]==='*',_0x1faa29;}async function Oe(_0x321b18,_0x3fe44d,_0x50c190,_0x368373,_0x38d91f=void 0x0,_0x14ba46){let _0x5da2f9=await _0x3fe44d['text'](),_0x1f6706=J(_0x5da2f9),_0x11f7b2=B(_0x3fe44d['url']),_0x5665df={...F(_0x321b18),'user':_0x38d91f},_0x3de70b=H(_0x5665df),_0x392d86=_0x14ba46?re(_0x14ba46,_0x3fe44d['path']):{};return{'app':O(_0x321b18),'permissions':T(_0x321b18),'user':_0x38d91f,'metadata':_0x3de70b,'body':_0x1f6706,'query':_0x11f7b2,'params':_0x392d86,'method':_0x50c190,'pathname':_0x368373,'requestUrl':_0x3fe44d['url'],'headers':Object['fromEntries'](_0x3fe44d['raw']['headers']['entries']())};}function Te(_0x43f73d){return{'method':_0x43f73d['method'],'pathname':_0x43f73d['pathname'],'ctx':_0x43f73d};}function Fe(_0x57ea67,_0x290dc0){let {status:_0x16bf44=0xc8,headers:_0x19864b={},body:_0x6807ef,type:_0x48c8a9}=_0x57ea67??{};return _0x48c8a9==='raw'?new globalThis['Response'](String(_0x6807ef??''),{'status':_0x16bf44,'headers':_0x19864b}):_0x290dc0(_0x6807ef,_0x16bf44);}function Ne(_0x4df031,_0x1ff082=null){return N(_0x4df031,{'appInfo':_0x1ff082});}var V=f;async function Ve(_0x243f4b){_0x243f4b?(await U(_0x243f4b),V['debug']('Cleared\x20worker\x20cache\x20for\x20app:\x20'+_0x243f4b)):V['debug']('clearModuleCache()\x20called\x20without\x20appId\x20-\x20no-op\x20in\x20worker\x20mode');}function Ze(){return 0x0;}function Ke(_0x1eee74,_0x3ff630){let _0x2e8db9=Object['fromEntries'](Object['entries'](_0x1eee74['headers']||{})['map'](([_0x725ec,_0x531175])=>[_0x725ec['toLowerCase'](),_0x531175]));return{'id':_0x1eee74['app']['id']||_0x3ff630['appId']||'','name':_0x1eee74['app']['name']||'','version':_0x1eee74['app']['version']||'','description':_0x1eee74['app']['description']||'','metadata':{..._0x1eee74['metadata'],'permissions':_0x1eee74['permissions']},'body':_0x1eee74['body'],'query':_0x1eee74['query'],'params':_0x1eee74?.['params'],'method':_0x1eee74['method'],'pathname':_0x1eee74['pathname'],'requestUrl':_0x1eee74['requestUrl'],'user':_0x1eee74['user'],'headers':_0x2e8db9};}var L=class{constructor(_0x257ddb){this['handle']=null,(this['config']=_0x257ddb,this['logger']=_0x257ddb['logger']||f,this['lifecycle']=W({'appsDir':_0x257ddb['appsDir'],'timeout':_0x257ddb['timeout'],'platformImports':_0x257ddb['platformImports'],'libDir':_0x257ddb['libDir']},{'onCreate':_0x2523f3=>this['logger']['info']('Worker\x20created',{'appId':_0x2523f3['appId']}),'onReady':_0x2c091d=>{this['lifecycle']['updateStatus'](_0x2c091d['appId'],'running'),this['logger']['info']('Worker\x20ready',{'appId':_0x2c091d['appId']});},'onCrash':_0x464cbc=>this['logger']['error']('Worker\x20crashed',{'appId':_0x464cbc['appId']}),'onStop':_0x3593da=>this['logger']['info']('Worker\x20stopped',{'appId':_0x3593da['appId']})}),this['messaging']=S({'onReady':_0x2b149b=>this['lifecycle']['updateStatus'](_0x2b149b,'running'),'onLog':(_0x20b505,_0x25fd23,_0x5e4f59,_0x5906d6)=>{(this['logger'][_0x25fd23]||this['logger']['info'])['call'](this['logger'],_0x5e4f59,_0x5906d6);},'onResult':()=>{}},_0x257ddb['timeout']||0x1d4c0));}async['create'](_0x46a047){if(this['handle'])throw new Error('Worker\x20already\x20created.\x20Call\x20destroy()\x20first.');let _0x316584=await this['lifecycle']['create'](this['config']['appId'],_0x46a047,this['config']['scriptUrl']);this['messaging']['setup'](_0x316584),this['messaging']['sendInit'](_0x316584,this['config']['appsDir'],_0x46a047,this['config']['serverPath']),this['handle']=_0x316584,await this['waitForReady']();}async['waitForReady'](_0x2bc536=0x2710){let _0x534bc8=Date['now']();for(;this['handle']&&this['handle']['status']!=='running';){if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed\x20during\x20initialization');if(Date['now']()-_0x534bc8>_0x2bc536)throw new Error('Worker\x20initialization\x20timeout');await new Promise(_0x346af6=>setTimeout(_0x346af6,0x64));}}async['invoke'](_0x37324d){if(!this['handle'])throw new Error('Worker\x20not\x20created.\x20Call\x20create()\x20first.');if(this['handle']['status']==='crashed')throw new Error('Worker\x20crashed.\x20Create\x20a\x20new\x20executor\x20instance.');return this['lifecycle']['touch'](this['config']['appId']),await this['messaging']['sendInvoke'](this['handle'],_0x37324d);}async['destroy'](){this['handle']&&(await this['lifecycle']['stop'](this['config']['appId']),this['handle']=null);}['getStatus'](){return this['handle']?.['status']||'not-created';}};function rt(_0x4a9452){return new L(_0x4a9452);}export{L as Executor,E as Lifecycle,Q as Manager,j as Messaging,D as PermManager,N as buildErrorResponse,Ke as buildParams,Te as buildPayload,Ve as clearModuleCache,rt as createExecutor,W as createLifecycle,ee as createManager,S as createMessaging,q as createPermManager,Oe as createRequestCtx,f as defaultLogger,xe as ensureWorker,ze as extractApi,O as extractAppInfo,F as extractAppMetadata,Le as extractIdentifier,H as extractMetadata,T as extractPermissions,Ue as extractStatic,Ce as extractUser,He as findApp,Ae as getAppLogMeta,Ze as getCacheSize,Se as getWorkerManager,We as getWorkerStats,Ne as handleError,Fe as handleResponse,be as initManager,Pe as invokeApp,qe as isWorkerCrashError,J as parseBody,B as parseQuery,ie as pathExists,$e as stopAllWorkers,U as stopWorker,Re as terminateAllWorkers,Ie as terminateWorker};