'use strict';function c(_0x39f21d,_0x45bc3c){let _0x491feb=Object['fromEntries'](Object['entries'](_0x39f21d['headers']||{})['map'](([_0x20f1db,_0x3129eb])=>[_0x20f1db['toLowerCase'](),_0x3129eb]));return{'id':_0x39f21d['app']['id']||_0x45bc3c['appId']||'','name':_0x39f21d['app']['name']||'','version':_0x39f21d['app']['version']||'','description':_0x39f21d['app']['description']||'','metadata':{..._0x39f21d['metadata'],'permissions':_0x39f21d['permissions']},'body':_0x39f21d['body'],'query':_0x39f21d['query'],'params':_0x39f21d?.['params'],'method':_0x39f21d['method'],'pathname':_0x39f21d['pathname'],'requestUrl':_0x39f21d['requestUrl'],'user':_0x39f21d['user'],'headers':_0x491feb};}function f(_0x1d7a10){return _0x1d7a10['split']('/')['filter'](_0x1a7c2a=>_0x1a7c2a['length']>0x0);}function P(_0xd9cb54,_0x3e754d){let _0x1a6120=f(_0xd9cb54),_0x44dee8=f(_0x3e754d),_0x1099ae=0x0,_0x876a0c=0x0;for(;_0x1099ae<_0x1a6120['length']&&_0x876a0c<_0x44dee8['length'];){let _0x28e25b=_0x1a6120[_0x1099ae],_0x381239=_0x44dee8[_0x876a0c];if(_0x28e25b==='*')return!![];if(_0x28e25b['startsWith'](':')){_0x1099ae++,_0x876a0c++;continue;}if(_0x28e25b!==_0x381239)return![];_0x1099ae++,_0x876a0c++;}return _0x1099ae===_0x1a6120['length']&&_0x876a0c===_0x44dee8['length']||_0x1099ae===_0x1a6120['length']-0x1&&_0x1a6120[_0x1099ae]==='*';}function m(_0x107bb6,_0x3b7c04,_0x11786a){let _0x2ac24f=_0x3b7c04+'\x20'+_0x11786a;if(_0x107bb6[_0x2ac24f])return{'handler':_0x107bb6[_0x2ac24f],'routePattern':_0x11786a};let _0xca22de=[];_0x11786a['startsWith']('/api')?_0xca22de['push'](_0x11786a['substring'](0x4)||'/'):_0xca22de['push']('/api'+_0x11786a),_0xca22de['push'](_0x11786a);for(let _0x43ce99 of _0xca22de)for(let _0x439611 of Object['keys'](_0x107bb6)){if(!_0x439611['startsWith'](_0x3b7c04+'\x20'))continue;let _0x3568c3=_0x439611['substring'](_0x3b7c04['length']+0x1);if(P(_0x3568c3,_0x43ce99))return{'handler':_0x107bb6[_0x439611],'routePattern':_0x3568c3};}return null;}function k(_0x3f2c0f){return typeof _0x3f2c0f=='function'?{'handler':_0x3f2c0f,'routePattern':''}:_0x3f2c0f;}var s={'appId':null,'manifest':null,'appsDir':null,'module':null,'serverPath':null};globalThis['WorkerCtx']={get 'appId'(){return s['appId'];},get 'manifest'(){return s['manifest'];}};async function w(_0x29b5de){let _0x342dea=async _0x4f0a11=>{try{let _0x36d064=globalThis['Deno'];if(!_0x36d064)throw new Error('Deno is not available');return await _0x36d064['stat'](_0x4f0a11),!0x0;}catch{return![];}};if(_0x29b5de&&typeof _0x29b5de=='string'&&_0x29b5de['length']>0x0)return _0x29b5de;if(s['serverPath']&&typeof s['serverPath']=='string'&&s['serverPath']['length']>0x0)return s['serverPath'];let _0x1cf1a6=s['manifest']?.['metadata']?.['serverPath'];if(_0x1cf1a6&&typeof _0x1cf1a6=='string'&&_0x1cf1a6['length']>0x0)return _0x1cf1a6;if(!s['appsDir']||!s['manifest'])throw new Error('appsDir\x20or\x20manifest\x20not\x20initialized');let _0xcc279b=s['manifest']['name'];if(!_0xcc279b)throw new Error('Manifest\x20name\x20not\x20found');let _0x34ea88=[s['appsDir']+'/service/server.js',s['appsDir']+'/service/server.ts',s['appsDir']+'/'+_0xcc279b+'/server.js',s['appsDir']+'/'+_0xcc279b+'/server.ts',s['appsDir']+'/server.ts',s['appsDir']+'/server.js'];for(let _0x1ef09d of _0x34ea88)if(await _0x342dea(_0x1ef09d))return _0x1ef09d;throw new Error('server\x20module\x20not\x20found.\x20tried:\x20'+_0x34ea88['join'](',\x20'));}function R(){let _0x15d57d=['log','info','warn','error','debug','trace'];for(let _0x55c292 of _0x15d57d){let _0x5800ff=(console[_0x55c292]||console['log'])['bind'](console);console[_0x55c292]=(..._0x1ae274)=>{try{let _0x4e3142=_0x1ae274['map'](_0x11fa3e=>{if(typeof _0x11fa3e=='string')return _0x11fa3e;if(_0x11fa3e instanceof Error)return JSON['stringify']({'name':_0x11fa3e['name'],'message':_0x11fa3e['message'],'stack':_0x11fa3e['stack']});if(typeof Request<'u'&&_0x11fa3e instanceof Request)try{return JSON['stringify']({'type':'Request','url':_0x11fa3e['url'],'method':_0x11fa3e['method'],'headers':Object['fromEntries'](_0x11fa3e['headers']['entries']()),'bodyUsed':_0x11fa3e['bodyUsed']});}catch{return'[Request]';}if(typeof Response<'u'&&_0x11fa3e instanceof Response)try{return JSON['stringify']({'type':'Response','status':_0x11fa3e['status'],'headers':Object['fromEntries'](_0x11fa3e['headers']['entries']())});}catch{return'[Response]';}try{return JSON['stringify'](_0x11fa3e);}catch{return String(_0x11fa3e);}})['join']('\x20');self['postMessage']({'type':'log','level':_0x55c292==='log'?'info':_0x55c292,'message':_0x4e3142,'meta':{'appId':s['appId']}});}catch{_0x5800ff(..._0x1ae274);}};}}R();async function v(_0xf3891a){if(!s['appId']||!s['appsDir']||!s['manifest'])throw new Error('appId,\x20appsDir\x20or\x20manifest\x20not\x20initialized');let _0x3d24f4=(await w(_0xf3891a))['replace'](/\\/g,'/'),_0x1298f4=(_0x3d24f4['startsWith']('file://')?_0x3d24f4:'file://'+_0x3d24f4)+'?t='+Date['now']();try{let _0x5e87c0=await import(_0x1298f4);return s['module']=_0x5e87c0,_0x5e87c0;}catch(_0x563efd){throw console['error']('Failed to load module:',_0x563efd),_0x563efd;}}function b(_0x4fa419){return _0x4fa419 instanceof Response?{'type':'raw','ok':!![],'body':'Response\x20object\x20not\x20transferable','status':0xc8,'headers':{}}:{'type':'json','ok':!![],'body':_0x4fa419,'status':0xc8,'headers':{'Content-Type':'application/json'}};}function g(_0x46c653){return _0x46c653['split']('/')['filter'](_0x1c2000=>_0x1c2000['length']>0x0);}function E(_0x287dcd){try{return decodeURIComponent(_0x287dcd);}catch{return _0x287dcd;}}function I(_0x41125c,_0x246fa3){let _0x56f82e=g(_0x41125c),_0x3c3ee3=g(_0x246fa3),_0x41a05b={},_0x1c8f2a=0x0,_0x4bcc81=0x0;for(;_0x1c8f2a<_0x56f82e['length']&&_0x4bcc81<_0x3c3ee3['length'];){let _0x5cf84f=_0x56f82e[_0x1c8f2a],_0x5da04b=_0x3c3ee3[_0x4bcc81];if(_0x5cf84f==='*')break;if(_0x5cf84f['startsWith'](':')){let _0x118a5d=_0x5cf84f['slice'](0x1);_0x118a5d&&(_0x41a05b[_0x118a5d]=E(_0x5da04b)),_0x1c8f2a++,_0x4bcc81++;continue;}if(_0x5cf84f!==_0x5da04b)return{};_0x1c8f2a++,_0x4bcc81++;}return _0x1c8f2a===_0x56f82e['length']||_0x1c8f2a===_0x56f82e['length']-0x1&&_0x56f82e[_0x1c8f2a]==='*',_0x41a05b;}function M(_0x4886e9,_0x40ba31){return _0x4886e9['startsWith']('/api')&&!_0x40ba31['startsWith']('/api')?_0x4886e9['substring'](0x4)||'/':!_0x4886e9['startsWith']('/api')&&_0x40ba31['startsWith']('/api')?'/api'+(_0x4886e9['startsWith']('/')?'':'/')+_0x4886e9:_0x4886e9;}async function W(_0x508705){let _0x5f403f=_0x508705['ctx']?.['metadata']?.['serverPath'];(!s['module']||_0x5f403f)&&await v(_0x5f403f);let _0x17a256=_0x508705['ctx'],{method:_0x253921,pathname:_0x23997c}=_0x17a256,_0x4d3020=s['module']?.['default']||{},_0x145392=m(_0x4d3020,_0x253921,_0x23997c);if(!_0x145392)throw Object['assign'](new Error('Route\x20'+_0x253921+'\x20'+_0x23997c+'\x20not\x20found'),{'code':'ROUTE_NOT_FOUND'});let _0x59f84b=k(_0x145392),_0x23eb33=c(_0x17a256,s),_0x4ccae0=_0x23997c,_0x1ff3fd=M(_0x59f84b['routePattern'],_0x4ccae0),_0x5002ca=_0x1ff3fd?I(_0x1ff3fd,_0x4ccae0):{},_0x1ec8e9=await _0x59f84b['handler']({..._0x23eb33,'params':{..._0x23eb33['params'],..._0x5002ca}});return b(_0x1ec8e9);}function D(_0x2801ec){s['appId']=_0x2801ec['appId'],s['manifest']=_0x2801ec['manifest'],s['appsDir']=_0x2801ec['appsDir'],s['serverPath']=_0x2801ec['serverPath']||null,console['log']('Worker\x20initialized',{'appId':s['appId']}),self['postMessage']({'type':'ready','appId':s['appId']});}async function $(_0x1102cf){let {reqId:_0x57a26b,payload:_0x31c5a8}=_0x1102cf;try{let _0x136328=await W(_0x31c5a8);self['postMessage']({'type':'result','reqId':_0x57a26b,'ok':!0x0,'response':_0x136328});}catch(_0x326a92){let _0x5c2ce0=_0x326a92;self['postMessage']({'type':'result','reqId':_0x57a26b,'ok':![],'error':{'message':_0x5c2ce0['message'],'stack':_0x5c2ce0['stack'],'code':_0x5c2ce0['code']}});}}function C(){console['log']('Worker\x20shutting\x20down',{'appId':s['appId']}),s['module']=null,s['appId']=null,s['manifest']=null,s['appsDir']=null,self['postMessage']({'type':'shutdown-complete'});}self['onmessage']=async _0x590c83=>{let _0x4d320b=_0x590c83['data'];try{switch(_0x4d320b['type']){case'init':D(_0x4d320b);break;case'invoke':await $(_0x4d320b);break;case'shutdown':C();break;default:console['warn']('Unknown\x20message\x20type:',_0x4d320b['type']);break;}}catch(_0x29d938){let _0x359f4f=_0x29d938;try{self['postMessage']({'type':'log','level':'error','message':'Unhandled\x20error\x20in\x20worker','meta':{'appId':s['appId'],'error':_0x359f4f['message'],'stack':_0x359f4f['stack']}});}catch{console['error']('Failed\x20to\x20send\x20error:',_0x359f4f);}}},self['onerror']=_0x22d110=>{let _0x61bb20={'message':typeof _0x22d110=='string'?_0x22d110:_0x22d110['message'],'filename':typeof _0x22d110=='string'?void 0x0:_0x22d110['filename'],'lineno':typeof _0x22d110=='string'?void 0x0:_0x22d110['lineno'],'colno':typeof _0x22d110=='string'?void 0x0:_0x22d110['colno'],'error':typeof _0x22d110=='string'?void 0x0:_0x22d110['error']?.['message'],'stack':typeof _0x22d110=='string'?void 0x0:_0x22d110['error']?.['stack'],'appId':s['appId']};console['error']('Worker\x20global\x20error:',_0x61bb20);},self['onunhandledrejection']=_0x394aa0=>{let _0x9a404c=_0x394aa0['reason'],_0x2e44ae={'appId':s['appId'],'reason':_0x9a404c instanceof Error?_0x9a404c['message']:String(_0x9a404c),'stack':_0x9a404c instanceof Error?_0x9a404c['stack']:void 0x0};console['error']('Unhandled\x20promise\x20rejection:',_0x2e44ae);};